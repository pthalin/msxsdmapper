0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014
0004   0000             ; Fabio Belavenuto
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 7B00h~7EFFh   : SPI data transfer window (read/write)
0015   0000             ; 7F00h         : Interface status and card select register (read/write)
0016   0000             ;       <read>
0017   0000             ;       b0      : 1=SD Card on slot-0 changed since last read
0018   0000             ;       b1      : 1=SD Card on slot-1 changed since last read
0019   0000             ;       b2      : 0=SD card present on slot-0
0020   0000             ;       b3      : 0=SD card present on slot-1
0021   0000             ;       b4      : 0=Write protecton enabled for SD card slot-0
0022   0000             ;       b5      : 0=Write protecton enabled for SD card slot-1
0023   0000             ;       b6      : SW0 status. 0=RAM disabled, 1=RAM enabled
0024   0000             ;       b7      : SW1 status. 0=RAM mode: MegaRAM, 1=RAM mode: Memory Mapper
0025   0000             ;       <write>
0026   0000             ;       b0      : SD card slot-0 chip-select (0=selected)
0027   0000             ;       b1      : SD card slot-1 chip-select (0=selected)
0028   0000             
0029   0000             	output	"driver.bin"
0030   0000             
0031   0000             ; Enderecos ROM
0032   0000             
0033   0000             BIOS_INITXT	= $6C						; Inicializa SCREEN0
0034   0000             BIOS_CHPUT	= $A2						; A=char
0035   0000             BIOS_CLS	= $C3						; Chamar com A=0
0036   0000             LINL40		= $F3AE						; Width
0037   0000             LINLEN		= $F3B0
0038   0000             
0039   0000             ; Enderecos SPI
0040   0000             
0041   0000             PORTCFG		= $7F00
0042   0000             PORTSPI		= $7B00
0043   0000             
0044   0000             ; Comandos SPI:
0045   0000             CMD0	= 0  | $40
0046   0000             CMD1	= 1  | $40
0047   0000             CMD8	= 8  | $40
0048   0000             CMD9	= 9  | $40
0049   0000             CMD10	= 10 | $40
0050   0000             CMD12	= 12 | $40
0051   0000             CMD16	= 16 | $40
0052   0000             CMD17	= 17 | $40
0053   0000             CMD18	= 18 | $40
0054   0000             CMD24	= 24 | $40
0055   0000             CMD25	= 25 | $40
0056   0000             CMD55	= 55 | $40
0057   0000             CMD58	= 58 | $40
0058   0000             ACMD23	= 23 | $40
0059   0000             ACMD41	= 41 | $40
0060   0000             
0061   0000             ; Offsets da area de trabalho
0062   0000             
0063   0000             BCSD 		= 0
0064   0000             BCID1		= 16
0065   0000             BCID2		= 32
0066   0000             NUMSD		= 48			; 1 se cartao 1, 2 se cartao 2
0067   0000             FLAGSCARTAO	= 49			; Flag indicando se houve mudanca ou erro de cartao
0068   0000             NUMBLOCOS	= 50			; 1 byte
0069   0000             TEMP		= 52			; 1 byte
0070   0000             BLOCOS1		= 56			; 3 bytes
0071   0000             BLOCOS2		= 60			; 3 bytes
0072   0000             
0073   0000             	org		$4000
0074   4000             
0075   4000 FF          	ds		256, $FF		; 256 dummy bytes
0076   4100             
0077   4100             DRV_START: 
0078   4100             
0079   4100             ;-----------------------------------------------------------------------------
0080   4100             ;
0081   4100             ; Miscellaneous constants
0082   4100             ;
0083   4100             
0084   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0085   4100             ;It is used by some of the kernel page 0 routines.
0086   4100             
0087   4100             CODE_ADD: 	equ	0F84Ch
0088   4100             
0089   4100             
0090   4100             ;-----------------------------------------------------------------------------
0091   4100             ;
0092   4100             ; Driver configuration constants
0093   4100             ;
0094   4100             
0095   4100             ;Driver version
0096   4100             
0097   4100             VER_MAIN	equ	1
0098   4100             VER_SEC		equ	0
0099   4100             VER_REV		equ	4
0100   4100             
0101   4100             
0102   4100             ;-----------------------------------------------------------------------------
0103   4100             ;
0104   4100             ; Error codes for DEV_RW
0105   4100             ;
0106   4100             
0107   4100             ENCOMP	equ	0FFh
0108   4100             EWRERR	equ	0FEh
0109   4100             EDISK	equ	0FDh
0110   4100             ENRDY	equ	0FCh
0111   4100             EDATA	equ	0FAh
0112   4100             ERNF	equ	0F9h
0113   4100             EWPROT	equ	0F8h
0114   4100             EUFORM	equ	0F7h
0115   4100             ESEEK	equ	0F3h
0116   4100             EIFORM	equ	0F0h
0117   4100             EIDEVL	equ	0B5h
0118   4100             EIPARM	equ	08Bh
0119   4100             
0120   4100             ;-----------------------------------------------------------------------------
0121   4100             ;
0122   4100             ; Routines and information available on kernel page 0
0123   4100             ;
0124   4100             
0125   4100             ;* Get in A the current slot for page 1. Corrupts F.
0126   4100             ;  Must be called by using CALBNK to bank 0:
0127   4100             ;    xor a
0128   4100             ;    ld ix,GSLOT1
0129   4100             ;    call CALBNK
0130   4100             
0131   4100             GSLOT1	equ	402Dh
0132   4100             
0133   4100             
0134   4100             ;* This routine reads a byte from another bank.
0135   4100             ;  Must be called by using CALBNK to the desired bank,
0136   4100             ;  passing the address to be read in HL:
0137   4100             ;    ld a,<bank number>
0138   4100             ;    ld hl,<byte address>
0139   4100             ;    ld ix,RDBANK
0140   4100             ;    call CALBNK
0141   4100             
0142   4100             RDBANK	equ	403Ch
0143   4100             
0144   4100             
0145   4100             ;* This routine temporarily switches kernel main bank
0146   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0147   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0148   4100             ;  It is necessary to use this routine to invoke CALBAS
0149   4100             ;  (so that kernel bank is correct in case of BASIC error)
0150   4100             ;  and to invoke DOS functions via F37Dh hook.
0151   4100             ;
0152   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0153   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0154   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0155   4100             
0156   4100             CALLB0	equ	403Fh
0157   4100             
0158   4100             
0159   4100             ;* Call a routine in another bank.
0160   4100             ;  Must be used if the driver spawns across more than one bank.
0161   4100             ;
0162   4100             ;  Input:  A = bank number
0163   4100             ;          IX = routine address
0164   4100             ;          AF' = AF for the routine
0165   4100             ;          HL' = Ix for the routine
0166   4100             ;          BC, DE, HL, IY = input for the routine
0167   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0168   4100             
0169   4100             CALBNK	equ	4042h
0170   4100             
0171   4100             
0172   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0173   4100             ;  which will in turn contain a pointer to the allocated page 3
0174   4100             ;  work area for that slot (0 if no work area was allocated).
0175   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0176   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0177   4100             ;  Corrupts F.
0178   4100             ;  Must be called by using CALBNK to bank 0:
0179   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0180   4100             ;    ex af,af'
0181   4100             ;    xor a
0182   4100             ;    ld ix,GWORK
0183   4100             ;    call CALBNK
0184   4100             
0185   4100             GWORK	equ	4045h
0186   4100             
0187   4100             
0188   4100             ;* This address contains one byte that tells how many banks
0189   4100             ;  form the Nextor kernel (or alternatively, the first bank
0190   4100             ;  number of the driver).
0191   4100             
0192   4100             K_SIZE	equ	40FEh
0193   4100             
0194   4100             
0195   4100             ;* This address contains one byte with the current bank number.
0196   4100             
0197   4100             CUR_BANK	equ	40FFh
0198   4100             
0199   4100             
0200   4100             ;-----------------------------------------------------------------------------
0201   4100             ;
0202   4100             ; Built-in format choice strings
0203   4100             ;
0204   4100             
0205   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0206   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0207   4100             
0208   4100             
0209   4100             ;-----------------------------------------------------------------------------
0210   4100             ;
0211   4100             ; Driver signature
0212   4100             ;
0213   4100             	db	"NEXTOR_DRIVER",0
0213   4100 4E4558544F525F44524956455200
0214   410E             
0215   410E             
0216   410E             ;-----------------------------------------------------------------------------
0217   410E             ;
0218   410E             ; Driver flags:
0219   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0220   410E 01          	db	1
0221   410F             
0222   410F             ;-----------------------------------------------------------------------------
0223   410F             ;
0224   410F             ; Reserved byte
0225   410F             ;
0226   410F             
0227   410F 00          	db	0
0228   4110             
0229   4110             
0230   4110             ;-----------------------------------------------------------------------------
0231   4110             ;
0232   4110             ; Driver name
0233   4110             ;
0234   4110             
0235   4110             DRV_NAME: 
0236   4110             	db	"SDMapper Driver"
0236   4110 53444D617070657220447269766572
0237   411F 20          	ds	32-($-DRV_NAME)," "
0238   4130             
0239   4130             
0240   4130             ;-----------------------------------------------------------------------------
0241   4130             ;
0242   4130             ; Jump table for the driver public routines
0243   4130             ;
0244   4130             
0245   4130             	; These routines are mandatory for all drivers
0246   4130                     ; (but probably you need to implement only DRV_INIT)
0247   4130             
0248   4130 C3 6C 41    	jp	DRV_TIMI
0249   4133 C3 3D 42    	jp	DRV_VERSION
0250   4136 C3 6D 41    	jp	DRV_INIT
0251   4139 C3 44 42    	jp	DRV_BASSTAT
0252   413C C3 46 42    	jp	DRV_BASDEV
0253   413F C3 48 42    	jp	DRV_EXTBIO
0254   4142 C3 49 42    	jp	DRV_DIRECT0
0255   4145 C3 49 42    	jp	DRV_DIRECT1
0256   4148 C3 49 42    	jp	DRV_DIRECT2
0257   414B C3 49 42    	jp	DRV_DIRECT3
0258   414E C3 49 42    	jp	DRV_DIRECT4
0259   4151             
0260   4151 00          	ds	15
0261   4160             
0262   4160             	; These routines are mandatory for device-based drivers
0263   4160             
0264   4160 C3 4A 42    	jp	DEV_RW
0265   4163 C3 BB 42    	jp	DEV_INFO
0266   4166 C3 41 43    	jp	DEV_STATUS
0267   4169 C3 81 43    	jp	LUN_INFO
0268   416C             
0269   416C             
0270   416C             ;=====
0271   416C             ;=====  END of data that must be at fixed addresses
0272   416C             ;=====
0273   416C             
0274   416C             
0275   416C             ;-----------------------------------------------------------------------------
0276   416C             ;
0277   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0278   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0279   416C             
0280   416C             DRV_TIMI: 
0281   416C C9          	ret
0282   416D             
0283   416D             
0284   416D             ;-----------------------------------------------------------------------------
0285   416D             ;
0286   416D             ; Driver initialization routine, it is called twice:
0287   416D             ;
0288   416D             ; 1) First execution, for information gathering.
0289   416D             ;    Input:
0290   416D             ;      A = 0
0291   416D             ;      B = number of available drives
0292   416D             ;      HL = maximum size of allocatable work area in page 3
0293   416D             ;    Output:
0294   416D             ;      A = number of required drives (for drive-based driver only)
0295   416D             ;      HL = size of required work area in page 3
0296   416D             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0297   416D             ;
0298   416D             ; 2) Second execution, for work area and hardware initialization.
0299   416D             ;    Input:
0300   416D             ;      A = 1
0301   416D             ;      B = number of allocated drives for this controller
0302   416D             ;
0303   416D             ;    The work area address can be obtained by using GWORK.
0304   416D             ;
0305   416D             ;    If first execution requests more work area than available,
0306   416D             ;    second execution will not be done and DRV_TIMI will not be hooked
0307   416D             ;    to the timer interrupt.
0308   416D             ;
0309   416D             ;    If first execution requests more drives than available,
0310   416D             ;    as many drives as possible will be allocated, and the initialization
0311   416D             ;    procedure will continue the normal way
0312   416D             ;    (for drive-based drivers only. Device-based drivers always
0313   416D             ;     get two allocated drives.)
0314   416D             
0315   416D             DRV_INIT: 
0316   416D B7          	or		a							; testar se eh primeira ou segunda chamada
0317   416E CA 38 42    	jp z,	.primeira_chamada
0318   4171             
0319   4171             ; 2. chamada:
0320   4171 CD 6C 00    	call	BIOS_INITXT					; inicializar tela
0321   4174 AF          	xor		a
0322   4175 CD C3 00    	call	BIOS_CLS					; limpar tela
0323   4178 CD C0 43    	call	pegaWorkArea
0324   417B 11 91 58    	ld		de, strTitulo				; imprimir titulo
0325   417E CD 4B 57    	call	printString
0326   4181 11 5D 59    	ld		de, strMr_mp_desativada
0327   4184 3A 00 7F    	ld		a, (PORTCFG)				; testar se mapper/megaram esta ativa
0328   4187 E6 40       	and		$40
0329   4189 28 0D       	jr z,	.print						; desativada, pula
0330   418B 11 79 59    	ld		de, strMapper
0331   418E 3A 00 7F    	ld		a, (PORTCFG)				; ativa, testar se eh mapper ou megaram
0332   4191 E6 80       	and		$80
0333   4193 20 03       	jr nz,	.print
0334   4195 11 8A 59    	ld		de, strMegaram				; Megaram ativa
0335   4198             .print: 
0336   4198 CD 4B 57    	call	printString
0337   419B 11 38 59    	ld		de, strCrLf
0338   419E CD 4B 57    	call	printString
0339   41A1 AF          	xor		a							; zera flags do cartao
0340   41A2 FD 77 31    	ld		(iy+FLAGSCARTAO), a
0341   41A5 3E 01       	ld		a, 1						; detectar cartao 1
0342   41A7 CD BE 41    	call	.detecta
0343   41AA 3E 02       	ld		a, 2						; detectar cartao 2
0344   41AC CD BE 41    	call	.detecta
0345   41AF 01 00 00    	ld		bc, 0
0346   41B2 1E 05       	ld		e, 5
0347   41B4             .wait: 									; esperar um pouco para dar tempo
0348   41B4 00          	nop									; de ler mensagens
0349   41B5 0B          	dec		bc
0350   41B6 79          	ld		a, c
0351   41B7 B0          	or		b
0352   41B8 20 FA       	jr nz,	.wait
0353   41BA 1D          	dec		e
0354   41BB 20 F7       	jr nz,	.wait
0355   41BD C9          	ret
0356   41BE             
0357   41BE             .detecta: 
0358   41BE FD 77 30    	ld		(iy+NUMSD), a				; processo de deteccao dos cartoes
0359   41C1 11 3B 59    	ld		de, strCartao
0360   41C4 CD 4B 57    	call	printString
0361   41C7 FD 7E 30    	ld		a, (iy+NUMSD)
0362   41CA C6 30       	add		'0'
0363   41CC CD A2 00    	call	BIOS_CHPUT
0364   41CF 3E 3A       	ld		a, ':'
0365   41D1 CD A2 00    	call	BIOS_CHPUT
0366   41D4 3E 20       	ld		a, ' '
0367   41D6 CD A2 00    	call	BIOS_CHPUT
0368   41D9 FD 4E 30    	ld		c, (iy+NUMSD)
0369   41DC CB 01       	rlc		c
0370   41DE CB 01       	rlc		c							; ......XX => ....XX..
0371   41E0 3A 00 7F    	ld		a, (PORTCFG)				; testar se cartao esta inserido
0372   41E3 A1          	and		c							; C contem 1 se cartao 1, 2 se cartao 2
0373   41E4 28 09       	jr z,	.naoVazio
0374   41E6 11 41 59    	ld		de, strVazio				; nao tem cartao no slot
0375   41E9 CD 4B 57    	call	printString
0376   41EC C3 FD 41    	jp		.marcaErro
0377   41EF             .naoVazio: 
0378   41EF CD 41 44    	call	detectaCartao				; tem cartao no slot, inicializar e detectar
0379   41F2 30 0C       	jr nc,	.detectou
0380   41F4 CD 84 45    	call	desabilitaSDs
0381   41F7 11 49 59    	ld		de, strNaoIdentificado
0382   41FA CD 4B 57    	call	printString
0383   41FD             .marcaErro: 
0384   41FD C3 FE 43    	jp		marcaErroCartao				; slot vazio ou erro de deteccao, marcar nas flags
0385   4200             .detectou: 
0386   4200 CD 19 44    	call	calculaCIDoffset			; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0387   4203 DD 7E 0F    	ld		a, (ix+15)					; pegar byte SDV1 ou SDV2
0388   4206 11 9C 59    	ld		de, strSDV1					; e imprimir
0389   4209 B7          	or		a
0390   420A 28 03       	jr z,	.pula1
0391   420C 11 A4 59    	ld		de, strSDV2
0392   420F             .pula1: 
0393   420F CD 4B 57    	call	printString
0394   4212 3E 28       	ld		a, '('
0395   4214 CD A2 00    	call	BIOS_CHPUT
0396   4217 DD 7E 00    	ld		a, (ix)						; pegar byte do fabricante
0397   421A CD 98 57    	call	printDecToAscii				; Imprimir Manufacturer ID
0398   421D 3E 29       	ld		a, ')'
0399   421F CD A2 00    	call	BIOS_CHPUT
0400   4222 3E 20       	ld		a, ' '
0401   4224 CD A2 00    	call	BIOS_CHPUT
0402   4227 DD 7E 00    	ld		a, (ix)						; pegar byte do fabricante
0403   422A CD C4 57    	call	pegaFabricante				; achar nome do fabricante
0404   422D EB          	ex		de, hl
0405   422E CD 4B 57    	call	printString					; e imprimir
0406   4231 11 38 59    	ld		de, strCrLf
0407   4234 CD 4B 57    	call	printString
0408   4237 C9          	ret
0409   4238             
0410   4238             .primeira_chamada: 
0411   4238 AF          	xor		a							; primeira chamada do Nextor
0412   4239 21 40 00    	ld		hl, 64						; informar que precisamos de 64 bytes
0413   423C C9          	ret									; de RAM para dados
0414   423D             
0415   423D             ;-----------------------------------------------------------------------------
0416   423D             ;
0417   423D             ; Obtain driver version
0418   423D             ;
0419   423D             ; Input:  -
0420   423D             ; Output: A = Main version number
0421   423D             ;         B = Secondary version number
0422   423D             ;         C = Revision number
0423   423D             
0424   423D             DRV_VERSION: 
0425   423D 3E 01       	ld		a, VER_MAIN
0426   423F 06 00       	ld		b, VER_SEC
0427   4241 0E 04       	ld		c, VER_REV
0428   4243 C9          	ret
0429   4244             
0430   4244             
0431   4244             ;-----------------------------------------------------------------------------
0432   4244             ;
0433   4244             ; BASIC expanded statement ("CALL") handler.
0434   4244             ; Works the expected way, except that if invoking CALBAS is needed,
0435   4244             ; it must be done via the CALLB0 routine in kernel page 0.
0436   4244             
0437   4244             DRV_BASSTAT: 
0438   4244 37          	scf
0439   4245 C9          	ret
0440   4246             
0441   4246             
0442   4246             ;-----------------------------------------------------------------------------
0443   4246             ;
0444   4246             ; BASIC expanded device handler.
0445   4246             ; Works the expected way, except that if invoking CALBAS is needed,
0446   4246             ; it must be done via the CALLB0 routine in kernel page 0.
0447   4246             
0448   4246             DRV_BASDEV: 
0449   4246 37          	scf
0450   4247 C9          	ret
0451   4248             
0452   4248             ;-----------------------------------------------------------------------------
0453   4248             ;
0454   4248             ; Extended BIOS hook.
0455   4248             ; Works the expected way, except that it must return
0456   4248             ; D'=1 if the old hook must be called, D'=0 otherwise.
0457   4248             ; It is entered with D'=1.
0458   4248             
0459   4248             DRV_EXTBIO: 
0460   4248 C9          	ret
0461   4249             
0462   4249             ;-----------------------------------------------------------------------------
0463   4249             ;
0464   4249             ; Direct calls entry points.
0465   4249             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0466   4249             ; in kernel banks 0 and 3 will be redirected
0467   4249             ; to DIRECT0/1/2/3/4 respectively.
0468   4249             ; Receives all register data from the caller except IX and AF'.
0469   4249             
0470   4249             DRV_DIRECT0: 
0471   4249             DRV_DIRECT1: 
0472   4249             DRV_DIRECT2: 
0473   4249             DRV_DIRECT3: 
0474   4249             DRV_DIRECT4: 
0475   4249 C9          	ret
0476   424A             
0477   424A             
0478   424A             ;=====
0479   424A             ;=====  BEGIN of DEVICE-BASED specific routines
0480   424A             ;=====
0481   424A             
0482   424A             ;-----------------------------------------------------------------------------
0483   424A             ;
0484   424A             ; Read or write logical sectors from/to a logical unit
0485   424A             ;
0486   424A             ;Input:    Cy=0 to read, 1 to write
0487   424A             ;          A = Device number, 1 to 7
0488   424A             ;          B = Number of sectors to read or write
0489   424A             ;          C = Logical unit number, 1 to 7
0490   424A             ;          HL = Source or destination memory address for the transfer
0491   424A             ;          DE = Address where the 4 byte sector number is stored.
0492   424A             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0493   424A             ;              0: Ok
0494   424A             ;              .IDEVL: Invalid device or LUN
0495   424A             ;              .NRDY: Not ready
0496   424A             ;              .DISK: General unknown disk error
0497   424A             ;              .DATA: CRC error when reading
0498   424A             ;              .RNF: Sector not found
0499   424A             ;              .UFORM: Unformatted disk
0500   424A             ;              .WPROT: Write protected media, or read-only logical unit
0501   424A             ;              .WRERR: Write error
0502   424A             ;              .NCOMP: Incompatible disk.
0503   424A             ;              .SEEK: Seek error.
0504   424A             ;          B = Number of sectors actually read (in case of error only)
0505   424A             
0506   424A             DEV_RW: 
0507   424A F5          	push	af
0508   424C BF FE 03    	cp		a, 3						; somente 2 dispositivos
0509   424E 30 10       	jr nc,	.saicomerroidl
0510   4250 0D          	dec		c							; somente 1 logical unit
0511   4251 20 0D       	jr nz,	.saicomerroidl
0512   4253 E5          	push	hl
0513   4254 CD D6 43    	call	testaCartao					; verificar se cartao esta OK
0514   4257 E1          	pop		hl
0515   4258 30 0C       	jr nc,	.ok
0516   425A F1          	pop		af							; retira AF guardado no inicio
0517   425B 3E FC       	ld		a, ENRDY					; Not ready
0518   425D             ;	ld		a, EDISK					; General unknown disk error
0519   425D 06 00       	ld		b, 0
0520   425F C9          	ret
0521   4260             .saicomerroidl: 
0522   4260 F1          	pop		af							; retira AF guardado no inicio
0523   4261 3E B5       	ld		a, EIDEVL					; informar erro
0524   4263 06 00       	ld		b, 0
0525   4265 C9          	ret
0526   4266             .ok: 
0527   4266 FD 70 32    	ld		(iy+NUMBLOCOS), b			; guarda numero de blocos para ler/gravar
0528   4269 E5          	push	hl
0529   426A D5          	push	de
0530   426B CD 19 44    	call	calculaCIDoffset			; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0531   426E D1          	pop		de
0532   426F E1          	pop		hl
0533   4270 F1          	pop		af							; retira AF guardado no inicio, para saber se eh leitura ou escrita
0534   4271 38 1F       	jr c,	escrita						; se for escrita pulamos
0535   4273             leitura: 
0536   4273 1A          	ld		a, (de)						; 1. n. bloco
0537   4274 F5          	push	af
0538   4275 13          	inc		de
0539   4276 1A          	ld		a, (de)						; 2. n. bloco
0540   4277 F5          	push	af
0541   4278 13          	inc		de
0542   4279 1A          	ld		a, (de)						; 3. n. bloco
0543   427A 4F          	ld		c, a
0544   427B 13          	inc		de
0545   427C 1A          	ld		a, (de)						; 4. n. bloco
0546   427D 13          	inc		de
0547   427E 47          	ld		b, a
0548   427F F1          	pop		af
0549   4280 57          	ld		d, a
0550   4281 F1          	pop		af							; HL = ponteiro destino
0551   4282 5F          	ld		e, a						; BC DE = 32 bits numero do bloco
0552   4283 CD E0 4E    	call	LerBloco					; chamar rotina de leitura de dados
0553   4286 30 08       	jr nc,	.ok
0554   4288 CD FE 43    	call	marcaErroCartao				; ocorreu erro na leitura, marcar erro
0555   428B             ;	ld		a, ENRDY					; Not ready
0556   428B 3E FD       	ld		a, EDISK					; General unknown disk error
0557   428D 06 00       	ld		b, 0						; informar que lemos 0 blocos
0558   428F C9          	ret
0559   4290             .ok: 
0560   4290 AF          	xor		a							; tudo OK, informar ao Nextor
0561   4291 C9          	ret
0562   4292             
0563   4292             escrita: 
0564   4292 CD 09 44    	call	testaWP						; testar se cartao esta protegido contra escrita
0565   4295 28 05       	jr z,	.ok
0566   4297 3E F8       	ld		a, EWPROT					; disco protegido
0567   4299 06 00       	ld		b, 0
0568   429B C9          	ret
0569   429C             .ok: 
0570   429C 1A          	ld		a, (de)						; 1. n. bloco
0571   429D F5          	push	af
0572   429E 13          	inc		de
0573   429F 1A          	ld		a, (de)						; 2. n. bloco
0574   42A0 F5          	push	af
0575   42A1 13          	inc		de
0576   42A2 1A          	ld		a, (de)						; 3. n. bloco
0577   42A3 13          	inc		de
0578   42A4 4F          	ld		c, a
0579   42A5 1A          	ld		a, (de)						; 4. n. bloco
0580   42A6 13          	inc		de
0581   42A7 47          	ld		b, a
0582   42A8 F1          	pop		af
0583   42A9 57          	ld		d, a
0584   42AA F1          	pop		af							; HL = ponteiro destino
0585   42AB 5F          	ld		e, a						; BC DE = 32 bits numero do bloco
0586   42AC CD 38 46    	call	GravarBloco					; chamar rotina de gravacao de dados
0587   42AF 30 08       	jr nc,	.ok2
0588   42B1 CD FE 43    	call	marcaErroCartao				; ocorreu erro, marcar nas flags
0589   42B4 3E FE       	ld		a, EWRERR					; Write error
0590   42B6 06 00       	ld		b, 0
0591   42B8 C9          	ret
0592   42B9             .ok2: 
0593   42B9 AF          	xor		a							; gravacao sem erros!
0594   42BA C9          	ret
0595   42BB             
0596   42BB             ;-----------------------------------------------------------------------------
0597   42BB             ;
0598   42BB             ; Device information gathering
0599   42BB             ;
0600   42BB             ;Input:   A = Device index, 1 to 7
0601   42BB             ;         B = Information to return:
0602   42BB             ;             0: Basic information
0603   42BB             ;             1: Manufacturer name string
0604   42BB             ;             2: Device name string
0605   42BB             ;             3: Serial number string
0606   42BB             ;         HL = Pointer to a buffer in RAM
0607   42BB             ;Output:  A = Error code:
0608   42BB             ;             0: Ok
0609   42BB             ;             1: Device not available or invalid device index
0610   42BB             ;             2: Information not available, or invalid information index
0611   42BB             ;         When basic information is requested,
0612   42BB             ;         buffer filled with the following information:
0613   42BB             ;
0614   42BB             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0615   42BB             ;        units (which is functionally equivalent to having only one).
0616   42BB             ;+1 (1): Device flags, always zero in Beta 2.
0617   42BB             ;
0618   42BB             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0619   42BB             ; left justified and padded with spaces. All the strings are optional,
0620   42BB             ; if not available, an error must be returned.
0621   42BB             ; If a string is provided by the device in binary format, it must be reported
0622   42BB             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0623   42BB             ; The maximum length for a string is 64 characters;
0624   42BB             ; if the string is actually longer, the leftmost 64 characters
0625   42BB             ; should be provided.
0626   42BB             ;
0627   42BB             ; In the case of the serial number string, the same rules for the strings
0628   42BB             ; apply, except that it must be provided right-justified,
0629   42BB             ; and if it is too long, the rightmost characters must be
0630   42BB             ; provided, not the leftmost.
0631   42BB             
0632   42BB             DEV_INFO: 
0633   42BB 04          	inc		b
0634   42BD BF FE 03    	cp		a, 3						; somente 2 dispositivos
0635   42BF 30 07       	jr nc,	.saicomerro
0636   42C1 E5          	push	hl
0637   42C2 CD D6 43    	call	testaCartao					; verificar se cartao esta OK
0638   42C5 E1          	pop		hl
0639   42C6 30 03       	jr nc,	.ok							; nao houve erro
0640   42C8             .saicomerro: 
0641   42C8 3E 01       	ld		a, 1						; informar erro
0642   42CA C9          	ret
0643   42CB             
0644   42CB             .ok: 
0645   42CB 10 07       	djnz	.naoBasic
0646   42CD             ; Basic information:
0647   42CD 3E 01       	ld		a, 1						; 1 logical unit somente
0648   42CF 77          	ld		(hl), a
0649   42D0 AF          	xor		a							; reservado, deve ser 0
0650   42D1 23          	inc		hl
0651   42D2 77          	ld		(hl), a
0652   42D3 C9          	ret									; retorna com A=0 (OK)
0653   42D4             
0654   42D4             .naoBasic: 
0655   42D4 E5          	push	hl
0656   42D5 CD 19 44    	call	calculaCIDoffset			; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0657   42D8 E1          	pop		hl
0658   42D9 10 25       	djnz	.naoManuf
0659   42DB             ; Manufacturer Name:
0660   42DB E5          	push	hl							; salva ponteiro do buffer
0661   42DC 06 40       	ld		b, 64						; preenche buffer com espaco
0662   42DE 3E 20       	ld		a, ' '
0663   42E0             .loop1: 
0664   42E0 77          	ld		(hl), a
0665   42E1 23          	inc		hl
0666   42E2 10 FC       	djnz	.loop1
0667   42E4 D1          	pop		de							; recuperamos ponteiro do buffer em DE
0668   42E5 3E 28       	ld		a, '('						; colocamos (xx) xxx no buffer
0669   42E7 12          	ld		(de), a
0670   42E8 13          	inc		de
0671   42E9 DD 7E 00    	ld		a, (ix)						; byte do fabricante
0672   42EC CD 54 57    	call	DecToAscii
0673   42EF 3E 29       	ld		a, ')'
0674   42F1 12          	ld		(de), a
0675   42F2 13          	inc		de
0676   42F3 3E 20       	ld		a, ' '
0677   42F5 12          	ld		(de), a
0678   42F6 13          	inc		de
0679   42F7 DD 7E 00    	ld		a, (ix)						; byte do fabricante
0680   42FA CD C4 57    	call	pegaFabricante				; pegar nome do fabricante em HL
0681   42FD ED B0       	ldir								; e colocar no buffer
0682   42FF C9          	ret
0683   4300             
0684   4300             .naoManuf: 
0685   4300 10 1A       	djnz	.naoProduct
0686   4302             ; Product Name:
0687   4302 E5          	push	hl							; guarda HL que aponta para buffer do Nextor
0688   4303 DD E5       	push	ix
0689   4305 E1          	pop		hl							; joga IX para HL
0690   4306 16 00       	ld		d, 0
0691   4308 1E 03       	ld		e, 3						; adiciona offset do productname em HL
0692   430A 19          	add		hl, de
0693   430B D1          	pop		de							; recupera buffer do Nextor em DE
0694   430C 01 05 00    	ld		bc, 5						; 5 caracteres
0695   430F ED B0       	ldir								; copia nome do produto
0696   4311 EB          	ex		de, hl						; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0697   4312 06 3B       	ld		b, 59						; Coloca espaco no restante do buffer
0698   4314 3E 20       	ld		a, ' '
0699   4316             .loop2: 
0700   4316 77          	ld		(hl), a
0701   4317 23          	inc		hl
0702   4318 10 FC       	djnz	.loop2
0703   431A AF          	xor		a							; informar sem erros
0704   431B C9          	ret
0705   431C             
0706   431C             .naoProduct: 
0707   431C             ; Serial:
0708   431C 3E 30       	ld		a, '0'						; Coloca prefixo "0x"
0709   431E 77          	ld		(hl), a
0710   431F 23          	inc		hl
0711   4320 3E 78       	ld		a, 'x'
0712   4322 77          	ld		(hl), a
0713   4323 23          	inc		hl
0714   4324 E5          	push	hl							; guarda HL que aponta para buffer do Nextor
0715   4325 DD E5       	push	ix
0716   4327 E1          	pop		hl							; joga IX para HL
0717   4328 16 00       	ld		d, 0
0718   432A 1E 09       	ld		e, 9						; adiciona offset do productname em HL
0719   432C 19          	add		hl, de
0720   432D D1          	pop		de							; recupera buffer do nextor em DE
0721   432E 06 04       	ld		b, 4						; 4 bytes do serial
0722   4330             .loop3: 
0723   4330 7E          	ld		a, (hl)
0724   4331 CD 84 57    	call	HexToAscii					; converter HEXA para ASCII
0725   4334 23          	inc		hl
0726   4335 10 F9       	djnz	.loop3
0727   4337 06 36       	ld		b, 54						; Coloca espaco no restante
0728   4339 3E 20       	ld		a, ' '
0729   433B             .loop4: 
0730   433B 12          	ld		(de), a
0731   433C 13          	inc		de
0732   433D 10 FC       	djnz	.loop4
0733   433F AF          	xor		a							; informar sem erros
0734   4340 C9          	ret
0735   4341             
0736   4341             ;-----------------------------------------------------------------------------
0737   4341             ;
0738   4341             ; Obtain device status
0739   4341             ;
0740   4341             ;Input:   A = Device index, 1 to 7
0741   4341             ;         B = Logical unit number, 1 to 7
0742   4341             ;             0 to return the status of the device itself.
0743   4341             ;Output:  A = Status for the specified logical unit,
0744   4341             ;             or for the whole device if 0 was specified:
0745   4341             ;                0: The device or logical unit is not available, or the
0746   4341             ;                   device or logical unit number supplied is invalid.
0747   4341             ;                1: The device or logical unit is available and has not
0748   4341             ;                   changed since the last status request.
0749   4341             ;                2: The device or logical unit is available and has changed
0750   4341             ;                   since the last status request
0751   4341             ;                   (for devices, the device has been unplugged and a
0752   4341             ;                    different device has been plugged which has been
0753   4341             ;                    assigned the same device index; for logical units,
0754   4341             ;                    the media has been changed).
0755   4341             ;                3: The device or logical unit is available, but it is not
0756   4341             ;                   possible to determine whether it has been changed
0757   4341             ;                   or not since the last status request.
0758   4341             ;
0759   4341             ; Devices not supporting hot-plugging must always return status value 1.
0760   4341             ; Non removable logical units may return values 0 and 1.
0761   4341             ;
0762   4341             ; The returned status is always relative to the previous invokation of
0763   4341             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0764   4341             
0765   4341             DEV_STATUS: 
0766   4342 BF FE 03    	cp		a, 3						; 2 dispositivos somente
0767   4344 30 38       	jr nc,	.saicomerro
0768   4346 05          	dec		b							; 1 logical unit somente
0769   4347 20 35       	jr nz,	.saicomerro
0770   4349             
0771   4349 F5          	push	af
0772   434A CD C0 43    	call	pegaWorkArea
0773   434D F1          	pop		af
0774   434E FD 77 30    	ld		(iy+NUMSD), a				; salva numero do device atual (1 ou 2)
0775   4351 4F          	ld		c, a
0776   4352 C5          	push	bc
0777   4353 CB 01       	rlc		c
0778   4355 CB 01       	rlc		c							; ......XX => ....XX..
0779   4357 3A 00 7F    	ld		a, (PORTCFG)				; testar se cartao esta inserido
0780   435A A1          	and		c							; C contem 1 se cartao 1, 2 se cartao 2
0781   435B C1          	pop		bc
0782   435C 20 1D       	jr nz,	.cartaoComErro				; se slot do cartao estiver vazio, marcamos o erro nas flags
0783   435E FD 7E 31    	ld		a, (iy+FLAGSCARTAO)			; testar bit de erro do cartao nas flags
0784   4361 A1          	and		c
0785   4362 28 14       	jr z,	.semMudanca					; cartao nao marcado com erro, pula
0786   4364 CD 41 44    	call	detectaCartao				; erro na deteccao do cartao, tentar re-detectar
0787   4367 38 12       	jr c,	.cartaoComErro				; nao conseguimos detectar, sai com erro
0788   4369 FD 7E 30    	ld		a, (iy+NUMSD)				; conseguimos detectar, tira erro nas flags
0789   436C 2F          	cpl									; inverte bits para fazer o AND
0790   436D 4F          	ld		c, a
0791   436E FD 7E 31    	ld		a, (iy+FLAGSCARTAO)
0792   4371 A1          	and		c							; limpa bit
0793   4372 FD 77 31    	ld		(iy+FLAGSCARTAO), a
0794   4375             .comMudanca: 
0795   4375 3E 02       	ld		a, 2						; informa ao Nextor que cartao esta OK e mudou
0796   4377 C9          	ret
0797   4378             .semMudanca: 
0798   4378 3E 01       	ld		a, 1						; informa ao Nextor que cartao esta OK e nao mudou
0799   437A C9          	ret
0800   437B             .cartaoComErro: 
0801   437B CD FE 43    	call	marcaErroCartao				; marcar erro do cartao nas flags
0802   437E             .saicomerro: 
0803   437E 3E 00       	ld		a, 0						; informa erro
0804   4380 C9          	ret
0805   4381             
0806   4381             ;-----------------------------------------------------------------------------
0807   4381             ;
0808   4381             ; Obtain logical unit information
0809   4381             ;
0810   4381             ;Input:   A  = Device index, 1 to 7
0811   4381             ;         B  = Logical unit number, 1 to 7
0812   4381             ;         HL = Pointer to buffer in RAM.
0813   4381             ;Output:  A = 0: Ok, buffer filled with information.
0814   4381             ;             1: Error, device or logical unit not available,
0815   4381             ;                or device index or logical unit number invalid.
0816   4381             ;         On success, buffer filled with the following information:
0817   4381             ;
0818   4381             ;+0 (1): Medium type:
0819   4381             ;        0: Block device
0820   4381             ;        1: CD or DVD reader or recorder
0821   4381             ;        2-254: Unused. Additional codes may be defined in the future.
0822   4381             ;        255: Other
0823   4381             ;+1 (2): Sector size, 0 if this information does not apply or is
0824   4381             ;        not available.
0825   4381             ;+3 (4): Total number of available sectors.
0826   4381             ;        0 if this information does not apply or is not available.
0827   4381             ;+7 (1): Flags:
0828   4381             ;        bit 0: 1 if the medium is removable.
0829   4381             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0830   4381             ;               be write protected or write enabled is not considered
0831   4381             ;               to be read-only.
0832   4381             ;        bit 2: 1 if the LUN is a floppy disk drive.
0833   4381             ;+8 (2): Number of cylinders
0834   4381             ;+10 (1): Number of heads
0835   4381             ;+11 (1): Number of sectors per track
0836   4381             ;
0837   4381             ; Number of cylinders, heads and sectors apply to hard disks only.
0838   4381             ; For other types of device, these fields must be zero.
0839   4381             
0840   4381             LUN_INFO: 
0841   4382 BF FE 03    	cp		a, 3						; somente 2 dispositivo
0842   4384 30 0A       	jr nc,	.saicomerro
0843   4386 05          	dec		b							; somente 1 logical unit
0844   4387 20 07       	jr nz,	.saicomerro
0845   4389 E5          	push	hl
0846   438A CD D6 43    	call	testaCartao
0847   438D E1          	pop		hl
0848   438E 30 03       	jr nc,	.ok						; nao tem erro com o cartao
0849   4390             .saicomerro: 
0850   4390 3E 01       	ld		a, 1						; informar erro
0851   4392 C9          	ret
0852   4393             .ok: 
0853   4393 E5          	push	hl
0854   4394 CD 2D 44    	call	calculaBLOCOSoffset			; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0855   4397 E1          	pop		hl							; do cartao dependendo do cartao atual solicitado
0856   4398 AF          	xor		a
0857   4399 77          	ld		(hl), a						; Informar que o dispositivo eh do tipo block device
0858   439A 23          	inc		hl
0859   439B 77          	ld		(hl), a						; tamanho de um bloco = 512 bytes (coloca $00, $02 que é $200 = 512)
0860   439C 23          	inc		hl
0861   439D 3E 02       	ld		a, 2
0862   439F 77          	ld		(hl), a
0863   43A0 23          	inc		hl
0864   43A1 DD 7E 00    	ld		a, (ix)						; copia numero de blocos total
0865   43A4 77          	ld		(hl), a
0866   43A5 23          	inc		hl
0867   43A6 DD 7E 01    	ld		a, (ix+1)
0868   43A9 77          	ld		(hl), a
0869   43AA 23          	inc		hl
0870   43AB DD 7E 02    	ld		a, (ix+2)
0871   43AE 77          	ld		(hl), a
0872   43AF 23          	inc		hl
0873   43B0 AF          	xor		a							; cartoes SD tem total de blocos em 24 bits, mas o Nextor pede numero de
0874   43B1 77          	ld		(hl), a 					; 32 bits, entao coloca 0 no MSB
0875   43B2 23          	inc		hl
0876   43B3 3E 01       	ld		a, 1						; flags: dispositivo R/W removivel
0877   43B5 77          	ld		(hl), a
0878   43B6 23          	inc		hl
0879   43B7 AF          	xor		a							; CHS = 0
0880   43B8 77          	ld		(hl), a
0881   43B9 23          	inc		hl
0882   43BA 77          	ld		(hl), a
0883   43BB 23          	inc		hl
0884   43BC 77          	ld		(hl), a
0885   43BD 23          	inc		hl
0886   43BE AF          	xor		a							; informar que dados foram preenchidos
0887   43BF C9          	ret
0888   43C0             
0889   43C0             ;=====
0890   43C0             ;=====  END of DEVICE-BASED specific routines
0891   43C0             ;=====
0892   43C0             
0893   43C0             ;------------------------------------------------
0894   43C0             ; Rotinas auxiliares
0895   43C0             ;------------------------------------------------
0896   43C0             
0897   43C0             ;------------------------------------------------
0898   43C0             ; Pedir ao Nextor o ponteiro de dados de trabalho
0899   43C0             ; na RAM e colocar em HL e IY
0900   43C0             ; Destroi HL e IY
0901   43C0             ;------------------------------------------------
0902   43C0             pegaWorkArea: 
0903   43C0 F5          	push	af
0904   43C1 AF          	xor		a				; Pegar endereco da area de trabalho
0905   43C2 08          	ex		af, af'
0906   43C3 AF          	xor		a
0907   43C4 DD 21 45 40 	ld		ix, GWORK
0908   43C8 CD 42 40    	call	CALBNK
0909   43CB DD 6E 00    	ld		l, (ix)			; em HL tem o ponteiro da nossa area da RAM
0910   43CE DD 66 01    	ld		h, (ix+1)
0911   43D1 E5          	push	hl
0912   43D2 FD E1       	pop		iy				; em IY temos o mesmo ponteiro
0913   43D4 F1          	pop		af
0914   43D5 C9          	ret
0915   43D6             
0916   43D6             ;------------------------------------------------
0917   43D6             ; Testa se cartao esta inserido e/ou houve erro
0918   43D6             ; na ultima vez que foi acessado. Carry indica
0919   43D6             ; erro
0920   43D6             ; Destroi AF, HL, IX, C
0921   43D6             ;------------------------------------------------
0922   43D6             testaCartao: 
0923   43D6 F5          	push	af
0924   43D7 CD C0 43    	call	pegaWorkArea
0925   43DA F1          	pop		af
0926   43DB FD 77 30    	ld		(iy+NUMSD), a				; salva numero do device atual (1 ou 2)
0927   43DE 4F          	ld		c, a
0928   43DF C5          	push	bc
0929   43E0 CB 01       	rlc		c
0930   43E2 CB 01       	rlc		c							; ......XX => ....XX..
0931   43E4 3A 00 7F    	ld		a, (PORTCFG)				; testar se cartao esta inserido
0932   43E7 A1          	and		c							; C contem 1 se cartao 1, 2 se cartao 2
0933   43E8 C1          	pop		bc
0934   43E9 20 0A       	jr nz,	.saicomerro
0935   43EB FD 7E 31    	ld		a, (iy+FLAGSCARTAO)			; testar bit de erro do cartao nas flags
0936   43EE A1          	and		c
0937   43EF 28 02       	jr z,	.ok
0938   43F1 37          	scf									; indica erro
0939   43F2 C9          	ret
0940   43F3             .ok: 
0941   43F3 AF          	xor		a							; zera carry indicando sem erro
0942   43F4 C9          	ret
0943   43F5             .saicomerro: 
0944   43F5 FD 7E 31    	ld		a, (iy+FLAGSCARTAO)			; marca bit de erro nas flags
0945   43F8 B1          	or		c
0946   43F9 FD 77 31    	ld		(iy+FLAGSCARTAO), a
0947   43FC 37          	scf
0948   43FD C9          	ret
0949   43FE             
0950   43FE             ;------------------------------------------------
0951   43FE             ; Marcar bit de erro nas flags
0952   43FE             ; Destroi AF, C
0953   43FE             ;------------------------------------------------
0954   43FE             marcaErroCartao: 
0955   43FE FD 4E 30    	ld		c, (iy+NUMSD)				; cartao atual (1 ou 2)
0956   4401 FD 7E 31    	ld		a, (iy+FLAGSCARTAO)			; marcar erro
0957   4404 B1          	or		c
0958   4405 FD 77 31    	ld		(iy+FLAGSCARTAO), a
0959   4408 C9          	ret
0960   4409             
0961   4409             ;------------------------------------------------
0962   4409             ; Testar se cartao atual esta protegido contra
0963   4409             ; gravacao, A=0 se protegido
0964   4409             ; Destroi AF, C
0965   4409             ;------------------------------------------------
0966   4409             testaWP: 
0967   4409 FD 4E 30    	ld		c, (iy+NUMSD)				; cartao atual (1 ou 2)
0968   440C CB 01       	rlc		c
0969   440E CB 01       	rlc		c
0970   4410 CB 01       	rlc		c
0971   4412 CB 01       	rlc		c							; ......XX => ..XX....
0972   4414 3A 00 7F    	ld		a, (PORTCFG)				; testar se cartao esta protegido
0973   4417 A1          	and		c
0974   4418 C9          	ret									; se A for 0 cartao esta protegido
0975   4419             
0976   4419             ;------------------------------------------------
0977   4419             ; Calcula offset do buffer na RAM em HL e IX para
0978   4419             ; os dados do CID dependendo do cartao atual
0979   4419             ; Destroi AF, DE, HL e IX
0980   4419             ;------------------------------------------------
0981   4419             calculaCIDoffset: 
0982   4419 FD E5       	push	iy							; copiamos IY para HL
0983   441B E1          	pop		hl
0984   441C 16 00       	ld		d, 0
0985   441E 1E 10       	ld		e, BCID1					; DE aponta para buffer BCID1
0986   4420 FD 7E 30    	ld		a, (iy+NUMSD)				; vamos fazer IX apontar para o buffer correto
0987   4423 3D          	dec		a							; dependendo do cartao: BCID1 ou BCID2
0988   4424 28 02       	jr z,	.c1
0989   4426 1E 20       	ld		e, BCID2					; DE aponta para buffer BCID2
0990   4428             .c1: 
0991   4428 19          	add		hl, de						; HL aponta para buffer correto
0992   4429 E5          	push	hl		
0993   442A DD E1       	pop		ix							; vamos colocar HL em IX
0994   442C C9          	ret
0995   442D             
0996   442D             ;------------------------------------------------
0997   442D             ; Calcula offset do buffer na RAM para os dados
0998   442D             ; do total de blocos dependendo do cartao atual
0999   442D             ; Offset fica em HL e IX
1000   442D             ; Destroi AF, DE, HL e IX
1001   442D             ;------------------------------------------------
1002   442D             calculaBLOCOSoffset: 
1003   442D FD E5       	push	iy							; copiamos IY para HL
1004   442F E1          	pop		hl
1005   4430 16 00       	ld		d, 0
1006   4432 1E 38       	ld		e, BLOCOS1					; DE aponta para buffer BLOCOS1
1007   4434 FD 7E 30    	ld		a, (iy+NUMSD)				; Vamos fazer IX apontar para o buffer correto
1008   4437 3D          	dec		a							; dependendo do cartao: BLOCOS1 ou BLOCOS2
1009   4438 28 02       	jr z,	.c1
1010   443A 1E 3C       	ld		e, BLOCOS2					; DE aponta para buffer BLOCOS2
1011   443C             .c1: 
1012   443C 19          	add		hl, de						; HL aponta para buffer correto
1013   443D E5          	push	hl		
1014   443E DD E1       	pop		ix							; Vamos colocar HL em IX
1015   4440 C9          	ret
1016   4441             
1017   4441             
1018   4441             ;------------------------------------------------
1019   4441             ; Minhas funcoes para cartao SD
1020   4441             ;------------------------------------------------
1021   4441             
1022   4441             ;------------------------------------------------
1023   4441             ; Processo de inicializacao e deteccao do cartao.
1024   4441             ; Detecta se cartao responde, qual versao (SDV1
1025   4441             ; ou SDV2), faz a leitura do CSD e CID e calcula
1026   4441             ; o numero de blocos do cartao, colocando o CID
1027   4441             ; e total de blocos no buffer correto dependendo
1028   4441             ; do cartao 1 ou 2.
1029   4441             ; Retorna erro no carry. Se for 0 indica deteccao
1030   4441             ; com sucesso.
1031   4441             ; Destroi todos os registradores
1032   4441             ;------------------------------------------------
1033   4441             detectaCartao: 
1034   4441 CD 65 45    	call	iniciaSD						; manda pulsos de clock e comandos iniciais
1035   4444 D8          	ret c									; retorna se erro
1036   4445 CD 10 45    	call	testaSDCV2						; tenta inicializar um cartao SDV2
1037   4448 D8          	ret c
1038   4449 FD E5       	push	iy								; colocar em HL buffer da RAM de trabalho
1039   444B E1          	pop		hl								; CSD esta no offset 0, nao precisamos somar
1040   444C 3E 49       	ld		a, CMD9							; ler CSD
1041   444E CD 31 45    	call	lerBlocoCxD
1042   4451 D8          	ret c
1043   4452 CD 19 44    	call	calculaCIDoffset				; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1044   4455 3E 4A       	ld		a, CMD10						; ler CID
1045   4457 CD 31 45    	call	lerBlocoCxD
1046   445A D8          	ret c
1047   445B 3E 7A       	ld		a, CMD58						; ler OCR
1048   445D 11 00 00    	ld		de, 0
1049   4460 CD B6 45    	call	SD_SEND_CMD_2_ARGS_GET_R3		; enviar comando e receber resposta tipo R3
1050   4463 D8          	ret c
1051   4464 78          	ld		a, b							; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1052   4465 E6 40       	and		$40
1053   4467 DD 77 0F    	ld		(ix+15), a						; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1054   446A CC 05 45    	call z,	mudarTamanhoBlocoPara512		; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1055   446D D8          	ret c									; e nao precisamos mudar tamanho do bloco para 512
1056   446E CD 84 45    	call	desabilitaSDs
1057   4471             											; agora vamos calcular o total de blocos dependendo dos dados do CSD
1058   4471 CD 2D 44    	call	calculaBLOCOSoffset				; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1059   4474 FD E5       	push	iy								; copiamos IY para HL
1060   4476 E1          	pop		hl
1061   4477 16 00       	ld		d, 0
1062   4479 1E 05       	ld		e, BCSD+5
1063   447B 19          	add		hl, de							; HL aponta para buffer BCSD+5
1064   447C FD 7E 00    	ld		a, (iy+BCSD)
1065   447F E6 C0       	and		$C0								; testa versao do registro CSD
1066   4481 28 06       	jr z,	.calculaCSD1
1067   4483 FE 40       	cp		$40
1068   4485 28 54       	jr z,	.calculaCSD2
1069   4487 37          	scf										; versao do registro CSD nao reconhecida, informa erro na deteccao
1070   4488 C9          	ret
1071   4489             
1072   4489             ; -----------------------------------
1073   4489             ; Registro CSD versao 1, calcular da
1074   4489             ; maneira correta para a versao 1
1075   4489             ; -----------------------------------
1076   4489             .calculaCSD1: 
1077   4489 7E          	ld		a, (hl)
1078   448A E6 0F       	and		$0F								; isola READ_BL_LEN
1079   448C F5          	push	af
1080   448D 23          	inc		hl
1081   448E 7E          	ld		a, (hl)							; 2 primeiros bits de C_SIZE
1082   448F E6 03       	and		3
1083   4491 57          	ld		d, a
1084   4492 23          	inc		hl
1085   4493 5E          	ld		e, (hl)							; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1086   4494 23          	inc		hl
1087   4495 7E          	ld		a, (hl)
1088   4496 E6 C0       	and		$C0								; 2 ultimos bits de C_SIZE
1089   4498 87          	add		a, a							; rotaciona a esquerda
1090   4499 CB 13       	rl		e								; rotaciona	para DE
1091   449B CB 12       	rl		d
1092   449D 87          	add		a, a							; mais uma rotacao
1093   449E CB 13       	rl		e								; rotaciona para DE
1094   44A0 CB 12       	rl		d
1095   44A2 13          	inc		de								; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1096   44A3 23          	inc		hl
1097   44A4 7E          	ld		a, (hl)							; proximo byte
1098   44A5 E6 03       	and		3								; 2 bits de C_SIZE_MUL
1099   44A7 47          	ld		b, a							; B contem os 2 bits de C_SIZE_MUL
1100   44A8 23          	inc		hl						
1101   44A9 7E          	ld		a, (hl)							; proximo byte
1102   44AA E6 80       	and		$80								; 1 bit de C_SIZE_MUL
1103   44AC 87          	add		a, a							; rotaciona para esquerda jogando no carry
1104   44AD CB 10       	rl		b								; rotaciona para B
1105   44AF 04          	inc		b								; agora B contem os 3 bits de C_SIZE_MUL
1106   44B0 04          	inc		b								; faz B = C_SIZE_MUL + 2
1107   44B1 F1          	pop		af								; volta em A o READ_BL_LEN
1108   44B2 80          	add		a, b							; A = READ_BL_LEN + (C_SIZE_MUL+2)
1109   44B3 01 00 00    	ld		bc, 0
1110   44B6 CD CF 44    	call	.eleva2
1111   44B9 5A          	ld		e, d							; aqui temos 32 bits (BC DE) com o tamanho do cartao
1112   44BA 51          	ld		d, c							; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1113   44BB 48          	ld		c, b
1114   44BC 06 00       	ld		b, 0
1115   44BE CB 39       	srl		c								; rotacionamos a direita o C, carry = LSB (divide por 2)
1116   44C0 CB 1A       	rr		d								; rotacionamos D e E
1117   44C2 CB 1B       	rr		e								; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1118   44C4             .salvaBlocos: 
1119   44C4 DD 71 02    	ld		(ix+2), c						; colocar no buffer BLOCOS correto a quantidade de blocos
1120   44C7 DD 72 01    	ld		(ix+1), d						; que o cartao (1 ou 2) tem
1121   44CA DD 73 00    	ld		(ix), e
1122   44CD AF          	xor		a								; limpa carry
1123   44CE C9          	ret
1124   44CF             
1125   44CF             .eleva2: 									; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1126   44CF             											; BC = 0
1127   44CF             											; DE = C_SIZE
1128   44CF CB 23       	sla		e								; rotacionamos C_SIZE por 'A' vezes
1129   44D1 CB 12       	rl		d
1130   44D3 CB 11       	rl		c
1131   44D5 CB 10       	rl		b
1132   44D7 3D          	dec		a								; subtraimos 1
1133   44D8 20 F5       	jr nz,	.eleva2
1134   44DA C9          	ret										; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1135   44DB             
1136   44DB             ; -----------------------------------
1137   44DB             ; Registro CSD versao 2, calcular da
1138   44DB             ; maneira correta para a versao 2
1139   44DB             ; -----------------------------------
1140   44DB             .calculaCSD2: 
1141   44DB 23          	inc		hl								; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1142   44DC 23          	inc		hl
1143   44DD 7E          	ld		a, (hl)
1144   44DE E6 3F       	and		$3F
1145   44E0 4F          	ld		c, a
1146   44E1 23          	inc		hl
1147   44E2 56          	ld		d, (hl)
1148   44E3 23          	inc		hl
1149   44E4 5E          	ld		e, (hl)
1150   44E5 CD F1 44    	call	.inc32							; soma 1
1151   44E8 CD F9 44    	call	.desloca32						; multiplica por 512
1152   44EB CD FE 44    	call	.rotaciona24					; multiplica por 2
1153   44EE C3 C4 44    	jp		.salvaBlocos
1154   44F1             
1155   44F1             .inc32: 
1156   44F1 1C          	inc		e
1157   44F2 C0          	ret nz
1158   44F3 14          	inc		d
1159   44F4 C0          	ret nz
1160   44F5 0C          	inc		c
1161   44F6 C0          	ret nz
1162   44F7 04          	inc		b
1163   44F8 C9          	ret
1164   44F9             
1165   44F9             .desloca32: 
1166   44F9 41          	ld		b, c
1167   44FA 4A          	ld		c, d
1168   44FB 53          	ld		d, e
1169   44FC 1E 00       	ld		e, 0
1170   44FE             .rotaciona24: 
1171   44FE CB 22       	sla		d
1172   4500 CB 11       	rl		c
1173   4502 CB 10       	rl		b
1174   4504 C9          	ret
1175   4505             
1176   4505             ; ------------------------------------------------
1177   4505             ; Setar o tamanho do bloco para 512 se o cartao
1178   4505             ; for SDV1
1179   4505             ; ------------------------------------------------
1180   4505             mudarTamanhoBlocoPara512: 
1181   4505 3E 50       	ld		a, CMD16
1182   4507 01 00 00    	ld		bc, 0
1183   450A 11 00 02    	ld		de, 512
1184   450D C3 A1 45    	jp		SD_SEND_CMD_GET_ERROR
1185   4510             
1186   4510             ; ------------------------------------------------
1187   4510             ; Tenta inicializar um cartao SDV2, se houver erro
1188   4510             ; o cartao deve ser SDV1
1189   4510             ; ------------------------------------------------
1190   4510             testaSDCV2: 
1191   4510 3E 48       	ld		a, CMD8
1192   4512 11 AA 01    	ld		de, $1AA
1193   4515 CD B6 45    	call	SD_SEND_CMD_2_ARGS_GET_R3
1194   4518 21 9A 45    	ld		hl, SD_SEND_CMD1			; HL aponta para rotina correta
1195   451B 38 03       	jr c,	.pula						; cartao recusou CMD8, enviar comando CMD1
1196   451D 21 8C 45    	ld		hl, SD_SEND_ACMD41			; cartao aceitou CMD8, enviar comando ACMD41
1197   4520             .pula: 
1198   4520 01 14 00    	ld		bc, 20						; B = 0, C = 20: 5120 tentativas
1199   4523             .loop: 
1200   4523 C5          	push	bc
1201   4524 CD 30 45    	call	.jumpHL						; chamar rotina correta em HL
1202   4527 C1          	pop		bc
1203   4528 D0          	ret nc
1204   4529 10 F8       	djnz	.loop
1205   452B 0D          	dec		c
1206   452C 20 F5       	jr nz,	.loop
1207   452E 37          	scf
1208   452F C9          	ret
1209   4530             .jumpHL: 
1210   4530 E9          	jp	(hl)							; chamar rotina correta em HL
1211   4531             
1212   4531             ; ------------------------------------------------
1213   4531             ; Ler registro CID ou CSD, o comando vem em A
1214   4531             ; ------------------------------------------------
1215   4531             lerBlocoCxD: 
1216   4531 CD 9C 45    	call	SD_SEND_CMD_NO_ARGS
1217   4534 D8          	ret c
1218   4535 CD FF 45    	call	WAIT_RESP_FE
1219   4538 D8          	ret c
1220   4539 11 00 7B    	ld		de, PORTSPI
1221   453C EB          	ex		hl, de
1222   453D ED A0       > ldi							
1222   453F ED A0       > ldi							
1222   4541 ED A0       > ldi							
1222   4543 ED A0       > ldi							
1222   4545 ED A0       > ldi							
1222   4547 ED A0       > ldi							
1222   4549 ED A0       > ldi							
1222   454B ED A0       > ldi							
1222   454D ED A0       > ldi							
1222   454F ED A0       > ldi							
1222   4551 ED A0       > ldi							
1222   4553 ED A0       > ldi							
1222   4555 ED A0       > ldi							
1222   4557 ED A0       > ldi							
1222   4559 ED A0       > ldi							
1222   455B ED A0       > ldi							
1223   455D 00          	nop
1224   455E 7E          	ld		a, (hl)
1225   455F 00          	nop
1226   4560 7E          	ld		a, (hl)						; byte de resposta
1227   4561 B7          	or		a
1228   4562 EB          	ex		hl, de
1229   4563 18 1F       	jr		desabilitaSDs
1230   4565             
1231   4565             ; ------------------------------------------------
1232   4565             ; Algoritmo para inicializar um cartao SD
1233   4565             ; Destroi AF, B, DE
1234   4565             ; ------------------------------------------------
1235   4565             iniciaSD: 
1236   4565 CD 84 45    	call	desabilitaSDs
1237   4568             
1238   4568 06 0A       	ld		b, 10						; enviar 80 pulsos de clock com cartao desabilitado
1239   456A             enviaClocksInicio: 
1240   456A 3E FF       	ld		a, $FF						; manter MOSI em 1
1241   456C 32 00 7B    	ld		(PORTSPI), a
1242   456F 10 F9       	djnz	enviaClocksInicio
1243   4571 CD 2B 46    	call	setaSDAtual					; ativar cartao atual
1244   4574 06 08       	ld		b, 8						; 8 tentativas para CMD0
1245   4576             SD_SEND_CMD0: 
1246   4576 3E 40       	ld		a, CMD0						; primeiro comando: CMD0
1247   4578 11 00 00    	ld		de, 0
1248   457B C5          	push	bc
1249   457C CD A9 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1250   457F C1          	pop		bc
1251   4580 D0          	ret nc								; retorna se cartao respondeu ao CMD0
1252   4581 10 F3       	djnz	SD_SEND_CMD0
1253   4583 37          	scf									; cartao nao respondeu ao CMD0, informar erro
1254   4584             	; fall throw
1255   4584             
1256   4584             ; ------------------------------------------------
1257   4584             ; Desabilitar (de-selecionar) todos os cartoes
1258   4584             ; Nao destroi registradores
1259   4584             ; ------------------------------------------------
1260   4584             desabilitaSDs: 
1261   4584 F5          	push	af
1262   4585 3E FF       	ld		a, $FF						; todos os /CS em 1
1263   4587 32 00 7F    	ld		(PORTCFG), a
1264   458A F1          	pop		af
1265   458B C9          	ret
1266   458C             
1267   458C             ; ------------------------------------------------
1268   458C             ; Enviar comando ACMD41
1269   458C             ; ------------------------------------------------
1270   458C             SD_SEND_ACMD41: 
1271   458C 3E 77       	ld		a, CMD55
1272   458E CD 9C 45    	call	SD_SEND_CMD_NO_ARGS
1273   4591 3E 69       	ld		a, ACMD41
1274   4593 01 00 40    	ld		bc, $4000
1275   4596 51          	ld		d, c
1276   4597 59          	ld		e, c
1277   4598 18 07       	jr		SD_SEND_CMD_GET_ERROR
1278   459A             
1279   459A             ; ------------------------------------------------
1280   459A             ; Enviar CMD1 para cartao. Carry indica erro
1281   459A             ; Destroi AF, BC, DE
1282   459A             ; ------------------------------------------------
1283   459A             SD_SEND_CMD1: 
1284   459A 3E 41       	ld		a, CMD1
1285   459C             SD_SEND_CMD_NO_ARGS: 
1286   459C 01 00 00    	ld		bc, 0
1287   459F 50          	ld		d, b
1288   45A0 59          	ld		e, c
1289   45A1             SD_SEND_CMD_GET_ERROR: 
1290   45A1 CD CF 45    	call	SD_SEND_CMD
1291   45A4 B7          	or		a
1292   45A5 C8          	ret z								; se A=0 nao houve erro, retornar
1293   45A6             	; fall throw
1294   45A6             
1295   45A6             ; ------------------------------------------------
1296   45A6             ; Informar erro
1297   45A6             ; Nao destroi registradores
1298   45A6             ; ------------------------------------------------
1299   45A6             setaErro: 
1300   45A6 37          	scf
1301   45A7 18 DB       	jr		desabilitaSDs
1302   45A9             
1303   45A9             ; ------------------------------------------------
1304   45A9             ; Enviar comando em A com 2 bytes de parametros
1305   45A9             ; em DE e testar retorno BUSY
1306   45A9             ; Retorna em A a resposta do cartao
1307   45A9             ; Destroi AF, BC
1308   45A9             ; ------------------------------------------------
1309   45A9             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1310   45A9 01 00 00    	ld		bc, 0
1311   45AC CD CF 45    	call	SD_SEND_CMD
1312   45AF 47          	ld		b, a
1313   45B0 E6 FE       	and		$FE							; testar bit 0 (flag BUSY)
1314   45B2 78          	ld		a, b
1315   45B3 20 F1       	jr nz,	setaErro					; BUSY em 1, informar erro
1316   45B5 C9          	ret									; sem erros
1317   45B6             
1318   45B6             ; ------------------------------------------------
1319   45B6             ; Enviar comando em A com 2 bytes de parametros
1320   45B6             ; em DE e ler resposta do tipo R3 em BC DE
1321   45B6             ; Retorna em A a resposta do cartao
1322   45B6             ; Destroi AF, BC, DE, HL
1323   45B6             ; ------------------------------------------------
1324   45B6             SD_SEND_CMD_2_ARGS_GET_R3: 
1325   45B6 CD A9 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1326   45B9 D8          	ret c
1327   45BA F5          	push	af
1328   45BB CD 0D 46    	call	WAIT_RESP_NO_FF
1329   45BE 67          	ld		h, a
1330   45BF CD 0D 46    	call	WAIT_RESP_NO_FF
1331   45C2 6F          	ld		l, a
1332   45C3 CD 0D 46    	call	WAIT_RESP_NO_FF
1333   45C6 57          	ld		d, a
1334   45C7 CD 0D 46    	call	WAIT_RESP_NO_FF
1335   45CA 5F          	ld		e, a
1336   45CB 44          	ld		b, h
1337   45CC 4D          	ld		c, l
1338   45CD F1          	pop		af
1339   45CE C9          	ret
1340   45CF             
1341   45CF             ; ------------------------------------------------
1342   45CF             ; Enviar comando em A com 4 bytes de parametros
1343   45CF             ; em BC DE e enviar CRC correto se for CMD0 ou 
1344   45CF             ; CMD8 e aguardar processamento do cartao
1345   45CF             ; Destroi AF, BC
1346   45CF             ; ------------------------------------------------
1347   45CF             SD_SEND_CMD: 
1348   45CF CD 2B 46    	call	setaSDAtual
1349   45D2 32 00 7B    	ld		(PORTSPI), a
1350   45D5 F5          	push	af
1351   45D6 78          	ld		a, b
1352   45D7 00          	nop
1353   45D8 32 00 7B    	ld		(PORTSPI), a
1354   45DB 79          	ld		a, c
1355   45DC 00          	nop
1356   45DD 32 00 7B    	ld		(PORTSPI), a
1357   45E0 7A          	ld		a, d
1358   45E1 00          	nop
1359   45E2 32 00 7B    	ld		(PORTSPI), a
1360   45E5 7B          	ld		a, e
1361   45E6 00          	nop
1362   45E7 32 00 7B    	ld		(PORTSPI), a
1363   45EA F1          	pop		af
1364   45EB FE 40       	cp		CMD0
1365   45ED 06 95       	ld		b, $95						; CRC para CMD0
1366   45EF 28 08       	jr z,	enviaCRC
1367   45F1 FE 48       	cp		CMD8
1368   45F3 06 87       	ld		b, $87						; CRC para CMD8
1369   45F5 28 02       	jr z,	enviaCRC
1370   45F7 06 FF       	ld		b, $FF						; CRC dummy
1371   45F9             enviaCRC: 
1372   45F9 78          	ld		a, b
1373   45FA 32 00 7B    	ld		(PORTSPI), a
1374   45FD 18 0E       	jr		WAIT_RESP_NO_FF
1375   45FF             
1376   45FF             ; ------------------------------------------------
1377   45FF             ; Esperar que resposta do cartao seja $FE
1378   45FF             ; Destroi AF, B
1379   45FF             ; ------------------------------------------------
1380   45FF             WAIT_RESP_FE: 
1381   45FF 06 0A       	ld		b, 10						; 10 tentativas
1382   4601             .loop: 
1383   4601 C5          	push	bc
1384   4602 CD 0D 46    	call	WAIT_RESP_NO_FF				; esperar resposta diferente de $FF
1385   4605 C1          	pop		bc
1386   4606 FE FE       	cp		$FE							; resposta é $FE ?
1387   4608 C8          	ret z								; sim, retornamos com carry=0
1388   4609 10 F6       	djnz	.loop
1389   460B 37          	scf									; erro, carry=1
1390   460C C9          	ret
1391   460D             
1392   460D             ; ------------------------------------------------
1393   460D             ; Esperar que resposta do cartao seja diferente
1394   460D             ; de $FF
1395   460D             ; Destroi AF, BC
1396   460D             ; ------------------------------------------------
1397   460D             WAIT_RESP_NO_FF: 
1398   460D 01 01 00    	ld		bc, 1						; 256 tentativas
1399   4610             .loop: 
1400   4610 3A 00 7B    	ld		a, (PORTSPI)
1401   4613 FE FF       	cp		$FF							; testa $FF
1402   4615 C0          	ret nz								; sai se nao for $FF
1403   4616 10 F8       	djnz	.loop
1404   4618 0D          	dec		c
1405   4619 20 F5       	jr nz,	.loop
1406   461B C9          	ret
1407   461C             
1408   461C             ; ------------------------------------------------
1409   461C             ; Esperar que resposta do cartao seja diferente
1410   461C             ; de $00
1411   461C             ; Destroi A, BC
1412   461C             ; ------------------------------------------------
1413   461C             WAIT_RESP_NO_00: 
1414   461C 01 80 00    	ld		bc, 128						; 32768 tentativas
1415   461F             .loop: 
1416   461F 3A 00 7B    	ld		a, (PORTSPI)
1417   4622 B7          	or		a
1418   4623 C0          	ret nz								; se resposta for <> $00, sai
1419   4624 10 F9       	djnz	.loop
1420   4626 0D          	dec		c
1421   4627 20 F6       	jr nz,	.loop
1422   4629 37          	scf									; erro
1423   462A C9          	ret
1424   462B             
1425   462B             ; ------------------------------------------------
1426   462B             ; Ativa (seleciona) cartao atual baixando seu /CS
1427   462B             ; Nao destroi registradores
1428   462B             ; ------------------------------------------------
1429   462B             setaSDAtual: 
1430   462B F5          	push	af
1431   462C 3A 00 7B    	ld		a, (PORTSPI)				; dummy read
1432   462F FD 7E 30    	ld		a, (iy+NUMSD)
1433   4632 2F          	cpl									; inverte bits
1434   4633 32 00 7F    	ld		(PORTCFG), a
1435   4636 F1          	pop		af
1436   4637 C9          	ret
1437   4638             
1438   4638             
1439   4638             ; ------------------------------------------------
1440   4638             ; Grava um bloco de 512 bytes no cartao
1441   4638             ; HL aponta para o inicio dos dados
1442   4638             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1443   4638             ; Destroi AF, BC, DE, HL
1444   4638             ; ------------------------------------------------
1445   4638             GravarBloco: 
1446   4638 DD 7E 0F    	ld		a, (ix+15)					; verificar se eh SDV1 ou SDV2
1447   463B B7          	or		a
1448   463C CC 3F 57    	call z,	blocoParaByte				; se for SDV1 coverter blocos para bytes
1449   463F CD 2B 46    	call	setaSDAtual					; selecionar cartao atual
1450   4642 FD 7E 32    	ld		a, (iy+NUMBLOCOS)			; testar se Nextor quer gravar 1 ou mais blocos
1451   4645 3D          	dec		a
1452   4646 CA AD 4A    	jp z,	.umBloco					; somente um bloco, gravar usando CMD24
1453   4649             
1454   4649             ; multiplos blocos
1455   4649 C5          	push	bc
1456   464A D5          	push	de
1457   464B 3E 77       	ld		a, CMD55					; Multiplos blocos, mandar ACMD23 com total de blocos
1458   464D CD 9C 45    	call	SD_SEND_CMD_NO_ARGS
1459   4650 3E 57       	ld		a, ACMD23
1460   4652 01 00 00    	ld		bc, 0
1461   4655 51          	ld		d, c
1462   4656 FD 5E 32    	ld		e, (iy+NUMBLOCOS)			; parametro = total de blocos a gravar
1463   4659 CD A1 45    	call	SD_SEND_CMD_GET_ERROR
1464   465C D1          	pop		de
1465   465D C1          	pop		bc
1466   465E DA B4 4A    	jp c,	.erro						; erro no ACMD23
1467   4661 3E 59       	ld		a, CMD25					; comando CMD25 = write multiple blocks
1468   4663 CD A1 45    	call	SD_SEND_CMD_GET_ERROR
1469   4666 DA B4 4A    	jp c,	.erro						; erro
1470   4669             .loop: 
1471   4669 3E FC       	ld		a, $FC						; mandar $FC para indicar que os proximos dados sao
1472   466B 32 00 7B    	ld		(PORTSPI),	a				; dados para gravacao
1473   466E 11 00 7B    	ld		de, PORTSPI
1474   4671 ED A0       > ldi							
1474   4673 ED A0       > ldi							
1474   4675 ED A0       > ldi							
1474   4677 ED A0       > ldi							
1474   4679 ED A0       > ldi							
1474   467B ED A0       > ldi							
1474   467D ED A0       > ldi							
1474   467F ED A0       > ldi							
1474   4681 ED A0       > ldi							
1474   4683 ED A0       > ldi							
1474   4685 ED A0       > ldi							
1474   4687 ED A0       > ldi							
1474   4689 ED A0       > ldi							
1474   468B ED A0       > ldi							
1474   468D ED A0       > ldi							
1474   468F ED A0       > ldi							
1474   4691 ED A0       > ldi							
1474   4693 ED A0       > ldi							
1474   4695 ED A0       > ldi							
1474   4697 ED A0       > ldi							
1474   4699 ED A0       > ldi							
1474   469B ED A0       > ldi							
1474   469D ED A0       > ldi							
1474   469F ED A0       > ldi							
1474   46A1 ED A0       > ldi							
1474   46A3 ED A0       > ldi							
1474   46A5 ED A0       > ldi							
1474   46A7 ED A0       > ldi							
1474   46A9 ED A0       > ldi							
1474   46AB ED A0       > ldi							
1474   46AD ED A0       > ldi							
1474   46AF ED A0       > ldi							
1474   46B1 ED A0       > ldi							
1474   46B3 ED A0       > ldi							
1474   46B5 ED A0       > ldi							
1474   46B7 ED A0       > ldi							
1474   46B9 ED A0       > ldi							
1474   46BB ED A0       > ldi							
1474   46BD ED A0       > ldi							
1474   46BF ED A0       > ldi							
1474   46C1 ED A0       > ldi							
1474   46C3 ED A0       > ldi							
1474   46C5 ED A0       > ldi							
1474   46C7 ED A0       > ldi							
1474   46C9 ED A0       > ldi							
1474   46CB ED A0       > ldi							
1474   46CD ED A0       > ldi							
1474   46CF ED A0       > ldi							
1474   46D1 ED A0       > ldi							
1474   46D3 ED A0       > ldi							
1474   46D5 ED A0       > ldi							
1474   46D7 ED A0       > ldi							
1474   46D9 ED A0       > ldi							
1474   46DB ED A0       > ldi							
1474   46DD ED A0       > ldi							
1474   46DF ED A0       > ldi							
1474   46E1 ED A0       > ldi							
1474   46E3 ED A0       > ldi							
1474   46E5 ED A0       > ldi							
1474   46E7 ED A0       > ldi							
1474   46E9 ED A0       > ldi							
1474   46EB ED A0       > ldi							
1474   46ED ED A0       > ldi							
1474   46EF ED A0       > ldi							
1474   46F1 ED A0       > ldi							
1474   46F3 ED A0       > ldi							
1474   46F5 ED A0       > ldi							
1474   46F7 ED A0       > ldi							
1474   46F9 ED A0       > ldi							
1474   46FB ED A0       > ldi							
1474   46FD ED A0       > ldi							
1474   46FF ED A0       > ldi							
1474   4701 ED A0       > ldi							
1474   4703 ED A0       > ldi							
1474   4705 ED A0       > ldi							
1474   4707 ED A0       > ldi							
1474   4709 ED A0       > ldi							
1474   470B ED A0       > ldi							
1474   470D ED A0       > ldi							
1474   470F ED A0       > ldi							
1474   4711 ED A0       > ldi							
1474   4713 ED A0       > ldi							
1474   4715 ED A0       > ldi							
1474   4717 ED A0       > ldi							
1474   4719 ED A0       > ldi							
1474   471B ED A0       > ldi							
1474   471D ED A0       > ldi							
1474   471F ED A0       > ldi							
1474   4721 ED A0       > ldi							
1474   4723 ED A0       > ldi							
1474   4725 ED A0       > ldi							
1474   4727 ED A0       > ldi							
1474   4729 ED A0       > ldi							
1474   472B ED A0       > ldi							
1474   472D ED A0       > ldi							
1474   472F ED A0       > ldi							
1474   4731 ED A0       > ldi							
1474   4733 ED A0       > ldi							
1474   4735 ED A0       > ldi							
1474   4737 ED A0       > ldi							
1474   4739 ED A0       > ldi							
1474   473B ED A0       > ldi							
1474   473D ED A0       > ldi							
1474   473F ED A0       > ldi							
1474   4741 ED A0       > ldi							
1474   4743 ED A0       > ldi							
1474   4745 ED A0       > ldi							
1474   4747 ED A0       > ldi							
1474   4749 ED A0       > ldi							
1474   474B ED A0       > ldi							
1474   474D ED A0       > ldi							
1474   474F ED A0       > ldi							
1474   4751 ED A0       > ldi							
1474   4753 ED A0       > ldi							
1474   4755 ED A0       > ldi							
1474   4757 ED A0       > ldi							
1474   4759 ED A0       > ldi							
1474   475B ED A0       > ldi							
1474   475D ED A0       > ldi							
1474   475F ED A0       > ldi							
1474   4761 ED A0       > ldi							
1474   4763 ED A0       > ldi							
1474   4765 ED A0       > ldi							
1474   4767 ED A0       > ldi							
1474   4769 ED A0       > ldi							
1474   476B ED A0       > ldi							
1474   476D ED A0       > ldi							
1474   476F ED A0       > ldi							
1474   4771 ED A0       > ldi							
1474   4773 ED A0       > ldi							
1474   4775 ED A0       > ldi							
1474   4777 ED A0       > ldi							
1474   4779 ED A0       > ldi							
1474   477B ED A0       > ldi							
1474   477D ED A0       > ldi							
1474   477F ED A0       > ldi							
1474   4781 ED A0       > ldi							
1474   4783 ED A0       > ldi							
1474   4785 ED A0       > ldi							
1474   4787 ED A0       > ldi							
1474   4789 ED A0       > ldi							
1474   478B ED A0       > ldi							
1474   478D ED A0       > ldi							
1474   478F ED A0       > ldi							
1474   4791 ED A0       > ldi							
1474   4793 ED A0       > ldi							
1474   4795 ED A0       > ldi							
1474   4797 ED A0       > ldi							
1474   4799 ED A0       > ldi							
1474   479B ED A0       > ldi							
1474   479D ED A0       > ldi							
1474   479F ED A0       > ldi							
1474   47A1 ED A0       > ldi							
1474   47A3 ED A0       > ldi							
1474   47A5 ED A0       > ldi							
1474   47A7 ED A0       > ldi							
1474   47A9 ED A0       > ldi							
1474   47AB ED A0       > ldi							
1474   47AD ED A0       > ldi							
1474   47AF ED A0       > ldi							
1474   47B1 ED A0       > ldi							
1474   47B3 ED A0       > ldi							
1474   47B5 ED A0       > ldi							
1474   47B7 ED A0       > ldi							
1474   47B9 ED A0       > ldi							
1474   47BB ED A0       > ldi							
1474   47BD ED A0       > ldi							
1474   47BF ED A0       > ldi							
1474   47C1 ED A0       > ldi							
1474   47C3 ED A0       > ldi							
1474   47C5 ED A0       > ldi							
1474   47C7 ED A0       > ldi							
1474   47C9 ED A0       > ldi							
1474   47CB ED A0       > ldi							
1474   47CD ED A0       > ldi							
1474   47CF ED A0       > ldi							
1474   47D1 ED A0       > ldi							
1474   47D3 ED A0       > ldi							
1474   47D5 ED A0       > ldi							
1474   47D7 ED A0       > ldi							
1474   47D9 ED A0       > ldi							
1474   47DB ED A0       > ldi							
1474   47DD ED A0       > ldi							
1474   47DF ED A0       > ldi							
1474   47E1 ED A0       > ldi							
1474   47E3 ED A0       > ldi							
1474   47E5 ED A0       > ldi							
1474   47E7 ED A0       > ldi							
1474   47E9 ED A0       > ldi							
1474   47EB ED A0       > ldi							
1474   47ED ED A0       > ldi							
1474   47EF ED A0       > ldi							
1474   47F1 ED A0       > ldi							
1474   47F3 ED A0       > ldi							
1474   47F5 ED A0       > ldi							
1474   47F7 ED A0       > ldi							
1474   47F9 ED A0       > ldi							
1474   47FB ED A0       > ldi							
1474   47FD ED A0       > ldi							
1474   47FF ED A0       > ldi							
1474   4801 ED A0       > ldi							
1474   4803 ED A0       > ldi							
1474   4805 ED A0       > ldi							
1474   4807 ED A0       > ldi							
1474   4809 ED A0       > ldi							
1474   480B ED A0       > ldi							
1474   480D ED A0       > ldi							
1474   480F ED A0       > ldi							
1474   4811 ED A0       > ldi							
1474   4813 ED A0       > ldi							
1474   4815 ED A0       > ldi							
1474   4817 ED A0       > ldi							
1474   4819 ED A0       > ldi							
1474   481B ED A0       > ldi							
1474   481D ED A0       > ldi							
1474   481F ED A0       > ldi							
1474   4821 ED A0       > ldi							
1474   4823 ED A0       > ldi							
1474   4825 ED A0       > ldi							
1474   4827 ED A0       > ldi							
1474   4829 ED A0       > ldi							
1474   482B ED A0       > ldi							
1474   482D ED A0       > ldi							
1474   482F ED A0       > ldi							
1474   4831 ED A0       > ldi							
1474   4833 ED A0       > ldi							
1474   4835 ED A0       > ldi							
1474   4837 ED A0       > ldi							
1474   4839 ED A0       > ldi							
1474   483B ED A0       > ldi							
1474   483D ED A0       > ldi							
1474   483F ED A0       > ldi							
1474   4841 ED A0       > ldi							
1474   4843 ED A0       > ldi							
1474   4845 ED A0       > ldi							
1474   4847 ED A0       > ldi							
1474   4849 ED A0       > ldi							
1474   484B ED A0       > ldi							
1474   484D ED A0       > ldi							
1474   484F ED A0       > ldi							
1474   4851 ED A0       > ldi							
1474   4853 ED A0       > ldi							
1474   4855 ED A0       > ldi							
1474   4857 ED A0       > ldi							
1474   4859 ED A0       > ldi							
1474   485B ED A0       > ldi							
1474   485D ED A0       > ldi							
1474   485F ED A0       > ldi							
1474   4861 ED A0       > ldi							
1474   4863 ED A0       > ldi							
1474   4865 ED A0       > ldi							
1474   4867 ED A0       > ldi							
1474   4869 ED A0       > ldi							
1474   486B ED A0       > ldi							
1474   486D ED A0       > ldi							
1474   486F ED A0       > ldi							
1474   4871 ED A0       > ldi							
1474   4873 ED A0       > ldi							
1474   4875 ED A0       > ldi							
1474   4877 ED A0       > ldi							
1474   4879 ED A0       > ldi							
1474   487B ED A0       > ldi							
1474   487D ED A0       > ldi							
1474   487F ED A0       > ldi							
1474   4881 ED A0       > ldi							
1474   4883 ED A0       > ldi							
1474   4885 ED A0       > ldi							
1474   4887 ED A0       > ldi							
1474   4889 ED A0       > ldi							
1474   488B ED A0       > ldi							
1474   488D ED A0       > ldi							
1474   488F ED A0       > ldi							
1474   4891 ED A0       > ldi							
1474   4893 ED A0       > ldi							
1474   4895 ED A0       > ldi							
1474   4897 ED A0       > ldi							
1474   4899 ED A0       > ldi							
1474   489B ED A0       > ldi							
1474   489D ED A0       > ldi							
1474   489F ED A0       > ldi							
1474   48A1 ED A0       > ldi							
1474   48A3 ED A0       > ldi							
1474   48A5 ED A0       > ldi							
1474   48A7 ED A0       > ldi							
1474   48A9 ED A0       > ldi							
1474   48AB ED A0       > ldi							
1474   48AD ED A0       > ldi							
1474   48AF ED A0       > ldi							
1474   48B1 ED A0       > ldi							
1474   48B3 ED A0       > ldi							
1474   48B5 ED A0       > ldi							
1474   48B7 ED A0       > ldi							
1474   48B9 ED A0       > ldi							
1474   48BB ED A0       > ldi							
1474   48BD ED A0       > ldi							
1474   48BF ED A0       > ldi							
1474   48C1 ED A0       > ldi							
1474   48C3 ED A0       > ldi							
1474   48C5 ED A0       > ldi							
1474   48C7 ED A0       > ldi							
1474   48C9 ED A0       > ldi							
1474   48CB ED A0       > ldi							
1474   48CD ED A0       > ldi							
1474   48CF ED A0       > ldi							
1474   48D1 ED A0       > ldi							
1474   48D3 ED A0       > ldi							
1474   48D5 ED A0       > ldi							
1474   48D7 ED A0       > ldi							
1474   48D9 ED A0       > ldi							
1474   48DB ED A0       > ldi							
1474   48DD ED A0       > ldi							
1474   48DF ED A0       > ldi							
1474   48E1 ED A0       > ldi							
1474   48E3 ED A0       > ldi							
1474   48E5 ED A0       > ldi							
1474   48E7 ED A0       > ldi							
1474   48E9 ED A0       > ldi							
1474   48EB ED A0       > ldi							
1474   48ED ED A0       > ldi							
1474   48EF ED A0       > ldi							
1474   48F1 ED A0       > ldi							
1474   48F3 ED A0       > ldi							
1474   48F5 ED A0       > ldi							
1474   48F7 ED A0       > ldi							
1474   48F9 ED A0       > ldi							
1474   48FB ED A0       > ldi							
1474   48FD ED A0       > ldi							
1474   48FF ED A0       > ldi							
1474   4901 ED A0       > ldi							
1474   4903 ED A0       > ldi							
1474   4905 ED A0       > ldi							
1474   4907 ED A0       > ldi							
1474   4909 ED A0       > ldi							
1474   490B ED A0       > ldi							
1474   490D ED A0       > ldi							
1474   490F ED A0       > ldi							
1474   4911 ED A0       > ldi							
1474   4913 ED A0       > ldi							
1474   4915 ED A0       > ldi							
1474   4917 ED A0       > ldi							
1474   4919 ED A0       > ldi							
1474   491B ED A0       > ldi							
1474   491D ED A0       > ldi							
1474   491F ED A0       > ldi							
1474   4921 ED A0       > ldi							
1474   4923 ED A0       > ldi							
1474   4925 ED A0       > ldi							
1474   4927 ED A0       > ldi							
1474   4929 ED A0       > ldi							
1474   492B ED A0       > ldi							
1474   492D ED A0       > ldi							
1474   492F ED A0       > ldi							
1474   4931 ED A0       > ldi							
1474   4933 ED A0       > ldi							
1474   4935 ED A0       > ldi							
1474   4937 ED A0       > ldi							
1474   4939 ED A0       > ldi							
1474   493B ED A0       > ldi							
1474   493D ED A0       > ldi							
1474   493F ED A0       > ldi							
1474   4941 ED A0       > ldi							
1474   4943 ED A0       > ldi							
1474   4945 ED A0       > ldi							
1474   4947 ED A0       > ldi							
1474   4949 ED A0       > ldi							
1474   494B ED A0       > ldi							
1474   494D ED A0       > ldi							
1474   494F ED A0       > ldi							
1474   4951 ED A0       > ldi							
1474   4953 ED A0       > ldi							
1474   4955 ED A0       > ldi							
1474   4957 ED A0       > ldi							
1474   4959 ED A0       > ldi							
1474   495B ED A0       > ldi							
1474   495D ED A0       > ldi							
1474   495F ED A0       > ldi							
1474   4961 ED A0       > ldi							
1474   4963 ED A0       > ldi							
1474   4965 ED A0       > ldi							
1474   4967 ED A0       > ldi							
1474   4969 ED A0       > ldi							
1474   496B ED A0       > ldi							
1474   496D ED A0       > ldi							
1474   496F ED A0       > ldi							
1474   4971 ED A0       > ldi							
1474   4973 ED A0       > ldi							
1474   4975 ED A0       > ldi							
1474   4977 ED A0       > ldi							
1474   4979 ED A0       > ldi							
1474   497B ED A0       > ldi							
1474   497D ED A0       > ldi							
1474   497F ED A0       > ldi							
1474   4981 ED A0       > ldi							
1474   4983 ED A0       > ldi							
1474   4985 ED A0       > ldi							
1474   4987 ED A0       > ldi							
1474   4989 ED A0       > ldi							
1474   498B ED A0       > ldi							
1474   498D ED A0       > ldi							
1474   498F ED A0       > ldi							
1474   4991 ED A0       > ldi							
1474   4993 ED A0       > ldi							
1474   4995 ED A0       > ldi							
1474   4997 ED A0       > ldi							
1474   4999 ED A0       > ldi							
1474   499B ED A0       > ldi							
1474   499D ED A0       > ldi							
1474   499F ED A0       > ldi							
1474   49A1 ED A0       > ldi							
1474   49A3 ED A0       > ldi							
1474   49A5 ED A0       > ldi							
1474   49A7 ED A0       > ldi							
1474   49A9 ED A0       > ldi							
1474   49AB ED A0       > ldi							
1474   49AD ED A0       > ldi							
1474   49AF ED A0       > ldi							
1474   49B1 ED A0       > ldi							
1474   49B3 ED A0       > ldi							
1474   49B5 ED A0       > ldi							
1474   49B7 ED A0       > ldi							
1474   49B9 ED A0       > ldi							
1474   49BB ED A0       > ldi							
1474   49BD ED A0       > ldi							
1474   49BF ED A0       > ldi							
1474   49C1 ED A0       > ldi							
1474   49C3 ED A0       > ldi							
1474   49C5 ED A0       > ldi							
1474   49C7 ED A0       > ldi							
1474   49C9 ED A0       > ldi							
1474   49CB ED A0       > ldi							
1474   49CD ED A0       > ldi							
1474   49CF ED A0       > ldi							
1474   49D1 ED A0       > ldi							
1474   49D3 ED A0       > ldi							
1474   49D5 ED A0       > ldi							
1474   49D7 ED A0       > ldi							
1474   49D9 ED A0       > ldi							
1474   49DB ED A0       > ldi							
1474   49DD ED A0       > ldi							
1474   49DF ED A0       > ldi							
1474   49E1 ED A0       > ldi							
1474   49E3 ED A0       > ldi							
1474   49E5 ED A0       > ldi							
1474   49E7 ED A0       > ldi							
1474   49E9 ED A0       > ldi							
1474   49EB ED A0       > ldi							
1474   49ED ED A0       > ldi							
1474   49EF ED A0       > ldi							
1474   49F1 ED A0       > ldi							
1474   49F3 ED A0       > ldi							
1474   49F5 ED A0       > ldi							
1474   49F7 ED A0       > ldi							
1474   49F9 ED A0       > ldi							
1474   49FB ED A0       > ldi							
1474   49FD ED A0       > ldi							
1474   49FF ED A0       > ldi							
1474   4A01 ED A0       > ldi							
1474   4A03 ED A0       > ldi							
1474   4A05 ED A0       > ldi							
1474   4A07 ED A0       > ldi							
1474   4A09 ED A0       > ldi							
1474   4A0B ED A0       > ldi							
1474   4A0D ED A0       > ldi							
1474   4A0F ED A0       > ldi							
1474   4A11 ED A0       > ldi							
1474   4A13 ED A0       > ldi							
1474   4A15 ED A0       > ldi							
1474   4A17 ED A0       > ldi							
1474   4A19 ED A0       > ldi							
1474   4A1B ED A0       > ldi							
1474   4A1D ED A0       > ldi							
1474   4A1F ED A0       > ldi							
1474   4A21 ED A0       > ldi							
1474   4A23 ED A0       > ldi							
1474   4A25 ED A0       > ldi							
1474   4A27 ED A0       > ldi							
1474   4A29 ED A0       > ldi							
1474   4A2B ED A0       > ldi							
1474   4A2D ED A0       > ldi							
1474   4A2F ED A0       > ldi							
1474   4A31 ED A0       > ldi							
1474   4A33 ED A0       > ldi							
1474   4A35 ED A0       > ldi							
1474   4A37 ED A0       > ldi							
1474   4A39 ED A0       > ldi							
1474   4A3B ED A0       > ldi							
1474   4A3D ED A0       > ldi							
1474   4A3F ED A0       > ldi							
1474   4A41 ED A0       > ldi							
1474   4A43 ED A0       > ldi							
1474   4A45 ED A0       > ldi							
1474   4A47 ED A0       > ldi							
1474   4A49 ED A0       > ldi							
1474   4A4B ED A0       > ldi							
1474   4A4D ED A0       > ldi							
1474   4A4F ED A0       > ldi							
1474   4A51 ED A0       > ldi							
1474   4A53 ED A0       > ldi							
1474   4A55 ED A0       > ldi							
1474   4A57 ED A0       > ldi							
1474   4A59 ED A0       > ldi							
1474   4A5B ED A0       > ldi							
1474   4A5D ED A0       > ldi							
1474   4A5F ED A0       > ldi							
1474   4A61 ED A0       > ldi							
1474   4A63 ED A0       > ldi							
1474   4A65 ED A0       > ldi							
1474   4A67 ED A0       > ldi							
1474   4A69 ED A0       > ldi							
1474   4A6B ED A0       > ldi							
1474   4A6D ED A0       > ldi							
1474   4A6F ED A0       > ldi							
1475   4A71 3E FF       	ld		a, $FF						; envia dummy CRC
1476   4A73 32 00 7B    	ld		(PORTSPI),	a
1477   4A76 00          	nop
1478   4A77 32 00 7B    	ld		(PORTSPI),	a
1479   4A7A CD 0D 46    	call	WAIT_RESP_NO_FF				; esperar cartao
1480   4A7D E6 1F       	and		$1F							; testa bits erro
1481   4A7F FE 05       	cp		5
1482   4A81 20 31       	jr nz,	.erro					; resposta errada, informar erro
1483   4A83 CD 1C 46    	call	WAIT_RESP_NO_00				; esperar cartao
1484   4A86 38 2C       	jr c,	.erro
1485   4A88 FD 7E 32    	ld		a, (iy+NUMBLOCOS)			; testar se tem mais blocos para gravar
1486   4A8B 3D          	dec		a
1487   4A8C FD 77 32    	ld		(iy+NUMBLOCOS), a
1488   4A8F C2 69 46    	jp nz,	.loop
1489   4A92 3A 00 7B    	ld		a, (PORTSPI)				; acabou os blocos, fazer 2 dummy reads
1490   4A95 00          	nop
1491   4A96 3A 00 7B    	ld		a, (PORTSPI)
1492   4A99 3E FD       	ld		a, $FD						; enviar $FD para informar ao cartao que acabou os dados
1493   4A9B 32 00 7B    	ld		(PORTSPI),	a
1494   4A9E 00          	nop
1495   4A9F 00          	nop
1496   4AA0 3A 00 7B    	ld		a, (PORTSPI)				; dummy reads
1497   4AA3 00          	nop
1498   4AA4 3A 00 7B    	ld		a, (PORTSPI)
1499   4AA7 CD 1C 46    	call	WAIT_RESP_NO_00				; esperar cartao
1500   4AAA C3 D9 4E    	jp		.fim						; CMD25 concluido, sair informando nenhum erro
1501   4AAD             
1502   4AAD             .umBloco: 
1503   4AAD 3E 58       	ld		a, CMD24					; gravar somente um bloco com comando CMD24 = Write Single Block
1504   4AAF CD A1 45    	call	SD_SEND_CMD_GET_ERROR
1505   4AB2 30 04       	jr nc,	.ok
1506   4AB4             .erro: 
1507   4AB4 37          	scf									; informar erro
1508   4AB5 C3 DA 4E    	jp		terminaLeituraEscritaBloco
1509   4AB8             .ok: 
1510   4AB8 3E FE       	ld		a, $FE						; mandar $FE para indicar que vamos mandar dados para gravacao
1511   4ABA 32 00 7B    	ld		(PORTSPI),	a
1512   4ABD 11 00 7B    	ld		de, PORTSPI
1513   4AC0 ED A0       > ldi
1513   4AC2 ED A0       > ldi
1513   4AC4 ED A0       > ldi
1513   4AC6 ED A0       > ldi
1513   4AC8 ED A0       > ldi
1513   4ACA ED A0       > ldi
1513   4ACC ED A0       > ldi
1513   4ACE ED A0       > ldi
1513   4AD0 ED A0       > ldi
1513   4AD2 ED A0       > ldi
1513   4AD4 ED A0       > ldi
1513   4AD6 ED A0       > ldi
1513   4AD8 ED A0       > ldi
1513   4ADA ED A0       > ldi
1513   4ADC ED A0       > ldi
1513   4ADE ED A0       > ldi
1513   4AE0 ED A0       > ldi
1513   4AE2 ED A0       > ldi
1513   4AE4 ED A0       > ldi
1513   4AE6 ED A0       > ldi
1513   4AE8 ED A0       > ldi
1513   4AEA ED A0       > ldi
1513   4AEC ED A0       > ldi
1513   4AEE ED A0       > ldi
1513   4AF0 ED A0       > ldi
1513   4AF2 ED A0       > ldi
1513   4AF4 ED A0       > ldi
1513   4AF6 ED A0       > ldi
1513   4AF8 ED A0       > ldi
1513   4AFA ED A0       > ldi
1513   4AFC ED A0       > ldi
1513   4AFE ED A0       > ldi
1513   4B00 ED A0       > ldi
1513   4B02 ED A0       > ldi
1513   4B04 ED A0       > ldi
1513   4B06 ED A0       > ldi
1513   4B08 ED A0       > ldi
1513   4B0A ED A0       > ldi
1513   4B0C ED A0       > ldi
1513   4B0E ED A0       > ldi
1513   4B10 ED A0       > ldi
1513   4B12 ED A0       > ldi
1513   4B14 ED A0       > ldi
1513   4B16 ED A0       > ldi
1513   4B18 ED A0       > ldi
1513   4B1A ED A0       > ldi
1513   4B1C ED A0       > ldi
1513   4B1E ED A0       > ldi
1513   4B20 ED A0       > ldi
1513   4B22 ED A0       > ldi
1513   4B24 ED A0       > ldi
1513   4B26 ED A0       > ldi
1513   4B28 ED A0       > ldi
1513   4B2A ED A0       > ldi
1513   4B2C ED A0       > ldi
1513   4B2E ED A0       > ldi
1513   4B30 ED A0       > ldi
1513   4B32 ED A0       > ldi
1513   4B34 ED A0       > ldi
1513   4B36 ED A0       > ldi
1513   4B38 ED A0       > ldi
1513   4B3A ED A0       > ldi
1513   4B3C ED A0       > ldi
1513   4B3E ED A0       > ldi
1513   4B40 ED A0       > ldi
1513   4B42 ED A0       > ldi
1513   4B44 ED A0       > ldi
1513   4B46 ED A0       > ldi
1513   4B48 ED A0       > ldi
1513   4B4A ED A0       > ldi
1513   4B4C ED A0       > ldi
1513   4B4E ED A0       > ldi
1513   4B50 ED A0       > ldi
1513   4B52 ED A0       > ldi
1513   4B54 ED A0       > ldi
1513   4B56 ED A0       > ldi
1513   4B58 ED A0       > ldi
1513   4B5A ED A0       > ldi
1513   4B5C ED A0       > ldi
1513   4B5E ED A0       > ldi
1513   4B60 ED A0       > ldi
1513   4B62 ED A0       > ldi
1513   4B64 ED A0       > ldi
1513   4B66 ED A0       > ldi
1513   4B68 ED A0       > ldi
1513   4B6A ED A0       > ldi
1513   4B6C ED A0       > ldi
1513   4B6E ED A0       > ldi
1513   4B70 ED A0       > ldi
1513   4B72 ED A0       > ldi
1513   4B74 ED A0       > ldi
1513   4B76 ED A0       > ldi
1513   4B78 ED A0       > ldi
1513   4B7A ED A0       > ldi
1513   4B7C ED A0       > ldi
1513   4B7E ED A0       > ldi
1513   4B80 ED A0       > ldi
1513   4B82 ED A0       > ldi
1513   4B84 ED A0       > ldi
1513   4B86 ED A0       > ldi
1513   4B88 ED A0       > ldi
1513   4B8A ED A0       > ldi
1513   4B8C ED A0       > ldi
1513   4B8E ED A0       > ldi
1513   4B90 ED A0       > ldi
1513   4B92 ED A0       > ldi
1513   4B94 ED A0       > ldi
1513   4B96 ED A0       > ldi
1513   4B98 ED A0       > ldi
1513   4B9A ED A0       > ldi
1513   4B9C ED A0       > ldi
1513   4B9E ED A0       > ldi
1513   4BA0 ED A0       > ldi
1513   4BA2 ED A0       > ldi
1513   4BA4 ED A0       > ldi
1513   4BA6 ED A0       > ldi
1513   4BA8 ED A0       > ldi
1513   4BAA ED A0       > ldi
1513   4BAC ED A0       > ldi
1513   4BAE ED A0       > ldi
1513   4BB0 ED A0       > ldi
1513   4BB2 ED A0       > ldi
1513   4BB4 ED A0       > ldi
1513   4BB6 ED A0       > ldi
1513   4BB8 ED A0       > ldi
1513   4BBA ED A0       > ldi
1513   4BBC ED A0       > ldi
1513   4BBE ED A0       > ldi
1513   4BC0 ED A0       > ldi
1513   4BC2 ED A0       > ldi
1513   4BC4 ED A0       > ldi
1513   4BC6 ED A0       > ldi
1513   4BC8 ED A0       > ldi
1513   4BCA ED A0       > ldi
1513   4BCC ED A0       > ldi
1513   4BCE ED A0       > ldi
1513   4BD0 ED A0       > ldi
1513   4BD2 ED A0       > ldi
1513   4BD4 ED A0       > ldi
1513   4BD6 ED A0       > ldi
1513   4BD8 ED A0       > ldi
1513   4BDA ED A0       > ldi
1513   4BDC ED A0       > ldi
1513   4BDE ED A0       > ldi
1513   4BE0 ED A0       > ldi
1513   4BE2 ED A0       > ldi
1513   4BE4 ED A0       > ldi
1513   4BE6 ED A0       > ldi
1513   4BE8 ED A0       > ldi
1513   4BEA ED A0       > ldi
1513   4BEC ED A0       > ldi
1513   4BEE ED A0       > ldi
1513   4BF0 ED A0       > ldi
1513   4BF2 ED A0       > ldi
1513   4BF4 ED A0       > ldi
1513   4BF6 ED A0       > ldi
1513   4BF8 ED A0       > ldi
1513   4BFA ED A0       > ldi
1513   4BFC ED A0       > ldi
1513   4BFE ED A0       > ldi
1513   4C00 ED A0       > ldi
1513   4C02 ED A0       > ldi
1513   4C04 ED A0       > ldi
1513   4C06 ED A0       > ldi
1513   4C08 ED A0       > ldi
1513   4C0A ED A0       > ldi
1513   4C0C ED A0       > ldi
1513   4C0E ED A0       > ldi
1513   4C10 ED A0       > ldi
1513   4C12 ED A0       > ldi
1513   4C14 ED A0       > ldi
1513   4C16 ED A0       > ldi
1513   4C18 ED A0       > ldi
1513   4C1A ED A0       > ldi
1513   4C1C ED A0       > ldi
1513   4C1E ED A0       > ldi
1513   4C20 ED A0       > ldi
1513   4C22 ED A0       > ldi
1513   4C24 ED A0       > ldi
1513   4C26 ED A0       > ldi
1513   4C28 ED A0       > ldi
1513   4C2A ED A0       > ldi
1513   4C2C ED A0       > ldi
1513   4C2E ED A0       > ldi
1513   4C30 ED A0       > ldi
1513   4C32 ED A0       > ldi
1513   4C34 ED A0       > ldi
1513   4C36 ED A0       > ldi
1513   4C38 ED A0       > ldi
1513   4C3A ED A0       > ldi
1513   4C3C ED A0       > ldi
1513   4C3E ED A0       > ldi
1513   4C40 ED A0       > ldi
1513   4C42 ED A0       > ldi
1513   4C44 ED A0       > ldi
1513   4C46 ED A0       > ldi
1513   4C48 ED A0       > ldi
1513   4C4A ED A0       > ldi
1513   4C4C ED A0       > ldi
1513   4C4E ED A0       > ldi
1513   4C50 ED A0       > ldi
1513   4C52 ED A0       > ldi
1513   4C54 ED A0       > ldi
1513   4C56 ED A0       > ldi
1513   4C58 ED A0       > ldi
1513   4C5A ED A0       > ldi
1513   4C5C ED A0       > ldi
1513   4C5E ED A0       > ldi
1513   4C60 ED A0       > ldi
1513   4C62 ED A0       > ldi
1513   4C64 ED A0       > ldi
1513   4C66 ED A0       > ldi
1513   4C68 ED A0       > ldi
1513   4C6A ED A0       > ldi
1513   4C6C ED A0       > ldi
1513   4C6E ED A0       > ldi
1513   4C70 ED A0       > ldi
1513   4C72 ED A0       > ldi
1513   4C74 ED A0       > ldi
1513   4C76 ED A0       > ldi
1513   4C78 ED A0       > ldi
1513   4C7A ED A0       > ldi
1513   4C7C ED A0       > ldi
1513   4C7E ED A0       > ldi
1513   4C80 ED A0       > ldi
1513   4C82 ED A0       > ldi
1513   4C84 ED A0       > ldi
1513   4C86 ED A0       > ldi
1513   4C88 ED A0       > ldi
1513   4C8A ED A0       > ldi
1513   4C8C ED A0       > ldi
1513   4C8E ED A0       > ldi
1513   4C90 ED A0       > ldi
1513   4C92 ED A0       > ldi
1513   4C94 ED A0       > ldi
1513   4C96 ED A0       > ldi
1513   4C98 ED A0       > ldi
1513   4C9A ED A0       > ldi
1513   4C9C ED A0       > ldi
1513   4C9E ED A0       > ldi
1513   4CA0 ED A0       > ldi
1513   4CA2 ED A0       > ldi
1513   4CA4 ED A0       > ldi
1513   4CA6 ED A0       > ldi
1513   4CA8 ED A0       > ldi
1513   4CAA ED A0       > ldi
1513   4CAC ED A0       > ldi
1513   4CAE ED A0       > ldi
1513   4CB0 ED A0       > ldi
1513   4CB2 ED A0       > ldi
1513   4CB4 ED A0       > ldi
1513   4CB6 ED A0       > ldi
1513   4CB8 ED A0       > ldi
1513   4CBA ED A0       > ldi
1513   4CBC ED A0       > ldi
1513   4CBE ED A0       > ldi
1513   4CC0 ED A0       > ldi
1513   4CC2 ED A0       > ldi
1513   4CC4 ED A0       > ldi
1513   4CC6 ED A0       > ldi
1513   4CC8 ED A0       > ldi
1513   4CCA ED A0       > ldi
1513   4CCC ED A0       > ldi
1513   4CCE ED A0       > ldi
1513   4CD0 ED A0       > ldi
1513   4CD2 ED A0       > ldi
1513   4CD4 ED A0       > ldi
1513   4CD6 ED A0       > ldi
1513   4CD8 ED A0       > ldi
1513   4CDA ED A0       > ldi
1513   4CDC ED A0       > ldi
1513   4CDE ED A0       > ldi
1513   4CE0 ED A0       > ldi
1513   4CE2 ED A0       > ldi
1513   4CE4 ED A0       > ldi
1513   4CE6 ED A0       > ldi
1513   4CE8 ED A0       > ldi
1513   4CEA ED A0       > ldi
1513   4CEC ED A0       > ldi
1513   4CEE ED A0       > ldi
1513   4CF0 ED A0       > ldi
1513   4CF2 ED A0       > ldi
1513   4CF4 ED A0       > ldi
1513   4CF6 ED A0       > ldi
1513   4CF8 ED A0       > ldi
1513   4CFA ED A0       > ldi
1513   4CFC ED A0       > ldi
1513   4CFE ED A0       > ldi
1513   4D00 ED A0       > ldi
1513   4D02 ED A0       > ldi
1513   4D04 ED A0       > ldi
1513   4D06 ED A0       > ldi
1513   4D08 ED A0       > ldi
1513   4D0A ED A0       > ldi
1513   4D0C ED A0       > ldi
1513   4D0E ED A0       > ldi
1513   4D10 ED A0       > ldi
1513   4D12 ED A0       > ldi
1513   4D14 ED A0       > ldi
1513   4D16 ED A0       > ldi
1513   4D18 ED A0       > ldi
1513   4D1A ED A0       > ldi
1513   4D1C ED A0       > ldi
1513   4D1E ED A0       > ldi
1513   4D20 ED A0       > ldi
1513   4D22 ED A0       > ldi
1513   4D24 ED A0       > ldi
1513   4D26 ED A0       > ldi
1513   4D28 ED A0       > ldi
1513   4D2A ED A0       > ldi
1513   4D2C ED A0       > ldi
1513   4D2E ED A0       > ldi
1513   4D30 ED A0       > ldi
1513   4D32 ED A0       > ldi
1513   4D34 ED A0       > ldi
1513   4D36 ED A0       > ldi
1513   4D38 ED A0       > ldi
1513   4D3A ED A0       > ldi
1513   4D3C ED A0       > ldi
1513   4D3E ED A0       > ldi
1513   4D40 ED A0       > ldi
1513   4D42 ED A0       > ldi
1513   4D44 ED A0       > ldi
1513   4D46 ED A0       > ldi
1513   4D48 ED A0       > ldi
1513   4D4A ED A0       > ldi
1513   4D4C ED A0       > ldi
1513   4D4E ED A0       > ldi
1513   4D50 ED A0       > ldi
1513   4D52 ED A0       > ldi
1513   4D54 ED A0       > ldi
1513   4D56 ED A0       > ldi
1513   4D58 ED A0       > ldi
1513   4D5A ED A0       > ldi
1513   4D5C ED A0       > ldi
1513   4D5E ED A0       > ldi
1513   4D60 ED A0       > ldi
1513   4D62 ED A0       > ldi
1513   4D64 ED A0       > ldi
1513   4D66 ED A0       > ldi
1513   4D68 ED A0       > ldi
1513   4D6A ED A0       > ldi
1513   4D6C ED A0       > ldi
1513   4D6E ED A0       > ldi
1513   4D70 ED A0       > ldi
1513   4D72 ED A0       > ldi
1513   4D74 ED A0       > ldi
1513   4D76 ED A0       > ldi
1513   4D78 ED A0       > ldi
1513   4D7A ED A0       > ldi
1513   4D7C ED A0       > ldi
1513   4D7E ED A0       > ldi
1513   4D80 ED A0       > ldi
1513   4D82 ED A0       > ldi
1513   4D84 ED A0       > ldi
1513   4D86 ED A0       > ldi
1513   4D88 ED A0       > ldi
1513   4D8A ED A0       > ldi
1513   4D8C ED A0       > ldi
1513   4D8E ED A0       > ldi
1513   4D90 ED A0       > ldi
1513   4D92 ED A0       > ldi
1513   4D94 ED A0       > ldi
1513   4D96 ED A0       > ldi
1513   4D98 ED A0       > ldi
1513   4D9A ED A0       > ldi
1513   4D9C ED A0       > ldi
1513   4D9E ED A0       > ldi
1513   4DA0 ED A0       > ldi
1513   4DA2 ED A0       > ldi
1513   4DA4 ED A0       > ldi
1513   4DA6 ED A0       > ldi
1513   4DA8 ED A0       > ldi
1513   4DAA ED A0       > ldi
1513   4DAC ED A0       > ldi
1513   4DAE ED A0       > ldi
1513   4DB0 ED A0       > ldi
1513   4DB2 ED A0       > ldi
1513   4DB4 ED A0       > ldi
1513   4DB6 ED A0       > ldi
1513   4DB8 ED A0       > ldi
1513   4DBA ED A0       > ldi
1513   4DBC ED A0       > ldi
1513   4DBE ED A0       > ldi
1513   4DC0 ED A0       > ldi
1513   4DC2 ED A0       > ldi
1513   4DC4 ED A0       > ldi
1513   4DC6 ED A0       > ldi
1513   4DC8 ED A0       > ldi
1513   4DCA ED A0       > ldi
1513   4DCC ED A0       > ldi
1513   4DCE ED A0       > ldi
1513   4DD0 ED A0       > ldi
1513   4DD2 ED A0       > ldi
1513   4DD4 ED A0       > ldi
1513   4DD6 ED A0       > ldi
1513   4DD8 ED A0       > ldi
1513   4DDA ED A0       > ldi
1513   4DDC ED A0       > ldi
1513   4DDE ED A0       > ldi
1513   4DE0 ED A0       > ldi
1513   4DE2 ED A0       > ldi
1513   4DE4 ED A0       > ldi
1513   4DE6 ED A0       > ldi
1513   4DE8 ED A0       > ldi
1513   4DEA ED A0       > ldi
1513   4DEC ED A0       > ldi
1513   4DEE ED A0       > ldi
1513   4DF0 ED A0       > ldi
1513   4DF2 ED A0       > ldi
1513   4DF4 ED A0       > ldi
1513   4DF6 ED A0       > ldi
1513   4DF8 ED A0       > ldi
1513   4DFA ED A0       > ldi
1513   4DFC ED A0       > ldi
1513   4DFE ED A0       > ldi
1513   4E00 ED A0       > ldi
1513   4E02 ED A0       > ldi
1513   4E04 ED A0       > ldi
1513   4E06 ED A0       > ldi
1513   4E08 ED A0       > ldi
1513   4E0A ED A0       > ldi
1513   4E0C ED A0       > ldi
1513   4E0E ED A0       > ldi
1513   4E10 ED A0       > ldi
1513   4E12 ED A0       > ldi
1513   4E14 ED A0       > ldi
1513   4E16 ED A0       > ldi
1513   4E18 ED A0       > ldi
1513   4E1A ED A0       > ldi
1513   4E1C ED A0       > ldi
1513   4E1E ED A0       > ldi
1513   4E20 ED A0       > ldi
1513   4E22 ED A0       > ldi
1513   4E24 ED A0       > ldi
1513   4E26 ED A0       > ldi
1513   4E28 ED A0       > ldi
1513   4E2A ED A0       > ldi
1513   4E2C ED A0       > ldi
1513   4E2E ED A0       > ldi
1513   4E30 ED A0       > ldi
1513   4E32 ED A0       > ldi
1513   4E34 ED A0       > ldi
1513   4E36 ED A0       > ldi
1513   4E38 ED A0       > ldi
1513   4E3A ED A0       > ldi
1513   4E3C ED A0       > ldi
1513   4E3E ED A0       > ldi
1513   4E40 ED A0       > ldi
1513   4E42 ED A0       > ldi
1513   4E44 ED A0       > ldi
1513   4E46 ED A0       > ldi
1513   4E48 ED A0       > ldi
1513   4E4A ED A0       > ldi
1513   4E4C ED A0       > ldi
1513   4E4E ED A0       > ldi
1513   4E50 ED A0       > ldi
1513   4E52 ED A0       > ldi
1513   4E54 ED A0       > ldi
1513   4E56 ED A0       > ldi
1513   4E58 ED A0       > ldi
1513   4E5A ED A0       > ldi
1513   4E5C ED A0       > ldi
1513   4E5E ED A0       > ldi
1513   4E60 ED A0       > ldi
1513   4E62 ED A0       > ldi
1513   4E64 ED A0       > ldi
1513   4E66 ED A0       > ldi
1513   4E68 ED A0       > ldi
1513   4E6A ED A0       > ldi
1513   4E6C ED A0       > ldi
1513   4E6E ED A0       > ldi
1513   4E70 ED A0       > ldi
1513   4E72 ED A0       > ldi
1513   4E74 ED A0       > ldi
1513   4E76 ED A0       > ldi
1513   4E78 ED A0       > ldi
1513   4E7A ED A0       > ldi
1513   4E7C ED A0       > ldi
1513   4E7E ED A0       > ldi
1513   4E80 ED A0       > ldi
1513   4E82 ED A0       > ldi
1513   4E84 ED A0       > ldi
1513   4E86 ED A0       > ldi
1513   4E88 ED A0       > ldi
1513   4E8A ED A0       > ldi
1513   4E8C ED A0       > ldi
1513   4E8E ED A0       > ldi
1513   4E90 ED A0       > ldi
1513   4E92 ED A0       > ldi
1513   4E94 ED A0       > ldi
1513   4E96 ED A0       > ldi
1513   4E98 ED A0       > ldi
1513   4E9A ED A0       > ldi
1513   4E9C ED A0       > ldi
1513   4E9E ED A0       > ldi
1513   4EA0 ED A0       > ldi
1513   4EA2 ED A0       > ldi
1513   4EA4 ED A0       > ldi
1513   4EA6 ED A0       > ldi
1513   4EA8 ED A0       > ldi
1513   4EAA ED A0       > ldi
1513   4EAC ED A0       > ldi
1513   4EAE ED A0       > ldi
1513   4EB0 ED A0       > ldi
1513   4EB2 ED A0       > ldi
1513   4EB4 ED A0       > ldi
1513   4EB6 ED A0       > ldi
1513   4EB8 ED A0       > ldi
1513   4EBA ED A0       > ldi
1513   4EBC ED A0       > ldi
1513   4EBE ED A0       > ldi
1514   4EC0 3E FF       	ld		a, $FF						; envia dummy CRC
1515   4EC2 32 00 7B    	ld		(PORTSPI),	a
1516   4EC5 00          	nop
1517   4EC6 32 00 7B    	ld		(PORTSPI),	a
1518   4EC9 CD 0D 46    	call	WAIT_RESP_NO_FF				; esperar cartao
1519   4ECC E6 1F       	and		$1F							; testa bits erro
1520   4ECE FE 05       	cp		5
1521   4ED0 C2 B4 4A    	jp nz,	.erro						; resposta errada, informar erro
1522   4ED3             .esp: 
1523   4ED3 CD 0D 46    	call	WAIT_RESP_NO_FF				; esperar cartao
1524   4ED6 B7          	or		a
1525   4ED7 28 FA       	jr z,	.esp
1526   4ED9             .fim: 
1527   4ED9 AF          	xor		a							; zera carry e informa nenhum erro
1528   4EDA             terminaLeituraEscritaBloco: 
1529   4EDA F5          	push	af
1530   4EDB CD 84 45    	call	desabilitaSDs				; desabilitar todos os cartoes
1531   4EDE F1          	pop		af
1532   4EDF C9          	ret
1533   4EE0             
1534   4EE0             ; ------------------------------------------------
1535   4EE0             ; Ler um bloco de 512 bytes do cartao
1536   4EE0             ; HL aponta para o inicio dos dados
1537   4EE0             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1538   4EE0             ; Destroi AF, BC, DE, HL
1539   4EE0             ; ------------------------------------------------
1540   4EE0             LerBloco: 
1541   4EE0 DD 7E 0F    	ld		a, (ix+15)					; verificar se eh SDV1 ou SDV2
1542   4EE3 B7          	or		a
1543   4EE4 CC 3F 57    	call z,	blocoParaByte				; se for SDV1 coverter blocos para bytes
1544   4EE7 CD 2B 46    	call	setaSDAtual
1545   4EEA FD 7E 32    	ld		a, (iy+NUMBLOCOS)			; testar se Nextor quer ler um ou mais blocos
1546   4EED 3D          	dec		a
1547   4EEE CA 1E 53    	jp z,	.umBloco					; somente um bloco, pular
1548   4EF1             
1549   4EF1             ; multiplos blocos
1550   4EF1 3E 52       	ld		a, CMD18					; ler multiplos blocos com CMD18 = Read Multiple Blocks
1551   4EF3 CD A1 45    	call	SD_SEND_CMD_GET_ERROR
1552   4EF6 DA 25 53    	jp c,	.erro
1553   4EF9             .loop: 
1554   4EF9 CD FF 45    	call	WAIT_RESP_FE
1555   4EFC DA 25 53    	jp c,	.erro
1556   4EFF 11 00 7B    	ld		de, PORTSPI
1557   4F02 EB          	ex		hl, de
1558   4F03 ED A0       > ldi
1558   4F05 ED A0       > ldi
1558   4F07 ED A0       > ldi
1558   4F09 ED A0       > ldi
1558   4F0B ED A0       > ldi
1558   4F0D ED A0       > ldi
1558   4F0F ED A0       > ldi
1558   4F11 ED A0       > ldi
1558   4F13 ED A0       > ldi
1558   4F15 ED A0       > ldi
1558   4F17 ED A0       > ldi
1558   4F19 ED A0       > ldi
1558   4F1B ED A0       > ldi
1558   4F1D ED A0       > ldi
1558   4F1F ED A0       > ldi
1558   4F21 ED A0       > ldi
1558   4F23 ED A0       > ldi
1558   4F25 ED A0       > ldi
1558   4F27 ED A0       > ldi
1558   4F29 ED A0       > ldi
1558   4F2B ED A0       > ldi
1558   4F2D ED A0       > ldi
1558   4F2F ED A0       > ldi
1558   4F31 ED A0       > ldi
1558   4F33 ED A0       > ldi
1558   4F35 ED A0       > ldi
1558   4F37 ED A0       > ldi
1558   4F39 ED A0       > ldi
1558   4F3B ED A0       > ldi
1558   4F3D ED A0       > ldi
1558   4F3F ED A0       > ldi
1558   4F41 ED A0       > ldi
1558   4F43 ED A0       > ldi
1558   4F45 ED A0       > ldi
1558   4F47 ED A0       > ldi
1558   4F49 ED A0       > ldi
1558   4F4B ED A0       > ldi
1558   4F4D ED A0       > ldi
1558   4F4F ED A0       > ldi
1558   4F51 ED A0       > ldi
1558   4F53 ED A0       > ldi
1558   4F55 ED A0       > ldi
1558   4F57 ED A0       > ldi
1558   4F59 ED A0       > ldi
1558   4F5B ED A0       > ldi
1558   4F5D ED A0       > ldi
1558   4F5F ED A0       > ldi
1558   4F61 ED A0       > ldi
1558   4F63 ED A0       > ldi
1558   4F65 ED A0       > ldi
1558   4F67 ED A0       > ldi
1558   4F69 ED A0       > ldi
1558   4F6B ED A0       > ldi
1558   4F6D ED A0       > ldi
1558   4F6F ED A0       > ldi
1558   4F71 ED A0       > ldi
1558   4F73 ED A0       > ldi
1558   4F75 ED A0       > ldi
1558   4F77 ED A0       > ldi
1558   4F79 ED A0       > ldi
1558   4F7B ED A0       > ldi
1558   4F7D ED A0       > ldi
1558   4F7F ED A0       > ldi
1558   4F81 ED A0       > ldi
1558   4F83 ED A0       > ldi
1558   4F85 ED A0       > ldi
1558   4F87 ED A0       > ldi
1558   4F89 ED A0       > ldi
1558   4F8B ED A0       > ldi
1558   4F8D ED A0       > ldi
1558   4F8F ED A0       > ldi
1558   4F91 ED A0       > ldi
1558   4F93 ED A0       > ldi
1558   4F95 ED A0       > ldi
1558   4F97 ED A0       > ldi
1558   4F99 ED A0       > ldi
1558   4F9B ED A0       > ldi
1558   4F9D ED A0       > ldi
1558   4F9F ED A0       > ldi
1558   4FA1 ED A0       > ldi
1558   4FA3 ED A0       > ldi
1558   4FA5 ED A0       > ldi
1558   4FA7 ED A0       > ldi
1558   4FA9 ED A0       > ldi
1558   4FAB ED A0       > ldi
1558   4FAD ED A0       > ldi
1558   4FAF ED A0       > ldi
1558   4FB1 ED A0       > ldi
1558   4FB3 ED A0       > ldi
1558   4FB5 ED A0       > ldi
1558   4FB7 ED A0       > ldi
1558   4FB9 ED A0       > ldi
1558   4FBB ED A0       > ldi
1558   4FBD ED A0       > ldi
1558   4FBF ED A0       > ldi
1558   4FC1 ED A0       > ldi
1558   4FC3 ED A0       > ldi
1558   4FC5 ED A0       > ldi
1558   4FC7 ED A0       > ldi
1558   4FC9 ED A0       > ldi
1558   4FCB ED A0       > ldi
1558   4FCD ED A0       > ldi
1558   4FCF ED A0       > ldi
1558   4FD1 ED A0       > ldi
1558   4FD3 ED A0       > ldi
1558   4FD5 ED A0       > ldi
1558   4FD7 ED A0       > ldi
1558   4FD9 ED A0       > ldi
1558   4FDB ED A0       > ldi
1558   4FDD ED A0       > ldi
1558   4FDF ED A0       > ldi
1558   4FE1 ED A0       > ldi
1558   4FE3 ED A0       > ldi
1558   4FE5 ED A0       > ldi
1558   4FE7 ED A0       > ldi
1558   4FE9 ED A0       > ldi
1558   4FEB ED A0       > ldi
1558   4FED ED A0       > ldi
1558   4FEF ED A0       > ldi
1558   4FF1 ED A0       > ldi
1558   4FF3 ED A0       > ldi
1558   4FF5 ED A0       > ldi
1558   4FF7 ED A0       > ldi
1558   4FF9 ED A0       > ldi
1558   4FFB ED A0       > ldi
1558   4FFD ED A0       > ldi
1558   4FFF ED A0       > ldi
1558   5001 ED A0       > ldi
1558   5003 ED A0       > ldi
1558   5005 ED A0       > ldi
1558   5007 ED A0       > ldi
1558   5009 ED A0       > ldi
1558   500B ED A0       > ldi
1558   500D ED A0       > ldi
1558   500F ED A0       > ldi
1558   5011 ED A0       > ldi
1558   5013 ED A0       > ldi
1558   5015 ED A0       > ldi
1558   5017 ED A0       > ldi
1558   5019 ED A0       > ldi
1558   501B ED A0       > ldi
1558   501D ED A0       > ldi
1558   501F ED A0       > ldi
1558   5021 ED A0       > ldi
1558   5023 ED A0       > ldi
1558   5025 ED A0       > ldi
1558   5027 ED A0       > ldi
1558   5029 ED A0       > ldi
1558   502B ED A0       > ldi
1558   502D ED A0       > ldi
1558   502F ED A0       > ldi
1558   5031 ED A0       > ldi
1558   5033 ED A0       > ldi
1558   5035 ED A0       > ldi
1558   5037 ED A0       > ldi
1558   5039 ED A0       > ldi
1558   503B ED A0       > ldi
1558   503D ED A0       > ldi
1558   503F ED A0       > ldi
1558   5041 ED A0       > ldi
1558   5043 ED A0       > ldi
1558   5045 ED A0       > ldi
1558   5047 ED A0       > ldi
1558   5049 ED A0       > ldi
1558   504B ED A0       > ldi
1558   504D ED A0       > ldi
1558   504F ED A0       > ldi
1558   5051 ED A0       > ldi
1558   5053 ED A0       > ldi
1558   5055 ED A0       > ldi
1558   5057 ED A0       > ldi
1558   5059 ED A0       > ldi
1558   505B ED A0       > ldi
1558   505D ED A0       > ldi
1558   505F ED A0       > ldi
1558   5061 ED A0       > ldi
1558   5063 ED A0       > ldi
1558   5065 ED A0       > ldi
1558   5067 ED A0       > ldi
1558   5069 ED A0       > ldi
1558   506B ED A0       > ldi
1558   506D ED A0       > ldi
1558   506F ED A0       > ldi
1558   5071 ED A0       > ldi
1558   5073 ED A0       > ldi
1558   5075 ED A0       > ldi
1558   5077 ED A0       > ldi
1558   5079 ED A0       > ldi
1558   507B ED A0       > ldi
1558   507D ED A0       > ldi
1558   507F ED A0       > ldi
1558   5081 ED A0       > ldi
1558   5083 ED A0       > ldi
1558   5085 ED A0       > ldi
1558   5087 ED A0       > ldi
1558   5089 ED A0       > ldi
1558   508B ED A0       > ldi
1558   508D ED A0       > ldi
1558   508F ED A0       > ldi
1558   5091 ED A0       > ldi
1558   5093 ED A0       > ldi
1558   5095 ED A0       > ldi
1558   5097 ED A0       > ldi
1558   5099 ED A0       > ldi
1558   509B ED A0       > ldi
1558   509D ED A0       > ldi
1558   509F ED A0       > ldi
1558   50A1 ED A0       > ldi
1558   50A3 ED A0       > ldi
1558   50A5 ED A0       > ldi
1558   50A7 ED A0       > ldi
1558   50A9 ED A0       > ldi
1558   50AB ED A0       > ldi
1558   50AD ED A0       > ldi
1558   50AF ED A0       > ldi
1558   50B1 ED A0       > ldi
1558   50B3 ED A0       > ldi
1558   50B5 ED A0       > ldi
1558   50B7 ED A0       > ldi
1558   50B9 ED A0       > ldi
1558   50BB ED A0       > ldi
1558   50BD ED A0       > ldi
1558   50BF ED A0       > ldi
1558   50C1 ED A0       > ldi
1558   50C3 ED A0       > ldi
1558   50C5 ED A0       > ldi
1558   50C7 ED A0       > ldi
1558   50C9 ED A0       > ldi
1558   50CB ED A0       > ldi
1558   50CD ED A0       > ldi
1558   50CF ED A0       > ldi
1558   50D1 ED A0       > ldi
1558   50D3 ED A0       > ldi
1558   50D5 ED A0       > ldi
1558   50D7 ED A0       > ldi
1558   50D9 ED A0       > ldi
1558   50DB ED A0       > ldi
1558   50DD ED A0       > ldi
1558   50DF ED A0       > ldi
1558   50E1 ED A0       > ldi
1558   50E3 ED A0       > ldi
1558   50E5 ED A0       > ldi
1558   50E7 ED A0       > ldi
1558   50E9 ED A0       > ldi
1558   50EB ED A0       > ldi
1558   50ED ED A0       > ldi
1558   50EF ED A0       > ldi
1558   50F1 ED A0       > ldi
1558   50F3 ED A0       > ldi
1558   50F5 ED A0       > ldi
1558   50F7 ED A0       > ldi
1558   50F9 ED A0       > ldi
1558   50FB ED A0       > ldi
1558   50FD ED A0       > ldi
1558   50FF ED A0       > ldi
1558   5101 ED A0       > ldi
1558   5103 ED A0       > ldi
1558   5105 ED A0       > ldi
1558   5107 ED A0       > ldi
1558   5109 ED A0       > ldi
1558   510B ED A0       > ldi
1558   510D ED A0       > ldi
1558   510F ED A0       > ldi
1558   5111 ED A0       > ldi
1558   5113 ED A0       > ldi
1558   5115 ED A0       > ldi
1558   5117 ED A0       > ldi
1558   5119 ED A0       > ldi
1558   511B ED A0       > ldi
1558   511D ED A0       > ldi
1558   511F ED A0       > ldi
1558   5121 ED A0       > ldi
1558   5123 ED A0       > ldi
1558   5125 ED A0       > ldi
1558   5127 ED A0       > ldi
1558   5129 ED A0       > ldi
1558   512B ED A0       > ldi
1558   512D ED A0       > ldi
1558   512F ED A0       > ldi
1558   5131 ED A0       > ldi
1558   5133 ED A0       > ldi
1558   5135 ED A0       > ldi
1558   5137 ED A0       > ldi
1558   5139 ED A0       > ldi
1558   513B ED A0       > ldi
1558   513D ED A0       > ldi
1558   513F ED A0       > ldi
1558   5141 ED A0       > ldi
1558   5143 ED A0       > ldi
1558   5145 ED A0       > ldi
1558   5147 ED A0       > ldi
1558   5149 ED A0       > ldi
1558   514B ED A0       > ldi
1558   514D ED A0       > ldi
1558   514F ED A0       > ldi
1558   5151 ED A0       > ldi
1558   5153 ED A0       > ldi
1558   5155 ED A0       > ldi
1558   5157 ED A0       > ldi
1558   5159 ED A0       > ldi
1558   515B ED A0       > ldi
1558   515D ED A0       > ldi
1558   515F ED A0       > ldi
1558   5161 ED A0       > ldi
1558   5163 ED A0       > ldi
1558   5165 ED A0       > ldi
1558   5167 ED A0       > ldi
1558   5169 ED A0       > ldi
1558   516B ED A0       > ldi
1558   516D ED A0       > ldi
1558   516F ED A0       > ldi
1558   5171 ED A0       > ldi
1558   5173 ED A0       > ldi
1558   5175 ED A0       > ldi
1558   5177 ED A0       > ldi
1558   5179 ED A0       > ldi
1558   517B ED A0       > ldi
1558   517D ED A0       > ldi
1558   517F ED A0       > ldi
1558   5181 ED A0       > ldi
1558   5183 ED A0       > ldi
1558   5185 ED A0       > ldi
1558   5187 ED A0       > ldi
1558   5189 ED A0       > ldi
1558   518B ED A0       > ldi
1558   518D ED A0       > ldi
1558   518F ED A0       > ldi
1558   5191 ED A0       > ldi
1558   5193 ED A0       > ldi
1558   5195 ED A0       > ldi
1558   5197 ED A0       > ldi
1558   5199 ED A0       > ldi
1558   519B ED A0       > ldi
1558   519D ED A0       > ldi
1558   519F ED A0       > ldi
1558   51A1 ED A0       > ldi
1558   51A3 ED A0       > ldi
1558   51A5 ED A0       > ldi
1558   51A7 ED A0       > ldi
1558   51A9 ED A0       > ldi
1558   51AB ED A0       > ldi
1558   51AD ED A0       > ldi
1558   51AF ED A0       > ldi
1558   51B1 ED A0       > ldi
1558   51B3 ED A0       > ldi
1558   51B5 ED A0       > ldi
1558   51B7 ED A0       > ldi
1558   51B9 ED A0       > ldi
1558   51BB ED A0       > ldi
1558   51BD ED A0       > ldi
1558   51BF ED A0       > ldi
1558   51C1 ED A0       > ldi
1558   51C3 ED A0       > ldi
1558   51C5 ED A0       > ldi
1558   51C7 ED A0       > ldi
1558   51C9 ED A0       > ldi
1558   51CB ED A0       > ldi
1558   51CD ED A0       > ldi
1558   51CF ED A0       > ldi
1558   51D1 ED A0       > ldi
1558   51D3 ED A0       > ldi
1558   51D5 ED A0       > ldi
1558   51D7 ED A0       > ldi
1558   51D9 ED A0       > ldi
1558   51DB ED A0       > ldi
1558   51DD ED A0       > ldi
1558   51DF ED A0       > ldi
1558   51E1 ED A0       > ldi
1558   51E3 ED A0       > ldi
1558   51E5 ED A0       > ldi
1558   51E7 ED A0       > ldi
1558   51E9 ED A0       > ldi
1558   51EB ED A0       > ldi
1558   51ED ED A0       > ldi
1558   51EF ED A0       > ldi
1558   51F1 ED A0       > ldi
1558   51F3 ED A0       > ldi
1558   51F5 ED A0       > ldi
1558   51F7 ED A0       > ldi
1558   51F9 ED A0       > ldi
1558   51FB ED A0       > ldi
1558   51FD ED A0       > ldi
1558   51FF ED A0       > ldi
1558   5201 ED A0       > ldi
1558   5203 ED A0       > ldi
1558   5205 ED A0       > ldi
1558   5207 ED A0       > ldi
1558   5209 ED A0       > ldi
1558   520B ED A0       > ldi
1558   520D ED A0       > ldi
1558   520F ED A0       > ldi
1558   5211 ED A0       > ldi
1558   5213 ED A0       > ldi
1558   5215 ED A0       > ldi
1558   5217 ED A0       > ldi
1558   5219 ED A0       > ldi
1558   521B ED A0       > ldi
1558   521D ED A0       > ldi
1558   521F ED A0       > ldi
1558   5221 ED A0       > ldi
1558   5223 ED A0       > ldi
1558   5225 ED A0       > ldi
1558   5227 ED A0       > ldi
1558   5229 ED A0       > ldi
1558   522B ED A0       > ldi
1558   522D ED A0       > ldi
1558   522F ED A0       > ldi
1558   5231 ED A0       > ldi
1558   5233 ED A0       > ldi
1558   5235 ED A0       > ldi
1558   5237 ED A0       > ldi
1558   5239 ED A0       > ldi
1558   523B ED A0       > ldi
1558   523D ED A0       > ldi
1558   523F ED A0       > ldi
1558   5241 ED A0       > ldi
1558   5243 ED A0       > ldi
1558   5245 ED A0       > ldi
1558   5247 ED A0       > ldi
1558   5249 ED A0       > ldi
1558   524B ED A0       > ldi
1558   524D ED A0       > ldi
1558   524F ED A0       > ldi
1558   5251 ED A0       > ldi
1558   5253 ED A0       > ldi
1558   5255 ED A0       > ldi
1558   5257 ED A0       > ldi
1558   5259 ED A0       > ldi
1558   525B ED A0       > ldi
1558   525D ED A0       > ldi
1558   525F ED A0       > ldi
1558   5261 ED A0       > ldi
1558   5263 ED A0       > ldi
1558   5265 ED A0       > ldi
1558   5267 ED A0       > ldi
1558   5269 ED A0       > ldi
1558   526B ED A0       > ldi
1558   526D ED A0       > ldi
1558   526F ED A0       > ldi
1558   5271 ED A0       > ldi
1558   5273 ED A0       > ldi
1558   5275 ED A0       > ldi
1558   5277 ED A0       > ldi
1558   5279 ED A0       > ldi
1558   527B ED A0       > ldi
1558   527D ED A0       > ldi
1558   527F ED A0       > ldi
1558   5281 ED A0       > ldi
1558   5283 ED A0       > ldi
1558   5285 ED A0       > ldi
1558   5287 ED A0       > ldi
1558   5289 ED A0       > ldi
1558   528B ED A0       > ldi
1558   528D ED A0       > ldi
1558   528F ED A0       > ldi
1558   5291 ED A0       > ldi
1558   5293 ED A0       > ldi
1558   5295 ED A0       > ldi
1558   5297 ED A0       > ldi
1558   5299 ED A0       > ldi
1558   529B ED A0       > ldi
1558   529D ED A0       > ldi
1558   529F ED A0       > ldi
1558   52A1 ED A0       > ldi
1558   52A3 ED A0       > ldi
1558   52A5 ED A0       > ldi
1558   52A7 ED A0       > ldi
1558   52A9 ED A0       > ldi
1558   52AB ED A0       > ldi
1558   52AD ED A0       > ldi
1558   52AF ED A0       > ldi
1558   52B1 ED A0       > ldi
1558   52B3 ED A0       > ldi
1558   52B5 ED A0       > ldi
1558   52B7 ED A0       > ldi
1558   52B9 ED A0       > ldi
1558   52BB ED A0       > ldi
1558   52BD ED A0       > ldi
1558   52BF ED A0       > ldi
1558   52C1 ED A0       > ldi
1558   52C3 ED A0       > ldi
1558   52C5 ED A0       > ldi
1558   52C7 ED A0       > ldi
1558   52C9 ED A0       > ldi
1558   52CB ED A0       > ldi
1558   52CD ED A0       > ldi
1558   52CF ED A0       > ldi
1558   52D1 ED A0       > ldi
1558   52D3 ED A0       > ldi
1558   52D5 ED A0       > ldi
1558   52D7 ED A0       > ldi
1558   52D9 ED A0       > ldi
1558   52DB ED A0       > ldi
1558   52DD ED A0       > ldi
1558   52DF ED A0       > ldi
1558   52E1 ED A0       > ldi
1558   52E3 ED A0       > ldi
1558   52E5 ED A0       > ldi
1558   52E7 ED A0       > ldi
1558   52E9 ED A0       > ldi
1558   52EB ED A0       > ldi
1558   52ED ED A0       > ldi
1558   52EF ED A0       > ldi
1558   52F1 ED A0       > ldi
1558   52F3 ED A0       > ldi
1558   52F5 ED A0       > ldi
1558   52F7 ED A0       > ldi
1558   52F9 ED A0       > ldi
1558   52FB ED A0       > ldi
1558   52FD ED A0       > ldi
1558   52FF ED A0       > ldi
1558   5301 ED A0       > ldi
1559   5303 EB          	ex		hl, de
1560   5304 00          	nop
1561   5305 3A 00 7B    	ld		a, (PORTSPI)				; descarta CRC
1562   5308 00          	nop
1563   5309 3A 00 7B    	ld		a, (PORTSPI)
1564   530C FD 7E 32    	ld		a, (iy+NUMBLOCOS)			; testar se tem mais blocos para ler
1565   530F 3D          	dec		a
1566   5310 FD 77 32    	ld		(iy+NUMBLOCOS), a
1567   5313 C2 F9 4E    	jp nz,	.loop
1568   5316 3E 4C       	ld		a, CMD12					; acabou os blocos, mandar CMD12 para cancelar leitura
1569   5318 CD 9C 45    	call	SD_SEND_CMD_NO_ARGS
1570   531B C3 3B 57    	jp		.fim
1571   531E             
1572   531E             .umBloco: 
1573   531E 3E 51       	ld		a, CMD17					; ler somente um bloco com CMD17 = Read Single Block
1574   5320 CD A1 45    	call	SD_SEND_CMD_GET_ERROR
1575   5323 30 04       	jr nc,	.ok
1576   5325             .erro: 
1577   5325 37          	scf
1578   5326 C3 DA 4E    	jp		terminaLeituraEscritaBloco
1579   5329             .ok: 
1580   5329 CD FF 45    	call	WAIT_RESP_FE
1581   532C 38 F7       	jr c,	.erro
1582   532E 11 00 7B    	ld		de, PORTSPI
1583   5331 EB          	ex		hl, de
1584   5332 ED A0       > ldi
1584   5334 ED A0       > ldi
1584   5336 ED A0       > ldi
1584   5338 ED A0       > ldi
1584   533A ED A0       > ldi
1584   533C ED A0       > ldi
1584   533E ED A0       > ldi
1584   5340 ED A0       > ldi
1584   5342 ED A0       > ldi
1584   5344 ED A0       > ldi
1584   5346 ED A0       > ldi
1584   5348 ED A0       > ldi
1584   534A ED A0       > ldi
1584   534C ED A0       > ldi
1584   534E ED A0       > ldi
1584   5350 ED A0       > ldi
1584   5352 ED A0       > ldi
1584   5354 ED A0       > ldi
1584   5356 ED A0       > ldi
1584   5358 ED A0       > ldi
1584   535A ED A0       > ldi
1584   535C ED A0       > ldi
1584   535E ED A0       > ldi
1584   5360 ED A0       > ldi
1584   5362 ED A0       > ldi
1584   5364 ED A0       > ldi
1584   5366 ED A0       > ldi
1584   5368 ED A0       > ldi
1584   536A ED A0       > ldi
1584   536C ED A0       > ldi
1584   536E ED A0       > ldi
1584   5370 ED A0       > ldi
1584   5372 ED A0       > ldi
1584   5374 ED A0       > ldi
1584   5376 ED A0       > ldi
1584   5378 ED A0       > ldi
1584   537A ED A0       > ldi
1584   537C ED A0       > ldi
1584   537E ED A0       > ldi
1584   5380 ED A0       > ldi
1584   5382 ED A0       > ldi
1584   5384 ED A0       > ldi
1584   5386 ED A0       > ldi
1584   5388 ED A0       > ldi
1584   538A ED A0       > ldi
1584   538C ED A0       > ldi
1584   538E ED A0       > ldi
1584   5390 ED A0       > ldi
1584   5392 ED A0       > ldi
1584   5394 ED A0       > ldi
1584   5396 ED A0       > ldi
1584   5398 ED A0       > ldi
1584   539A ED A0       > ldi
1584   539C ED A0       > ldi
1584   539E ED A0       > ldi
1584   53A0 ED A0       > ldi
1584   53A2 ED A0       > ldi
1584   53A4 ED A0       > ldi
1584   53A6 ED A0       > ldi
1584   53A8 ED A0       > ldi
1584   53AA ED A0       > ldi
1584   53AC ED A0       > ldi
1584   53AE ED A0       > ldi
1584   53B0 ED A0       > ldi
1584   53B2 ED A0       > ldi
1584   53B4 ED A0       > ldi
1584   53B6 ED A0       > ldi
1584   53B8 ED A0       > ldi
1584   53BA ED A0       > ldi
1584   53BC ED A0       > ldi
1584   53BE ED A0       > ldi
1584   53C0 ED A0       > ldi
1584   53C2 ED A0       > ldi
1584   53C4 ED A0       > ldi
1584   53C6 ED A0       > ldi
1584   53C8 ED A0       > ldi
1584   53CA ED A0       > ldi
1584   53CC ED A0       > ldi
1584   53CE ED A0       > ldi
1584   53D0 ED A0       > ldi
1584   53D2 ED A0       > ldi
1584   53D4 ED A0       > ldi
1584   53D6 ED A0       > ldi
1584   53D8 ED A0       > ldi
1584   53DA ED A0       > ldi
1584   53DC ED A0       > ldi
1584   53DE ED A0       > ldi
1584   53E0 ED A0       > ldi
1584   53E2 ED A0       > ldi
1584   53E4 ED A0       > ldi
1584   53E6 ED A0       > ldi
1584   53E8 ED A0       > ldi
1584   53EA ED A0       > ldi
1584   53EC ED A0       > ldi
1584   53EE ED A0       > ldi
1584   53F0 ED A0       > ldi
1584   53F2 ED A0       > ldi
1584   53F4 ED A0       > ldi
1584   53F6 ED A0       > ldi
1584   53F8 ED A0       > ldi
1584   53FA ED A0       > ldi
1584   53FC ED A0       > ldi
1584   53FE ED A0       > ldi
1584   5400 ED A0       > ldi
1584   5402 ED A0       > ldi
1584   5404 ED A0       > ldi
1584   5406 ED A0       > ldi
1584   5408 ED A0       > ldi
1584   540A ED A0       > ldi
1584   540C ED A0       > ldi
1584   540E ED A0       > ldi
1584   5410 ED A0       > ldi
1584   5412 ED A0       > ldi
1584   5414 ED A0       > ldi
1584   5416 ED A0       > ldi
1584   5418 ED A0       > ldi
1584   541A ED A0       > ldi
1584   541C ED A0       > ldi
1584   541E ED A0       > ldi
1584   5420 ED A0       > ldi
1584   5422 ED A0       > ldi
1584   5424 ED A0       > ldi
1584   5426 ED A0       > ldi
1584   5428 ED A0       > ldi
1584   542A ED A0       > ldi
1584   542C ED A0       > ldi
1584   542E ED A0       > ldi
1584   5430 ED A0       > ldi
1584   5432 ED A0       > ldi
1584   5434 ED A0       > ldi
1584   5436 ED A0       > ldi
1584   5438 ED A0       > ldi
1584   543A ED A0       > ldi
1584   543C ED A0       > ldi
1584   543E ED A0       > ldi
1584   5440 ED A0       > ldi
1584   5442 ED A0       > ldi
1584   5444 ED A0       > ldi
1584   5446 ED A0       > ldi
1584   5448 ED A0       > ldi
1584   544A ED A0       > ldi
1584   544C ED A0       > ldi
1584   544E ED A0       > ldi
1584   5450 ED A0       > ldi
1584   5452 ED A0       > ldi
1584   5454 ED A0       > ldi
1584   5456 ED A0       > ldi
1584   5458 ED A0       > ldi
1584   545A ED A0       > ldi
1584   545C ED A0       > ldi
1584   545E ED A0       > ldi
1584   5460 ED A0       > ldi
1584   5462 ED A0       > ldi
1584   5464 ED A0       > ldi
1584   5466 ED A0       > ldi
1584   5468 ED A0       > ldi
1584   546A ED A0       > ldi
1584   546C ED A0       > ldi
1584   546E ED A0       > ldi
1584   5470 ED A0       > ldi
1584   5472 ED A0       > ldi
1584   5474 ED A0       > ldi
1584   5476 ED A0       > ldi
1584   5478 ED A0       > ldi
1584   547A ED A0       > ldi
1584   547C ED A0       > ldi
1584   547E ED A0       > ldi
1584   5480 ED A0       > ldi
1584   5482 ED A0       > ldi
1584   5484 ED A0       > ldi
1584   5486 ED A0       > ldi
1584   5488 ED A0       > ldi
1584   548A ED A0       > ldi
1584   548C ED A0       > ldi
1584   548E ED A0       > ldi
1584   5490 ED A0       > ldi
1584   5492 ED A0       > ldi
1584   5494 ED A0       > ldi
1584   5496 ED A0       > ldi
1584   5498 ED A0       > ldi
1584   549A ED A0       > ldi
1584   549C ED A0       > ldi
1584   549E ED A0       > ldi
1584   54A0 ED A0       > ldi
1584   54A2 ED A0       > ldi
1584   54A4 ED A0       > ldi
1584   54A6 ED A0       > ldi
1584   54A8 ED A0       > ldi
1584   54AA ED A0       > ldi
1584   54AC ED A0       > ldi
1584   54AE ED A0       > ldi
1584   54B0 ED A0       > ldi
1584   54B2 ED A0       > ldi
1584   54B4 ED A0       > ldi
1584   54B6 ED A0       > ldi
1584   54B8 ED A0       > ldi
1584   54BA ED A0       > ldi
1584   54BC ED A0       > ldi
1584   54BE ED A0       > ldi
1584   54C0 ED A0       > ldi
1584   54C2 ED A0       > ldi
1584   54C4 ED A0       > ldi
1584   54C6 ED A0       > ldi
1584   54C8 ED A0       > ldi
1584   54CA ED A0       > ldi
1584   54CC ED A0       > ldi
1584   54CE ED A0       > ldi
1584   54D0 ED A0       > ldi
1584   54D2 ED A0       > ldi
1584   54D4 ED A0       > ldi
1584   54D6 ED A0       > ldi
1584   54D8 ED A0       > ldi
1584   54DA ED A0       > ldi
1584   54DC ED A0       > ldi
1584   54DE ED A0       > ldi
1584   54E0 ED A0       > ldi
1584   54E2 ED A0       > ldi
1584   54E4 ED A0       > ldi
1584   54E6 ED A0       > ldi
1584   54E8 ED A0       > ldi
1584   54EA ED A0       > ldi
1584   54EC ED A0       > ldi
1584   54EE ED A0       > ldi
1584   54F0 ED A0       > ldi
1584   54F2 ED A0       > ldi
1584   54F4 ED A0       > ldi
1584   54F6 ED A0       > ldi
1584   54F8 ED A0       > ldi
1584   54FA ED A0       > ldi
1584   54FC ED A0       > ldi
1584   54FE ED A0       > ldi
1584   5500 ED A0       > ldi
1584   5502 ED A0       > ldi
1584   5504 ED A0       > ldi
1584   5506 ED A0       > ldi
1584   5508 ED A0       > ldi
1584   550A ED A0       > ldi
1584   550C ED A0       > ldi
1584   550E ED A0       > ldi
1584   5510 ED A0       > ldi
1584   5512 ED A0       > ldi
1584   5514 ED A0       > ldi
1584   5516 ED A0       > ldi
1584   5518 ED A0       > ldi
1584   551A ED A0       > ldi
1584   551C ED A0       > ldi
1584   551E ED A0       > ldi
1584   5520 ED A0       > ldi
1584   5522 ED A0       > ldi
1584   5524 ED A0       > ldi
1584   5526 ED A0       > ldi
1584   5528 ED A0       > ldi
1584   552A ED A0       > ldi
1584   552C ED A0       > ldi
1584   552E ED A0       > ldi
1584   5530 ED A0       > ldi
1584   5532 ED A0       > ldi
1584   5534 ED A0       > ldi
1584   5536 ED A0       > ldi
1584   5538 ED A0       > ldi
1584   553A ED A0       > ldi
1584   553C ED A0       > ldi
1584   553E ED A0       > ldi
1584   5540 ED A0       > ldi
1584   5542 ED A0       > ldi
1584   5544 ED A0       > ldi
1584   5546 ED A0       > ldi
1584   5548 ED A0       > ldi
1584   554A ED A0       > ldi
1584   554C ED A0       > ldi
1584   554E ED A0       > ldi
1584   5550 ED A0       > ldi
1584   5552 ED A0       > ldi
1584   5554 ED A0       > ldi
1584   5556 ED A0       > ldi
1584   5558 ED A0       > ldi
1584   555A ED A0       > ldi
1584   555C ED A0       > ldi
1584   555E ED A0       > ldi
1584   5560 ED A0       > ldi
1584   5562 ED A0       > ldi
1584   5564 ED A0       > ldi
1584   5566 ED A0       > ldi
1584   5568 ED A0       > ldi
1584   556A ED A0       > ldi
1584   556C ED A0       > ldi
1584   556E ED A0       > ldi
1584   5570 ED A0       > ldi
1584   5572 ED A0       > ldi
1584   5574 ED A0       > ldi
1584   5576 ED A0       > ldi
1584   5578 ED A0       > ldi
1584   557A ED A0       > ldi
1584   557C ED A0       > ldi
1584   557E ED A0       > ldi
1584   5580 ED A0       > ldi
1584   5582 ED A0       > ldi
1584   5584 ED A0       > ldi
1584   5586 ED A0       > ldi
1584   5588 ED A0       > ldi
1584   558A ED A0       > ldi
1584   558C ED A0       > ldi
1584   558E ED A0       > ldi
1584   5590 ED A0       > ldi
1584   5592 ED A0       > ldi
1584   5594 ED A0       > ldi
1584   5596 ED A0       > ldi
1584   5598 ED A0       > ldi
1584   559A ED A0       > ldi
1584   559C ED A0       > ldi
1584   559E ED A0       > ldi
1584   55A0 ED A0       > ldi
1584   55A2 ED A0       > ldi
1584   55A4 ED A0       > ldi
1584   55A6 ED A0       > ldi
1584   55A8 ED A0       > ldi
1584   55AA ED A0       > ldi
1584   55AC ED A0       > ldi
1584   55AE ED A0       > ldi
1584   55B0 ED A0       > ldi
1584   55B2 ED A0       > ldi
1584   55B4 ED A0       > ldi
1584   55B6 ED A0       > ldi
1584   55B8 ED A0       > ldi
1584   55BA ED A0       > ldi
1584   55BC ED A0       > ldi
1584   55BE ED A0       > ldi
1584   55C0 ED A0       > ldi
1584   55C2 ED A0       > ldi
1584   55C4 ED A0       > ldi
1584   55C6 ED A0       > ldi
1584   55C8 ED A0       > ldi
1584   55CA ED A0       > ldi
1584   55CC ED A0       > ldi
1584   55CE ED A0       > ldi
1584   55D0 ED A0       > ldi
1584   55D2 ED A0       > ldi
1584   55D4 ED A0       > ldi
1584   55D6 ED A0       > ldi
1584   55D8 ED A0       > ldi
1584   55DA ED A0       > ldi
1584   55DC ED A0       > ldi
1584   55DE ED A0       > ldi
1584   55E0 ED A0       > ldi
1584   55E2 ED A0       > ldi
1584   55E4 ED A0       > ldi
1584   55E6 ED A0       > ldi
1584   55E8 ED A0       > ldi
1584   55EA ED A0       > ldi
1584   55EC ED A0       > ldi
1584   55EE ED A0       > ldi
1584   55F0 ED A0       > ldi
1584   55F2 ED A0       > ldi
1584   55F4 ED A0       > ldi
1584   55F6 ED A0       > ldi
1584   55F8 ED A0       > ldi
1584   55FA ED A0       > ldi
1584   55FC ED A0       > ldi
1584   55FE ED A0       > ldi
1584   5600 ED A0       > ldi
1584   5602 ED A0       > ldi
1584   5604 ED A0       > ldi
1584   5606 ED A0       > ldi
1584   5608 ED A0       > ldi
1584   560A ED A0       > ldi
1584   560C ED A0       > ldi
1584   560E ED A0       > ldi
1584   5610 ED A0       > ldi
1584   5612 ED A0       > ldi
1584   5614 ED A0       > ldi
1584   5616 ED A0       > ldi
1584   5618 ED A0       > ldi
1584   561A ED A0       > ldi
1584   561C ED A0       > ldi
1584   561E ED A0       > ldi
1584   5620 ED A0       > ldi
1584   5622 ED A0       > ldi
1584   5624 ED A0       > ldi
1584   5626 ED A0       > ldi
1584   5628 ED A0       > ldi
1584   562A ED A0       > ldi
1584   562C ED A0       > ldi
1584   562E ED A0       > ldi
1584   5630 ED A0       > ldi
1584   5632 ED A0       > ldi
1584   5634 ED A0       > ldi
1584   5636 ED A0       > ldi
1584   5638 ED A0       > ldi
1584   563A ED A0       > ldi
1584   563C ED A0       > ldi
1584   563E ED A0       > ldi
1584   5640 ED A0       > ldi
1584   5642 ED A0       > ldi
1584   5644 ED A0       > ldi
1584   5646 ED A0       > ldi
1584   5648 ED A0       > ldi
1584   564A ED A0       > ldi
1584   564C ED A0       > ldi
1584   564E ED A0       > ldi
1584   5650 ED A0       > ldi
1584   5652 ED A0       > ldi
1584   5654 ED A0       > ldi
1584   5656 ED A0       > ldi
1584   5658 ED A0       > ldi
1584   565A ED A0       > ldi
1584   565C ED A0       > ldi
1584   565E ED A0       > ldi
1584   5660 ED A0       > ldi
1584   5662 ED A0       > ldi
1584   5664 ED A0       > ldi
1584   5666 ED A0       > ldi
1584   5668 ED A0       > ldi
1584   566A ED A0       > ldi
1584   566C ED A0       > ldi
1584   566E ED A0       > ldi
1584   5670 ED A0       > ldi
1584   5672 ED A0       > ldi
1584   5674 ED A0       > ldi
1584   5676 ED A0       > ldi
1584   5678 ED A0       > ldi
1584   567A ED A0       > ldi
1584   567C ED A0       > ldi
1584   567E ED A0       > ldi
1584   5680 ED A0       > ldi
1584   5682 ED A0       > ldi
1584   5684 ED A0       > ldi
1584   5686 ED A0       > ldi
1584   5688 ED A0       > ldi
1584   568A ED A0       > ldi
1584   568C ED A0       > ldi
1584   568E ED A0       > ldi
1584   5690 ED A0       > ldi
1584   5692 ED A0       > ldi
1584   5694 ED A0       > ldi
1584   5696 ED A0       > ldi
1584   5698 ED A0       > ldi
1584   569A ED A0       > ldi
1584   569C ED A0       > ldi
1584   569E ED A0       > ldi
1584   56A0 ED A0       > ldi
1584   56A2 ED A0       > ldi
1584   56A4 ED A0       > ldi
1584   56A6 ED A0       > ldi
1584   56A8 ED A0       > ldi
1584   56AA ED A0       > ldi
1584   56AC ED A0       > ldi
1584   56AE ED A0       > ldi
1584   56B0 ED A0       > ldi
1584   56B2 ED A0       > ldi
1584   56B4 ED A0       > ldi
1584   56B6 ED A0       > ldi
1584   56B8 ED A0       > ldi
1584   56BA ED A0       > ldi
1584   56BC ED A0       > ldi
1584   56BE ED A0       > ldi
1584   56C0 ED A0       > ldi
1584   56C2 ED A0       > ldi
1584   56C4 ED A0       > ldi
1584   56C6 ED A0       > ldi
1584   56C8 ED A0       > ldi
1584   56CA ED A0       > ldi
1584   56CC ED A0       > ldi
1584   56CE ED A0       > ldi
1584   56D0 ED A0       > ldi
1584   56D2 ED A0       > ldi
1584   56D4 ED A0       > ldi
1584   56D6 ED A0       > ldi
1584   56D8 ED A0       > ldi
1584   56DA ED A0       > ldi
1584   56DC ED A0       > ldi
1584   56DE ED A0       > ldi
1584   56E0 ED A0       > ldi
1584   56E2 ED A0       > ldi
1584   56E4 ED A0       > ldi
1584   56E6 ED A0       > ldi
1584   56E8 ED A0       > ldi
1584   56EA ED A0       > ldi
1584   56EC ED A0       > ldi
1584   56EE ED A0       > ldi
1584   56F0 ED A0       > ldi
1584   56F2 ED A0       > ldi
1584   56F4 ED A0       > ldi
1584   56F6 ED A0       > ldi
1584   56F8 ED A0       > ldi
1584   56FA ED A0       > ldi
1584   56FC ED A0       > ldi
1584   56FE ED A0       > ldi
1584   5700 ED A0       > ldi
1584   5702 ED A0       > ldi
1584   5704 ED A0       > ldi
1584   5706 ED A0       > ldi
1584   5708 ED A0       > ldi
1584   570A ED A0       > ldi
1584   570C ED A0       > ldi
1584   570E ED A0       > ldi
1584   5710 ED A0       > ldi
1584   5712 ED A0       > ldi
1584   5714 ED A0       > ldi
1584   5716 ED A0       > ldi
1584   5718 ED A0       > ldi
1584   571A ED A0       > ldi
1584   571C ED A0       > ldi
1584   571E ED A0       > ldi
1584   5720 ED A0       > ldi
1584   5722 ED A0       > ldi
1584   5724 ED A0       > ldi
1584   5726 ED A0       > ldi
1584   5728 ED A0       > ldi
1584   572A ED A0       > ldi
1584   572C ED A0       > ldi
1584   572E ED A0       > ldi
1584   5730 ED A0       > ldi
1585   5732 EB          	ex		hl, de
1586   5733 00          	nop
1587   5734 3A 00 7B    	ld		a, (PORTSPI)				; descarta CRC
1588   5737 00          	nop
1589   5738 3A 00 7B    	ld		a, (PORTSPI)
1590   573B             .fim: 
1591   573B AF          	xor		a							; zera carry para informar leitura sem erros
1592   573C C3 DA 4E    	jp		terminaLeituraEscritaBloco
1593   573F             
1594   573F             ; ------------------------------------------------
1595   573F             ; Converte blocos para bytes. Na pratica faz
1596   573F             ; BC DE = (BC DE) * 512
1597   573F             ; ------------------------------------------------
1598   573F             blocoParaByte: 
1599   573F 41          	ld		b, c
1600   5740 4A          	ld		c, d
1601   5741 53          	ld		d, e
1602   5742 1E 00       	ld		e, 0
1603   5744 CB 22       	sla		d
1604   5746 CB 11       	rl		c
1605   5748 CB 10       	rl		b
1606   574A C9          	ret
1607   574B             
1608   574B             ; ------------------------------------------------
1609   574B             ; Funcoes utilitarias
1610   574B             ; ------------------------------------------------
1611   574B             
1612   574B             ; ------------------------------------------------
1613   574B             ; Imprime string na tela apontada por DE
1614   574B             ; Destroi todos os registradores
1615   574B             ; ------------------------------------------------
1616   574B             printString: 
1617   574B 1A          	ld		a, (de)
1618   574C B7          	or		a
1619   574D C8          	ret z
1620   574E CD A2 00    	call	BIOS_CHPUT
1621   5751 13          	inc		de
1622   5752 18 F7       	jr		printString
1623   5754             
1624   5754             
1625   5754             ; ------------------------------------------------
1626   5754             ; Converte o byte em A para string em decimal no
1627   5754             ; buffer apontado por DE
1628   5754             ; Destroi AF, BC, HL, DE
1629   5754             ; ------------------------------------------------
1630   5754             DecToAscii: 
1631   5754 26 00       	ld		h, 0
1632   5756 6F          	ld		l, a						; copiar A para HL
1633   5757 FD 36 34 01 	ld		(iy+TEMP), 1				; flag para indicar que devemos cortar os zeros a esquerda
1634   575B 01 9C FF    	ld		bc, -100					; centenas
1635   575E CD 6C 57    	call	.num1
1636   5761 0E F6       	ld		c, -10						; dezenas
1637   5763 CD 6C 57    	call	.num1
1638   5766 FD 36 34 02 	ld		(iy+TEMP), 2				; unidade deve exibir 0 se for zero e nao corta-lo
1639   576A 0E FF       	ld		c, -1						; unidades
1640   576C             .num1: 
1641   576C 3E 2F       	ld		a, '0'-1
1642   576E             .num2: 
1643   576E 3C          	inc		a							; contar o valor em ascii de '0' a '9'
1644   576F 09          	add		hl, bc						; somar com negativo
1645   5770 38 FC       	jr c,	.num2					; ainda nao zeramos
1646   5772 ED 42       	sbc		hl, bc						; retoma valor original
1647   5774 FD 35 34    	dec		(iy+TEMP)					; se flag do corte do zero indicar para nao cortar, pula
1648   5777 20 08       	jr nz,	.naozero
1649   5779 FE 30       	cp		'0'							; devemos cortar os zeros a esquerda. Eh zero?
1650   577B 20 04       	jr nz,	.naozero
1651   577D FD 34 34    	inc		(iy+TEMP)					; se for zero, nao salvamos e voltamos a flag
1652   5780 C9          	ret
1653   5781             .naozero: 
1654   5781 12          	ld		(de), a						; eh zero ou eh outro numero, salvar
1655   5782 13          	inc		de							; incrementa ponteiro de destino
1656   5783 C9          	ret
1657   5784             
1658   5784             ; ------------------------------------------------
1659   5784             ; Converte o byte em A para string em hexa no
1660   5784             ; buffer apontado por DE
1661   5784             ; Destroi AF, C, DE
1662   5784             ; ------------------------------------------------
1663   5784             HexToAscii: 
1664   5784 4F          	ld		c, a
1665   5785 1F          	rra
1666   5786 1F          	rra
1667   5787 1F          	rra
1668   5788 1F          	rra
1669   5789 CD 8D 57    	call	.conv
1670   578C 79          	ld  	a, c
1671   578D             .conv: 
1672   578D E6 0F       	and		$0F
1673   578F C6 90       	add		a, $90
1674   5791 27          	daa
1675   5792 CE 40       	adc		a, $40
1676   5794 27          	daa
1677   5795 12          	ld		(de), a
1678   5796 13          	inc		de
1679   5797 C9          	ret
1680   5798             
1681   5798             ; ------------------------------------------------
1682   5798             ; Converte o byte em A para string em decimal e
1683   5798             ; imprime na tela
1684   5798             ; Destroi AF, BC, HL, DE
1685   5798             ; ------------------------------------------------
1686   5798             printDecToAscii: 
1687   5798 26 00       	ld		h, 0
1688   579A 6F          	ld		l, a						; copiar A para HL
1689   579B 06 01       	ld		b, 1						; flag para indicar que devemos cortar os zeros a esquerda
1690   579D 11 9C FF    	ld		de, -100					; centenas
1691   57A0 CD AC 57    	call	.num1
1692   57A3 1E F6       	ld		e, -10						; dezenas
1693   57A5 CD AC 57    	call	.num1
1694   57A8 06 02       	ld		b, 2						; unidade deve exibir 0 se for zero e nao corta-lo
1695   57AA 1E FF       	ld		e, -1						; unidades
1696   57AC             .num1: 
1697   57AC 3E 2F       	ld		a, '0'-1
1698   57AE             .num2: 
1699   57AE 3C          	inc		a							; contar o valor em ascii de '0' a '9'
1700   57AF 19          	add		hl, de						; somar com negativo
1701   57B0 38 FC       	jr c,	.num2						; ainda nao zeramos
1702   57B2 ED 52       	sbc		hl, de						; retoma valor original
1703   57B4 10 06       	djnz	.naozero					; se flag do corte do zero indicar para nao cortar, pula
1704   57B6 FE 30       	cp		'0'							; devemos cortar os zeros a esquerda. Eh zero?
1705   57B8 20 02       	jr nz,	.naozero
1706   57BA 04          	inc		b							; se for zero, nao imprimimos e voltamos a flag
1707   57BB C9          	ret
1708   57BC             .naozero: 
1709   57BC E5          	push	hl							; nao eh zero ou eh outro numero, imprimir
1710   57BD C5          	push	bc
1711   57BE CD A2 00    	call	BIOS_CHPUT
1712   57C1 C1          	pop		bc
1713   57C2 E1          	pop		hl
1714   57C3 C9          	ret
1715   57C4             
1716   57C4             ; ------------------------------------------------
1717   57C4             ; Procura pelo nome do fabricante em uma tabela.
1718   57C4             ; A contem o byte do fabricante
1719   57C4             ; Devolve HL apontando para o buffer do fabricante
1720   57C4             ; e BC com o comprimento do texto
1721   57C4             ; Destroi AF, BC, HL
1722   57C4             ; ------------------------------------------------
1723   57C4             pegaFabricante: 
1724   57C4 4F          	ld		c, a
1725   57C5 21 E6 57    	ld		hl, tblFabricantes
1726   57C8             
1727   57C8             .loop: 
1728   57C8 7E          	ld		a, (hl)
1729   57C9 23          	inc		hl
1730   57CA B9          	cp		c
1731   57CB 28 0C       	jr z,	.achado
1732   57CD B7          	or		a
1733   57CE 28 09       	jr z,	.achado
1734   57D0 C5          	push	bc
1735   57D1 CD D9 57    	call	.achado
1736   57D4 09          	add		hl, bc
1737   57D5 23          	inc		hl
1738   57D6 C1          	pop		bc
1739   57D7 18 EF       	jr		.loop
1740   57D9             
1741   57D9             .achado: 
1742   57D9 0E 00       	ld		c, 0
1743   57DB E5          	push	hl
1744   57DC AF          	xor		a
1745   57DD             .loop2: 
1746   57DD 0C          	inc		c
1747   57DE 23          	inc		hl
1748   57DF BE          	cp		(hl)
1749   57E0 20 FB       	jr nz,	.loop2
1750   57E2 E1          	pop		hl
1751   57E3 06 00       	ld		b, 0
1752   57E5 C9          	ret
1753   57E6             
1754   57E6             ; ---------------------------------------------------------------------------
1755   57E6             tblFabricantes: 
1756   57E6 01          	db		1
1757   57E7             	db		"Panasonic",0
1757   57E7 50616E61736F6E696300
1758   57F1 02          	db		2
1759   57F2             	db		"Toshiba",0
1759   57F2 546F736869626100
1760   57FA 03          	db		3
1761   57FB             	db		"SanDisk",0
1761   57FB 53616E4469736B00
1762   5803 04          	db		4
1763   5804             	db		"SMI-S",0
1763   5804 534D492D5300
1764   580A 06          	db		6
1765   580B             	db		"Renesas",0
1765   580B 52656E6573617300
1766   5813 11          	db		17
1767   5814             	db		"Dane-Elec",0
1767   5814 44616E652D456C656300
1768   581E 13          	db		19
1769   581F             	db		"KingMax",0
1769   581F 4B696E674D617800
1770   5827 15          	db		21
1771   5828             	db		"Samsung",0
1771   5828 53616D73756E6700
1772   5830 18          	db		24
1773   5831             	db		"Infineon",0
1773   5831 496E66696E656F6E00
1774   583A 1A          	db		26
1775   583B 50 51 49 00 	db		"PQI",0
1776   583F 1B          	db		27
1777   5840 536F6E7900  	db		"Sony",0
1778   5845 1C          	db		28
1779   5846             	db		"Transcend",0
1779   5846 5472616E7363656E6400
1780   5850 1D          	db		29
1781   5851             	db		"A-DATA",0
1781   5851 412D4441544100
1782   5858 1F          	db		31
1783   5859             	db		"SiliconPower",0
1783   5859 53696C69636F6E506F77657200
1784   5866 27          	db		39
1785   5867             	db		"Verbatim",0
1785   5867 566572626174696D00
1786   5870 41          	db		65
1787   5871 4F 4B 49 00 	db		"OKI",0
1788   5875 73          	db		115
1789   5876             	db		"SilverHT",0
1789   5876 53696C766572485400
1790   587F 89          	db		137
1791   5880             	db		"L.Data",0
1791   5880 4C2E4461746100
1792   5887 00          	db		0
1793   5888             	db		"Generico",0
1793   5888 47656E657269636F00
1794   5891             
1795   5891             ; ------------------------------------------------
1796   5891             strTitulo: 
1797   5891             	db		"SD Mapper/Megaram",13,10
1797   5891 5344204D61707065722F4D65676172616D0D0A
1798   58A4             	db		"Nextor Driver",13,10
1798   58A4 4E6578746F72204472697665720D0A
1799   58B3             	db		"Versao "
1799   58B3 56657273616F20
1800   58BA 312E302E34  	db		VER_MAIN + $30, '.', VER_SEC + $30, '.', VER_REV + $30
1801   58BF 0D 0A       	db		13, 10
1802   58C1             	db		"Copyright (c) 2014",13,10
1802   58C1 436F707972696768742028632920323031340D0A
1803   58D5             	db		"Fabio Belavenuto",13,10
1803   58D5 466162696F2042656C6176656E75746F0D0A
1804   58E7             	db		"PCB por Luciano Sturaro",13,10
1804   58E7 50434220706F72204C756369616E6F205374757261726F0D0A
1805   5900             	db		"Licenced under",13,10
1805   5900 4C6963656E63656420756E6465720D0A
1806   5910             	db		"CERN OHL v1.1",13,10
1806   5910 4345524E204F484C2076312E310D0A
1807   591F             	db		"http://ohwr.org/cernohl",13,10
1807   591F 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
1808   5938             	; fall throw
1809   5938             strCrLf: 
1810   5938 0D 0A 00    	db		13,10,0
1811   593B             strCartao: 
1812   593B             	db		"Slot ",0
1812   593B 536C6F742000
1813   5941             strVazio: 
1814   5941             	db		"Vazio",13,10,0
1814   5941 56617A696F0D0A00
1815   5949             strNaoIdentificado: 
1816   5949             	db		"Nao identificado!",13,10,0
1816   5949 4E616F206964656E746966696361646F210D0A00
1817   595D             strMr_mp_desativada: 
1818   595D             	db		"Mapper/megaram desativada",13,10,0
1818   595D 4D61707065722F6D65676172616D20646573617469766164610D0A00
1819   5979             strMapper: 
1820   5979             	db		"Mapper ativada",13,10,0
1820   5979 4D617070657220617469766164610D0A00
1821   598A             strMegaram: 
1822   598A             	db		"Megaram ativada",13,10,0
1822   598A 4D65676172616D20617469766164610D0A00
1823   599C             strSDV1: 
1824   599C             	db		"SDV1 - ",0
1824   599C 53445631202D2000
1825   59A4             strSDV2: 
1826   59A4             	db		"SDV2 - ",0
1826   59A4 53445632202D2000
1827   59AC             
1828   59AC             ;-----------------------------------------------------------------------------
1829   59AC             ;
1830   59AC             ; End of the driver code
1831   59AC             
1832   59AC             DRV_END: 
1833   59AC             
1834   59AC FF          	ds	3ED0h-(DRV_END-DRV_START), $FF
1835   7FD0             
1836   7FD0             
