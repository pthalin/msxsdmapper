0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 7B00h~7EFFh	: SPI data transfer window (read/write)
0015   0000             ; 7F00h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	If no SD card is selected:
0018   0000             ;	b7-b2 : always 0
0019   0000             ;	b1 : SW1 status (Driver selection)
0020   0000             ;	b0 : SW0 status. 0=RAM disabled, 1=RAM enabled
0021   0000             ;	If any SD card is selected:
0022   0000             ;	b7-b3 : always 0
0023   0000             ;	b2 : 1=Write protecton enabled for SD card slot selected
0024   0000             ;	b1 : 0=SD card present on slot selected
0025   0000             ;	b0 : 1=SD Card on slot selected changed since last read
0026   0000             ;	<write>
0027   0000             ;	b0	: SD card slot-0 chip-select (1=selected)
0028   0000             ;	b1	: SD card slot-1 chip-select (1=selected)
0029   0000             
0030   0000             ; 7F02h		: 8-bit timer (97.65625 KHz frequency, 10.24uS resolution) (read/write)
0031   0000             ; When a value is written, the timer will decrease it until it reaches zero
0032   0000             
0033   0000             	output	"driver.bin"
0034   0000             
0035   0000             ;-----------------------------------------------------------------------------
0036   0000             ;
0037   0000             ; Driver configuration constants
0038   0000             ;
0039   0000             
0040   0000             ;Driver type:
0041   0000             ;   0 for drive-based
0042   0000             ;   1 for device-based
0043   0000             
0044   0000             DRV_TYPE	equ	1
0045   0000             
0046   0000             ;Hot-plug devices support (device-based drivers only):
0047   0000             ;   0 for no hot-plug support
0048   0000             ;   1 for hot-plug support
0049   0000             
0050   0000             DRV_HOTPLUG	equ	0
0051   0000             
0052   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0053   0000             
0054   0000             ;Driver version
0055   0000             
0056   0000             VER_MAIN	equ	1
0057   0000             VER_SEC		equ	0
0058   0000             VER_REV		equ	8
0059   0000             
0060   0000             ;-----------------------------------------------------------------------------
0061   0000             ; SPI addresses. Check the Technical info above for the bit contents
0062   0000             
0063   0000             SPIDATA		= $7B00
0064   0000             SPICTRL		= $7F00
0065   0000             SPISTATUS	= $7F00
0066   0000             TIMERREG	= $7F02
0067   0000             
0068   0000             ; Interface status flags
0069   0000             IF_RAM		= 0		; 1=Interface RAM is enabled
0070   0000             IF_DRVER	= 1		; RAM mode: 0=MegaRAM, 1=MemoryMapper
0071   0000             IF_M_RAM	= (1 shl IF_RAM)		; bitmask for IF_RAM
0072   0000             IF_M_DRVER	= (1 shl IF_DRVER)		; bitmask for IF_DRVER
0073   0000             
0074   0000             ; card slot status flags
0075   0000             SD_DSKCHG	= 0		; SD card changed since last status check
0076   0000             SD_PRESENT	= 1		; SD card present
0077   0000             SD_WRTPROT	= 2		; SD card is write protected
0078   0000             SD_M_DSKCHG	= (1 shl SD_DSKCHG)		; bitmask for SD_DSKCHG
0079   0000             SD_M_PRESENT	= (1 shl SD_PRESENT)		; bitmask for SD_PRESENT
0080   0000             SD_M_WRTPROT	= (1 shl SD_WRTPROT)		; bitmask for SD_WRTPROT
0081   0000             
0082   0000             ; SPI commands: 
0083   0000             CMD0	= 0  | $40
0084   0000             CMD1	= 1  | $40
0085   0000             CMD8	= 8  | $40
0086   0000             CMD9	= 9  | $40
0087   0000             CMD10	= 10 | $40
0088   0000             CMD12	= 12 | $40
0089   0000             CMD16	= 16 | $40
0090   0000             CMD17	= 17 | $40
0091   0000             CMD18	= 18 | $40
0092   0000             CMD24	= 24 | $40
0093   0000             CMD25	= 25 | $40
0094   0000             CMD55	= 55 | $40
0095   0000             CMD58	= 58 | $40
0096   0000             ACMD23	= 23 | $40
0097   0000             ACMD41	= 41 | $40
0098   0000             
0099   0000             ; Work area variables 
0100   0000              STRUCT WRKAREA
0101   0000~            BCSD 		ds 16	; Card Specific Data
0102   0000~            BCID1		ds 16	; Card-ID of card1
0103   0000~            BCID2		ds 16	; Card-ID of card2
0104   0000~            NUMSD		db 	; Currently selected card: 1 or 2 
0105   0000~            CARDFLAGS	db 	; Flags that indicate card-change or card error 
0106   0000~            NUMBLOCKS	db 	; Number of blocks in multi-block operations 
0107   0000~            BLOCKS1		ds 3	; 3 bytes. Size of card1, in blocks.
0108   0000~            BLOCKS2		ds 3	; 3 bytes. Size of card2, in blocks.
0109   0000~            TEMP		db	; Temporary data
0110   0000~            TRLDIR		ds 8	; R800 data transfer helper 
0111   0000              ENDS
0112   0000             
0113   0000             
0114   0000             ;-----------------------------------------------------------------------------
0115   0000             ;
0116   0000             ; Standard BIOS and work area entries
0117   0000             INITXT	= $006C		; Inicializa SCREEN0
0118   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0119   0000             CHGET	= $009F		; Get character from keyboard buffer
0120   0000             CHPUT	= $00A2		; A=char
0121   0000             CLS	= $00C3		; Chamar com A=0
0122   0000             ERAFNK	= $00CC		; Erase function key display
0123   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0124   0000             KILBUF	= $0156		; Clear keyboard buffer
0125   0000             EXTROM	= $015F
0126   0000             
0127   0000             ; subROM functions
0128   0000             SDFSCR	= $0185
0129   0000             REDCLK	= $01F5
0130   0000             
0131   0000             
0132   0000             ; System variables
0133   0000             MSXVER	= $002D
0134   0000             LINL40	= $F3AE		; Width
0135   0000             LINLEN	= $F3B0
0136   0000             INTFLG	= $FC9B
0137   0000             SCRMOD	= $FCAF
0138   0000             
0139   0000             
0140   0000             ;-----------------------------------------------------------------------------
0141   0000             
0142   0000             
0143   0000             	org		$4000
0144   4000             
0145   4000 FF          	ds		256, $FF		; 256 dummy bytes
0146   4100             
0147   4100             DRV_START: 
0148   4100             
0149   4100             ;-----------------------------------------------------------------------------
0150   4100             ;
0151   4100             ; Miscellaneous constants
0152   4100             ;
0153   4100             
0154   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0155   4100             ;It is used by some of the kernel page 0 routines.
0156   4100             
0157   4100             CODE_ADD: 	equ	0F84Ch
0158   4100             
0159   4100             
0160   4100             ;-----------------------------------------------------------------------------
0161   4100             ;
0162   4100             ; Error codes for DEV_RW
0163   4100             ;
0164   4100             
0165   4100             ENCOMP	equ	0FFh
0166   4100             EWRERR	equ	0FEh
0167   4100             EDISK	equ	0FDh
0168   4100             ENRDY	equ	0FCh
0169   4100             EDATA	equ	0FAh
0170   4100             ERNF	equ	0F9h
0171   4100             EWPROT	equ	0F8h
0172   4100             EUFORM	equ	0F7h
0173   4100             ESEEK	equ	0F3h
0174   4100             EIFORM	equ	0F0h
0175   4100             EIDEVL	equ	0B5h
0176   4100             EIPARM	equ	08Bh
0177   4100             
0178   4100             ;-----------------------------------------------------------------------------
0179   4100             ;
0180   4100             ; Routines and information available on kernel page 0
0181   4100             ;
0182   4100             
0183   4100             ;* Get in A the current slot for page 1. Corrupts F.
0184   4100             ;  Must be called by using CALBNK to bank 0:
0185   4100             ;    xor a
0186   4100             ;    ld ix,GSLOT1
0187   4100             ;    call CALBNK
0188   4100             
0189   4100             GSLOT1	equ	402Dh
0190   4100             
0191   4100             
0192   4100             ;* This routine reads a byte from another bank.
0193   4100             ;  Must be called by using CALBNK to the desired bank,
0194   4100             ;  passing the address to be read in HL:
0195   4100             ;    ld a,<bank number>
0196   4100             ;    ld hl,<byte address>
0197   4100             ;    ld ix,RDBANK
0198   4100             ;    call CALBNK
0199   4100             
0200   4100             RDBANK	equ	403Ch
0201   4100             
0202   4100             
0203   4100             ;* This routine temporarily switches kernel main bank
0204   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0205   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0206   4100             ;  It is necessary to use this routine to invoke CALBAS
0207   4100             ;  (so that kernel bank is correct in case of BASIC error)
0208   4100             ;  and to invoke DOS functions via F37Dh hook.
0209   4100             ;
0210   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0211   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0212   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0213   4100             
0214   4100             CALLB0	equ	403Fh
0215   4100             
0216   4100             
0217   4100             ;* Call a routine in another bank.
0218   4100             ;  Must be used if the driver spawns across more than one bank.
0219   4100             ;
0220   4100             ;  Input:  A = bank number
0221   4100             ;          IX = routine address
0222   4100             ;          AF' = AF for the routine
0223   4100             ;          HL' = Ix for the routine
0224   4100             ;          BC, DE, HL, IY = input for the routine
0225   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0226   4100             
0227   4100             CALBNK	equ	4042h
0228   4100             
0229   4100             
0230   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0231   4100             ;  which will in turn contain a pointer to the allocated page 3
0232   4100             ;  work area for that slot (0 if no work area was allocated).
0233   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0234   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0235   4100             ;  Corrupts F.
0236   4100             ;  Must be called by using CALBNK to bank 0:
0237   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0238   4100             ;    ex af,af'
0239   4100             ;    xor a
0240   4100             ;    ld ix,GWORK
0241   4100             ;    call CALBNK
0242   4100             
0243   4100             GWORK	equ	4045h
0244   4100             
0245   4100             
0246   4100             ;* This address contains one byte that tells how many banks
0247   4100             ;  form the Nextor kernel (or alternatively, the first bank
0248   4100             ;  number of the driver).
0249   4100             
0250   4100             K_SIZE	equ	40FEh
0251   4100             
0252   4100             
0253   4100             ;* This address contains one byte with the current bank number.
0254   4100             
0255   4100             CUR_BANK	equ	40FFh
0256   4100             
0257   4100             
0258   4100             ;-----------------------------------------------------------------------------
0259   4100             ;
0260   4100             ; Built-in format choice strings
0261   4100             ;
0262   4100             
0263   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0264   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0265   4100             
0266   4100             
0267   4100             ;-----------------------------------------------------------------------------
0268   4100             ;
0269   4100             ; Driver signature
0270   4100             ;
0271   4100             	db	"NEXTOR_DRIVER",0
0271   4100 4E4558544F525F44524956455200
0272   410E             
0273   410E             
0274   410E             ;-----------------------------------------------------------------------------
0275   410E             ;
0276   410E             ; Driver flags:
0277   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0278   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0279   410E             
0280   410E 01          	db 1+(2*DRV_HOTPLUG)
0281   410F             
0282   410F             ;-----------------------------------------------------------------------------
0283   410F             ;
0284   410F             ; Reserved byte
0285   410F             ;
0286   410F 00          	db	0
0287   4110             
0288   4110             ;-----------------------------------------------------------------------------
0289   4110             ;
0290   4110             ; Driver name
0291   4110             ;
0292   4110             
0293   4110             DRV_NAME: 
0294   4110             	db	"SDHC Driver"
0294   4110 5344484320447269766572
0295   411B 20          	ds	32-($-DRV_NAME)," "
0296   4130             
0297   4130             
0298   4130             ;-----------------------------------------------------------------------------
0299   4130             ;
0300   4130             ; Jump table for the driver public routines
0301   4130             ;
0302   4130             
0303   4130             	; These routines are mandatory for all drivers
0304   4130                     ; (but probably you need to implement only DRV_INIT)
0305   4130             
0306   4130 C3 6C 41    	jp	DRV_TIMI
0307   4133 C3 40 42    	jp	DRV_VERSION
0308   4136 C3 6D 41    	jp	DRV_INIT
0309   4139 C3 47 42    	jp	DRV_BASSTAT
0310   413C C3 49 42    	jp	DRV_BASDEV
0311   413F C3 4B 42    	jp	DRV_EXTBIO
0312   4142 C3 4C 42    	jp	DRV_DIRECT0
0313   4145 C3 4C 42    	jp	DRV_DIRECT1
0314   4148 C3 4C 42    	jp	DRV_DIRECT2
0315   414B C3 4C 42    	jp	DRV_DIRECT3
0316   414E C3 4C 42    	jp	DRV_DIRECT4
0317   4151             
0318   4151 00          	ds	15
0319   4160             
0320   4160             	; These routines are mandatory for device-based drivers
0321   4160             
0322   4160 C3 4D 42    	jp	DEV_RW
0323   4163 C3 CF 42    	jp	DEV_INFO
0324   4166 C3 57 43    	jp	DEV_STATUS
0325   4169 C3 98 43    	jp	LUN_INFO
0326   416C             
0327   416C             
0328   416C             ;=====
0329   416C             ;=====  END of data that must be at fixed addresses
0330   416C             ;=====
0331   416C             
0332   416C             
0333   416C             ;-----------------------------------------------------------------------------
0334   416C             ;
0335   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0336   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0337   416C             
0338   416C             DRV_TIMI: 
0339   416C C9          	ret
0340   416D             
0341   416D             ;-----------------------------------------------------------------------------
0342   416D             ;
0343   416D             ; Driver initialization routine, it is called twice:
0344   416D             ;
0345   416D             ; 1) First execution, for information gathering.
0346   416D             ;    Input:
0347   416D             ;      A = 0
0348   416D             ;      B = number of available drives
0349   416D             ;      HL = maximum size of allocatable work area in page 3
0350   416D             ;    Output:
0351   416D             ;      A = number of required drives (for drive-based driver only)
0352   416D             ;      HL = size of required work area in page 3
0353   416D             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0354   416D             ;
0355   416D             ; 2) Second execution, for work area and hardware initialization.
0356   416D             ;    Input:
0357   416D             ;      A = 1
0358   416D             ;      B = number of allocated drives for this controller
0359   416D             ;
0360   416D             ;    The work area address can be obtained by using GWORK.
0361   416D             ;
0362   416D             ;    If first execution requests more work area than available,
0363   416D             ;    second execution will not be done and DRV_TIMI will not be hooked
0364   416D             ;    to the timer interrupt.
0365   416D             ;
0366   416D             ;    If first execution requests more drives than available,
0367   416D             ;    as many drives as possible will be allocated, and the initialization
0368   416D             ;    procedure will continue the normal way
0369   416D             ;    (for drive-based drivers only. Device-based drivers always
0370   416D             ;     get two allocated drives.)
0371   416D             
0372   416D             DRV_INIT: 
0373   416D B7          	or	a		; Is this the 1st call? 
0374   416E 20 0F       	jr	nz,.call2
0375   4170             ; 1st call:
0376   4170 21 3A 00    	ld	hl,WRKAREA.TRLDIR ; size of work area needed for the Z80
0377   4173 3A 2D 00    	ld	a,(MSXVER)
0378   4176 FE 03       	cp	3		; MSX Turbo-R?
0379   4178 3F          	ccf
0380   4179 D0          	ret	nc		; No, return with Cy off
0381   417A 21 42 00    	ld	hl,WRKAREA	; size of work area needed for the TR
0382   417D B7          	or	a		; Clear Cy
0383   417E C9          	ret
0384   417F             
0385   417F             
0386   417F             .call2: 
0387   417F             ; 2nd call: 
0388   417F CD DA 58    	call	MYSETSCR		; Set the screen mode
0389   4182 CD D7 43    	call	pegaWorkArea		; HL=IY=Work area pointer
0390   4185             
0391   4185 11 8F 59    	ld	de,strTitle		; prints the title 
0392   4188 CD 94 57    	call	printString
0393   418B             
0394   418B             
0395   418B             .sdhcinit: 	; FBLabs SDHC Interface initialization
0396   418B CD 22 42    	call	.printmode		; Print the switches configuration
0397   418E AF          	xor	a			; zera flags do cartao
0398   418F FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
0399   4192             
0400   4192 3E 01       	ld	a, 1			; detectar cartao 1
0401   4194 CD AD 41    	call	.detecta
0402   4197 3E 02       	ld	a, 2			; detectar cartao 2
0403   4199 CD AD 41    	call	.detecta
0404   419C 01 00 00    	ld	bc, 0
0405   419F 1E 05       	ld	e, 5
0406   41A1             
0407   41A1 CD 6D 59    	call	INSTR800HLP		; Install R800 data copy on workarea
0408   41A4             
0409   41A4 CD 1E 59    	call	INICHKSTOP		; Check if the STOP key was pressed
0410   41A7             
0411   41A7 11 5F 5A    	ld	de, strCrLf
0412   41AA C3 94 57    	jp	printString
0413   41AD             
0414   41AD             .detecta: 
0415   41AD FD 77 30    	ld	(iy+WRKAREA.NUMSD), a	; Save the requested card slot
0416   41B0 11 62 5A    	ld	de, strCartao
0417   41B3 CD 94 57    	call	printString
0418   41B6 FD 4E 30    	ld	c, (iy+WRKAREA.NUMSD)
0419   41B9 79          	ld	a,c
0420   41BA C6 30       	add	'0'
0421   41BC CD A2 00    	call	CHPUT
0422   41BF 3E 3A       	ld	a, ':'
0423   41C1 CD A2 00    	call	CHPUT
0424   41C4 3E 20       	ld	a, ' '
0425   41C6 CD A2 00    	call	CHPUT
0426   41C9 79          	ld	a,c			; Get card slot#
0427   41CA             ;	cpl				; invert bits
0428   41CA             ;	and	3
0429   41CA 32 00 7F    	ld	(SPICTRL), a		; Select card slot
0430   41CD 3A 00 7F    	ld	a, (SPISTATUS)		; get card slot status
0431   41D0 CD A4 45    	call	disableSDs
0432   41D3 E6 02       	and	SD_M_PRESENT		; Is there an card present?
0433   41D5 28 06       	jr	z,.naoVazio		; Yes, skip
0434   41D7 11 68 5A    	ld	de, strVazio		; Empty SD card slot message
0435   41DA C3 94 57    	jp	printString
0436   41DD             ;	jp	.marcaErro
0437   41DD             .naoVazio: 
0438   41DD CD 57 44    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0439   41E0 30 09       	jr	nc,.detectou
0440   41E2 CD A4 45    	call	disableSDs
0441   41E5 11 70 5A    	ld	de, strNaoIdentificado
0442   41E8 C3 94 57    	jp	printString
0443   41EB             ;.marcaErro:
0444   41EB             ;	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0445   41EB             .detectou: 
0446   41EB CD 2F 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0447   41EE DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0448   41F1 11 D8 5A    	ld	de, strSDV1	; e imprimir
0449   41F4 B7          	or	a
0450   41F5 28 03       	jr	z,.pula1
0451   41F7 11 E0 5A    	ld	de, strSDV2
0452   41FA             .pula1: 
0453   41FA CD 94 57    	call	printString
0454   41FD 3E 28       	ld	a,'('
0455   41FF CD A2 00    	call	CHPUT
0456   4202 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0457   4205 CD E1 57    	call	printDecToAscii	; Imprimir Manufacturer ID
0458   4208 3E 29       	ld	a,')'
0459   420A CD A2 00    	call	CHPUT
0460   420D 3E 20       	ld	a,' '
0461   420F CD A2 00    	call	CHPUT
0462   4212 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0463   4215 CD 0D 58    	call	pegaFabricante	; achar nome do fabricante
0464   4218 EB          	ex	de,hl
0465   4219 CD 94 57    	call	printString	; e imprimir
0466   421C 11 5F 5A    	ld	de,strCrLf
0467   421F C3 94 57    	jp	printString
0468   4222             
0469   4222             
0470   4222             .printmode: 		; Print the two switches configuration
0471   4222 AF          	xor	a			; 0=Interface status
0472   4223 32 00 7F    	ld	(SPICTRL),a
0473   4226 3A 00 7F    	ld	a, (SPISTATUS)		; Check if the mapper/megaRAM is active
0474   4229 E6 01       	and	IF_M_RAM		; Is the RAM enabled?
0475   422B 11 7B 5A    	ld	de,strMr_mp_desativada
0476   422E 28 0D       	jr	z,.print		; No, skip
0477   4230 3A 00 7F    	ld	a, (SPISTATUS)		; ativa, testar se eh mapper ou megaram
0478   4233 E6 02       	and	IF_M_DRVER
0479   4235 11 A3 5A    	ld	de,strDrvMain
0480   4238 20 03       	jr	nz,.print
0481   423A 11 BA 5A    	ld	de, strDrvDev
0482   423D             .print: 
0483   423D C3 94 57    	jp	printString
0484   4240             
0485   4240             ;-----------------------------------------------------------------------------
0486   4240             ;
0487   4240             ; Obtain driver version
0488   4240             ;
0489   4240             ; Input:  -
0490   4240             ; Output: A = Main version number
0491   4240             ;         B = Secondary version number
0492   4240             ;         C = Revision number
0493   4240             
0494   4240             DRV_VERSION: 
0495   4240 3E 01       	ld	a, VER_MAIN
0496   4242 06 00       	ld	b, VER_SEC
0497   4244 0E 08       	ld	c, VER_REV
0498   4246 C9          	ret
0499   4247             
0500   4247             
0501   4247             ;-----------------------------------------------------------------------------
0502   4247             ;
0503   4247             ; BASIC expanded statement ("CALL") handler.
0504   4247             ; Works the expected way, except that if invoking CALBAS is needed,
0505   4247             ; it must be done via the CALLB0 routine in kernel page 0.
0506   4247             
0507   4247             DRV_BASSTAT: 
0508   4247 37          	scf
0509   4248 C9          	ret
0510   4249             
0511   4249             
0512   4249             ;-----------------------------------------------------------------------------
0513   4249             ;
0514   4249             ; BASIC expanded device handler.
0515   4249             ; Works the expected way, except that if invoking CALBAS is needed,
0516   4249             ; it must be done via the CALLB0 routine in kernel page 0.
0517   4249             
0518   4249             DRV_BASDEV: 
0519   4249 37          	scf
0520   424A C9          	ret
0521   424B             
0522   424B             ;-----------------------------------------------------------------------------
0523   424B             ;
0524   424B             ; Extended BIOS hook.
0525   424B             ; Works the expected way, except that it must return
0526   424B             ; D'=1 if the old hook must be called, D'=0 otherwise.
0527   424B             ; It is entered with D'=1.
0528   424B             
0529   424B             DRV_EXTBIO: 
0530   424B C9          	ret
0531   424C             
0532   424C             ;-----------------------------------------------------------------------------
0533   424C             ;
0534   424C             ; Direct calls entry points.
0535   424C             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0536   424C             ; in kernel banks 0 and 3 will be redirected
0537   424C             ; to DIRECT0/1/2/3/4 respectively.
0538   424C             ; Receives all register data from the caller except IX and AF'.
0539   424C             
0540   424C             DRV_DIRECT0: 
0541   424C             DRV_DIRECT1: 
0542   424C             DRV_DIRECT2: 
0543   424C             DRV_DIRECT3: 
0544   424C             DRV_DIRECT4: 
0545   424C C9          	ret
0546   424D             
0547   424D             
0548   424D             ;=====
0549   424D             ;=====  BEGIN of DEVICE-BASED specific routines
0550   424D             ;=====
0551   424D             
0552   424D             ;-----------------------------------------------------------------------------
0553   424D             ;
0554   424D             ; Read or write logical sectors from/to a logical unit
0555   424D             ;
0556   424D             ;Input:    Cy=0 to read, 1 to write
0557   424D             ;          A = Device number, 1 to 7
0558   424D             ;          B = Number of sectors to read or write
0559   424D             ;          C = Logical unit number, 1 to 7
0560   424D             ;          HL = Source or destination memory address for the transfer
0561   424D             ;          DE = Address where the 4 byte sector number is stored.
0562   424D             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0563   424D             ;              0: Ok
0564   424D             ;              .IDEVL: Invalid device or LUN
0565   424D             ;              .NRDY: Not ready
0566   424D             ;              .DISK: General unknown disk error
0567   424D             ;              .DATA: CRC error when reading
0568   424D             ;              .RNF: Sector not found
0569   424D             ;              .UFORM: Unformatted disk
0570   424D             ;              .WPROT: Write protected media, or read-only logical unit
0571   424D             ;              .WRERR: Write error
0572   424D             ;              .NCOMP: Incompatible disk.
0573   424D             ;              .SEEK: Seek error.
0574   424D             ;          B = Number of sectors actually read (in case of error only)
0575   424D             
0576   424D             DEV_RW: 
0577   424D F5          	push	af
0578   424F BF FE 03    	cp	a, 3		; somente 2 dispositivos
0579   4251 30 1C       	jr	nc,.saicomerroidl
0580   4253 0D          	dec	c		; somente 1 logical unit
0581   4254 20 19       	jr	nz,.saicomerroidl
0582   4256 CD D7 43    	call	pegaWorkArea	; IY=Work area pointer
0583   4259 FD 77 30    	ld	(iy+WRKAREA.NUMSD),a
0584   425C FD 70 32    	ld	(iy+WRKAREA.NUMBLOCKS),b	; save the number of blocks to transfer 
0585   425F CD 46 46    	call	setaSDAtual
0586   4262 3A 00 7F    	ld	a,(SPISTATUS)	; Get this card slot status
0587   4265 E6 02       	and	SD_M_PRESENT	; Is ther a card present?
0588   4267 28 0C       	jr	z,.cardok	; Yes, skip
0589   4269 F1          	pop	af
0590   426A 3E FC       	ld	a, ENRDY	; Not ready
0591   426C 06 00       	ld	b, 0
0592   426E C9          	ret
0593   426F             .saicomerroidl: 
0594   426F F1          	pop	af
0595   4270 3E B5       	ld	a, EIDEVL	; error: Invalid device or LUN 
0596   4272 06 00       	ld	b, 0
0597   4274 C9          	ret
0598   4275             .cardok: 
0599   4275             ;	exx
0600   4275 D5 E5       	push	de,hl
0601   4277 CD 2F 44    	call	calculaCIDoffset	; ix=CID offset 
0602   427A DD 7E 0F    	ld	a,(ix+15)	; verificar se eh SDV1 ou SDV2
0603   427D DD 6F       	ld	ixl,a		; ixl=SDcard version
0604   427F E1 D1       	pop	hl,de
0605   4281 F1          	pop	af		; a=Device number, f=read/write flag 
0606   4282             ;	exx			; hl=Source/dest Address, de=Pointer to sect#
0607   4282             ;	ld	ixh, b 		; ixh=Number of blocks to transfer
0608   4282 38 1F       	jr	c,escrita	; Skip if it's a write operation 
0609   4284             leitura: 
0610   4284 1A          	ld	a, (de)		; 1. n. bloco
0611   4285 F5          	push	af
0612   4286 13          	inc	de
0613   4287 1A          	ld	a, (de)		; 2. n. bloco
0614   4288 F5          	push	af
0615   4289 13          	inc	de
0616   428A 1A          	ld	a, (de)		; 3. n. bloco
0617   428B 4F          	ld	c, a
0618   428C 13          	inc	de
0619   428D 1A          	ld	a, (de)		; 4. n. bloco
0620   428E 13          	inc	de
0621   428F 47          	ld	b, a
0622   4290 F1          	pop	af
0623   4291 57          	ld	d, a
0624   4292 F1          	pop	af		; HL = ponteiro destino
0625   4293 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0626   4294 CD 15 4F    	call	LerBloco	; chamar rotina de leitura de dados
0627   4297 30 08       	jr	nc,.ok
0628   4299 CD 18 44    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0629   429C             ;	ld	a, ENRDY	; Not ready
0630   429C 3E FD       	ld	a, EDISK	; General unknown disk error
0631   429E 06 00       	ld	b, 0		; informar que lemos 0 blocos
0632   42A0 C9          	ret
0633   42A1             .ok: 
0634   42A1 AF          	xor	a		; tudo OK, informar ao Nextor
0635   42A2 C9          	ret
0636   42A3             
0637   42A3             escrita: 
0638   42A3             	; Test if the card is write protected
0639   42A3 3A 00 7F    	ld	a,(SPISTATUS)	; Get this card slot status
0640   42A6 E6 04       	and	SD_M_WRTPROT	; Is the card write protected?
0641   42A8 28 05       	jr	z,.ok
0642   42AA 3E F8       	ld	a, EWPROT	; disco protegido
0643   42AC 06 00       	ld	b,0		; 0 blocks were written
0644   42AE C9          	ret
0645   42AF             .ok: 
0646   42AF 1A          	ld	a, (de)		; 1. n. bloco
0647   42B0 F5          	push	af
0648   42B1 13          	inc	de
0649   42B2 1A          	ld	a, (de)		; 2. n. bloco
0650   42B3 F5          	push	af
0651   42B4 13          	inc	de
0652   42B5 1A          	ld	a, (de)		; 3. n. bloco
0653   42B6 13          	inc	de
0654   42B7 4F          	ld	c, a
0655   42B8 1A          	ld	a, (de)		; 4. n. bloco
0656   42B9 13          	inc	de
0657   42BA 47          	ld	b, a
0658   42BB F1          	pop	af
0659   42BC 57          	ld	d, a
0660   42BD F1          	pop	af		; HL = ponteiro destino
0661   42BE 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0662   42BF CD 52 46    	call	GravarBloco	; chamar rotina de gravacao de dados
0663   42C2 30 09       	jr	nc,.ok2
0664   42C4             ;	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0665   42C4 FD 7E 32    	ld	a,(iy+WRKAREA.NUMBLOCKS) ; Get the number of requested blocks
0666   42C7 DD 94       	sub	ixh		; subtract the number of remaining blocks
0667   42C9 47          	ld	b,a		; b=number of blocks written
0668   42CA 3E FE       	ld	a,EWRERR	; Write error
0669   42CC C9          	ret
0670   42CD             .ok2: 
0671   42CD AF          	xor	a			; gravacao sem erros!
0672   42CE C9          	ret
0673   42CF             
0674   42CF             ;-----------------------------------------------------------------------------
0675   42CF             ;
0676   42CF             ; Device information gathering
0677   42CF             ;
0678   42CF             ;Input:   A = Device index, 1 to 7
0679   42CF             ;         B = Information to return:
0680   42CF             ;             0: Basic information
0681   42CF             ;             1: Manufacturer name string
0682   42CF             ;             2: Device name string
0683   42CF             ;             3: Serial number string
0684   42CF             ;         HL = Pointer to a buffer in RAM
0685   42CF             ;Output:  A = Error code:
0686   42CF             ;             0: Ok
0687   42CF             ;             1: Device not available or invalid device index
0688   42CF             ;             2: Information not available, or invalid information index
0689   42CF             ;         When basic information is requested,
0690   42CF             ;         buffer filled with the following information:
0691   42CF             ;
0692   42CF             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0693   42CF             ;        units (which is functionally equivalent to having only one).
0694   42CF             ;+1 (1): Device flags, always zero in Beta 2.
0695   42CF             ;
0696   42CF             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0697   42CF             ; left justified and padded with spaces. All the strings are optional,
0698   42CF             ; if not available, an error must be returned.
0699   42CF             ; If a string is provided by the device in binary format, it must be reported
0700   42CF             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0701   42CF             ; The maximum length for a string is 64 characters;
0702   42CF             ; if the string is actually longer, the leftmost 64 characters
0703   42CF             ; should be provided.
0704   42CF             ;
0705   42CF             ; In the case of the serial number string, the same rules for the strings
0706   42CF             ; apply, except that it must be provided right-justified,
0707   42CF             ; and if it is too long, the rightmost characters must be
0708   42CF             ; provided, not the leftmost.
0709   42CF             
0710   42CF             DEV_INFO: 
0711   42D0 BF FE 03    	cp	a,3		; somente 2 dispositivos
0712   42D2 38 03       	jr	c,.devok
0713   42D4 3E 01       	ld	a,1		; invalid device index
0714   42D6 C9          	ret
0715   42D7             .devok: 
0716   42D7 CD D7 43    	call	pegaWorkArea	; IY=Work area pointer
0717   42DA FD 77 30    	ld	(iy+WRKAREA.NUMSD),a
0718   42DD CD 46 46    	call	setaSDAtual
0719   42E0 04          	inc	b
0720   42E1 10 06       	djnz	.naoBasic
0721   42E3             
0722   42E3             ; Basic information:
0723   42E3 36 01       	ld	(hl), 1		; 1 logical unit somente
0724   42E5 23          	inc	hl
0725   42E6 AF          	xor	a
0726   42E7 77          	ld	(hl),a		; reservado, deve ser 0
0727   42E8 C9          	ret			; retorna com A=0 (OK)
0728   42E9             
0729   42E9             .naoBasic: 
0730   42E9 3E 02       	ld	a,2
0731   42EB             ;	ret	c		; No card present? Quit with info not available
0732   42EB             
0733   42EB E5          	push	hl
0734   42EC CD 2F 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0735   42EF E1          	pop	hl
0736   42F0 10 26       	djnz	.naoManuf
0737   42F2             ; Manufacturer Name:
0738   42F2 E5          	push	hl		; salva ponteiro do buffer
0739   42F3 06 40       	ld	b, 64		; preenche buffer com espaco
0740   42F5 3E 20       	ld	a, ' '
0741   42F7             .loop1: 
0742   42F7 77          	ld	(hl), a
0743   42F8 23          	inc	hl
0744   42F9 10 FC       	djnz	.loop1
0745   42FB D1          	pop	de		; recuperamos ponteiro do buffer em DE
0746   42FC 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0747   42FE 12          	ld	(de), a
0748   42FF 13          	inc	de
0749   4300 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0750   4303 CD 9D 57    	call	DecToAscii
0751   4306 3E 29       	ld	a, ')'
0752   4308 12          	ld	(de), a
0753   4309 13          	inc	de
0754   430A 3E 20       	ld	a, ' '
0755   430C 12          	ld	(de), a
0756   430D 13          	inc	de
0757   430E DD 7E 00    	ld	a, (ix)		; byte do fabricante
0758   4311 CD 0D 58    	call	pegaFabricante	; pegar nome do fabricante em HL
0759   4314 ED B0       	ldir			; e colocar no buffer
0760   4316 AF          	xor	a		; Return with A=0 (Ok)
0761   4317 C9          	ret
0762   4318             
0763   4318             .naoManuf: 
0764   4318 10 1A       	djnz	.naoProduct
0765   431A             ; Product Name:
0766   431A E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0767   431B DD E5       	push	ix
0768   431D E1          	pop	hl		; joga IX para HL
0769   431E 16 00       	ld	d, 0
0770   4320 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0771   4322 19          	add	hl, de
0772   4323 D1          	pop	de		; recupera buffer do Nextor em DE
0773   4324 01 05 00    	ld	bc, 5		; 5 caracteres
0774   4327 ED B0       	ldir			; copia nome do produto
0775   4329 EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0776   432A 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0777   432C 3E 20       	ld	a, ' '
0778   432E             .loop2: 
0779   432E 77          	ld	(hl), a
0780   432F 23          	inc	hl
0781   4330 10 FC       	djnz	.loop2
0782   4332 AF          	xor	a		; Return with A=0 (Ok)
0783   4333 C9          	ret
0784   4334             
0785   4334             .naoProduct: 
0786   4334             ; Serial Number:
0787   4334 36 30       	ld	(hl),'0'	; Coloca prefixo "0x"
0788   4336 23          	inc	hl
0789   4337 36 78       	ld	(hl), 'x'
0790   4339 23          	inc	hl
0791   433A E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0792   433B DD E5       	push	ix
0793   433D E1          	pop	hl		; joga IX para HL
0794   433E 16 00       	ld	d, 0
0795   4340 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0796   4342 19          	add	hl, de
0797   4343 D1          	pop	de		; recupera buffer do nextor em DE
0798   4344 06 04       	ld	b, 4		; 4 bytes do serial
0799   4346             .loop3: 
0800   4346 7E          	ld	a, (hl)
0801   4347 CD CD 57    	call	HexToAscii	; converter HEXA para ASCII
0802   434A 23          	inc	hl
0803   434B 10 F9       	djnz	.loop3
0804   434D 06 36       	ld	b, 54		; Coloca espaco no restante
0805   434F 3E 20       	ld	a, ' '
0806   4351             .loop4: 
0807   4351 12          	ld	(de), a
0808   4352 13          	inc	de
0809   4353 10 FC       	djnz	.loop4
0810   4355 AF          	xor	a		; Return with A=0 (Ok)
0811   4356 C9          	ret
0812   4357             
0813   4357             ;-----------------------------------------------------------------------------
0814   4357             ;
0815   4357             ; Obtain device status
0816   4357             ;
0817   4357             ;Input:   A = Device index, 1 to 7
0818   4357             ;         B = Logical unit number, 1 to 7
0819   4357             ;             0 to return the status of the device itself.
0820   4357             ;Output:  A = Status for the specified logical unit,
0821   4357             ;             or for the whole device if 0 was specified:
0822   4357             ;                0: The device or logical unit is not available, or the
0823   4357             ;                   device or logical unit number supplied is invalid.
0824   4357             ;                1: The device or logical unit is available and has not
0825   4357             ;                   changed since the last status request.
0826   4357             ;                2: The device or logical unit is available and has changed
0827   4357             ;                   since the last status request
0828   4357             ;                   (for devices, the device has been unplugged and a
0829   4357             ;                    different device has been plugged which has been
0830   4357             ;                    assigned the same device index; for logical units,
0831   4357             ;                    the media has been changed).
0832   4357             ;                3: The device or logical unit is available, but it is not
0833   4357             ;                   possible to determine whether it has been changed
0834   4357             ;                   or not since the last status request.
0835   4357             ;
0836   4357             ; Devices not supporting hot-plugging must always return status value 1.
0837   4357             ; Non removable logical units may return values 0 and 1.
0838   4357             ;
0839   4357             ; The returned status is always relative to the previous invokation of
0840   4357             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0841   4357             
0842   4357             DEV_STATUS: 
0843   4358 BF FE 03    	cp	a,3		; 2 dispositivos somente
0844   435A 30 39       	jr	nc,.saicomerro
0845   435C 05          	dec	b		; 1 logical unit somente
0846   435D 20 36       	jr	nz,.saicomerro
0847   435F             
0848   435F F5          	push	af
0849   4360 CD D7 43    	call	pegaWorkArea	; HL=IY=Work area pointer
0850   4363 F1          	pop	af
0851   4364 FD 77 30    	ld	(iy+WRKAREA.NUMSD),a	; salva numero do device atual (1 ou 2)
0852   4367 4F          	ld	c, a
0853   4368 32 00 7F    	ld	(SPICTRL), a	; selects SD
0854   436B 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta inserido
0855   436E CD A4 45    	call	disableSDs
0856   4371 E6 02       	and	$02
0857   4373 20 1D       	jr	nz,.cartaoComErro	; se slot do cartao estiver vazio, marcamos o erro nas flags
0858   4375 FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; testar bit de erro do cartao nas flags
0859   4378 A1          	and	c
0860   4379 28 14       	jr	z,.semMudanca	; cartao nao marcado com erro, pula
0861   437B CD 57 44    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0862   437E 38 12       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0863   4380 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)		; conseguimos detectar, tira erro nas flags
0864   4383 2F          	cpl			; inverte bits para fazer o AND
0865   4384 4F          	ld	c, a
0866   4385 FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)
0867   4388 A1          	and	c			; limpa bit
0868   4389 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
0869   438C             .comMudanca: 
0870   438C 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0871   438E C9          	ret
0872   438F             .semMudanca: 
0873   438F 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0874   4391 C9          	ret
0875   4392             .cartaoComErro: 
0876   4392 CD 18 44    	call	marcaErroCartao	; marcar erro do cartao nas flags
0877   4395             .saicomerro: 
0878   4395 3E 00       	ld	a, 0		; informa erro
0879   4397 C9          	ret
0880   4398             
0881   4398             ;-----------------------------------------------------------------------------
0882   4398             ;
0883   4398             ; Obtain logical unit information
0884   4398             ;
0885   4398             ;Input:   A  = Device index, 1 to 7
0886   4398             ;         B  = Logical unit number, 1 to 7
0887   4398             ;         HL = Pointer to buffer in RAM.
0888   4398             ;Output:  A = 0: Ok, buffer filled with information.
0889   4398             ;             1: Error, device or logical unit not available,
0890   4398             ;                or device index or logical unit number invalid.
0891   4398             ;         On success, buffer filled with the following information:
0892   4398             ;
0893   4398             ;+0 (1): Medium type:
0894   4398             ;        0: Block device
0895   4398             ;        1: CD or DVD reader or recorder
0896   4398             ;        2-254: Unused. Additional codes may be defined in the future.
0897   4398             ;        255: Other
0898   4398             ;+1 (2): Sector size, 0 if this information does not apply or is
0899   4398             ;        not available.
0900   4398             ;+3 (4): Total number of available sectors.
0901   4398             ;        0 if this information does not apply or is not available.
0902   4398             ;+7 (1): Flags:
0903   4398             ;        bit 0: 1 if the medium is removable.
0904   4398             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0905   4398             ;               be write protected or write enabled is not considered
0906   4398             ;               to be read-only.
0907   4398             ;        bit 2: 1 if the LUN is a floppy disk drive.
0908   4398             ;+8 (2): Number of cylinders
0909   4398             ;+10 (1): Number of heads
0910   4398             ;+11 (1): Number of sectors per track
0911   4398             ;
0912   4398             ; Number of cylinders, heads and sectors apply to hard disks only.
0913   4398             ; For other types of device, these fields must be zero.
0914   4398             
0915   4398             LUN_INFO: 
0916   4399 BF FE 03    	cp	a, 3		; somente 2 dispositivo
0917   439B 30 0A       	jr	nc,.saicomerro
0918   439D 05          	dec	b		; somente 1 logical unit
0919   439E 20 07       	jr	nz,.saicomerro
0920   43A0 E5          	push	hl
0921   43A1 CD EF 43    	call	testaCartao
0922   43A4 E1          	pop	hl
0923   43A5 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0924   43A7             .saicomerro: 
0925   43A7 3E 01       	ld	a, 1		; informar erro
0926   43A9 C9          	ret
0927   43AA             .ok: 
0928   43AA E5          	push	hl
0929   43AB CD 43 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0930   43AE E1          	pop	hl		; do cartao dependendo do cartao atual solicitado
0931   43AF AF          	xor	a
0932   43B0 77          	ld	(hl), a		; Informar que o dispositivo eh do tipo block device
0933   43B1 23          	inc	hl
0934   43B2 77          	ld	(hl), a		; tamanho de um bloco = 512 bytes (coloca $00, $02 que é $200 = 512)
0935   43B3 23          	inc	hl
0936   43B4 3E 02       	ld	a, 2
0937   43B6 77          	ld	(hl), a
0938   43B7 23          	inc	hl
0939   43B8 DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0940   43BB 77          	ld	(hl), a
0941   43BC 23          	inc	hl
0942   43BD DD 7E 01    	ld	a, (ix+1)
0943   43C0 77          	ld	(hl), a
0944   43C1 23          	inc	hl
0945   43C2 DD 7E 02    	ld	a, (ix+2)
0946   43C5 77          	ld	(hl), a
0947   43C6 23          	inc	hl
0948   43C7 AF          	xor	a		; cartoes SD tem total de blocos em 24 bits, mas o Nextor pede numero de
0949   43C8 77          	ld	(hl), a 	; 32 bits, entao coloca 0 no MSB
0950   43C9 23          	inc	hl
0951   43CA 3E 01       	ld	a, 1		; flags: dispositivo R/W removivel
0952   43CC 77          	ld	(hl), a
0953   43CD 23          	inc	hl
0954   43CE AF          	xor	a		; CHS = 0
0955   43CF 77          	ld	(hl), a
0956   43D0 23          	inc	hl
0957   43D1 77          	ld	(hl), a
0958   43D2 23          	inc	hl
0959   43D3 77          	ld	(hl), a
0960   43D4 23          	inc	hl
0961   43D5 AF          	xor	a		; informar que dados foram preenchidos
0962   43D6 C9          	ret
0963   43D7             
0964   43D7             ;=====
0965   43D7             ;=====  END of DEVICE-BASED specific routines
0966   43D7             ;=====
0967   43D7             
0968   43D7             ;------------------------------------------------
0969   43D7             ; Rotinas auxiliares
0970   43D7             ;------------------------------------------------
0971   43D7             
0972   43D7             ;------------------------------------------------
0973   43D7             ; Pedir ao Nextor o ponteiro de dados de trabalho
0974   43D7             ; na RAM e colocar em HL e IY
0975   43D7             ; Output: 
0976   43D7             ; IY = WorkArea pointer
0977   43D7             ; Modifies: IX
0978   43D7             ;------------------------------------------------
0979   43D7             pegaWorkArea: 
0980   43D7 F5 E5       	push	af,hl
0981   43D9 AF          	xor	a		; Pegar endereco da area de trabalho
0982   43DA 08          	ex	af,af'
0983   43DB AF          	xor	a
0984   43DC DD 21 45 40 	ld	ix, GWORK
0985   43E0 CD 42 40    	call	CALBNK
0986   43E3 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
0987   43E6 DD 66 01    	ld	h,(ix+1)
0988   43E9 E5          	push	hl
0989   43EA FD E1       	pop	iy		; em IY temos o mesmo ponteiro
0990   43EC E1 F1       	pop	hl,af
0991   43EE C9          	ret
0992   43EF             
0993   43EF             ;------------------------------------------------
0994   43EF             ; Testa se cartao esta inserido e/ou houve erro
0995   43EF             ; na ultima vez que foi acessado. Carry indica
0996   43EF             ; erro
0997   43EF             ; Destroi AF, HL, IX, C
0998   43EF             ;------------------------------------------------
0999   43EF             testaCartao: 
1000   43EF F5          	push	af
1001   43F0 CD D7 43    	call	pegaWorkArea	; HL=IY=Work area pointer
1002   43F3 F1          	pop	af
1003   43F4 FD 77 30    	ld	(iy+WRKAREA.NUMSD), a	; salva numero do device atual (1 ou 2)
1004   43F7 4F          	ld	c, a
1005   43F8 32 00 7F    	ld	(SPICTRL), a	; Selects SD
1006   43FB 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta inserido
1007   43FE CD A4 45    	call	disableSDs
1008   4401 E6 02       	and	$02
1009   4403 20 0A       	jr	nz,.saicomerro				
1010   4405 FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; testar bit de erro do cartao nas flags
1011   4408 A1          	and	c
1012   4409 28 02       	jr	z,.ok
1013   440B 37          	scf			; indica erro
1014   440C C9          	ret
1015   440D             .ok: 
1016   440D AF          	xor	a		; zera carry indicando sem erro
1017   440E C9          	ret
1018   440F             .saicomerro: 
1019   440F FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; marca bit de erro nas flags
1020   4412 B1          	or	c
1021   4413 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1022   4416 37          	scf
1023   4417 C9          	ret
1024   4418             
1025   4418             ;------------------------------------------------
1026   4418             ; Marcar bit de erro nas flags
1027   4418             ; Destroi AF, C
1028   4418             ;------------------------------------------------
1029   4418             marcaErroCartao: 
1030   4418 FD 4E 30    	ld	c, (iy+WRKAREA.NUMSD)		; cartao atual (1 ou 2)
1031   441B FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; marcar erro
1032   441E B1          	or	c
1033   441F FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1034   4422 C9          	ret
1035   4423             
1036   4423             ;------------------------------------------------
1037   4423             ; Testar se cartao atual esta protegido contra
1038   4423             ; gravacao, A=0 se protegido
1039   4423             ; Destroi AF, C
1040   4423             ;------------------------------------------------
1041   4423             testaWP: 
1042   4423 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; cartao atual (1 ou 2)
1043   4426 32 00 7F    	ld	(SPICTRL), a
1044   4429 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta protegido
1045   442C             ;	call	disableSDs
1046   442C E6 04       	and	$04
1047   442E C9          	ret			; se A for 0 cartao esta protegido
1048   442F             
1049   442F             ;------------------------------------------------
1050   442F             ; Calcula offset do buffer na RAM em HL e IX para
1051   442F             ; os dados do CID dependendo do cartao atual
1052   442F             ; Destroi AF, DE, HL e IX
1053   442F             ;------------------------------------------------
1054   442F             calculaCIDoffset: 
1055   442F FD E5       	push	iy		; copiamos IY para HL
1056   4431 E1          	pop	hl
1057   4432 16 00       	ld	d, 0
1058   4434 1E 10       	ld	e, WRKAREA.BCID1	; DE aponta para buffer BCID1
1059   4436 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; vamos fazer IX apontar para o buffer correto
1060   4439 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1061   443A 28 02       	jr	z,.c1
1062   443C 1E 20       	ld	e, WRKAREA.BCID2	; DE aponta para buffer BCID2
1063   443E             .c1: 
1064   443E 19          	add	hl, de		; HL aponta para buffer correto
1065   443F E5          	push	hl		
1066   4440 DD E1       	pop	ix		; vamos colocar HL em IX
1067   4442 C9          	ret
1068   4443             
1069   4443             ;------------------------------------------------
1070   4443             ; Calcula offset do buffer na RAM para os dados
1071   4443             ; do total de blocos dependendo do cartao atual
1072   4443             ; Offset fica em HL e IX
1073   4443             ; Destroi AF, DE, HL e IX
1074   4443             ;------------------------------------------------
1075   4443             calculaBLOCOSoffset: 
1076   4443 FD E5       	push	iy		; copiamos IY para HL
1077   4445 E1          	pop	hl
1078   4446 16 00       	ld	d, 0
1079   4448 1E 33       	ld	e, WRKAREA.BLOCKS1	; DE aponta para buffer BLOCKS1
1080   444A FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; Vamos fazer IX apontar para o buffer correto
1081   444D 3D          	dec	a		; dependendo do cartao: BLOCKS1 ou BLOCKS2
1082   444E 28 02       	jr	z,.c1
1083   4450 1E 36       	ld	e, WRKAREA.BLOCKS2	; DE aponta para buffer BLOCKS2
1084   4452             .c1: 
1085   4452 19          	add	hl, de		; HL aponta para buffer correto
1086   4453 E5          	push	hl		
1087   4454 DD E1       	pop	ix		; Vamos colocar HL em IX
1088   4456 C9          	ret
1089   4457             
1090   4457             
1091   4457             ;------------------------------------------------
1092   4457             ; Minhas funcoes para cartao SD
1093   4457             ;------------------------------------------------
1094   4457             
1095   4457             ;------------------------------------------------
1096   4457             ; Processo de inicializacao e deteccao do cartao.
1097   4457             ; Detecta se cartao responde, qual versao (SDV1
1098   4457             ; ou SDV2), faz a leitura do CSD e CID e calcula
1099   4457             ; o numero de blocos do cartao, colocando o CID
1100   4457             ; e total de blocos no buffer correto dependendo
1101   4457             ; do cartao 1 ou 2.
1102   4457             ; Retorna erro no carry. Se for 0 indica deteccao
1103   4457             ; com sucesso.
1104   4457             ; Destroi todos os registradores
1105   4457             ;------------------------------------------------
1106   4457             detectaCartao: 
1107   4457 CD 85 45    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1108   445A D8          	ret	c			; retorna se erro
1109   445B CD 26 45    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1110   445E D8          	ret	c
1111   445F FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1112   4461 E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1113   4462 3E 49       	ld	a, CMD9		; ler CSD
1114   4464 CD 47 45    	call	lerBlocoCxD
1115   4467 D8          	ret	c
1116   4468 CD 2F 44    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1117   446B 3E 4A       	ld	a, CMD10	; ler CID
1118   446D CD 47 45    	call	lerBlocoCxD
1119   4470 D8          	ret	c
1120   4471 3E 7A       	ld	a, CMD58	; ler OCR
1121   4473 11 00 00    	ld	de, 0
1122   4476 CD D5 45    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1123   4479 D8          	ret	c
1124   447A 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1125   447B E6 40       	and	$40
1126   447D DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1127   4480 CC 1B 45    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1128   4483 D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1129   4484 CD A4 45    	call	disableSDs
1130   4487             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1131   4487 CD 43 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1132   448A FD E5       	push	iy		; copiamos IY para HL
1133   448C E1          	pop	hl
1134   448D 16 00       	ld	d, 0
1135   448F 1E 05       	ld	e, WRKAREA.BCSD+5
1136   4491 19          	add	hl, de		; HL aponta para buffer BCSD+5
1137   4492 FD 7E 00    	ld	a, (iy+WRKAREA.BCSD)
1138   4495 E6 C0       	and	$C0		; testa versao do registro CSD
1139   4497 28 06       	jr	z,.calculaCSD1
1140   4499 FE 40       	cp	$40
1141   449B 28 54       	jr	z,.calculaCSD2
1142   449D 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1143   449E C9          	ret
1144   449F             
1145   449F             ; -----------------------------------
1146   449F             ; Registro CSD versao 1, calcular da
1147   449F             ; maneira correta para a versao 1
1148   449F             ; -----------------------------------
1149   449F             .calculaCSD1: 
1150   449F 7E          	ld	a, (hl)
1151   44A0 E6 0F       	and	$0F		; isola READ_BL_LEN
1152   44A2 F5          	push	af
1153   44A3 23          	inc	hl
1154   44A4 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1155   44A5 E6 03       	and	3
1156   44A7 57          	ld	d, a
1157   44A8 23          	inc	hl
1158   44A9 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1159   44AA 23          	inc	hl
1160   44AB 7E          	ld	a, (hl)
1161   44AC E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1162   44AE 87          	add	a, a		; rotaciona a esquerda
1163   44AF CB 13       	rl	e		; rotaciona para DE
1164   44B1 CB 12       	rl	d
1165   44B3 87          	add	a, a		; mais uma rotacao
1166   44B4 CB 13       	rl	e		; rotaciona para DE
1167   44B6 CB 12       	rl	d
1168   44B8 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1169   44B9 23          	inc	hl
1170   44BA 7E          	ld	a, (hl)		; proximo byte
1171   44BB E6 03       	and	3		; 2 bits de C_SIZE_MUL
1172   44BD 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1173   44BE 23          	inc	hl						
1174   44BF 7E          	ld	a, (hl)		; proximo byte
1175   44C0 E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1176   44C2 87          	add	a, a		; rotaciona para esquerda jogando no carry
1177   44C3 CB 10       	rl	b		; rotaciona para B
1178   44C5 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1179   44C6 04          	inc	b		; faz B = C_SIZE_MUL + 2
1180   44C7 F1          	pop	af		; volta em A o READ_BL_LEN
1181   44C8 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1182   44C9 01 00 00    	ld	bc, 0
1183   44CC CD E5 44    	call	.eleva2
1184   44CF 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1185   44D0 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1186   44D1 48          	ld	c, b
1187   44D2 06 00       	ld	b, 0
1188   44D4 CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1189   44D6 CB 1A       	rr	d		; rotacionamos D e E
1190   44D8 CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1191   44DA             .salvaBlocos: 
1192   44DA DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1193   44DD DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1194   44E0 DD 73 00    	ld	(ix), e
1195   44E3 AF          	xor	a		; limpa carry
1196   44E4 C9          	ret
1197   44E5             
1198   44E5             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1199   44E5             				; BC = 0
1200   44E5             				; DE = C_SIZE
1201   44E5 CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1202   44E7 CB 12       	rl	d
1203   44E9 CB 11       	rl	c
1204   44EB CB 10       	rl	b
1205   44ED 3D          	dec	a		; subtraimos 1
1206   44EE 20 F5       	jr	nz,.eleva2
1207   44F0 C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1208   44F1             
1209   44F1             ; -----------------------------------
1210   44F1             ; Registro CSD versao 2, calcular da
1211   44F1             ; maneira correta para a versao 2
1212   44F1             ; -----------------------------------
1213   44F1             .calculaCSD2: 
1214   44F1 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1215   44F2 23          	inc	hl
1216   44F3 7E          	ld	a, (hl)
1217   44F4 E6 3F       	and	$3F
1218   44F6 4F          	ld	c, a
1219   44F7 23          	inc	hl
1220   44F8 56          	ld	d, (hl)
1221   44F9 23          	inc	hl
1222   44FA 5E          	ld	e, (hl)
1223   44FB CD 07 45    	call	.inc32		; soma 1
1224   44FE CD 0F 45    	call	.desloca32	; multiplica por 512
1225   4501 CD 14 45    	call	.rotaciona24	; multiplica por 2
1226   4504 C3 DA 44    	jp		.salvaBlocos
1227   4507             
1228   4507             .inc32: 
1229   4507 1C          	inc	e
1230   4508 C0          	ret	nz
1231   4509 14          	inc	d
1232   450A C0          	ret	nz
1233   450B 0C          	inc	c
1234   450C C0          	ret	nz
1235   450D 04          	inc	b
1236   450E C9          	ret
1237   450F             
1238   450F             .desloca32: 
1239   450F 41          	ld	b, c
1240   4510 4A          	ld	c, d
1241   4511 53          	ld	d, e
1242   4512 1E 00       	ld	e, 0
1243   4514             .rotaciona24: 
1244   4514 CB 22       	sla	d
1245   4516 CB 11       	rl	c
1246   4518 CB 10       	rl	b
1247   451A C9          	ret
1248   451B             
1249   451B             ; ------------------------------------------------
1250   451B             ; Setar o tamanho do bloco para 512 se o cartao
1251   451B             ; for SDV1
1252   451B             ; ------------------------------------------------
1253   451B             mudarTamanhoBlocoPara512: 
1254   451B 3E 50       	ld	a, CMD16
1255   451D 01 00 00    	ld	bc, 0
1256   4520 11 00 02    	ld	de, 512
1257   4523 C3 C0 45    	jp	SD_SEND_CMD_GET_ERROR
1258   4526             
1259   4526             ; ------------------------------------------------
1260   4526             ; Tenta inicializar um cartao SDV2, se houver erro
1261   4526             ; o cartao deve ser SDV1
1262   4526             ; ------------------------------------------------
1263   4526             testaSDCV2: 
1264   4526 3E 48       	ld	a, CMD8
1265   4528 11 AA 01    	ld	de, $1AA
1266   452B CD D5 45    	call	SD_SEND_CMD_2_ARGS_GET_R3
1267   452E 21 B9 45    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1268   4531 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1269   4533 21 AB 45    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1270   4536             .pula: 
1271   4536 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1272   4539             .loop: 
1273   4539 C5          	push	bc
1274   453A CD 46 45    	call	.jumpHL		; chamar rotina correta em HL
1275   453D C1          	pop	bc
1276   453E D0          	ret	nc
1277   453F 10 F8       	djnz	.loop
1278   4541 0D          	dec	c
1279   4542 20 F5       	jr	nz,.loop
1280   4544 37          	scf
1281   4545 C9          	ret
1282   4546             .jumpHL: 
1283   4546 E9          	jp	(hl)		; chamar rotina correta em HL
1284   4547             
1285   4547             ; ------------------------------------------------
1286   4547             ; Ler registro CID ou CSD, o comando vem em A
1287   4547             ; ------------------------------------------------
1288   4547             lerBlocoCxD: 
1289   4547 CD BB 45    	call	SD_SEND_CMD_NO_ARGS
1290   454A D8          	ret	c
1291   454B CD 1A 46    	call	WAIT_RESP_FE
1292   454E D8          	ret	c
1293   454F EB          	ex	de,hl
1294   4550             
1295   4550             	; Check for a Z80 or R800
1296   4550             ;	or 	a		; Clear Cy
1297   4550 3E 14       	ld	a,20
1298   4552 ED F9       	db	#ED,#F9		; mulub a,a
1299   4554 21 00 7B    	ld	hl, SPIDATA
1300   4557 38 25       	jr	c,.r800		; Use LDIR for R800
1301   4559 ED A0       > ldi	
1301   455B ED A0       > ldi	
1301   455D ED A0       > ldi	
1301   455F ED A0       > ldi	
1301   4561 ED A0       > ldi	
1301   4563 ED A0       > ldi	
1301   4565 ED A0       > ldi	
1301   4567 ED A0       > ldi	
1301   4569 ED A0       > ldi	
1301   456B ED A0       > ldi	
1301   456D ED A0       > ldi	
1301   456F ED A0       > ldi	
1301   4571 ED A0       > ldi	
1301   4573 ED A0       > ldi	
1301   4575 ED A0       > ldi	
1301   4577 ED A0       > ldi	
1302   4579             .end
1303   4579 7E           	ld	a, (hl)
1304   457A 7E          	ld	a, (hl)		; byte de resposta
1305   457B B7          	or	a
1306   457C EB          	ex	de,hl
1307   457D             ;	jr	disableSDs
1308   457D C9          	ret
1309   457E             
1310   457E             .r800: 
1311   457E 01 10 00    	ld	bc,16
1312   4581 ED B0       	ldir
1313   4583 18 F4       	jr	.end
1314   4585             
1315   4585             ; ------------------------------------------------
1316   4585             ; Algoritmo para inicializar um cartao SD
1317   4585             ; Destroi AF, B, DE
1318   4585             ; ------------------------------------------------
1319   4585             iniciaSD: 
1320   4585 CD A4 45    	call	disableSDs
1321   4588             
1322   4588 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1323   458A             enviaClocksInicio: 
1324   458A 3E FF       	ld	a, $FF		; manter MOSI em 1
1325   458C 32 00 7B    	ld	(SPIDATA), a
1326   458F 10 F9       	djnz	enviaClocksInicio
1327   4591 CD 46 46    	call	setaSDAtual	; ativar cartao atual
1328   4594 06 08       	ld	b, 8		; 8 tentativas para CMD0
1329   4596             SD_SEND_CMD0: 
1330   4596 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1331   4598 11 00 00    	ld	de, 0
1332   459B C5          	push	bc
1333   459C CD C8 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1334   459F C1          	pop	bc
1335   45A0 D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1336   45A1 10 F3       	djnz	SD_SEND_CMD0
1337   45A3 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1338   45A4             	; fall throw
1339   45A4             
1340   45A4             ; ------------------------------------------------
1341   45A4             ; Desabilitar (de-selecionar) todos os cartoes
1342   45A4             ; Nao destroi registradores
1343   45A4             ; ------------------------------------------------
1344   45A4             disableSDs: 
1345   45A4 F5          	push	af
1346   45A5 AF          	xor	a
1347   45A6 32 00 7F    	ld	(SPICTRL), a
1348   45A9 F1          	pop	af
1349   45AA C9          	ret
1350   45AB             
1351   45AB             ; ------------------------------------------------
1352   45AB             ; Enviar comando ACMD41
1353   45AB             ; ------------------------------------------------
1354   45AB             SD_SEND_ACMD41: 
1355   45AB 3E 77       	ld	a, CMD55
1356   45AD CD BB 45    	call	SD_SEND_CMD_NO_ARGS
1357   45B0 3E 69       	ld	a, ACMD41
1358   45B2 01 00 40    	ld	bc, $4000
1359   45B5 51          	ld	d, c
1360   45B6 59          	ld	e, c
1361   45B7 18 07       	jr		SD_SEND_CMD_GET_ERROR
1362   45B9             
1363   45B9             ; ------------------------------------------------
1364   45B9             ; Enviar CMD1 para cartao. Carry indica erro
1365   45B9             ; Destroi AF, BC, DE
1366   45B9             ; ------------------------------------------------
1367   45B9             SD_SEND_CMD1: 
1368   45B9 3E 41       	ld	a, CMD1
1369   45BB             SD_SEND_CMD_NO_ARGS: 
1370   45BB 01 00 00    	ld	bc, 0
1371   45BE 50          	ld	d, b
1372   45BF 59          	ld	e, c
1373   45C0             SD_SEND_CMD_GET_ERROR: 
1374   45C0 CD EE 45    	call	SD_SEND_CMD
1375   45C3 B7          	or	a
1376   45C4 C8          	ret	z			; se A=0 nao houve erro, retornar
1377   45C5             	; fall throw
1378   45C5             
1379   45C5             ; ------------------------------------------------
1380   45C5             ; Informar erro
1381   45C5             ; Nao destroi registradores
1382   45C5             ; ------------------------------------------------
1383   45C5             setaErro: 
1384   45C5 37          	scf
1385   45C6 18 DC       	jr		disableSDs
1386   45C8             
1387   45C8             ; ------------------------------------------------
1388   45C8             ; Enviar comando em A com 2 bytes de parametros
1389   45C8             ; em DE e testar retorno BUSY
1390   45C8             ; Retorna em A a resposta do cartao
1391   45C8             ; Destroi AF, BC
1392   45C8             ; ------------------------------------------------
1393   45C8             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1394   45C8 01 00 00    	ld	bc, 0
1395   45CB CD EE 45    	call	SD_SEND_CMD
1396   45CE 47          	ld	b, a
1397   45CF E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1398   45D1 78          	ld	a, b
1399   45D2 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1400   45D4 C9          	ret			; sem erros
1401   45D5             
1402   45D5             ; ------------------------------------------------
1403   45D5             ; Enviar comando em A com 2 bytes de parametros
1404   45D5             ; em DE e ler resposta do tipo R3 em BC DE
1405   45D5             ; Retorna em A a resposta do cartao
1406   45D5             ; Destroi AF, BC, DE, HL
1407   45D5             ; ------------------------------------------------
1408   45D5             SD_SEND_CMD_2_ARGS_GET_R3: 
1409   45D5 CD C8 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1410   45D8 D8          	ret	c
1411   45D9 F5          	push	af
1412   45DA CD 28 46    	call	WAIT_RESP_NO_FF
1413   45DD 67          	ld	h, a
1414   45DE CD 28 46    	call	WAIT_RESP_NO_FF
1415   45E1 6F          	ld	l, a
1416   45E2 CD 28 46    	call	WAIT_RESP_NO_FF
1417   45E5 57          	ld	d, a
1418   45E6 CD 28 46    	call	WAIT_RESP_NO_FF
1419   45E9 5F          	ld	e, a
1420   45EA 44          	ld	b, h
1421   45EB 4D          	ld	c, l
1422   45EC F1          	pop	af
1423   45ED C9          	ret
1424   45EE             
1425   45EE             ; ------------------------------------------------
1426   45EE             ; Enviar comando em A com 4 bytes de parametros
1427   45EE             ; em BC DE e enviar CRC correto se for CMD0 ou 
1428   45EE             ; CMD8 e aguardar processamento do cartao
1429   45EE             ; Output  : A=0 if there was no error
1430   45EE             ; Modifies:  AF, B, AF'
1431   45EE             ; ------------------------------------------------
1432   45EE             SD_SEND_CMD: 
1433   45EE CD 46 46    	call	setaSDAtual
1434   45F1 32 00 7B    	ld	(SPIDATA), a
1435   45F4 F5          	push	af
1436   45F5 78          	ld	a, b
1437   45F6 32 00 7B    	ld	(SPIDATA), a
1438   45F9 79          	ld	a, c
1439   45FA 32 00 7B    	ld	(SPIDATA), a
1440   45FD 7A          	ld	a, d
1441   45FE 32 00 7B    	ld	(SPIDATA), a
1442   4601 7B          	ld	a, e
1443   4602 32 00 7B    	ld	(SPIDATA), a
1444   4605 F1          	pop	af
1445   4606 FE 40       	cp	CMD0
1446   4608 06 95       	ld	b, $95		; CRC para CMD0
1447   460A 28 08       	jr	z,enviaCRC
1448   460C FE 48       	cp	CMD8
1449   460E 06 87       	ld	b, $87		; CRC para CMD8
1450   4610 28 02       	jr	z,enviaCRC
1451   4612 06 FF       	ld	b, $FF		; CRC dummy
1452   4614             enviaCRC: 
1453   4614 78          	ld	a, b
1454   4615 32 00 7B    	ld	(SPIDATA), a
1455   4618 18 0E       	jr	WAIT_RESP_NO_FF
1456   461A             
1457   461A             ; ------------------------------------------------
1458   461A             ; Esperar que resposta do cartao seja $FE
1459   461A             ; Destroi AF, B
1460   461A             ; ------------------------------------------------
1461   461A             WAIT_RESP_FE: 
1462   461A 06 0A       	ld	b, 10		; 10 tentativas
1463   461C             .loop: 
1464   461C C5          	push	bc
1465   461D CD 28 46    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1466   4620 C1          	pop	bc
1467   4621 FE FE       	cp	$FE		; resposta é $FE ?
1468   4623 C8          	ret	z		; sim, retornamos com carry=0
1469   4624 10 F6       	djnz	.loop
1470   4626 37          	scf			; erro, carry=1
1471   4627 C9          	ret
1472   4628             
1473   4628             ; ------------------------------------------------
1474   4628             ; Esperar que resposta do cartao seja diferente
1475   4628             ; de $FF
1476   4628             ; Destroi AF, BC
1477   4628             ; ------------------------------------------------
1478   4628             WAIT_RESP_NO_FF: 
1479   4628 01 01 00    	ld	bc, 1		; 256 tentativas
1480   462B             .loop: 
1481   462B 3A 00 7B    	ld	a, (SPIDATA)
1482   462E FE FF       	cp	$FF		; testa $FF
1483   4630 C0          	ret		nz		; sai se nao for $FF
1484   4631 10 F8       	djnz	.loop
1485   4633 0D          	dec	c
1486   4634 20 F5       	jr	nz,.loop
1487   4636 C9          	ret
1488   4637             
1489   4637             ; ------------------------------------------------
1490   4637             ; Esperar que resposta do cartao seja diferente
1491   4637             ; de $00
1492   4637             ; Destroi A, BC
1493   4637             ; ------------------------------------------------
1494   4637             WAIT_RESP_NO_00: 
1495   4637 01 80 00    	ld	bc, 128		; 32768 tentativas
1496   463A             .loop: 
1497   463A 3A 00 7B    	ld	a, (SPIDATA)
1498   463D B7          	or	a
1499   463E C0          	ret	nz			; se resposta for <> $00, sai
1500   463F 10 F9       	djnz	.loop
1501   4641 0D          	dec	c
1502   4642 20 F6       	jr	nz,.loop
1503   4644 37          	scf			; erro
1504   4645 C9          	ret
1505   4646             
1506   4646             ; ------------------------------------------------
1507   4646             ; Sets the requested card slot and check its status
1508   4646             ; In case it detects that the card was changed, it will call the detection
1509   4646             ; routine to re-dectect the card type
1510   4646             ; Input: Target card slot
1511   4646             ; Output: Cy = No SD card is present
1512   4646             ;         A: 0=The same card is still present
1513   4646             ;            1=The card was changed since the last check
1514   4646             ; ------------------------------------------------
1515   4646             setaSDAtual: 
1516   4646 F5          	push	af
1517   4647 3A 00 7B    	ld	a, (SPIDATA)	; dummy read
1518   464A FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)
1519   464D 32 00 7F    	ld	(SPICTRL), a
1520   4650 F1          	pop	af
1521   4651 C9          	ret
1522   4652             
1523   4652              IFDEF BLA
1524   4652~            	ld	a, (SPIDATA)	; dummy read
1525   4652~            	ld	a, (iy+WRKAREA.NUMSD)
1526   4652~            ;	cpl			; invert bits
1527   4652~            ;	and	3
1528   4652~            	ld	(SPICTRL), a
1529   4652~            	;
1530   4652~            	ld	a,(SPISTATUS)	; Get this card slot status
1531   4652~            	bit	SD_PRESENT,a	; Is there a card present?
1532   4652~            	scf
1533   4652~            	ret	nz		; No, return with error
1534   4652~            1535   4652~            	; ***Workaround for the problem that Nextor doesn't call DEV_STATUS to
1536   4652~            	; check if the media has changed before every disk operation, so we
1537   4652~            	; need to always check if it changed.
1538   4652~            	and	SD_M_DSKCHG	; Was the card changed since last checked?
1539   4652~            	ret	z		; No, return
1540   4652~            	push	bc,de,hl,ix
1541   4652~            	call	detectaCartao	; Detect the new card
1542   4652~            	pop	ix,hl,de,bc
1543   4652~            	ret	c		; Error? Then return
1544   4652~            	ld	a,1
1545   4652~            	ret
1546   4652              ENDIF ; BLA
1547   4652             
1548   4652             ; ------------------------------------------------
1549   4652             ; Grava um bloco de 512 bytes no cartao
1550   4652             ; HL = aponta para o inicio dos dados
1551   4652             ; BC:DE = contem o numero do bloco (BCDE = 32 bits)
1552   4652             ; IXH = Number of blocks
1553   4652             ; IXL = SDcard version (0 or 1)
1554   4652             ; Modifies:  AF, BC, DE, HL, IXL
1555   4652             ; ------------------------------------------------
1556   4652             GravarBloco: 
1557   4652 DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1558   4655 B7          	or	a
1559   4656 CC 88 57    	call	z,blocoParaByte		; se for SDV1 coverter blocos para bytes
1560   4659             ;	call	setaSDAtual	; selecionar cartao atual
1561   4659 FD 7E 32    	ld	a, (iy+WRKAREA.NUMBLOCKS)	; testar se Nextor quer gravar 1 ou mais blocos
1562   465C 3D          	dec	a
1563   465D CA DA 4A    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1564   4660             
1565   4660             ; multiplos blocos
1566   4660 C5          	push	bc
1567   4661 D5          	push	de
1568   4662 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1569   4664 CD BB 45    	call	SD_SEND_CMD_NO_ARGS
1570   4667 3E 57       	ld	a, ACMD23
1571   4669 01 00 00    	ld	bc, 0
1572   466C 51          	ld	d, c
1573   466D FD 5E 32    	ld	e, (iy+WRKAREA.NUMBLOCKS)	; parametro = total de blocos a gravar
1574   4670 CD C0 45    	call	SD_SEND_CMD_GET_ERROR
1575   4673 D1          	pop	de
1576   4674 C1          	pop	bc
1577   4675 DA 11 4F    	jp	c,terminaLeituraEscritaBloco	; erro no ACMD23
1578   4678 3E 59       	ld	a, CMD25	; comando CMD25 = write multiple blocks
1579   467A CD C0 45    	call	SD_SEND_CMD_GET_ERROR
1580   467D DA 11 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1581   4680             .loop: 
1582   4680 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados sao
1583   4682 32 00 7B    	ld	(SPIDATA),a	; dados para gravacao
1584   4685             	; Check for a Z80 or R800
1585   4685 EB          	ex	de,hl
1586   4686             ;	or 	a		; Clear Cy
1587   4686 3E 14       	ld	a,20
1588   4688 ED F9       	db	#ED,#F9		; mulub a,a
1589   468A EB          	ex	de,hl
1590   468B 11 00 7B    	ld	de, SPIDATA
1591   468E DA CB 4A    	jp	c,.r800m	; Use LDIR for R800
1592   4691 ED A0       > ldi		
1592   4693 ED A0       > ldi		
1592   4695 ED A0       > ldi		
1592   4697 ED A0       > ldi		
1592   4699 ED A0       > ldi		
1592   469B ED A0       > ldi		
1592   469D ED A0       > ldi		
1592   469F ED A0       > ldi		
1592   46A1 ED A0       > ldi		
1592   46A3 ED A0       > ldi		
1592   46A5 ED A0       > ldi		
1592   46A7 ED A0       > ldi		
1592   46A9 ED A0       > ldi		
1592   46AB ED A0       > ldi		
1592   46AD ED A0       > ldi		
1592   46AF ED A0       > ldi		
1592   46B1 ED A0       > ldi		
1592   46B3 ED A0       > ldi		
1592   46B5 ED A0       > ldi		
1592   46B7 ED A0       > ldi		
1592   46B9 ED A0       > ldi		
1592   46BB ED A0       > ldi		
1592   46BD ED A0       > ldi		
1592   46BF ED A0       > ldi		
1592   46C1 ED A0       > ldi		
1592   46C3 ED A0       > ldi		
1592   46C5 ED A0       > ldi		
1592   46C7 ED A0       > ldi		
1592   46C9 ED A0       > ldi		
1592   46CB ED A0       > ldi		
1592   46CD ED A0       > ldi		
1592   46CF ED A0       > ldi		
1592   46D1 ED A0       > ldi		
1592   46D3 ED A0       > ldi		
1592   46D5 ED A0       > ldi		
1592   46D7 ED A0       > ldi		
1592   46D9 ED A0       > ldi		
1592   46DB ED A0       > ldi		
1592   46DD ED A0       > ldi		
1592   46DF ED A0       > ldi		
1592   46E1 ED A0       > ldi		
1592   46E3 ED A0       > ldi		
1592   46E5 ED A0       > ldi		
1592   46E7 ED A0       > ldi		
1592   46E9 ED A0       > ldi		
1592   46EB ED A0       > ldi		
1592   46ED ED A0       > ldi		
1592   46EF ED A0       > ldi		
1592   46F1 ED A0       > ldi		
1592   46F3 ED A0       > ldi		
1592   46F5 ED A0       > ldi		
1592   46F7 ED A0       > ldi		
1592   46F9 ED A0       > ldi		
1592   46FB ED A0       > ldi		
1592   46FD ED A0       > ldi		
1592   46FF ED A0       > ldi		
1592   4701 ED A0       > ldi		
1592   4703 ED A0       > ldi		
1592   4705 ED A0       > ldi		
1592   4707 ED A0       > ldi		
1592   4709 ED A0       > ldi		
1592   470B ED A0       > ldi		
1592   470D ED A0       > ldi		
1592   470F ED A0       > ldi		
1592   4711 ED A0       > ldi		
1592   4713 ED A0       > ldi		
1592   4715 ED A0       > ldi		
1592   4717 ED A0       > ldi		
1592   4719 ED A0       > ldi		
1592   471B ED A0       > ldi		
1592   471D ED A0       > ldi		
1592   471F ED A0       > ldi		
1592   4721 ED A0       > ldi		
1592   4723 ED A0       > ldi		
1592   4725 ED A0       > ldi		
1592   4727 ED A0       > ldi		
1592   4729 ED A0       > ldi		
1592   472B ED A0       > ldi		
1592   472D ED A0       > ldi		
1592   472F ED A0       > ldi		
1592   4731 ED A0       > ldi		
1592   4733 ED A0       > ldi		
1592   4735 ED A0       > ldi		
1592   4737 ED A0       > ldi		
1592   4739 ED A0       > ldi		
1592   473B ED A0       > ldi		
1592   473D ED A0       > ldi		
1592   473F ED A0       > ldi		
1592   4741 ED A0       > ldi		
1592   4743 ED A0       > ldi		
1592   4745 ED A0       > ldi		
1592   4747 ED A0       > ldi		
1592   4749 ED A0       > ldi		
1592   474B ED A0       > ldi		
1592   474D ED A0       > ldi		
1592   474F ED A0       > ldi		
1592   4751 ED A0       > ldi		
1592   4753 ED A0       > ldi		
1592   4755 ED A0       > ldi		
1592   4757 ED A0       > ldi		
1592   4759 ED A0       > ldi		
1592   475B ED A0       > ldi		
1592   475D ED A0       > ldi		
1592   475F ED A0       > ldi		
1592   4761 ED A0       > ldi		
1592   4763 ED A0       > ldi		
1592   4765 ED A0       > ldi		
1592   4767 ED A0       > ldi		
1592   4769 ED A0       > ldi		
1592   476B ED A0       > ldi		
1592   476D ED A0       > ldi		
1592   476F ED A0       > ldi		
1592   4771 ED A0       > ldi		
1592   4773 ED A0       > ldi		
1592   4775 ED A0       > ldi		
1592   4777 ED A0       > ldi		
1592   4779 ED A0       > ldi		
1592   477B ED A0       > ldi		
1592   477D ED A0       > ldi		
1592   477F ED A0       > ldi		
1592   4781 ED A0       > ldi		
1592   4783 ED A0       > ldi		
1592   4785 ED A0       > ldi		
1592   4787 ED A0       > ldi		
1592   4789 ED A0       > ldi		
1592   478B ED A0       > ldi		
1592   478D ED A0       > ldi		
1592   478F ED A0       > ldi		
1592   4791 ED A0       > ldi		
1592   4793 ED A0       > ldi		
1592   4795 ED A0       > ldi		
1592   4797 ED A0       > ldi		
1592   4799 ED A0       > ldi		
1592   479B ED A0       > ldi		
1592   479D ED A0       > ldi		
1592   479F ED A0       > ldi		
1592   47A1 ED A0       > ldi		
1592   47A3 ED A0       > ldi		
1592   47A5 ED A0       > ldi		
1592   47A7 ED A0       > ldi		
1592   47A9 ED A0       > ldi		
1592   47AB ED A0       > ldi		
1592   47AD ED A0       > ldi		
1592   47AF ED A0       > ldi		
1592   47B1 ED A0       > ldi		
1592   47B3 ED A0       > ldi		
1592   47B5 ED A0       > ldi		
1592   47B7 ED A0       > ldi		
1592   47B9 ED A0       > ldi		
1592   47BB ED A0       > ldi		
1592   47BD ED A0       > ldi		
1592   47BF ED A0       > ldi		
1592   47C1 ED A0       > ldi		
1592   47C3 ED A0       > ldi		
1592   47C5 ED A0       > ldi		
1592   47C7 ED A0       > ldi		
1592   47C9 ED A0       > ldi		
1592   47CB ED A0       > ldi		
1592   47CD ED A0       > ldi		
1592   47CF ED A0       > ldi		
1592   47D1 ED A0       > ldi		
1592   47D3 ED A0       > ldi		
1592   47D5 ED A0       > ldi		
1592   47D7 ED A0       > ldi		
1592   47D9 ED A0       > ldi		
1592   47DB ED A0       > ldi		
1592   47DD ED A0       > ldi		
1592   47DF ED A0       > ldi		
1592   47E1 ED A0       > ldi		
1592   47E3 ED A0       > ldi		
1592   47E5 ED A0       > ldi		
1592   47E7 ED A0       > ldi		
1592   47E9 ED A0       > ldi		
1592   47EB ED A0       > ldi		
1592   47ED ED A0       > ldi		
1592   47EF ED A0       > ldi		
1592   47F1 ED A0       > ldi		
1592   47F3 ED A0       > ldi		
1592   47F5 ED A0       > ldi		
1592   47F7 ED A0       > ldi		
1592   47F9 ED A0       > ldi		
1592   47FB ED A0       > ldi		
1592   47FD ED A0       > ldi		
1592   47FF ED A0       > ldi		
1592   4801 ED A0       > ldi		
1592   4803 ED A0       > ldi		
1592   4805 ED A0       > ldi		
1592   4807 ED A0       > ldi		
1592   4809 ED A0       > ldi		
1592   480B ED A0       > ldi		
1592   480D ED A0       > ldi		
1592   480F ED A0       > ldi		
1592   4811 ED A0       > ldi		
1592   4813 ED A0       > ldi		
1592   4815 ED A0       > ldi		
1592   4817 ED A0       > ldi		
1592   4819 ED A0       > ldi		
1592   481B ED A0       > ldi		
1592   481D ED A0       > ldi		
1592   481F ED A0       > ldi		
1592   4821 ED A0       > ldi		
1592   4823 ED A0       > ldi		
1592   4825 ED A0       > ldi		
1592   4827 ED A0       > ldi		
1592   4829 ED A0       > ldi		
1592   482B ED A0       > ldi		
1592   482D ED A0       > ldi		
1592   482F ED A0       > ldi		
1592   4831 ED A0       > ldi		
1592   4833 ED A0       > ldi		
1592   4835 ED A0       > ldi		
1592   4837 ED A0       > ldi		
1592   4839 ED A0       > ldi		
1592   483B ED A0       > ldi		
1592   483D ED A0       > ldi		
1592   483F ED A0       > ldi		
1592   4841 ED A0       > ldi		
1592   4843 ED A0       > ldi		
1592   4845 ED A0       > ldi		
1592   4847 ED A0       > ldi		
1592   4849 ED A0       > ldi		
1592   484B ED A0       > ldi		
1592   484D ED A0       > ldi		
1592   484F ED A0       > ldi		
1592   4851 ED A0       > ldi		
1592   4853 ED A0       > ldi		
1592   4855 ED A0       > ldi		
1592   4857 ED A0       > ldi		
1592   4859 ED A0       > ldi		
1592   485B ED A0       > ldi		
1592   485D ED A0       > ldi		
1592   485F ED A0       > ldi		
1592   4861 ED A0       > ldi		
1592   4863 ED A0       > ldi		
1592   4865 ED A0       > ldi		
1592   4867 ED A0       > ldi		
1592   4869 ED A0       > ldi		
1592   486B ED A0       > ldi		
1592   486D ED A0       > ldi		
1592   486F ED A0       > ldi		
1592   4871 ED A0       > ldi		
1592   4873 ED A0       > ldi		
1592   4875 ED A0       > ldi		
1592   4877 ED A0       > ldi		
1592   4879 ED A0       > ldi		
1592   487B ED A0       > ldi		
1592   487D ED A0       > ldi		
1592   487F ED A0       > ldi		
1592   4881 ED A0       > ldi		
1592   4883 ED A0       > ldi		
1592   4885 ED A0       > ldi		
1592   4887 ED A0       > ldi		
1592   4889 ED A0       > ldi		
1592   488B ED A0       > ldi		
1592   488D ED A0       > ldi		
1592   488F ED A0       > ldi		
1592   4891 ED A0       > ldi		
1592   4893 ED A0       > ldi		
1592   4895 ED A0       > ldi		
1592   4897 ED A0       > ldi		
1592   4899 ED A0       > ldi		
1592   489B ED A0       > ldi		
1592   489D ED A0       > ldi		
1592   489F ED A0       > ldi		
1592   48A1 ED A0       > ldi		
1592   48A3 ED A0       > ldi		
1592   48A5 ED A0       > ldi		
1592   48A7 ED A0       > ldi		
1592   48A9 ED A0       > ldi		
1592   48AB ED A0       > ldi		
1592   48AD ED A0       > ldi		
1592   48AF ED A0       > ldi		
1592   48B1 ED A0       > ldi		
1592   48B3 ED A0       > ldi		
1592   48B5 ED A0       > ldi		
1592   48B7 ED A0       > ldi		
1592   48B9 ED A0       > ldi		
1592   48BB ED A0       > ldi		
1592   48BD ED A0       > ldi		
1592   48BF ED A0       > ldi		
1592   48C1 ED A0       > ldi		
1592   48C3 ED A0       > ldi		
1592   48C5 ED A0       > ldi		
1592   48C7 ED A0       > ldi		
1592   48C9 ED A0       > ldi		
1592   48CB ED A0       > ldi		
1592   48CD ED A0       > ldi		
1592   48CF ED A0       > ldi		
1592   48D1 ED A0       > ldi		
1592   48D3 ED A0       > ldi		
1592   48D5 ED A0       > ldi		
1592   48D7 ED A0       > ldi		
1592   48D9 ED A0       > ldi		
1592   48DB ED A0       > ldi		
1592   48DD ED A0       > ldi		
1592   48DF ED A0       > ldi		
1592   48E1 ED A0       > ldi		
1592   48E3 ED A0       > ldi		
1592   48E5 ED A0       > ldi		
1592   48E7 ED A0       > ldi		
1592   48E9 ED A0       > ldi		
1592   48EB ED A0       > ldi		
1592   48ED ED A0       > ldi		
1592   48EF ED A0       > ldi		
1592   48F1 ED A0       > ldi		
1592   48F3 ED A0       > ldi		
1592   48F5 ED A0       > ldi		
1592   48F7 ED A0       > ldi		
1592   48F9 ED A0       > ldi		
1592   48FB ED A0       > ldi		
1592   48FD ED A0       > ldi		
1592   48FF ED A0       > ldi		
1592   4901 ED A0       > ldi		
1592   4903 ED A0       > ldi		
1592   4905 ED A0       > ldi		
1592   4907 ED A0       > ldi		
1592   4909 ED A0       > ldi		
1592   490B ED A0       > ldi		
1592   490D ED A0       > ldi		
1592   490F ED A0       > ldi		
1592   4911 ED A0       > ldi		
1592   4913 ED A0       > ldi		
1592   4915 ED A0       > ldi		
1592   4917 ED A0       > ldi		
1592   4919 ED A0       > ldi		
1592   491B ED A0       > ldi		
1592   491D ED A0       > ldi		
1592   491F ED A0       > ldi		
1592   4921 ED A0       > ldi		
1592   4923 ED A0       > ldi		
1592   4925 ED A0       > ldi		
1592   4927 ED A0       > ldi		
1592   4929 ED A0       > ldi		
1592   492B ED A0       > ldi		
1592   492D ED A0       > ldi		
1592   492F ED A0       > ldi		
1592   4931 ED A0       > ldi		
1592   4933 ED A0       > ldi		
1592   4935 ED A0       > ldi		
1592   4937 ED A0       > ldi		
1592   4939 ED A0       > ldi		
1592   493B ED A0       > ldi		
1592   493D ED A0       > ldi		
1592   493F ED A0       > ldi		
1592   4941 ED A0       > ldi		
1592   4943 ED A0       > ldi		
1592   4945 ED A0       > ldi		
1592   4947 ED A0       > ldi		
1592   4949 ED A0       > ldi		
1592   494B ED A0       > ldi		
1592   494D ED A0       > ldi		
1592   494F ED A0       > ldi		
1592   4951 ED A0       > ldi		
1592   4953 ED A0       > ldi		
1592   4955 ED A0       > ldi		
1592   4957 ED A0       > ldi		
1592   4959 ED A0       > ldi		
1592   495B ED A0       > ldi		
1592   495D ED A0       > ldi		
1592   495F ED A0       > ldi		
1592   4961 ED A0       > ldi		
1592   4963 ED A0       > ldi		
1592   4965 ED A0       > ldi		
1592   4967 ED A0       > ldi		
1592   4969 ED A0       > ldi		
1592   496B ED A0       > ldi		
1592   496D ED A0       > ldi		
1592   496F ED A0       > ldi		
1592   4971 ED A0       > ldi		
1592   4973 ED A0       > ldi		
1592   4975 ED A0       > ldi		
1592   4977 ED A0       > ldi		
1592   4979 ED A0       > ldi		
1592   497B ED A0       > ldi		
1592   497D ED A0       > ldi		
1592   497F ED A0       > ldi		
1592   4981 ED A0       > ldi		
1592   4983 ED A0       > ldi		
1592   4985 ED A0       > ldi		
1592   4987 ED A0       > ldi		
1592   4989 ED A0       > ldi		
1592   498B ED A0       > ldi		
1592   498D ED A0       > ldi		
1592   498F ED A0       > ldi		
1592   4991 ED A0       > ldi		
1592   4993 ED A0       > ldi		
1592   4995 ED A0       > ldi		
1592   4997 ED A0       > ldi		
1592   4999 ED A0       > ldi		
1592   499B ED A0       > ldi		
1592   499D ED A0       > ldi		
1592   499F ED A0       > ldi		
1592   49A1 ED A0       > ldi		
1592   49A3 ED A0       > ldi		
1592   49A5 ED A0       > ldi		
1592   49A7 ED A0       > ldi		
1592   49A9 ED A0       > ldi		
1592   49AB ED A0       > ldi		
1592   49AD ED A0       > ldi		
1592   49AF ED A0       > ldi		
1592   49B1 ED A0       > ldi		
1592   49B3 ED A0       > ldi		
1592   49B5 ED A0       > ldi		
1592   49B7 ED A0       > ldi		
1592   49B9 ED A0       > ldi		
1592   49BB ED A0       > ldi		
1592   49BD ED A0       > ldi		
1592   49BF ED A0       > ldi		
1592   49C1 ED A0       > ldi		
1592   49C3 ED A0       > ldi		
1592   49C5 ED A0       > ldi		
1592   49C7 ED A0       > ldi		
1592   49C9 ED A0       > ldi		
1592   49CB ED A0       > ldi		
1592   49CD ED A0       > ldi		
1592   49CF ED A0       > ldi		
1592   49D1 ED A0       > ldi		
1592   49D3 ED A0       > ldi		
1592   49D5 ED A0       > ldi		
1592   49D7 ED A0       > ldi		
1592   49D9 ED A0       > ldi		
1592   49DB ED A0       > ldi		
1592   49DD ED A0       > ldi		
1592   49DF ED A0       > ldi		
1592   49E1 ED A0       > ldi		
1592   49E3 ED A0       > ldi		
1592   49E5 ED A0       > ldi		
1592   49E7 ED A0       > ldi		
1592   49E9 ED A0       > ldi		
1592   49EB ED A0       > ldi		
1592   49ED ED A0       > ldi		
1592   49EF ED A0       > ldi		
1592   49F1 ED A0       > ldi		
1592   49F3 ED A0       > ldi		
1592   49F5 ED A0       > ldi		
1592   49F7 ED A0       > ldi		
1592   49F9 ED A0       > ldi		
1592   49FB ED A0       > ldi		
1592   49FD ED A0       > ldi		
1592   49FF ED A0       > ldi		
1592   4A01 ED A0       > ldi		
1592   4A03 ED A0       > ldi		
1592   4A05 ED A0       > ldi		
1592   4A07 ED A0       > ldi		
1592   4A09 ED A0       > ldi		
1592   4A0B ED A0       > ldi		
1592   4A0D ED A0       > ldi		
1592   4A0F ED A0       > ldi		
1592   4A11 ED A0       > ldi		
1592   4A13 ED A0       > ldi		
1592   4A15 ED A0       > ldi		
1592   4A17 ED A0       > ldi		
1592   4A19 ED A0       > ldi		
1592   4A1B ED A0       > ldi		
1592   4A1D ED A0       > ldi		
1592   4A1F ED A0       > ldi		
1592   4A21 ED A0       > ldi		
1592   4A23 ED A0       > ldi		
1592   4A25 ED A0       > ldi		
1592   4A27 ED A0       > ldi		
1592   4A29 ED A0       > ldi		
1592   4A2B ED A0       > ldi		
1592   4A2D ED A0       > ldi		
1592   4A2F ED A0       > ldi		
1592   4A31 ED A0       > ldi		
1592   4A33 ED A0       > ldi		
1592   4A35 ED A0       > ldi		
1592   4A37 ED A0       > ldi		
1592   4A39 ED A0       > ldi		
1592   4A3B ED A0       > ldi		
1592   4A3D ED A0       > ldi		
1592   4A3F ED A0       > ldi		
1592   4A41 ED A0       > ldi		
1592   4A43 ED A0       > ldi		
1592   4A45 ED A0       > ldi		
1592   4A47 ED A0       > ldi		
1592   4A49 ED A0       > ldi		
1592   4A4B ED A0       > ldi		
1592   4A4D ED A0       > ldi		
1592   4A4F ED A0       > ldi		
1592   4A51 ED A0       > ldi		
1592   4A53 ED A0       > ldi		
1592   4A55 ED A0       > ldi		
1592   4A57 ED A0       > ldi		
1592   4A59 ED A0       > ldi		
1592   4A5B ED A0       > ldi		
1592   4A5D ED A0       > ldi		
1592   4A5F ED A0       > ldi		
1592   4A61 ED A0       > ldi		
1592   4A63 ED A0       > ldi		
1592   4A65 ED A0       > ldi		
1592   4A67 ED A0       > ldi		
1592   4A69 ED A0       > ldi		
1592   4A6B ED A0       > ldi		
1592   4A6D ED A0       > ldi		
1592   4A6F ED A0       > ldi		
1592   4A71 ED A0       > ldi		
1592   4A73 ED A0       > ldi		
1592   4A75 ED A0       > ldi		
1592   4A77 ED A0       > ldi		
1592   4A79 ED A0       > ldi		
1592   4A7B ED A0       > ldi		
1592   4A7D ED A0       > ldi		
1592   4A7F ED A0       > ldi		
1592   4A81 ED A0       > ldi		
1592   4A83 ED A0       > ldi		
1592   4A85 ED A0       > ldi		
1592   4A87 ED A0       > ldi		
1592   4A89 ED A0       > ldi		
1592   4A8B ED A0       > ldi		
1592   4A8D ED A0       > ldi		
1592   4A8F ED A0       > ldi		
1593   4A91             .part2m: 
1594   4A91 3E FF       	ld	a, $FF		; envia dummy CRC
1595   4A93 32 00 7B    	ld	(SPIDATA),a
1596   4A96 32 00 7B    	ld	(SPIDATA),a
1597   4A99 CD 28 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1598   4A9C E6 1F       	and	$1F		; testa bits erro
1599   4A9E FE 05       	cp	5
1600   4AA0 37          	scf
1601   4AA1 C2 11 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1602   4AA4 CD 37 46    	call	WAIT_RESP_NO_00	; esperar cartao
1603   4AA7 DA 11 4F    	jp	c,terminaLeituraEscritaBloco
1604   4AAA FD 7E 32    	ld	a, (iy+WRKAREA.NUMBLOCKS)	; testar se tem mais blocos para gravar
1605   4AAD 3D          	dec	a
1606   4AAE FD 77 32    	ld	(iy+WRKAREA.NUMBLOCKS), a
1607   4AB1 C2 80 46    	jp	nz,.loop
1608   4AB4 3A 00 7B    	ld	a, (SPIDATA)	; acabou os blocos, fazer 2 dummy reads
1609   4AB7 3A 00 7B    	ld	a, (SPIDATA)
1610   4ABA 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1611   4ABC 32 00 7B    	ld	(SPIDATA),a
1612   4ABF 3A 00 7B    	ld	a, (SPIDATA)	; dummy reads
1613   4AC2 3A 00 7B    	ld	a, (SPIDATA)
1614   4AC5 CD 37 46    	call	WAIT_RESP_NO_00	; esperar cartao
1615   4AC8 C3 10 4F    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1616   4ACB             
1617   4ACB 01 00 02    .r800m: 	ld	bc,512
1618   4ACE ED B0       	ldir
1619   4AD0 18 BF       	jr	.part2m
1620   4AD2             
1621   4AD2 01 00 02    .r800s: 	ld	bc,512
1622   4AD5 ED B0       	ldir
1623   4AD7 C3 F2 4E    	jp	.part2s
1624   4ADA             
1625   4ADA             .umBloco: 
1626   4ADA 3E 58       	ld	a, CMD24	; gravar somente um bloco com comando CMD24 = Write Single Block
1627   4ADC CD C0 45    	call	SD_SEND_CMD_GET_ERROR
1628   4ADF DA 11 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1629   4AE2             
1630   4AE2 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1631   4AE4 32 00 7B    	ld	(SPIDATA),a
1632   4AE7             
1633   4AE7             	; Check for a Z80 or R800
1634   4AE7 EB          	ex	de,hl
1635   4AE8             ;	or 	a		; Clear Cy
1636   4AE8 3E 14       	ld	a,20
1637   4AEA ED F9       	db	#ED,#F9		; mulub a,a
1638   4AEC EB          	ex	de,hl
1639   4AED 11 00 7B    	ld	de, SPIDATA
1640   4AF0 38 E0       	jr	c,.r800s	; Use LDIR for R800
1641   4AF2 ED A0       > ldi
1641   4AF4 ED A0       > ldi
1641   4AF6 ED A0       > ldi
1641   4AF8 ED A0       > ldi
1641   4AFA ED A0       > ldi
1641   4AFC ED A0       > ldi
1641   4AFE ED A0       > ldi
1641   4B00 ED A0       > ldi
1641   4B02 ED A0       > ldi
1641   4B04 ED A0       > ldi
1641   4B06 ED A0       > ldi
1641   4B08 ED A0       > ldi
1641   4B0A ED A0       > ldi
1641   4B0C ED A0       > ldi
1641   4B0E ED A0       > ldi
1641   4B10 ED A0       > ldi
1641   4B12 ED A0       > ldi
1641   4B14 ED A0       > ldi
1641   4B16 ED A0       > ldi
1641   4B18 ED A0       > ldi
1641   4B1A ED A0       > ldi
1641   4B1C ED A0       > ldi
1641   4B1E ED A0       > ldi
1641   4B20 ED A0       > ldi
1641   4B22 ED A0       > ldi
1641   4B24 ED A0       > ldi
1641   4B26 ED A0       > ldi
1641   4B28 ED A0       > ldi
1641   4B2A ED A0       > ldi
1641   4B2C ED A0       > ldi
1641   4B2E ED A0       > ldi
1641   4B30 ED A0       > ldi
1641   4B32 ED A0       > ldi
1641   4B34 ED A0       > ldi
1641   4B36 ED A0       > ldi
1641   4B38 ED A0       > ldi
1641   4B3A ED A0       > ldi
1641   4B3C ED A0       > ldi
1641   4B3E ED A0       > ldi
1641   4B40 ED A0       > ldi
1641   4B42 ED A0       > ldi
1641   4B44 ED A0       > ldi
1641   4B46 ED A0       > ldi
1641   4B48 ED A0       > ldi
1641   4B4A ED A0       > ldi
1641   4B4C ED A0       > ldi
1641   4B4E ED A0       > ldi
1641   4B50 ED A0       > ldi
1641   4B52 ED A0       > ldi
1641   4B54 ED A0       > ldi
1641   4B56 ED A0       > ldi
1641   4B58 ED A0       > ldi
1641   4B5A ED A0       > ldi
1641   4B5C ED A0       > ldi
1641   4B5E ED A0       > ldi
1641   4B60 ED A0       > ldi
1641   4B62 ED A0       > ldi
1641   4B64 ED A0       > ldi
1641   4B66 ED A0       > ldi
1641   4B68 ED A0       > ldi
1641   4B6A ED A0       > ldi
1641   4B6C ED A0       > ldi
1641   4B6E ED A0       > ldi
1641   4B70 ED A0       > ldi
1641   4B72 ED A0       > ldi
1641   4B74 ED A0       > ldi
1641   4B76 ED A0       > ldi
1641   4B78 ED A0       > ldi
1641   4B7A ED A0       > ldi
1641   4B7C ED A0       > ldi
1641   4B7E ED A0       > ldi
1641   4B80 ED A0       > ldi
1641   4B82 ED A0       > ldi
1641   4B84 ED A0       > ldi
1641   4B86 ED A0       > ldi
1641   4B88 ED A0       > ldi
1641   4B8A ED A0       > ldi
1641   4B8C ED A0       > ldi
1641   4B8E ED A0       > ldi
1641   4B90 ED A0       > ldi
1641   4B92 ED A0       > ldi
1641   4B94 ED A0       > ldi
1641   4B96 ED A0       > ldi
1641   4B98 ED A0       > ldi
1641   4B9A ED A0       > ldi
1641   4B9C ED A0       > ldi
1641   4B9E ED A0       > ldi
1641   4BA0 ED A0       > ldi
1641   4BA2 ED A0       > ldi
1641   4BA4 ED A0       > ldi
1641   4BA6 ED A0       > ldi
1641   4BA8 ED A0       > ldi
1641   4BAA ED A0       > ldi
1641   4BAC ED A0       > ldi
1641   4BAE ED A0       > ldi
1641   4BB0 ED A0       > ldi
1641   4BB2 ED A0       > ldi
1641   4BB4 ED A0       > ldi
1641   4BB6 ED A0       > ldi
1641   4BB8 ED A0       > ldi
1641   4BBA ED A0       > ldi
1641   4BBC ED A0       > ldi
1641   4BBE ED A0       > ldi
1641   4BC0 ED A0       > ldi
1641   4BC2 ED A0       > ldi
1641   4BC4 ED A0       > ldi
1641   4BC6 ED A0       > ldi
1641   4BC8 ED A0       > ldi
1641   4BCA ED A0       > ldi
1641   4BCC ED A0       > ldi
1641   4BCE ED A0       > ldi
1641   4BD0 ED A0       > ldi
1641   4BD2 ED A0       > ldi
1641   4BD4 ED A0       > ldi
1641   4BD6 ED A0       > ldi
1641   4BD8 ED A0       > ldi
1641   4BDA ED A0       > ldi
1641   4BDC ED A0       > ldi
1641   4BDE ED A0       > ldi
1641   4BE0 ED A0       > ldi
1641   4BE2 ED A0       > ldi
1641   4BE4 ED A0       > ldi
1641   4BE6 ED A0       > ldi
1641   4BE8 ED A0       > ldi
1641   4BEA ED A0       > ldi
1641   4BEC ED A0       > ldi
1641   4BEE ED A0       > ldi
1641   4BF0 ED A0       > ldi
1641   4BF2 ED A0       > ldi
1641   4BF4 ED A0       > ldi
1641   4BF6 ED A0       > ldi
1641   4BF8 ED A0       > ldi
1641   4BFA ED A0       > ldi
1641   4BFC ED A0       > ldi
1641   4BFE ED A0       > ldi
1641   4C00 ED A0       > ldi
1641   4C02 ED A0       > ldi
1641   4C04 ED A0       > ldi
1641   4C06 ED A0       > ldi
1641   4C08 ED A0       > ldi
1641   4C0A ED A0       > ldi
1641   4C0C ED A0       > ldi
1641   4C0E ED A0       > ldi
1641   4C10 ED A0       > ldi
1641   4C12 ED A0       > ldi
1641   4C14 ED A0       > ldi
1641   4C16 ED A0       > ldi
1641   4C18 ED A0       > ldi
1641   4C1A ED A0       > ldi
1641   4C1C ED A0       > ldi
1641   4C1E ED A0       > ldi
1641   4C20 ED A0       > ldi
1641   4C22 ED A0       > ldi
1641   4C24 ED A0       > ldi
1641   4C26 ED A0       > ldi
1641   4C28 ED A0       > ldi
1641   4C2A ED A0       > ldi
1641   4C2C ED A0       > ldi
1641   4C2E ED A0       > ldi
1641   4C30 ED A0       > ldi
1641   4C32 ED A0       > ldi
1641   4C34 ED A0       > ldi
1641   4C36 ED A0       > ldi
1641   4C38 ED A0       > ldi
1641   4C3A ED A0       > ldi
1641   4C3C ED A0       > ldi
1641   4C3E ED A0       > ldi
1641   4C40 ED A0       > ldi
1641   4C42 ED A0       > ldi
1641   4C44 ED A0       > ldi
1641   4C46 ED A0       > ldi
1641   4C48 ED A0       > ldi
1641   4C4A ED A0       > ldi
1641   4C4C ED A0       > ldi
1641   4C4E ED A0       > ldi
1641   4C50 ED A0       > ldi
1641   4C52 ED A0       > ldi
1641   4C54 ED A0       > ldi
1641   4C56 ED A0       > ldi
1641   4C58 ED A0       > ldi
1641   4C5A ED A0       > ldi
1641   4C5C ED A0       > ldi
1641   4C5E ED A0       > ldi
1641   4C60 ED A0       > ldi
1641   4C62 ED A0       > ldi
1641   4C64 ED A0       > ldi
1641   4C66 ED A0       > ldi
1641   4C68 ED A0       > ldi
1641   4C6A ED A0       > ldi
1641   4C6C ED A0       > ldi
1641   4C6E ED A0       > ldi
1641   4C70 ED A0       > ldi
1641   4C72 ED A0       > ldi
1641   4C74 ED A0       > ldi
1641   4C76 ED A0       > ldi
1641   4C78 ED A0       > ldi
1641   4C7A ED A0       > ldi
1641   4C7C ED A0       > ldi
1641   4C7E ED A0       > ldi
1641   4C80 ED A0       > ldi
1641   4C82 ED A0       > ldi
1641   4C84 ED A0       > ldi
1641   4C86 ED A0       > ldi
1641   4C88 ED A0       > ldi
1641   4C8A ED A0       > ldi
1641   4C8C ED A0       > ldi
1641   4C8E ED A0       > ldi
1641   4C90 ED A0       > ldi
1641   4C92 ED A0       > ldi
1641   4C94 ED A0       > ldi
1641   4C96 ED A0       > ldi
1641   4C98 ED A0       > ldi
1641   4C9A ED A0       > ldi
1641   4C9C ED A0       > ldi
1641   4C9E ED A0       > ldi
1641   4CA0 ED A0       > ldi
1641   4CA2 ED A0       > ldi
1641   4CA4 ED A0       > ldi
1641   4CA6 ED A0       > ldi
1641   4CA8 ED A0       > ldi
1641   4CAA ED A0       > ldi
1641   4CAC ED A0       > ldi
1641   4CAE ED A0       > ldi
1641   4CB0 ED A0       > ldi
1641   4CB2 ED A0       > ldi
1641   4CB4 ED A0       > ldi
1641   4CB6 ED A0       > ldi
1641   4CB8 ED A0       > ldi
1641   4CBA ED A0       > ldi
1641   4CBC ED A0       > ldi
1641   4CBE ED A0       > ldi
1641   4CC0 ED A0       > ldi
1641   4CC2 ED A0       > ldi
1641   4CC4 ED A0       > ldi
1641   4CC6 ED A0       > ldi
1641   4CC8 ED A0       > ldi
1641   4CCA ED A0       > ldi
1641   4CCC ED A0       > ldi
1641   4CCE ED A0       > ldi
1641   4CD0 ED A0       > ldi
1641   4CD2 ED A0       > ldi
1641   4CD4 ED A0       > ldi
1641   4CD6 ED A0       > ldi
1641   4CD8 ED A0       > ldi
1641   4CDA ED A0       > ldi
1641   4CDC ED A0       > ldi
1641   4CDE ED A0       > ldi
1641   4CE0 ED A0       > ldi
1641   4CE2 ED A0       > ldi
1641   4CE4 ED A0       > ldi
1641   4CE6 ED A0       > ldi
1641   4CE8 ED A0       > ldi
1641   4CEA ED A0       > ldi
1641   4CEC ED A0       > ldi
1641   4CEE ED A0       > ldi
1641   4CF0 ED A0       > ldi
1641   4CF2 ED A0       > ldi
1641   4CF4 ED A0       > ldi
1641   4CF6 ED A0       > ldi
1641   4CF8 ED A0       > ldi
1641   4CFA ED A0       > ldi
1641   4CFC ED A0       > ldi
1641   4CFE ED A0       > ldi
1641   4D00 ED A0       > ldi
1641   4D02 ED A0       > ldi
1641   4D04 ED A0       > ldi
1641   4D06 ED A0       > ldi
1641   4D08 ED A0       > ldi
1641   4D0A ED A0       > ldi
1641   4D0C ED A0       > ldi
1641   4D0E ED A0       > ldi
1641   4D10 ED A0       > ldi
1641   4D12 ED A0       > ldi
1641   4D14 ED A0       > ldi
1641   4D16 ED A0       > ldi
1641   4D18 ED A0       > ldi
1641   4D1A ED A0       > ldi
1641   4D1C ED A0       > ldi
1641   4D1E ED A0       > ldi
1641   4D20 ED A0       > ldi
1641   4D22 ED A0       > ldi
1641   4D24 ED A0       > ldi
1641   4D26 ED A0       > ldi
1641   4D28 ED A0       > ldi
1641   4D2A ED A0       > ldi
1641   4D2C ED A0       > ldi
1641   4D2E ED A0       > ldi
1641   4D30 ED A0       > ldi
1641   4D32 ED A0       > ldi
1641   4D34 ED A0       > ldi
1641   4D36 ED A0       > ldi
1641   4D38 ED A0       > ldi
1641   4D3A ED A0       > ldi
1641   4D3C ED A0       > ldi
1641   4D3E ED A0       > ldi
1641   4D40 ED A0       > ldi
1641   4D42 ED A0       > ldi
1641   4D44 ED A0       > ldi
1641   4D46 ED A0       > ldi
1641   4D48 ED A0       > ldi
1641   4D4A ED A0       > ldi
1641   4D4C ED A0       > ldi
1641   4D4E ED A0       > ldi
1641   4D50 ED A0       > ldi
1641   4D52 ED A0       > ldi
1641   4D54 ED A0       > ldi
1641   4D56 ED A0       > ldi
1641   4D58 ED A0       > ldi
1641   4D5A ED A0       > ldi
1641   4D5C ED A0       > ldi
1641   4D5E ED A0       > ldi
1641   4D60 ED A0       > ldi
1641   4D62 ED A0       > ldi
1641   4D64 ED A0       > ldi
1641   4D66 ED A0       > ldi
1641   4D68 ED A0       > ldi
1641   4D6A ED A0       > ldi
1641   4D6C ED A0       > ldi
1641   4D6E ED A0       > ldi
1641   4D70 ED A0       > ldi
1641   4D72 ED A0       > ldi
1641   4D74 ED A0       > ldi
1641   4D76 ED A0       > ldi
1641   4D78 ED A0       > ldi
1641   4D7A ED A0       > ldi
1641   4D7C ED A0       > ldi
1641   4D7E ED A0       > ldi
1641   4D80 ED A0       > ldi
1641   4D82 ED A0       > ldi
1641   4D84 ED A0       > ldi
1641   4D86 ED A0       > ldi
1641   4D88 ED A0       > ldi
1641   4D8A ED A0       > ldi
1641   4D8C ED A0       > ldi
1641   4D8E ED A0       > ldi
1641   4D90 ED A0       > ldi
1641   4D92 ED A0       > ldi
1641   4D94 ED A0       > ldi
1641   4D96 ED A0       > ldi
1641   4D98 ED A0       > ldi
1641   4D9A ED A0       > ldi
1641   4D9C ED A0       > ldi
1641   4D9E ED A0       > ldi
1641   4DA0 ED A0       > ldi
1641   4DA2 ED A0       > ldi
1641   4DA4 ED A0       > ldi
1641   4DA6 ED A0       > ldi
1641   4DA8 ED A0       > ldi
1641   4DAA ED A0       > ldi
1641   4DAC ED A0       > ldi
1641   4DAE ED A0       > ldi
1641   4DB0 ED A0       > ldi
1641   4DB2 ED A0       > ldi
1641   4DB4 ED A0       > ldi
1641   4DB6 ED A0       > ldi
1641   4DB8 ED A0       > ldi
1641   4DBA ED A0       > ldi
1641   4DBC ED A0       > ldi
1641   4DBE ED A0       > ldi
1641   4DC0 ED A0       > ldi
1641   4DC2 ED A0       > ldi
1641   4DC4 ED A0       > ldi
1641   4DC6 ED A0       > ldi
1641   4DC8 ED A0       > ldi
1641   4DCA ED A0       > ldi
1641   4DCC ED A0       > ldi
1641   4DCE ED A0       > ldi
1641   4DD0 ED A0       > ldi
1641   4DD2 ED A0       > ldi
1641   4DD4 ED A0       > ldi
1641   4DD6 ED A0       > ldi
1641   4DD8 ED A0       > ldi
1641   4DDA ED A0       > ldi
1641   4DDC ED A0       > ldi
1641   4DDE ED A0       > ldi
1641   4DE0 ED A0       > ldi
1641   4DE2 ED A0       > ldi
1641   4DE4 ED A0       > ldi
1641   4DE6 ED A0       > ldi
1641   4DE8 ED A0       > ldi
1641   4DEA ED A0       > ldi
1641   4DEC ED A0       > ldi
1641   4DEE ED A0       > ldi
1641   4DF0 ED A0       > ldi
1641   4DF2 ED A0       > ldi
1641   4DF4 ED A0       > ldi
1641   4DF6 ED A0       > ldi
1641   4DF8 ED A0       > ldi
1641   4DFA ED A0       > ldi
1641   4DFC ED A0       > ldi
1641   4DFE ED A0       > ldi
1641   4E00 ED A0       > ldi
1641   4E02 ED A0       > ldi
1641   4E04 ED A0       > ldi
1641   4E06 ED A0       > ldi
1641   4E08 ED A0       > ldi
1641   4E0A ED A0       > ldi
1641   4E0C ED A0       > ldi
1641   4E0E ED A0       > ldi
1641   4E10 ED A0       > ldi
1641   4E12 ED A0       > ldi
1641   4E14 ED A0       > ldi
1641   4E16 ED A0       > ldi
1641   4E18 ED A0       > ldi
1641   4E1A ED A0       > ldi
1641   4E1C ED A0       > ldi
1641   4E1E ED A0       > ldi
1641   4E20 ED A0       > ldi
1641   4E22 ED A0       > ldi
1641   4E24 ED A0       > ldi
1641   4E26 ED A0       > ldi
1641   4E28 ED A0       > ldi
1641   4E2A ED A0       > ldi
1641   4E2C ED A0       > ldi
1641   4E2E ED A0       > ldi
1641   4E30 ED A0       > ldi
1641   4E32 ED A0       > ldi
1641   4E34 ED A0       > ldi
1641   4E36 ED A0       > ldi
1641   4E38 ED A0       > ldi
1641   4E3A ED A0       > ldi
1641   4E3C ED A0       > ldi
1641   4E3E ED A0       > ldi
1641   4E40 ED A0       > ldi
1641   4E42 ED A0       > ldi
1641   4E44 ED A0       > ldi
1641   4E46 ED A0       > ldi
1641   4E48 ED A0       > ldi
1641   4E4A ED A0       > ldi
1641   4E4C ED A0       > ldi
1641   4E4E ED A0       > ldi
1641   4E50 ED A0       > ldi
1641   4E52 ED A0       > ldi
1641   4E54 ED A0       > ldi
1641   4E56 ED A0       > ldi
1641   4E58 ED A0       > ldi
1641   4E5A ED A0       > ldi
1641   4E5C ED A0       > ldi
1641   4E5E ED A0       > ldi
1641   4E60 ED A0       > ldi
1641   4E62 ED A0       > ldi
1641   4E64 ED A0       > ldi
1641   4E66 ED A0       > ldi
1641   4E68 ED A0       > ldi
1641   4E6A ED A0       > ldi
1641   4E6C ED A0       > ldi
1641   4E6E ED A0       > ldi
1641   4E70 ED A0       > ldi
1641   4E72 ED A0       > ldi
1641   4E74 ED A0       > ldi
1641   4E76 ED A0       > ldi
1641   4E78 ED A0       > ldi
1641   4E7A ED A0       > ldi
1641   4E7C ED A0       > ldi
1641   4E7E ED A0       > ldi
1641   4E80 ED A0       > ldi
1641   4E82 ED A0       > ldi
1641   4E84 ED A0       > ldi
1641   4E86 ED A0       > ldi
1641   4E88 ED A0       > ldi
1641   4E8A ED A0       > ldi
1641   4E8C ED A0       > ldi
1641   4E8E ED A0       > ldi
1641   4E90 ED A0       > ldi
1641   4E92 ED A0       > ldi
1641   4E94 ED A0       > ldi
1641   4E96 ED A0       > ldi
1641   4E98 ED A0       > ldi
1641   4E9A ED A0       > ldi
1641   4E9C ED A0       > ldi
1641   4E9E ED A0       > ldi
1641   4EA0 ED A0       > ldi
1641   4EA2 ED A0       > ldi
1641   4EA4 ED A0       > ldi
1641   4EA6 ED A0       > ldi
1641   4EA8 ED A0       > ldi
1641   4EAA ED A0       > ldi
1641   4EAC ED A0       > ldi
1641   4EAE ED A0       > ldi
1641   4EB0 ED A0       > ldi
1641   4EB2 ED A0       > ldi
1641   4EB4 ED A0       > ldi
1641   4EB6 ED A0       > ldi
1641   4EB8 ED A0       > ldi
1641   4EBA ED A0       > ldi
1641   4EBC ED A0       > ldi
1641   4EBE ED A0       > ldi
1641   4EC0 ED A0       > ldi
1641   4EC2 ED A0       > ldi
1641   4EC4 ED A0       > ldi
1641   4EC6 ED A0       > ldi
1641   4EC8 ED A0       > ldi
1641   4ECA ED A0       > ldi
1641   4ECC ED A0       > ldi
1641   4ECE ED A0       > ldi
1641   4ED0 ED A0       > ldi
1641   4ED2 ED A0       > ldi
1641   4ED4 ED A0       > ldi
1641   4ED6 ED A0       > ldi
1641   4ED8 ED A0       > ldi
1641   4EDA ED A0       > ldi
1641   4EDC ED A0       > ldi
1641   4EDE ED A0       > ldi
1641   4EE0 ED A0       > ldi
1641   4EE2 ED A0       > ldi
1641   4EE4 ED A0       > ldi
1641   4EE6 ED A0       > ldi
1641   4EE8 ED A0       > ldi
1641   4EEA ED A0       > ldi
1641   4EEC ED A0       > ldi
1641   4EEE ED A0       > ldi
1641   4EF0 ED A0       > ldi
1642   4EF2             .part2s: 
1643   4EF2 01 00 02    	ld	bc,512
1644   4EF5 ED B0       	ldir
1645   4EF7 3E FF       	ld	a, $FF		; envia dummy CRC
1646   4EF9 32 00 7B    	ld	(SPIDATA),a
1647   4EFC 32 00 7B    	ld	(SPIDATA),a
1648   4EFF CD 28 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1649   4F02 E6 1F       	and	$1F		; testa bits erro
1650   4F04 FE 05       	cp	5
1651   4F06 37          	scf
1652   4F07 C2 11 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1653   4F0A             .esp: 
1654   4F0A CD 28 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1655   4F0D B7          	or	a
1656   4F0E 28 FA       	jr	z,.esp
1657   4F10             .fim: 
1658   4F10 AF          	xor	a		; zera carry e informa nenhum erro
1659   4F11             terminaLeituraEscritaBloco: 
1660   4F11             ;	push	af
1661   4F11 CD A4 45    	call	disableSDs	; desabilitar todos os cartoes
1662   4F14             ;	pop	af
1663   4F14 C9          	ret
1664   4F15             
1665   4F15             
1666   4F15             ; ------------------------------------------------
1667   4F15             ; Ler um bloco de 512 bytes do cartao
1668   4F15             ; HL =  aponta para o inicio dos dados
1669   4F15             ; BC:DE = contem o numero do bloco (BCDE = 32 bits)
1670   4F15             ; IXH = Number of blocks
1671   4F15             ; IXL = SDcard version (0 or 1)
1672   4F15             ; Destroi AF, BC, DE, HL, IXL
1673   4F15             ; ------------------------------------------------
1674   4F15             LerBloco: 
1675   4F15 FD 7E 32    	ld	a,(iy+WRKAREA.NUMBLOCKS)	; save the number of blocks to transfer 
1676   4F18 DD 67       	ld	ixh,a		; ixh=Number of blocks
1677   4F1A             ;	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1678   4F1A DD 7D       	ld	a,ixl
1679   4F1C B7          	or	a
1680   4F1D CC 88 57    	call	z,blocoParaByte	; se for SDV1 coverter blocos para bytes
1681   4F20             ;	call	setaSDAtual
1682   4F20             
1683   4F20             
1684   4F20             
1685   4F20 FD 7E 32    	ld	a, (iy+WRKAREA.NUMBLOCKS)	; testar se Nextor quer ler um ou mais blocos
1686   4F23 3D          	dec	a
1687   4F24 CA 68 53    	jp	z,.umBloco	; somente um bloco, pular
1688   4F27             
1689   4F27             ; multiplos blocos
1690   4F27 3E 52       	ld	a, CMD18	; ler multiplos blocos com CMD18 = Read Multiple Blocks
1691   4F29 CD C0 45    	call	SD_SEND_CMD_GET_ERROR
1692   4F2C DA 11 4F    	jp	c,terminaLeituraEscritaBloco
1693   4F2F             .loop: 
1694   4F2F CD 1A 46    	call	WAIT_RESP_FE
1695   4F32 DA 11 4F    	jp	c,terminaLeituraEscritaBloco
1696   4F35 EB          	ex	de,hl
1697   4F36             	; Check for a Z80 or R800
1698   4F36             ;	or 	a		; Clear Cy
1699   4F36 3E 14       	ld	a,20
1700   4F38 ED F9       	db	#ED,#F9		; mulub a,a
1701   4F3A 21 00 7B    	ld	hl, SPIDATA
1702   4F3D DA 59 53    	jp	c,.r800m	; Use LDIR for R800
1703   4F40 ED A0       > ldi
1703   4F42 ED A0       > ldi
1703   4F44 ED A0       > ldi
1703   4F46 ED A0       > ldi
1703   4F48 ED A0       > ldi
1703   4F4A ED A0       > ldi
1703   4F4C ED A0       > ldi
1703   4F4E ED A0       > ldi
1703   4F50 ED A0       > ldi
1703   4F52 ED A0       > ldi
1703   4F54 ED A0       > ldi
1703   4F56 ED A0       > ldi
1703   4F58 ED A0       > ldi
1703   4F5A ED A0       > ldi
1703   4F5C ED A0       > ldi
1703   4F5E ED A0       > ldi
1703   4F60 ED A0       > ldi
1703   4F62 ED A0       > ldi
1703   4F64 ED A0       > ldi
1703   4F66 ED A0       > ldi
1703   4F68 ED A0       > ldi
1703   4F6A ED A0       > ldi
1703   4F6C ED A0       > ldi
1703   4F6E ED A0       > ldi
1703   4F70 ED A0       > ldi
1703   4F72 ED A0       > ldi
1703   4F74 ED A0       > ldi
1703   4F76 ED A0       > ldi
1703   4F78 ED A0       > ldi
1703   4F7A ED A0       > ldi
1703   4F7C ED A0       > ldi
1703   4F7E ED A0       > ldi
1703   4F80 ED A0       > ldi
1703   4F82 ED A0       > ldi
1703   4F84 ED A0       > ldi
1703   4F86 ED A0       > ldi
1703   4F88 ED A0       > ldi
1703   4F8A ED A0       > ldi
1703   4F8C ED A0       > ldi
1703   4F8E ED A0       > ldi
1703   4F90 ED A0       > ldi
1703   4F92 ED A0       > ldi
1703   4F94 ED A0       > ldi
1703   4F96 ED A0       > ldi
1703   4F98 ED A0       > ldi
1703   4F9A ED A0       > ldi
1703   4F9C ED A0       > ldi
1703   4F9E ED A0       > ldi
1703   4FA0 ED A0       > ldi
1703   4FA2 ED A0       > ldi
1703   4FA4 ED A0       > ldi
1703   4FA6 ED A0       > ldi
1703   4FA8 ED A0       > ldi
1703   4FAA ED A0       > ldi
1703   4FAC ED A0       > ldi
1703   4FAE ED A0       > ldi
1703   4FB0 ED A0       > ldi
1703   4FB2 ED A0       > ldi
1703   4FB4 ED A0       > ldi
1703   4FB6 ED A0       > ldi
1703   4FB8 ED A0       > ldi
1703   4FBA ED A0       > ldi
1703   4FBC ED A0       > ldi
1703   4FBE ED A0       > ldi
1703   4FC0 ED A0       > ldi
1703   4FC2 ED A0       > ldi
1703   4FC4 ED A0       > ldi
1703   4FC6 ED A0       > ldi
1703   4FC8 ED A0       > ldi
1703   4FCA ED A0       > ldi
1703   4FCC ED A0       > ldi
1703   4FCE ED A0       > ldi
1703   4FD0 ED A0       > ldi
1703   4FD2 ED A0       > ldi
1703   4FD4 ED A0       > ldi
1703   4FD6 ED A0       > ldi
1703   4FD8 ED A0       > ldi
1703   4FDA ED A0       > ldi
1703   4FDC ED A0       > ldi
1703   4FDE ED A0       > ldi
1703   4FE0 ED A0       > ldi
1703   4FE2 ED A0       > ldi
1703   4FE4 ED A0       > ldi
1703   4FE6 ED A0       > ldi
1703   4FE8 ED A0       > ldi
1703   4FEA ED A0       > ldi
1703   4FEC ED A0       > ldi
1703   4FEE ED A0       > ldi
1703   4FF0 ED A0       > ldi
1703   4FF2 ED A0       > ldi
1703   4FF4 ED A0       > ldi
1703   4FF6 ED A0       > ldi
1703   4FF8 ED A0       > ldi
1703   4FFA ED A0       > ldi
1703   4FFC ED A0       > ldi
1703   4FFE ED A0       > ldi
1703   5000 ED A0       > ldi
1703   5002 ED A0       > ldi
1703   5004 ED A0       > ldi
1703   5006 ED A0       > ldi
1703   5008 ED A0       > ldi
1703   500A ED A0       > ldi
1703   500C ED A0       > ldi
1703   500E ED A0       > ldi
1703   5010 ED A0       > ldi
1703   5012 ED A0       > ldi
1703   5014 ED A0       > ldi
1703   5016 ED A0       > ldi
1703   5018 ED A0       > ldi
1703   501A ED A0       > ldi
1703   501C ED A0       > ldi
1703   501E ED A0       > ldi
1703   5020 ED A0       > ldi
1703   5022 ED A0       > ldi
1703   5024 ED A0       > ldi
1703   5026 ED A0       > ldi
1703   5028 ED A0       > ldi
1703   502A ED A0       > ldi
1703   502C ED A0       > ldi
1703   502E ED A0       > ldi
1703   5030 ED A0       > ldi
1703   5032 ED A0       > ldi
1703   5034 ED A0       > ldi
1703   5036 ED A0       > ldi
1703   5038 ED A0       > ldi
1703   503A ED A0       > ldi
1703   503C ED A0       > ldi
1703   503E ED A0       > ldi
1703   5040 ED A0       > ldi
1703   5042 ED A0       > ldi
1703   5044 ED A0       > ldi
1703   5046 ED A0       > ldi
1703   5048 ED A0       > ldi
1703   504A ED A0       > ldi
1703   504C ED A0       > ldi
1703   504E ED A0       > ldi
1703   5050 ED A0       > ldi
1703   5052 ED A0       > ldi
1703   5054 ED A0       > ldi
1703   5056 ED A0       > ldi
1703   5058 ED A0       > ldi
1703   505A ED A0       > ldi
1703   505C ED A0       > ldi
1703   505E ED A0       > ldi
1703   5060 ED A0       > ldi
1703   5062 ED A0       > ldi
1703   5064 ED A0       > ldi
1703   5066 ED A0       > ldi
1703   5068 ED A0       > ldi
1703   506A ED A0       > ldi
1703   506C ED A0       > ldi
1703   506E ED A0       > ldi
1703   5070 ED A0       > ldi
1703   5072 ED A0       > ldi
1703   5074 ED A0       > ldi
1703   5076 ED A0       > ldi
1703   5078 ED A0       > ldi
1703   507A ED A0       > ldi
1703   507C ED A0       > ldi
1703   507E ED A0       > ldi
1703   5080 ED A0       > ldi
1703   5082 ED A0       > ldi
1703   5084 ED A0       > ldi
1703   5086 ED A0       > ldi
1703   5088 ED A0       > ldi
1703   508A ED A0       > ldi
1703   508C ED A0       > ldi
1703   508E ED A0       > ldi
1703   5090 ED A0       > ldi
1703   5092 ED A0       > ldi
1703   5094 ED A0       > ldi
1703   5096 ED A0       > ldi
1703   5098 ED A0       > ldi
1703   509A ED A0       > ldi
1703   509C ED A0       > ldi
1703   509E ED A0       > ldi
1703   50A0 ED A0       > ldi
1703   50A2 ED A0       > ldi
1703   50A4 ED A0       > ldi
1703   50A6 ED A0       > ldi
1703   50A8 ED A0       > ldi
1703   50AA ED A0       > ldi
1703   50AC ED A0       > ldi
1703   50AE ED A0       > ldi
1703   50B0 ED A0       > ldi
1703   50B2 ED A0       > ldi
1703   50B4 ED A0       > ldi
1703   50B6 ED A0       > ldi
1703   50B8 ED A0       > ldi
1703   50BA ED A0       > ldi
1703   50BC ED A0       > ldi
1703   50BE ED A0       > ldi
1703   50C0 ED A0       > ldi
1703   50C2 ED A0       > ldi
1703   50C4 ED A0       > ldi
1703   50C6 ED A0       > ldi
1703   50C8 ED A0       > ldi
1703   50CA ED A0       > ldi
1703   50CC ED A0       > ldi
1703   50CE ED A0       > ldi
1703   50D0 ED A0       > ldi
1703   50D2 ED A0       > ldi
1703   50D4 ED A0       > ldi
1703   50D6 ED A0       > ldi
1703   50D8 ED A0       > ldi
1703   50DA ED A0       > ldi
1703   50DC ED A0       > ldi
1703   50DE ED A0       > ldi
1703   50E0 ED A0       > ldi
1703   50E2 ED A0       > ldi
1703   50E4 ED A0       > ldi
1703   50E6 ED A0       > ldi
1703   50E8 ED A0       > ldi
1703   50EA ED A0       > ldi
1703   50EC ED A0       > ldi
1703   50EE ED A0       > ldi
1703   50F0 ED A0       > ldi
1703   50F2 ED A0       > ldi
1703   50F4 ED A0       > ldi
1703   50F6 ED A0       > ldi
1703   50F8 ED A0       > ldi
1703   50FA ED A0       > ldi
1703   50FC ED A0       > ldi
1703   50FE ED A0       > ldi
1703   5100 ED A0       > ldi
1703   5102 ED A0       > ldi
1703   5104 ED A0       > ldi
1703   5106 ED A0       > ldi
1703   5108 ED A0       > ldi
1703   510A ED A0       > ldi
1703   510C ED A0       > ldi
1703   510E ED A0       > ldi
1703   5110 ED A0       > ldi
1703   5112 ED A0       > ldi
1703   5114 ED A0       > ldi
1703   5116 ED A0       > ldi
1703   5118 ED A0       > ldi
1703   511A ED A0       > ldi
1703   511C ED A0       > ldi
1703   511E ED A0       > ldi
1703   5120 ED A0       > ldi
1703   5122 ED A0       > ldi
1703   5124 ED A0       > ldi
1703   5126 ED A0       > ldi
1703   5128 ED A0       > ldi
1703   512A ED A0       > ldi
1703   512C ED A0       > ldi
1703   512E ED A0       > ldi
1703   5130 ED A0       > ldi
1703   5132 ED A0       > ldi
1703   5134 ED A0       > ldi
1703   5136 ED A0       > ldi
1703   5138 ED A0       > ldi
1703   513A ED A0       > ldi
1703   513C ED A0       > ldi
1703   513E ED A0       > ldi
1703   5140 ED A0       > ldi
1703   5142 ED A0       > ldi
1703   5144 ED A0       > ldi
1703   5146 ED A0       > ldi
1703   5148 ED A0       > ldi
1703   514A ED A0       > ldi
1703   514C ED A0       > ldi
1703   514E ED A0       > ldi
1703   5150 ED A0       > ldi
1703   5152 ED A0       > ldi
1703   5154 ED A0       > ldi
1703   5156 ED A0       > ldi
1703   5158 ED A0       > ldi
1703   515A ED A0       > ldi
1703   515C ED A0       > ldi
1703   515E ED A0       > ldi
1703   5160 ED A0       > ldi
1703   5162 ED A0       > ldi
1703   5164 ED A0       > ldi
1703   5166 ED A0       > ldi
1703   5168 ED A0       > ldi
1703   516A ED A0       > ldi
1703   516C ED A0       > ldi
1703   516E ED A0       > ldi
1703   5170 ED A0       > ldi
1703   5172 ED A0       > ldi
1703   5174 ED A0       > ldi
1703   5176 ED A0       > ldi
1703   5178 ED A0       > ldi
1703   517A ED A0       > ldi
1703   517C ED A0       > ldi
1703   517E ED A0       > ldi
1703   5180 ED A0       > ldi
1703   5182 ED A0       > ldi
1703   5184 ED A0       > ldi
1703   5186 ED A0       > ldi
1703   5188 ED A0       > ldi
1703   518A ED A0       > ldi
1703   518C ED A0       > ldi
1703   518E ED A0       > ldi
1703   5190 ED A0       > ldi
1703   5192 ED A0       > ldi
1703   5194 ED A0       > ldi
1703   5196 ED A0       > ldi
1703   5198 ED A0       > ldi
1703   519A ED A0       > ldi
1703   519C ED A0       > ldi
1703   519E ED A0       > ldi
1703   51A0 ED A0       > ldi
1703   51A2 ED A0       > ldi
1703   51A4 ED A0       > ldi
1703   51A6 ED A0       > ldi
1703   51A8 ED A0       > ldi
1703   51AA ED A0       > ldi
1703   51AC ED A0       > ldi
1703   51AE ED A0       > ldi
1703   51B0 ED A0       > ldi
1703   51B2 ED A0       > ldi
1703   51B4 ED A0       > ldi
1703   51B6 ED A0       > ldi
1703   51B8 ED A0       > ldi
1703   51BA ED A0       > ldi
1703   51BC ED A0       > ldi
1703   51BE ED A0       > ldi
1703   51C0 ED A0       > ldi
1703   51C2 ED A0       > ldi
1703   51C4 ED A0       > ldi
1703   51C6 ED A0       > ldi
1703   51C8 ED A0       > ldi
1703   51CA ED A0       > ldi
1703   51CC ED A0       > ldi
1703   51CE ED A0       > ldi
1703   51D0 ED A0       > ldi
1703   51D2 ED A0       > ldi
1703   51D4 ED A0       > ldi
1703   51D6 ED A0       > ldi
1703   51D8 ED A0       > ldi
1703   51DA ED A0       > ldi
1703   51DC ED A0       > ldi
1703   51DE ED A0       > ldi
1703   51E0 ED A0       > ldi
1703   51E2 ED A0       > ldi
1703   51E4 ED A0       > ldi
1703   51E6 ED A0       > ldi
1703   51E8 ED A0       > ldi
1703   51EA ED A0       > ldi
1703   51EC ED A0       > ldi
1703   51EE ED A0       > ldi
1703   51F0 ED A0       > ldi
1703   51F2 ED A0       > ldi
1703   51F4 ED A0       > ldi
1703   51F6 ED A0       > ldi
1703   51F8 ED A0       > ldi
1703   51FA ED A0       > ldi
1703   51FC ED A0       > ldi
1703   51FE ED A0       > ldi
1703   5200 ED A0       > ldi
1703   5202 ED A0       > ldi
1703   5204 ED A0       > ldi
1703   5206 ED A0       > ldi
1703   5208 ED A0       > ldi
1703   520A ED A0       > ldi
1703   520C ED A0       > ldi
1703   520E ED A0       > ldi
1703   5210 ED A0       > ldi
1703   5212 ED A0       > ldi
1703   5214 ED A0       > ldi
1703   5216 ED A0       > ldi
1703   5218 ED A0       > ldi
1703   521A ED A0       > ldi
1703   521C ED A0       > ldi
1703   521E ED A0       > ldi
1703   5220 ED A0       > ldi
1703   5222 ED A0       > ldi
1703   5224 ED A0       > ldi
1703   5226 ED A0       > ldi
1703   5228 ED A0       > ldi
1703   522A ED A0       > ldi
1703   522C ED A0       > ldi
1703   522E ED A0       > ldi
1703   5230 ED A0       > ldi
1703   5232 ED A0       > ldi
1703   5234 ED A0       > ldi
1703   5236 ED A0       > ldi
1703   5238 ED A0       > ldi
1703   523A ED A0       > ldi
1703   523C ED A0       > ldi
1703   523E ED A0       > ldi
1703   5240 ED A0       > ldi
1703   5242 ED A0       > ldi
1703   5244 ED A0       > ldi
1703   5246 ED A0       > ldi
1703   5248 ED A0       > ldi
1703   524A ED A0       > ldi
1703   524C ED A0       > ldi
1703   524E ED A0       > ldi
1703   5250 ED A0       > ldi
1703   5252 ED A0       > ldi
1703   5254 ED A0       > ldi
1703   5256 ED A0       > ldi
1703   5258 ED A0       > ldi
1703   525A ED A0       > ldi
1703   525C ED A0       > ldi
1703   525E ED A0       > ldi
1703   5260 ED A0       > ldi
1703   5262 ED A0       > ldi
1703   5264 ED A0       > ldi
1703   5266 ED A0       > ldi
1703   5268 ED A0       > ldi
1703   526A ED A0       > ldi
1703   526C ED A0       > ldi
1703   526E ED A0       > ldi
1703   5270 ED A0       > ldi
1703   5272 ED A0       > ldi
1703   5274 ED A0       > ldi
1703   5276 ED A0       > ldi
1703   5278 ED A0       > ldi
1703   527A ED A0       > ldi
1703   527C ED A0       > ldi
1703   527E ED A0       > ldi
1703   5280 ED A0       > ldi
1703   5282 ED A0       > ldi
1703   5284 ED A0       > ldi
1703   5286 ED A0       > ldi
1703   5288 ED A0       > ldi
1703   528A ED A0       > ldi
1703   528C ED A0       > ldi
1703   528E ED A0       > ldi
1703   5290 ED A0       > ldi
1703   5292 ED A0       > ldi
1703   5294 ED A0       > ldi
1703   5296 ED A0       > ldi
1703   5298 ED A0       > ldi
1703   529A ED A0       > ldi
1703   529C ED A0       > ldi
1703   529E ED A0       > ldi
1703   52A0 ED A0       > ldi
1703   52A2 ED A0       > ldi
1703   52A4 ED A0       > ldi
1703   52A6 ED A0       > ldi
1703   52A8 ED A0       > ldi
1703   52AA ED A0       > ldi
1703   52AC ED A0       > ldi
1703   52AE ED A0       > ldi
1703   52B0 ED A0       > ldi
1703   52B2 ED A0       > ldi
1703   52B4 ED A0       > ldi
1703   52B6 ED A0       > ldi
1703   52B8 ED A0       > ldi
1703   52BA ED A0       > ldi
1703   52BC ED A0       > ldi
1703   52BE ED A0       > ldi
1703   52C0 ED A0       > ldi
1703   52C2 ED A0       > ldi
1703   52C4 ED A0       > ldi
1703   52C6 ED A0       > ldi
1703   52C8 ED A0       > ldi
1703   52CA ED A0       > ldi
1703   52CC ED A0       > ldi
1703   52CE ED A0       > ldi
1703   52D0 ED A0       > ldi
1703   52D2 ED A0       > ldi
1703   52D4 ED A0       > ldi
1703   52D6 ED A0       > ldi
1703   52D8 ED A0       > ldi
1703   52DA ED A0       > ldi
1703   52DC ED A0       > ldi
1703   52DE ED A0       > ldi
1703   52E0 ED A0       > ldi
1703   52E2 ED A0       > ldi
1703   52E4 ED A0       > ldi
1703   52E6 ED A0       > ldi
1703   52E8 ED A0       > ldi
1703   52EA ED A0       > ldi
1703   52EC ED A0       > ldi
1703   52EE ED A0       > ldi
1703   52F0 ED A0       > ldi
1703   52F2 ED A0       > ldi
1703   52F4 ED A0       > ldi
1703   52F6 ED A0       > ldi
1703   52F8 ED A0       > ldi
1703   52FA ED A0       > ldi
1703   52FC ED A0       > ldi
1703   52FE ED A0       > ldi
1703   5300 ED A0       > ldi
1703   5302 ED A0       > ldi
1703   5304 ED A0       > ldi
1703   5306 ED A0       > ldi
1703   5308 ED A0       > ldi
1703   530A ED A0       > ldi
1703   530C ED A0       > ldi
1703   530E ED A0       > ldi
1703   5310 ED A0       > ldi
1703   5312 ED A0       > ldi
1703   5314 ED A0       > ldi
1703   5316 ED A0       > ldi
1703   5318 ED A0       > ldi
1703   531A ED A0       > ldi
1703   531C ED A0       > ldi
1703   531E ED A0       > ldi
1703   5320 ED A0       > ldi
1703   5322 ED A0       > ldi
1703   5324 ED A0       > ldi
1703   5326 ED A0       > ldi
1703   5328 ED A0       > ldi
1703   532A ED A0       > ldi
1703   532C ED A0       > ldi
1703   532E ED A0       > ldi
1703   5330 ED A0       > ldi
1703   5332 ED A0       > ldi
1703   5334 ED A0       > ldi
1703   5336 ED A0       > ldi
1703   5338 ED A0       > ldi
1703   533A ED A0       > ldi
1703   533C ED A0       > ldi
1703   533E ED A0       > ldi
1704   5340             .part2m: 
1705   5340 EB          	ex	de,hl
1706   5341 3A 00 7B    	ld	a, (SPIDATA)	; descarta CRC
1707   5344 3A 00 7B    	ld	a, (SPIDATA)
1708   5347 FD 7E 32    	ld	a, (iy+WRKAREA.NUMBLOCKS)	; testar se tem mais blocos para ler
1709   534A 3D          	dec	a
1710   534B FD 77 32    	ld	(iy+WRKAREA.NUMBLOCKS), a
1711   534E C2 2F 4F    	jp	nz,.loop
1712   5351 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1713   5353 CD BB 45    	call	SD_SEND_CMD_NO_ARGS
1714   5356 C3 84 57    	jp	.fim
1715   5359             
1716   5359 01 00 02    .r800m:  ld	bc,512
1717   535C ED B0       	ldir
1718   535E 18 E0       	jr	.part2m
1719   5360             
1720   5360 01 00 02    .r800s: 	ld	bc,512
1721   5363 ED B0       	ldir
1722   5365 C3 80 57    	jp	.part2s
1723   5368             
1724   5368             .umBloco: 
1725   5368 3E 51       	ld	a, CMD17	; ler somente um bloco com CMD17 = Read Single Block
1726   536A CD C0 45    	call	SD_SEND_CMD_GET_ERROR
1727   536D DA 11 4F    	jp	c,terminaLeituraEscritaBloco
1728   5370             
1729   5370 CD 1A 46    	call	WAIT_RESP_FE
1730   5373 DA 11 4F    	jp	c,terminaLeituraEscritaBloco
1731   5376 EB          	ex	de,hl
1732   5377             
1733   5377             	; Check for a Z80 or R800
1734   5377             ;	or 	a		; Clear Cy
1735   5377 3E 14       	ld	a,20
1736   5379 ED F9       	db	#ED,#F9		; mulub a,a
1737   537B 21 00 7B    	ld	hl, SPIDATA
1738   537E 38 E0       	jr	c,.r800s	; Use LDIR for R800
1739   5380 ED A0       > ldi
1739   5382 ED A0       > ldi
1739   5384 ED A0       > ldi
1739   5386 ED A0       > ldi
1739   5388 ED A0       > ldi
1739   538A ED A0       > ldi
1739   538C ED A0       > ldi
1739   538E ED A0       > ldi
1739   5390 ED A0       > ldi
1739   5392 ED A0       > ldi
1739   5394 ED A0       > ldi
1739   5396 ED A0       > ldi
1739   5398 ED A0       > ldi
1739   539A ED A0       > ldi
1739   539C ED A0       > ldi
1739   539E ED A0       > ldi
1739   53A0 ED A0       > ldi
1739   53A2 ED A0       > ldi
1739   53A4 ED A0       > ldi
1739   53A6 ED A0       > ldi
1739   53A8 ED A0       > ldi
1739   53AA ED A0       > ldi
1739   53AC ED A0       > ldi
1739   53AE ED A0       > ldi
1739   53B0 ED A0       > ldi
1739   53B2 ED A0       > ldi
1739   53B4 ED A0       > ldi
1739   53B6 ED A0       > ldi
1739   53B8 ED A0       > ldi
1739   53BA ED A0       > ldi
1739   53BC ED A0       > ldi
1739   53BE ED A0       > ldi
1739   53C0 ED A0       > ldi
1739   53C2 ED A0       > ldi
1739   53C4 ED A0       > ldi
1739   53C6 ED A0       > ldi
1739   53C8 ED A0       > ldi
1739   53CA ED A0       > ldi
1739   53CC ED A0       > ldi
1739   53CE ED A0       > ldi
1739   53D0 ED A0       > ldi
1739   53D2 ED A0       > ldi
1739   53D4 ED A0       > ldi
1739   53D6 ED A0       > ldi
1739   53D8 ED A0       > ldi
1739   53DA ED A0       > ldi
1739   53DC ED A0       > ldi
1739   53DE ED A0       > ldi
1739   53E0 ED A0       > ldi
1739   53E2 ED A0       > ldi
1739   53E4 ED A0       > ldi
1739   53E6 ED A0       > ldi
1739   53E8 ED A0       > ldi
1739   53EA ED A0       > ldi
1739   53EC ED A0       > ldi
1739   53EE ED A0       > ldi
1739   53F0 ED A0       > ldi
1739   53F2 ED A0       > ldi
1739   53F4 ED A0       > ldi
1739   53F6 ED A0       > ldi
1739   53F8 ED A0       > ldi
1739   53FA ED A0       > ldi
1739   53FC ED A0       > ldi
1739   53FE ED A0       > ldi
1739   5400 ED A0       > ldi
1739   5402 ED A0       > ldi
1739   5404 ED A0       > ldi
1739   5406 ED A0       > ldi
1739   5408 ED A0       > ldi
1739   540A ED A0       > ldi
1739   540C ED A0       > ldi
1739   540E ED A0       > ldi
1739   5410 ED A0       > ldi
1739   5412 ED A0       > ldi
1739   5414 ED A0       > ldi
1739   5416 ED A0       > ldi
1739   5418 ED A0       > ldi
1739   541A ED A0       > ldi
1739   541C ED A0       > ldi
1739   541E ED A0       > ldi
1739   5420 ED A0       > ldi
1739   5422 ED A0       > ldi
1739   5424 ED A0       > ldi
1739   5426 ED A0       > ldi
1739   5428 ED A0       > ldi
1739   542A ED A0       > ldi
1739   542C ED A0       > ldi
1739   542E ED A0       > ldi
1739   5430 ED A0       > ldi
1739   5432 ED A0       > ldi
1739   5434 ED A0       > ldi
1739   5436 ED A0       > ldi
1739   5438 ED A0       > ldi
1739   543A ED A0       > ldi
1739   543C ED A0       > ldi
1739   543E ED A0       > ldi
1739   5440 ED A0       > ldi
1739   5442 ED A0       > ldi
1739   5444 ED A0       > ldi
1739   5446 ED A0       > ldi
1739   5448 ED A0       > ldi
1739   544A ED A0       > ldi
1739   544C ED A0       > ldi
1739   544E ED A0       > ldi
1739   5450 ED A0       > ldi
1739   5452 ED A0       > ldi
1739   5454 ED A0       > ldi
1739   5456 ED A0       > ldi
1739   5458 ED A0       > ldi
1739   545A ED A0       > ldi
1739   545C ED A0       > ldi
1739   545E ED A0       > ldi
1739   5460 ED A0       > ldi
1739   5462 ED A0       > ldi
1739   5464 ED A0       > ldi
1739   5466 ED A0       > ldi
1739   5468 ED A0       > ldi
1739   546A ED A0       > ldi
1739   546C ED A0       > ldi
1739   546E ED A0       > ldi
1739   5470 ED A0       > ldi
1739   5472 ED A0       > ldi
1739   5474 ED A0       > ldi
1739   5476 ED A0       > ldi
1739   5478 ED A0       > ldi
1739   547A ED A0       > ldi
1739   547C ED A0       > ldi
1739   547E ED A0       > ldi
1739   5480 ED A0       > ldi
1739   5482 ED A0       > ldi
1739   5484 ED A0       > ldi
1739   5486 ED A0       > ldi
1739   5488 ED A0       > ldi
1739   548A ED A0       > ldi
1739   548C ED A0       > ldi
1739   548E ED A0       > ldi
1739   5490 ED A0       > ldi
1739   5492 ED A0       > ldi
1739   5494 ED A0       > ldi
1739   5496 ED A0       > ldi
1739   5498 ED A0       > ldi
1739   549A ED A0       > ldi
1739   549C ED A0       > ldi
1739   549E ED A0       > ldi
1739   54A0 ED A0       > ldi
1739   54A2 ED A0       > ldi
1739   54A4 ED A0       > ldi
1739   54A6 ED A0       > ldi
1739   54A8 ED A0       > ldi
1739   54AA ED A0       > ldi
1739   54AC ED A0       > ldi
1739   54AE ED A0       > ldi
1739   54B0 ED A0       > ldi
1739   54B2 ED A0       > ldi
1739   54B4 ED A0       > ldi
1739   54B6 ED A0       > ldi
1739   54B8 ED A0       > ldi
1739   54BA ED A0       > ldi
1739   54BC ED A0       > ldi
1739   54BE ED A0       > ldi
1739   54C0 ED A0       > ldi
1739   54C2 ED A0       > ldi
1739   54C4 ED A0       > ldi
1739   54C6 ED A0       > ldi
1739   54C8 ED A0       > ldi
1739   54CA ED A0       > ldi
1739   54CC ED A0       > ldi
1739   54CE ED A0       > ldi
1739   54D0 ED A0       > ldi
1739   54D2 ED A0       > ldi
1739   54D4 ED A0       > ldi
1739   54D6 ED A0       > ldi
1739   54D8 ED A0       > ldi
1739   54DA ED A0       > ldi
1739   54DC ED A0       > ldi
1739   54DE ED A0       > ldi
1739   54E0 ED A0       > ldi
1739   54E2 ED A0       > ldi
1739   54E4 ED A0       > ldi
1739   54E6 ED A0       > ldi
1739   54E8 ED A0       > ldi
1739   54EA ED A0       > ldi
1739   54EC ED A0       > ldi
1739   54EE ED A0       > ldi
1739   54F0 ED A0       > ldi
1739   54F2 ED A0       > ldi
1739   54F4 ED A0       > ldi
1739   54F6 ED A0       > ldi
1739   54F8 ED A0       > ldi
1739   54FA ED A0       > ldi
1739   54FC ED A0       > ldi
1739   54FE ED A0       > ldi
1739   5500 ED A0       > ldi
1739   5502 ED A0       > ldi
1739   5504 ED A0       > ldi
1739   5506 ED A0       > ldi
1739   5508 ED A0       > ldi
1739   550A ED A0       > ldi
1739   550C ED A0       > ldi
1739   550E ED A0       > ldi
1739   5510 ED A0       > ldi
1739   5512 ED A0       > ldi
1739   5514 ED A0       > ldi
1739   5516 ED A0       > ldi
1739   5518 ED A0       > ldi
1739   551A ED A0       > ldi
1739   551C ED A0       > ldi
1739   551E ED A0       > ldi
1739   5520 ED A0       > ldi
1739   5522 ED A0       > ldi
1739   5524 ED A0       > ldi
1739   5526 ED A0       > ldi
1739   5528 ED A0       > ldi
1739   552A ED A0       > ldi
1739   552C ED A0       > ldi
1739   552E ED A0       > ldi
1739   5530 ED A0       > ldi
1739   5532 ED A0       > ldi
1739   5534 ED A0       > ldi
1739   5536 ED A0       > ldi
1739   5538 ED A0       > ldi
1739   553A ED A0       > ldi
1739   553C ED A0       > ldi
1739   553E ED A0       > ldi
1739   5540 ED A0       > ldi
1739   5542 ED A0       > ldi
1739   5544 ED A0       > ldi
1739   5546 ED A0       > ldi
1739   5548 ED A0       > ldi
1739   554A ED A0       > ldi
1739   554C ED A0       > ldi
1739   554E ED A0       > ldi
1739   5550 ED A0       > ldi
1739   5552 ED A0       > ldi
1739   5554 ED A0       > ldi
1739   5556 ED A0       > ldi
1739   5558 ED A0       > ldi
1739   555A ED A0       > ldi
1739   555C ED A0       > ldi
1739   555E ED A0       > ldi
1739   5560 ED A0       > ldi
1739   5562 ED A0       > ldi
1739   5564 ED A0       > ldi
1739   5566 ED A0       > ldi
1739   5568 ED A0       > ldi
1739   556A ED A0       > ldi
1739   556C ED A0       > ldi
1739   556E ED A0       > ldi
1739   5570 ED A0       > ldi
1739   5572 ED A0       > ldi
1739   5574 ED A0       > ldi
1739   5576 ED A0       > ldi
1739   5578 ED A0       > ldi
1739   557A ED A0       > ldi
1739   557C ED A0       > ldi
1739   557E ED A0       > ldi
1739   5580 ED A0       > ldi
1739   5582 ED A0       > ldi
1739   5584 ED A0       > ldi
1739   5586 ED A0       > ldi
1739   5588 ED A0       > ldi
1739   558A ED A0       > ldi
1739   558C ED A0       > ldi
1739   558E ED A0       > ldi
1739   5590 ED A0       > ldi
1739   5592 ED A0       > ldi
1739   5594 ED A0       > ldi
1739   5596 ED A0       > ldi
1739   5598 ED A0       > ldi
1739   559A ED A0       > ldi
1739   559C ED A0       > ldi
1739   559E ED A0       > ldi
1739   55A0 ED A0       > ldi
1739   55A2 ED A0       > ldi
1739   55A4 ED A0       > ldi
1739   55A6 ED A0       > ldi
1739   55A8 ED A0       > ldi
1739   55AA ED A0       > ldi
1739   55AC ED A0       > ldi
1739   55AE ED A0       > ldi
1739   55B0 ED A0       > ldi
1739   55B2 ED A0       > ldi
1739   55B4 ED A0       > ldi
1739   55B6 ED A0       > ldi
1739   55B8 ED A0       > ldi
1739   55BA ED A0       > ldi
1739   55BC ED A0       > ldi
1739   55BE ED A0       > ldi
1739   55C0 ED A0       > ldi
1739   55C2 ED A0       > ldi
1739   55C4 ED A0       > ldi
1739   55C6 ED A0       > ldi
1739   55C8 ED A0       > ldi
1739   55CA ED A0       > ldi
1739   55CC ED A0       > ldi
1739   55CE ED A0       > ldi
1739   55D0 ED A0       > ldi
1739   55D2 ED A0       > ldi
1739   55D4 ED A0       > ldi
1739   55D6 ED A0       > ldi
1739   55D8 ED A0       > ldi
1739   55DA ED A0       > ldi
1739   55DC ED A0       > ldi
1739   55DE ED A0       > ldi
1739   55E0 ED A0       > ldi
1739   55E2 ED A0       > ldi
1739   55E4 ED A0       > ldi
1739   55E6 ED A0       > ldi
1739   55E8 ED A0       > ldi
1739   55EA ED A0       > ldi
1739   55EC ED A0       > ldi
1739   55EE ED A0       > ldi
1739   55F0 ED A0       > ldi
1739   55F2 ED A0       > ldi
1739   55F4 ED A0       > ldi
1739   55F6 ED A0       > ldi
1739   55F8 ED A0       > ldi
1739   55FA ED A0       > ldi
1739   55FC ED A0       > ldi
1739   55FE ED A0       > ldi
1739   5600 ED A0       > ldi
1739   5602 ED A0       > ldi
1739   5604 ED A0       > ldi
1739   5606 ED A0       > ldi
1739   5608 ED A0       > ldi
1739   560A ED A0       > ldi
1739   560C ED A0       > ldi
1739   560E ED A0       > ldi
1739   5610 ED A0       > ldi
1739   5612 ED A0       > ldi
1739   5614 ED A0       > ldi
1739   5616 ED A0       > ldi
1739   5618 ED A0       > ldi
1739   561A ED A0       > ldi
1739   561C ED A0       > ldi
1739   561E ED A0       > ldi
1739   5620 ED A0       > ldi
1739   5622 ED A0       > ldi
1739   5624 ED A0       > ldi
1739   5626 ED A0       > ldi
1739   5628 ED A0       > ldi
1739   562A ED A0       > ldi
1739   562C ED A0       > ldi
1739   562E ED A0       > ldi
1739   5630 ED A0       > ldi
1739   5632 ED A0       > ldi
1739   5634 ED A0       > ldi
1739   5636 ED A0       > ldi
1739   5638 ED A0       > ldi
1739   563A ED A0       > ldi
1739   563C ED A0       > ldi
1739   563E ED A0       > ldi
1739   5640 ED A0       > ldi
1739   5642 ED A0       > ldi
1739   5644 ED A0       > ldi
1739   5646 ED A0       > ldi
1739   5648 ED A0       > ldi
1739   564A ED A0       > ldi
1739   564C ED A0       > ldi
1739   564E ED A0       > ldi
1739   5650 ED A0       > ldi
1739   5652 ED A0       > ldi
1739   5654 ED A0       > ldi
1739   5656 ED A0       > ldi
1739   5658 ED A0       > ldi
1739   565A ED A0       > ldi
1739   565C ED A0       > ldi
1739   565E ED A0       > ldi
1739   5660 ED A0       > ldi
1739   5662 ED A0       > ldi
1739   5664 ED A0       > ldi
1739   5666 ED A0       > ldi
1739   5668 ED A0       > ldi
1739   566A ED A0       > ldi
1739   566C ED A0       > ldi
1739   566E ED A0       > ldi
1739   5670 ED A0       > ldi
1739   5672 ED A0       > ldi
1739   5674 ED A0       > ldi
1739   5676 ED A0       > ldi
1739   5678 ED A0       > ldi
1739   567A ED A0       > ldi
1739   567C ED A0       > ldi
1739   567E ED A0       > ldi
1739   5680 ED A0       > ldi
1739   5682 ED A0       > ldi
1739   5684 ED A0       > ldi
1739   5686 ED A0       > ldi
1739   5688 ED A0       > ldi
1739   568A ED A0       > ldi
1739   568C ED A0       > ldi
1739   568E ED A0       > ldi
1739   5690 ED A0       > ldi
1739   5692 ED A0       > ldi
1739   5694 ED A0       > ldi
1739   5696 ED A0       > ldi
1739   5698 ED A0       > ldi
1739   569A ED A0       > ldi
1739   569C ED A0       > ldi
1739   569E ED A0       > ldi
1739   56A0 ED A0       > ldi
1739   56A2 ED A0       > ldi
1739   56A4 ED A0       > ldi
1739   56A6 ED A0       > ldi
1739   56A8 ED A0       > ldi
1739   56AA ED A0       > ldi
1739   56AC ED A0       > ldi
1739   56AE ED A0       > ldi
1739   56B0 ED A0       > ldi
1739   56B2 ED A0       > ldi
1739   56B4 ED A0       > ldi
1739   56B6 ED A0       > ldi
1739   56B8 ED A0       > ldi
1739   56BA ED A0       > ldi
1739   56BC ED A0       > ldi
1739   56BE ED A0       > ldi
1739   56C0 ED A0       > ldi
1739   56C2 ED A0       > ldi
1739   56C4 ED A0       > ldi
1739   56C6 ED A0       > ldi
1739   56C8 ED A0       > ldi
1739   56CA ED A0       > ldi
1739   56CC ED A0       > ldi
1739   56CE ED A0       > ldi
1739   56D0 ED A0       > ldi
1739   56D2 ED A0       > ldi
1739   56D4 ED A0       > ldi
1739   56D6 ED A0       > ldi
1739   56D8 ED A0       > ldi
1739   56DA ED A0       > ldi
1739   56DC ED A0       > ldi
1739   56DE ED A0       > ldi
1739   56E0 ED A0       > ldi
1739   56E2 ED A0       > ldi
1739   56E4 ED A0       > ldi
1739   56E6 ED A0       > ldi
1739   56E8 ED A0       > ldi
1739   56EA ED A0       > ldi
1739   56EC ED A0       > ldi
1739   56EE ED A0       > ldi
1739   56F0 ED A0       > ldi
1739   56F2 ED A0       > ldi
1739   56F4 ED A0       > ldi
1739   56F6 ED A0       > ldi
1739   56F8 ED A0       > ldi
1739   56FA ED A0       > ldi
1739   56FC ED A0       > ldi
1739   56FE ED A0       > ldi
1739   5700 ED A0       > ldi
1739   5702 ED A0       > ldi
1739   5704 ED A0       > ldi
1739   5706 ED A0       > ldi
1739   5708 ED A0       > ldi
1739   570A ED A0       > ldi
1739   570C ED A0       > ldi
1739   570E ED A0       > ldi
1739   5710 ED A0       > ldi
1739   5712 ED A0       > ldi
1739   5714 ED A0       > ldi
1739   5716 ED A0       > ldi
1739   5718 ED A0       > ldi
1739   571A ED A0       > ldi
1739   571C ED A0       > ldi
1739   571E ED A0       > ldi
1739   5720 ED A0       > ldi
1739   5722 ED A0       > ldi
1739   5724 ED A0       > ldi
1739   5726 ED A0       > ldi
1739   5728 ED A0       > ldi
1739   572A ED A0       > ldi
1739   572C ED A0       > ldi
1739   572E ED A0       > ldi
1739   5730 ED A0       > ldi
1739   5732 ED A0       > ldi
1739   5734 ED A0       > ldi
1739   5736 ED A0       > ldi
1739   5738 ED A0       > ldi
1739   573A ED A0       > ldi
1739   573C ED A0       > ldi
1739   573E ED A0       > ldi
1739   5740 ED A0       > ldi
1739   5742 ED A0       > ldi
1739   5744 ED A0       > ldi
1739   5746 ED A0       > ldi
1739   5748 ED A0       > ldi
1739   574A ED A0       > ldi
1739   574C ED A0       > ldi
1739   574E ED A0       > ldi
1739   5750 ED A0       > ldi
1739   5752 ED A0       > ldi
1739   5754 ED A0       > ldi
1739   5756 ED A0       > ldi
1739   5758 ED A0       > ldi
1739   575A ED A0       > ldi
1739   575C ED A0       > ldi
1739   575E ED A0       > ldi
1739   5760 ED A0       > ldi
1739   5762 ED A0       > ldi
1739   5764 ED A0       > ldi
1739   5766 ED A0       > ldi
1739   5768 ED A0       > ldi
1739   576A ED A0       > ldi
1739   576C ED A0       > ldi
1739   576E ED A0       > ldi
1739   5770 ED A0       > ldi
1739   5772 ED A0       > ldi
1739   5774 ED A0       > ldi
1739   5776 ED A0       > ldi
1739   5778 ED A0       > ldi
1739   577A ED A0       > ldi
1739   577C ED A0       > ldi
1739   577E ED A0       > ldi
1740   5780             .part2s: 
1741   5780 EB          	ex	de,hl
1742   5781 3A 00 7B    	ld	a, (SPIDATA)	; descarta CRC
1743   5784             .fim: 
1744   5784 AF          	xor	a		; zera carry para informar leitura sem erros
1745   5785 C3 11 4F    	jp	terminaLeituraEscritaBloco
1746   5788             
1747   5788             
1748   5788             ; ------------------------------------------------
1749   5788             ; Converte blocos para bytes. Na pratica faz
1750   5788             ; BC DE = (BC DE) * 512
1751   5788             ; ------------------------------------------------
1752   5788             blocoParaByte: 
1753   5788 41          	ld	b, c
1754   5789 4A          	ld	c, d
1755   578A 53          	ld	d, e
1756   578B 1E 00       	ld	e, 0
1757   578D CB 22       	sla	d
1758   578F CB 11       	rl	c
1759   5791 CB 10       	rl	b
1760   5793 C9          	ret
1761   5794             
1762   5794             ; ------------------------------------------------
1763   5794             ; Funcoes utilitarias
1764   5794             ; ------------------------------------------------
1765   5794             
1766   5794             
1767   5794             ; ------------------------------------------------
1768   5794             ; Imprime string na tela apontada por DE
1769   5794             ; Destroi todos os registradores
1770   5794             ; ------------------------------------------------
1771   5794             printString: 
1772   5794 1A          	ld	a, (de)
1773   5795 B7          	or	a
1774   5796 C8          	ret	z
1775   5797 CD A2 00    	call	CHPUT
1776   579A 13          	inc	de
1777   579B 18 F7       	jr	printString
1778   579D             
1779   579D             
1780   579D             ; ------------------------------------------------
1781   579D             ; Converte o byte em A para string em decimal no
1782   579D             ; buffer apontado por DE
1783   579D             ; Destroi AF, BC, HL, DE
1784   579D             ; ------------------------------------------------
1785   579D             DecToAscii: 
1786   579D 26 00       	ld	h, 0
1787   579F 6F          	ld	l, a		; copiar A para HL
1788   57A0 FD 36 39 01 	ld	(iy+WRKAREA.TEMP),1	; flag para indicar que devemos cortar os zeros a esquerda
1789   57A4 01 9C FF    	ld	bc, -100	; centenas
1790   57A7 CD B5 57    	call	.num1
1791   57AA 0E F6       	ld	c, -10		; dezenas
1792   57AC CD B5 57    	call	.num1
1793   57AF FD 36 39 02 	ld	(iy+WRKAREA.TEMP),2	; unidade deve exibir 0 se for zero e nao corta-lo
1794   57B3 0E FF       	ld	c, -1		; unidades
1795   57B5             .num1: 
1796   57B5 3E 2F       	ld	a, '0'-1
1797   57B7             .num2: 
1798   57B7 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1799   57B8 09          	add	hl, bc		; somar com negativo
1800   57B9 38 FC       	jr	c,.num2		; ainda nao zeramos
1801   57BB ED 42       	sbc	hl, bc		; retoma valor original
1802   57BD FD 35 39    	dec	(iy+WRKAREA.TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1803   57C0 20 08       	jr	nz,.naozero
1804   57C2 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1805   57C4 20 04       	jr	nz,.naozero
1806   57C6 FD 34 39    	inc	(iy+WRKAREA.TEMP)	; se for zero, nao salvamos e voltamos a flag
1807   57C9 C9          	ret
1808   57CA             .naozero: 
1809   57CA 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1810   57CB 13          	inc	de		; incrementa ponteiro de destino
1811   57CC C9          	ret
1812   57CD             
1813   57CD             ; ------------------------------------------------
1814   57CD             ; Converte o byte em A para string em hexa no
1815   57CD             ; buffer apontado por DE
1816   57CD             ; Destroi AF, C, DE
1817   57CD             ; ------------------------------------------------
1818   57CD             HexToAscii: 
1819   57CD 4F          	ld	c, a
1820   57CE 1F          	rra
1821   57CF 1F          	rra
1822   57D0 1F          	rra
1823   57D1 1F          	rra
1824   57D2 CD D6 57    	call	.conv
1825   57D5 79          	ld  	a, c
1826   57D6             .conv: 
1827   57D6 E6 0F       	and	$0F
1828   57D8 C6 90       	add	a, $90
1829   57DA 27          	daa
1830   57DB CE 40       	adc	a, $40
1831   57DD 27          	daa
1832   57DE 12          	ld	(de), a
1833   57DF 13          	inc	de
1834   57E0 C9          	ret
1835   57E1             
1836   57E1             ; ------------------------------------------------
1837   57E1             ; Converte o byte em A para string em decimal e
1838   57E1             ; imprime na tela
1839   57E1             ; Destroi AF, BC, HL, DE
1840   57E1             ; ------------------------------------------------
1841   57E1             printDecToAscii: 
1842   57E1 26 00       	ld	h, 0
1843   57E3 6F          	ld	l, a		; copiar A para HL
1844   57E4 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1845   57E6 11 9C FF    	ld	de, -100	; centenas
1846   57E9 CD F5 57    	call	.num1
1847   57EC 1E F6       	ld	e, -10		; dezenas
1848   57EE CD F5 57    	call	.num1
1849   57F1 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1850   57F3 1E FF       	ld	e, -1		; unidades
1851   57F5             .num1: 
1852   57F5 3E 2F       	ld	a, '0'-1
1853   57F7             .num2: 
1854   57F7 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1855   57F8 19          	add	hl, de		; somar com negativo
1856   57F9 38 FC       	jr	c,.num2		; ainda nao zeramos
1857   57FB ED 52       	sbc	hl, de		; retoma valor original
1858   57FD 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1859   57FF FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1860   5801 20 02       	jr	nz,.naozero
1861   5803 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1862   5804 C9          	ret
1863   5805             .naozero: 
1864   5805 E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1865   5806 C5          	push	bc
1866   5807 CD A2 00    	call	CHPUT
1867   580A C1          	pop	bc
1868   580B E1          	pop	hl
1869   580C C9          	ret
1870   580D             
1871   580D             ; ------------------------------------------------
1872   580D             ; Procura pelo nome do fabricante em uma tabela.
1873   580D             ; A contem o byte do fabricante
1874   580D             ; Devolve HL apontando para o buffer do fabricante
1875   580D             ; e BC com o comprimento do texto
1876   580D             ; Destroi AF, BC, HL
1877   580D             ; ------------------------------------------------
1878   580D             pegaFabricante: 
1879   580D 4F          	ld	c, a
1880   580E 21 2F 58    	ld	hl, tblFabricantes
1881   5811             
1882   5811             .loop: 
1883   5811 7E          	ld	a, (hl)
1884   5812 23          	inc	hl
1885   5813 B9          	cp	c
1886   5814 28 0C       	jr	z,.achado
1887   5816 B7          	or	a
1888   5817 28 09       	jr	z,.achado
1889   5819 C5          	push	bc
1890   581A CD 22 58    	call	.achado
1891   581D 09          	add	hl, bc
1892   581E 23          	inc	hl
1893   581F C1          	pop	bc
1894   5820 18 EF       	jr	.loop
1895   5822             
1896   5822             .achado: 
1897   5822 0E 00       	ld	c, 0
1898   5824 E5          	push	hl
1899   5825 AF          	xor	a
1900   5826             .loop2: 
1901   5826 0C          	inc	c
1902   5827 23          	inc	hl
1903   5828 BE          	cp	(hl)
1904   5829 20 FB       	jr	nz,.loop2
1905   582B E1          	pop	hl
1906   582C 06 00       	ld	b, 0
1907   582E C9          	ret
1908   582F             
1909   582F             tblFabricantes: 
1910   582F 01          	db	1
1911   5830             	db	"Panasonic",0
1911   5830 50616E61736F6E696300
1912   583A 02          	db	2
1913   583B             	db	"Toshiba",0
1913   583B 546F736869626100
1914   5843 03          	db	3
1915   5844             	db	"SanDisk",0
1915   5844 53616E4469736B00
1916   584C 04          	db	4
1917   584D             	db	"SMI-S",0
1917   584D 534D492D5300
1918   5853 06          	db	6
1919   5854             	db	"Renesas",0
1919   5854 52656E6573617300
1920   585C 11          	db	17
1921   585D             	db	"Dane-Elec",0
1921   585D 44616E652D456C656300
1922   5867 13          	db	19
1923   5868             	db	"KingMax",0
1923   5868 4B696E674D617800
1924   5870 15          	db	21
1925   5871             	db	"Samsung",0
1925   5871 53616D73756E6700
1926   5879 18          	db	24
1927   587A             	db	"Infineon",0
1927   587A 496E66696E656F6E00
1928   5883 1A          	db	26
1929   5884 50 51 49 00 	db	"PQI",0
1930   5888 1B          	db	27
1931   5889 536F6E7900  	db	"Sony",0
1932   588E 1C          	db	28
1933   588F             	db	"Transcend",0
1933   588F 5472616E7363656E6400
1934   5899 1D          	db	29
1935   589A             	db	"A-DATA",0
1935   589A 412D4441544100
1936   58A1 1F          	db	31
1937   58A2             	db	"SiliconPower",0
1937   58A2 53696C69636F6E506F77657200
1938   58AF 27          	db	39
1939   58B0             	db	"Verbatim",0
1939   58B0 566572626174696D00
1940   58B9 41          	db	65
1941   58BA 4F 4B 49 00 	db	"OKI",0
1942   58BE 73          	db	115
1943   58BF             	db	"SilverHT",0
1943   58BF 53696C766572485400
1944   58C8 89          	db	137
1945   58C9             	db	"L.Data",0
1945   58C9 4C2E4461746100
1946   58D0 00          	db	0
1947   58D1             	db	"Generico",0
1947   58D1 47656E657269636F00
1948   58DA             
1949   58DA             
1950   58DA             ; ------------------------------------------------
1951   58DA             ; Restore screen parameters on MSX>=2 if they're
1952   58DA             ; not set yet
1953   58DA             ; ------------------------------------------------
1954   58DA             MYSETSCR: 
1955   58DA 3A 2D 00    	ld	a,(MSXVER)
1956   58DD B7          	or	a			; MSX1?
1957   58DE 20 08       	jr	nz,.notMSX1		; No, skip
1958   58E0             .MSX1: 
1959   58E0 3A AF FC    	ld	a,(SCRMOD)
1960   58E3 B7          	or	a			; SCREEN0 already?
1961   58E4 C8          	ret	z			; Yes, quit
1962   58E5 C3 6C 00    	jp	INITXT			; set screen0
1963   58E8             
1964   58E8             .notMSX1: 
1965   58E8 0E 23       	ld	c,$23			; Block-2, R#3
1966   58EA DD 21 F5 01 	ld 	ix,REDCLK
1967   58EE CD 5F 01    	call	EXTROM
1968   58F1 E6 01       	and	1
1969   58F3 47          	ld	b,a
1970   58F4 3A AF FC    	ld	a,(SCRMOD)
1971   58F7 B8          	cp	b
1972   58F8 20 1C       	jr	nz,.restore
1973   58FA 0C          	inc	c
1974   58FB DD 21 F5 01 	ld 	ix,REDCLK
1975   58FF CD 5F 01    	call	EXTROM
1976   5902 47          	ld	b,a
1977   5903 0C          	inc	c
1978   5904 DD 21 F5 01 	ld 	ix,REDCLK
1979   5908 CD 5F 01    	call	EXTROM
1980   590B 87          	add	a,a
1981   590C 87          	add	a,a
1982   590D 87          	add	a,a
1983   590E 87          	add	a,a
1984   590F B0          	or	b
1985   5910 47          	ld	b,a
1986   5911 3A B0 F3    	ld	a,(LINLEN)
1987   5914 B8          	cp	b
1988   5915 C8          	ret	z
1989   5916             .restore: 
1990   5916 AF          	xor	a		; Don't displat the function keys
1991   5917 DD 21 85 01 	ld	ix,SDFSCR
1992   591B C3 5F 01    	jp	EXTROM
1993   591E             
1994   591E             ; ------------------------------------------------
1995   591E             ; Check if the STOP key was signaled on DRV_INIT
1996   591E             ; ------------------------------------------------
1997   591E             INICHKSTOP: 
1998   591E 3A 9B FC    	ld	a,(INTFLG)
1999   5921 FE 04       	cp	4			; Was STOP pressed?
2000   5923 C0          	ret	nz			; No, quit as fast as possible 
2001   5924             
2002   5924             	; Handle STOP to pause and read messages, and ask for the copyright info
2003   5924 11 AE 59    	ld	de,strBootpaused
2004   5927 CD 94 57    	call	printString
2005   592A 3E 07       .wait1: 	ld	a,7
2006   592C CD 41 01    	call	SNSMAT
2007   592F E6 10       	and	$10			; Is STOP still pressed?
2008   5931 28 F7       	jr	z,.wait1		; Wait for STOP to be released
2009   5933 AF          	xor	a
2010   5934 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
2011   5937 06 00       	ld	b,0			; b=inhibit 'i' key flag
2012   5939 CD 9C 00    .wait2:  call	CHSNS
2013   593C C4 59 59    	call	nz,.chkikey		; Wait until a key is pressed
2014   593F 3A 9B FC    	ld	a,(INTFLG)
2015   5942 FE 04       	cp	4			; Was STOP pressed?
2016   5944 20 F3       	jr	nz,.wait2		; No, return
2017   5946 AF          	xor	a
2018   5947 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
2019   594A CD 56 01    	call	KILBUF
2020   594D 06 1E       	ld	b,30			; Since the user is trying pause the
2021   594F 76          .wait3: 	halt				; boot messages, this gives him enough
2022   5950             					; time to react and pause the next
2023   5950             					; driver
2024   5950 3A 9B FC    	ld	a,(INTFLG)
2025   5953 FE 04       	cp	4			; Was STOP pressed?
2026   5955 C8          	ret	z			; quit so the next driver can process it
2027   5956 10 F7       	djnz	.wait3			; The user will have the impression
2028   5958             					; that he has a perfect timing.   ;)
2029   5958 C9          	ret
2030   5959             
2031   5959             .chkikey: 
2032   5959 CB 40       	bit	0,b			; Was the copyright message shown?
2033   595B C0          	ret	nz			; Yes, return
2034   595C CD 9F 00    	call	CHGET
2035   595F FE 69       	cp	'i'
2036   5961 28 03       	jr	z,.showcopyright
2037   5963 FE 49       	cp	'I'
2038   5965 C0          	ret	nz
2039   5966             .showcopyright: 
2040   5966 04          	inc	b			; Inhibit further presses of the i key 
2041   5967 11 DE 59    	ld	de,strCopyright
2042   596A C3 94 57    	jp	printString
2043   596D             
2044   596D             
2045   596D             
2046   596D             ; ------------------------------------------------
2047   596D             ; Install the R800 data transfer helper routine on WorkArea 
2048   596D             ; ------------------------------------------------
2049   596D             INSTR800HLP: 
2050   596D 3A 2D 00    	ld	a,(MSXVER)
2051   5970 FE 03       	cp	3		; MSX Turbo-R?
2052   5972 D8          	ret	c		; No, return
2053   5973 CD 80 59    	call	GTR800LDIR
2054   5976 EB          	ex	de,hl
2055   5977 21 88 59    	ld	hl,R800DATHLP
2056   597A 01 07 00    	ld	bc,R800DATHLP.end-R800DATHLP
2057   597D ED B0       	ldir
2058   597F C9          	ret
2059   5980             
2060   5980             ; ------------------------------------------------
2061   5980             ; Obtain the pointer to the R800 data transfer helper routine
2062   5980             ; Input   : IY=Pointer to the WorkArea
2063   5980             ; Output  : HL=pointer to R800 data transfer helper routine 
2064   5980             ; Modifies: DE
2065   5980             ; ------------------------------------------------
2066   5980             GTR800LDIR: 
2067   5980 FD E5       	push	iy
2068   5982 E1          	pop	hl			; hl=WorkArea
2069   5983 11 3A 00    	ld	de,WRKAREA.TRLDIR
2070   5986 19          	add	hl,de
2071   5987 C9          	ret
2072   5988             
2073   5988             ; ------------------------------------------------
2074   5988             ; R800 data transfer routine, copied to the WorkArea
2075   5988             ; ------------------------------------------------
2076   5988             R800DATHLP: 
2077   5988 D9          	exx
2078   5989 01 00 02    	ld	bc,512
2079   598C ED B0       	ldir
2080   598E C9          	ret
2081   598F             .end
2082   598F              
2083   598F             
2084   598F             
2085   598F             ; ==========================================================================
2086   598F             strTitle: 
2087   598F             	db	13,"FBLabs SDHC driver ",27,'J'
2087   598F 0D46424C616273205344484320647269766572201B4A
2088   59A5             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
2088   59A5 76312E302E38
2089   59AB 0D 0A 00    	db	13,10,0
2090   59AE             
2091   59AE             strBootpaused: 
2092   59AE             	db	"Paused. Press <i> to show the copyright info.",13,10,0
2092   59AE 5061757365642E205072657373203C693E20746F2073686F772074686520636F
2092   59CE 7079726967687420696E666F2E0D0A00
2093   59DE             
2094   59DE             strCopyright: 
2095   59DE             	db	"(c) 2014 Fabio Belavenuto",13,10
2095   59DE 286329203230313420466162696F2042656C6176656E75746F0D0A
2096   59F9             	db	"(c) 2017 FRS",13,10
2096   59F9 2863292032303137204652530D0A
2097   5A07             	db	"Licenced under CERN OHL v1.1",13,10
2097   5A07 4C6963656E63656420756E646572204345524E204F484C2076312E310D0A
2098   5A25             	db	"http://ohwr.org/cernohl",13,10
2098   5A25 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
2099   5A3E             	db	"PCB designed by Luciano Sturaro",13,10
2099   5A3E 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
2099   5A5E 0A
2100   5A5F             	; fall throw
2101   5A5F             strCrLf: 
2102   5A5F 0D 0A 00    	db	13,10,0
2103   5A62             strCartao: 
2104   5A62             	db	"Slot ",0
2104   5A62 536C6F742000
2105   5A68             strVazio: 
2106   5A68             	db	"Empty",13,10,0
2106   5A68 456D7074790D0A00
2107   5A70             strNaoIdentificado: 
2108   5A70             	db	"Unknown!",13,10,0
2108   5A70 556E6B6E6F776E210D0A00
2109   5A7B             			;----------------------------------------
2110   5A7B             strMr_mp_desativada: 
2111   5A7B             	db	"Slot expander/Mapper/MegaRAM disabled",13,10,0
2111   5A7B 536C6F7420657870616E6465722F4D61707065722F4D65676152414D20646973
2111   5A9B 61626C65640D0A00
2112   5AA3             strDrvMain: 
2113   5AA3             	db	"Driver main selected",13,10,0
2113   5AA3 447269766572206D61696E2073656C65637465640D0A00
2114   5ABA             strDrvDev: 
2115   5ABA             	db	"Driver development selected",13,10,0
2115   5ABA 44726976657220646576656C6F706D656E742073656C65637465640D0A00
2116   5AD8             strSDV1: 
2117   5AD8             	db	"SDV1 - ",0
2117   5AD8 53445631202D2000
2118   5AE0             strSDV2: 
2119   5AE0             	db	"SDV2 - ",0
2119   5AE0 53445632202D2000
2120   5AE8             
2121   5AE8             ;-----------------------------------------------------------------------------
2122   5AE8             ;
2123   5AE8             ; End of the driver code
2124   5AE8             
2125   5AE8             DRV_END: 
2126   5AE8             
2127   5AE8             ;	ds	3ED0h-(DRV_END-DRV_START), $FF
2128   5AE8 FF          	ds	$7B00-$, #FF
2129   7B00             
2130   7B00             
