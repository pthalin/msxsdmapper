0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 7B00h~7EFFh	: SPI data transfer window (read/write)
0015   0000             ; 7F00h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	b0	: 0=SD card present on slot-0
0018   0000             ;	b1	: 0=SD card present on slot-1
0019   0000             ;	b2	: 0=Write protecton enabled for SD card slot-0
0020   0000             ;	b3	: 0=Write protecton enabled for SD card slot-1
0021   0000             ;	b4	: SW0 status. 0=RAM enabled, 1=RAM disabled
0022   0000             ;	b5	: SW1 status. 0=RAM mode: MegaRAM, 1=RAM mode: Memory Mapper
0023   0000             ;	b6	: Reserved for future use. Must be masked out from readings.
0024   0000             ;	b7	: 1=SPI transfer busy. 0=No ongoing SPI transfer
0025   0000             ;	<write>
0026   0000             ;	b0	: SD card slot-0 chip-select (0=selected)
0027   0000             ;	b1	: SD card slot-1 chip-select (0=selected)
0028   0000             
0029   0000             ; 7F01h		: Mode configuration register (write only)
0030   0000             ;	b0	: 0=ROM mode, SPI interface disabled, 1=SPI interface enabled
0031   0000             
0032   0000             
0033   0000             
0034   0000             	output	"driver.bin"
0035   0000             
0036   0000             ;-----------------------------------------------------------------------------
0037   0000             ;
0038   0000             ; Driver configuration constants
0039   0000             ;
0040   0000             
0041   0000             ;Driver type:
0042   0000             ;   0 for drive-based
0043   0000             ;   1 for device-based
0044   0000             
0045   0000             DRV_TYPE	equ	1
0046   0000             
0047   0000             ;Hot-plug devices support (device-based drivers only):
0048   0000             ;   0 for no hot-plug support
0049   0000             ;   1 for hot-plug support
0050   0000             
0051   0000             DRV_HOTPLUG	equ	0
0052   0000             
0053   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0054   0000             
0055   0000             ;Driver version
0056   0000             
0057   0000             VER_MAIN	equ	1
0058   0000             VER_SEC		equ	0
0059   0000             VER_REV		equ	6
0060   0000             
0061   0000             ;-----------------------------------------------------------------------------
0062   0000             ; Enderecos SPI
0063   0000             
0064   0000             SPIDATA		= $7B00
0065   0000             SPICTRL		= $7F00
0066   0000             SPISTATUS	= $7F00
0067   0000             SPIMODE		= $7F01
0068   0000             
0069   0000             ; Comandos SPI:
0070   0000             CMD0	= 0  | $40
0071   0000             CMD1	= 1  | $40
0072   0000             CMD8	= 8  | $40
0073   0000             CMD9	= 9  | $40
0074   0000             CMD10	= 10 | $40
0075   0000             CMD12	= 12 | $40
0076   0000             CMD16	= 16 | $40
0077   0000             CMD17	= 17 | $40
0078   0000             CMD18	= 18 | $40
0079   0000             CMD24	= 24 | $40
0080   0000             CMD25	= 25 | $40
0081   0000             CMD55	= 55 | $40
0082   0000             CMD58	= 58 | $40
0083   0000             ACMD23	= 23 | $40
0084   0000             ACMD41	= 41 | $40
0085   0000             
0086   0000             ; Offsets da area de trabalho
0087   0000             
0088   0000             BCSD 		= 0
0089   0000             BCID1		= 16
0090   0000             BCID2		= 32
0091   0000             NUMSD		= 48	; 1 se cartao 1, 2 se cartao 2
0092   0000             FLAGSCARTAO	= 49	; Flag indicando se houve mudanca ou erro de cartao
0093   0000             NUMBLOCOS	= 50	; 1 byte
0094   0000             TEMP		= 52	; 1 byte
0095   0000             BLOCOS1		= 56	; 3 bytes
0096   0000             BLOCOS2		= 60	; 3 bytes
0097   0000             
0098   0000             
0099   0000             
0100   0000             ;-----------------------------------------------------------------------------
0101   0000             ;
0102   0000             ; Standard BIOS and work area entries
0103   0000             INITXT	= $006C		; Inicializa SCREEN0
0104   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0105   0000             CHGET	= $009F		; Get character from keyboard buffer
0106   0000             CHPUT	= $00A2		; A=char
0107   0000             CLS	= $00C3		; Chamar com A=0
0108   0000             ERAFNK	= $00CC		; Erase function key display
0109   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0110   0000             KILBUF	= $0156		; Clear keyboard buffer
0111   0000             EXTROM	= $015F
0112   0000             
0113   0000             ; subROM functions
0114   0000             SDFSCR	= $0185
0115   0000             REDCLK	= $01F5
0116   0000             
0117   0000             
0118   0000             ; System variables
0119   0000             MSXVER	= $002D
0120   0000             LINL40	= $F3AE		; Width
0121   0000             LINLEN	= $F3B0
0122   0000             INTFLG	= $FC9B
0123   0000             SCRMOD	= $FCAF
0124   0000             
0125   0000             
0126   0000             ;-----------------------------------------------------------------------------
0127   0000             
0128   0000             
0129   0000             	org		$4000
0130   4000             
0131   4000 FF          	ds		256, $FF		; 256 dummy bytes
0132   4100             
0133   4100             DRV_START: 
0134   4100             
0135   4100             ;-----------------------------------------------------------------------------
0136   4100             ;
0137   4100             ; Miscellaneous constants
0138   4100             ;
0139   4100             
0140   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0141   4100             ;It is used by some of the kernel page 0 routines.
0142   4100             
0143   4100             CODE_ADD: 	equ	0F84Ch
0144   4100             
0145   4100             
0146   4100             ;-----------------------------------------------------------------------------
0147   4100             ;
0148   4100             ; Error codes for DEV_RW
0149   4100             ;
0150   4100             
0151   4100             ENCOMP	equ	0FFh
0152   4100             EWRERR	equ	0FEh
0153   4100             EDISK	equ	0FDh
0154   4100             ENRDY	equ	0FCh
0155   4100             EDATA	equ	0FAh
0156   4100             ERNF	equ	0F9h
0157   4100             EWPROT	equ	0F8h
0158   4100             EUFORM	equ	0F7h
0159   4100             ESEEK	equ	0F3h
0160   4100             EIFORM	equ	0F0h
0161   4100             EIDEVL	equ	0B5h
0162   4100             EIPARM	equ	08Bh
0163   4100             
0164   4100             ;-----------------------------------------------------------------------------
0165   4100             ;
0166   4100             ; Routines and information available on kernel page 0
0167   4100             ;
0168   4100             
0169   4100             ;* Get in A the current slot for page 1. Corrupts F.
0170   4100             ;  Must be called by using CALBNK to bank 0:
0171   4100             ;    xor a
0172   4100             ;    ld ix,GSLOT1
0173   4100             ;    call CALBNK
0174   4100             
0175   4100             GSLOT1	equ	402Dh
0176   4100             
0177   4100             
0178   4100             ;* This routine reads a byte from another bank.
0179   4100             ;  Must be called by using CALBNK to the desired bank,
0180   4100             ;  passing the address to be read in HL:
0181   4100             ;    ld a,<bank number>
0182   4100             ;    ld hl,<byte address>
0183   4100             ;    ld ix,RDBANK
0184   4100             ;    call CALBNK
0185   4100             
0186   4100             RDBANK	equ	403Ch
0187   4100             
0188   4100             
0189   4100             ;* This routine temporarily switches kernel main bank
0190   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0191   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0192   4100             ;  It is necessary to use this routine to invoke CALBAS
0193   4100             ;  (so that kernel bank is correct in case of BASIC error)
0194   4100             ;  and to invoke DOS functions via F37Dh hook.
0195   4100             ;
0196   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0197   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0198   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0199   4100             
0200   4100             CALLB0	equ	403Fh
0201   4100             
0202   4100             
0203   4100             ;* Call a routine in another bank.
0204   4100             ;  Must be used if the driver spawns across more than one bank.
0205   4100             ;
0206   4100             ;  Input:  A = bank number
0207   4100             ;          IX = routine address
0208   4100             ;          AF' = AF for the routine
0209   4100             ;          HL' = Ix for the routine
0210   4100             ;          BC, DE, HL, IY = input for the routine
0211   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0212   4100             
0213   4100             CALBNK	equ	4042h
0214   4100             
0215   4100             
0216   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0217   4100             ;  which will in turn contain a pointer to the allocated page 3
0218   4100             ;  work area for that slot (0 if no work area was allocated).
0219   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0220   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0221   4100             ;  Corrupts F.
0222   4100             ;  Must be called by using CALBNK to bank 0:
0223   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0224   4100             ;    ex af,af'
0225   4100             ;    xor a
0226   4100             ;    ld ix,GWORK
0227   4100             ;    call CALBNK
0228   4100             
0229   4100             GWORK	equ	4045h
0230   4100             
0231   4100             
0232   4100             ;* This address contains one byte that tells how many banks
0233   4100             ;  form the Nextor kernel (or alternatively, the first bank
0234   4100             ;  number of the driver).
0235   4100             
0236   4100             K_SIZE	equ	40FEh
0237   4100             
0238   4100             
0239   4100             ;* This address contains one byte with the current bank number.
0240   4100             
0241   4100             CUR_BANK	equ	40FFh
0242   4100             
0243   4100             
0244   4100             ;-----------------------------------------------------------------------------
0245   4100             ;
0246   4100             ; Built-in format choice strings
0247   4100             ;
0248   4100             
0249   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0250   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0251   4100             
0252   4100             
0253   4100             ;-----------------------------------------------------------------------------
0254   4100             ;
0255   4100             ; Driver signature
0256   4100             ;
0257   4100             	db	"NEXTOR_DRIVER",0
0257   4100 4E4558544F525F44524956455200
0258   410E             
0259   410E             
0260   410E             ;-----------------------------------------------------------------------------
0261   410E             ;
0262   410E             ; Driver flags:
0263   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0264   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0265   410E             
0266   410E 01          	db 1+(2*DRV_HOTPLUG)
0267   410F             
0268   410F             ;-----------------------------------------------------------------------------
0269   410F             ;
0270   410F             ; Reserved byte
0271   410F             ;
0272   410F 00          	db	0
0273   4110             
0274   4110             ;-----------------------------------------------------------------------------
0275   4110             ;
0276   4110             ; Driver name
0277   4110             ;
0278   4110             
0279   4110             DRV_NAME: 
0280   4110             	db	"SDMapper Driver"
0280   4110 53444D617070657220447269766572
0281   411F 20          	ds	32-($-DRV_NAME)," "
0282   4130             
0283   4130             
0284   4130             ;-----------------------------------------------------------------------------
0285   4130             ;
0286   4130             ; Jump table for the driver public routines
0287   4130             ;
0288   4130             
0289   4130             	; These routines are mandatory for all drivers
0290   4130                     ; (but probably you need to implement only DRV_INIT)
0291   4130             
0292   4130 C3 6C 41    	jp	DRV_TIMI
0293   4133 C3 7B 42    	jp	DRV_VERSION
0294   4136 C3 6D 41    	jp	DRV_INIT
0295   4139 C3 82 42    	jp	DRV_BASSTAT
0296   413C C3 84 42    	jp	DRV_BASDEV
0297   413F C3 86 42    	jp	DRV_EXTBIO
0298   4142 C3 87 42    	jp	DRV_DIRECT0
0299   4145 C3 87 42    	jp	DRV_DIRECT1
0300   4148 C3 87 42    	jp	DRV_DIRECT2
0301   414B C3 87 42    	jp	DRV_DIRECT3
0302   414E C3 87 42    	jp	DRV_DIRECT4
0303   4151             
0304   4151 00          	ds	15
0305   4160             
0306   4160             	; These routines are mandatory for device-based drivers
0307   4160             
0308   4160 C3 88 42    	jp	DEV_RW
0309   4163 C3 05 43    	jp	DEV_INFO
0310   4166 C3 8B 43    	jp	DEV_STATUS
0311   4169 C3 CB 43    	jp	LUN_INFO
0312   416C             
0313   416C             
0314   416C             ;=====
0315   416C             ;=====  END of data that must be at fixed addresses
0316   416C             ;=====
0317   416C             
0318   416C             
0319   416C             ;-----------------------------------------------------------------------------
0320   416C             ;
0321   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0322   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0323   416C             
0324   416C             DRV_TIMI: 
0325   416C C9          	ret
0326   416D             
0327   416D             
0328   416D             ;-----------------------------------------------------------------------------
0329   416D             ;
0330   416D             ; Driver initialization routine, it is called twice:
0331   416D             ;
0332   416D             ; 1) First execution, for information gathering.
0333   416D             ;    Input:
0334   416D             ;      A = 0
0335   416D             ;      B = number of available drives
0336   416D             ;      HL = maximum size of allocatable work area in page 3
0337   416D             ;    Output:
0338   416D             ;      A = number of required drives (for drive-based driver only)
0339   416D             ;      HL = size of required work area in page 3
0340   416D             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0341   416D             ;
0342   416D             ; 2) Second execution, for work area and hardware initialization.
0343   416D             ;    Input:
0344   416D             ;      A = 1
0345   416D             ;      B = number of allocated drives for this controller
0346   416D             ;
0347   416D             ;    The work area address can be obtained by using GWORK.
0348   416D             ;
0349   416D             ;    If first execution requests more work area than available,
0350   416D             ;    second execution will not be done and DRV_TIMI will not be hooked
0351   416D             ;    to the timer interrupt.
0352   416D             ;
0353   416D             ;    If first execution requests more drives than available,
0354   416D             ;    as many drives as possible will be allocated, and the initialization
0355   416D             ;    procedure will continue the normal way
0356   416D             ;    (for drive-based drivers only. Device-based drivers always
0357   416D             ;     get two allocated drives.)
0358   416D             
0359   416D             DRV_INIT: 
0360   416D B7          	or	a		; Is this the 1st call? 
0361   416E 21 40 00    	ld	hl, 64		; 64 bytes of work area is needed 
0362   4171 C8          	ret	z		; Yes, return
0363   4172             
0364   4172             ; 2nd call: 
0365   4172 CD 1E 59    	call	MYSETSCR		; Set the screen mode
0366   4175 CD 0A 44    	call	pegaWorkArea		; HL=IY=Work area pointer
0367   4178             
0368   4178 11 5B 59    	ld	de,strTitle		; prints the title 
0369   417B CD D8 57    	call	printString
0370   417E             
0371   417E CD 60 42    	call	SDMAPPERINIT		; SD-Mapper exclusive init
0372   4181             
0373   4181             SDHCDEVINIT: 	; FBLabs SDHC Interface initialization
0374   4181 AF          	xor	a			; zera flags do cartao
0375   4182 FD 77 31    	ld	(iy+FLAGSCARTAO), a
0376   4185 3E 01       	ld	a, 1			; detectar cartao 1
0377   4187 CD EA 41    	call	.detecta
0378   418A 3E 02       	ld	a, 2			; detectar cartao 2
0379   418C CD EA 41    	call	.detecta
0380   418F 01 00 00    	ld	bc, 0
0381   4192 1E 05       	ld	e, 5
0382   4194             
0383   4194             .chkStop:  ; Check if the STOP key was signaled
0384   4194 3A 9B FC    	ld	a,(INTFLG)
0385   4197 FE 04       	cp	4			; Was STOP pressed?
0386   4199 20 35       	jr	nz,.end			; No, quit as fast as possible 
0387   419B             
0388   419B             	; Handle STOP to pause and read messages, and ask for the copyright info
0389   419B 11 77 59    	ld	de,strBootpaused
0390   419E CD D8 57    	call	printString
0391   41A1 3E 07       .wait1: 	ld	a,7
0392   41A3 CD 41 01    	call	SNSMAT
0393   41A6 E6 10       	and	$10			; Is STOP still pressed?
0394   41A8 28 F7       	jr	z,.wait1		; Wait for STOP to be released
0395   41AA AF          	xor	a
0396   41AB 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0397   41AE 06 00       	ld	b,0			; b=inhibit 'i' key flag
0398   41B0 CD 9C 00    .wait2:  call	CHSNS
0399   41B3 C4 D6 41    	call	nz,.chkikey		; Wait until a key is pressed
0400   41B6 3A 9B FC    	ld	a,(INTFLG)
0401   41B9 FE 04       	cp	4			; Was STOP pressed?
0402   41BB 20 F3       	jr	nz,.wait2		; No, return
0403   41BD AF          	xor	a
0404   41BE 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0405   41C1 CD 56 01    	call	KILBUF
0406   41C4 06 1E       	ld	b,30			; Since the user is trying pause the
0407   41C6 76          .wait3: 	halt				; boot messages, this gives him enough
0408   41C7             					; time to react and pause the next
0409   41C7             					; driver
0410   41C7 3A 9B FC    	ld	a,(INTFLG)
0411   41CA FE 04       	cp	4			; Was STOP pressed?
0412   41CC 28 02       	jr	z,.end			; quit so the next driver can process it
0413   41CE 10 F6       	djnz	.wait3			; The user will have the impression
0414   41D0             					; that he has a perfect timing.   ;)
0415   41D0             
0416   41D0             
0417   41D0             .end
0418   41D0 11 24 5A     	ld	de, strCrLf
0419   41D3 C3 D8 57    	jp	printString
0420   41D6             
0421   41D6             .chkikey: 
0422   41D6 CB 40       	bit	0,b			; Was the copyright message shown?
0423   41D8 C0          	ret	nz			; Yes, return
0424   41D9 CD 9F 00    	call	CHGET
0425   41DC FE 69       	cp	'i'
0426   41DE 28 03       	jr	z,.showcopyright
0427   41E0 FE 49       	cp	'I'
0428   41E2 C0          	ret	nz
0429   41E3             .showcopyright: 
0430   41E3 04          	inc	b			; Inhibit further presses of the i key 
0431   41E4 11 A7 59    	ld	de,strCopyright
0432   41E7 C3 D8 57    	jp	printString
0433   41EA             
0434   41EA             .detecta: 
0435   41EA FD 77 30    	ld	(iy+NUMSD), a		; processo de deteccao dos cartoes
0436   41ED 11 27 5A    	ld	de, strCartao
0437   41F0 CD D8 57    	call	printString
0438   41F3 FD 7E 30    	ld	a, (iy+NUMSD)
0439   41F6 C6 30       	add	'0'
0440   41F8 CD A2 00    	call	CHPUT
0441   41FB 3E 3A       	ld	a, ':'
0442   41FD CD A2 00    	call	CHPUT
0443   4200 3E 20       	ld	a, ' '
0444   4202 CD A2 00    	call	CHPUT
0445   4205 FD 4E 30    	ld	c, (iy+NUMSD)
0446   4208 3A 00 7F    	ld	a, (SPISTATUS)		; testar se cartao esta inserido
0447   420B A1          	and	c			; C contem 1 se cartao 1, 2 se cartao 2
0448   420C 28 09       	jr	z,.naoVazio
0449   420E 11 2D 5A    	ld	de, strVazio		; nao tem cartao no slot
0450   4211 CD D8 57    	call	printString
0451   4214 C3 25 42    	jp	.marcaErro
0452   4217             .naoVazio: 
0453   4217 CD 84 44    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0454   421A 30 0C       	jr	nc,.detectou
0455   421C CD D2 45    	call	desabilitaSDs
0456   421F 11 35 5A    	ld	de, strNaoIdentificado
0457   4222 CD D8 57    	call	printString
0458   4225             .marcaErro: 
0459   4225 C3 45 44    	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0460   4228             .detectou: 
0461   4228 CD 5C 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0462   422B DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0463   422E 11 B6 5A    	ld	de, strSDV1	; e imprimir
0464   4231 B7          	or	a
0465   4232 28 03       	jr	z,.pula1
0466   4234 11 BE 5A    	ld	de, strSDV2
0467   4237             .pula1: 
0468   4237 CD D8 57    	call	printString
0469   423A 3E 28       	ld	a,'('
0470   423C CD A2 00    	call	CHPUT
0471   423F DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0472   4242 CD 25 58    	call	printDecToAscii	; Imprimir Manufacturer ID
0473   4245 3E 29       	ld	a,')'
0474   4247 CD A2 00    	call	CHPUT
0475   424A 3E 20       	ld	a,' '
0476   424C CD A2 00    	call	CHPUT
0477   424F DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0478   4252 CD 51 58    	call	pegaFabricante	; achar nome do fabricante
0479   4255 EB          	ex	de,hl
0480   4256 CD D8 57    	call	printString	; e imprimir
0481   4259 11 24 5A    	ld	de,strCrLf
0482   425C CD D8 57    	call	printString
0483   425F C9          	ret
0484   4260             
0485   4260             
0486   4260             SDMAPPERINIT: 		; This block is exclusive for the SD-Mapper
0487   4260 11 40 5A    	ld	de, strMr_mp_desativada
0488   4263 3A 00 7F    	ld	a, (SPISTATUS)		; testar se mapper/megaram esta ativa
0489   4266 E6 10       	and	$10
0490   4268 28 0E       	jr	z,.print		; desativada, pula
0491   426A 11 68 5A    	ld	de, strMapper
0492   426D 3A 00 7F    	ld	a, (SPISTATUS)		; ativa, testar se eh mapper ou megaram
0493   4270 E6 20       	and	$20
0494   4272 C2 D8 57    	jp	nz,printString
0495   4275 11 92 5A    	ld	de, strMegaram		; Megaram ativa
0496   4278             .print: 
0497   4278 C3 D8 57    	jp	printString
0498   427B             
0499   427B             ;-----------------------------------------------------------------------------
0500   427B             ;
0501   427B             ; Obtain driver version
0502   427B             ;
0503   427B             ; Input:  -
0504   427B             ; Output: A = Main version number
0505   427B             ;         B = Secondary version number
0506   427B             ;         C = Revision number
0507   427B             
0508   427B             DRV_VERSION: 
0509   427B 3E 01       	ld	a, VER_MAIN
0510   427D 06 00       	ld	b, VER_SEC
0511   427F 0E 06       	ld	c, VER_REV
0512   4281 C9          	ret
0513   4282             
0514   4282             
0515   4282             ;-----------------------------------------------------------------------------
0516   4282             ;
0517   4282             ; BASIC expanded statement ("CALL") handler.
0518   4282             ; Works the expected way, except that if invoking CALBAS is needed,
0519   4282             ; it must be done via the CALLB0 routine in kernel page 0.
0520   4282             
0521   4282             DRV_BASSTAT: 
0522   4282 37          	scf
0523   4283 C9          	ret
0524   4284             
0525   4284             
0526   4284             ;-----------------------------------------------------------------------------
0527   4284             ;
0528   4284             ; BASIC expanded device handler.
0529   4284             ; Works the expected way, except that if invoking CALBAS is needed,
0530   4284             ; it must be done via the CALLB0 routine in kernel page 0.
0531   4284             
0532   4284             DRV_BASDEV: 
0533   4284 37          	scf
0534   4285 C9          	ret
0535   4286             
0536   4286             ;-----------------------------------------------------------------------------
0537   4286             ;
0538   4286             ; Extended BIOS hook.
0539   4286             ; Works the expected way, except that it must return
0540   4286             ; D'=1 if the old hook must be called, D'=0 otherwise.
0541   4286             ; It is entered with D'=1.
0542   4286             
0543   4286             DRV_EXTBIO: 
0544   4286 C9          	ret
0545   4287             
0546   4287             ;-----------------------------------------------------------------------------
0547   4287             ;
0548   4287             ; Direct calls entry points.
0549   4287             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0550   4287             ; in kernel banks 0 and 3 will be redirected
0551   4287             ; to DIRECT0/1/2/3/4 respectively.
0552   4287             ; Receives all register data from the caller except IX and AF'.
0553   4287             
0554   4287             DRV_DIRECT0: 
0555   4287             DRV_DIRECT1: 
0556   4287             DRV_DIRECT2: 
0557   4287             DRV_DIRECT3: 
0558   4287             DRV_DIRECT4: 
0559   4287 C9          	ret
0560   4288             
0561   4288             
0562   4288             ;=====
0563   4288             ;=====  BEGIN of DEVICE-BASED specific routines
0564   4288             ;=====
0565   4288             
0566   4288             ;-----------------------------------------------------------------------------
0567   4288             ;
0568   4288             ; Read or write logical sectors from/to a logical unit
0569   4288             ;
0570   4288             ;Input:    Cy=0 to read, 1 to write
0571   4288             ;          A = Device number, 1 to 7
0572   4288             ;          B = Number of sectors to read or write
0573   4288             ;          C = Logical unit number, 1 to 7
0574   4288             ;          HL = Source or destination memory address for the transfer
0575   4288             ;          DE = Address where the 4 byte sector number is stored.
0576   4288             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0577   4288             ;              0: Ok
0578   4288             ;              .IDEVL: Invalid device or LUN
0579   4288             ;              .NRDY: Not ready
0580   4288             ;              .DISK: General unknown disk error
0581   4288             ;              .DATA: CRC error when reading
0582   4288             ;              .RNF: Sector not found
0583   4288             ;              .UFORM: Unformatted disk
0584   4288             ;              .WPROT: Write protected media, or read-only logical unit
0585   4288             ;              .WRERR: Write error
0586   4288             ;              .NCOMP: Incompatible disk.
0587   4288             ;              .SEEK: Seek error.
0588   4288             ;          B = Number of sectors actually read (in case of error only)
0589   4288             
0590   4288             DEV_RW: 
0591   4288 F5          	push	af
0592   428A BF FE 03    	cp	a, 3		; somente 2 dispositivos
0593   428C 30 10       	jr	nc,.saicomerroidl
0594   428E 0D          	dec	c		; somente 1 logical unit
0595   428F 20 0D       	jr	nz,.saicomerroidl
0596   4291 E5          	push	hl
0597   4292 CD 23 44    	call	testaCartao	; verificar se cartao esta OK
0598   4295 E1          	pop	hl
0599   4296 30 0C       	jr	nc,.ok
0600   4298 F1          	pop	af		; retira AF guardado no inicio
0601   4299 3E FC       	ld	a, ENRDY	; Not ready
0602   429B             ;	ld	a, EDISK	; General unknown disk error
0603   429B 06 00       	ld	b, 0
0604   429D C9          	ret
0605   429E             .saicomerroidl: 
0606   429E F1          	pop	af		; retira AF guardado no inicio
0607   429F 3E B5       	ld	a, EIDEVL	; informar erro
0608   42A1 06 00       	ld	b, 0
0609   42A3 C9          	ret
0610   42A4             .ok: 
0611   42A4 FD 70 32    	ld	(iy+NUMBLOCOS), b	; guarda numero de blocos para ler/gravar
0612   42A7 E5          	push	hl
0613   42A8 D5          	push	de
0614   42A9 CD 5C 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0615   42AC D1          	pop	de
0616   42AD E1          	pop	hl
0617   42AE F1          	pop	af		; retira AF guardado no inicio, para saber se eh leitura ou escrita
0618   42AF 38 25       	jr	c,escrita	; se for escrita pulamos
0619   42B1             leitura: 
0620   42B1 1A          	ld	a, (de)		; 1. n. bloco
0621   42B2 F5          	push	af
0622   42B3 13          	inc	de
0623   42B4 1A          	ld	a, (de)		; 2. n. bloco
0624   42B5 F5          	push	af
0625   42B6 13          	inc	de
0626   42B7 1A          	ld	a, (de)		; 3. n. bloco
0627   42B8 4F          	ld	c, a
0628   42B9 13          	inc	de
0629   42BA 1A          	ld	a, (de)		; 4. n. bloco
0630   42BB 13          	inc	de
0631   42BC 47          	ld	b, a
0632   42BD F1          	pop	af
0633   42BE 57          	ld	d, a
0634   42BF F1          	pop	af		; HL = ponteiro destino
0635   42C0 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0636   42C1 CD C8 57    	call	enableSPI
0637   42C4 CD 4A 4F    	call	LerBloco	; chamar rotina de leitura de dados
0638   42C7 CD D0 57    	call	disableSPI
0639   42CA 30 08       	jr	nc,.ok
0640   42CC CD 45 44    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0641   42CF             ;	ld	a, ENRDY	; Not ready
0642   42CF 3E FD       	ld	a, EDISK	; General unknown disk error
0643   42D1 06 00       	ld	b, 0		; informar que lemos 0 blocos
0644   42D3 C9          	ret
0645   42D4             .ok: 
0646   42D4 AF          	xor	a		; tudo OK, informar ao Nextor
0647   42D5 C9          	ret
0648   42D6             
0649   42D6             escrita: 
0650   42D6 CD 50 44    	call	testaWP		; testar se cartao esta protegido contra escrita
0651   42D9 28 05       	jr	z,.ok
0652   42DB 3E F8       	ld	a, EWPROT	; disco protegido
0653   42DD 06 00       	ld	b, 0
0654   42DF C9          	ret
0655   42E0             .ok: 
0656   42E0 1A          	ld	a, (de)		; 1. n. bloco
0657   42E1 F5          	push	af
0658   42E2 13          	inc	de
0659   42E3 1A          	ld	a, (de)		; 2. n. bloco
0660   42E4 F5          	push	af
0661   42E5 13          	inc	de
0662   42E6 1A          	ld	a, (de)		; 3. n. bloco
0663   42E7 13          	inc	de
0664   42E8 4F          	ld	c, a
0665   42E9 1A          	ld	a, (de)		; 4. n. bloco
0666   42EA 13          	inc	de
0667   42EB 47          	ld	b, a
0668   42EC F1          	pop	af
0669   42ED 57          	ld	d, a
0670   42EE F1          	pop	af		; HL = ponteiro destino
0671   42EF 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0672   42F0 CD C8 57    	call	enableSPI
0673   42F3 CD 82 46    	call	GravarBloco	; chamar rotina de gravacao de dados
0674   42F6 CD D0 57    	call	disableSPI
0675   42F9 30 08       	jr	nc,.ok2
0676   42FB CD 45 44    	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0677   42FE 3E FE       	ld	a,EWRERR	; Write error
0678   4300 06 00       	ld	b,0
0679   4302 C9          	ret
0680   4303             .ok2: 
0681   4303 AF          	xor	a			; gravacao sem erros!
0682   4304 C9          	ret
0683   4305             
0684   4305             ;-----------------------------------------------------------------------------
0685   4305             ;
0686   4305             ; Device information gathering
0687   4305             ;
0688   4305             ;Input:   A = Device index, 1 to 7
0689   4305             ;         B = Information to return:
0690   4305             ;             0: Basic information
0691   4305             ;             1: Manufacturer name string
0692   4305             ;             2: Device name string
0693   4305             ;             3: Serial number string
0694   4305             ;         HL = Pointer to a buffer in RAM
0695   4305             ;Output:  A = Error code:
0696   4305             ;             0: Ok
0697   4305             ;             1: Device not available or invalid device index
0698   4305             ;             2: Information not available, or invalid information index
0699   4305             ;         When basic information is requested,
0700   4305             ;         buffer filled with the following information:
0701   4305             ;
0702   4305             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0703   4305             ;        units (which is functionally equivalent to having only one).
0704   4305             ;+1 (1): Device flags, always zero in Beta 2.
0705   4305             ;
0706   4305             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0707   4305             ; left justified and padded with spaces. All the strings are optional,
0708   4305             ; if not available, an error must be returned.
0709   4305             ; If a string is provided by the device in binary format, it must be reported
0710   4305             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0711   4305             ; The maximum length for a string is 64 characters;
0712   4305             ; if the string is actually longer, the leftmost 64 characters
0713   4305             ; should be provided.
0714   4305             ;
0715   4305             ; In the case of the serial number string, the same rules for the strings
0716   4305             ; apply, except that it must be provided right-justified,
0717   4305             ; and if it is too long, the rightmost characters must be
0718   4305             ; provided, not the leftmost.
0719   4305             
0720   4305             DEV_INFO: 
0721   4305 04          	inc	b
0722   4307 BF FE 03    	cp	a,3		; somente 2 dispositivos
0723   4309 30 07       	jr	nc,.saicomerro
0724   430B E5          	push	hl
0725   430C CD 23 44    	call	testaCartao	; verificar se cartao esta OK
0726   430F E1          	pop	hl
0727   4310 30 03       	jr	nc,.ok		; nao houve erro
0728   4312             .saicomerro: 
0729   4312 3E 01       	ld	a, 1		; informar erro
0730   4314 C9          	ret
0731   4315             
0732   4315             .ok: 
0733   4315 10 07       	djnz	.naoBasic
0734   4317             ; Basic information:
0735   4317 3E 01       	ld	a,1		; 1 logical unit somente
0736   4319 77          	ld	(hl), a
0737   431A AF          	xor	a		; reservado, deve ser 0
0738   431B 23          	inc	hl
0739   431C 77          	ld	(hl), a
0740   431D C9          	ret			; retorna com A=0 (OK)
0741   431E             
0742   431E             .naoBasic: 
0743   431E E5          	push	hl
0744   431F CD 5C 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0745   4322 E1          	pop	hl
0746   4323 10 25       	djnz	.naoManuf
0747   4325             ; Manufacturer Name:
0748   4325 E5          	push	hl		; salva ponteiro do buffer
0749   4326 06 40       	ld	b, 64		; preenche buffer com espaco
0750   4328 3E 20       	ld	a, ' '
0751   432A             .loop1: 
0752   432A 77          	ld	(hl), a
0753   432B 23          	inc	hl
0754   432C 10 FC       	djnz	.loop1
0755   432E D1          	pop	de		; recuperamos ponteiro do buffer em DE
0756   432F 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0757   4331 12          	ld	(de), a
0758   4332 13          	inc	de
0759   4333 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0760   4336 CD E1 57    	call	DecToAscii
0761   4339 3E 29       	ld	a, ')'
0762   433B 12          	ld	(de), a
0763   433C 13          	inc	de
0764   433D 3E 20       	ld	a, ' '
0765   433F 12          	ld	(de), a
0766   4340 13          	inc	de
0767   4341 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0768   4344 CD 51 58    	call	pegaFabricante	; pegar nome do fabricante em HL
0769   4347 ED B0       	ldir			; e colocar no buffer
0770   4349 C9          	ret
0771   434A             
0772   434A             .naoManuf: 
0773   434A 10 1A       	djnz	.naoProduct
0774   434C             ; Product Name:
0775   434C E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0776   434D DD E5       	push	ix
0777   434F E1          	pop	hl		; joga IX para HL
0778   4350 16 00       	ld	d, 0
0779   4352 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0780   4354 19          	add	hl, de
0781   4355 D1          	pop	de		; recupera buffer do Nextor em DE
0782   4356 01 05 00    	ld	bc, 5		; 5 caracteres
0783   4359 ED B0       	ldir			; copia nome do produto
0784   435B EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0785   435C 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0786   435E 3E 20       	ld	a, ' '
0787   4360             .loop2: 
0788   4360 77          	ld	(hl), a
0789   4361 23          	inc	hl
0790   4362 10 FC       	djnz	.loop2
0791   4364 AF          	xor	a		; informar sem erros
0792   4365 C9          	ret
0793   4366             
0794   4366             .naoProduct: 
0795   4366             ; Serial:
0796   4366 3E 30       	ld	a, '0'		; Coloca prefixo "0x"
0797   4368 77          	ld	(hl), a
0798   4369 23          	inc	hl
0799   436A 3E 78       	ld	a, 'x'
0800   436C 77          	ld	(hl), a
0801   436D 23          	inc	hl
0802   436E E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0803   436F DD E5       	push	ix
0804   4371 E1          	pop	hl		; joga IX para HL
0805   4372 16 00       	ld	d, 0
0806   4374 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0807   4376 19          	add	hl, de
0808   4377 D1          	pop	de		; recupera buffer do nextor em DE
0809   4378 06 04       	ld	b, 4		; 4 bytes do serial
0810   437A             .loop3: 
0811   437A 7E          	ld	a, (hl)
0812   437B CD 11 58    	call	HexToAscii	; converter HEXA para ASCII
0813   437E 23          	inc	hl
0814   437F 10 F9       	djnz	.loop3
0815   4381 06 36       	ld	b, 54		; Coloca espaco no restante
0816   4383 3E 20       	ld	a, ' '
0817   4385             .loop4: 
0818   4385 12          	ld	(de), a
0819   4386 13          	inc	de
0820   4387 10 FC       	djnz	.loop4
0821   4389 AF          	xor	a		; informar sem erros
0822   438A C9          	ret
0823   438B             
0824   438B             ;-----------------------------------------------------------------------------
0825   438B             ;
0826   438B             ; Obtain device status
0827   438B             ;
0828   438B             ;Input:   A = Device index, 1 to 7
0829   438B             ;         B = Logical unit number, 1 to 7
0830   438B             ;             0 to return the status of the device itself.
0831   438B             ;Output:  A = Status for the specified logical unit,
0832   438B             ;             or for the whole device if 0 was specified:
0833   438B             ;                0: The device or logical unit is not available, or the
0834   438B             ;                   device or logical unit number supplied is invalid.
0835   438B             ;                1: The device or logical unit is available and has not
0836   438B             ;                   changed since the last status request.
0837   438B             ;                2: The device or logical unit is available and has changed
0838   438B             ;                   since the last status request
0839   438B             ;                   (for devices, the device has been unplugged and a
0840   438B             ;                    different device has been plugged which has been
0841   438B             ;                    assigned the same device index; for logical units,
0842   438B             ;                    the media has been changed).
0843   438B             ;                3: The device or logical unit is available, but it is not
0844   438B             ;                   possible to determine whether it has been changed
0845   438B             ;                   or not since the last status request.
0846   438B             ;
0847   438B             ; Devices not supporting hot-plugging must always return status value 1.
0848   438B             ; Non removable logical units may return values 0 and 1.
0849   438B             ;
0850   438B             ; The returned status is always relative to the previous invokation of
0851   438B             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0852   438B             
0853   438B             DEV_STATUS: 
0854   438C BF FE 03    	cp	a,3		; 2 dispositivos somente
0855   438E 30 38       	jr	nc,.saicomerro
0856   4390 05          	dec	b		; 1 logical unit somente
0857   4391 20 35       	jr	nz,.saicomerro
0858   4393             
0859   4393 F5          	push	af
0860   4394 CD 0A 44    	call	pegaWorkArea	; HL=IY=Work area pointer
0861   4397 F1          	pop	af
0862   4398 FD 77 30    	ld	(iy+NUMSD),a	; salva numero do device atual (1 ou 2)
0863   439B 4F          	ld	c,a		; c=device number
0864   439C 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta inserido
0865   439F A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
0866   43A0 20 23       	jr	nz,.cartaoComErro	; se slot do cartao estiver vazio, marcamos o erro nas flags
0867   43A2 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
0868   43A5 A1          	and	c
0869   43A6 28 1A       	jr	z,.semMudanca	; cartao nao marcado com erro, pula
0870   43A8 CD C8 57    	call	enableSPI
0871   43AB CD 84 44    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0872   43AE CD D0 57    	call	disableSPI
0873   43B1 38 12       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0874   43B3 FD 7E 30    	ld	a, (iy+NUMSD)		; conseguimos detectar, tira erro nas flags
0875   43B6 2F          	cpl			; inverte bits para fazer o AND
0876   43B7 4F          	ld	c, a
0877   43B8 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)
0878   43BB A1          	and	c			; limpa bit
0879   43BC FD 77 31    	ld	(iy+FLAGSCARTAO), a
0880   43BF             .comMudanca: 
0881   43BF 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0882   43C1 C9          	ret
0883   43C2             .semMudanca: 
0884   43C2 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0885   43C4 C9          	ret
0886   43C5             .cartaoComErro: 
0887   43C5 CD 45 44    	call	marcaErroCartao	; marcar erro do cartao nas flags
0888   43C8             .saicomerro: 
0889   43C8 3E 00       	ld	a, 0		; informa erro
0890   43CA C9          	ret
0891   43CB             
0892   43CB             ;-----------------------------------------------------------------------------
0893   43CB             ;
0894   43CB             ; Obtain logical unit information
0895   43CB             ;
0896   43CB             ;Input:   A  = Device index, 1 to 7
0897   43CB             ;         B  = Logical unit number, 1 to 7
0898   43CB             ;         HL = Pointer to buffer in RAM.
0899   43CB             ;Output:  A = 0: Ok, buffer filled with information.
0900   43CB             ;             1: Error, device or logical unit not available,
0901   43CB             ;                or device index or logical unit number invalid.
0902   43CB             ;         On success, buffer filled with the following information:
0903   43CB             ;
0904   43CB             ;+0 (1): Medium type:
0905   43CB             ;        0: Block device
0906   43CB             ;        1: CD or DVD reader or recorder
0907   43CB             ;        2-254: Unused. Additional codes may be defined in the future.
0908   43CB             ;        255: Other
0909   43CB             ;+1 (2): Sector size, 0 if this information does not apply or is
0910   43CB             ;        not available.
0911   43CB             ;+3 (4): Total number of available sectors.
0912   43CB             ;        0 if this information does not apply or is not available.
0913   43CB             ;+7 (1): Flags:
0914   43CB             ;        bit 0: 1 if the medium is removable.
0915   43CB             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0916   43CB             ;               be write protected or write enabled is not considered
0917   43CB             ;               to be read-only.
0918   43CB             ;        bit 2: 1 if the LUN is a floppy disk drive.
0919   43CB             ;+8 (2): Number of cylinders
0920   43CB             ;+10 (1): Number of heads
0921   43CB             ;+11 (1): Number of sectors per track
0922   43CB             ;
0923   43CB             ; Number of cylinders, heads and sectors apply to hard disks only.
0924   43CB             ; For other types of device, these fields must be zero.
0925   43CB             
0926   43CB             LUN_INFO: 
0927   43CC BF FE 03    	cp	a, 3		; somente 2 dispositivo
0928   43CE 30 0A       	jr	nc,.saicomerro
0929   43D0 05          	dec	b		; somente 1 logical unit
0930   43D1 20 07       	jr	nz,.saicomerro
0931   43D3 E5          	push	hl
0932   43D4 CD 23 44    	call	testaCartao
0933   43D7 E1          	pop	hl
0934   43D8 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0935   43DA             .saicomerro: 
0936   43DA 3E 01       	ld	a, 1		; informar erro
0937   43DC C9          	ret
0938   43DD             .ok: 
0939   43DD E5          	push	hl
0940   43DE CD 70 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0941   43E1 E1          	pop	hl		; do cartao dependendo do cartao atual solicitado
0942   43E2 AF          	xor	a
0943   43E3 77          	ld	(hl), a		; Informar que o dispositivo eh do tipo block device
0944   43E4 23          	inc	hl
0945   43E5 77          	ld	(hl), a		; tamanho de um bloco = 512 bytes (coloca $00, $02 que é $200 = 512)
0946   43E6 23          	inc	hl
0947   43E7 3E 02       	ld	a, 2
0948   43E9 77          	ld	(hl), a
0949   43EA 23          	inc	hl
0950   43EB DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0951   43EE 77          	ld	(hl), a
0952   43EF 23          	inc	hl
0953   43F0 DD 7E 01    	ld	a, (ix+1)
0954   43F3 77          	ld	(hl), a
0955   43F4 23          	inc	hl
0956   43F5 DD 7E 02    	ld	a, (ix+2)
0957   43F8 77          	ld	(hl), a
0958   43F9 23          	inc	hl
0959   43FA AF          	xor	a		; cartoes SD tem total de blocos em 24 bits, mas o Nextor pede numero de
0960   43FB 77          	ld	(hl), a 	; 32 bits, entao coloca 0 no MSB
0961   43FC 23          	inc	hl
0962   43FD 3E 01       	ld	a, 1		; flags: dispositivo R/W removivel
0963   43FF 77          	ld	(hl), a
0964   4400 23          	inc	hl
0965   4401 AF          	xor	a		; CHS = 0
0966   4402 77          	ld	(hl), a
0967   4403 23          	inc	hl
0968   4404 77          	ld	(hl), a
0969   4405 23          	inc	hl
0970   4406 77          	ld	(hl), a
0971   4407 23          	inc	hl
0972   4408 AF          	xor	a		; informar que dados foram preenchidos
0973   4409 C9          	ret
0974   440A             
0975   440A             ;=====
0976   440A             ;=====  END of DEVICE-BASED specific routines
0977   440A             ;=====
0978   440A             
0979   440A             ;------------------------------------------------
0980   440A             ; Rotinas auxiliares
0981   440A             ;------------------------------------------------
0982   440A             
0983   440A             ;------------------------------------------------
0984   440A             ; Pedir ao Nextor o ponteiro de dados de trabalho
0985   440A             ; na RAM e colocar em HL e IY
0986   440A             ; Destroi HL e IY
0987   440A             ;------------------------------------------------
0988   440A             pegaWorkArea: 
0989   440A F5          	push	af
0990   440B AF          	xor	a		; Pegar endereco da area de trabalho
0991   440C 08          	ex	af,af'
0992   440D AF          	xor	a
0993   440E DD 21 45 40 	ld	ix, GWORK
0994   4412 CD D0 57    	call	disableSPI
0995   4415 CD 42 40    	call	CALBNK
0996   4418 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
0997   441B DD 66 01    	ld	h,(ix+1)
0998   441E E5          	push	hl
0999   441F FD E1       	pop	iy		; em IY temos o mesmo ponteiro
1000   4421 F1          	pop	af
1001   4422 C9          	ret
1002   4423             
1003   4423             ;------------------------------------------------
1004   4423             ; Testa se cartao esta inserido e/ou houve erro
1005   4423             ; na ultima vez que foi acessado. Carry indica
1006   4423             ; erro
1007   4423             ; Destroi AF, HL, IX, C
1008   4423             ;------------------------------------------------
1009   4423             testaCartao: 
1010   4423 F5          	push	af
1011   4424 CD 0A 44    	call	pegaWorkArea	; HL=IY=Work area pointer
1012   4427 F1          	pop	af
1013   4428 FD 77 30    	ld	(iy+NUMSD), a	; salva numero do device atual (1 ou 2)
1014   442B 4F          	ld	c, a
1015   442C 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta inserido
1016   442F A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
1017   4430 20 0A       	jr	nz,.saicomerro				
1018   4432 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
1019   4435 A1          	and	c
1020   4436 28 02       	jr	z,.ok
1021   4438 37          	scf			; indica erro
1022   4439 C9          	ret
1023   443A             .ok: 
1024   443A AF          	xor	a		; zera carry indicando sem erro
1025   443B C9          	ret
1026   443C             .saicomerro: 
1027   443C FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marca bit de erro nas flags
1028   443F B1          	or	c
1029   4440 FD 77 31    	ld	(iy+FLAGSCARTAO), a
1030   4443 37          	scf
1031   4444 C9          	ret
1032   4445             
1033   4445             ;------------------------------------------------
1034   4445             ; Marcar bit de erro nas flags
1035   4445             ; Destroi AF, C
1036   4445             ;------------------------------------------------
1037   4445             marcaErroCartao: 
1038   4445 FD 4E 30    	ld	c, (iy+NUMSD)		; cartao atual (1 ou 2)
1039   4448 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marcar erro
1040   444B B1          	or	c
1041   444C FD 77 31    	ld	(iy+FLAGSCARTAO), a
1042   444F C9          	ret
1043   4450             
1044   4450             ;------------------------------------------------
1045   4450             ; Testar se cartao atual esta protegido contra
1046   4450             ; gravacao, A=0 se protegido
1047   4450             ; Destroi AF, C
1048   4450             ;------------------------------------------------
1049   4450             testaWP: 
1050   4450 FD 4E 30    	ld	c, (iy+NUMSD)	; cartao atual (1 ou 2)
1051   4453 CB 01       	rlc	c		; desloca para apontar para bits 2 ou 3 para cartoes 1 ou 2 respectivamente
1052   4455 CB 01       	rlc	c
1053   4457 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta protegido
1054   445A A1          	and	c
1055   445B C9          	ret			; se A for 0 cartao esta protegido
1056   445C             
1057   445C             ;------------------------------------------------
1058   445C             ; Calcula offset do buffer na RAM em HL e IX para
1059   445C             ; os dados do CID dependendo do cartao atual
1060   445C             ; Destroi AF, DE, HL e IX
1061   445C             ;------------------------------------------------
1062   445C             calculaCIDoffset: 
1063   445C FD E5       	push	iy		; copiamos IY para HL
1064   445E E1          	pop	hl
1065   445F 16 00       	ld	d, 0
1066   4461 1E 10       	ld	e, BCID1	; DE aponta para buffer BCID1
1067   4463 FD 7E 30    	ld	a, (iy+NUMSD)	; vamos fazer IX apontar para o buffer correto
1068   4466 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1069   4467 28 02       	jr	z,.c1
1070   4469 1E 20       	ld	e, BCID2	; DE aponta para buffer BCID2
1071   446B             .c1: 
1072   446B 19          	add	hl, de		; HL aponta para buffer correto
1073   446C E5          	push	hl		
1074   446D DD E1       	pop	ix		; vamos colocar HL em IX
1075   446F C9          	ret
1076   4470             
1077   4470             ;------------------------------------------------
1078   4470             ; Calcula offset do buffer na RAM para os dados
1079   4470             ; do total de blocos dependendo do cartao atual
1080   4470             ; Offset fica em HL e IX
1081   4470             ; Destroi AF, DE, HL e IX
1082   4470             ;------------------------------------------------
1083   4470             calculaBLOCOSoffset: 
1084   4470 FD E5       	push	iy		; copiamos IY para HL
1085   4472 E1          	pop	hl
1086   4473 16 00       	ld	d, 0
1087   4475 1E 38       	ld	e, BLOCOS1	; DE aponta para buffer BLOCOS1
1088   4477 FD 7E 30    	ld	a, (iy+NUMSD)	; Vamos fazer IX apontar para o buffer correto
1089   447A 3D          	dec	a		; dependendo do cartao: BLOCOS1 ou BLOCOS2
1090   447B 28 02       	jr	z,.c1
1091   447D 1E 3C       	ld	e, BLOCOS2	; DE aponta para buffer BLOCOS2
1092   447F             .c1: 
1093   447F 19          	add	hl, de		; HL aponta para buffer correto
1094   4480 E5          	push	hl		
1095   4481 DD E1       	pop	ix		; Vamos colocar HL em IX
1096   4483 C9          	ret
1097   4484             
1098   4484             
1099   4484             ;------------------------------------------------
1100   4484             ; Minhas funcoes para cartao SD
1101   4484             ;------------------------------------------------
1102   4484             
1103   4484             ;------------------------------------------------
1104   4484             ; Processo de inicializacao e deteccao do cartao.
1105   4484             ; Detecta se cartao responde, qual versao (SDV1
1106   4484             ; ou SDV2), faz a leitura do CSD e CID e calcula
1107   4484             ; o numero de blocos do cartao, colocando o CID
1108   4484             ; e total de blocos no buffer correto dependendo
1109   4484             ; do cartao 1 ou 2.
1110   4484             ; Retorna erro no carry. Se for 0 indica deteccao
1111   4484             ; com sucesso.
1112   4484             ; Destroi todos os registradores
1113   4484             ;------------------------------------------------
1114   4484             detectaCartao: 
1115   4484 CD B3 45    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1116   4487 D8          	ret	c			; retorna se erro
1117   4488 CD 53 45    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1118   448B D8          	ret	c
1119   448C FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1120   448E E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1121   448F 3E 49       	ld	a, CMD9		; ler CSD
1122   4491 CD 74 45    	call	lerBlocoCxD
1123   4494 D8          	ret	c
1124   4495 CD 5C 44    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1125   4498 3E 4A       	ld	a, CMD10	; ler CID
1126   449A CD 74 45    	call	lerBlocoCxD
1127   449D D8          	ret	c
1128   449E 3E 7A       	ld	a, CMD58	; ler OCR
1129   44A0 11 00 00    	ld	de, 0
1130   44A3 CD 04 46    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1131   44A6 D8          	ret	c
1132   44A7 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1133   44A8 E6 40       	and	$40
1134   44AA DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1135   44AD CC 48 45    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1136   44B0 D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1137   44B1 CD D2 45    	call	desabilitaSDs
1138   44B4             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1139   44B4 CD 70 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1140   44B7 FD E5       	push	iy		; copiamos IY para HL
1141   44B9 E1          	pop	hl
1142   44BA 16 00       	ld	d, 0
1143   44BC 1E 05       	ld	e, BCSD+5
1144   44BE 19          	add	hl, de		; HL aponta para buffer BCSD+5
1145   44BF FD 7E 00    	ld	a, (iy+BCSD)
1146   44C2 E6 C0       	and	$C0		; testa versao do registro CSD
1147   44C4 28 06       	jr	z,.calculaCSD1
1148   44C6 FE 40       	cp	$40
1149   44C8 28 54       	jr	z,.calculaCSD2
1150   44CA 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1151   44CB C9          	ret
1152   44CC             
1153   44CC             ; -----------------------------------
1154   44CC             ; Registro CSD versao 1, calcular da
1155   44CC             ; maneira correta para a versao 1
1156   44CC             ; -----------------------------------
1157   44CC             .calculaCSD1: 
1158   44CC 7E          	ld	a, (hl)
1159   44CD E6 0F       	and	$0F		; isola READ_BL_LEN
1160   44CF F5          	push	af
1161   44D0 23          	inc	hl
1162   44D1 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1163   44D2 E6 03       	and	3
1164   44D4 57          	ld	d, a
1165   44D5 23          	inc	hl
1166   44D6 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1167   44D7 23          	inc	hl
1168   44D8 7E          	ld	a, (hl)
1169   44D9 E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1170   44DB 87          	add	a, a		; rotaciona a esquerda
1171   44DC CB 13       	rl	e		; rotaciona para DE
1172   44DE CB 12       	rl	d
1173   44E0 87          	add	a, a		; mais uma rotacao
1174   44E1 CB 13       	rl	e		; rotaciona para DE
1175   44E3 CB 12       	rl	d
1176   44E5 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1177   44E6 23          	inc	hl
1178   44E7 7E          	ld	a, (hl)		; proximo byte
1179   44E8 E6 03       	and	3		; 2 bits de C_SIZE_MUL
1180   44EA 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1181   44EB 23          	inc	hl						
1182   44EC 7E          	ld	a, (hl)		; proximo byte
1183   44ED E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1184   44EF 87          	add	a, a		; rotaciona para esquerda jogando no carry
1185   44F0 CB 10       	rl	b		; rotaciona para B
1186   44F2 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1187   44F3 04          	inc	b		; faz B = C_SIZE_MUL + 2
1188   44F4 F1          	pop	af		; volta em A o READ_BL_LEN
1189   44F5 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1190   44F6 01 00 00    	ld	bc, 0
1191   44F9 CD 12 45    	call	.eleva2
1192   44FC 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1193   44FD 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1194   44FE 48          	ld	c, b
1195   44FF 06 00       	ld	b, 0
1196   4501 CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1197   4503 CB 1A       	rr	d		; rotacionamos D e E
1198   4505 CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1199   4507             .salvaBlocos: 
1200   4507 DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1201   450A DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1202   450D DD 73 00    	ld	(ix), e
1203   4510 AF          	xor	a		; limpa carry
1204   4511 C9          	ret
1205   4512             
1206   4512             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1207   4512             				; BC = 0
1208   4512             				; DE = C_SIZE
1209   4512 CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1210   4514 CB 12       	rl	d
1211   4516 CB 11       	rl	c
1212   4518 CB 10       	rl	b
1213   451A 3D          	dec	a		; subtraimos 1
1214   451B 20 F5       	jr	nz,.eleva2
1215   451D C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1216   451E             
1217   451E             ; -----------------------------------
1218   451E             ; Registro CSD versao 2, calcular da
1219   451E             ; maneira correta para a versao 2
1220   451E             ; -----------------------------------
1221   451E             .calculaCSD2: 
1222   451E 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1223   451F 23          	inc	hl
1224   4520 7E          	ld	a, (hl)
1225   4521 E6 3F       	and	$3F
1226   4523 4F          	ld	c, a
1227   4524 23          	inc	hl
1228   4525 56          	ld	d, (hl)
1229   4526 23          	inc	hl
1230   4527 5E          	ld	e, (hl)
1231   4528 CD 34 45    	call	.inc32		; soma 1
1232   452B CD 3C 45    	call	.desloca32	; multiplica por 512
1233   452E CD 41 45    	call	.rotaciona24	; multiplica por 2
1234   4531 C3 07 45    	jp		.salvaBlocos
1235   4534             
1236   4534             .inc32: 
1237   4534 1C          	inc	e
1238   4535 C0          	ret	nz
1239   4536 14          	inc	d
1240   4537 C0          	ret	nz
1241   4538 0C          	inc	c
1242   4539 C0          	ret	nz
1243   453A 04          	inc	b
1244   453B C9          	ret
1245   453C             
1246   453C             .desloca32: 
1247   453C 41          	ld	b, c
1248   453D 4A          	ld	c, d
1249   453E 53          	ld	d, e
1250   453F 1E 00       	ld	e, 0
1251   4541             .rotaciona24: 
1252   4541 CB 22       	sla	d
1253   4543 CB 11       	rl	c
1254   4545 CB 10       	rl	b
1255   4547 C9          	ret
1256   4548             
1257   4548             ; ------------------------------------------------
1258   4548             ; Setar o tamanho do bloco para 512 se o cartao
1259   4548             ; for SDV1
1260   4548             ; ------------------------------------------------
1261   4548             mudarTamanhoBlocoPara512: 
1262   4548 3E 50       	ld	a, CMD16
1263   454A 01 00 00    	ld	bc, 0
1264   454D 11 00 02    	ld	de, 512
1265   4550 C3 EF 45    	jp	SD_SEND_CMD_GET_ERROR
1266   4553             
1267   4553             ; ------------------------------------------------
1268   4553             ; Tenta inicializar um cartao SDV2, se houver erro
1269   4553             ; o cartao deve ser SDV1
1270   4553             ; ------------------------------------------------
1271   4553             testaSDCV2: 
1272   4553 3E 48       	ld	a, CMD8
1273   4555 11 AA 01    	ld	de, $1AA
1274   4558 CD 04 46    	call	SD_SEND_CMD_2_ARGS_GET_R3
1275   455B 21 E8 45    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1276   455E 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1277   4560 21 DA 45    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1278   4563             .pula: 
1279   4563 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1280   4566             .loop: 
1281   4566 C5          	push	bc
1282   4567 CD 73 45    	call	.jumpHL		; chamar rotina correta em HL
1283   456A C1          	pop	bc
1284   456B D0          	ret	nc
1285   456C 10 F8       	djnz	.loop
1286   456E 0D          	dec	c
1287   456F 20 F5       	jr	nz,.loop
1288   4571 37          	scf
1289   4572 C9          	ret
1290   4573             .jumpHL: 
1291   4573 E9          	jp	(hl)		; chamar rotina correta em HL
1292   4574             
1293   4574             ; ------------------------------------------------
1294   4574             ; Ler registro CID ou CSD, o comando vem em A
1295   4574             ; ------------------------------------------------
1296   4574             lerBlocoCxD: 
1297   4574 CD EA 45    	call	SD_SEND_CMD_NO_ARGS
1298   4577 D8          	ret	c
1299   4578 CD 49 46    	call	WAIT_RESP_FE
1300   457B D8          	ret	c
1301   457C EB          	ex	de,hl
1302   457D             
1303   457D             	; Check for a Z80 or R800
1304   457D             ;	or 	a		; Clear Cy
1305   457D 3E 14       	ld	a,20
1306   457F ED F9       	db	#ED,#F9		; mulub a,a
1307   4581 21 00 7B    	ld	hl, SPIDATA
1308   4584 38 26       	jr	c,.r800		; Use LDIR for R800
1309   4586 ED A0       > ldi	
1309   4588 ED A0       > ldi	
1309   458A ED A0       > ldi	
1309   458C ED A0       > ldi	
1309   458E ED A0       > ldi	
1309   4590 ED A0       > ldi	
1309   4592 ED A0       > ldi	
1309   4594 ED A0       > ldi	
1309   4596 ED A0       > ldi	
1309   4598 ED A0       > ldi	
1309   459A ED A0       > ldi	
1309   459C ED A0       > ldi	
1309   459E ED A0       > ldi	
1309   45A0 ED A0       > ldi	
1309   45A2 ED A0       > ldi	
1309   45A4 ED A0       > ldi	
1310   45A6             .end
1311   45A6 7E           	ld	a, (hl)
1312   45A7 7E          	ld	a, (hl)		; byte de resposta
1313   45A8 B7          	or	a
1314   45A9 EB          	ex	de,hl
1315   45AA 18 26       	jr		desabilitaSDs
1316   45AC             
1317   45AC             .r800: 
1318   45AC 01 10 00    	ld	bc,16
1319   45AF ED B0       	ldir
1320   45B1 18 F3       	jr	.end
1321   45B3             
1322   45B3             ; ------------------------------------------------
1323   45B3             ; Algoritmo para inicializar um cartao SD
1324   45B3             ; Destroi AF, B, DE
1325   45B3             ; ------------------------------------------------
1326   45B3             iniciaSD: 
1327   45B3 CD D2 45    	call	desabilitaSDs
1328   45B6             
1329   45B6 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1330   45B8             enviaClocksInicio: 
1331   45B8 3E FF       	ld	a, $FF		; manter MOSI em 1
1332   45BA 32 00 7B    	ld	(SPIDATA), a
1333   45BD 10 F9       	djnz	enviaClocksInicio
1334   45BF CD 75 46    	call	setaSDAtual	; ativar cartao atual
1335   45C2 06 08       	ld	b, 8		; 8 tentativas para CMD0
1336   45C4             SD_SEND_CMD0: 
1337   45C4 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1338   45C6 11 00 00    	ld	de, 0
1339   45C9 C5          	push	bc
1340   45CA CD F7 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1341   45CD C1          	pop	bc
1342   45CE D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1343   45CF 10 F3       	djnz	SD_SEND_CMD0
1344   45D1 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1345   45D2             	; fall throw
1346   45D2             
1347   45D2             ; ------------------------------------------------
1348   45D2             ; Desabilitar (de-selecionar) todos os cartoes
1349   45D2             ; Nao destroi registradores
1350   45D2             ; ------------------------------------------------
1351   45D2             desabilitaSDs: 
1352   45D2 F5          	push	af
1353   45D3 3E FF       	ld	a, $FF		; todos os /CS em 1
1354   45D5 32 00 7F    	ld	(SPICTRL), a
1355   45D8 F1          	pop	af
1356   45D9 C9          	ret
1357   45DA             
1358   45DA             ; ------------------------------------------------
1359   45DA             ; Enviar comando ACMD41
1360   45DA             ; ------------------------------------------------
1361   45DA             SD_SEND_ACMD41: 
1362   45DA 3E 77       	ld	a, CMD55
1363   45DC CD EA 45    	call	SD_SEND_CMD_NO_ARGS
1364   45DF 3E 69       	ld	a, ACMD41
1365   45E1 01 00 40    	ld	bc, $4000
1366   45E4 51          	ld	d, c
1367   45E5 59          	ld	e, c
1368   45E6 18 07       	jr		SD_SEND_CMD_GET_ERROR
1369   45E8             
1370   45E8             ; ------------------------------------------------
1371   45E8             ; Enviar CMD1 para cartao. Carry indica erro
1372   45E8             ; Destroi AF, BC, DE
1373   45E8             ; ------------------------------------------------
1374   45E8             SD_SEND_CMD1: 
1375   45E8 3E 41       	ld	a, CMD1
1376   45EA             SD_SEND_CMD_NO_ARGS: 
1377   45EA 01 00 00    	ld	bc, 0
1378   45ED 50          	ld	d, b
1379   45EE 59          	ld	e, c
1380   45EF             SD_SEND_CMD_GET_ERROR: 
1381   45EF CD 1D 46    	call	SD_SEND_CMD
1382   45F2 B7          	or	a
1383   45F3 C8          	ret	z			; se A=0 nao houve erro, retornar
1384   45F4             	; fall throw
1385   45F4             
1386   45F4             ; ------------------------------------------------
1387   45F4             ; Informar erro
1388   45F4             ; Nao destroi registradores
1389   45F4             ; ------------------------------------------------
1390   45F4             setaErro: 
1391   45F4 37          	scf
1392   45F5 18 DB       	jr		desabilitaSDs
1393   45F7             
1394   45F7             ; ------------------------------------------------
1395   45F7             ; Enviar comando em A com 2 bytes de parametros
1396   45F7             ; em DE e testar retorno BUSY
1397   45F7             ; Retorna em A a resposta do cartao
1398   45F7             ; Destroi AF, BC
1399   45F7             ; ------------------------------------------------
1400   45F7             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1401   45F7 01 00 00    	ld	bc, 0
1402   45FA CD 1D 46    	call	SD_SEND_CMD
1403   45FD 47          	ld	b, a
1404   45FE E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1405   4600 78          	ld	a, b
1406   4601 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1407   4603 C9          	ret			; sem erros
1408   4604             
1409   4604             ; ------------------------------------------------
1410   4604             ; Enviar comando em A com 2 bytes de parametros
1411   4604             ; em DE e ler resposta do tipo R3 em BC DE
1412   4604             ; Retorna em A a resposta do cartao
1413   4604             ; Destroi AF, BC, DE, HL
1414   4604             ; ------------------------------------------------
1415   4604             SD_SEND_CMD_2_ARGS_GET_R3: 
1416   4604 CD F7 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1417   4607 D8          	ret	c
1418   4608 F5          	push	af
1419   4609 CD 57 46    	call	WAIT_RESP_NO_FF
1420   460C 67          	ld	h, a
1421   460D CD 57 46    	call	WAIT_RESP_NO_FF
1422   4610 6F          	ld	l, a
1423   4611 CD 57 46    	call	WAIT_RESP_NO_FF
1424   4614 57          	ld	d, a
1425   4615 CD 57 46    	call	WAIT_RESP_NO_FF
1426   4618 5F          	ld	e, a
1427   4619 44          	ld	b, h
1428   461A 4D          	ld	c, l
1429   461B F1          	pop	af
1430   461C C9          	ret
1431   461D             
1432   461D             ; ------------------------------------------------
1433   461D             ; Enviar comando em A com 4 bytes de parametros
1434   461D             ; em BC DE e enviar CRC correto se for CMD0 ou 
1435   461D             ; CMD8 e aguardar processamento do cartao
1436   461D             ; Destroi AF, BC
1437   461D             ; ------------------------------------------------
1438   461D             SD_SEND_CMD: 
1439   461D CD 75 46    	call	setaSDAtual
1440   4620 32 00 7B    	ld	(SPIDATA), a
1441   4623 F5          	push	af
1442   4624 78          	ld	a, b
1443   4625 32 00 7B    	ld	(SPIDATA), a
1444   4628 79          	ld	a, c
1445   4629 32 00 7B    	ld	(SPIDATA), a
1446   462C 7A          	ld	a, d
1447   462D 32 00 7B    	ld	(SPIDATA), a
1448   4630 7B          	ld	a, e
1449   4631 32 00 7B    	ld	(SPIDATA), a
1450   4634 F1          	pop	af
1451   4635 FE 40       	cp	CMD0
1452   4637 06 95       	ld	b, $95		; CRC para CMD0
1453   4639 28 08       	jr	z,enviaCRC
1454   463B FE 48       	cp	CMD8
1455   463D 06 87       	ld	b, $87		; CRC para CMD8
1456   463F 28 02       	jr	z,enviaCRC
1457   4641 06 FF       	ld	b, $FF		; CRC dummy
1458   4643             enviaCRC: 
1459   4643 78          	ld	a, b
1460   4644 32 00 7B    	ld	(SPIDATA), a
1461   4647 18 0E       	jr	WAIT_RESP_NO_FF
1462   4649             
1463   4649             ; ------------------------------------------------
1464   4649             ; Esperar que resposta do cartao seja $FE
1465   4649             ; Destroi AF, B
1466   4649             ; ------------------------------------------------
1467   4649             WAIT_RESP_FE: 
1468   4649 06 0A       	ld	b, 10		; 10 tentativas
1469   464B             .loop: 
1470   464B C5          	push	bc
1471   464C CD 57 46    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1472   464F C1          	pop	bc
1473   4650 FE FE       	cp	$FE		; resposta é $FE ?
1474   4652 C8          	ret	z		; sim, retornamos com carry=0
1475   4653 10 F6       	djnz	.loop
1476   4655 37          	scf			; erro, carry=1
1477   4656 C9          	ret
1478   4657             
1479   4657             ; ------------------------------------------------
1480   4657             ; Esperar que resposta do cartao seja diferente
1481   4657             ; de $FF
1482   4657             ; Destroi AF, BC
1483   4657             ; ------------------------------------------------
1484   4657             WAIT_RESP_NO_FF: 
1485   4657 01 01 00    	ld	bc, 1		; 256 tentativas
1486   465A             .loop: 
1487   465A 3A 00 7B    	ld	a, (SPIDATA)
1488   465D FE FF       	cp	$FF		; testa $FF
1489   465F C0          	ret		nz		; sai se nao for $FF
1490   4660 10 F8       	djnz	.loop
1491   4662 0D          	dec	c
1492   4663 20 F5       	jr	nz,.loop
1493   4665 C9          	ret
1494   4666             
1495   4666             ; ------------------------------------------------
1496   4666             ; Esperar que resposta do cartao seja diferente
1497   4666             ; de $00
1498   4666             ; Destroi A, BC
1499   4666             ; ------------------------------------------------
1500   4666             WAIT_RESP_NO_00: 
1501   4666 01 80 00    	ld	bc, 128		; 32768 tentativas
1502   4669             .loop: 
1503   4669 3A 00 7B    	ld	a, (SPIDATA)
1504   466C B7          	or	a
1505   466D C0          	ret	nz			; se resposta for <> $00, sai
1506   466E 10 F9       	djnz	.loop
1507   4670 0D          	dec	c
1508   4671 20 F6       	jr	nz,.loop
1509   4673 37          	scf			; erro
1510   4674 C9          	ret
1511   4675             
1512   4675             ; ------------------------------------------------
1513   4675             ; Ativa (seleciona) cartao atual baixando seu /CS
1514   4675             ; Nao destroi registradores
1515   4675             ; ------------------------------------------------
1516   4675             setaSDAtual: 
1517   4675 F5          	push	af
1518   4676 3A 00 7B    	ld	a, (SPIDATA)	; dummy read
1519   4679 FD 7E 30    	ld	a, (iy+NUMSD)
1520   467C 2F          	cpl			; inverte bits
1521   467D 32 00 7F    	ld	(SPICTRL), a
1522   4680 F1          	pop	af
1523   4681 C9          	ret
1524   4682             
1525   4682             
1526   4682             ; ------------------------------------------------
1527   4682             ; Grava um bloco de 512 bytes no cartao
1528   4682             ; HL aponta para o inicio dos dados
1529   4682             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1530   4682             ; Destroi AF, BC, DE, HL
1531   4682             ; ------------------------------------------------
1532   4682             GravarBloco: 
1533   4682 DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1534   4685 B7          	or	a
1535   4686 CC BC 57    	call	z,blocoParaByte		; se for SDV1 coverter blocos para bytes
1536   4689 CD 75 46    	call	setaSDAtual	; selecionar cartao atual
1537   468C FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer gravar 1 ou mais blocos
1538   468F 3D          	dec	a
1539   4690 CA 0D 4B    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1540   4693             
1541   4693             ; multiplos blocos
1542   4693 C5          	push	bc
1543   4694 D5          	push	de
1544   4695 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1545   4697 CD EA 45    	call	SD_SEND_CMD_NO_ARGS
1546   469A 3E 57       	ld	a, ACMD23
1547   469C 01 00 00    	ld	bc, 0
1548   469F 51          	ld	d, c
1549   46A0 FD 5E 32    	ld	e, (iy+NUMBLOCOS)	; parametro = total de blocos a gravar
1550   46A3 CD EF 45    	call	SD_SEND_CMD_GET_ERROR
1551   46A6 D1          	pop	de
1552   46A7 C1          	pop	bc
1553   46A8 DA 44 4F    	jp	c,terminaLeituraEscritaBloco	; erro no ACMD23
1554   46AB 3E 59       	ld	a, CMD25	; comando CMD25 = write multiple blocks
1555   46AD CD EF 45    	call	SD_SEND_CMD_GET_ERROR
1556   46B0 DA 44 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1557   46B3             .loop: 
1558   46B3 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados sao
1559   46B5 32 00 7B    	ld	(SPIDATA),a	; dados para gravacao
1560   46B8             	; Check for a Z80 or R800
1561   46B8 EB          	ex	de,hl
1562   46B9             ;	or 	a		; Clear Cy
1563   46B9 3E 14       	ld	a,20
1564   46BB ED F9       	db	#ED,#F9		; mulub a,a
1565   46BD EB          	ex	de,hl
1566   46BE 11 00 7B    	ld	de, SPIDATA
1567   46C1 DA FE 4A    	jp	c,.r800m	; Use LDIR for R800
1568   46C4 ED A0       > ldi		
1568   46C6 ED A0       > ldi		
1568   46C8 ED A0       > ldi		
1568   46CA ED A0       > ldi		
1568   46CC ED A0       > ldi		
1568   46CE ED A0       > ldi		
1568   46D0 ED A0       > ldi		
1568   46D2 ED A0       > ldi		
1568   46D4 ED A0       > ldi		
1568   46D6 ED A0       > ldi		
1568   46D8 ED A0       > ldi		
1568   46DA ED A0       > ldi		
1568   46DC ED A0       > ldi		
1568   46DE ED A0       > ldi		
1568   46E0 ED A0       > ldi		
1568   46E2 ED A0       > ldi		
1568   46E4 ED A0       > ldi		
1568   46E6 ED A0       > ldi		
1568   46E8 ED A0       > ldi		
1568   46EA ED A0       > ldi		
1568   46EC ED A0       > ldi		
1568   46EE ED A0       > ldi		
1568   46F0 ED A0       > ldi		
1568   46F2 ED A0       > ldi		
1568   46F4 ED A0       > ldi		
1568   46F6 ED A0       > ldi		
1568   46F8 ED A0       > ldi		
1568   46FA ED A0       > ldi		
1568   46FC ED A0       > ldi		
1568   46FE ED A0       > ldi		
1568   4700 ED A0       > ldi		
1568   4702 ED A0       > ldi		
1568   4704 ED A0       > ldi		
1568   4706 ED A0       > ldi		
1568   4708 ED A0       > ldi		
1568   470A ED A0       > ldi		
1568   470C ED A0       > ldi		
1568   470E ED A0       > ldi		
1568   4710 ED A0       > ldi		
1568   4712 ED A0       > ldi		
1568   4714 ED A0       > ldi		
1568   4716 ED A0       > ldi		
1568   4718 ED A0       > ldi		
1568   471A ED A0       > ldi		
1568   471C ED A0       > ldi		
1568   471E ED A0       > ldi		
1568   4720 ED A0       > ldi		
1568   4722 ED A0       > ldi		
1568   4724 ED A0       > ldi		
1568   4726 ED A0       > ldi		
1568   4728 ED A0       > ldi		
1568   472A ED A0       > ldi		
1568   472C ED A0       > ldi		
1568   472E ED A0       > ldi		
1568   4730 ED A0       > ldi		
1568   4732 ED A0       > ldi		
1568   4734 ED A0       > ldi		
1568   4736 ED A0       > ldi		
1568   4738 ED A0       > ldi		
1568   473A ED A0       > ldi		
1568   473C ED A0       > ldi		
1568   473E ED A0       > ldi		
1568   4740 ED A0       > ldi		
1568   4742 ED A0       > ldi		
1568   4744 ED A0       > ldi		
1568   4746 ED A0       > ldi		
1568   4748 ED A0       > ldi		
1568   474A ED A0       > ldi		
1568   474C ED A0       > ldi		
1568   474E ED A0       > ldi		
1568   4750 ED A0       > ldi		
1568   4752 ED A0       > ldi		
1568   4754 ED A0       > ldi		
1568   4756 ED A0       > ldi		
1568   4758 ED A0       > ldi		
1568   475A ED A0       > ldi		
1568   475C ED A0       > ldi		
1568   475E ED A0       > ldi		
1568   4760 ED A0       > ldi		
1568   4762 ED A0       > ldi		
1568   4764 ED A0       > ldi		
1568   4766 ED A0       > ldi		
1568   4768 ED A0       > ldi		
1568   476A ED A0       > ldi		
1568   476C ED A0       > ldi		
1568   476E ED A0       > ldi		
1568   4770 ED A0       > ldi		
1568   4772 ED A0       > ldi		
1568   4774 ED A0       > ldi		
1568   4776 ED A0       > ldi		
1568   4778 ED A0       > ldi		
1568   477A ED A0       > ldi		
1568   477C ED A0       > ldi		
1568   477E ED A0       > ldi		
1568   4780 ED A0       > ldi		
1568   4782 ED A0       > ldi		
1568   4784 ED A0       > ldi		
1568   4786 ED A0       > ldi		
1568   4788 ED A0       > ldi		
1568   478A ED A0       > ldi		
1568   478C ED A0       > ldi		
1568   478E ED A0       > ldi		
1568   4790 ED A0       > ldi		
1568   4792 ED A0       > ldi		
1568   4794 ED A0       > ldi		
1568   4796 ED A0       > ldi		
1568   4798 ED A0       > ldi		
1568   479A ED A0       > ldi		
1568   479C ED A0       > ldi		
1568   479E ED A0       > ldi		
1568   47A0 ED A0       > ldi		
1568   47A2 ED A0       > ldi		
1568   47A4 ED A0       > ldi		
1568   47A6 ED A0       > ldi		
1568   47A8 ED A0       > ldi		
1568   47AA ED A0       > ldi		
1568   47AC ED A0       > ldi		
1568   47AE ED A0       > ldi		
1568   47B0 ED A0       > ldi		
1568   47B2 ED A0       > ldi		
1568   47B4 ED A0       > ldi		
1568   47B6 ED A0       > ldi		
1568   47B8 ED A0       > ldi		
1568   47BA ED A0       > ldi		
1568   47BC ED A0       > ldi		
1568   47BE ED A0       > ldi		
1568   47C0 ED A0       > ldi		
1568   47C2 ED A0       > ldi		
1568   47C4 ED A0       > ldi		
1568   47C6 ED A0       > ldi		
1568   47C8 ED A0       > ldi		
1568   47CA ED A0       > ldi		
1568   47CC ED A0       > ldi		
1568   47CE ED A0       > ldi		
1568   47D0 ED A0       > ldi		
1568   47D2 ED A0       > ldi		
1568   47D4 ED A0       > ldi		
1568   47D6 ED A0       > ldi		
1568   47D8 ED A0       > ldi		
1568   47DA ED A0       > ldi		
1568   47DC ED A0       > ldi		
1568   47DE ED A0       > ldi		
1568   47E0 ED A0       > ldi		
1568   47E2 ED A0       > ldi		
1568   47E4 ED A0       > ldi		
1568   47E6 ED A0       > ldi		
1568   47E8 ED A0       > ldi		
1568   47EA ED A0       > ldi		
1568   47EC ED A0       > ldi		
1568   47EE ED A0       > ldi		
1568   47F0 ED A0       > ldi		
1568   47F2 ED A0       > ldi		
1568   47F4 ED A0       > ldi		
1568   47F6 ED A0       > ldi		
1568   47F8 ED A0       > ldi		
1568   47FA ED A0       > ldi		
1568   47FC ED A0       > ldi		
1568   47FE ED A0       > ldi		
1568   4800 ED A0       > ldi		
1568   4802 ED A0       > ldi		
1568   4804 ED A0       > ldi		
1568   4806 ED A0       > ldi		
1568   4808 ED A0       > ldi		
1568   480A ED A0       > ldi		
1568   480C ED A0       > ldi		
1568   480E ED A0       > ldi		
1568   4810 ED A0       > ldi		
1568   4812 ED A0       > ldi		
1568   4814 ED A0       > ldi		
1568   4816 ED A0       > ldi		
1568   4818 ED A0       > ldi		
1568   481A ED A0       > ldi		
1568   481C ED A0       > ldi		
1568   481E ED A0       > ldi		
1568   4820 ED A0       > ldi		
1568   4822 ED A0       > ldi		
1568   4824 ED A0       > ldi		
1568   4826 ED A0       > ldi		
1568   4828 ED A0       > ldi		
1568   482A ED A0       > ldi		
1568   482C ED A0       > ldi		
1568   482E ED A0       > ldi		
1568   4830 ED A0       > ldi		
1568   4832 ED A0       > ldi		
1568   4834 ED A0       > ldi		
1568   4836 ED A0       > ldi		
1568   4838 ED A0       > ldi		
1568   483A ED A0       > ldi		
1568   483C ED A0       > ldi		
1568   483E ED A0       > ldi		
1568   4840 ED A0       > ldi		
1568   4842 ED A0       > ldi		
1568   4844 ED A0       > ldi		
1568   4846 ED A0       > ldi		
1568   4848 ED A0       > ldi		
1568   484A ED A0       > ldi		
1568   484C ED A0       > ldi		
1568   484E ED A0       > ldi		
1568   4850 ED A0       > ldi		
1568   4852 ED A0       > ldi		
1568   4854 ED A0       > ldi		
1568   4856 ED A0       > ldi		
1568   4858 ED A0       > ldi		
1568   485A ED A0       > ldi		
1568   485C ED A0       > ldi		
1568   485E ED A0       > ldi		
1568   4860 ED A0       > ldi		
1568   4862 ED A0       > ldi		
1568   4864 ED A0       > ldi		
1568   4866 ED A0       > ldi		
1568   4868 ED A0       > ldi		
1568   486A ED A0       > ldi		
1568   486C ED A0       > ldi		
1568   486E ED A0       > ldi		
1568   4870 ED A0       > ldi		
1568   4872 ED A0       > ldi		
1568   4874 ED A0       > ldi		
1568   4876 ED A0       > ldi		
1568   4878 ED A0       > ldi		
1568   487A ED A0       > ldi		
1568   487C ED A0       > ldi		
1568   487E ED A0       > ldi		
1568   4880 ED A0       > ldi		
1568   4882 ED A0       > ldi		
1568   4884 ED A0       > ldi		
1568   4886 ED A0       > ldi		
1568   4888 ED A0       > ldi		
1568   488A ED A0       > ldi		
1568   488C ED A0       > ldi		
1568   488E ED A0       > ldi		
1568   4890 ED A0       > ldi		
1568   4892 ED A0       > ldi		
1568   4894 ED A0       > ldi		
1568   4896 ED A0       > ldi		
1568   4898 ED A0       > ldi		
1568   489A ED A0       > ldi		
1568   489C ED A0       > ldi		
1568   489E ED A0       > ldi		
1568   48A0 ED A0       > ldi		
1568   48A2 ED A0       > ldi		
1568   48A4 ED A0       > ldi		
1568   48A6 ED A0       > ldi		
1568   48A8 ED A0       > ldi		
1568   48AA ED A0       > ldi		
1568   48AC ED A0       > ldi		
1568   48AE ED A0       > ldi		
1568   48B0 ED A0       > ldi		
1568   48B2 ED A0       > ldi		
1568   48B4 ED A0       > ldi		
1568   48B6 ED A0       > ldi		
1568   48B8 ED A0       > ldi		
1568   48BA ED A0       > ldi		
1568   48BC ED A0       > ldi		
1568   48BE ED A0       > ldi		
1568   48C0 ED A0       > ldi		
1568   48C2 ED A0       > ldi		
1568   48C4 ED A0       > ldi		
1568   48C6 ED A0       > ldi		
1568   48C8 ED A0       > ldi		
1568   48CA ED A0       > ldi		
1568   48CC ED A0       > ldi		
1568   48CE ED A0       > ldi		
1568   48D0 ED A0       > ldi		
1568   48D2 ED A0       > ldi		
1568   48D4 ED A0       > ldi		
1568   48D6 ED A0       > ldi		
1568   48D8 ED A0       > ldi		
1568   48DA ED A0       > ldi		
1568   48DC ED A0       > ldi		
1568   48DE ED A0       > ldi		
1568   48E0 ED A0       > ldi		
1568   48E2 ED A0       > ldi		
1568   48E4 ED A0       > ldi		
1568   48E6 ED A0       > ldi		
1568   48E8 ED A0       > ldi		
1568   48EA ED A0       > ldi		
1568   48EC ED A0       > ldi		
1568   48EE ED A0       > ldi		
1568   48F0 ED A0       > ldi		
1568   48F2 ED A0       > ldi		
1568   48F4 ED A0       > ldi		
1568   48F6 ED A0       > ldi		
1568   48F8 ED A0       > ldi		
1568   48FA ED A0       > ldi		
1568   48FC ED A0       > ldi		
1568   48FE ED A0       > ldi		
1568   4900 ED A0       > ldi		
1568   4902 ED A0       > ldi		
1568   4904 ED A0       > ldi		
1568   4906 ED A0       > ldi		
1568   4908 ED A0       > ldi		
1568   490A ED A0       > ldi		
1568   490C ED A0       > ldi		
1568   490E ED A0       > ldi		
1568   4910 ED A0       > ldi		
1568   4912 ED A0       > ldi		
1568   4914 ED A0       > ldi		
1568   4916 ED A0       > ldi		
1568   4918 ED A0       > ldi		
1568   491A ED A0       > ldi		
1568   491C ED A0       > ldi		
1568   491E ED A0       > ldi		
1568   4920 ED A0       > ldi		
1568   4922 ED A0       > ldi		
1568   4924 ED A0       > ldi		
1568   4926 ED A0       > ldi		
1568   4928 ED A0       > ldi		
1568   492A ED A0       > ldi		
1568   492C ED A0       > ldi		
1568   492E ED A0       > ldi		
1568   4930 ED A0       > ldi		
1568   4932 ED A0       > ldi		
1568   4934 ED A0       > ldi		
1568   4936 ED A0       > ldi		
1568   4938 ED A0       > ldi		
1568   493A ED A0       > ldi		
1568   493C ED A0       > ldi		
1568   493E ED A0       > ldi		
1568   4940 ED A0       > ldi		
1568   4942 ED A0       > ldi		
1568   4944 ED A0       > ldi		
1568   4946 ED A0       > ldi		
1568   4948 ED A0       > ldi		
1568   494A ED A0       > ldi		
1568   494C ED A0       > ldi		
1568   494E ED A0       > ldi		
1568   4950 ED A0       > ldi		
1568   4952 ED A0       > ldi		
1568   4954 ED A0       > ldi		
1568   4956 ED A0       > ldi		
1568   4958 ED A0       > ldi		
1568   495A ED A0       > ldi		
1568   495C ED A0       > ldi		
1568   495E ED A0       > ldi		
1568   4960 ED A0       > ldi		
1568   4962 ED A0       > ldi		
1568   4964 ED A0       > ldi		
1568   4966 ED A0       > ldi		
1568   4968 ED A0       > ldi		
1568   496A ED A0       > ldi		
1568   496C ED A0       > ldi		
1568   496E ED A0       > ldi		
1568   4970 ED A0       > ldi		
1568   4972 ED A0       > ldi		
1568   4974 ED A0       > ldi		
1568   4976 ED A0       > ldi		
1568   4978 ED A0       > ldi		
1568   497A ED A0       > ldi		
1568   497C ED A0       > ldi		
1568   497E ED A0       > ldi		
1568   4980 ED A0       > ldi		
1568   4982 ED A0       > ldi		
1568   4984 ED A0       > ldi		
1568   4986 ED A0       > ldi		
1568   4988 ED A0       > ldi		
1568   498A ED A0       > ldi		
1568   498C ED A0       > ldi		
1568   498E ED A0       > ldi		
1568   4990 ED A0       > ldi		
1568   4992 ED A0       > ldi		
1568   4994 ED A0       > ldi		
1568   4996 ED A0       > ldi		
1568   4998 ED A0       > ldi		
1568   499A ED A0       > ldi		
1568   499C ED A0       > ldi		
1568   499E ED A0       > ldi		
1568   49A0 ED A0       > ldi		
1568   49A2 ED A0       > ldi		
1568   49A4 ED A0       > ldi		
1568   49A6 ED A0       > ldi		
1568   49A8 ED A0       > ldi		
1568   49AA ED A0       > ldi		
1568   49AC ED A0       > ldi		
1568   49AE ED A0       > ldi		
1568   49B0 ED A0       > ldi		
1568   49B2 ED A0       > ldi		
1568   49B4 ED A0       > ldi		
1568   49B6 ED A0       > ldi		
1568   49B8 ED A0       > ldi		
1568   49BA ED A0       > ldi		
1568   49BC ED A0       > ldi		
1568   49BE ED A0       > ldi		
1568   49C0 ED A0       > ldi		
1568   49C2 ED A0       > ldi		
1568   49C4 ED A0       > ldi		
1568   49C6 ED A0       > ldi		
1568   49C8 ED A0       > ldi		
1568   49CA ED A0       > ldi		
1568   49CC ED A0       > ldi		
1568   49CE ED A0       > ldi		
1568   49D0 ED A0       > ldi		
1568   49D2 ED A0       > ldi		
1568   49D4 ED A0       > ldi		
1568   49D6 ED A0       > ldi		
1568   49D8 ED A0       > ldi		
1568   49DA ED A0       > ldi		
1568   49DC ED A0       > ldi		
1568   49DE ED A0       > ldi		
1568   49E0 ED A0       > ldi		
1568   49E2 ED A0       > ldi		
1568   49E4 ED A0       > ldi		
1568   49E6 ED A0       > ldi		
1568   49E8 ED A0       > ldi		
1568   49EA ED A0       > ldi		
1568   49EC ED A0       > ldi		
1568   49EE ED A0       > ldi		
1568   49F0 ED A0       > ldi		
1568   49F2 ED A0       > ldi		
1568   49F4 ED A0       > ldi		
1568   49F6 ED A0       > ldi		
1568   49F8 ED A0       > ldi		
1568   49FA ED A0       > ldi		
1568   49FC ED A0       > ldi		
1568   49FE ED A0       > ldi		
1568   4A00 ED A0       > ldi		
1568   4A02 ED A0       > ldi		
1568   4A04 ED A0       > ldi		
1568   4A06 ED A0       > ldi		
1568   4A08 ED A0       > ldi		
1568   4A0A ED A0       > ldi		
1568   4A0C ED A0       > ldi		
1568   4A0E ED A0       > ldi		
1568   4A10 ED A0       > ldi		
1568   4A12 ED A0       > ldi		
1568   4A14 ED A0       > ldi		
1568   4A16 ED A0       > ldi		
1568   4A18 ED A0       > ldi		
1568   4A1A ED A0       > ldi		
1568   4A1C ED A0       > ldi		
1568   4A1E ED A0       > ldi		
1568   4A20 ED A0       > ldi		
1568   4A22 ED A0       > ldi		
1568   4A24 ED A0       > ldi		
1568   4A26 ED A0       > ldi		
1568   4A28 ED A0       > ldi		
1568   4A2A ED A0       > ldi		
1568   4A2C ED A0       > ldi		
1568   4A2E ED A0       > ldi		
1568   4A30 ED A0       > ldi		
1568   4A32 ED A0       > ldi		
1568   4A34 ED A0       > ldi		
1568   4A36 ED A0       > ldi		
1568   4A38 ED A0       > ldi		
1568   4A3A ED A0       > ldi		
1568   4A3C ED A0       > ldi		
1568   4A3E ED A0       > ldi		
1568   4A40 ED A0       > ldi		
1568   4A42 ED A0       > ldi		
1568   4A44 ED A0       > ldi		
1568   4A46 ED A0       > ldi		
1568   4A48 ED A0       > ldi		
1568   4A4A ED A0       > ldi		
1568   4A4C ED A0       > ldi		
1568   4A4E ED A0       > ldi		
1568   4A50 ED A0       > ldi		
1568   4A52 ED A0       > ldi		
1568   4A54 ED A0       > ldi		
1568   4A56 ED A0       > ldi		
1568   4A58 ED A0       > ldi		
1568   4A5A ED A0       > ldi		
1568   4A5C ED A0       > ldi		
1568   4A5E ED A0       > ldi		
1568   4A60 ED A0       > ldi		
1568   4A62 ED A0       > ldi		
1568   4A64 ED A0       > ldi		
1568   4A66 ED A0       > ldi		
1568   4A68 ED A0       > ldi		
1568   4A6A ED A0       > ldi		
1568   4A6C ED A0       > ldi		
1568   4A6E ED A0       > ldi		
1568   4A70 ED A0       > ldi		
1568   4A72 ED A0       > ldi		
1568   4A74 ED A0       > ldi		
1568   4A76 ED A0       > ldi		
1568   4A78 ED A0       > ldi		
1568   4A7A ED A0       > ldi		
1568   4A7C ED A0       > ldi		
1568   4A7E ED A0       > ldi		
1568   4A80 ED A0       > ldi		
1568   4A82 ED A0       > ldi		
1568   4A84 ED A0       > ldi		
1568   4A86 ED A0       > ldi		
1568   4A88 ED A0       > ldi		
1568   4A8A ED A0       > ldi		
1568   4A8C ED A0       > ldi		
1568   4A8E ED A0       > ldi		
1568   4A90 ED A0       > ldi		
1568   4A92 ED A0       > ldi		
1568   4A94 ED A0       > ldi		
1568   4A96 ED A0       > ldi		
1568   4A98 ED A0       > ldi		
1568   4A9A ED A0       > ldi		
1568   4A9C ED A0       > ldi		
1568   4A9E ED A0       > ldi		
1568   4AA0 ED A0       > ldi		
1568   4AA2 ED A0       > ldi		
1568   4AA4 ED A0       > ldi		
1568   4AA6 ED A0       > ldi		
1568   4AA8 ED A0       > ldi		
1568   4AAA ED A0       > ldi		
1568   4AAC ED A0       > ldi		
1568   4AAE ED A0       > ldi		
1568   4AB0 ED A0       > ldi		
1568   4AB2 ED A0       > ldi		
1568   4AB4 ED A0       > ldi		
1568   4AB6 ED A0       > ldi		
1568   4AB8 ED A0       > ldi		
1568   4ABA ED A0       > ldi		
1568   4ABC ED A0       > ldi		
1568   4ABE ED A0       > ldi		
1568   4AC0 ED A0       > ldi		
1568   4AC2 ED A0       > ldi		
1569   4AC4             .part2m: 
1570   4AC4 3E FF       	ld	a, $FF		; envia dummy CRC
1571   4AC6 32 00 7B    	ld	(SPIDATA),a
1572   4AC9 32 00 7B    	ld	(SPIDATA),a
1573   4ACC CD 57 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1574   4ACF E6 1F       	and	$1F		; testa bits erro
1575   4AD1 FE 05       	cp	5
1576   4AD3 37          	scf
1577   4AD4 C2 44 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1578   4AD7 CD 66 46    	call	WAIT_RESP_NO_00	; esperar cartao
1579   4ADA DA 44 4F    	jp	c,terminaLeituraEscritaBloco
1580   4ADD FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para gravar
1581   4AE0 3D          	dec	a
1582   4AE1 FD 77 32    	ld	(iy+NUMBLOCOS), a
1583   4AE4 C2 B3 46    	jp	nz,.loop
1584   4AE7 3A 00 7B    	ld	a, (SPIDATA)	; acabou os blocos, fazer 2 dummy reads
1585   4AEA 3A 00 7B    	ld	a, (SPIDATA)
1586   4AED 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1587   4AEF 32 00 7B    	ld	(SPIDATA),a
1588   4AF2 3A 00 7B    	ld	a, (SPIDATA)	; dummy reads
1589   4AF5 3A 00 7B    	ld	a, (SPIDATA)
1590   4AF8 CD 66 46    	call	WAIT_RESP_NO_00	; esperar cartao
1591   4AFB C3 43 4F    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1592   4AFE             
1593   4AFE 01 00 02    .r800m: 	ld	bc,512
1594   4B01 ED B0       	ldir
1595   4B03 18 BF       	jr	.part2m
1596   4B05             
1597   4B05 01 00 02    .r800s: 	ld	bc,512
1598   4B08 ED B0       	ldir
1599   4B0A C3 25 4F    	jp	.part2s
1600   4B0D             
1601   4B0D             .umBloco: 
1602   4B0D 3E 58       	ld	a, CMD24	; gravar somente um bloco com comando CMD24 = Write Single Block
1603   4B0F CD EF 45    	call	SD_SEND_CMD_GET_ERROR
1604   4B12 DA 44 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1605   4B15             
1606   4B15 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1607   4B17 32 00 7B    	ld	(SPIDATA),a
1608   4B1A             
1609   4B1A             	; Check for a Z80 or R800
1610   4B1A EB          	ex	de,hl
1611   4B1B             ;	or 	a		; Clear Cy
1612   4B1B 3E 14       	ld	a,20
1613   4B1D ED F9       	db	#ED,#F9		; mulub a,a
1614   4B1F EB          	ex	de,hl
1615   4B20 11 00 7B    	ld	de, SPIDATA
1616   4B23 38 E0       	jr	c,.r800s	; Use LDIR for R800
1617   4B25 ED A0       > ldi
1617   4B27 ED A0       > ldi
1617   4B29 ED A0       > ldi
1617   4B2B ED A0       > ldi
1617   4B2D ED A0       > ldi
1617   4B2F ED A0       > ldi
1617   4B31 ED A0       > ldi
1617   4B33 ED A0       > ldi
1617   4B35 ED A0       > ldi
1617   4B37 ED A0       > ldi
1617   4B39 ED A0       > ldi
1617   4B3B ED A0       > ldi
1617   4B3D ED A0       > ldi
1617   4B3F ED A0       > ldi
1617   4B41 ED A0       > ldi
1617   4B43 ED A0       > ldi
1617   4B45 ED A0       > ldi
1617   4B47 ED A0       > ldi
1617   4B49 ED A0       > ldi
1617   4B4B ED A0       > ldi
1617   4B4D ED A0       > ldi
1617   4B4F ED A0       > ldi
1617   4B51 ED A0       > ldi
1617   4B53 ED A0       > ldi
1617   4B55 ED A0       > ldi
1617   4B57 ED A0       > ldi
1617   4B59 ED A0       > ldi
1617   4B5B ED A0       > ldi
1617   4B5D ED A0       > ldi
1617   4B5F ED A0       > ldi
1617   4B61 ED A0       > ldi
1617   4B63 ED A0       > ldi
1617   4B65 ED A0       > ldi
1617   4B67 ED A0       > ldi
1617   4B69 ED A0       > ldi
1617   4B6B ED A0       > ldi
1617   4B6D ED A0       > ldi
1617   4B6F ED A0       > ldi
1617   4B71 ED A0       > ldi
1617   4B73 ED A0       > ldi
1617   4B75 ED A0       > ldi
1617   4B77 ED A0       > ldi
1617   4B79 ED A0       > ldi
1617   4B7B ED A0       > ldi
1617   4B7D ED A0       > ldi
1617   4B7F ED A0       > ldi
1617   4B81 ED A0       > ldi
1617   4B83 ED A0       > ldi
1617   4B85 ED A0       > ldi
1617   4B87 ED A0       > ldi
1617   4B89 ED A0       > ldi
1617   4B8B ED A0       > ldi
1617   4B8D ED A0       > ldi
1617   4B8F ED A0       > ldi
1617   4B91 ED A0       > ldi
1617   4B93 ED A0       > ldi
1617   4B95 ED A0       > ldi
1617   4B97 ED A0       > ldi
1617   4B99 ED A0       > ldi
1617   4B9B ED A0       > ldi
1617   4B9D ED A0       > ldi
1617   4B9F ED A0       > ldi
1617   4BA1 ED A0       > ldi
1617   4BA3 ED A0       > ldi
1617   4BA5 ED A0       > ldi
1617   4BA7 ED A0       > ldi
1617   4BA9 ED A0       > ldi
1617   4BAB ED A0       > ldi
1617   4BAD ED A0       > ldi
1617   4BAF ED A0       > ldi
1617   4BB1 ED A0       > ldi
1617   4BB3 ED A0       > ldi
1617   4BB5 ED A0       > ldi
1617   4BB7 ED A0       > ldi
1617   4BB9 ED A0       > ldi
1617   4BBB ED A0       > ldi
1617   4BBD ED A0       > ldi
1617   4BBF ED A0       > ldi
1617   4BC1 ED A0       > ldi
1617   4BC3 ED A0       > ldi
1617   4BC5 ED A0       > ldi
1617   4BC7 ED A0       > ldi
1617   4BC9 ED A0       > ldi
1617   4BCB ED A0       > ldi
1617   4BCD ED A0       > ldi
1617   4BCF ED A0       > ldi
1617   4BD1 ED A0       > ldi
1617   4BD3 ED A0       > ldi
1617   4BD5 ED A0       > ldi
1617   4BD7 ED A0       > ldi
1617   4BD9 ED A0       > ldi
1617   4BDB ED A0       > ldi
1617   4BDD ED A0       > ldi
1617   4BDF ED A0       > ldi
1617   4BE1 ED A0       > ldi
1617   4BE3 ED A0       > ldi
1617   4BE5 ED A0       > ldi
1617   4BE7 ED A0       > ldi
1617   4BE9 ED A0       > ldi
1617   4BEB ED A0       > ldi
1617   4BED ED A0       > ldi
1617   4BEF ED A0       > ldi
1617   4BF1 ED A0       > ldi
1617   4BF3 ED A0       > ldi
1617   4BF5 ED A0       > ldi
1617   4BF7 ED A0       > ldi
1617   4BF9 ED A0       > ldi
1617   4BFB ED A0       > ldi
1617   4BFD ED A0       > ldi
1617   4BFF ED A0       > ldi
1617   4C01 ED A0       > ldi
1617   4C03 ED A0       > ldi
1617   4C05 ED A0       > ldi
1617   4C07 ED A0       > ldi
1617   4C09 ED A0       > ldi
1617   4C0B ED A0       > ldi
1617   4C0D ED A0       > ldi
1617   4C0F ED A0       > ldi
1617   4C11 ED A0       > ldi
1617   4C13 ED A0       > ldi
1617   4C15 ED A0       > ldi
1617   4C17 ED A0       > ldi
1617   4C19 ED A0       > ldi
1617   4C1B ED A0       > ldi
1617   4C1D ED A0       > ldi
1617   4C1F ED A0       > ldi
1617   4C21 ED A0       > ldi
1617   4C23 ED A0       > ldi
1617   4C25 ED A0       > ldi
1617   4C27 ED A0       > ldi
1617   4C29 ED A0       > ldi
1617   4C2B ED A0       > ldi
1617   4C2D ED A0       > ldi
1617   4C2F ED A0       > ldi
1617   4C31 ED A0       > ldi
1617   4C33 ED A0       > ldi
1617   4C35 ED A0       > ldi
1617   4C37 ED A0       > ldi
1617   4C39 ED A0       > ldi
1617   4C3B ED A0       > ldi
1617   4C3D ED A0       > ldi
1617   4C3F ED A0       > ldi
1617   4C41 ED A0       > ldi
1617   4C43 ED A0       > ldi
1617   4C45 ED A0       > ldi
1617   4C47 ED A0       > ldi
1617   4C49 ED A0       > ldi
1617   4C4B ED A0       > ldi
1617   4C4D ED A0       > ldi
1617   4C4F ED A0       > ldi
1617   4C51 ED A0       > ldi
1617   4C53 ED A0       > ldi
1617   4C55 ED A0       > ldi
1617   4C57 ED A0       > ldi
1617   4C59 ED A0       > ldi
1617   4C5B ED A0       > ldi
1617   4C5D ED A0       > ldi
1617   4C5F ED A0       > ldi
1617   4C61 ED A0       > ldi
1617   4C63 ED A0       > ldi
1617   4C65 ED A0       > ldi
1617   4C67 ED A0       > ldi
1617   4C69 ED A0       > ldi
1617   4C6B ED A0       > ldi
1617   4C6D ED A0       > ldi
1617   4C6F ED A0       > ldi
1617   4C71 ED A0       > ldi
1617   4C73 ED A0       > ldi
1617   4C75 ED A0       > ldi
1617   4C77 ED A0       > ldi
1617   4C79 ED A0       > ldi
1617   4C7B ED A0       > ldi
1617   4C7D ED A0       > ldi
1617   4C7F ED A0       > ldi
1617   4C81 ED A0       > ldi
1617   4C83 ED A0       > ldi
1617   4C85 ED A0       > ldi
1617   4C87 ED A0       > ldi
1617   4C89 ED A0       > ldi
1617   4C8B ED A0       > ldi
1617   4C8D ED A0       > ldi
1617   4C8F ED A0       > ldi
1617   4C91 ED A0       > ldi
1617   4C93 ED A0       > ldi
1617   4C95 ED A0       > ldi
1617   4C97 ED A0       > ldi
1617   4C99 ED A0       > ldi
1617   4C9B ED A0       > ldi
1617   4C9D ED A0       > ldi
1617   4C9F ED A0       > ldi
1617   4CA1 ED A0       > ldi
1617   4CA3 ED A0       > ldi
1617   4CA5 ED A0       > ldi
1617   4CA7 ED A0       > ldi
1617   4CA9 ED A0       > ldi
1617   4CAB ED A0       > ldi
1617   4CAD ED A0       > ldi
1617   4CAF ED A0       > ldi
1617   4CB1 ED A0       > ldi
1617   4CB3 ED A0       > ldi
1617   4CB5 ED A0       > ldi
1617   4CB7 ED A0       > ldi
1617   4CB9 ED A0       > ldi
1617   4CBB ED A0       > ldi
1617   4CBD ED A0       > ldi
1617   4CBF ED A0       > ldi
1617   4CC1 ED A0       > ldi
1617   4CC3 ED A0       > ldi
1617   4CC5 ED A0       > ldi
1617   4CC7 ED A0       > ldi
1617   4CC9 ED A0       > ldi
1617   4CCB ED A0       > ldi
1617   4CCD ED A0       > ldi
1617   4CCF ED A0       > ldi
1617   4CD1 ED A0       > ldi
1617   4CD3 ED A0       > ldi
1617   4CD5 ED A0       > ldi
1617   4CD7 ED A0       > ldi
1617   4CD9 ED A0       > ldi
1617   4CDB ED A0       > ldi
1617   4CDD ED A0       > ldi
1617   4CDF ED A0       > ldi
1617   4CE1 ED A0       > ldi
1617   4CE3 ED A0       > ldi
1617   4CE5 ED A0       > ldi
1617   4CE7 ED A0       > ldi
1617   4CE9 ED A0       > ldi
1617   4CEB ED A0       > ldi
1617   4CED ED A0       > ldi
1617   4CEF ED A0       > ldi
1617   4CF1 ED A0       > ldi
1617   4CF3 ED A0       > ldi
1617   4CF5 ED A0       > ldi
1617   4CF7 ED A0       > ldi
1617   4CF9 ED A0       > ldi
1617   4CFB ED A0       > ldi
1617   4CFD ED A0       > ldi
1617   4CFF ED A0       > ldi
1617   4D01 ED A0       > ldi
1617   4D03 ED A0       > ldi
1617   4D05 ED A0       > ldi
1617   4D07 ED A0       > ldi
1617   4D09 ED A0       > ldi
1617   4D0B ED A0       > ldi
1617   4D0D ED A0       > ldi
1617   4D0F ED A0       > ldi
1617   4D11 ED A0       > ldi
1617   4D13 ED A0       > ldi
1617   4D15 ED A0       > ldi
1617   4D17 ED A0       > ldi
1617   4D19 ED A0       > ldi
1617   4D1B ED A0       > ldi
1617   4D1D ED A0       > ldi
1617   4D1F ED A0       > ldi
1617   4D21 ED A0       > ldi
1617   4D23 ED A0       > ldi
1617   4D25 ED A0       > ldi
1617   4D27 ED A0       > ldi
1617   4D29 ED A0       > ldi
1617   4D2B ED A0       > ldi
1617   4D2D ED A0       > ldi
1617   4D2F ED A0       > ldi
1617   4D31 ED A0       > ldi
1617   4D33 ED A0       > ldi
1617   4D35 ED A0       > ldi
1617   4D37 ED A0       > ldi
1617   4D39 ED A0       > ldi
1617   4D3B ED A0       > ldi
1617   4D3D ED A0       > ldi
1617   4D3F ED A0       > ldi
1617   4D41 ED A0       > ldi
1617   4D43 ED A0       > ldi
1617   4D45 ED A0       > ldi
1617   4D47 ED A0       > ldi
1617   4D49 ED A0       > ldi
1617   4D4B ED A0       > ldi
1617   4D4D ED A0       > ldi
1617   4D4F ED A0       > ldi
1617   4D51 ED A0       > ldi
1617   4D53 ED A0       > ldi
1617   4D55 ED A0       > ldi
1617   4D57 ED A0       > ldi
1617   4D59 ED A0       > ldi
1617   4D5B ED A0       > ldi
1617   4D5D ED A0       > ldi
1617   4D5F ED A0       > ldi
1617   4D61 ED A0       > ldi
1617   4D63 ED A0       > ldi
1617   4D65 ED A0       > ldi
1617   4D67 ED A0       > ldi
1617   4D69 ED A0       > ldi
1617   4D6B ED A0       > ldi
1617   4D6D ED A0       > ldi
1617   4D6F ED A0       > ldi
1617   4D71 ED A0       > ldi
1617   4D73 ED A0       > ldi
1617   4D75 ED A0       > ldi
1617   4D77 ED A0       > ldi
1617   4D79 ED A0       > ldi
1617   4D7B ED A0       > ldi
1617   4D7D ED A0       > ldi
1617   4D7F ED A0       > ldi
1617   4D81 ED A0       > ldi
1617   4D83 ED A0       > ldi
1617   4D85 ED A0       > ldi
1617   4D87 ED A0       > ldi
1617   4D89 ED A0       > ldi
1617   4D8B ED A0       > ldi
1617   4D8D ED A0       > ldi
1617   4D8F ED A0       > ldi
1617   4D91 ED A0       > ldi
1617   4D93 ED A0       > ldi
1617   4D95 ED A0       > ldi
1617   4D97 ED A0       > ldi
1617   4D99 ED A0       > ldi
1617   4D9B ED A0       > ldi
1617   4D9D ED A0       > ldi
1617   4D9F ED A0       > ldi
1617   4DA1 ED A0       > ldi
1617   4DA3 ED A0       > ldi
1617   4DA5 ED A0       > ldi
1617   4DA7 ED A0       > ldi
1617   4DA9 ED A0       > ldi
1617   4DAB ED A0       > ldi
1617   4DAD ED A0       > ldi
1617   4DAF ED A0       > ldi
1617   4DB1 ED A0       > ldi
1617   4DB3 ED A0       > ldi
1617   4DB5 ED A0       > ldi
1617   4DB7 ED A0       > ldi
1617   4DB9 ED A0       > ldi
1617   4DBB ED A0       > ldi
1617   4DBD ED A0       > ldi
1617   4DBF ED A0       > ldi
1617   4DC1 ED A0       > ldi
1617   4DC3 ED A0       > ldi
1617   4DC5 ED A0       > ldi
1617   4DC7 ED A0       > ldi
1617   4DC9 ED A0       > ldi
1617   4DCB ED A0       > ldi
1617   4DCD ED A0       > ldi
1617   4DCF ED A0       > ldi
1617   4DD1 ED A0       > ldi
1617   4DD3 ED A0       > ldi
1617   4DD5 ED A0       > ldi
1617   4DD7 ED A0       > ldi
1617   4DD9 ED A0       > ldi
1617   4DDB ED A0       > ldi
1617   4DDD ED A0       > ldi
1617   4DDF ED A0       > ldi
1617   4DE1 ED A0       > ldi
1617   4DE3 ED A0       > ldi
1617   4DE5 ED A0       > ldi
1617   4DE7 ED A0       > ldi
1617   4DE9 ED A0       > ldi
1617   4DEB ED A0       > ldi
1617   4DED ED A0       > ldi
1617   4DEF ED A0       > ldi
1617   4DF1 ED A0       > ldi
1617   4DF3 ED A0       > ldi
1617   4DF5 ED A0       > ldi
1617   4DF7 ED A0       > ldi
1617   4DF9 ED A0       > ldi
1617   4DFB ED A0       > ldi
1617   4DFD ED A0       > ldi
1617   4DFF ED A0       > ldi
1617   4E01 ED A0       > ldi
1617   4E03 ED A0       > ldi
1617   4E05 ED A0       > ldi
1617   4E07 ED A0       > ldi
1617   4E09 ED A0       > ldi
1617   4E0B ED A0       > ldi
1617   4E0D ED A0       > ldi
1617   4E0F ED A0       > ldi
1617   4E11 ED A0       > ldi
1617   4E13 ED A0       > ldi
1617   4E15 ED A0       > ldi
1617   4E17 ED A0       > ldi
1617   4E19 ED A0       > ldi
1617   4E1B ED A0       > ldi
1617   4E1D ED A0       > ldi
1617   4E1F ED A0       > ldi
1617   4E21 ED A0       > ldi
1617   4E23 ED A0       > ldi
1617   4E25 ED A0       > ldi
1617   4E27 ED A0       > ldi
1617   4E29 ED A0       > ldi
1617   4E2B ED A0       > ldi
1617   4E2D ED A0       > ldi
1617   4E2F ED A0       > ldi
1617   4E31 ED A0       > ldi
1617   4E33 ED A0       > ldi
1617   4E35 ED A0       > ldi
1617   4E37 ED A0       > ldi
1617   4E39 ED A0       > ldi
1617   4E3B ED A0       > ldi
1617   4E3D ED A0       > ldi
1617   4E3F ED A0       > ldi
1617   4E41 ED A0       > ldi
1617   4E43 ED A0       > ldi
1617   4E45 ED A0       > ldi
1617   4E47 ED A0       > ldi
1617   4E49 ED A0       > ldi
1617   4E4B ED A0       > ldi
1617   4E4D ED A0       > ldi
1617   4E4F ED A0       > ldi
1617   4E51 ED A0       > ldi
1617   4E53 ED A0       > ldi
1617   4E55 ED A0       > ldi
1617   4E57 ED A0       > ldi
1617   4E59 ED A0       > ldi
1617   4E5B ED A0       > ldi
1617   4E5D ED A0       > ldi
1617   4E5F ED A0       > ldi
1617   4E61 ED A0       > ldi
1617   4E63 ED A0       > ldi
1617   4E65 ED A0       > ldi
1617   4E67 ED A0       > ldi
1617   4E69 ED A0       > ldi
1617   4E6B ED A0       > ldi
1617   4E6D ED A0       > ldi
1617   4E6F ED A0       > ldi
1617   4E71 ED A0       > ldi
1617   4E73 ED A0       > ldi
1617   4E75 ED A0       > ldi
1617   4E77 ED A0       > ldi
1617   4E79 ED A0       > ldi
1617   4E7B ED A0       > ldi
1617   4E7D ED A0       > ldi
1617   4E7F ED A0       > ldi
1617   4E81 ED A0       > ldi
1617   4E83 ED A0       > ldi
1617   4E85 ED A0       > ldi
1617   4E87 ED A0       > ldi
1617   4E89 ED A0       > ldi
1617   4E8B ED A0       > ldi
1617   4E8D ED A0       > ldi
1617   4E8F ED A0       > ldi
1617   4E91 ED A0       > ldi
1617   4E93 ED A0       > ldi
1617   4E95 ED A0       > ldi
1617   4E97 ED A0       > ldi
1617   4E99 ED A0       > ldi
1617   4E9B ED A0       > ldi
1617   4E9D ED A0       > ldi
1617   4E9F ED A0       > ldi
1617   4EA1 ED A0       > ldi
1617   4EA3 ED A0       > ldi
1617   4EA5 ED A0       > ldi
1617   4EA7 ED A0       > ldi
1617   4EA9 ED A0       > ldi
1617   4EAB ED A0       > ldi
1617   4EAD ED A0       > ldi
1617   4EAF ED A0       > ldi
1617   4EB1 ED A0       > ldi
1617   4EB3 ED A0       > ldi
1617   4EB5 ED A0       > ldi
1617   4EB7 ED A0       > ldi
1617   4EB9 ED A0       > ldi
1617   4EBB ED A0       > ldi
1617   4EBD ED A0       > ldi
1617   4EBF ED A0       > ldi
1617   4EC1 ED A0       > ldi
1617   4EC3 ED A0       > ldi
1617   4EC5 ED A0       > ldi
1617   4EC7 ED A0       > ldi
1617   4EC9 ED A0       > ldi
1617   4ECB ED A0       > ldi
1617   4ECD ED A0       > ldi
1617   4ECF ED A0       > ldi
1617   4ED1 ED A0       > ldi
1617   4ED3 ED A0       > ldi
1617   4ED5 ED A0       > ldi
1617   4ED7 ED A0       > ldi
1617   4ED9 ED A0       > ldi
1617   4EDB ED A0       > ldi
1617   4EDD ED A0       > ldi
1617   4EDF ED A0       > ldi
1617   4EE1 ED A0       > ldi
1617   4EE3 ED A0       > ldi
1617   4EE5 ED A0       > ldi
1617   4EE7 ED A0       > ldi
1617   4EE9 ED A0       > ldi
1617   4EEB ED A0       > ldi
1617   4EED ED A0       > ldi
1617   4EEF ED A0       > ldi
1617   4EF1 ED A0       > ldi
1617   4EF3 ED A0       > ldi
1617   4EF5 ED A0       > ldi
1617   4EF7 ED A0       > ldi
1617   4EF9 ED A0       > ldi
1617   4EFB ED A0       > ldi
1617   4EFD ED A0       > ldi
1617   4EFF ED A0       > ldi
1617   4F01 ED A0       > ldi
1617   4F03 ED A0       > ldi
1617   4F05 ED A0       > ldi
1617   4F07 ED A0       > ldi
1617   4F09 ED A0       > ldi
1617   4F0B ED A0       > ldi
1617   4F0D ED A0       > ldi
1617   4F0F ED A0       > ldi
1617   4F11 ED A0       > ldi
1617   4F13 ED A0       > ldi
1617   4F15 ED A0       > ldi
1617   4F17 ED A0       > ldi
1617   4F19 ED A0       > ldi
1617   4F1B ED A0       > ldi
1617   4F1D ED A0       > ldi
1617   4F1F ED A0       > ldi
1617   4F21 ED A0       > ldi
1617   4F23 ED A0       > ldi
1618   4F25             .part2s: 
1619   4F25 01 00 02    	ld	bc,512
1620   4F28 ED B0       	ldir
1621   4F2A 3E FF       	ld	a, $FF		; envia dummy CRC
1622   4F2C 32 00 7B    	ld	(SPIDATA),a
1623   4F2F 32 00 7B    	ld	(SPIDATA),a
1624   4F32 CD 57 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1625   4F35 E6 1F       	and	$1F		; testa bits erro
1626   4F37 FE 05       	cp	5
1627   4F39 37          	scf
1628   4F3A C2 44 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1629   4F3D             .esp: 
1630   4F3D CD 57 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1631   4F40 B7          	or	a
1632   4F41 28 FA       	jr	z,.esp
1633   4F43             .fim: 
1634   4F43 AF          	xor	a		; zera carry e informa nenhum erro
1635   4F44             terminaLeituraEscritaBloco: 
1636   4F44 F5          	push	af
1637   4F45 CD D2 45    	call	desabilitaSDs	; desabilitar todos os cartoes
1638   4F48 F1          	pop	af
1639   4F49 C9          	ret
1640   4F4A             
1641   4F4A             
1642   4F4A             ; ------------------------------------------------
1643   4F4A             ; Ler um bloco de 512 bytes do cartao
1644   4F4A             ; HL aponta para o inicio dos dados
1645   4F4A             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1646   4F4A             ; Destroi AF, BC, DE, HL
1647   4F4A             ; ------------------------------------------------
1648   4F4A             LerBloco: 
1649   4F4A DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1650   4F4D B7          	or	a
1651   4F4E CC BC 57    	call	z,blocoParaByte	; se for SDV1 coverter blocos para bytes
1652   4F51 CD 75 46    	call	setaSDAtual
1653   4F54             
1654   4F54             
1655   4F54             
1656   4F54 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer ler um ou mais blocos
1657   4F57 3D          	dec	a
1658   4F58 CA 9C 53    	jp	z,.umBloco	; somente um bloco, pular
1659   4F5B             
1660   4F5B             ; multiplos blocos
1661   4F5B 3E 52       	ld	a, CMD18	; ler multiplos blocos com CMD18 = Read Multiple Blocks
1662   4F5D CD EF 45    	call	SD_SEND_CMD_GET_ERROR
1663   4F60 DA 44 4F    	jp	c,terminaLeituraEscritaBloco
1664   4F63             .loop: 
1665   4F63 CD 49 46    	call	WAIT_RESP_FE
1666   4F66 DA 44 4F    	jp	c,terminaLeituraEscritaBloco
1667   4F69 EB          	ex	de,hl
1668   4F6A             	; Check for a Z80 or R800
1669   4F6A             ;	or 	a		; Clear Cy
1670   4F6A 3E 14       	ld	a,20
1671   4F6C ED F9       	db	#ED,#F9		; mulub a,a
1672   4F6E 21 00 7B    	ld	hl, SPIDATA
1673   4F71 DA 8D 53    	jp	c,.r800m	; Use LDIR for R800
1674   4F74 ED A0       > ldi
1674   4F76 ED A0       > ldi
1674   4F78 ED A0       > ldi
1674   4F7A ED A0       > ldi
1674   4F7C ED A0       > ldi
1674   4F7E ED A0       > ldi
1674   4F80 ED A0       > ldi
1674   4F82 ED A0       > ldi
1674   4F84 ED A0       > ldi
1674   4F86 ED A0       > ldi
1674   4F88 ED A0       > ldi
1674   4F8A ED A0       > ldi
1674   4F8C ED A0       > ldi
1674   4F8E ED A0       > ldi
1674   4F90 ED A0       > ldi
1674   4F92 ED A0       > ldi
1674   4F94 ED A0       > ldi
1674   4F96 ED A0       > ldi
1674   4F98 ED A0       > ldi
1674   4F9A ED A0       > ldi
1674   4F9C ED A0       > ldi
1674   4F9E ED A0       > ldi
1674   4FA0 ED A0       > ldi
1674   4FA2 ED A0       > ldi
1674   4FA4 ED A0       > ldi
1674   4FA6 ED A0       > ldi
1674   4FA8 ED A0       > ldi
1674   4FAA ED A0       > ldi
1674   4FAC ED A0       > ldi
1674   4FAE ED A0       > ldi
1674   4FB0 ED A0       > ldi
1674   4FB2 ED A0       > ldi
1674   4FB4 ED A0       > ldi
1674   4FB6 ED A0       > ldi
1674   4FB8 ED A0       > ldi
1674   4FBA ED A0       > ldi
1674   4FBC ED A0       > ldi
1674   4FBE ED A0       > ldi
1674   4FC0 ED A0       > ldi
1674   4FC2 ED A0       > ldi
1674   4FC4 ED A0       > ldi
1674   4FC6 ED A0       > ldi
1674   4FC8 ED A0       > ldi
1674   4FCA ED A0       > ldi
1674   4FCC ED A0       > ldi
1674   4FCE ED A0       > ldi
1674   4FD0 ED A0       > ldi
1674   4FD2 ED A0       > ldi
1674   4FD4 ED A0       > ldi
1674   4FD6 ED A0       > ldi
1674   4FD8 ED A0       > ldi
1674   4FDA ED A0       > ldi
1674   4FDC ED A0       > ldi
1674   4FDE ED A0       > ldi
1674   4FE0 ED A0       > ldi
1674   4FE2 ED A0       > ldi
1674   4FE4 ED A0       > ldi
1674   4FE6 ED A0       > ldi
1674   4FE8 ED A0       > ldi
1674   4FEA ED A0       > ldi
1674   4FEC ED A0       > ldi
1674   4FEE ED A0       > ldi
1674   4FF0 ED A0       > ldi
1674   4FF2 ED A0       > ldi
1674   4FF4 ED A0       > ldi
1674   4FF6 ED A0       > ldi
1674   4FF8 ED A0       > ldi
1674   4FFA ED A0       > ldi
1674   4FFC ED A0       > ldi
1674   4FFE ED A0       > ldi
1674   5000 ED A0       > ldi
1674   5002 ED A0       > ldi
1674   5004 ED A0       > ldi
1674   5006 ED A0       > ldi
1674   5008 ED A0       > ldi
1674   500A ED A0       > ldi
1674   500C ED A0       > ldi
1674   500E ED A0       > ldi
1674   5010 ED A0       > ldi
1674   5012 ED A0       > ldi
1674   5014 ED A0       > ldi
1674   5016 ED A0       > ldi
1674   5018 ED A0       > ldi
1674   501A ED A0       > ldi
1674   501C ED A0       > ldi
1674   501E ED A0       > ldi
1674   5020 ED A0       > ldi
1674   5022 ED A0       > ldi
1674   5024 ED A0       > ldi
1674   5026 ED A0       > ldi
1674   5028 ED A0       > ldi
1674   502A ED A0       > ldi
1674   502C ED A0       > ldi
1674   502E ED A0       > ldi
1674   5030 ED A0       > ldi
1674   5032 ED A0       > ldi
1674   5034 ED A0       > ldi
1674   5036 ED A0       > ldi
1674   5038 ED A0       > ldi
1674   503A ED A0       > ldi
1674   503C ED A0       > ldi
1674   503E ED A0       > ldi
1674   5040 ED A0       > ldi
1674   5042 ED A0       > ldi
1674   5044 ED A0       > ldi
1674   5046 ED A0       > ldi
1674   5048 ED A0       > ldi
1674   504A ED A0       > ldi
1674   504C ED A0       > ldi
1674   504E ED A0       > ldi
1674   5050 ED A0       > ldi
1674   5052 ED A0       > ldi
1674   5054 ED A0       > ldi
1674   5056 ED A0       > ldi
1674   5058 ED A0       > ldi
1674   505A ED A0       > ldi
1674   505C ED A0       > ldi
1674   505E ED A0       > ldi
1674   5060 ED A0       > ldi
1674   5062 ED A0       > ldi
1674   5064 ED A0       > ldi
1674   5066 ED A0       > ldi
1674   5068 ED A0       > ldi
1674   506A ED A0       > ldi
1674   506C ED A0       > ldi
1674   506E ED A0       > ldi
1674   5070 ED A0       > ldi
1674   5072 ED A0       > ldi
1674   5074 ED A0       > ldi
1674   5076 ED A0       > ldi
1674   5078 ED A0       > ldi
1674   507A ED A0       > ldi
1674   507C ED A0       > ldi
1674   507E ED A0       > ldi
1674   5080 ED A0       > ldi
1674   5082 ED A0       > ldi
1674   5084 ED A0       > ldi
1674   5086 ED A0       > ldi
1674   5088 ED A0       > ldi
1674   508A ED A0       > ldi
1674   508C ED A0       > ldi
1674   508E ED A0       > ldi
1674   5090 ED A0       > ldi
1674   5092 ED A0       > ldi
1674   5094 ED A0       > ldi
1674   5096 ED A0       > ldi
1674   5098 ED A0       > ldi
1674   509A ED A0       > ldi
1674   509C ED A0       > ldi
1674   509E ED A0       > ldi
1674   50A0 ED A0       > ldi
1674   50A2 ED A0       > ldi
1674   50A4 ED A0       > ldi
1674   50A6 ED A0       > ldi
1674   50A8 ED A0       > ldi
1674   50AA ED A0       > ldi
1674   50AC ED A0       > ldi
1674   50AE ED A0       > ldi
1674   50B0 ED A0       > ldi
1674   50B2 ED A0       > ldi
1674   50B4 ED A0       > ldi
1674   50B6 ED A0       > ldi
1674   50B8 ED A0       > ldi
1674   50BA ED A0       > ldi
1674   50BC ED A0       > ldi
1674   50BE ED A0       > ldi
1674   50C0 ED A0       > ldi
1674   50C2 ED A0       > ldi
1674   50C4 ED A0       > ldi
1674   50C6 ED A0       > ldi
1674   50C8 ED A0       > ldi
1674   50CA ED A0       > ldi
1674   50CC ED A0       > ldi
1674   50CE ED A0       > ldi
1674   50D0 ED A0       > ldi
1674   50D2 ED A0       > ldi
1674   50D4 ED A0       > ldi
1674   50D6 ED A0       > ldi
1674   50D8 ED A0       > ldi
1674   50DA ED A0       > ldi
1674   50DC ED A0       > ldi
1674   50DE ED A0       > ldi
1674   50E0 ED A0       > ldi
1674   50E2 ED A0       > ldi
1674   50E4 ED A0       > ldi
1674   50E6 ED A0       > ldi
1674   50E8 ED A0       > ldi
1674   50EA ED A0       > ldi
1674   50EC ED A0       > ldi
1674   50EE ED A0       > ldi
1674   50F0 ED A0       > ldi
1674   50F2 ED A0       > ldi
1674   50F4 ED A0       > ldi
1674   50F6 ED A0       > ldi
1674   50F8 ED A0       > ldi
1674   50FA ED A0       > ldi
1674   50FC ED A0       > ldi
1674   50FE ED A0       > ldi
1674   5100 ED A0       > ldi
1674   5102 ED A0       > ldi
1674   5104 ED A0       > ldi
1674   5106 ED A0       > ldi
1674   5108 ED A0       > ldi
1674   510A ED A0       > ldi
1674   510C ED A0       > ldi
1674   510E ED A0       > ldi
1674   5110 ED A0       > ldi
1674   5112 ED A0       > ldi
1674   5114 ED A0       > ldi
1674   5116 ED A0       > ldi
1674   5118 ED A0       > ldi
1674   511A ED A0       > ldi
1674   511C ED A0       > ldi
1674   511E ED A0       > ldi
1674   5120 ED A0       > ldi
1674   5122 ED A0       > ldi
1674   5124 ED A0       > ldi
1674   5126 ED A0       > ldi
1674   5128 ED A0       > ldi
1674   512A ED A0       > ldi
1674   512C ED A0       > ldi
1674   512E ED A0       > ldi
1674   5130 ED A0       > ldi
1674   5132 ED A0       > ldi
1674   5134 ED A0       > ldi
1674   5136 ED A0       > ldi
1674   5138 ED A0       > ldi
1674   513A ED A0       > ldi
1674   513C ED A0       > ldi
1674   513E ED A0       > ldi
1674   5140 ED A0       > ldi
1674   5142 ED A0       > ldi
1674   5144 ED A0       > ldi
1674   5146 ED A0       > ldi
1674   5148 ED A0       > ldi
1674   514A ED A0       > ldi
1674   514C ED A0       > ldi
1674   514E ED A0       > ldi
1674   5150 ED A0       > ldi
1674   5152 ED A0       > ldi
1674   5154 ED A0       > ldi
1674   5156 ED A0       > ldi
1674   5158 ED A0       > ldi
1674   515A ED A0       > ldi
1674   515C ED A0       > ldi
1674   515E ED A0       > ldi
1674   5160 ED A0       > ldi
1674   5162 ED A0       > ldi
1674   5164 ED A0       > ldi
1674   5166 ED A0       > ldi
1674   5168 ED A0       > ldi
1674   516A ED A0       > ldi
1674   516C ED A0       > ldi
1674   516E ED A0       > ldi
1674   5170 ED A0       > ldi
1674   5172 ED A0       > ldi
1674   5174 ED A0       > ldi
1674   5176 ED A0       > ldi
1674   5178 ED A0       > ldi
1674   517A ED A0       > ldi
1674   517C ED A0       > ldi
1674   517E ED A0       > ldi
1674   5180 ED A0       > ldi
1674   5182 ED A0       > ldi
1674   5184 ED A0       > ldi
1674   5186 ED A0       > ldi
1674   5188 ED A0       > ldi
1674   518A ED A0       > ldi
1674   518C ED A0       > ldi
1674   518E ED A0       > ldi
1674   5190 ED A0       > ldi
1674   5192 ED A0       > ldi
1674   5194 ED A0       > ldi
1674   5196 ED A0       > ldi
1674   5198 ED A0       > ldi
1674   519A ED A0       > ldi
1674   519C ED A0       > ldi
1674   519E ED A0       > ldi
1674   51A0 ED A0       > ldi
1674   51A2 ED A0       > ldi
1674   51A4 ED A0       > ldi
1674   51A6 ED A0       > ldi
1674   51A8 ED A0       > ldi
1674   51AA ED A0       > ldi
1674   51AC ED A0       > ldi
1674   51AE ED A0       > ldi
1674   51B0 ED A0       > ldi
1674   51B2 ED A0       > ldi
1674   51B4 ED A0       > ldi
1674   51B6 ED A0       > ldi
1674   51B8 ED A0       > ldi
1674   51BA ED A0       > ldi
1674   51BC ED A0       > ldi
1674   51BE ED A0       > ldi
1674   51C0 ED A0       > ldi
1674   51C2 ED A0       > ldi
1674   51C4 ED A0       > ldi
1674   51C6 ED A0       > ldi
1674   51C8 ED A0       > ldi
1674   51CA ED A0       > ldi
1674   51CC ED A0       > ldi
1674   51CE ED A0       > ldi
1674   51D0 ED A0       > ldi
1674   51D2 ED A0       > ldi
1674   51D4 ED A0       > ldi
1674   51D6 ED A0       > ldi
1674   51D8 ED A0       > ldi
1674   51DA ED A0       > ldi
1674   51DC ED A0       > ldi
1674   51DE ED A0       > ldi
1674   51E0 ED A0       > ldi
1674   51E2 ED A0       > ldi
1674   51E4 ED A0       > ldi
1674   51E6 ED A0       > ldi
1674   51E8 ED A0       > ldi
1674   51EA ED A0       > ldi
1674   51EC ED A0       > ldi
1674   51EE ED A0       > ldi
1674   51F0 ED A0       > ldi
1674   51F2 ED A0       > ldi
1674   51F4 ED A0       > ldi
1674   51F6 ED A0       > ldi
1674   51F8 ED A0       > ldi
1674   51FA ED A0       > ldi
1674   51FC ED A0       > ldi
1674   51FE ED A0       > ldi
1674   5200 ED A0       > ldi
1674   5202 ED A0       > ldi
1674   5204 ED A0       > ldi
1674   5206 ED A0       > ldi
1674   5208 ED A0       > ldi
1674   520A ED A0       > ldi
1674   520C ED A0       > ldi
1674   520E ED A0       > ldi
1674   5210 ED A0       > ldi
1674   5212 ED A0       > ldi
1674   5214 ED A0       > ldi
1674   5216 ED A0       > ldi
1674   5218 ED A0       > ldi
1674   521A ED A0       > ldi
1674   521C ED A0       > ldi
1674   521E ED A0       > ldi
1674   5220 ED A0       > ldi
1674   5222 ED A0       > ldi
1674   5224 ED A0       > ldi
1674   5226 ED A0       > ldi
1674   5228 ED A0       > ldi
1674   522A ED A0       > ldi
1674   522C ED A0       > ldi
1674   522E ED A0       > ldi
1674   5230 ED A0       > ldi
1674   5232 ED A0       > ldi
1674   5234 ED A0       > ldi
1674   5236 ED A0       > ldi
1674   5238 ED A0       > ldi
1674   523A ED A0       > ldi
1674   523C ED A0       > ldi
1674   523E ED A0       > ldi
1674   5240 ED A0       > ldi
1674   5242 ED A0       > ldi
1674   5244 ED A0       > ldi
1674   5246 ED A0       > ldi
1674   5248 ED A0       > ldi
1674   524A ED A0       > ldi
1674   524C ED A0       > ldi
1674   524E ED A0       > ldi
1674   5250 ED A0       > ldi
1674   5252 ED A0       > ldi
1674   5254 ED A0       > ldi
1674   5256 ED A0       > ldi
1674   5258 ED A0       > ldi
1674   525A ED A0       > ldi
1674   525C ED A0       > ldi
1674   525E ED A0       > ldi
1674   5260 ED A0       > ldi
1674   5262 ED A0       > ldi
1674   5264 ED A0       > ldi
1674   5266 ED A0       > ldi
1674   5268 ED A0       > ldi
1674   526A ED A0       > ldi
1674   526C ED A0       > ldi
1674   526E ED A0       > ldi
1674   5270 ED A0       > ldi
1674   5272 ED A0       > ldi
1674   5274 ED A0       > ldi
1674   5276 ED A0       > ldi
1674   5278 ED A0       > ldi
1674   527A ED A0       > ldi
1674   527C ED A0       > ldi
1674   527E ED A0       > ldi
1674   5280 ED A0       > ldi
1674   5282 ED A0       > ldi
1674   5284 ED A0       > ldi
1674   5286 ED A0       > ldi
1674   5288 ED A0       > ldi
1674   528A ED A0       > ldi
1674   528C ED A0       > ldi
1674   528E ED A0       > ldi
1674   5290 ED A0       > ldi
1674   5292 ED A0       > ldi
1674   5294 ED A0       > ldi
1674   5296 ED A0       > ldi
1674   5298 ED A0       > ldi
1674   529A ED A0       > ldi
1674   529C ED A0       > ldi
1674   529E ED A0       > ldi
1674   52A0 ED A0       > ldi
1674   52A2 ED A0       > ldi
1674   52A4 ED A0       > ldi
1674   52A6 ED A0       > ldi
1674   52A8 ED A0       > ldi
1674   52AA ED A0       > ldi
1674   52AC ED A0       > ldi
1674   52AE ED A0       > ldi
1674   52B0 ED A0       > ldi
1674   52B2 ED A0       > ldi
1674   52B4 ED A0       > ldi
1674   52B6 ED A0       > ldi
1674   52B8 ED A0       > ldi
1674   52BA ED A0       > ldi
1674   52BC ED A0       > ldi
1674   52BE ED A0       > ldi
1674   52C0 ED A0       > ldi
1674   52C2 ED A0       > ldi
1674   52C4 ED A0       > ldi
1674   52C6 ED A0       > ldi
1674   52C8 ED A0       > ldi
1674   52CA ED A0       > ldi
1674   52CC ED A0       > ldi
1674   52CE ED A0       > ldi
1674   52D0 ED A0       > ldi
1674   52D2 ED A0       > ldi
1674   52D4 ED A0       > ldi
1674   52D6 ED A0       > ldi
1674   52D8 ED A0       > ldi
1674   52DA ED A0       > ldi
1674   52DC ED A0       > ldi
1674   52DE ED A0       > ldi
1674   52E0 ED A0       > ldi
1674   52E2 ED A0       > ldi
1674   52E4 ED A0       > ldi
1674   52E6 ED A0       > ldi
1674   52E8 ED A0       > ldi
1674   52EA ED A0       > ldi
1674   52EC ED A0       > ldi
1674   52EE ED A0       > ldi
1674   52F0 ED A0       > ldi
1674   52F2 ED A0       > ldi
1674   52F4 ED A0       > ldi
1674   52F6 ED A0       > ldi
1674   52F8 ED A0       > ldi
1674   52FA ED A0       > ldi
1674   52FC ED A0       > ldi
1674   52FE ED A0       > ldi
1674   5300 ED A0       > ldi
1674   5302 ED A0       > ldi
1674   5304 ED A0       > ldi
1674   5306 ED A0       > ldi
1674   5308 ED A0       > ldi
1674   530A ED A0       > ldi
1674   530C ED A0       > ldi
1674   530E ED A0       > ldi
1674   5310 ED A0       > ldi
1674   5312 ED A0       > ldi
1674   5314 ED A0       > ldi
1674   5316 ED A0       > ldi
1674   5318 ED A0       > ldi
1674   531A ED A0       > ldi
1674   531C ED A0       > ldi
1674   531E ED A0       > ldi
1674   5320 ED A0       > ldi
1674   5322 ED A0       > ldi
1674   5324 ED A0       > ldi
1674   5326 ED A0       > ldi
1674   5328 ED A0       > ldi
1674   532A ED A0       > ldi
1674   532C ED A0       > ldi
1674   532E ED A0       > ldi
1674   5330 ED A0       > ldi
1674   5332 ED A0       > ldi
1674   5334 ED A0       > ldi
1674   5336 ED A0       > ldi
1674   5338 ED A0       > ldi
1674   533A ED A0       > ldi
1674   533C ED A0       > ldi
1674   533E ED A0       > ldi
1674   5340 ED A0       > ldi
1674   5342 ED A0       > ldi
1674   5344 ED A0       > ldi
1674   5346 ED A0       > ldi
1674   5348 ED A0       > ldi
1674   534A ED A0       > ldi
1674   534C ED A0       > ldi
1674   534E ED A0       > ldi
1674   5350 ED A0       > ldi
1674   5352 ED A0       > ldi
1674   5354 ED A0       > ldi
1674   5356 ED A0       > ldi
1674   5358 ED A0       > ldi
1674   535A ED A0       > ldi
1674   535C ED A0       > ldi
1674   535E ED A0       > ldi
1674   5360 ED A0       > ldi
1674   5362 ED A0       > ldi
1674   5364 ED A0       > ldi
1674   5366 ED A0       > ldi
1674   5368 ED A0       > ldi
1674   536A ED A0       > ldi
1674   536C ED A0       > ldi
1674   536E ED A0       > ldi
1674   5370 ED A0       > ldi
1674   5372 ED A0       > ldi
1675   5374             .part2m: 
1676   5374 EB          	ex	de,hl
1677   5375 3A 00 7B    	ld	a, (SPIDATA)	; descarta CRC
1678   5378 3A 00 7B    	ld	a, (SPIDATA)
1679   537B FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para ler
1680   537E 3D          	dec	a
1681   537F FD 77 32    	ld	(iy+NUMBLOCOS), a
1682   5382 C2 63 4F    	jp	nz,.loop
1683   5385 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1684   5387 CD EA 45    	call	SD_SEND_CMD_NO_ARGS
1685   538A C3 B8 57    	jp	.fim
1686   538D             
1687   538D 01 00 02    .r800m:  ld	bc,512
1688   5390 ED B0       	ldir
1689   5392 18 E0       	jr	.part2m
1690   5394             
1691   5394 01 00 02    .r800s: 	ld	bc,512
1692   5397 ED B0       	ldir
1693   5399 C3 B4 57    	jp	.part2s
1694   539C             
1695   539C             .umBloco: 
1696   539C 3E 51       	ld	a, CMD17	; ler somente um bloco com CMD17 = Read Single Block
1697   539E CD EF 45    	call	SD_SEND_CMD_GET_ERROR
1698   53A1 DA 44 4F    	jp	c,terminaLeituraEscritaBloco
1699   53A4             
1700   53A4 CD 49 46    	call	WAIT_RESP_FE
1701   53A7 DA 44 4F    	jp	c,terminaLeituraEscritaBloco
1702   53AA EB          	ex	de,hl
1703   53AB             
1704   53AB             	; Check for a Z80 or R800
1705   53AB             ;	or 	a		; Clear Cy
1706   53AB 3E 14       	ld	a,20
1707   53AD ED F9       	db	#ED,#F9		; mulub a,a
1708   53AF 21 00 7B    	ld	hl, SPIDATA
1709   53B2 38 E0       	jr	c,.r800s	; Use LDIR for R800
1710   53B4 ED A0       > ldi
1710   53B6 ED A0       > ldi
1710   53B8 ED A0       > ldi
1710   53BA ED A0       > ldi
1710   53BC ED A0       > ldi
1710   53BE ED A0       > ldi
1710   53C0 ED A0       > ldi
1710   53C2 ED A0       > ldi
1710   53C4 ED A0       > ldi
1710   53C6 ED A0       > ldi
1710   53C8 ED A0       > ldi
1710   53CA ED A0       > ldi
1710   53CC ED A0       > ldi
1710   53CE ED A0       > ldi
1710   53D0 ED A0       > ldi
1710   53D2 ED A0       > ldi
1710   53D4 ED A0       > ldi
1710   53D6 ED A0       > ldi
1710   53D8 ED A0       > ldi
1710   53DA ED A0       > ldi
1710   53DC ED A0       > ldi
1710   53DE ED A0       > ldi
1710   53E0 ED A0       > ldi
1710   53E2 ED A0       > ldi
1710   53E4 ED A0       > ldi
1710   53E6 ED A0       > ldi
1710   53E8 ED A0       > ldi
1710   53EA ED A0       > ldi
1710   53EC ED A0       > ldi
1710   53EE ED A0       > ldi
1710   53F0 ED A0       > ldi
1710   53F2 ED A0       > ldi
1710   53F4 ED A0       > ldi
1710   53F6 ED A0       > ldi
1710   53F8 ED A0       > ldi
1710   53FA ED A0       > ldi
1710   53FC ED A0       > ldi
1710   53FE ED A0       > ldi
1710   5400 ED A0       > ldi
1710   5402 ED A0       > ldi
1710   5404 ED A0       > ldi
1710   5406 ED A0       > ldi
1710   5408 ED A0       > ldi
1710   540A ED A0       > ldi
1710   540C ED A0       > ldi
1710   540E ED A0       > ldi
1710   5410 ED A0       > ldi
1710   5412 ED A0       > ldi
1710   5414 ED A0       > ldi
1710   5416 ED A0       > ldi
1710   5418 ED A0       > ldi
1710   541A ED A0       > ldi
1710   541C ED A0       > ldi
1710   541E ED A0       > ldi
1710   5420 ED A0       > ldi
1710   5422 ED A0       > ldi
1710   5424 ED A0       > ldi
1710   5426 ED A0       > ldi
1710   5428 ED A0       > ldi
1710   542A ED A0       > ldi
1710   542C ED A0       > ldi
1710   542E ED A0       > ldi
1710   5430 ED A0       > ldi
1710   5432 ED A0       > ldi
1710   5434 ED A0       > ldi
1710   5436 ED A0       > ldi
1710   5438 ED A0       > ldi
1710   543A ED A0       > ldi
1710   543C ED A0       > ldi
1710   543E ED A0       > ldi
1710   5440 ED A0       > ldi
1710   5442 ED A0       > ldi
1710   5444 ED A0       > ldi
1710   5446 ED A0       > ldi
1710   5448 ED A0       > ldi
1710   544A ED A0       > ldi
1710   544C ED A0       > ldi
1710   544E ED A0       > ldi
1710   5450 ED A0       > ldi
1710   5452 ED A0       > ldi
1710   5454 ED A0       > ldi
1710   5456 ED A0       > ldi
1710   5458 ED A0       > ldi
1710   545A ED A0       > ldi
1710   545C ED A0       > ldi
1710   545E ED A0       > ldi
1710   5460 ED A0       > ldi
1710   5462 ED A0       > ldi
1710   5464 ED A0       > ldi
1710   5466 ED A0       > ldi
1710   5468 ED A0       > ldi
1710   546A ED A0       > ldi
1710   546C ED A0       > ldi
1710   546E ED A0       > ldi
1710   5470 ED A0       > ldi
1710   5472 ED A0       > ldi
1710   5474 ED A0       > ldi
1710   5476 ED A0       > ldi
1710   5478 ED A0       > ldi
1710   547A ED A0       > ldi
1710   547C ED A0       > ldi
1710   547E ED A0       > ldi
1710   5480 ED A0       > ldi
1710   5482 ED A0       > ldi
1710   5484 ED A0       > ldi
1710   5486 ED A0       > ldi
1710   5488 ED A0       > ldi
1710   548A ED A0       > ldi
1710   548C ED A0       > ldi
1710   548E ED A0       > ldi
1710   5490 ED A0       > ldi
1710   5492 ED A0       > ldi
1710   5494 ED A0       > ldi
1710   5496 ED A0       > ldi
1710   5498 ED A0       > ldi
1710   549A ED A0       > ldi
1710   549C ED A0       > ldi
1710   549E ED A0       > ldi
1710   54A0 ED A0       > ldi
1710   54A2 ED A0       > ldi
1710   54A4 ED A0       > ldi
1710   54A6 ED A0       > ldi
1710   54A8 ED A0       > ldi
1710   54AA ED A0       > ldi
1710   54AC ED A0       > ldi
1710   54AE ED A0       > ldi
1710   54B0 ED A0       > ldi
1710   54B2 ED A0       > ldi
1710   54B4 ED A0       > ldi
1710   54B6 ED A0       > ldi
1710   54B8 ED A0       > ldi
1710   54BA ED A0       > ldi
1710   54BC ED A0       > ldi
1710   54BE ED A0       > ldi
1710   54C0 ED A0       > ldi
1710   54C2 ED A0       > ldi
1710   54C4 ED A0       > ldi
1710   54C6 ED A0       > ldi
1710   54C8 ED A0       > ldi
1710   54CA ED A0       > ldi
1710   54CC ED A0       > ldi
1710   54CE ED A0       > ldi
1710   54D0 ED A0       > ldi
1710   54D2 ED A0       > ldi
1710   54D4 ED A0       > ldi
1710   54D6 ED A0       > ldi
1710   54D8 ED A0       > ldi
1710   54DA ED A0       > ldi
1710   54DC ED A0       > ldi
1710   54DE ED A0       > ldi
1710   54E0 ED A0       > ldi
1710   54E2 ED A0       > ldi
1710   54E4 ED A0       > ldi
1710   54E6 ED A0       > ldi
1710   54E8 ED A0       > ldi
1710   54EA ED A0       > ldi
1710   54EC ED A0       > ldi
1710   54EE ED A0       > ldi
1710   54F0 ED A0       > ldi
1710   54F2 ED A0       > ldi
1710   54F4 ED A0       > ldi
1710   54F6 ED A0       > ldi
1710   54F8 ED A0       > ldi
1710   54FA ED A0       > ldi
1710   54FC ED A0       > ldi
1710   54FE ED A0       > ldi
1710   5500 ED A0       > ldi
1710   5502 ED A0       > ldi
1710   5504 ED A0       > ldi
1710   5506 ED A0       > ldi
1710   5508 ED A0       > ldi
1710   550A ED A0       > ldi
1710   550C ED A0       > ldi
1710   550E ED A0       > ldi
1710   5510 ED A0       > ldi
1710   5512 ED A0       > ldi
1710   5514 ED A0       > ldi
1710   5516 ED A0       > ldi
1710   5518 ED A0       > ldi
1710   551A ED A0       > ldi
1710   551C ED A0       > ldi
1710   551E ED A0       > ldi
1710   5520 ED A0       > ldi
1710   5522 ED A0       > ldi
1710   5524 ED A0       > ldi
1710   5526 ED A0       > ldi
1710   5528 ED A0       > ldi
1710   552A ED A0       > ldi
1710   552C ED A0       > ldi
1710   552E ED A0       > ldi
1710   5530 ED A0       > ldi
1710   5532 ED A0       > ldi
1710   5534 ED A0       > ldi
1710   5536 ED A0       > ldi
1710   5538 ED A0       > ldi
1710   553A ED A0       > ldi
1710   553C ED A0       > ldi
1710   553E ED A0       > ldi
1710   5540 ED A0       > ldi
1710   5542 ED A0       > ldi
1710   5544 ED A0       > ldi
1710   5546 ED A0       > ldi
1710   5548 ED A0       > ldi
1710   554A ED A0       > ldi
1710   554C ED A0       > ldi
1710   554E ED A0       > ldi
1710   5550 ED A0       > ldi
1710   5552 ED A0       > ldi
1710   5554 ED A0       > ldi
1710   5556 ED A0       > ldi
1710   5558 ED A0       > ldi
1710   555A ED A0       > ldi
1710   555C ED A0       > ldi
1710   555E ED A0       > ldi
1710   5560 ED A0       > ldi
1710   5562 ED A0       > ldi
1710   5564 ED A0       > ldi
1710   5566 ED A0       > ldi
1710   5568 ED A0       > ldi
1710   556A ED A0       > ldi
1710   556C ED A0       > ldi
1710   556E ED A0       > ldi
1710   5570 ED A0       > ldi
1710   5572 ED A0       > ldi
1710   5574 ED A0       > ldi
1710   5576 ED A0       > ldi
1710   5578 ED A0       > ldi
1710   557A ED A0       > ldi
1710   557C ED A0       > ldi
1710   557E ED A0       > ldi
1710   5580 ED A0       > ldi
1710   5582 ED A0       > ldi
1710   5584 ED A0       > ldi
1710   5586 ED A0       > ldi
1710   5588 ED A0       > ldi
1710   558A ED A0       > ldi
1710   558C ED A0       > ldi
1710   558E ED A0       > ldi
1710   5590 ED A0       > ldi
1710   5592 ED A0       > ldi
1710   5594 ED A0       > ldi
1710   5596 ED A0       > ldi
1710   5598 ED A0       > ldi
1710   559A ED A0       > ldi
1710   559C ED A0       > ldi
1710   559E ED A0       > ldi
1710   55A0 ED A0       > ldi
1710   55A2 ED A0       > ldi
1710   55A4 ED A0       > ldi
1710   55A6 ED A0       > ldi
1710   55A8 ED A0       > ldi
1710   55AA ED A0       > ldi
1710   55AC ED A0       > ldi
1710   55AE ED A0       > ldi
1710   55B0 ED A0       > ldi
1710   55B2 ED A0       > ldi
1710   55B4 ED A0       > ldi
1710   55B6 ED A0       > ldi
1710   55B8 ED A0       > ldi
1710   55BA ED A0       > ldi
1710   55BC ED A0       > ldi
1710   55BE ED A0       > ldi
1710   55C0 ED A0       > ldi
1710   55C2 ED A0       > ldi
1710   55C4 ED A0       > ldi
1710   55C6 ED A0       > ldi
1710   55C8 ED A0       > ldi
1710   55CA ED A0       > ldi
1710   55CC ED A0       > ldi
1710   55CE ED A0       > ldi
1710   55D0 ED A0       > ldi
1710   55D2 ED A0       > ldi
1710   55D4 ED A0       > ldi
1710   55D6 ED A0       > ldi
1710   55D8 ED A0       > ldi
1710   55DA ED A0       > ldi
1710   55DC ED A0       > ldi
1710   55DE ED A0       > ldi
1710   55E0 ED A0       > ldi
1710   55E2 ED A0       > ldi
1710   55E4 ED A0       > ldi
1710   55E6 ED A0       > ldi
1710   55E8 ED A0       > ldi
1710   55EA ED A0       > ldi
1710   55EC ED A0       > ldi
1710   55EE ED A0       > ldi
1710   55F0 ED A0       > ldi
1710   55F2 ED A0       > ldi
1710   55F4 ED A0       > ldi
1710   55F6 ED A0       > ldi
1710   55F8 ED A0       > ldi
1710   55FA ED A0       > ldi
1710   55FC ED A0       > ldi
1710   55FE ED A0       > ldi
1710   5600 ED A0       > ldi
1710   5602 ED A0       > ldi
1710   5604 ED A0       > ldi
1710   5606 ED A0       > ldi
1710   5608 ED A0       > ldi
1710   560A ED A0       > ldi
1710   560C ED A0       > ldi
1710   560E ED A0       > ldi
1710   5610 ED A0       > ldi
1710   5612 ED A0       > ldi
1710   5614 ED A0       > ldi
1710   5616 ED A0       > ldi
1710   5618 ED A0       > ldi
1710   561A ED A0       > ldi
1710   561C ED A0       > ldi
1710   561E ED A0       > ldi
1710   5620 ED A0       > ldi
1710   5622 ED A0       > ldi
1710   5624 ED A0       > ldi
1710   5626 ED A0       > ldi
1710   5628 ED A0       > ldi
1710   562A ED A0       > ldi
1710   562C ED A0       > ldi
1710   562E ED A0       > ldi
1710   5630 ED A0       > ldi
1710   5632 ED A0       > ldi
1710   5634 ED A0       > ldi
1710   5636 ED A0       > ldi
1710   5638 ED A0       > ldi
1710   563A ED A0       > ldi
1710   563C ED A0       > ldi
1710   563E ED A0       > ldi
1710   5640 ED A0       > ldi
1710   5642 ED A0       > ldi
1710   5644 ED A0       > ldi
1710   5646 ED A0       > ldi
1710   5648 ED A0       > ldi
1710   564A ED A0       > ldi
1710   564C ED A0       > ldi
1710   564E ED A0       > ldi
1710   5650 ED A0       > ldi
1710   5652 ED A0       > ldi
1710   5654 ED A0       > ldi
1710   5656 ED A0       > ldi
1710   5658 ED A0       > ldi
1710   565A ED A0       > ldi
1710   565C ED A0       > ldi
1710   565E ED A0       > ldi
1710   5660 ED A0       > ldi
1710   5662 ED A0       > ldi
1710   5664 ED A0       > ldi
1710   5666 ED A0       > ldi
1710   5668 ED A0       > ldi
1710   566A ED A0       > ldi
1710   566C ED A0       > ldi
1710   566E ED A0       > ldi
1710   5670 ED A0       > ldi
1710   5672 ED A0       > ldi
1710   5674 ED A0       > ldi
1710   5676 ED A0       > ldi
1710   5678 ED A0       > ldi
1710   567A ED A0       > ldi
1710   567C ED A0       > ldi
1710   567E ED A0       > ldi
1710   5680 ED A0       > ldi
1710   5682 ED A0       > ldi
1710   5684 ED A0       > ldi
1710   5686 ED A0       > ldi
1710   5688 ED A0       > ldi
1710   568A ED A0       > ldi
1710   568C ED A0       > ldi
1710   568E ED A0       > ldi
1710   5690 ED A0       > ldi
1710   5692 ED A0       > ldi
1710   5694 ED A0       > ldi
1710   5696 ED A0       > ldi
1710   5698 ED A0       > ldi
1710   569A ED A0       > ldi
1710   569C ED A0       > ldi
1710   569E ED A0       > ldi
1710   56A0 ED A0       > ldi
1710   56A2 ED A0       > ldi
1710   56A4 ED A0       > ldi
1710   56A6 ED A0       > ldi
1710   56A8 ED A0       > ldi
1710   56AA ED A0       > ldi
1710   56AC ED A0       > ldi
1710   56AE ED A0       > ldi
1710   56B0 ED A0       > ldi
1710   56B2 ED A0       > ldi
1710   56B4 ED A0       > ldi
1710   56B6 ED A0       > ldi
1710   56B8 ED A0       > ldi
1710   56BA ED A0       > ldi
1710   56BC ED A0       > ldi
1710   56BE ED A0       > ldi
1710   56C0 ED A0       > ldi
1710   56C2 ED A0       > ldi
1710   56C4 ED A0       > ldi
1710   56C6 ED A0       > ldi
1710   56C8 ED A0       > ldi
1710   56CA ED A0       > ldi
1710   56CC ED A0       > ldi
1710   56CE ED A0       > ldi
1710   56D0 ED A0       > ldi
1710   56D2 ED A0       > ldi
1710   56D4 ED A0       > ldi
1710   56D6 ED A0       > ldi
1710   56D8 ED A0       > ldi
1710   56DA ED A0       > ldi
1710   56DC ED A0       > ldi
1710   56DE ED A0       > ldi
1710   56E0 ED A0       > ldi
1710   56E2 ED A0       > ldi
1710   56E4 ED A0       > ldi
1710   56E6 ED A0       > ldi
1710   56E8 ED A0       > ldi
1710   56EA ED A0       > ldi
1710   56EC ED A0       > ldi
1710   56EE ED A0       > ldi
1710   56F0 ED A0       > ldi
1710   56F2 ED A0       > ldi
1710   56F4 ED A0       > ldi
1710   56F6 ED A0       > ldi
1710   56F8 ED A0       > ldi
1710   56FA ED A0       > ldi
1710   56FC ED A0       > ldi
1710   56FE ED A0       > ldi
1710   5700 ED A0       > ldi
1710   5702 ED A0       > ldi
1710   5704 ED A0       > ldi
1710   5706 ED A0       > ldi
1710   5708 ED A0       > ldi
1710   570A ED A0       > ldi
1710   570C ED A0       > ldi
1710   570E ED A0       > ldi
1710   5710 ED A0       > ldi
1710   5712 ED A0       > ldi
1710   5714 ED A0       > ldi
1710   5716 ED A0       > ldi
1710   5718 ED A0       > ldi
1710   571A ED A0       > ldi
1710   571C ED A0       > ldi
1710   571E ED A0       > ldi
1710   5720 ED A0       > ldi
1710   5722 ED A0       > ldi
1710   5724 ED A0       > ldi
1710   5726 ED A0       > ldi
1710   5728 ED A0       > ldi
1710   572A ED A0       > ldi
1710   572C ED A0       > ldi
1710   572E ED A0       > ldi
1710   5730 ED A0       > ldi
1710   5732 ED A0       > ldi
1710   5734 ED A0       > ldi
1710   5736 ED A0       > ldi
1710   5738 ED A0       > ldi
1710   573A ED A0       > ldi
1710   573C ED A0       > ldi
1710   573E ED A0       > ldi
1710   5740 ED A0       > ldi
1710   5742 ED A0       > ldi
1710   5744 ED A0       > ldi
1710   5746 ED A0       > ldi
1710   5748 ED A0       > ldi
1710   574A ED A0       > ldi
1710   574C ED A0       > ldi
1710   574E ED A0       > ldi
1710   5750 ED A0       > ldi
1710   5752 ED A0       > ldi
1710   5754 ED A0       > ldi
1710   5756 ED A0       > ldi
1710   5758 ED A0       > ldi
1710   575A ED A0       > ldi
1710   575C ED A0       > ldi
1710   575E ED A0       > ldi
1710   5760 ED A0       > ldi
1710   5762 ED A0       > ldi
1710   5764 ED A0       > ldi
1710   5766 ED A0       > ldi
1710   5768 ED A0       > ldi
1710   576A ED A0       > ldi
1710   576C ED A0       > ldi
1710   576E ED A0       > ldi
1710   5770 ED A0       > ldi
1710   5772 ED A0       > ldi
1710   5774 ED A0       > ldi
1710   5776 ED A0       > ldi
1710   5778 ED A0       > ldi
1710   577A ED A0       > ldi
1710   577C ED A0       > ldi
1710   577E ED A0       > ldi
1710   5780 ED A0       > ldi
1710   5782 ED A0       > ldi
1710   5784 ED A0       > ldi
1710   5786 ED A0       > ldi
1710   5788 ED A0       > ldi
1710   578A ED A0       > ldi
1710   578C ED A0       > ldi
1710   578E ED A0       > ldi
1710   5790 ED A0       > ldi
1710   5792 ED A0       > ldi
1710   5794 ED A0       > ldi
1710   5796 ED A0       > ldi
1710   5798 ED A0       > ldi
1710   579A ED A0       > ldi
1710   579C ED A0       > ldi
1710   579E ED A0       > ldi
1710   57A0 ED A0       > ldi
1710   57A2 ED A0       > ldi
1710   57A4 ED A0       > ldi
1710   57A6 ED A0       > ldi
1710   57A8 ED A0       > ldi
1710   57AA ED A0       > ldi
1710   57AC ED A0       > ldi
1710   57AE ED A0       > ldi
1710   57B0 ED A0       > ldi
1710   57B2 ED A0       > ldi
1711   57B4             .part2s: 
1712   57B4 EB          	ex	de,hl
1713   57B5 3A 00 7B    	ld	a, (SPIDATA)	; descarta CRC
1714   57B8             .fim: 
1715   57B8 AF          	xor	a		; zera carry para informar leitura sem erros
1716   57B9 C3 44 4F    	jp	terminaLeituraEscritaBloco
1717   57BC             
1718   57BC             
1719   57BC             ; ------------------------------------------------
1720   57BC             ; Converte blocos para bytes. Na pratica faz
1721   57BC             ; BC DE = (BC DE) * 512
1722   57BC             ; ------------------------------------------------
1723   57BC             blocoParaByte: 
1724   57BC 41          	ld	b, c
1725   57BD 4A          	ld	c, d
1726   57BE 53          	ld	d, e
1727   57BF 1E 00       	ld	e, 0
1728   57C1 CB 22       	sla	d
1729   57C3 CB 11       	rl	c
1730   57C5 CB 10       	rl	b
1731   57C7 C9          	ret
1732   57C8             
1733   57C8             ; ------------------------------------------------
1734   57C8             ; Funcoes utilitarias
1735   57C8             ; ------------------------------------------------
1736   57C8             
1737   57C8             ; ------------------------------------------------
1738   57C8             ; Enable the SPI interface
1739   57C8             ; ------------------------------------------------
1740   57C8             enableSPI: 
1741   57C8 F5          	push	af
1742   57C9 3E 01       	ld	a, 1
1743   57CB 32 01 7F    	ld	(SPIMODE), a
1744   57CE F1          	pop	af
1745   57CF C9          	ret
1746   57D0             
1747   57D0             ; ------------------------------------------------
1748   57D0             ; Disable the SPI interface
1749   57D0             ; ------------------------------------------------
1750   57D0             disableSPI: 
1751   57D0 F5          	push	af
1752   57D1 3E 00       	ld	a, 0
1753   57D3 32 01 7F    	ld	(SPIMODE), a
1754   57D6 F1          	pop	af
1755   57D7 C9          	ret
1756   57D8             
1757   57D8             ; ------------------------------------------------
1758   57D8             ; Imprime string na tela apontada por DE
1759   57D8             ; Destroi todos os registradores
1760   57D8             ; ------------------------------------------------
1761   57D8             printString: 
1762   57D8 1A          	ld	a, (de)
1763   57D9 B7          	or	a
1764   57DA C8          	ret	z
1765   57DB CD A2 00    	call	CHPUT
1766   57DE 13          	inc	de
1767   57DF 18 F7       	jr	printString
1768   57E1             
1769   57E1             
1770   57E1             ; ------------------------------------------------
1771   57E1             ; Converte o byte em A para string em decimal no
1772   57E1             ; buffer apontado por DE
1773   57E1             ; Destroi AF, BC, HL, DE
1774   57E1             ; ------------------------------------------------
1775   57E1             DecToAscii: 
1776   57E1 26 00       	ld	h, 0
1777   57E3 6F          	ld	l, a		; copiar A para HL
1778   57E4 FD 36 34 01 	ld	(iy+TEMP), 1	; flag para indicar que devemos cortar os zeros a esquerda
1779   57E8 01 9C FF    	ld	bc, -100	; centenas
1780   57EB CD F9 57    	call	.num1
1781   57EE 0E F6       	ld	c, -10		; dezenas
1782   57F0 CD F9 57    	call	.num1
1783   57F3 FD 36 34 02 	ld	(iy+TEMP), 2	; unidade deve exibir 0 se for zero e nao corta-lo
1784   57F7 0E FF       	ld	c, -1		; unidades
1785   57F9             .num1: 
1786   57F9 3E 2F       	ld	a, '0'-1
1787   57FB             .num2: 
1788   57FB 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1789   57FC 09          	add	hl, bc		; somar com negativo
1790   57FD 38 FC       	jr	c,.num2		; ainda nao zeramos
1791   57FF ED 42       	sbc	hl, bc		; retoma valor original
1792   5801 FD 35 34    	dec	(iy+TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1793   5804 20 08       	jr	nz,.naozero
1794   5806 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1795   5808 20 04       	jr	nz,.naozero
1796   580A FD 34 34    	inc	(iy+TEMP)	; se for zero, nao salvamos e voltamos a flag
1797   580D C9          	ret
1798   580E             .naozero: 
1799   580E 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1800   580F 13          	inc	de		; incrementa ponteiro de destino
1801   5810 C9          	ret
1802   5811             
1803   5811             ; ------------------------------------------------
1804   5811             ; Converte o byte em A para string em hexa no
1805   5811             ; buffer apontado por DE
1806   5811             ; Destroi AF, C, DE
1807   5811             ; ------------------------------------------------
1808   5811             HexToAscii: 
1809   5811 4F          	ld	c, a
1810   5812 1F          	rra
1811   5813 1F          	rra
1812   5814 1F          	rra
1813   5815 1F          	rra
1814   5816 CD 1A 58    	call	.conv
1815   5819 79          	ld  	a, c
1816   581A             .conv: 
1817   581A E6 0F       	and	$0F
1818   581C C6 90       	add	a, $90
1819   581E 27          	daa
1820   581F CE 40       	adc	a, $40
1821   5821 27          	daa
1822   5822 12          	ld	(de), a
1823   5823 13          	inc	de
1824   5824 C9          	ret
1825   5825             
1826   5825             ; ------------------------------------------------
1827   5825             ; Converte o byte em A para string em decimal e
1828   5825             ; imprime na tela
1829   5825             ; Destroi AF, BC, HL, DE
1830   5825             ; ------------------------------------------------
1831   5825             printDecToAscii: 
1832   5825 26 00       	ld	h, 0
1833   5827 6F          	ld	l, a		; copiar A para HL
1834   5828 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1835   582A 11 9C FF    	ld	de, -100	; centenas
1836   582D CD 39 58    	call	.num1
1837   5830 1E F6       	ld	e, -10		; dezenas
1838   5832 CD 39 58    	call	.num1
1839   5835 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1840   5837 1E FF       	ld	e, -1		; unidades
1841   5839             .num1: 
1842   5839 3E 2F       	ld	a, '0'-1
1843   583B             .num2: 
1844   583B 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1845   583C 19          	add	hl, de		; somar com negativo
1846   583D 38 FC       	jr	c,.num2		; ainda nao zeramos
1847   583F ED 52       	sbc	hl, de		; retoma valor original
1848   5841 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1849   5843 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1850   5845 20 02       	jr	nz,.naozero
1851   5847 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1852   5848 C9          	ret
1853   5849             .naozero: 
1854   5849 E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1855   584A C5          	push	bc
1856   584B CD A2 00    	call	CHPUT
1857   584E C1          	pop	bc
1858   584F E1          	pop	hl
1859   5850 C9          	ret
1860   5851             
1861   5851             ; ------------------------------------------------
1862   5851             ; Procura pelo nome do fabricante em uma tabela.
1863   5851             ; A contem o byte do fabricante
1864   5851             ; Devolve HL apontando para o buffer do fabricante
1865   5851             ; e BC com o comprimento do texto
1866   5851             ; Destroi AF, BC, HL
1867   5851             ; ------------------------------------------------
1868   5851             pegaFabricante: 
1869   5851 4F          	ld	c, a
1870   5852 21 73 58    	ld	hl, tblFabricantes
1871   5855             
1872   5855             .loop: 
1873   5855 7E          	ld	a, (hl)
1874   5856 23          	inc	hl
1875   5857 B9          	cp	c
1876   5858 28 0C       	jr	z,.achado
1877   585A B7          	or	a
1878   585B 28 09       	jr	z,.achado
1879   585D C5          	push	bc
1880   585E CD 66 58    	call	.achado
1881   5861 09          	add	hl, bc
1882   5862 23          	inc	hl
1883   5863 C1          	pop	bc
1884   5864 18 EF       	jr	.loop
1885   5866             
1886   5866             .achado: 
1887   5866 0E 00       	ld	c, 0
1888   5868 E5          	push	hl
1889   5869 AF          	xor	a
1890   586A             .loop2: 
1891   586A 0C          	inc	c
1892   586B 23          	inc	hl
1893   586C BE          	cp	(hl)
1894   586D 20 FB       	jr	nz,.loop2
1895   586F E1          	pop	hl
1896   5870 06 00       	ld	b, 0
1897   5872 C9          	ret
1898   5873             
1899   5873             tblFabricantes: 
1900   5873 01          	db	1
1901   5874             	db	"Panasonic",0
1901   5874 50616E61736F6E696300
1902   587E 02          	db	2
1903   587F             	db	"Toshiba",0
1903   587F 546F736869626100
1904   5887 03          	db	3
1905   5888             	db	"SanDisk",0
1905   5888 53616E4469736B00
1906   5890 04          	db	4
1907   5891             	db	"SMI-S",0
1907   5891 534D492D5300
1908   5897 06          	db	6
1909   5898             	db	"Renesas",0
1909   5898 52656E6573617300
1910   58A0 11          	db	17
1911   58A1             	db	"Dane-Elec",0
1911   58A1 44616E652D456C656300
1912   58AB 13          	db	19
1913   58AC             	db	"KingMax",0
1913   58AC 4B696E674D617800
1914   58B4 15          	db	21
1915   58B5             	db	"Samsung",0
1915   58B5 53616D73756E6700
1916   58BD 18          	db	24
1917   58BE             	db	"Infineon",0
1917   58BE 496E66696E656F6E00
1918   58C7 1A          	db	26
1919   58C8 50 51 49 00 	db	"PQI",0
1920   58CC 1B          	db	27
1921   58CD 536F6E7900  	db	"Sony",0
1922   58D2 1C          	db	28
1923   58D3             	db	"Transcend",0
1923   58D3 5472616E7363656E6400
1924   58DD 1D          	db	29
1925   58DE             	db	"A-DATA",0
1925   58DE 412D4441544100
1926   58E5 1F          	db	31
1927   58E6             	db	"SiliconPower",0
1927   58E6 53696C69636F6E506F77657200
1928   58F3 27          	db	39
1929   58F4             	db	"Verbatim",0
1929   58F4 566572626174696D00
1930   58FD 41          	db	65
1931   58FE 4F 4B 49 00 	db	"OKI",0
1932   5902 73          	db	115
1933   5903             	db	"SilverHT",0
1933   5903 53696C766572485400
1934   590C 89          	db	137
1935   590D             	db	"L.Data",0
1935   590D 4C2E4461746100
1936   5914 00          	db	0
1937   5915             	db	"Generico",0
1937   5915 47656E657269636F00
1938   591E             
1939   591E             
1940   591E             ; ------------------------------------------------
1941   591E             ; Restore screen parameters on MSX>=2 if they're
1942   591E             ; not set yet
1943   591E             ; ------------------------------------------------
1944   591E             MYSETSCR: 
1945   591E 3A 2D 00    	ld	a,(MSXVER)
1946   5921 B7          	or	a			; MSX1?
1947   5922 CA 6C 00    	jp	z,INITXT		; Yes, change do screen-0
1948   5925             
1949   5925 0E 23       	ld	c,$23			; Block-2, R#3
1950   5927 DD 21 F5 01 	ld 	ix,REDCLK
1951   592B CD 5F 01    	call	EXTROM
1952   592E E6 01       	and	1
1953   5930 47          	ld	b,a
1954   5931 3A AF FC    	ld	a,(SCRMOD)
1955   5934 B8          	cp	b
1956   5935 20 1C       	jr	nz,.restore
1957   5937 0C          	inc	c
1958   5938 DD 21 F5 01 	ld 	ix,REDCLK
1959   593C CD 5F 01    	call	EXTROM
1960   593F 47          	ld	b,a
1961   5940 0C          	inc	c
1962   5941 DD 21 F5 01 	ld 	ix,REDCLK
1963   5945 CD 5F 01    	call	EXTROM
1964   5948 87          	add	a,a
1965   5949 87          	add	a,a
1966   594A 87          	add	a,a
1967   594B 87          	add	a,a
1968   594C B0          	or	b
1969   594D 47          	ld	b,a
1970   594E 3A B0 F3    	ld	a,(LINLEN)
1971   5951 B8          	cp	b
1972   5952 C8          	ret	z
1973   5953             .restore: 
1974   5953 AF          	xor	a		; Don't displat the function keys
1975   5954 DD 21 85 01 	ld	ix,SDFSCR
1976   5958 C3 5F 01    	jp	EXTROM
1977   595B             
1978   595B             
1979   595B             
1980   595B             ; ==========================================================================
1981   595B             strTitle: 
1982   595B             	db	"FBLabs SDHC driver "
1982   595B 46424C61627320534448432064726976657220
1983   596E             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
1983   596E 76312E302E36
1984   5974 0D 0A 00    	db	13,10,0
1985   5977             
1986   5977             strBootpaused: 
1987   5977             	db	"Paused. Press <i> to show the copyright info.",13,10,0
1987   5977 5061757365642E205072657373203C693E20746F2073686F772074686520636F
1987   5997 7079726967687420696E666F2E0D0A00
1988   59A7             
1989   59A7             strCopyright: 
1990   59A7             	db	"Copyright (c) 2014 Fabio Belavenuto",13,10
1990   59A7 436F7079726967687420286329203230313420466162696F2042656C6176656E
1990   59C7 75746F0D0A
1991   59CC             	db	"Licenced under CERN OHL v1.1",13,10
1991   59CC 4C6963656E63656420756E646572204345524E204F484C2076312E310D0A
1992   59EA             	db	"http://ohwr.org/cernohl",13,10
1992   59EA 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
1993   5A03             	db	"PCB designed by Luciano Sturaro",13,10
1993   5A03 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
1993   5A23 0A
1994   5A24             	; fall throw
1995   5A24             strCrLf: 
1996   5A24 0D 0A 00    	db	13,10,0
1997   5A27             strCartao: 
1998   5A27             	db	"Slot ",0
1998   5A27 536C6F742000
1999   5A2D             strVazio: 
2000   5A2D             	db	"Empty",13,10,0
2000   5A2D 456D7074790D0A00
2001   5A35             strNaoIdentificado: 
2002   5A35             	db	"Unknown!",13,10,0
2002   5A35 556E6B6E6F776E210D0A00
2003   5A40             			;----------------------------------------
2004   5A40             strMr_mp_desativada: 
2005   5A40             	db	"Slot expander/Mapper/MegaRAM disabled",13,10,0
2005   5A40 536C6F7420657870616E6465722F4D61707065722F4D65676152414D20646973
2005   5A60 61626C65640D0A00
2006   5A68             strMapper: 
2007   5A68             	db	"Slot expanded and Memory Mapper enabled",13,10,0
2007   5A68 536C6F7420657870616E64656420616E64204D656D6F7279204D617070657220
2007   5A88 656E61626C65640D0A00
2008   5A92             strMegaram: 
2009   5A92             	db	"Slot expander and MegaRAM enabled",13,10,0
2009   5A92 536C6F7420657870616E64657220616E64204D65676152414D20656E61626C65
2009   5AB2 640D0A00
2010   5AB6             strSDV1: 
2011   5AB6             	db	"SDV1 - ",0
2011   5AB6 53445631202D2000
2012   5ABE             strSDV2: 
2013   5ABE             	db	"SDV2 - ",0
2013   5ABE 53445632202D2000
2014   5AC6             
2015   5AC6             ;-----------------------------------------------------------------------------
2016   5AC6             ;
2017   5AC6             ; End of the driver code
2018   5AC6             
2019   5AC6             DRV_END: 
2020   5AC6             
2021   5AC6 FF          	ds	3ED0h-(DRV_END-DRV_START), $FF
2022   7FD0             
2023   7FD0             
