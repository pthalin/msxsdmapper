0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 7B00h~7EFFh	: SPI data transfer window (read/write)
0015   0000             ; 7F00h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	b0	: 1=SD Card on slot-0 changed since last read
0018   0000             ;	b1	: 1=SD Card on slot-1 changed since last read
0019   0000             ;	b2	: 0=SD card present on slot-0
0020   0000             ;	b3	: 0=SD card present on slot-1
0021   0000             ;	b4	: 0=Write protecton enabled for SD card slot-0
0022   0000             ;	b5	: 0=Write protecton enabled for SD card slot-1
0023   0000             ;	b6	: SW0 status. 0=RAM disabled, 1=RAM enabled
0024   0000             ;	b7	: SW1 status. 0=RAM mode: MegaRAM, 1=RAM mode: Memory Mapper
0025   0000             ;	<write>
0026   0000             ;	b0	: SD card slot-0 chip-select (0=selected)
0027   0000             ;	b1	: SD card slot-1 chip-select (0=selected)
0028   0000             
0029   0000             
0030   0000             	output	"driver.bin"
0031   0000             
0032   0000             ;-----------------------------------------------------------------------------
0033   0000             ;
0034   0000             ; Driver configuration constants
0035   0000             ;
0036   0000             
0037   0000             ;Driver type:
0038   0000             ;   0 for drive-based
0039   0000             ;   1 for device-based
0040   0000             
0041   0000             DRV_TYPE	equ	1
0042   0000             
0043   0000             ;Hot-plug devices support (device-based drivers only):
0044   0000             ;   0 for no hot-plug support
0045   0000             ;   1 for hot-plug support
0046   0000             
0047   0000             DRV_HOTPLUG	equ	0
0048   0000             
0049   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0050   0000             
0051   0000             ;Driver version
0052   0000             
0053   0000             VER_MAIN	equ	1
0054   0000             VER_SEC		equ	0
0055   0000             VER_REV		equ	5
0056   0000             
0057   0000             ;-----------------------------------------------------------------------------
0058   0000             ; Enderecos SPI
0059   0000             
0060   0000             PORTCFG		= $7F00
0061   0000             PORTSPI		= $7B00
0062   0000             
0063   0000             ; Comandos SPI:
0064   0000             CMD0	= 0  | $40
0065   0000             CMD1	= 1  | $40
0066   0000             CMD8	= 8  | $40
0067   0000             CMD9	= 9  | $40
0068   0000             CMD10	= 10 | $40
0069   0000             CMD12	= 12 | $40
0070   0000             CMD16	= 16 | $40
0071   0000             CMD17	= 17 | $40
0072   0000             CMD18	= 18 | $40
0073   0000             CMD24	= 24 | $40
0074   0000             CMD25	= 25 | $40
0075   0000             CMD55	= 55 | $40
0076   0000             CMD58	= 58 | $40
0077   0000             ACMD23	= 23 | $40
0078   0000             ACMD41	= 41 | $40
0079   0000             
0080   0000             ; Offsets da area de trabalho
0081   0000             
0082   0000             BCSD 		= 0
0083   0000             BCID1		= 16
0084   0000             BCID2		= 32
0085   0000             NUMSD		= 48	; 1 se cartao 1, 2 se cartao 2
0086   0000             FLAGSCARTAO	= 49	; Flag indicando se houve mudanca ou erro de cartao
0087   0000             NUMBLOCOS	= 50	; 1 byte
0088   0000             TEMP		= 52	; 1 byte
0089   0000             BLOCOS1		= 56	; 3 bytes
0090   0000             BLOCOS2		= 60	; 3 bytes
0091   0000             
0092   0000             ;-----------------------------------------------------------------------------
0093   0000             ;
0094   0000             ; Standard BIOS and work area entries
0095   0000             INITXT	= $006C		; Inicializa SCREEN0
0096   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0097   0000             CHGET	= $009F		; Get character from keyboard buffer
0098   0000             CHPUT	= $00A2		; A=char
0099   0000             CLS	= $00C3		; Chamar com A=0
0100   0000             ERAFNK	= $00CC		; Erase function key display
0101   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0102   0000             KILBUF	= $0156		; Clear keyboard buffer
0103   0000             EXTROM	= $015F
0104   0000             
0105   0000             ; subROM functions
0106   0000             SDFSCR	= $0185
0107   0000             REDCLK	= $01F5
0108   0000             
0109   0000             
0110   0000             ; System variables
0111   0000             MSXVER	= $002D
0112   0000             LINL40	= $F3AE		; Width
0113   0000             LINLEN	= $F3B0
0114   0000             INTFLG	= $FC9B
0115   0000             SCRMOD	= $FCAF
0116   0000             
0117   0000             
0118   0000             ;-----------------------------------------------------------------------------
0119   0000             
0120   0000             
0121   0000             	org		$4000
0122   4000             
0123   4000 FF          	ds		256, $FF		; 256 dummy bytes
0124   4100             
0125   4100             DRV_START: 
0126   4100             
0127   4100             ;-----------------------------------------------------------------------------
0128   4100             ;
0129   4100             ; Miscellaneous constants
0130   4100             ;
0131   4100             
0132   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0133   4100             ;It is used by some of the kernel page 0 routines.
0134   4100             
0135   4100             CODE_ADD: 	equ	0F84Ch
0136   4100             
0137   4100             
0138   4100             ;-----------------------------------------------------------------------------
0139   4100             ;
0140   4100             ; Error codes for DEV_RW
0141   4100             ;
0142   4100             
0143   4100             ENCOMP	equ	0FFh
0144   4100             EWRERR	equ	0FEh
0145   4100             EDISK	equ	0FDh
0146   4100             ENRDY	equ	0FCh
0147   4100             EDATA	equ	0FAh
0148   4100             ERNF	equ	0F9h
0149   4100             EWPROT	equ	0F8h
0150   4100             EUFORM	equ	0F7h
0151   4100             ESEEK	equ	0F3h
0152   4100             EIFORM	equ	0F0h
0153   4100             EIDEVL	equ	0B5h
0154   4100             EIPARM	equ	08Bh
0155   4100             
0156   4100             ;-----------------------------------------------------------------------------
0157   4100             ;
0158   4100             ; Routines and information available on kernel page 0
0159   4100             ;
0160   4100             
0161   4100             ;* Get in A the current slot for page 1. Corrupts F.
0162   4100             ;  Must be called by using CALBNK to bank 0:
0163   4100             ;    xor a
0164   4100             ;    ld ix,GSLOT1
0165   4100             ;    call CALBNK
0166   4100             
0167   4100             GSLOT1	equ	402Dh
0168   4100             
0169   4100             
0170   4100             ;* This routine reads a byte from another bank.
0171   4100             ;  Must be called by using CALBNK to the desired bank,
0172   4100             ;  passing the address to be read in HL:
0173   4100             ;    ld a,<bank number>
0174   4100             ;    ld hl,<byte address>
0175   4100             ;    ld ix,RDBANK
0176   4100             ;    call CALBNK
0177   4100             
0178   4100             RDBANK	equ	403Ch
0179   4100             
0180   4100             
0181   4100             ;* This routine temporarily switches kernel main bank
0182   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0183   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0184   4100             ;  It is necessary to use this routine to invoke CALBAS
0185   4100             ;  (so that kernel bank is correct in case of BASIC error)
0186   4100             ;  and to invoke DOS functions via F37Dh hook.
0187   4100             ;
0188   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0189   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0190   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0191   4100             
0192   4100             CALLB0	equ	403Fh
0193   4100             
0194   4100             
0195   4100             ;* Call a routine in another bank.
0196   4100             ;  Must be used if the driver spawns across more than one bank.
0197   4100             ;
0198   4100             ;  Input:  A = bank number
0199   4100             ;          IX = routine address
0200   4100             ;          AF' = AF for the routine
0201   4100             ;          HL' = Ix for the routine
0202   4100             ;          BC, DE, HL, IY = input for the routine
0203   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0204   4100             
0205   4100             CALBNK	equ	4042h
0206   4100             
0207   4100             
0208   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0209   4100             ;  which will in turn contain a pointer to the allocated page 3
0210   4100             ;  work area for that slot (0 if no work area was allocated).
0211   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0212   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0213   4100             ;  Corrupts F.
0214   4100             ;  Must be called by using CALBNK to bank 0:
0215   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0216   4100             ;    ex af,af'
0217   4100             ;    xor a
0218   4100             ;    ld ix,GWORK
0219   4100             ;    call CALBNK
0220   4100             
0221   4100             GWORK	equ	4045h
0222   4100             
0223   4100             
0224   4100             ;* This address contains one byte that tells how many banks
0225   4100             ;  form the Nextor kernel (or alternatively, the first bank
0226   4100             ;  number of the driver).
0227   4100             
0228   4100             K_SIZE	equ	40FEh
0229   4100             
0230   4100             
0231   4100             ;* This address contains one byte with the current bank number.
0232   4100             
0233   4100             CUR_BANK	equ	40FFh
0234   4100             
0235   4100             
0236   4100             ;-----------------------------------------------------------------------------
0237   4100             ;
0238   4100             ; Built-in format choice strings
0239   4100             ;
0240   4100             
0241   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0242   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0243   4100             
0244   4100             
0245   4100             ;-----------------------------------------------------------------------------
0246   4100             ;
0247   4100             ; Driver signature
0248   4100             ;
0249   4100             	db	"NEXTOR_DRIVER",0
0249   4100 4E4558544F525F44524956455200
0250   410E             
0251   410E             
0252   410E             ;-----------------------------------------------------------------------------
0253   410E             ;
0254   410E             ; Driver flags:
0255   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0256   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0257   410E             
0258   410E 01          	db 1+(2*DRV_HOTPLUG)
0259   410F             
0260   410F             ;-----------------------------------------------------------------------------
0261   410F             ;
0262   410F             ; Reserved byte
0263   410F             ;
0264   410F 00          	db	0
0265   4110             
0266   4110             ;-----------------------------------------------------------------------------
0267   4110             ;
0268   4110             ; Driver name
0269   4110             ;
0270   4110             
0271   4110             DRV_NAME: 
0272   4110             	db	"SDMapper Driver"
0272   4110 53444D617070657220447269766572
0273   411F 20          	ds	32-($-DRV_NAME)," "
0274   4130             
0275   4130             
0276   4130             ;-----------------------------------------------------------------------------
0277   4130             ;
0278   4130             ; Jump table for the driver public routines
0279   4130             ;
0280   4130             
0281   4130             	; These routines are mandatory for all drivers
0282   4130                     ; (but probably you need to implement only DRV_INIT)
0283   4130             
0284   4130 C3 6C 41    	jp	DRV_TIMI
0285   4133 C3 49 49    	jp	DRV_VERSION
0286   4136 C3 00 48    	jp	DRV_INIT
0287   4139 C3 50 49    	jp	DRV_BASSTAT
0288   413C C3 52 49    	jp	DRV_BASDEV
0289   413F C3 54 49    	jp	DRV_EXTBIO
0290   4142 C3 55 49    	jp	DRV_DIRECT0
0291   4145 C3 55 49    	jp	DRV_DIRECT1
0292   4148 C3 55 49    	jp	DRV_DIRECT2
0293   414B C3 55 49    	jp	DRV_DIRECT3
0294   414E C3 55 49    	jp	DRV_DIRECT4
0295   4151             
0296   4151 00          	ds	15
0297   4160             
0298   4160             	; These routines are mandatory for device-based drivers
0299   4160             
0300   4160 C3 56 49    	jp	DEV_RW
0301   4163 C3 C7 49    	jp	DEV_INFO
0302   4166 C3 4D 4A    	jp	DEV_STATUS
0303   4169 C3 8D 4A    	jp	LUN_INFO
0304   416C             
0305   416C             
0306   416C             ;=====
0307   416C             ;=====  END of data that must be at fixed addresses
0308   416C             ;=====
0309   416C             
0310   416C             
0311   416C             ;-----------------------------------------------------------------------------
0312   416C             ;
0313   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0314   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0315   416C             
0316   416C             DRV_TIMI: 
0317   416C C9          	ret
0318   416D             
0319   416D             
0320   416D             ; Skips the interface r/w registers 
0321   416D FF          	ds	$4800-$, $FF
0322   4800             
0323   4800             
0324   4800             ;-----------------------------------------------------------------------------
0325   4800             ;
0326   4800             ; Driver initialization routine, it is called twice:
0327   4800             ;
0328   4800             ; 1) First execution, for information gathering.
0329   4800             ;    Input:
0330   4800             ;      A = 0
0331   4800             ;      B = number of available drives
0332   4800             ;      HL = maximum size of allocatable work area in page 3
0333   4800             ;    Output:
0334   4800             ;      A = number of required drives (for drive-based driver only)
0335   4800             ;      HL = size of required work area in page 3
0336   4800             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0337   4800             ;
0338   4800             ; 2) Second execution, for work area and hardware initialization.
0339   4800             ;    Input:
0340   4800             ;      A = 1
0341   4800             ;      B = number of allocated drives for this controller
0342   4800             ;
0343   4800             ;    The work area address can be obtained by using GWORK.
0344   4800             ;
0345   4800             ;    If first execution requests more work area than available,
0346   4800             ;    second execution will not be done and DRV_TIMI will not be hooked
0347   4800             ;    to the timer interrupt.
0348   4800             ;
0349   4800             ;    If first execution requests more drives than available,
0350   4800             ;    as many drives as possible will be allocated, and the initialization
0351   4800             ;    procedure will continue the normal way
0352   4800             ;    (for drive-based drivers only. Device-based drivers always
0353   4800             ;     get two allocated drives.)
0354   4800             
0355   4800             DRV_INIT: 
0356   4800 B7          	or	a		; Is this the 1st call? 
0357   4801 21 40 00    	ld	hl, 64		; 64 bytes of work area is needed 
0358   4804 C8          	ret	z		; Yes, return
0359   4805             
0360   4805             ; 2nd call: 
0361   4805 CD 0E 49    	call	MYSETSCR
0362   4808 CD CC 4A    	call	pegaWorkArea		; HL=IY=Work area pointer
0363   480B 11 9D 5F    	ld	de,strTitle		; prints the title 
0364   480E CD 57 5E    	call	printString
0365   4811             
0366   4811 CD F3 48    	call	SDMAPPERINIT		; SD-Mapper exclusive init
0367   4814             
0368   4814             SDHCDEVINIT: 	; FBLabs SDHC Interface initialization
0369   4814 AF          	xor	a			; zera flags do cartao
0370   4815 FD 77 31    	ld	(iy+FLAGSCARTAO), a
0371   4818 3E 01       	ld	a, 1			; detectar cartao 1
0372   481A CD 7D 48    	call	.detecta
0373   481D 3E 02       	ld	a, 2			; detectar cartao 2
0374   481F CD 7D 48    	call	.detecta
0375   4822 01 00 00    	ld	bc, 0
0376   4825 1E 05       	ld	e, 5
0377   4827             
0378   4827             .chkStop:  ; Check if the STOP key was signaled
0379   4827 3A 9B FC    	ld	a,(INTFLG)
0380   482A FE 04       	cp	4			; Was STOP pressed?
0381   482C 20 35       	jr	nz,.end			; No, quit as fast as possible 
0382   482E             
0383   482E             	; Handle STOP to pause and read messages, and ask for the copyright info
0384   482E 11 B9 5F    	ld	de,strBootpaused
0385   4831 CD 57 5E    	call	printString
0386   4834 3E 07       .wait1: 	ld	a,7
0387   4836 CD 41 01    	call	SNSMAT
0388   4839 E6 10       	and	$10			; Is STOP still pressed?
0389   483B 28 F7       	jr	z,.wait1		; Wait for STOP to be released
0390   483D AF          	xor	a
0391   483E 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0392   4841 06 00       	ld	b,0			; b=inhibit 'i' key flag
0393   4843 CD 9C 00    .wait2:  call	CHSNS
0394   4846 C4 69 48    	call	nz,.chkikey		; Wait until a key is pressed
0395   4849 3A 9B FC    	ld	a,(INTFLG)
0396   484C FE 04       	cp	4			; Was STOP pressed?
0397   484E 20 F3       	jr	nz,.wait2		; No, return
0398   4850 AF          	xor	a
0399   4851 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0400   4854 CD 56 01    	call	KILBUF
0401   4857 06 1E       	ld	b,30			; Since the user is trying pause the
0402   4859 76          .wait3: 	halt				; boot messages, this gives him enough
0403   485A             					; time to react and pause the next
0404   485A             					; driver
0405   485A 3A 9B FC    	ld	a,(INTFLG)
0406   485D FE 04       	cp	4			; Was STOP pressed?
0407   485F 28 02       	jr	z,.end			; quit so the next driver can process it
0408   4861 10 F6       	djnz	.wait3			; The user will have the impression
0409   4863             					; that he has a perfect timing.   ;)
0410   4863             
0411   4863             
0412   4863             .end
0413   4863 11 66 60     	ld	de, strCrLf
0414   4866 C3 57 5E    	jp	printString
0415   4869             
0416   4869             .chkikey: 
0417   4869 CB 40       	bit	0,b			; Was the copyright message shown?
0418   486B C0          	ret	nz			; Yes, return
0419   486C CD 9F 00    	call	CHGET
0420   486F FE 69       	cp	'i'
0421   4871 28 03       	jr	z,.showcopyright
0422   4873 FE 49       	cp	'I'
0423   4875 C0          	ret	nz
0424   4876             .showcopyright: 
0425   4876 04          	inc	b			; Inhibit further presses of the i key 
0426   4877 11 E9 5F    	ld	de,strCopyright
0427   487A C3 57 5E    	jp	printString
0428   487D             
0429   487D             .detecta: 
0430   487D FD 77 30    	ld	(iy+NUMSD), a		; processo de deteccao dos cartoes
0431   4880 11 69 60    	ld	de, strCartao
0432   4883 CD 57 5E    	call	printString
0433   4886 FD 7E 30    	ld	a, (iy+NUMSD)
0434   4889 C6 30       	add	'0'
0435   488B CD A2 00    	call	CHPUT
0436   488E 3E 3A       	ld	a, ':'
0437   4890 CD A2 00    	call	CHPUT
0438   4893 3E 20       	ld	a, ' '
0439   4895 CD A2 00    	call	CHPUT
0440   4898 FD 4E 30    	ld	c, (iy+NUMSD)
0441   489B 3A 00 7F    	ld	a, (PORTCFG)		; testar se cartao esta inserido
0442   489E A1          	and	c			; C contem 1 se cartao 1, 2 se cartao 2
0443   489F 28 09       	jr	z,.naoVazio
0444   48A1 11 6F 60    	ld	de, strVazio		; nao tem cartao no slot
0445   48A4 CD 57 5E    	call	printString
0446   48A7 C3 B8 48    	jp	.marcaErro
0447   48AA             .naoVazio: 
0448   48AA CD 4D 4B    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0449   48AD 30 0C       	jr	nc,.detectou
0450   48AF CD 90 4C    	call	desabilitaSDs
0451   48B2 11 77 60    	ld	de, strNaoIdentificado
0452   48B5 CD 57 5E    	call	printString
0453   48B8             .marcaErro: 
0454   48B8 C3 0A 4B    	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0455   48BB             .detectou: 
0456   48BB CD 25 4B    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0457   48BE DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0458   48C1 11 F8 60    	ld	de, strSDV1	; e imprimir
0459   48C4 B7          	or	a
0460   48C5 28 03       	jr	z,.pula1
0461   48C7 11 00 61    	ld	de, strSDV2
0462   48CA             .pula1: 
0463   48CA CD 57 5E    	call	printString
0464   48CD 3E 28       	ld	a,'('
0465   48CF CD A2 00    	call	CHPUT
0466   48D2 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0467   48D5 CD A4 5E    	call	printDecToAscii	; Imprimir Manufacturer ID
0468   48D8 3E 29       	ld	a,')'
0469   48DA CD A2 00    	call	CHPUT
0470   48DD 3E 20       	ld	a,' '
0471   48DF CD A2 00    	call	CHPUT
0472   48E2 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0473   48E5 CD D0 5E    	call	pegaFabricante	; achar nome do fabricante
0474   48E8 EB          	ex	de,hl
0475   48E9 CD 57 5E    	call	printString	; e imprimir
0476   48EC 11 66 60    	ld	de,strCrLf
0477   48EF CD 57 5E    	call	printString
0478   48F2 C9          	ret
0479   48F3             
0480   48F3             
0481   48F3             SDMAPPERINIT: 		; This block is exclusive for the SD-Mapper
0482   48F3 11 82 60    	ld	de, strMr_mp_desativada
0483   48F6 3A 00 7F    	ld	a, (PORTCFG)		; testar se mapper/megaram esta ativa
0484   48F9 E6 40       	and	$40
0485   48FB 28 0E       	jr	z,.print		; desativada, pula
0486   48FD 11 AA 60    	ld	de, strMapper
0487   4900 3A 00 7F    	ld	a, (PORTCFG)		; ativa, testar se eh mapper ou megaram
0488   4903 E6 80       	and	$80
0489   4905 C2 57 5E    	jp	nz,printString
0490   4908 11 D4 60    	ld	de, strMegaram		; Megaram ativa
0491   490B             .print: 
0492   490B C3 57 5E    	jp	printString
0493   490E             
0494   490E             MYSETSCR: 	; Restore screen parameters on MSX>=2 if they're not set yet
0495   490E 3A 2D 00    	ld	a,(MSXVER)
0496   4911 B7          	or	a			; MSX1?
0497   4912 C8          	ret	z			; Yes, return
0498   4913             
0499   4913 0E 23       	ld	c,$23			; Block-2, R#3
0500   4915 DD 21 F5 01 	ld 	ix,REDCLK
0501   4919 CD 5F 01    	call	EXTROM
0502   491C E6 01       	and	1
0503   491E 47          	ld	b,a
0504   491F 3A AF FC    	ld	a,(SCRMOD)
0505   4922 B8          	cp	b
0506   4923 20 1C       	jr	nz,.restore
0507   4925 0C          	inc	c
0508   4926 DD 21 F5 01 	ld 	ix,REDCLK
0509   492A CD 5F 01    	call	EXTROM
0510   492D 47          	ld	b,a
0511   492E 0C          	inc	c
0512   492F DD 21 F5 01 	ld 	ix,REDCLK
0513   4933 CD 5F 01    	call	EXTROM
0514   4936 87          	add	a,a
0515   4937 87          	add	a,a
0516   4938 87          	add	a,a
0517   4939 87          	add	a,a
0518   493A B0          	or	b
0519   493B 47          	ld	b,a
0520   493C 3A B0 F3    	ld	a,(LINLEN)
0521   493F B8          	cp	b
0522   4940 C8          	ret	z
0523   4941             .restore: 
0524   4941 AF          	xor	a		; Don't displat the function keys
0525   4942 DD 21 85 01 	ld	ix,SDFSCR
0526   4946 C3 5F 01    	jp	EXTROM
0527   4949             
0528   4949             ;-----------------------------------------------------------------------------
0529   4949             ;
0530   4949             ; Obtain driver version
0531   4949             ;
0532   4949             ; Input:  -
0533   4949             ; Output: A = Main version number
0534   4949             ;         B = Secondary version number
0535   4949             ;         C = Revision number
0536   4949             
0537   4949             DRV_VERSION: 
0538   4949 3E 01       	ld	a, VER_MAIN
0539   494B 06 00       	ld	b, VER_SEC
0540   494D 0E 05       	ld	c, VER_REV
0541   494F C9          	ret
0542   4950             
0543   4950             
0544   4950             ;-----------------------------------------------------------------------------
0545   4950             ;
0546   4950             ; BASIC expanded statement ("CALL") handler.
0547   4950             ; Works the expected way, except that if invoking CALBAS is needed,
0548   4950             ; it must be done via the CALLB0 routine in kernel page 0.
0549   4950             
0550   4950             DRV_BASSTAT: 
0551   4950 37          	scf
0552   4951 C9          	ret
0553   4952             
0554   4952             
0555   4952             ;-----------------------------------------------------------------------------
0556   4952             ;
0557   4952             ; BASIC expanded device handler.
0558   4952             ; Works the expected way, except that if invoking CALBAS is needed,
0559   4952             ; it must be done via the CALLB0 routine in kernel page 0.
0560   4952             
0561   4952             DRV_BASDEV: 
0562   4952 37          	scf
0563   4953 C9          	ret
0564   4954             
0565   4954             ;-----------------------------------------------------------------------------
0566   4954             ;
0567   4954             ; Extended BIOS hook.
0568   4954             ; Works the expected way, except that it must return
0569   4954             ; D'=1 if the old hook must be called, D'=0 otherwise.
0570   4954             ; It is entered with D'=1.
0571   4954             
0572   4954             DRV_EXTBIO: 
0573   4954 C9          	ret
0574   4955             
0575   4955             ;-----------------------------------------------------------------------------
0576   4955             ;
0577   4955             ; Direct calls entry points.
0578   4955             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0579   4955             ; in kernel banks 0 and 3 will be redirected
0580   4955             ; to DIRECT0/1/2/3/4 respectively.
0581   4955             ; Receives all register data from the caller except IX and AF'.
0582   4955             
0583   4955             DRV_DIRECT0: 
0584   4955             DRV_DIRECT1: 
0585   4955             DRV_DIRECT2: 
0586   4955             DRV_DIRECT3: 
0587   4955             DRV_DIRECT4: 
0588   4955 C9          	ret
0589   4956             
0590   4956             
0591   4956             ;=====
0592   4956             ;=====  BEGIN of DEVICE-BASED specific routines
0593   4956             ;=====
0594   4956             
0595   4956             ;-----------------------------------------------------------------------------
0596   4956             ;
0597   4956             ; Read or write logical sectors from/to a logical unit
0598   4956             ;
0599   4956             ;Input:    Cy=0 to read, 1 to write
0600   4956             ;          A = Device number, 1 to 7
0601   4956             ;          B = Number of sectors to read or write
0602   4956             ;          C = Logical unit number, 1 to 7
0603   4956             ;          HL = Source or destination memory address for the transfer
0604   4956             ;          DE = Address where the 4 byte sector number is stored.
0605   4956             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0606   4956             ;              0: Ok
0607   4956             ;              .IDEVL: Invalid device or LUN
0608   4956             ;              .NRDY: Not ready
0609   4956             ;              .DISK: General unknown disk error
0610   4956             ;              .DATA: CRC error when reading
0611   4956             ;              .RNF: Sector not found
0612   4956             ;              .UFORM: Unformatted disk
0613   4956             ;              .WPROT: Write protected media, or read-only logical unit
0614   4956             ;              .WRERR: Write error
0615   4956             ;              .NCOMP: Incompatible disk.
0616   4956             ;              .SEEK: Seek error.
0617   4956             ;          B = Number of sectors actually read (in case of error only)
0618   4956             
0619   4956             DEV_RW: 
0620   4956 F5          	push	af
0621   4958 BF FE 03    	cp	a, 3		; somente 2 dispositivos
0622   495A 30 10       	jr	nc,.saicomerroidl
0623   495C 0D          	dec	c		; somente 1 logical unit
0624   495D 20 0D       	jr	nz,.saicomerroidl
0625   495F E5          	push	hl
0626   4960 CD E2 4A    	call	testaCartao	; verificar se cartao esta OK
0627   4963 E1          	pop	hl
0628   4964 30 0C       	jr	nc,.ok
0629   4966 F1          	pop	af		; retira AF guardado no inicio
0630   4967 3E FC       	ld	a, ENRDY	; Not ready
0631   4969             ;	ld	a, EDISK	; General unknown disk error
0632   4969 06 00       	ld	b, 0
0633   496B C9          	ret
0634   496C             .saicomerroidl: 
0635   496C F1          	pop	af		; retira AF guardado no inicio
0636   496D 3E B5       	ld	a, EIDEVL	; informar erro
0637   496F 06 00       	ld	b, 0
0638   4971 C9          	ret
0639   4972             .ok: 
0640   4972 FD 70 32    	ld	(iy+NUMBLOCOS), b	; guarda numero de blocos para ler/gravar
0641   4975 E5          	push	hl
0642   4976 D5          	push	de
0643   4977 CD 25 4B    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0644   497A D1          	pop	de
0645   497B E1          	pop	hl
0646   497C F1          	pop	af		; retira AF guardado no inicio, para saber se eh leitura ou escrita
0647   497D 38 1F       	jr	c,escrita	; se for escrita pulamos
0648   497F             leitura: 
0649   497F 1A          	ld	a, (de)		; 1. n. bloco
0650   4980 F5          	push	af
0651   4981 13          	inc	de
0652   4982 1A          	ld	a, (de)		; 2. n. bloco
0653   4983 F5          	push	af
0654   4984 13          	inc	de
0655   4985 1A          	ld	a, (de)		; 3. n. bloco
0656   4986 4F          	ld	c, a
0657   4987 13          	inc	de
0658   4988 1A          	ld	a, (de)		; 4. n. bloco
0659   4989 13          	inc	de
0660   498A 47          	ld	b, a
0661   498B F1          	pop	af
0662   498C 57          	ld	d, a
0663   498D F1          	pop	af		; HL = ponteiro destino
0664   498E 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0665   498F CD EC 55    	call	LerBloco	; chamar rotina de leitura de dados
0666   4992 30 08       	jr	nc,.ok
0667   4994 CD 0A 4B    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0668   4997             ;	ld	a, ENRDY	; Not ready
0669   4997 3E FD       	ld	a, EDISK	; General unknown disk error
0670   4999 06 00       	ld	b, 0		; informar que lemos 0 blocos
0671   499B C9          	ret
0672   499C             .ok: 
0673   499C AF          	xor	a		; tudo OK, informar ao Nextor
0674   499D C9          	ret
0675   499E             
0676   499E             escrita: 
0677   499E CD 15 4B    	call	testaWP		; testar se cartao esta protegido contra escrita
0678   49A1 28 05       	jr	z,.ok
0679   49A3 3E F8       	ld	a, EWPROT	; disco protegido
0680   49A5 06 00       	ld	b, 0
0681   49A7 C9          	ret
0682   49A8             .ok: 
0683   49A8 1A          	ld	a, (de)		; 1. n. bloco
0684   49A9 F5          	push	af
0685   49AA 13          	inc	de
0686   49AB 1A          	ld	a, (de)		; 2. n. bloco
0687   49AC F5          	push	af
0688   49AD 13          	inc	de
0689   49AE 1A          	ld	a, (de)		; 3. n. bloco
0690   49AF 13          	inc	de
0691   49B0 4F          	ld	c, a
0692   49B1 1A          	ld	a, (de)		; 4. n. bloco
0693   49B2 13          	inc	de
0694   49B3 47          	ld	b, a
0695   49B4 F1          	pop	af
0696   49B5 57          	ld	d, a
0697   49B6 F1          	pop	af		; HL = ponteiro destino
0698   49B7 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0699   49B8 CD 44 4D    	call	GravarBloco	; chamar rotina de gravacao de dados
0700   49BB 30 08       	jr	nc,.ok2
0701   49BD CD 0A 4B    	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0702   49C0 3E FE       	ld	a,EWRERR	; Write error
0703   49C2 06 00       	ld	b,0
0704   49C4 C9          	ret
0705   49C5             .ok2: 
0706   49C5 AF          	xor	a			; gravacao sem erros!
0707   49C6 C9          	ret
0708   49C7             
0709   49C7             ;-----------------------------------------------------------------------------
0710   49C7             ;
0711   49C7             ; Device information gathering
0712   49C7             ;
0713   49C7             ;Input:   A = Device index, 1 to 7
0714   49C7             ;         B = Information to return:
0715   49C7             ;             0: Basic information
0716   49C7             ;             1: Manufacturer name string
0717   49C7             ;             2: Device name string
0718   49C7             ;             3: Serial number string
0719   49C7             ;         HL = Pointer to a buffer in RAM
0720   49C7             ;Output:  A = Error code:
0721   49C7             ;             0: Ok
0722   49C7             ;             1: Device not available or invalid device index
0723   49C7             ;             2: Information not available, or invalid information index
0724   49C7             ;         When basic information is requested,
0725   49C7             ;         buffer filled with the following information:
0726   49C7             ;
0727   49C7             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0728   49C7             ;        units (which is functionally equivalent to having only one).
0729   49C7             ;+1 (1): Device flags, always zero in Beta 2.
0730   49C7             ;
0731   49C7             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0732   49C7             ; left justified and padded with spaces. All the strings are optional,
0733   49C7             ; if not available, an error must be returned.
0734   49C7             ; If a string is provided by the device in binary format, it must be reported
0735   49C7             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0736   49C7             ; The maximum length for a string is 64 characters;
0737   49C7             ; if the string is actually longer, the leftmost 64 characters
0738   49C7             ; should be provided.
0739   49C7             ;
0740   49C7             ; In the case of the serial number string, the same rules for the strings
0741   49C7             ; apply, except that it must be provided right-justified,
0742   49C7             ; and if it is too long, the rightmost characters must be
0743   49C7             ; provided, not the leftmost.
0744   49C7             
0745   49C7             DEV_INFO: 
0746   49C7 04          	inc	b
0747   49C9 BF FE 03    	cp	a,3		; somente 2 dispositivos
0748   49CB 30 07       	jr	nc,.saicomerro
0749   49CD E5          	push	hl
0750   49CE CD E2 4A    	call	testaCartao	; verificar se cartao esta OK
0751   49D1 E1          	pop	hl
0752   49D2 30 03       	jr	nc,.ok		; nao houve erro
0753   49D4             .saicomerro: 
0754   49D4 3E 01       	ld	a, 1		; informar erro
0755   49D6 C9          	ret
0756   49D7             
0757   49D7             .ok: 
0758   49D7 10 07       	djnz	.naoBasic
0759   49D9             ; Basic information:
0760   49D9 3E 01       	ld	a,1		; 1 logical unit somente
0761   49DB 77          	ld	(hl), a
0762   49DC AF          	xor	a		; reservado, deve ser 0
0763   49DD 23          	inc	hl
0764   49DE 77          	ld	(hl), a
0765   49DF C9          	ret			; retorna com A=0 (OK)
0766   49E0             
0767   49E0             .naoBasic: 
0768   49E0 E5          	push	hl
0769   49E1 CD 25 4B    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0770   49E4 E1          	pop	hl
0771   49E5 10 25       	djnz	.naoManuf
0772   49E7             ; Manufacturer Name:
0773   49E7 E5          	push	hl		; salva ponteiro do buffer
0774   49E8 06 40       	ld	b, 64		; preenche buffer com espaco
0775   49EA 3E 20       	ld	a, ' '
0776   49EC             .loop1: 
0777   49EC 77          	ld	(hl), a
0778   49ED 23          	inc	hl
0779   49EE 10 FC       	djnz	.loop1
0780   49F0 D1          	pop	de		; recuperamos ponteiro do buffer em DE
0781   49F1 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0782   49F3 12          	ld	(de), a
0783   49F4 13          	inc	de
0784   49F5 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0785   49F8 CD 60 5E    	call	DecToAscii
0786   49FB 3E 29       	ld	a, ')'
0787   49FD 12          	ld	(de), a
0788   49FE 13          	inc	de
0789   49FF 3E 20       	ld	a, ' '
0790   4A01 12          	ld	(de), a
0791   4A02 13          	inc	de
0792   4A03 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0793   4A06 CD D0 5E    	call	pegaFabricante	; pegar nome do fabricante em HL
0794   4A09 ED B0       	ldir			; e colocar no buffer
0795   4A0B C9          	ret
0796   4A0C             
0797   4A0C             .naoManuf: 
0798   4A0C 10 1A       	djnz	.naoProduct
0799   4A0E             ; Product Name:
0800   4A0E E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0801   4A0F DD E5       	push	ix
0802   4A11 E1          	pop	hl		; joga IX para HL
0803   4A12 16 00       	ld	d, 0
0804   4A14 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0805   4A16 19          	add	hl, de
0806   4A17 D1          	pop	de		; recupera buffer do Nextor em DE
0807   4A18 01 05 00    	ld	bc, 5		; 5 caracteres
0808   4A1B ED B0       	ldir			; copia nome do produto
0809   4A1D EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0810   4A1E 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0811   4A20 3E 20       	ld	a, ' '
0812   4A22             .loop2: 
0813   4A22 77          	ld	(hl), a
0814   4A23 23          	inc	hl
0815   4A24 10 FC       	djnz	.loop2
0816   4A26 AF          	xor	a		; informar sem erros
0817   4A27 C9          	ret
0818   4A28             
0819   4A28             .naoProduct: 
0820   4A28             ; Serial:
0821   4A28 3E 30       	ld	a, '0'		; Coloca prefixo "0x"
0822   4A2A 77          	ld	(hl), a
0823   4A2B 23          	inc	hl
0824   4A2C 3E 78       	ld	a, 'x'
0825   4A2E 77          	ld	(hl), a
0826   4A2F 23          	inc	hl
0827   4A30 E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0828   4A31 DD E5       	push	ix
0829   4A33 E1          	pop	hl		; joga IX para HL
0830   4A34 16 00       	ld	d, 0
0831   4A36 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0832   4A38 19          	add	hl, de
0833   4A39 D1          	pop	de		; recupera buffer do nextor em DE
0834   4A3A 06 04       	ld	b, 4		; 4 bytes do serial
0835   4A3C             .loop3: 
0836   4A3C 7E          	ld	a, (hl)
0837   4A3D CD 90 5E    	call	HexToAscii	; converter HEXA para ASCII
0838   4A40 23          	inc	hl
0839   4A41 10 F9       	djnz	.loop3
0840   4A43 06 36       	ld	b, 54		; Coloca espaco no restante
0841   4A45 3E 20       	ld	a, ' '
0842   4A47             .loop4: 
0843   4A47 12          	ld	(de), a
0844   4A48 13          	inc	de
0845   4A49 10 FC       	djnz	.loop4
0846   4A4B AF          	xor	a		; informar sem erros
0847   4A4C C9          	ret
0848   4A4D             
0849   4A4D             ;-----------------------------------------------------------------------------
0850   4A4D             ;
0851   4A4D             ; Obtain device status
0852   4A4D             ;
0853   4A4D             ;Input:   A = Device index, 1 to 7
0854   4A4D             ;         B = Logical unit number, 1 to 7
0855   4A4D             ;             0 to return the status of the device itself.
0856   4A4D             ;Output:  A = Status for the specified logical unit,
0857   4A4D             ;             or for the whole device if 0 was specified:
0858   4A4D             ;                0: The device or logical unit is not available, or the
0859   4A4D             ;                   device or logical unit number supplied is invalid.
0860   4A4D             ;                1: The device or logical unit is available and has not
0861   4A4D             ;                   changed since the last status request.
0862   4A4D             ;                2: The device or logical unit is available and has changed
0863   4A4D             ;                   since the last status request
0864   4A4D             ;                   (for devices, the device has been unplugged and a
0865   4A4D             ;                    different device has been plugged which has been
0866   4A4D             ;                    assigned the same device index; for logical units,
0867   4A4D             ;                    the media has been changed).
0868   4A4D             ;                3: The device or logical unit is available, but it is not
0869   4A4D             ;                   possible to determine whether it has been changed
0870   4A4D             ;                   or not since the last status request.
0871   4A4D             ;
0872   4A4D             ; Devices not supporting hot-plugging must always return status value 1.
0873   4A4D             ; Non removable logical units may return values 0 and 1.
0874   4A4D             ;
0875   4A4D             ; The returned status is always relative to the previous invokation of
0876   4A4D             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0877   4A4D             
0878   4A4D             DEV_STATUS: 
0879   4A4E BF FE 03    	cp	a,3		; 2 dispositivos somente
0880   4A50 30 38       	jr	nc,.saicomerro
0881   4A52 05          	dec	b		; 1 logical unit somente
0882   4A53 20 35       	jr	nz,.saicomerro
0883   4A55             
0884   4A55 F5          	push	af
0885   4A56 CD CC 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
0886   4A59 F1          	pop	af
0887   4A5A FD 77 30    	ld	(iy+NUMSD),a	; salva numero do device atual (1 ou 2)
0888   4A5D 4F          	ld	c,a		; c=device number
0889   4A5E C5          	push	bc
0890   4A5F CB 01       	rlc	c
0891   4A61 CB 01       	rlc	c							; ......XX => ....XX..
0892   4A63 3A 00 7F    	ld	a, (PORTCFG)	; testar se cartao esta inserido
0893   4A66 A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
0894   4A67 C1          	pop		bc
0895   4A68 20 1D       	jr	nz,.cartaoComErro	; se slot do cartao estiver vazio, marcamos o erro nas flags
0896   4A6A FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
0897   4A6D A1          	and	c
0898   4A6E 28 14       	jr	z,.semMudanca	; cartao nao marcado com erro, pula
0899   4A70 CD 4D 4B    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0900   4A73 38 12       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0901   4A75 FD 7E 30    	ld	a, (iy+NUMSD)		; conseguimos detectar, tira erro nas flags
0902   4A78 2F          	cpl			; inverte bits para fazer o AND
0903   4A79 4F          	ld	c, a
0904   4A7A FD 7E 31    	ld	a, (iy+FLAGSCARTAO)
0905   4A7D A1          	and	c			; limpa bit
0906   4A7E FD 77 31    	ld	(iy+FLAGSCARTAO), a
0907   4A81             .comMudanca: 
0908   4A81 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0909   4A83 C9          	ret
0910   4A84             .semMudanca: 
0911   4A84 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0912   4A86 C9          	ret
0913   4A87             .cartaoComErro: 
0914   4A87 CD 0A 4B    	call	marcaErroCartao	; marcar erro do cartao nas flags
0915   4A8A             .saicomerro: 
0916   4A8A 3E 00       	ld	a, 0		; informa erro
0917   4A8C C9          	ret
0918   4A8D             
0919   4A8D             ;-----------------------------------------------------------------------------
0920   4A8D             ;
0921   4A8D             ; Obtain logical unit information
0922   4A8D             ;
0923   4A8D             ;Input:   A  = Device index, 1 to 7
0924   4A8D             ;         B  = Logical unit number, 1 to 7
0925   4A8D             ;         HL = Pointer to buffer in RAM.
0926   4A8D             ;Output:  A = 0: Ok, buffer filled with information.
0927   4A8D             ;             1: Error, device or logical unit not available,
0928   4A8D             ;                or device index or logical unit number invalid.
0929   4A8D             ;         On success, buffer filled with the following information:
0930   4A8D             ;
0931   4A8D             ;+0 (1): Medium type:
0932   4A8D             ;        0: Block device
0933   4A8D             ;        1: CD or DVD reader or recorder
0934   4A8D             ;        2-254: Unused. Additional codes may be defined in the future.
0935   4A8D             ;        255: Other
0936   4A8D             ;+1 (2): Sector size, 0 if this information does not apply or is
0937   4A8D             ;        not available.
0938   4A8D             ;+3 (4): Total number of available sectors.
0939   4A8D             ;        0 if this information does not apply or is not available.
0940   4A8D             ;+7 (1): Flags:
0941   4A8D             ;        bit 0: 1 if the medium is removable.
0942   4A8D             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0943   4A8D             ;               be write protected or write enabled is not considered
0944   4A8D             ;               to be read-only.
0945   4A8D             ;        bit 2: 1 if the LUN is a floppy disk drive.
0946   4A8D             ;+8 (2): Number of cylinders
0947   4A8D             ;+10 (1): Number of heads
0948   4A8D             ;+11 (1): Number of sectors per track
0949   4A8D             ;
0950   4A8D             ; Number of cylinders, heads and sectors apply to hard disks only.
0951   4A8D             ; For other types of device, these fields must be zero.
0952   4A8D             
0953   4A8D             LUN_INFO: 
0954   4A8E BF FE 03    	cp	a, 3		; somente 2 dispositivo
0955   4A90 30 0A       	jr	nc,.saicomerro
0956   4A92 05          	dec	b		; somente 1 logical unit
0957   4A93 20 07       	jr	nz,.saicomerro
0958   4A95 E5          	push	hl
0959   4A96 CD E2 4A    	call	testaCartao
0960   4A99 E1          	pop	hl
0961   4A9A 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0962   4A9C             .saicomerro: 
0963   4A9C 3E 01       	ld	a, 1		; informar erro
0964   4A9E C9          	ret
0965   4A9F             .ok: 
0966   4A9F E5          	push	hl
0967   4AA0 CD 39 4B    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0968   4AA3 E1          	pop	hl		; do cartao dependendo do cartao atual solicitado
0969   4AA4 AF          	xor	a
0970   4AA5 77          	ld	(hl), a		; Informar que o dispositivo eh do tipo block device
0971   4AA6 23          	inc	hl
0972   4AA7 77          	ld	(hl), a		; tamanho de um bloco = 512 bytes (coloca $00, $02 que é $200 = 512)
0973   4AA8 23          	inc	hl
0974   4AA9 3E 02       	ld	a, 2
0975   4AAB 77          	ld	(hl), a
0976   4AAC 23          	inc	hl
0977   4AAD DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0978   4AB0 77          	ld	(hl), a
0979   4AB1 23          	inc	hl
0980   4AB2 DD 7E 01    	ld	a, (ix+1)
0981   4AB5 77          	ld	(hl), a
0982   4AB6 23          	inc	hl
0983   4AB7 DD 7E 02    	ld	a, (ix+2)
0984   4ABA 77          	ld	(hl), a
0985   4ABB 23          	inc	hl
0986   4ABC AF          	xor	a		; cartoes SD tem total de blocos em 24 bits, mas o Nextor pede numero de
0987   4ABD 77          	ld	(hl), a 	; 32 bits, entao coloca 0 no MSB
0988   4ABE 23          	inc	hl
0989   4ABF 3E 01       	ld	a, 1		; flags: dispositivo R/W removivel
0990   4AC1 77          	ld	(hl), a
0991   4AC2 23          	inc	hl
0992   4AC3 AF          	xor	a		; CHS = 0
0993   4AC4 77          	ld	(hl), a
0994   4AC5 23          	inc	hl
0995   4AC6 77          	ld	(hl), a
0996   4AC7 23          	inc	hl
0997   4AC8 77          	ld	(hl), a
0998   4AC9 23          	inc	hl
0999   4ACA AF          	xor	a		; informar que dados foram preenchidos
1000   4ACB C9          	ret
1001   4ACC             
1002   4ACC             ;=====
1003   4ACC             ;=====  END of DEVICE-BASED specific routines
1004   4ACC             ;=====
1005   4ACC             
1006   4ACC             ;------------------------------------------------
1007   4ACC             ; Rotinas auxiliares
1008   4ACC             ;------------------------------------------------
1009   4ACC             
1010   4ACC             ;------------------------------------------------
1011   4ACC             ; Pedir ao Nextor o ponteiro de dados de trabalho
1012   4ACC             ; na RAM e colocar em HL e IY
1013   4ACC             ; Destroi HL e IY
1014   4ACC             ;------------------------------------------------
1015   4ACC             pegaWorkArea: 
1016   4ACC F5          	push	af
1017   4ACD AF          	xor	a		; Pegar endereco da area de trabalho
1018   4ACE 08          	ex	af,af'
1019   4ACF AF          	xor	a
1020   4AD0 DD 21 45 40 	ld	ix, GWORK
1021   4AD4 CD 42 40    	call	CALBNK
1022   4AD7 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
1023   4ADA DD 66 01    	ld	h,(ix+1)
1024   4ADD E5          	push	hl
1025   4ADE FD E1       	pop	iy		; em IY temos o mesmo ponteiro
1026   4AE0 F1          	pop	af
1027   4AE1 C9          	ret
1028   4AE2             
1029   4AE2             ;------------------------------------------------
1030   4AE2             ; Testa se cartao esta inserido e/ou houve erro
1031   4AE2             ; na ultima vez que foi acessado. Carry indica
1032   4AE2             ; erro
1033   4AE2             ; Destroi AF, HL, IX, C
1034   4AE2             ;------------------------------------------------
1035   4AE2             testaCartao: 
1036   4AE2 F5          	push	af
1037   4AE3 CD CC 4A    	call	pegaWorkArea	; HL=IY=Work area pointer
1038   4AE6 F1          	pop	af
1039   4AE7 FD 77 30    	ld	(iy+NUMSD), a	; salva numero do device atual (1 ou 2)
1040   4AEA 4F          	ld	c, a
1041   4AEB C5          	push	bc
1042   4AEC CB 01       	rlc	c
1043   4AEE CB 01       	rlc	c							; ......XX => ....XX..
1044   4AF0 3A 00 7F    	ld	a, (PORTCFG)	; testar se cartao esta inserido
1045   4AF3 A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
1046   4AF4 C1          	pop	bc
1047   4AF5 20 0A       	jr	nz,.saicomerro				
1048   4AF7 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
1049   4AFA A1          	and	c
1050   4AFB 28 02       	jr	z,.ok
1051   4AFD 37          	scf			; indica erro
1052   4AFE C9          	ret
1053   4AFF             .ok: 
1054   4AFF AF          	xor	a		; zera carry indicando sem erro
1055   4B00 C9          	ret
1056   4B01             .saicomerro: 
1057   4B01 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marca bit de erro nas flags
1058   4B04 B1          	or	c
1059   4B05 FD 77 31    	ld	(iy+FLAGSCARTAO), a
1060   4B08 37          	scf
1061   4B09 C9          	ret
1062   4B0A             
1063   4B0A             ;------------------------------------------------
1064   4B0A             ; Marcar bit de erro nas flags
1065   4B0A             ; Destroi AF, C
1066   4B0A             ;------------------------------------------------
1067   4B0A             marcaErroCartao: 
1068   4B0A FD 4E 30    	ld	c, (iy+NUMSD)		; cartao atual (1 ou 2)
1069   4B0D FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marcar erro
1070   4B10 B1          	or	c
1071   4B11 FD 77 31    	ld	(iy+FLAGSCARTAO), a
1072   4B14 C9          	ret
1073   4B15             
1074   4B15             ;------------------------------------------------
1075   4B15             ; Testar se cartao atual esta protegido contra
1076   4B15             ; gravacao, A=0 se protegido
1077   4B15             ; Destroi AF, C
1078   4B15             ;------------------------------------------------
1079   4B15             testaWP: 
1080   4B15 FD 4E 30    	ld	c, (iy+NUMSD)	; cartao atual (1 ou 2)
1081   4B18 CB 01       	rlc	c
1082   4B1A CB 01       	rlc	c
1083   4B1C CB 01       	rlc	c
1084   4B1E CB 01       	rlc	c							; ......XX => ..XX....
1085   4B20 3A 00 7F    	ld	a, (PORTCFG)	; testar se cartao esta protegido
1086   4B23 A1          	and	c
1087   4B24 C9          	ret			; se A for 0 cartao esta protegido
1088   4B25             
1089   4B25             ;------------------------------------------------
1090   4B25             ; Calcula offset do buffer na RAM em HL e IX para
1091   4B25             ; os dados do CID dependendo do cartao atual
1092   4B25             ; Destroi AF, DE, HL e IX
1093   4B25             ;------------------------------------------------
1094   4B25             calculaCIDoffset: 
1095   4B25 FD E5       	push	iy		; copiamos IY para HL
1096   4B27 E1          	pop	hl
1097   4B28 16 00       	ld	d, 0
1098   4B2A 1E 10       	ld	e, BCID1	; DE aponta para buffer BCID1
1099   4B2C FD 7E 30    	ld	a, (iy+NUMSD)	; vamos fazer IX apontar para o buffer correto
1100   4B2F 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1101   4B30 28 02       	jr	z,.c1
1102   4B32 1E 20       	ld	e, BCID2	; DE aponta para buffer BCID2
1103   4B34             .c1: 
1104   4B34 19          	add	hl, de		; HL aponta para buffer correto
1105   4B35 E5          	push	hl		
1106   4B36 DD E1       	pop	ix		; vamos colocar HL em IX
1107   4B38 C9          	ret
1108   4B39             
1109   4B39             ;------------------------------------------------
1110   4B39             ; Calcula offset do buffer na RAM para os dados
1111   4B39             ; do total de blocos dependendo do cartao atual
1112   4B39             ; Offset fica em HL e IX
1113   4B39             ; Destroi AF, DE, HL e IX
1114   4B39             ;------------------------------------------------
1115   4B39             calculaBLOCOSoffset: 
1116   4B39 FD E5       	push	iy		; copiamos IY para HL
1117   4B3B E1          	pop	hl
1118   4B3C 16 00       	ld	d, 0
1119   4B3E 1E 38       	ld	e, BLOCOS1	; DE aponta para buffer BLOCOS1
1120   4B40 FD 7E 30    	ld	a, (iy+NUMSD)	; Vamos fazer IX apontar para o buffer correto
1121   4B43 3D          	dec	a		; dependendo do cartao: BLOCOS1 ou BLOCOS2
1122   4B44 28 02       	jr	z,.c1
1123   4B46 1E 3C       	ld	e, BLOCOS2	; DE aponta para buffer BLOCOS2
1124   4B48             .c1: 
1125   4B48 19          	add	hl, de		; HL aponta para buffer correto
1126   4B49 E5          	push	hl		
1127   4B4A DD E1       	pop	ix		; Vamos colocar HL em IX
1128   4B4C C9          	ret
1129   4B4D             
1130   4B4D             
1131   4B4D             ;------------------------------------------------
1132   4B4D             ; Minhas funcoes para cartao SD
1133   4B4D             ;------------------------------------------------
1134   4B4D             
1135   4B4D             ;------------------------------------------------
1136   4B4D             ; Processo de inicializacao e deteccao do cartao.
1137   4B4D             ; Detecta se cartao responde, qual versao (SDV1
1138   4B4D             ; ou SDV2), faz a leitura do CSD e CID e calcula
1139   4B4D             ; o numero de blocos do cartao, colocando o CID
1140   4B4D             ; e total de blocos no buffer correto dependendo
1141   4B4D             ; do cartao 1 ou 2.
1142   4B4D             ; Retorna erro no carry. Se for 0 indica deteccao
1143   4B4D             ; com sucesso.
1144   4B4D             ; Destroi todos os registradores
1145   4B4D             ;------------------------------------------------
1146   4B4D             detectaCartao: 
1147   4B4D CD 71 4C    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1148   4B50 D8          	ret	c			; retorna se erro
1149   4B51 CD 1C 4C    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1150   4B54 D8          	ret	c
1151   4B55 FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1152   4B57 E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1153   4B58 3E 49       	ld	a, CMD9		; ler CSD
1154   4B5A CD 3D 4C    	call	lerBlocoCxD
1155   4B5D D8          	ret	c
1156   4B5E CD 25 4B    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1157   4B61 3E 4A       	ld	a, CMD10	; ler CID
1158   4B63 CD 3D 4C    	call	lerBlocoCxD
1159   4B66 D8          	ret	c
1160   4B67 3E 7A       	ld	a, CMD58	; ler OCR
1161   4B69 11 00 00    	ld	de, 0
1162   4B6C CD C2 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1163   4B6F D8          	ret	c
1164   4B70 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1165   4B71 E6 40       	and	$40
1166   4B73 DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1167   4B76 CC 11 4C    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1168   4B79 D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1169   4B7A CD 90 4C    	call	desabilitaSDs
1170   4B7D             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1171   4B7D CD 39 4B    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1172   4B80 FD E5       	push	iy		; copiamos IY para HL
1173   4B82 E1          	pop	hl
1174   4B83 16 00       	ld	d, 0
1175   4B85 1E 05       	ld	e, BCSD+5
1176   4B87 19          	add	hl, de		; HL aponta para buffer BCSD+5
1177   4B88 FD 7E 00    	ld	a, (iy+BCSD)
1178   4B8B E6 C0       	and	$C0		; testa versao do registro CSD
1179   4B8D 28 06       	jr	z,.calculaCSD1
1180   4B8F FE 40       	cp	$40
1181   4B91 28 54       	jr	z,.calculaCSD2
1182   4B93 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1183   4B94 C9          	ret
1184   4B95             
1185   4B95             ; -----------------------------------
1186   4B95             ; Registro CSD versao 1, calcular da
1187   4B95             ; maneira correta para a versao 1
1188   4B95             ; -----------------------------------
1189   4B95             .calculaCSD1: 
1190   4B95 7E          	ld	a, (hl)
1191   4B96 E6 0F       	and	$0F		; isola READ_BL_LEN
1192   4B98 F5          	push	af
1193   4B99 23          	inc	hl
1194   4B9A 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1195   4B9B E6 03       	and	3
1196   4B9D 57          	ld	d, a
1197   4B9E 23          	inc	hl
1198   4B9F 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1199   4BA0 23          	inc	hl
1200   4BA1 7E          	ld	a, (hl)
1201   4BA2 E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1202   4BA4 87          	add	a, a		; rotaciona a esquerda
1203   4BA5 CB 13       	rl	e		; rotaciona para DE
1204   4BA7 CB 12       	rl	d
1205   4BA9 87          	add	a, a		; mais uma rotacao
1206   4BAA CB 13       	rl	e		; rotaciona para DE
1207   4BAC CB 12       	rl	d
1208   4BAE 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1209   4BAF 23          	inc	hl
1210   4BB0 7E          	ld	a, (hl)		; proximo byte
1211   4BB1 E6 03       	and	3		; 2 bits de C_SIZE_MUL
1212   4BB3 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1213   4BB4 23          	inc	hl						
1214   4BB5 7E          	ld	a, (hl)		; proximo byte
1215   4BB6 E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1216   4BB8 87          	add	a, a		; rotaciona para esquerda jogando no carry
1217   4BB9 CB 10       	rl	b		; rotaciona para B
1218   4BBB 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1219   4BBC 04          	inc	b		; faz B = C_SIZE_MUL + 2
1220   4BBD F1          	pop	af		; volta em A o READ_BL_LEN
1221   4BBE 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1222   4BBF 01 00 00    	ld	bc, 0
1223   4BC2 CD DB 4B    	call	.eleva2
1224   4BC5 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1225   4BC6 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1226   4BC7 48          	ld	c, b
1227   4BC8 06 00       	ld	b, 0
1228   4BCA CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1229   4BCC CB 1A       	rr	d		; rotacionamos D e E
1230   4BCE CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1231   4BD0             .salvaBlocos: 
1232   4BD0 DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1233   4BD3 DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1234   4BD6 DD 73 00    	ld	(ix), e
1235   4BD9 AF          	xor	a		; limpa carry
1236   4BDA C9          	ret
1237   4BDB             
1238   4BDB             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1239   4BDB             				; BC = 0
1240   4BDB             				; DE = C_SIZE
1241   4BDB CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1242   4BDD CB 12       	rl	d
1243   4BDF CB 11       	rl	c
1244   4BE1 CB 10       	rl	b
1245   4BE3 3D          	dec	a		; subtraimos 1
1246   4BE4 20 F5       	jr	nz,.eleva2
1247   4BE6 C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1248   4BE7             
1249   4BE7             ; -----------------------------------
1250   4BE7             ; Registro CSD versao 2, calcular da
1251   4BE7             ; maneira correta para a versao 2
1252   4BE7             ; -----------------------------------
1253   4BE7             .calculaCSD2: 
1254   4BE7 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1255   4BE8 23          	inc	hl
1256   4BE9 7E          	ld	a, (hl)
1257   4BEA E6 3F       	and	$3F
1258   4BEC 4F          	ld	c, a
1259   4BED 23          	inc	hl
1260   4BEE 56          	ld	d, (hl)
1261   4BEF 23          	inc	hl
1262   4BF0 5E          	ld	e, (hl)
1263   4BF1 CD FD 4B    	call	.inc32		; soma 1
1264   4BF4 CD 05 4C    	call	.desloca32	; multiplica por 512
1265   4BF7 CD 0A 4C    	call	.rotaciona24	; multiplica por 2
1266   4BFA C3 D0 4B    	jp		.salvaBlocos
1267   4BFD             
1268   4BFD             .inc32: 
1269   4BFD 1C          	inc	e
1270   4BFE C0          	ret	nz
1271   4BFF 14          	inc	d
1272   4C00 C0          	ret	nz
1273   4C01 0C          	inc	c
1274   4C02 C0          	ret	nz
1275   4C03 04          	inc	b
1276   4C04 C9          	ret
1277   4C05             
1278   4C05             .desloca32: 
1279   4C05 41          	ld	b, c
1280   4C06 4A          	ld	c, d
1281   4C07 53          	ld	d, e
1282   4C08 1E 00       	ld	e, 0
1283   4C0A             .rotaciona24: 
1284   4C0A CB 22       	sla	d
1285   4C0C CB 11       	rl	c
1286   4C0E CB 10       	rl	b
1287   4C10 C9          	ret
1288   4C11             
1289   4C11             ; ------------------------------------------------
1290   4C11             ; Setar o tamanho do bloco para 512 se o cartao
1291   4C11             ; for SDV1
1292   4C11             ; ------------------------------------------------
1293   4C11             mudarTamanhoBlocoPara512: 
1294   4C11 3E 50       	ld	a, CMD16
1295   4C13 01 00 00    	ld	bc, 0
1296   4C16 11 00 02    	ld	de, 512
1297   4C19 C3 AD 4C    	jp	SD_SEND_CMD_GET_ERROR
1298   4C1C             
1299   4C1C             ; ------------------------------------------------
1300   4C1C             ; Tenta inicializar um cartao SDV2, se houver erro
1301   4C1C             ; o cartao deve ser SDV1
1302   4C1C             ; ------------------------------------------------
1303   4C1C             testaSDCV2: 
1304   4C1C 3E 48       	ld	a, CMD8
1305   4C1E 11 AA 01    	ld	de, $1AA
1306   4C21 CD C2 4C    	call	SD_SEND_CMD_2_ARGS_GET_R3
1307   4C24 21 A6 4C    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1308   4C27 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1309   4C29 21 98 4C    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1310   4C2C             .pula: 
1311   4C2C 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1312   4C2F             .loop: 
1313   4C2F C5          	push	bc
1314   4C30 CD 3C 4C    	call	.jumpHL		; chamar rotina correta em HL
1315   4C33 C1          	pop	bc
1316   4C34 D0          	ret	nc
1317   4C35 10 F8       	djnz	.loop
1318   4C37 0D          	dec	c
1319   4C38 20 F5       	jr	nz,.loop
1320   4C3A 37          	scf
1321   4C3B C9          	ret
1322   4C3C             .jumpHL: 
1323   4C3C E9          	jp	(hl)		; chamar rotina correta em HL
1324   4C3D             
1325   4C3D             ; ------------------------------------------------
1326   4C3D             ; Ler registro CID ou CSD, o comando vem em A
1327   4C3D             ; ------------------------------------------------
1328   4C3D             lerBlocoCxD: 
1329   4C3D CD A8 4C    	call	SD_SEND_CMD_NO_ARGS
1330   4C40 D8          	ret	c
1331   4C41 CD 0B 4D    	call	WAIT_RESP_FE
1332   4C44 D8          	ret	c
1333   4C45 11 00 7B    	ld	de, PORTSPI
1334   4C48 EB          	ex	de,hl
1335   4C49 ED A0       > ldi	
1335   4C4B ED A0       > ldi	
1335   4C4D ED A0       > ldi	
1335   4C4F ED A0       > ldi	
1335   4C51 ED A0       > ldi	
1335   4C53 ED A0       > ldi	
1335   4C55 ED A0       > ldi	
1335   4C57 ED A0       > ldi	
1335   4C59 ED A0       > ldi	
1335   4C5B ED A0       > ldi	
1335   4C5D ED A0       > ldi	
1335   4C5F ED A0       > ldi	
1335   4C61 ED A0       > ldi	
1335   4C63 ED A0       > ldi	
1335   4C65 ED A0       > ldi	
1335   4C67 ED A0       > ldi	
1336   4C69 00          	nop
1337   4C6A 7E          	ld	a, (hl)
1338   4C6B 00          	nop
1339   4C6C 7E          	ld	a, (hl)		; byte de resposta
1340   4C6D B7          	or	a
1341   4C6E EB          	ex	de,hl
1342   4C6F 18 1F       	jr		desabilitaSDs
1343   4C71             
1344   4C71             ; ------------------------------------------------
1345   4C71             ; Algoritmo para inicializar um cartao SD
1346   4C71             ; Destroi AF, B, DE
1347   4C71             ; ------------------------------------------------
1348   4C71             iniciaSD: 
1349   4C71 CD 90 4C    	call	desabilitaSDs
1350   4C74             
1351   4C74 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1352   4C76             enviaClocksInicio: 
1353   4C76 3E FF       	ld	a, $FF		; manter MOSI em 1
1354   4C78 32 00 7B    	ld	(PORTSPI), a
1355   4C7B 10 F9       	djnz	enviaClocksInicio
1356   4C7D CD 37 4D    	call	setaSDAtual	; ativar cartao atual
1357   4C80 06 08       	ld	b, 8		; 8 tentativas para CMD0
1358   4C82             SD_SEND_CMD0: 
1359   4C82 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1360   4C84 11 00 00    	ld	de, 0
1361   4C87 C5          	push	bc
1362   4C88 CD B5 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1363   4C8B C1          	pop	bc
1364   4C8C D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1365   4C8D 10 F3       	djnz	SD_SEND_CMD0
1366   4C8F 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1367   4C90             	; fall throw
1368   4C90             
1369   4C90             ; ------------------------------------------------
1370   4C90             ; Desabilitar (de-selecionar) todos os cartoes
1371   4C90             ; Nao destroi registradores
1372   4C90             ; ------------------------------------------------
1373   4C90             desabilitaSDs: 
1374   4C90 F5          	push	af
1375   4C91 3E FF       	ld	a, $FF		; todos os /CS em 1
1376   4C93 32 00 7F    	ld	(PORTCFG), a
1377   4C96 F1          	pop	af
1378   4C97 C9          	ret
1379   4C98             
1380   4C98             ; ------------------------------------------------
1381   4C98             ; Enviar comando ACMD41
1382   4C98             ; ------------------------------------------------
1383   4C98             SD_SEND_ACMD41: 
1384   4C98 3E 77       	ld	a, CMD55
1385   4C9A CD A8 4C    	call	SD_SEND_CMD_NO_ARGS
1386   4C9D 3E 69       	ld	a, ACMD41
1387   4C9F 01 00 40    	ld	bc, $4000
1388   4CA2 51          	ld	d, c
1389   4CA3 59          	ld	e, c
1390   4CA4 18 07       	jr		SD_SEND_CMD_GET_ERROR
1391   4CA6             
1392   4CA6             ; ------------------------------------------------
1393   4CA6             ; Enviar CMD1 para cartao. Carry indica erro
1394   4CA6             ; Destroi AF, BC, DE
1395   4CA6             ; ------------------------------------------------
1396   4CA6             SD_SEND_CMD1: 
1397   4CA6 3E 41       	ld	a, CMD1
1398   4CA8             SD_SEND_CMD_NO_ARGS: 
1399   4CA8 01 00 00    	ld	bc, 0
1400   4CAB 50          	ld	d, b
1401   4CAC 59          	ld	e, c
1402   4CAD             SD_SEND_CMD_GET_ERROR: 
1403   4CAD CD DB 4C    	call	SD_SEND_CMD
1404   4CB0 B7          	or	a
1405   4CB1 C8          	ret	z			; se A=0 nao houve erro, retornar
1406   4CB2             	; fall throw
1407   4CB2             
1408   4CB2             ; ------------------------------------------------
1409   4CB2             ; Informar erro
1410   4CB2             ; Nao destroi registradores
1411   4CB2             ; ------------------------------------------------
1412   4CB2             setaErro: 
1413   4CB2 37          	scf
1414   4CB3 18 DB       	jr		desabilitaSDs
1415   4CB5             
1416   4CB5             ; ------------------------------------------------
1417   4CB5             ; Enviar comando em A com 2 bytes de parametros
1418   4CB5             ; em DE e testar retorno BUSY
1419   4CB5             ; Retorna em A a resposta do cartao
1420   4CB5             ; Destroi AF, BC
1421   4CB5             ; ------------------------------------------------
1422   4CB5             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1423   4CB5 01 00 00    	ld	bc, 0
1424   4CB8 CD DB 4C    	call	SD_SEND_CMD
1425   4CBB 47          	ld	b, a
1426   4CBC E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1427   4CBE 78          	ld	a, b
1428   4CBF 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1429   4CC1 C9          	ret			; sem erros
1430   4CC2             
1431   4CC2             ; ------------------------------------------------
1432   4CC2             ; Enviar comando em A com 2 bytes de parametros
1433   4CC2             ; em DE e ler resposta do tipo R3 em BC DE
1434   4CC2             ; Retorna em A a resposta do cartao
1435   4CC2             ; Destroi AF, BC, DE, HL
1436   4CC2             ; ------------------------------------------------
1437   4CC2             SD_SEND_CMD_2_ARGS_GET_R3: 
1438   4CC2 CD B5 4C    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1439   4CC5 D8          	ret	c
1440   4CC6 F5          	push	af
1441   4CC7 CD 19 4D    	call	WAIT_RESP_NO_FF
1442   4CCA 67          	ld	h, a
1443   4CCB CD 19 4D    	call	WAIT_RESP_NO_FF
1444   4CCE 6F          	ld	l, a
1445   4CCF CD 19 4D    	call	WAIT_RESP_NO_FF
1446   4CD2 57          	ld	d, a
1447   4CD3 CD 19 4D    	call	WAIT_RESP_NO_FF
1448   4CD6 5F          	ld	e, a
1449   4CD7 44          	ld	b, h
1450   4CD8 4D          	ld	c, l
1451   4CD9 F1          	pop	af
1452   4CDA C9          	ret
1453   4CDB             
1454   4CDB             ; ------------------------------------------------
1455   4CDB             ; Enviar comando em A com 4 bytes de parametros
1456   4CDB             ; em BC DE e enviar CRC correto se for CMD0 ou 
1457   4CDB             ; CMD8 e aguardar processamento do cartao
1458   4CDB             ; Destroi AF, BC
1459   4CDB             ; ------------------------------------------------
1460   4CDB             SD_SEND_CMD: 
1461   4CDB CD 37 4D    	call	setaSDAtual
1462   4CDE 32 00 7B    	ld	(PORTSPI), a
1463   4CE1 F5          	push	af
1464   4CE2 78          	ld	a, b
1465   4CE3 00          	nop
1466   4CE4 32 00 7B    	ld	(PORTSPI), a
1467   4CE7 79          	ld	a, c
1468   4CE8 00          	nop
1469   4CE9 32 00 7B    	ld	(PORTSPI), a
1470   4CEC 7A          	ld	a, d
1471   4CED 00          	nop
1472   4CEE 32 00 7B    	ld	(PORTSPI), a
1473   4CF1 7B          	ld	a, e
1474   4CF2 00          	nop
1475   4CF3 32 00 7B    	ld	(PORTSPI), a
1476   4CF6 F1          	pop	af
1477   4CF7 FE 40       	cp	CMD0
1478   4CF9 06 95       	ld	b, $95		; CRC para CMD0
1479   4CFB 28 08       	jr	z,enviaCRC
1480   4CFD FE 48       	cp	CMD8
1481   4CFF 06 87       	ld	b, $87		; CRC para CMD8
1482   4D01 28 02       	jr	z,enviaCRC
1483   4D03 06 FF       	ld	b, $FF		; CRC dummy
1484   4D05             enviaCRC: 
1485   4D05 78          	ld	a, b
1486   4D06 32 00 7B    	ld	(PORTSPI), a
1487   4D09 18 0E       	jr	WAIT_RESP_NO_FF
1488   4D0B             
1489   4D0B             ; ------------------------------------------------
1490   4D0B             ; Esperar que resposta do cartao seja $FE
1491   4D0B             ; Destroi AF, B
1492   4D0B             ; ------------------------------------------------
1493   4D0B             WAIT_RESP_FE: 
1494   4D0B 06 0A       	ld	b, 10		; 10 tentativas
1495   4D0D             .loop: 
1496   4D0D C5          	push	bc
1497   4D0E CD 19 4D    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1498   4D11 C1          	pop	bc
1499   4D12 FE FE       	cp	$FE		; resposta é $FE ?
1500   4D14 C8          	ret	z		; sim, retornamos com carry=0
1501   4D15 10 F6       	djnz	.loop
1502   4D17 37          	scf			; erro, carry=1
1503   4D18 C9          	ret
1504   4D19             
1505   4D19             ; ------------------------------------------------
1506   4D19             ; Esperar que resposta do cartao seja diferente
1507   4D19             ; de $FF
1508   4D19             ; Destroi AF, BC
1509   4D19             ; ------------------------------------------------
1510   4D19             WAIT_RESP_NO_FF: 
1511   4D19 01 01 00    	ld	bc, 1		; 256 tentativas
1512   4D1C             .loop: 
1513   4D1C 3A 00 7B    	ld	a, (PORTSPI)
1514   4D1F FE FF       	cp	$FF		; testa $FF
1515   4D21 C0          	ret		nz		; sai se nao for $FF
1516   4D22 10 F8       	djnz	.loop
1517   4D24 0D          	dec	c
1518   4D25 20 F5       	jr	nz,.loop
1519   4D27 C9          	ret
1520   4D28             
1521   4D28             ; ------------------------------------------------
1522   4D28             ; Esperar que resposta do cartao seja diferente
1523   4D28             ; de $00
1524   4D28             ; Destroi A, BC
1525   4D28             ; ------------------------------------------------
1526   4D28             WAIT_RESP_NO_00: 
1527   4D28 01 80 00    	ld	bc, 128		; 32768 tentativas
1528   4D2B             .loop: 
1529   4D2B 3A 00 7B    	ld	a, (PORTSPI)
1530   4D2E B7          	or	a
1531   4D2F C0          	ret	nz			; se resposta for <> $00, sai
1532   4D30 10 F9       	djnz	.loop
1533   4D32 0D          	dec	c
1534   4D33 20 F6       	jr	nz,.loop
1535   4D35 37          	scf			; erro
1536   4D36 C9          	ret
1537   4D37             
1538   4D37             ; ------------------------------------------------
1539   4D37             ; Ativa (seleciona) cartao atual baixando seu /CS
1540   4D37             ; Nao destroi registradores
1541   4D37             ; ------------------------------------------------
1542   4D37             setaSDAtual: 
1543   4D37 F5          	push	af
1544   4D38 3A 00 7B    	ld	a, (PORTSPI)	; dummy read
1545   4D3B FD 7E 30    	ld	a, (iy+NUMSD)
1546   4D3E 2F          	cpl			; inverte bits
1547   4D3F 32 00 7F    	ld	(PORTCFG), a
1548   4D42 F1          	pop	af
1549   4D43 C9          	ret
1550   4D44             
1551   4D44             
1552   4D44             ; ------------------------------------------------
1553   4D44             ; Grava um bloco de 512 bytes no cartao
1554   4D44             ; HL aponta para o inicio dos dados
1555   4D44             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1556   4D44             ; Destroi AF, BC, DE, HL
1557   4D44             ; ------------------------------------------------
1558   4D44             GravarBloco: 
1559   4D44 DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1560   4D47 B7          	or	a
1561   4D48 CC 4B 5E    	call	z,blocoParaByte		; se for SDV1 coverter blocos para bytes
1562   4D4B CD 37 4D    	call	setaSDAtual	; selecionar cartao atual
1563   4D4E FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer gravar 1 ou mais blocos
1564   4D51 3D          	dec	a
1565   4D52 CA B9 51    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1566   4D55             
1567   4D55             ; multiplos blocos
1568   4D55 C5          	push	bc
1569   4D56 D5          	push	de
1570   4D57 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1571   4D59 CD A8 4C    	call	SD_SEND_CMD_NO_ARGS
1572   4D5C 3E 57       	ld	a, ACMD23
1573   4D5E 01 00 00    	ld	bc, 0
1574   4D61 51          	ld	d, c
1575   4D62 FD 5E 32    	ld	e, (iy+NUMBLOCOS)	; parametro = total de blocos a gravar
1576   4D65 CD AD 4C    	call	SD_SEND_CMD_GET_ERROR
1577   4D68 D1          	pop	de
1578   4D69 C1          	pop	bc
1579   4D6A DA C0 51    	jp	c,.erro		; erro no ACMD23
1580   4D6D 3E 59       	ld	a, CMD25	; comando CMD25 = write multiple blocks
1581   4D6F CD AD 4C    	call	SD_SEND_CMD_GET_ERROR
1582   4D72 DA C0 51    	jp	c,.erro		; erro
1583   4D75             .loop: 
1584   4D75 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados sao
1585   4D77 32 00 7B    	ld	(PORTSPI),a	; dados para gravacao
1586   4D7A 11 00 7B    	ld	de, PORTSPI
1587   4D7D ED A0       > ldi		
1587   4D7F ED A0       > ldi		
1587   4D81 ED A0       > ldi		
1587   4D83 ED A0       > ldi		
1587   4D85 ED A0       > ldi		
1587   4D87 ED A0       > ldi		
1587   4D89 ED A0       > ldi		
1587   4D8B ED A0       > ldi		
1587   4D8D ED A0       > ldi		
1587   4D8F ED A0       > ldi		
1587   4D91 ED A0       > ldi		
1587   4D93 ED A0       > ldi		
1587   4D95 ED A0       > ldi		
1587   4D97 ED A0       > ldi		
1587   4D99 ED A0       > ldi		
1587   4D9B ED A0       > ldi		
1587   4D9D ED A0       > ldi		
1587   4D9F ED A0       > ldi		
1587   4DA1 ED A0       > ldi		
1587   4DA3 ED A0       > ldi		
1587   4DA5 ED A0       > ldi		
1587   4DA7 ED A0       > ldi		
1587   4DA9 ED A0       > ldi		
1587   4DAB ED A0       > ldi		
1587   4DAD ED A0       > ldi		
1587   4DAF ED A0       > ldi		
1587   4DB1 ED A0       > ldi		
1587   4DB3 ED A0       > ldi		
1587   4DB5 ED A0       > ldi		
1587   4DB7 ED A0       > ldi		
1587   4DB9 ED A0       > ldi		
1587   4DBB ED A0       > ldi		
1587   4DBD ED A0       > ldi		
1587   4DBF ED A0       > ldi		
1587   4DC1 ED A0       > ldi		
1587   4DC3 ED A0       > ldi		
1587   4DC5 ED A0       > ldi		
1587   4DC7 ED A0       > ldi		
1587   4DC9 ED A0       > ldi		
1587   4DCB ED A0       > ldi		
1587   4DCD ED A0       > ldi		
1587   4DCF ED A0       > ldi		
1587   4DD1 ED A0       > ldi		
1587   4DD3 ED A0       > ldi		
1587   4DD5 ED A0       > ldi		
1587   4DD7 ED A0       > ldi		
1587   4DD9 ED A0       > ldi		
1587   4DDB ED A0       > ldi		
1587   4DDD ED A0       > ldi		
1587   4DDF ED A0       > ldi		
1587   4DE1 ED A0       > ldi		
1587   4DE3 ED A0       > ldi		
1587   4DE5 ED A0       > ldi		
1587   4DE7 ED A0       > ldi		
1587   4DE9 ED A0       > ldi		
1587   4DEB ED A0       > ldi		
1587   4DED ED A0       > ldi		
1587   4DEF ED A0       > ldi		
1587   4DF1 ED A0       > ldi		
1587   4DF3 ED A0       > ldi		
1587   4DF5 ED A0       > ldi		
1587   4DF7 ED A0       > ldi		
1587   4DF9 ED A0       > ldi		
1587   4DFB ED A0       > ldi		
1587   4DFD ED A0       > ldi		
1587   4DFF ED A0       > ldi		
1587   4E01 ED A0       > ldi		
1587   4E03 ED A0       > ldi		
1587   4E05 ED A0       > ldi		
1587   4E07 ED A0       > ldi		
1587   4E09 ED A0       > ldi		
1587   4E0B ED A0       > ldi		
1587   4E0D ED A0       > ldi		
1587   4E0F ED A0       > ldi		
1587   4E11 ED A0       > ldi		
1587   4E13 ED A0       > ldi		
1587   4E15 ED A0       > ldi		
1587   4E17 ED A0       > ldi		
1587   4E19 ED A0       > ldi		
1587   4E1B ED A0       > ldi		
1587   4E1D ED A0       > ldi		
1587   4E1F ED A0       > ldi		
1587   4E21 ED A0       > ldi		
1587   4E23 ED A0       > ldi		
1587   4E25 ED A0       > ldi		
1587   4E27 ED A0       > ldi		
1587   4E29 ED A0       > ldi		
1587   4E2B ED A0       > ldi		
1587   4E2D ED A0       > ldi		
1587   4E2F ED A0       > ldi		
1587   4E31 ED A0       > ldi		
1587   4E33 ED A0       > ldi		
1587   4E35 ED A0       > ldi		
1587   4E37 ED A0       > ldi		
1587   4E39 ED A0       > ldi		
1587   4E3B ED A0       > ldi		
1587   4E3D ED A0       > ldi		
1587   4E3F ED A0       > ldi		
1587   4E41 ED A0       > ldi		
1587   4E43 ED A0       > ldi		
1587   4E45 ED A0       > ldi		
1587   4E47 ED A0       > ldi		
1587   4E49 ED A0       > ldi		
1587   4E4B ED A0       > ldi		
1587   4E4D ED A0       > ldi		
1587   4E4F ED A0       > ldi		
1587   4E51 ED A0       > ldi		
1587   4E53 ED A0       > ldi		
1587   4E55 ED A0       > ldi		
1587   4E57 ED A0       > ldi		
1587   4E59 ED A0       > ldi		
1587   4E5B ED A0       > ldi		
1587   4E5D ED A0       > ldi		
1587   4E5F ED A0       > ldi		
1587   4E61 ED A0       > ldi		
1587   4E63 ED A0       > ldi		
1587   4E65 ED A0       > ldi		
1587   4E67 ED A0       > ldi		
1587   4E69 ED A0       > ldi		
1587   4E6B ED A0       > ldi		
1587   4E6D ED A0       > ldi		
1587   4E6F ED A0       > ldi		
1587   4E71 ED A0       > ldi		
1587   4E73 ED A0       > ldi		
1587   4E75 ED A0       > ldi		
1587   4E77 ED A0       > ldi		
1587   4E79 ED A0       > ldi		
1587   4E7B ED A0       > ldi		
1587   4E7D ED A0       > ldi		
1587   4E7F ED A0       > ldi		
1587   4E81 ED A0       > ldi		
1587   4E83 ED A0       > ldi		
1587   4E85 ED A0       > ldi		
1587   4E87 ED A0       > ldi		
1587   4E89 ED A0       > ldi		
1587   4E8B ED A0       > ldi		
1587   4E8D ED A0       > ldi		
1587   4E8F ED A0       > ldi		
1587   4E91 ED A0       > ldi		
1587   4E93 ED A0       > ldi		
1587   4E95 ED A0       > ldi		
1587   4E97 ED A0       > ldi		
1587   4E99 ED A0       > ldi		
1587   4E9B ED A0       > ldi		
1587   4E9D ED A0       > ldi		
1587   4E9F ED A0       > ldi		
1587   4EA1 ED A0       > ldi		
1587   4EA3 ED A0       > ldi		
1587   4EA5 ED A0       > ldi		
1587   4EA7 ED A0       > ldi		
1587   4EA9 ED A0       > ldi		
1587   4EAB ED A0       > ldi		
1587   4EAD ED A0       > ldi		
1587   4EAF ED A0       > ldi		
1587   4EB1 ED A0       > ldi		
1587   4EB3 ED A0       > ldi		
1587   4EB5 ED A0       > ldi		
1587   4EB7 ED A0       > ldi		
1587   4EB9 ED A0       > ldi		
1587   4EBB ED A0       > ldi		
1587   4EBD ED A0       > ldi		
1587   4EBF ED A0       > ldi		
1587   4EC1 ED A0       > ldi		
1587   4EC3 ED A0       > ldi		
1587   4EC5 ED A0       > ldi		
1587   4EC7 ED A0       > ldi		
1587   4EC9 ED A0       > ldi		
1587   4ECB ED A0       > ldi		
1587   4ECD ED A0       > ldi		
1587   4ECF ED A0       > ldi		
1587   4ED1 ED A0       > ldi		
1587   4ED3 ED A0       > ldi		
1587   4ED5 ED A0       > ldi		
1587   4ED7 ED A0       > ldi		
1587   4ED9 ED A0       > ldi		
1587   4EDB ED A0       > ldi		
1587   4EDD ED A0       > ldi		
1587   4EDF ED A0       > ldi		
1587   4EE1 ED A0       > ldi		
1587   4EE3 ED A0       > ldi		
1587   4EE5 ED A0       > ldi		
1587   4EE7 ED A0       > ldi		
1587   4EE9 ED A0       > ldi		
1587   4EEB ED A0       > ldi		
1587   4EED ED A0       > ldi		
1587   4EEF ED A0       > ldi		
1587   4EF1 ED A0       > ldi		
1587   4EF3 ED A0       > ldi		
1587   4EF5 ED A0       > ldi		
1587   4EF7 ED A0       > ldi		
1587   4EF9 ED A0       > ldi		
1587   4EFB ED A0       > ldi		
1587   4EFD ED A0       > ldi		
1587   4EFF ED A0       > ldi		
1587   4F01 ED A0       > ldi		
1587   4F03 ED A0       > ldi		
1587   4F05 ED A0       > ldi		
1587   4F07 ED A0       > ldi		
1587   4F09 ED A0       > ldi		
1587   4F0B ED A0       > ldi		
1587   4F0D ED A0       > ldi		
1587   4F0F ED A0       > ldi		
1587   4F11 ED A0       > ldi		
1587   4F13 ED A0       > ldi		
1587   4F15 ED A0       > ldi		
1587   4F17 ED A0       > ldi		
1587   4F19 ED A0       > ldi		
1587   4F1B ED A0       > ldi		
1587   4F1D ED A0       > ldi		
1587   4F1F ED A0       > ldi		
1587   4F21 ED A0       > ldi		
1587   4F23 ED A0       > ldi		
1587   4F25 ED A0       > ldi		
1587   4F27 ED A0       > ldi		
1587   4F29 ED A0       > ldi		
1587   4F2B ED A0       > ldi		
1587   4F2D ED A0       > ldi		
1587   4F2F ED A0       > ldi		
1587   4F31 ED A0       > ldi		
1587   4F33 ED A0       > ldi		
1587   4F35 ED A0       > ldi		
1587   4F37 ED A0       > ldi		
1587   4F39 ED A0       > ldi		
1587   4F3B ED A0       > ldi		
1587   4F3D ED A0       > ldi		
1587   4F3F ED A0       > ldi		
1587   4F41 ED A0       > ldi		
1587   4F43 ED A0       > ldi		
1587   4F45 ED A0       > ldi		
1587   4F47 ED A0       > ldi		
1587   4F49 ED A0       > ldi		
1587   4F4B ED A0       > ldi		
1587   4F4D ED A0       > ldi		
1587   4F4F ED A0       > ldi		
1587   4F51 ED A0       > ldi		
1587   4F53 ED A0       > ldi		
1587   4F55 ED A0       > ldi		
1587   4F57 ED A0       > ldi		
1587   4F59 ED A0       > ldi		
1587   4F5B ED A0       > ldi		
1587   4F5D ED A0       > ldi		
1587   4F5F ED A0       > ldi		
1587   4F61 ED A0       > ldi		
1587   4F63 ED A0       > ldi		
1587   4F65 ED A0       > ldi		
1587   4F67 ED A0       > ldi		
1587   4F69 ED A0       > ldi		
1587   4F6B ED A0       > ldi		
1587   4F6D ED A0       > ldi		
1587   4F6F ED A0       > ldi		
1587   4F71 ED A0       > ldi		
1587   4F73 ED A0       > ldi		
1587   4F75 ED A0       > ldi		
1587   4F77 ED A0       > ldi		
1587   4F79 ED A0       > ldi		
1587   4F7B ED A0       > ldi		
1587   4F7D ED A0       > ldi		
1587   4F7F ED A0       > ldi		
1587   4F81 ED A0       > ldi		
1587   4F83 ED A0       > ldi		
1587   4F85 ED A0       > ldi		
1587   4F87 ED A0       > ldi		
1587   4F89 ED A0       > ldi		
1587   4F8B ED A0       > ldi		
1587   4F8D ED A0       > ldi		
1587   4F8F ED A0       > ldi		
1587   4F91 ED A0       > ldi		
1587   4F93 ED A0       > ldi		
1587   4F95 ED A0       > ldi		
1587   4F97 ED A0       > ldi		
1587   4F99 ED A0       > ldi		
1587   4F9B ED A0       > ldi		
1587   4F9D ED A0       > ldi		
1587   4F9F ED A0       > ldi		
1587   4FA1 ED A0       > ldi		
1587   4FA3 ED A0       > ldi		
1587   4FA5 ED A0       > ldi		
1587   4FA7 ED A0       > ldi		
1587   4FA9 ED A0       > ldi		
1587   4FAB ED A0       > ldi		
1587   4FAD ED A0       > ldi		
1587   4FAF ED A0       > ldi		
1587   4FB1 ED A0       > ldi		
1587   4FB3 ED A0       > ldi		
1587   4FB5 ED A0       > ldi		
1587   4FB7 ED A0       > ldi		
1587   4FB9 ED A0       > ldi		
1587   4FBB ED A0       > ldi		
1587   4FBD ED A0       > ldi		
1587   4FBF ED A0       > ldi		
1587   4FC1 ED A0       > ldi		
1587   4FC3 ED A0       > ldi		
1587   4FC5 ED A0       > ldi		
1587   4FC7 ED A0       > ldi		
1587   4FC9 ED A0       > ldi		
1587   4FCB ED A0       > ldi		
1587   4FCD ED A0       > ldi		
1587   4FCF ED A0       > ldi		
1587   4FD1 ED A0       > ldi		
1587   4FD3 ED A0       > ldi		
1587   4FD5 ED A0       > ldi		
1587   4FD7 ED A0       > ldi		
1587   4FD9 ED A0       > ldi		
1587   4FDB ED A0       > ldi		
1587   4FDD ED A0       > ldi		
1587   4FDF ED A0       > ldi		
1587   4FE1 ED A0       > ldi		
1587   4FE3 ED A0       > ldi		
1587   4FE5 ED A0       > ldi		
1587   4FE7 ED A0       > ldi		
1587   4FE9 ED A0       > ldi		
1587   4FEB ED A0       > ldi		
1587   4FED ED A0       > ldi		
1587   4FEF ED A0       > ldi		
1587   4FF1 ED A0       > ldi		
1587   4FF3 ED A0       > ldi		
1587   4FF5 ED A0       > ldi		
1587   4FF7 ED A0       > ldi		
1587   4FF9 ED A0       > ldi		
1587   4FFB ED A0       > ldi		
1587   4FFD ED A0       > ldi		
1587   4FFF ED A0       > ldi		
1587   5001 ED A0       > ldi		
1587   5003 ED A0       > ldi		
1587   5005 ED A0       > ldi		
1587   5007 ED A0       > ldi		
1587   5009 ED A0       > ldi		
1587   500B ED A0       > ldi		
1587   500D ED A0       > ldi		
1587   500F ED A0       > ldi		
1587   5011 ED A0       > ldi		
1587   5013 ED A0       > ldi		
1587   5015 ED A0       > ldi		
1587   5017 ED A0       > ldi		
1587   5019 ED A0       > ldi		
1587   501B ED A0       > ldi		
1587   501D ED A0       > ldi		
1587   501F ED A0       > ldi		
1587   5021 ED A0       > ldi		
1587   5023 ED A0       > ldi		
1587   5025 ED A0       > ldi		
1587   5027 ED A0       > ldi		
1587   5029 ED A0       > ldi		
1587   502B ED A0       > ldi		
1587   502D ED A0       > ldi		
1587   502F ED A0       > ldi		
1587   5031 ED A0       > ldi		
1587   5033 ED A0       > ldi		
1587   5035 ED A0       > ldi		
1587   5037 ED A0       > ldi		
1587   5039 ED A0       > ldi		
1587   503B ED A0       > ldi		
1587   503D ED A0       > ldi		
1587   503F ED A0       > ldi		
1587   5041 ED A0       > ldi		
1587   5043 ED A0       > ldi		
1587   5045 ED A0       > ldi		
1587   5047 ED A0       > ldi		
1587   5049 ED A0       > ldi		
1587   504B ED A0       > ldi		
1587   504D ED A0       > ldi		
1587   504F ED A0       > ldi		
1587   5051 ED A0       > ldi		
1587   5053 ED A0       > ldi		
1587   5055 ED A0       > ldi		
1587   5057 ED A0       > ldi		
1587   5059 ED A0       > ldi		
1587   505B ED A0       > ldi		
1587   505D ED A0       > ldi		
1587   505F ED A0       > ldi		
1587   5061 ED A0       > ldi		
1587   5063 ED A0       > ldi		
1587   5065 ED A0       > ldi		
1587   5067 ED A0       > ldi		
1587   5069 ED A0       > ldi		
1587   506B ED A0       > ldi		
1587   506D ED A0       > ldi		
1587   506F ED A0       > ldi		
1587   5071 ED A0       > ldi		
1587   5073 ED A0       > ldi		
1587   5075 ED A0       > ldi		
1587   5077 ED A0       > ldi		
1587   5079 ED A0       > ldi		
1587   507B ED A0       > ldi		
1587   507D ED A0       > ldi		
1587   507F ED A0       > ldi		
1587   5081 ED A0       > ldi		
1587   5083 ED A0       > ldi		
1587   5085 ED A0       > ldi		
1587   5087 ED A0       > ldi		
1587   5089 ED A0       > ldi		
1587   508B ED A0       > ldi		
1587   508D ED A0       > ldi		
1587   508F ED A0       > ldi		
1587   5091 ED A0       > ldi		
1587   5093 ED A0       > ldi		
1587   5095 ED A0       > ldi		
1587   5097 ED A0       > ldi		
1587   5099 ED A0       > ldi		
1587   509B ED A0       > ldi		
1587   509D ED A0       > ldi		
1587   509F ED A0       > ldi		
1587   50A1 ED A0       > ldi		
1587   50A3 ED A0       > ldi		
1587   50A5 ED A0       > ldi		
1587   50A7 ED A0       > ldi		
1587   50A9 ED A0       > ldi		
1587   50AB ED A0       > ldi		
1587   50AD ED A0       > ldi		
1587   50AF ED A0       > ldi		
1587   50B1 ED A0       > ldi		
1587   50B3 ED A0       > ldi		
1587   50B5 ED A0       > ldi		
1587   50B7 ED A0       > ldi		
1587   50B9 ED A0       > ldi		
1587   50BB ED A0       > ldi		
1587   50BD ED A0       > ldi		
1587   50BF ED A0       > ldi		
1587   50C1 ED A0       > ldi		
1587   50C3 ED A0       > ldi		
1587   50C5 ED A0       > ldi		
1587   50C7 ED A0       > ldi		
1587   50C9 ED A0       > ldi		
1587   50CB ED A0       > ldi		
1587   50CD ED A0       > ldi		
1587   50CF ED A0       > ldi		
1587   50D1 ED A0       > ldi		
1587   50D3 ED A0       > ldi		
1587   50D5 ED A0       > ldi		
1587   50D7 ED A0       > ldi		
1587   50D9 ED A0       > ldi		
1587   50DB ED A0       > ldi		
1587   50DD ED A0       > ldi		
1587   50DF ED A0       > ldi		
1587   50E1 ED A0       > ldi		
1587   50E3 ED A0       > ldi		
1587   50E5 ED A0       > ldi		
1587   50E7 ED A0       > ldi		
1587   50E9 ED A0       > ldi		
1587   50EB ED A0       > ldi		
1587   50ED ED A0       > ldi		
1587   50EF ED A0       > ldi		
1587   50F1 ED A0       > ldi		
1587   50F3 ED A0       > ldi		
1587   50F5 ED A0       > ldi		
1587   50F7 ED A0       > ldi		
1587   50F9 ED A0       > ldi		
1587   50FB ED A0       > ldi		
1587   50FD ED A0       > ldi		
1587   50FF ED A0       > ldi		
1587   5101 ED A0       > ldi		
1587   5103 ED A0       > ldi		
1587   5105 ED A0       > ldi		
1587   5107 ED A0       > ldi		
1587   5109 ED A0       > ldi		
1587   510B ED A0       > ldi		
1587   510D ED A0       > ldi		
1587   510F ED A0       > ldi		
1587   5111 ED A0       > ldi		
1587   5113 ED A0       > ldi		
1587   5115 ED A0       > ldi		
1587   5117 ED A0       > ldi		
1587   5119 ED A0       > ldi		
1587   511B ED A0       > ldi		
1587   511D ED A0       > ldi		
1587   511F ED A0       > ldi		
1587   5121 ED A0       > ldi		
1587   5123 ED A0       > ldi		
1587   5125 ED A0       > ldi		
1587   5127 ED A0       > ldi		
1587   5129 ED A0       > ldi		
1587   512B ED A0       > ldi		
1587   512D ED A0       > ldi		
1587   512F ED A0       > ldi		
1587   5131 ED A0       > ldi		
1587   5133 ED A0       > ldi		
1587   5135 ED A0       > ldi		
1587   5137 ED A0       > ldi		
1587   5139 ED A0       > ldi		
1587   513B ED A0       > ldi		
1587   513D ED A0       > ldi		
1587   513F ED A0       > ldi		
1587   5141 ED A0       > ldi		
1587   5143 ED A0       > ldi		
1587   5145 ED A0       > ldi		
1587   5147 ED A0       > ldi		
1587   5149 ED A0       > ldi		
1587   514B ED A0       > ldi		
1587   514D ED A0       > ldi		
1587   514F ED A0       > ldi		
1587   5151 ED A0       > ldi		
1587   5153 ED A0       > ldi		
1587   5155 ED A0       > ldi		
1587   5157 ED A0       > ldi		
1587   5159 ED A0       > ldi		
1587   515B ED A0       > ldi		
1587   515D ED A0       > ldi		
1587   515F ED A0       > ldi		
1587   5161 ED A0       > ldi		
1587   5163 ED A0       > ldi		
1587   5165 ED A0       > ldi		
1587   5167 ED A0       > ldi		
1587   5169 ED A0       > ldi		
1587   516B ED A0       > ldi		
1587   516D ED A0       > ldi		
1587   516F ED A0       > ldi		
1587   5171 ED A0       > ldi		
1587   5173 ED A0       > ldi		
1587   5175 ED A0       > ldi		
1587   5177 ED A0       > ldi		
1587   5179 ED A0       > ldi		
1587   517B ED A0       > ldi		
1588   517D 3E FF       	ld	a, $FF		; envia dummy CRC
1589   517F 32 00 7B    	ld	(PORTSPI),a
1590   5182 00          	nop
1591   5183 32 00 7B    	ld	(PORTSPI),a
1592   5186 CD 19 4D    	call	WAIT_RESP_NO_FF	; esperar cartao
1593   5189 E6 1F       	and	$1F		; testa bits erro
1594   518B FE 05       	cp	5
1595   518D 20 31       	jr	nz,.erro	; resposta errada, informar erro
1596   518F CD 28 4D    	call	WAIT_RESP_NO_00	; esperar cartao
1597   5192 38 2C       	jr	c,.erro
1598   5194 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para gravar
1599   5197 3D          	dec	a
1600   5198 FD 77 32    	ld	(iy+NUMBLOCOS), a
1601   519B C2 75 4D    	jp	nz,.loop
1602   519E 3A 00 7B    	ld	a, (PORTSPI)	; acabou os blocos, fazer 2 dummy reads
1603   51A1 00          	nop
1604   51A2 3A 00 7B    	ld	a, (PORTSPI)
1605   51A5 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1606   51A7 32 00 7B    	ld	(PORTSPI),a
1607   51AA 00          	nop
1608   51AB 00          	nop
1609   51AC 3A 00 7B    	ld	a, (PORTSPI)	; dummy reads
1610   51AF 00          	nop
1611   51B0 3A 00 7B    	ld	a, (PORTSPI)
1612   51B3 CD 28 4D    	call	WAIT_RESP_NO_00	; esperar cartao
1613   51B6 C3 E5 55    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1614   51B9             
1615   51B9             .umBloco: 
1616   51B9 3E 58       	ld	a, CMD24	; gravar somente um bloco com comando CMD24 = Write Single Block
1617   51BB CD AD 4C    	call	SD_SEND_CMD_GET_ERROR
1618   51BE 30 04       	jr	nc,.ok
1619   51C0             .erro: 
1620   51C0 37          	scf			; informar erro
1621   51C1 C3 E6 55    	jp	terminaLeituraEscritaBloco
1622   51C4             .ok: 
1623   51C4 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1624   51C6 32 00 7B    	ld	(PORTSPI),a
1625   51C9 11 00 7B    	ld	de, PORTSPI
1626   51CC ED A0       > ldi
1626   51CE ED A0       > ldi
1626   51D0 ED A0       > ldi
1626   51D2 ED A0       > ldi
1626   51D4 ED A0       > ldi
1626   51D6 ED A0       > ldi
1626   51D8 ED A0       > ldi
1626   51DA ED A0       > ldi
1626   51DC ED A0       > ldi
1626   51DE ED A0       > ldi
1626   51E0 ED A0       > ldi
1626   51E2 ED A0       > ldi
1626   51E4 ED A0       > ldi
1626   51E6 ED A0       > ldi
1626   51E8 ED A0       > ldi
1626   51EA ED A0       > ldi
1626   51EC ED A0       > ldi
1626   51EE ED A0       > ldi
1626   51F0 ED A0       > ldi
1626   51F2 ED A0       > ldi
1626   51F4 ED A0       > ldi
1626   51F6 ED A0       > ldi
1626   51F8 ED A0       > ldi
1626   51FA ED A0       > ldi
1626   51FC ED A0       > ldi
1626   51FE ED A0       > ldi
1626   5200 ED A0       > ldi
1626   5202 ED A0       > ldi
1626   5204 ED A0       > ldi
1626   5206 ED A0       > ldi
1626   5208 ED A0       > ldi
1626   520A ED A0       > ldi
1626   520C ED A0       > ldi
1626   520E ED A0       > ldi
1626   5210 ED A0       > ldi
1626   5212 ED A0       > ldi
1626   5214 ED A0       > ldi
1626   5216 ED A0       > ldi
1626   5218 ED A0       > ldi
1626   521A ED A0       > ldi
1626   521C ED A0       > ldi
1626   521E ED A0       > ldi
1626   5220 ED A0       > ldi
1626   5222 ED A0       > ldi
1626   5224 ED A0       > ldi
1626   5226 ED A0       > ldi
1626   5228 ED A0       > ldi
1626   522A ED A0       > ldi
1626   522C ED A0       > ldi
1626   522E ED A0       > ldi
1626   5230 ED A0       > ldi
1626   5232 ED A0       > ldi
1626   5234 ED A0       > ldi
1626   5236 ED A0       > ldi
1626   5238 ED A0       > ldi
1626   523A ED A0       > ldi
1626   523C ED A0       > ldi
1626   523E ED A0       > ldi
1626   5240 ED A0       > ldi
1626   5242 ED A0       > ldi
1626   5244 ED A0       > ldi
1626   5246 ED A0       > ldi
1626   5248 ED A0       > ldi
1626   524A ED A0       > ldi
1626   524C ED A0       > ldi
1626   524E ED A0       > ldi
1626   5250 ED A0       > ldi
1626   5252 ED A0       > ldi
1626   5254 ED A0       > ldi
1626   5256 ED A0       > ldi
1626   5258 ED A0       > ldi
1626   525A ED A0       > ldi
1626   525C ED A0       > ldi
1626   525E ED A0       > ldi
1626   5260 ED A0       > ldi
1626   5262 ED A0       > ldi
1626   5264 ED A0       > ldi
1626   5266 ED A0       > ldi
1626   5268 ED A0       > ldi
1626   526A ED A0       > ldi
1626   526C ED A0       > ldi
1626   526E ED A0       > ldi
1626   5270 ED A0       > ldi
1626   5272 ED A0       > ldi
1626   5274 ED A0       > ldi
1626   5276 ED A0       > ldi
1626   5278 ED A0       > ldi
1626   527A ED A0       > ldi
1626   527C ED A0       > ldi
1626   527E ED A0       > ldi
1626   5280 ED A0       > ldi
1626   5282 ED A0       > ldi
1626   5284 ED A0       > ldi
1626   5286 ED A0       > ldi
1626   5288 ED A0       > ldi
1626   528A ED A0       > ldi
1626   528C ED A0       > ldi
1626   528E ED A0       > ldi
1626   5290 ED A0       > ldi
1626   5292 ED A0       > ldi
1626   5294 ED A0       > ldi
1626   5296 ED A0       > ldi
1626   5298 ED A0       > ldi
1626   529A ED A0       > ldi
1626   529C ED A0       > ldi
1626   529E ED A0       > ldi
1626   52A0 ED A0       > ldi
1626   52A2 ED A0       > ldi
1626   52A4 ED A0       > ldi
1626   52A6 ED A0       > ldi
1626   52A8 ED A0       > ldi
1626   52AA ED A0       > ldi
1626   52AC ED A0       > ldi
1626   52AE ED A0       > ldi
1626   52B0 ED A0       > ldi
1626   52B2 ED A0       > ldi
1626   52B4 ED A0       > ldi
1626   52B6 ED A0       > ldi
1626   52B8 ED A0       > ldi
1626   52BA ED A0       > ldi
1626   52BC ED A0       > ldi
1626   52BE ED A0       > ldi
1626   52C0 ED A0       > ldi
1626   52C2 ED A0       > ldi
1626   52C4 ED A0       > ldi
1626   52C6 ED A0       > ldi
1626   52C8 ED A0       > ldi
1626   52CA ED A0       > ldi
1626   52CC ED A0       > ldi
1626   52CE ED A0       > ldi
1626   52D0 ED A0       > ldi
1626   52D2 ED A0       > ldi
1626   52D4 ED A0       > ldi
1626   52D6 ED A0       > ldi
1626   52D8 ED A0       > ldi
1626   52DA ED A0       > ldi
1626   52DC ED A0       > ldi
1626   52DE ED A0       > ldi
1626   52E0 ED A0       > ldi
1626   52E2 ED A0       > ldi
1626   52E4 ED A0       > ldi
1626   52E6 ED A0       > ldi
1626   52E8 ED A0       > ldi
1626   52EA ED A0       > ldi
1626   52EC ED A0       > ldi
1626   52EE ED A0       > ldi
1626   52F0 ED A0       > ldi
1626   52F2 ED A0       > ldi
1626   52F4 ED A0       > ldi
1626   52F6 ED A0       > ldi
1626   52F8 ED A0       > ldi
1626   52FA ED A0       > ldi
1626   52FC ED A0       > ldi
1626   52FE ED A0       > ldi
1626   5300 ED A0       > ldi
1626   5302 ED A0       > ldi
1626   5304 ED A0       > ldi
1626   5306 ED A0       > ldi
1626   5308 ED A0       > ldi
1626   530A ED A0       > ldi
1626   530C ED A0       > ldi
1626   530E ED A0       > ldi
1626   5310 ED A0       > ldi
1626   5312 ED A0       > ldi
1626   5314 ED A0       > ldi
1626   5316 ED A0       > ldi
1626   5318 ED A0       > ldi
1626   531A ED A0       > ldi
1626   531C ED A0       > ldi
1626   531E ED A0       > ldi
1626   5320 ED A0       > ldi
1626   5322 ED A0       > ldi
1626   5324 ED A0       > ldi
1626   5326 ED A0       > ldi
1626   5328 ED A0       > ldi
1626   532A ED A0       > ldi
1626   532C ED A0       > ldi
1626   532E ED A0       > ldi
1626   5330 ED A0       > ldi
1626   5332 ED A0       > ldi
1626   5334 ED A0       > ldi
1626   5336 ED A0       > ldi
1626   5338 ED A0       > ldi
1626   533A ED A0       > ldi
1626   533C ED A0       > ldi
1626   533E ED A0       > ldi
1626   5340 ED A0       > ldi
1626   5342 ED A0       > ldi
1626   5344 ED A0       > ldi
1626   5346 ED A0       > ldi
1626   5348 ED A0       > ldi
1626   534A ED A0       > ldi
1626   534C ED A0       > ldi
1626   534E ED A0       > ldi
1626   5350 ED A0       > ldi
1626   5352 ED A0       > ldi
1626   5354 ED A0       > ldi
1626   5356 ED A0       > ldi
1626   5358 ED A0       > ldi
1626   535A ED A0       > ldi
1626   535C ED A0       > ldi
1626   535E ED A0       > ldi
1626   5360 ED A0       > ldi
1626   5362 ED A0       > ldi
1626   5364 ED A0       > ldi
1626   5366 ED A0       > ldi
1626   5368 ED A0       > ldi
1626   536A ED A0       > ldi
1626   536C ED A0       > ldi
1626   536E ED A0       > ldi
1626   5370 ED A0       > ldi
1626   5372 ED A0       > ldi
1626   5374 ED A0       > ldi
1626   5376 ED A0       > ldi
1626   5378 ED A0       > ldi
1626   537A ED A0       > ldi
1626   537C ED A0       > ldi
1626   537E ED A0       > ldi
1626   5380 ED A0       > ldi
1626   5382 ED A0       > ldi
1626   5384 ED A0       > ldi
1626   5386 ED A0       > ldi
1626   5388 ED A0       > ldi
1626   538A ED A0       > ldi
1626   538C ED A0       > ldi
1626   538E ED A0       > ldi
1626   5390 ED A0       > ldi
1626   5392 ED A0       > ldi
1626   5394 ED A0       > ldi
1626   5396 ED A0       > ldi
1626   5398 ED A0       > ldi
1626   539A ED A0       > ldi
1626   539C ED A0       > ldi
1626   539E ED A0       > ldi
1626   53A0 ED A0       > ldi
1626   53A2 ED A0       > ldi
1626   53A4 ED A0       > ldi
1626   53A6 ED A0       > ldi
1626   53A8 ED A0       > ldi
1626   53AA ED A0       > ldi
1626   53AC ED A0       > ldi
1626   53AE ED A0       > ldi
1626   53B0 ED A0       > ldi
1626   53B2 ED A0       > ldi
1626   53B4 ED A0       > ldi
1626   53B6 ED A0       > ldi
1626   53B8 ED A0       > ldi
1626   53BA ED A0       > ldi
1626   53BC ED A0       > ldi
1626   53BE ED A0       > ldi
1626   53C0 ED A0       > ldi
1626   53C2 ED A0       > ldi
1626   53C4 ED A0       > ldi
1626   53C6 ED A0       > ldi
1626   53C8 ED A0       > ldi
1626   53CA ED A0       > ldi
1626   53CC ED A0       > ldi
1626   53CE ED A0       > ldi
1626   53D0 ED A0       > ldi
1626   53D2 ED A0       > ldi
1626   53D4 ED A0       > ldi
1626   53D6 ED A0       > ldi
1626   53D8 ED A0       > ldi
1626   53DA ED A0       > ldi
1626   53DC ED A0       > ldi
1626   53DE ED A0       > ldi
1626   53E0 ED A0       > ldi
1626   53E2 ED A0       > ldi
1626   53E4 ED A0       > ldi
1626   53E6 ED A0       > ldi
1626   53E8 ED A0       > ldi
1626   53EA ED A0       > ldi
1626   53EC ED A0       > ldi
1626   53EE ED A0       > ldi
1626   53F0 ED A0       > ldi
1626   53F2 ED A0       > ldi
1626   53F4 ED A0       > ldi
1626   53F6 ED A0       > ldi
1626   53F8 ED A0       > ldi
1626   53FA ED A0       > ldi
1626   53FC ED A0       > ldi
1626   53FE ED A0       > ldi
1626   5400 ED A0       > ldi
1626   5402 ED A0       > ldi
1626   5404 ED A0       > ldi
1626   5406 ED A0       > ldi
1626   5408 ED A0       > ldi
1626   540A ED A0       > ldi
1626   540C ED A0       > ldi
1626   540E ED A0       > ldi
1626   5410 ED A0       > ldi
1626   5412 ED A0       > ldi
1626   5414 ED A0       > ldi
1626   5416 ED A0       > ldi
1626   5418 ED A0       > ldi
1626   541A ED A0       > ldi
1626   541C ED A0       > ldi
1626   541E ED A0       > ldi
1626   5420 ED A0       > ldi
1626   5422 ED A0       > ldi
1626   5424 ED A0       > ldi
1626   5426 ED A0       > ldi
1626   5428 ED A0       > ldi
1626   542A ED A0       > ldi
1626   542C ED A0       > ldi
1626   542E ED A0       > ldi
1626   5430 ED A0       > ldi
1626   5432 ED A0       > ldi
1626   5434 ED A0       > ldi
1626   5436 ED A0       > ldi
1626   5438 ED A0       > ldi
1626   543A ED A0       > ldi
1626   543C ED A0       > ldi
1626   543E ED A0       > ldi
1626   5440 ED A0       > ldi
1626   5442 ED A0       > ldi
1626   5444 ED A0       > ldi
1626   5446 ED A0       > ldi
1626   5448 ED A0       > ldi
1626   544A ED A0       > ldi
1626   544C ED A0       > ldi
1626   544E ED A0       > ldi
1626   5450 ED A0       > ldi
1626   5452 ED A0       > ldi
1626   5454 ED A0       > ldi
1626   5456 ED A0       > ldi
1626   5458 ED A0       > ldi
1626   545A ED A0       > ldi
1626   545C ED A0       > ldi
1626   545E ED A0       > ldi
1626   5460 ED A0       > ldi
1626   5462 ED A0       > ldi
1626   5464 ED A0       > ldi
1626   5466 ED A0       > ldi
1626   5468 ED A0       > ldi
1626   546A ED A0       > ldi
1626   546C ED A0       > ldi
1626   546E ED A0       > ldi
1626   5470 ED A0       > ldi
1626   5472 ED A0       > ldi
1626   5474 ED A0       > ldi
1626   5476 ED A0       > ldi
1626   5478 ED A0       > ldi
1626   547A ED A0       > ldi
1626   547C ED A0       > ldi
1626   547E ED A0       > ldi
1626   5480 ED A0       > ldi
1626   5482 ED A0       > ldi
1626   5484 ED A0       > ldi
1626   5486 ED A0       > ldi
1626   5488 ED A0       > ldi
1626   548A ED A0       > ldi
1626   548C ED A0       > ldi
1626   548E ED A0       > ldi
1626   5490 ED A0       > ldi
1626   5492 ED A0       > ldi
1626   5494 ED A0       > ldi
1626   5496 ED A0       > ldi
1626   5498 ED A0       > ldi
1626   549A ED A0       > ldi
1626   549C ED A0       > ldi
1626   549E ED A0       > ldi
1626   54A0 ED A0       > ldi
1626   54A2 ED A0       > ldi
1626   54A4 ED A0       > ldi
1626   54A6 ED A0       > ldi
1626   54A8 ED A0       > ldi
1626   54AA ED A0       > ldi
1626   54AC ED A0       > ldi
1626   54AE ED A0       > ldi
1626   54B0 ED A0       > ldi
1626   54B2 ED A0       > ldi
1626   54B4 ED A0       > ldi
1626   54B6 ED A0       > ldi
1626   54B8 ED A0       > ldi
1626   54BA ED A0       > ldi
1626   54BC ED A0       > ldi
1626   54BE ED A0       > ldi
1626   54C0 ED A0       > ldi
1626   54C2 ED A0       > ldi
1626   54C4 ED A0       > ldi
1626   54C6 ED A0       > ldi
1626   54C8 ED A0       > ldi
1626   54CA ED A0       > ldi
1626   54CC ED A0       > ldi
1626   54CE ED A0       > ldi
1626   54D0 ED A0       > ldi
1626   54D2 ED A0       > ldi
1626   54D4 ED A0       > ldi
1626   54D6 ED A0       > ldi
1626   54D8 ED A0       > ldi
1626   54DA ED A0       > ldi
1626   54DC ED A0       > ldi
1626   54DE ED A0       > ldi
1626   54E0 ED A0       > ldi
1626   54E2 ED A0       > ldi
1626   54E4 ED A0       > ldi
1626   54E6 ED A0       > ldi
1626   54E8 ED A0       > ldi
1626   54EA ED A0       > ldi
1626   54EC ED A0       > ldi
1626   54EE ED A0       > ldi
1626   54F0 ED A0       > ldi
1626   54F2 ED A0       > ldi
1626   54F4 ED A0       > ldi
1626   54F6 ED A0       > ldi
1626   54F8 ED A0       > ldi
1626   54FA ED A0       > ldi
1626   54FC ED A0       > ldi
1626   54FE ED A0       > ldi
1626   5500 ED A0       > ldi
1626   5502 ED A0       > ldi
1626   5504 ED A0       > ldi
1626   5506 ED A0       > ldi
1626   5508 ED A0       > ldi
1626   550A ED A0       > ldi
1626   550C ED A0       > ldi
1626   550E ED A0       > ldi
1626   5510 ED A0       > ldi
1626   5512 ED A0       > ldi
1626   5514 ED A0       > ldi
1626   5516 ED A0       > ldi
1626   5518 ED A0       > ldi
1626   551A ED A0       > ldi
1626   551C ED A0       > ldi
1626   551E ED A0       > ldi
1626   5520 ED A0       > ldi
1626   5522 ED A0       > ldi
1626   5524 ED A0       > ldi
1626   5526 ED A0       > ldi
1626   5528 ED A0       > ldi
1626   552A ED A0       > ldi
1626   552C ED A0       > ldi
1626   552E ED A0       > ldi
1626   5530 ED A0       > ldi
1626   5532 ED A0       > ldi
1626   5534 ED A0       > ldi
1626   5536 ED A0       > ldi
1626   5538 ED A0       > ldi
1626   553A ED A0       > ldi
1626   553C ED A0       > ldi
1626   553E ED A0       > ldi
1626   5540 ED A0       > ldi
1626   5542 ED A0       > ldi
1626   5544 ED A0       > ldi
1626   5546 ED A0       > ldi
1626   5548 ED A0       > ldi
1626   554A ED A0       > ldi
1626   554C ED A0       > ldi
1626   554E ED A0       > ldi
1626   5550 ED A0       > ldi
1626   5552 ED A0       > ldi
1626   5554 ED A0       > ldi
1626   5556 ED A0       > ldi
1626   5558 ED A0       > ldi
1626   555A ED A0       > ldi
1626   555C ED A0       > ldi
1626   555E ED A0       > ldi
1626   5560 ED A0       > ldi
1626   5562 ED A0       > ldi
1626   5564 ED A0       > ldi
1626   5566 ED A0       > ldi
1626   5568 ED A0       > ldi
1626   556A ED A0       > ldi
1626   556C ED A0       > ldi
1626   556E ED A0       > ldi
1626   5570 ED A0       > ldi
1626   5572 ED A0       > ldi
1626   5574 ED A0       > ldi
1626   5576 ED A0       > ldi
1626   5578 ED A0       > ldi
1626   557A ED A0       > ldi
1626   557C ED A0       > ldi
1626   557E ED A0       > ldi
1626   5580 ED A0       > ldi
1626   5582 ED A0       > ldi
1626   5584 ED A0       > ldi
1626   5586 ED A0       > ldi
1626   5588 ED A0       > ldi
1626   558A ED A0       > ldi
1626   558C ED A0       > ldi
1626   558E ED A0       > ldi
1626   5590 ED A0       > ldi
1626   5592 ED A0       > ldi
1626   5594 ED A0       > ldi
1626   5596 ED A0       > ldi
1626   5598 ED A0       > ldi
1626   559A ED A0       > ldi
1626   559C ED A0       > ldi
1626   559E ED A0       > ldi
1626   55A0 ED A0       > ldi
1626   55A2 ED A0       > ldi
1626   55A4 ED A0       > ldi
1626   55A6 ED A0       > ldi
1626   55A8 ED A0       > ldi
1626   55AA ED A0       > ldi
1626   55AC ED A0       > ldi
1626   55AE ED A0       > ldi
1626   55B0 ED A0       > ldi
1626   55B2 ED A0       > ldi
1626   55B4 ED A0       > ldi
1626   55B6 ED A0       > ldi
1626   55B8 ED A0       > ldi
1626   55BA ED A0       > ldi
1626   55BC ED A0       > ldi
1626   55BE ED A0       > ldi
1626   55C0 ED A0       > ldi
1626   55C2 ED A0       > ldi
1626   55C4 ED A0       > ldi
1626   55C6 ED A0       > ldi
1626   55C8 ED A0       > ldi
1626   55CA ED A0       > ldi
1627   55CC 3E FF       	ld	a, $FF		; envia dummy CRC
1628   55CE 32 00 7B    	ld	(PORTSPI),a
1629   55D1 00          	nop
1630   55D2 32 00 7B    	ld	(PORTSPI),a
1631   55D5 CD 19 4D    	call	WAIT_RESP_NO_FF	; esperar cartao
1632   55D8 E6 1F       	and	$1F		; testa bits erro
1633   55DA FE 05       	cp	5
1634   55DC C2 C0 51    	jp	nz,.erro	; resposta errada, informar erro
1635   55DF             .esp: 
1636   55DF CD 19 4D    	call	WAIT_RESP_NO_FF	; esperar cartao
1637   55E2 B7          	or	a
1638   55E3 28 FA       	jr	z,.esp
1639   55E5             .fim: 
1640   55E5 AF          	xor	a		; zera carry e informa nenhum erro
1641   55E6             terminaLeituraEscritaBloco: 
1642   55E6 F5          	push	af
1643   55E7 CD 90 4C    	call	desabilitaSDs	; desabilitar todos os cartoes
1644   55EA F1          	pop	af
1645   55EB C9          	ret
1646   55EC             
1647   55EC             ; ------------------------------------------------
1648   55EC             ; Ler um bloco de 512 bytes do cartao
1649   55EC             ; HL aponta para o inicio dos dados
1650   55EC             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1651   55EC             ; Destroi AF, BC, DE, HL
1652   55EC             ; ------------------------------------------------
1653   55EC             LerBloco: 
1654   55EC DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1655   55EF B7          	or	a
1656   55F0 CC 4B 5E    	call	z,blocoParaByte	; se for SDV1 coverter blocos para bytes
1657   55F3 CD 37 4D    	call	setaSDAtual
1658   55F6 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer ler um ou mais blocos
1659   55F9 3D          	dec	a
1660   55FA CA 2A 5A    	jp	z,.umBloco	; somente um bloco, pular
1661   55FD             
1662   55FD             ; multiplos blocos
1663   55FD 3E 52       	ld	a, CMD18	; ler multiplos blocos com CMD18 = Read Multiple Blocks
1664   55FF CD AD 4C    	call	SD_SEND_CMD_GET_ERROR
1665   5602 DA 31 5A    	jp	c,.erro
1666   5605             .loop: 
1667   5605 CD 0B 4D    	call	WAIT_RESP_FE
1668   5608 DA 31 5A    	jp	c,.erro
1669   560B 11 00 7B    	ld	de, PORTSPI
1670   560E EB          	ex	de,hl
1671   560F ED A0       > ldi
1671   5611 ED A0       > ldi
1671   5613 ED A0       > ldi
1671   5615 ED A0       > ldi
1671   5617 ED A0       > ldi
1671   5619 ED A0       > ldi
1671   561B ED A0       > ldi
1671   561D ED A0       > ldi
1671   561F ED A0       > ldi
1671   5621 ED A0       > ldi
1671   5623 ED A0       > ldi
1671   5625 ED A0       > ldi
1671   5627 ED A0       > ldi
1671   5629 ED A0       > ldi
1671   562B ED A0       > ldi
1671   562D ED A0       > ldi
1671   562F ED A0       > ldi
1671   5631 ED A0       > ldi
1671   5633 ED A0       > ldi
1671   5635 ED A0       > ldi
1671   5637 ED A0       > ldi
1671   5639 ED A0       > ldi
1671   563B ED A0       > ldi
1671   563D ED A0       > ldi
1671   563F ED A0       > ldi
1671   5641 ED A0       > ldi
1671   5643 ED A0       > ldi
1671   5645 ED A0       > ldi
1671   5647 ED A0       > ldi
1671   5649 ED A0       > ldi
1671   564B ED A0       > ldi
1671   564D ED A0       > ldi
1671   564F ED A0       > ldi
1671   5651 ED A0       > ldi
1671   5653 ED A0       > ldi
1671   5655 ED A0       > ldi
1671   5657 ED A0       > ldi
1671   5659 ED A0       > ldi
1671   565B ED A0       > ldi
1671   565D ED A0       > ldi
1671   565F ED A0       > ldi
1671   5661 ED A0       > ldi
1671   5663 ED A0       > ldi
1671   5665 ED A0       > ldi
1671   5667 ED A0       > ldi
1671   5669 ED A0       > ldi
1671   566B ED A0       > ldi
1671   566D ED A0       > ldi
1671   566F ED A0       > ldi
1671   5671 ED A0       > ldi
1671   5673 ED A0       > ldi
1671   5675 ED A0       > ldi
1671   5677 ED A0       > ldi
1671   5679 ED A0       > ldi
1671   567B ED A0       > ldi
1671   567D ED A0       > ldi
1671   567F ED A0       > ldi
1671   5681 ED A0       > ldi
1671   5683 ED A0       > ldi
1671   5685 ED A0       > ldi
1671   5687 ED A0       > ldi
1671   5689 ED A0       > ldi
1671   568B ED A0       > ldi
1671   568D ED A0       > ldi
1671   568F ED A0       > ldi
1671   5691 ED A0       > ldi
1671   5693 ED A0       > ldi
1671   5695 ED A0       > ldi
1671   5697 ED A0       > ldi
1671   5699 ED A0       > ldi
1671   569B ED A0       > ldi
1671   569D ED A0       > ldi
1671   569F ED A0       > ldi
1671   56A1 ED A0       > ldi
1671   56A3 ED A0       > ldi
1671   56A5 ED A0       > ldi
1671   56A7 ED A0       > ldi
1671   56A9 ED A0       > ldi
1671   56AB ED A0       > ldi
1671   56AD ED A0       > ldi
1671   56AF ED A0       > ldi
1671   56B1 ED A0       > ldi
1671   56B3 ED A0       > ldi
1671   56B5 ED A0       > ldi
1671   56B7 ED A0       > ldi
1671   56B9 ED A0       > ldi
1671   56BB ED A0       > ldi
1671   56BD ED A0       > ldi
1671   56BF ED A0       > ldi
1671   56C1 ED A0       > ldi
1671   56C3 ED A0       > ldi
1671   56C5 ED A0       > ldi
1671   56C7 ED A0       > ldi
1671   56C9 ED A0       > ldi
1671   56CB ED A0       > ldi
1671   56CD ED A0       > ldi
1671   56CF ED A0       > ldi
1671   56D1 ED A0       > ldi
1671   56D3 ED A0       > ldi
1671   56D5 ED A0       > ldi
1671   56D7 ED A0       > ldi
1671   56D9 ED A0       > ldi
1671   56DB ED A0       > ldi
1671   56DD ED A0       > ldi
1671   56DF ED A0       > ldi
1671   56E1 ED A0       > ldi
1671   56E3 ED A0       > ldi
1671   56E5 ED A0       > ldi
1671   56E7 ED A0       > ldi
1671   56E9 ED A0       > ldi
1671   56EB ED A0       > ldi
1671   56ED ED A0       > ldi
1671   56EF ED A0       > ldi
1671   56F1 ED A0       > ldi
1671   56F3 ED A0       > ldi
1671   56F5 ED A0       > ldi
1671   56F7 ED A0       > ldi
1671   56F9 ED A0       > ldi
1671   56FB ED A0       > ldi
1671   56FD ED A0       > ldi
1671   56FF ED A0       > ldi
1671   5701 ED A0       > ldi
1671   5703 ED A0       > ldi
1671   5705 ED A0       > ldi
1671   5707 ED A0       > ldi
1671   5709 ED A0       > ldi
1671   570B ED A0       > ldi
1671   570D ED A0       > ldi
1671   570F ED A0       > ldi
1671   5711 ED A0       > ldi
1671   5713 ED A0       > ldi
1671   5715 ED A0       > ldi
1671   5717 ED A0       > ldi
1671   5719 ED A0       > ldi
1671   571B ED A0       > ldi
1671   571D ED A0       > ldi
1671   571F ED A0       > ldi
1671   5721 ED A0       > ldi
1671   5723 ED A0       > ldi
1671   5725 ED A0       > ldi
1671   5727 ED A0       > ldi
1671   5729 ED A0       > ldi
1671   572B ED A0       > ldi
1671   572D ED A0       > ldi
1671   572F ED A0       > ldi
1671   5731 ED A0       > ldi
1671   5733 ED A0       > ldi
1671   5735 ED A0       > ldi
1671   5737 ED A0       > ldi
1671   5739 ED A0       > ldi
1671   573B ED A0       > ldi
1671   573D ED A0       > ldi
1671   573F ED A0       > ldi
1671   5741 ED A0       > ldi
1671   5743 ED A0       > ldi
1671   5745 ED A0       > ldi
1671   5747 ED A0       > ldi
1671   5749 ED A0       > ldi
1671   574B ED A0       > ldi
1671   574D ED A0       > ldi
1671   574F ED A0       > ldi
1671   5751 ED A0       > ldi
1671   5753 ED A0       > ldi
1671   5755 ED A0       > ldi
1671   5757 ED A0       > ldi
1671   5759 ED A0       > ldi
1671   575B ED A0       > ldi
1671   575D ED A0       > ldi
1671   575F ED A0       > ldi
1671   5761 ED A0       > ldi
1671   5763 ED A0       > ldi
1671   5765 ED A0       > ldi
1671   5767 ED A0       > ldi
1671   5769 ED A0       > ldi
1671   576B ED A0       > ldi
1671   576D ED A0       > ldi
1671   576F ED A0       > ldi
1671   5771 ED A0       > ldi
1671   5773 ED A0       > ldi
1671   5775 ED A0       > ldi
1671   5777 ED A0       > ldi
1671   5779 ED A0       > ldi
1671   577B ED A0       > ldi
1671   577D ED A0       > ldi
1671   577F ED A0       > ldi
1671   5781 ED A0       > ldi
1671   5783 ED A0       > ldi
1671   5785 ED A0       > ldi
1671   5787 ED A0       > ldi
1671   5789 ED A0       > ldi
1671   578B ED A0       > ldi
1671   578D ED A0       > ldi
1671   578F ED A0       > ldi
1671   5791 ED A0       > ldi
1671   5793 ED A0       > ldi
1671   5795 ED A0       > ldi
1671   5797 ED A0       > ldi
1671   5799 ED A0       > ldi
1671   579B ED A0       > ldi
1671   579D ED A0       > ldi
1671   579F ED A0       > ldi
1671   57A1 ED A0       > ldi
1671   57A3 ED A0       > ldi
1671   57A5 ED A0       > ldi
1671   57A7 ED A0       > ldi
1671   57A9 ED A0       > ldi
1671   57AB ED A0       > ldi
1671   57AD ED A0       > ldi
1671   57AF ED A0       > ldi
1671   57B1 ED A0       > ldi
1671   57B3 ED A0       > ldi
1671   57B5 ED A0       > ldi
1671   57B7 ED A0       > ldi
1671   57B9 ED A0       > ldi
1671   57BB ED A0       > ldi
1671   57BD ED A0       > ldi
1671   57BF ED A0       > ldi
1671   57C1 ED A0       > ldi
1671   57C3 ED A0       > ldi
1671   57C5 ED A0       > ldi
1671   57C7 ED A0       > ldi
1671   57C9 ED A0       > ldi
1671   57CB ED A0       > ldi
1671   57CD ED A0       > ldi
1671   57CF ED A0       > ldi
1671   57D1 ED A0       > ldi
1671   57D3 ED A0       > ldi
1671   57D5 ED A0       > ldi
1671   57D7 ED A0       > ldi
1671   57D9 ED A0       > ldi
1671   57DB ED A0       > ldi
1671   57DD ED A0       > ldi
1671   57DF ED A0       > ldi
1671   57E1 ED A0       > ldi
1671   57E3 ED A0       > ldi
1671   57E5 ED A0       > ldi
1671   57E7 ED A0       > ldi
1671   57E9 ED A0       > ldi
1671   57EB ED A0       > ldi
1671   57ED ED A0       > ldi
1671   57EF ED A0       > ldi
1671   57F1 ED A0       > ldi
1671   57F3 ED A0       > ldi
1671   57F5 ED A0       > ldi
1671   57F7 ED A0       > ldi
1671   57F9 ED A0       > ldi
1671   57FB ED A0       > ldi
1671   57FD ED A0       > ldi
1671   57FF ED A0       > ldi
1671   5801 ED A0       > ldi
1671   5803 ED A0       > ldi
1671   5805 ED A0       > ldi
1671   5807 ED A0       > ldi
1671   5809 ED A0       > ldi
1671   580B ED A0       > ldi
1671   580D ED A0       > ldi
1671   580F ED A0       > ldi
1671   5811 ED A0       > ldi
1671   5813 ED A0       > ldi
1671   5815 ED A0       > ldi
1671   5817 ED A0       > ldi
1671   5819 ED A0       > ldi
1671   581B ED A0       > ldi
1671   581D ED A0       > ldi
1671   581F ED A0       > ldi
1671   5821 ED A0       > ldi
1671   5823 ED A0       > ldi
1671   5825 ED A0       > ldi
1671   5827 ED A0       > ldi
1671   5829 ED A0       > ldi
1671   582B ED A0       > ldi
1671   582D ED A0       > ldi
1671   582F ED A0       > ldi
1671   5831 ED A0       > ldi
1671   5833 ED A0       > ldi
1671   5835 ED A0       > ldi
1671   5837 ED A0       > ldi
1671   5839 ED A0       > ldi
1671   583B ED A0       > ldi
1671   583D ED A0       > ldi
1671   583F ED A0       > ldi
1671   5841 ED A0       > ldi
1671   5843 ED A0       > ldi
1671   5845 ED A0       > ldi
1671   5847 ED A0       > ldi
1671   5849 ED A0       > ldi
1671   584B ED A0       > ldi
1671   584D ED A0       > ldi
1671   584F ED A0       > ldi
1671   5851 ED A0       > ldi
1671   5853 ED A0       > ldi
1671   5855 ED A0       > ldi
1671   5857 ED A0       > ldi
1671   5859 ED A0       > ldi
1671   585B ED A0       > ldi
1671   585D ED A0       > ldi
1671   585F ED A0       > ldi
1671   5861 ED A0       > ldi
1671   5863 ED A0       > ldi
1671   5865 ED A0       > ldi
1671   5867 ED A0       > ldi
1671   5869 ED A0       > ldi
1671   586B ED A0       > ldi
1671   586D ED A0       > ldi
1671   586F ED A0       > ldi
1671   5871 ED A0       > ldi
1671   5873 ED A0       > ldi
1671   5875 ED A0       > ldi
1671   5877 ED A0       > ldi
1671   5879 ED A0       > ldi
1671   587B ED A0       > ldi
1671   587D ED A0       > ldi
1671   587F ED A0       > ldi
1671   5881 ED A0       > ldi
1671   5883 ED A0       > ldi
1671   5885 ED A0       > ldi
1671   5887 ED A0       > ldi
1671   5889 ED A0       > ldi
1671   588B ED A0       > ldi
1671   588D ED A0       > ldi
1671   588F ED A0       > ldi
1671   5891 ED A0       > ldi
1671   5893 ED A0       > ldi
1671   5895 ED A0       > ldi
1671   5897 ED A0       > ldi
1671   5899 ED A0       > ldi
1671   589B ED A0       > ldi
1671   589D ED A0       > ldi
1671   589F ED A0       > ldi
1671   58A1 ED A0       > ldi
1671   58A3 ED A0       > ldi
1671   58A5 ED A0       > ldi
1671   58A7 ED A0       > ldi
1671   58A9 ED A0       > ldi
1671   58AB ED A0       > ldi
1671   58AD ED A0       > ldi
1671   58AF ED A0       > ldi
1671   58B1 ED A0       > ldi
1671   58B3 ED A0       > ldi
1671   58B5 ED A0       > ldi
1671   58B7 ED A0       > ldi
1671   58B9 ED A0       > ldi
1671   58BB ED A0       > ldi
1671   58BD ED A0       > ldi
1671   58BF ED A0       > ldi
1671   58C1 ED A0       > ldi
1671   58C3 ED A0       > ldi
1671   58C5 ED A0       > ldi
1671   58C7 ED A0       > ldi
1671   58C9 ED A0       > ldi
1671   58CB ED A0       > ldi
1671   58CD ED A0       > ldi
1671   58CF ED A0       > ldi
1671   58D1 ED A0       > ldi
1671   58D3 ED A0       > ldi
1671   58D5 ED A0       > ldi
1671   58D7 ED A0       > ldi
1671   58D9 ED A0       > ldi
1671   58DB ED A0       > ldi
1671   58DD ED A0       > ldi
1671   58DF ED A0       > ldi
1671   58E1 ED A0       > ldi
1671   58E3 ED A0       > ldi
1671   58E5 ED A0       > ldi
1671   58E7 ED A0       > ldi
1671   58E9 ED A0       > ldi
1671   58EB ED A0       > ldi
1671   58ED ED A0       > ldi
1671   58EF ED A0       > ldi
1671   58F1 ED A0       > ldi
1671   58F3 ED A0       > ldi
1671   58F5 ED A0       > ldi
1671   58F7 ED A0       > ldi
1671   58F9 ED A0       > ldi
1671   58FB ED A0       > ldi
1671   58FD ED A0       > ldi
1671   58FF ED A0       > ldi
1671   5901 ED A0       > ldi
1671   5903 ED A0       > ldi
1671   5905 ED A0       > ldi
1671   5907 ED A0       > ldi
1671   5909 ED A0       > ldi
1671   590B ED A0       > ldi
1671   590D ED A0       > ldi
1671   590F ED A0       > ldi
1671   5911 ED A0       > ldi
1671   5913 ED A0       > ldi
1671   5915 ED A0       > ldi
1671   5917 ED A0       > ldi
1671   5919 ED A0       > ldi
1671   591B ED A0       > ldi
1671   591D ED A0       > ldi
1671   591F ED A0       > ldi
1671   5921 ED A0       > ldi
1671   5923 ED A0       > ldi
1671   5925 ED A0       > ldi
1671   5927 ED A0       > ldi
1671   5929 ED A0       > ldi
1671   592B ED A0       > ldi
1671   592D ED A0       > ldi
1671   592F ED A0       > ldi
1671   5931 ED A0       > ldi
1671   5933 ED A0       > ldi
1671   5935 ED A0       > ldi
1671   5937 ED A0       > ldi
1671   5939 ED A0       > ldi
1671   593B ED A0       > ldi
1671   593D ED A0       > ldi
1671   593F ED A0       > ldi
1671   5941 ED A0       > ldi
1671   5943 ED A0       > ldi
1671   5945 ED A0       > ldi
1671   5947 ED A0       > ldi
1671   5949 ED A0       > ldi
1671   594B ED A0       > ldi
1671   594D ED A0       > ldi
1671   594F ED A0       > ldi
1671   5951 ED A0       > ldi
1671   5953 ED A0       > ldi
1671   5955 ED A0       > ldi
1671   5957 ED A0       > ldi
1671   5959 ED A0       > ldi
1671   595B ED A0       > ldi
1671   595D ED A0       > ldi
1671   595F ED A0       > ldi
1671   5961 ED A0       > ldi
1671   5963 ED A0       > ldi
1671   5965 ED A0       > ldi
1671   5967 ED A0       > ldi
1671   5969 ED A0       > ldi
1671   596B ED A0       > ldi
1671   596D ED A0       > ldi
1671   596F ED A0       > ldi
1671   5971 ED A0       > ldi
1671   5973 ED A0       > ldi
1671   5975 ED A0       > ldi
1671   5977 ED A0       > ldi
1671   5979 ED A0       > ldi
1671   597B ED A0       > ldi
1671   597D ED A0       > ldi
1671   597F ED A0       > ldi
1671   5981 ED A0       > ldi
1671   5983 ED A0       > ldi
1671   5985 ED A0       > ldi
1671   5987 ED A0       > ldi
1671   5989 ED A0       > ldi
1671   598B ED A0       > ldi
1671   598D ED A0       > ldi
1671   598F ED A0       > ldi
1671   5991 ED A0       > ldi
1671   5993 ED A0       > ldi
1671   5995 ED A0       > ldi
1671   5997 ED A0       > ldi
1671   5999 ED A0       > ldi
1671   599B ED A0       > ldi
1671   599D ED A0       > ldi
1671   599F ED A0       > ldi
1671   59A1 ED A0       > ldi
1671   59A3 ED A0       > ldi
1671   59A5 ED A0       > ldi
1671   59A7 ED A0       > ldi
1671   59A9 ED A0       > ldi
1671   59AB ED A0       > ldi
1671   59AD ED A0       > ldi
1671   59AF ED A0       > ldi
1671   59B1 ED A0       > ldi
1671   59B3 ED A0       > ldi
1671   59B5 ED A0       > ldi
1671   59B7 ED A0       > ldi
1671   59B9 ED A0       > ldi
1671   59BB ED A0       > ldi
1671   59BD ED A0       > ldi
1671   59BF ED A0       > ldi
1671   59C1 ED A0       > ldi
1671   59C3 ED A0       > ldi
1671   59C5 ED A0       > ldi
1671   59C7 ED A0       > ldi
1671   59C9 ED A0       > ldi
1671   59CB ED A0       > ldi
1671   59CD ED A0       > ldi
1671   59CF ED A0       > ldi
1671   59D1 ED A0       > ldi
1671   59D3 ED A0       > ldi
1671   59D5 ED A0       > ldi
1671   59D7 ED A0       > ldi
1671   59D9 ED A0       > ldi
1671   59DB ED A0       > ldi
1671   59DD ED A0       > ldi
1671   59DF ED A0       > ldi
1671   59E1 ED A0       > ldi
1671   59E3 ED A0       > ldi
1671   59E5 ED A0       > ldi
1671   59E7 ED A0       > ldi
1671   59E9 ED A0       > ldi
1671   59EB ED A0       > ldi
1671   59ED ED A0       > ldi
1671   59EF ED A0       > ldi
1671   59F1 ED A0       > ldi
1671   59F3 ED A0       > ldi
1671   59F5 ED A0       > ldi
1671   59F7 ED A0       > ldi
1671   59F9 ED A0       > ldi
1671   59FB ED A0       > ldi
1671   59FD ED A0       > ldi
1671   59FF ED A0       > ldi
1671   5A01 ED A0       > ldi
1671   5A03 ED A0       > ldi
1671   5A05 ED A0       > ldi
1671   5A07 ED A0       > ldi
1671   5A09 ED A0       > ldi
1671   5A0B ED A0       > ldi
1671   5A0D ED A0       > ldi
1672   5A0F EB          	ex	de,hl
1673   5A10 00          	nop
1674   5A11 3A 00 7B    	ld	a, (PORTSPI)	; descarta CRC
1675   5A14 00          	nop
1676   5A15 3A 00 7B    	ld	a, (PORTSPI)
1677   5A18 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para ler
1678   5A1B 3D          	dec	a
1679   5A1C FD 77 32    	ld	(iy+NUMBLOCOS), a
1680   5A1F C2 05 56    	jp	nz,.loop
1681   5A22 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1682   5A24 CD A8 4C    	call	SD_SEND_CMD_NO_ARGS
1683   5A27 C3 47 5E    	jp		.fim
1684   5A2A             
1685   5A2A             .umBloco: 
1686   5A2A 3E 51       	ld	a, CMD17	; ler somente um bloco com CMD17 = Read Single Block
1687   5A2C CD AD 4C    	call	SD_SEND_CMD_GET_ERROR
1688   5A2F 30 04       	jr	nc,.ok
1689   5A31             .erro: 
1690   5A31 37          	scf
1691   5A32 C3 E6 55    	jp		terminaLeituraEscritaBloco
1692   5A35             .ok: 
1693   5A35 CD 0B 4D    	call	WAIT_RESP_FE
1694   5A38 38 F7       	jr	c,.erro
1695   5A3A 11 00 7B    	ld	de, PORTSPI
1696   5A3D EB          	ex	de,hl
1697   5A3E ED A0       > ldi
1697   5A40 ED A0       > ldi
1697   5A42 ED A0       > ldi
1697   5A44 ED A0       > ldi
1697   5A46 ED A0       > ldi
1697   5A48 ED A0       > ldi
1697   5A4A ED A0       > ldi
1697   5A4C ED A0       > ldi
1697   5A4E ED A0       > ldi
1697   5A50 ED A0       > ldi
1697   5A52 ED A0       > ldi
1697   5A54 ED A0       > ldi
1697   5A56 ED A0       > ldi
1697   5A58 ED A0       > ldi
1697   5A5A ED A0       > ldi
1697   5A5C ED A0       > ldi
1697   5A5E ED A0       > ldi
1697   5A60 ED A0       > ldi
1697   5A62 ED A0       > ldi
1697   5A64 ED A0       > ldi
1697   5A66 ED A0       > ldi
1697   5A68 ED A0       > ldi
1697   5A6A ED A0       > ldi
1697   5A6C ED A0       > ldi
1697   5A6E ED A0       > ldi
1697   5A70 ED A0       > ldi
1697   5A72 ED A0       > ldi
1697   5A74 ED A0       > ldi
1697   5A76 ED A0       > ldi
1697   5A78 ED A0       > ldi
1697   5A7A ED A0       > ldi
1697   5A7C ED A0       > ldi
1697   5A7E ED A0       > ldi
1697   5A80 ED A0       > ldi
1697   5A82 ED A0       > ldi
1697   5A84 ED A0       > ldi
1697   5A86 ED A0       > ldi
1697   5A88 ED A0       > ldi
1697   5A8A ED A0       > ldi
1697   5A8C ED A0       > ldi
1697   5A8E ED A0       > ldi
1697   5A90 ED A0       > ldi
1697   5A92 ED A0       > ldi
1697   5A94 ED A0       > ldi
1697   5A96 ED A0       > ldi
1697   5A98 ED A0       > ldi
1697   5A9A ED A0       > ldi
1697   5A9C ED A0       > ldi
1697   5A9E ED A0       > ldi
1697   5AA0 ED A0       > ldi
1697   5AA2 ED A0       > ldi
1697   5AA4 ED A0       > ldi
1697   5AA6 ED A0       > ldi
1697   5AA8 ED A0       > ldi
1697   5AAA ED A0       > ldi
1697   5AAC ED A0       > ldi
1697   5AAE ED A0       > ldi
1697   5AB0 ED A0       > ldi
1697   5AB2 ED A0       > ldi
1697   5AB4 ED A0       > ldi
1697   5AB6 ED A0       > ldi
1697   5AB8 ED A0       > ldi
1697   5ABA ED A0       > ldi
1697   5ABC ED A0       > ldi
1697   5ABE ED A0       > ldi
1697   5AC0 ED A0       > ldi
1697   5AC2 ED A0       > ldi
1697   5AC4 ED A0       > ldi
1697   5AC6 ED A0       > ldi
1697   5AC8 ED A0       > ldi
1697   5ACA ED A0       > ldi
1697   5ACC ED A0       > ldi
1697   5ACE ED A0       > ldi
1697   5AD0 ED A0       > ldi
1697   5AD2 ED A0       > ldi
1697   5AD4 ED A0       > ldi
1697   5AD6 ED A0       > ldi
1697   5AD8 ED A0       > ldi
1697   5ADA ED A0       > ldi
1697   5ADC ED A0       > ldi
1697   5ADE ED A0       > ldi
1697   5AE0 ED A0       > ldi
1697   5AE2 ED A0       > ldi
1697   5AE4 ED A0       > ldi
1697   5AE6 ED A0       > ldi
1697   5AE8 ED A0       > ldi
1697   5AEA ED A0       > ldi
1697   5AEC ED A0       > ldi
1697   5AEE ED A0       > ldi
1697   5AF0 ED A0       > ldi
1697   5AF2 ED A0       > ldi
1697   5AF4 ED A0       > ldi
1697   5AF6 ED A0       > ldi
1697   5AF8 ED A0       > ldi
1697   5AFA ED A0       > ldi
1697   5AFC ED A0       > ldi
1697   5AFE ED A0       > ldi
1697   5B00 ED A0       > ldi
1697   5B02 ED A0       > ldi
1697   5B04 ED A0       > ldi
1697   5B06 ED A0       > ldi
1697   5B08 ED A0       > ldi
1697   5B0A ED A0       > ldi
1697   5B0C ED A0       > ldi
1697   5B0E ED A0       > ldi
1697   5B10 ED A0       > ldi
1697   5B12 ED A0       > ldi
1697   5B14 ED A0       > ldi
1697   5B16 ED A0       > ldi
1697   5B18 ED A0       > ldi
1697   5B1A ED A0       > ldi
1697   5B1C ED A0       > ldi
1697   5B1E ED A0       > ldi
1697   5B20 ED A0       > ldi
1697   5B22 ED A0       > ldi
1697   5B24 ED A0       > ldi
1697   5B26 ED A0       > ldi
1697   5B28 ED A0       > ldi
1697   5B2A ED A0       > ldi
1697   5B2C ED A0       > ldi
1697   5B2E ED A0       > ldi
1697   5B30 ED A0       > ldi
1697   5B32 ED A0       > ldi
1697   5B34 ED A0       > ldi
1697   5B36 ED A0       > ldi
1697   5B38 ED A0       > ldi
1697   5B3A ED A0       > ldi
1697   5B3C ED A0       > ldi
1697   5B3E ED A0       > ldi
1697   5B40 ED A0       > ldi
1697   5B42 ED A0       > ldi
1697   5B44 ED A0       > ldi
1697   5B46 ED A0       > ldi
1697   5B48 ED A0       > ldi
1697   5B4A ED A0       > ldi
1697   5B4C ED A0       > ldi
1697   5B4E ED A0       > ldi
1697   5B50 ED A0       > ldi
1697   5B52 ED A0       > ldi
1697   5B54 ED A0       > ldi
1697   5B56 ED A0       > ldi
1697   5B58 ED A0       > ldi
1697   5B5A ED A0       > ldi
1697   5B5C ED A0       > ldi
1697   5B5E ED A0       > ldi
1697   5B60 ED A0       > ldi
1697   5B62 ED A0       > ldi
1697   5B64 ED A0       > ldi
1697   5B66 ED A0       > ldi
1697   5B68 ED A0       > ldi
1697   5B6A ED A0       > ldi
1697   5B6C ED A0       > ldi
1697   5B6E ED A0       > ldi
1697   5B70 ED A0       > ldi
1697   5B72 ED A0       > ldi
1697   5B74 ED A0       > ldi
1697   5B76 ED A0       > ldi
1697   5B78 ED A0       > ldi
1697   5B7A ED A0       > ldi
1697   5B7C ED A0       > ldi
1697   5B7E ED A0       > ldi
1697   5B80 ED A0       > ldi
1697   5B82 ED A0       > ldi
1697   5B84 ED A0       > ldi
1697   5B86 ED A0       > ldi
1697   5B88 ED A0       > ldi
1697   5B8A ED A0       > ldi
1697   5B8C ED A0       > ldi
1697   5B8E ED A0       > ldi
1697   5B90 ED A0       > ldi
1697   5B92 ED A0       > ldi
1697   5B94 ED A0       > ldi
1697   5B96 ED A0       > ldi
1697   5B98 ED A0       > ldi
1697   5B9A ED A0       > ldi
1697   5B9C ED A0       > ldi
1697   5B9E ED A0       > ldi
1697   5BA0 ED A0       > ldi
1697   5BA2 ED A0       > ldi
1697   5BA4 ED A0       > ldi
1697   5BA6 ED A0       > ldi
1697   5BA8 ED A0       > ldi
1697   5BAA ED A0       > ldi
1697   5BAC ED A0       > ldi
1697   5BAE ED A0       > ldi
1697   5BB0 ED A0       > ldi
1697   5BB2 ED A0       > ldi
1697   5BB4 ED A0       > ldi
1697   5BB6 ED A0       > ldi
1697   5BB8 ED A0       > ldi
1697   5BBA ED A0       > ldi
1697   5BBC ED A0       > ldi
1697   5BBE ED A0       > ldi
1697   5BC0 ED A0       > ldi
1697   5BC2 ED A0       > ldi
1697   5BC4 ED A0       > ldi
1697   5BC6 ED A0       > ldi
1697   5BC8 ED A0       > ldi
1697   5BCA ED A0       > ldi
1697   5BCC ED A0       > ldi
1697   5BCE ED A0       > ldi
1697   5BD0 ED A0       > ldi
1697   5BD2 ED A0       > ldi
1697   5BD4 ED A0       > ldi
1697   5BD6 ED A0       > ldi
1697   5BD8 ED A0       > ldi
1697   5BDA ED A0       > ldi
1697   5BDC ED A0       > ldi
1697   5BDE ED A0       > ldi
1697   5BE0 ED A0       > ldi
1697   5BE2 ED A0       > ldi
1697   5BE4 ED A0       > ldi
1697   5BE6 ED A0       > ldi
1697   5BE8 ED A0       > ldi
1697   5BEA ED A0       > ldi
1697   5BEC ED A0       > ldi
1697   5BEE ED A0       > ldi
1697   5BF0 ED A0       > ldi
1697   5BF2 ED A0       > ldi
1697   5BF4 ED A0       > ldi
1697   5BF6 ED A0       > ldi
1697   5BF8 ED A0       > ldi
1697   5BFA ED A0       > ldi
1697   5BFC ED A0       > ldi
1697   5BFE ED A0       > ldi
1697   5C00 ED A0       > ldi
1697   5C02 ED A0       > ldi
1697   5C04 ED A0       > ldi
1697   5C06 ED A0       > ldi
1697   5C08 ED A0       > ldi
1697   5C0A ED A0       > ldi
1697   5C0C ED A0       > ldi
1697   5C0E ED A0       > ldi
1697   5C10 ED A0       > ldi
1697   5C12 ED A0       > ldi
1697   5C14 ED A0       > ldi
1697   5C16 ED A0       > ldi
1697   5C18 ED A0       > ldi
1697   5C1A ED A0       > ldi
1697   5C1C ED A0       > ldi
1697   5C1E ED A0       > ldi
1697   5C20 ED A0       > ldi
1697   5C22 ED A0       > ldi
1697   5C24 ED A0       > ldi
1697   5C26 ED A0       > ldi
1697   5C28 ED A0       > ldi
1697   5C2A ED A0       > ldi
1697   5C2C ED A0       > ldi
1697   5C2E ED A0       > ldi
1697   5C30 ED A0       > ldi
1697   5C32 ED A0       > ldi
1697   5C34 ED A0       > ldi
1697   5C36 ED A0       > ldi
1697   5C38 ED A0       > ldi
1697   5C3A ED A0       > ldi
1697   5C3C ED A0       > ldi
1697   5C3E ED A0       > ldi
1697   5C40 ED A0       > ldi
1697   5C42 ED A0       > ldi
1697   5C44 ED A0       > ldi
1697   5C46 ED A0       > ldi
1697   5C48 ED A0       > ldi
1697   5C4A ED A0       > ldi
1697   5C4C ED A0       > ldi
1697   5C4E ED A0       > ldi
1697   5C50 ED A0       > ldi
1697   5C52 ED A0       > ldi
1697   5C54 ED A0       > ldi
1697   5C56 ED A0       > ldi
1697   5C58 ED A0       > ldi
1697   5C5A ED A0       > ldi
1697   5C5C ED A0       > ldi
1697   5C5E ED A0       > ldi
1697   5C60 ED A0       > ldi
1697   5C62 ED A0       > ldi
1697   5C64 ED A0       > ldi
1697   5C66 ED A0       > ldi
1697   5C68 ED A0       > ldi
1697   5C6A ED A0       > ldi
1697   5C6C ED A0       > ldi
1697   5C6E ED A0       > ldi
1697   5C70 ED A0       > ldi
1697   5C72 ED A0       > ldi
1697   5C74 ED A0       > ldi
1697   5C76 ED A0       > ldi
1697   5C78 ED A0       > ldi
1697   5C7A ED A0       > ldi
1697   5C7C ED A0       > ldi
1697   5C7E ED A0       > ldi
1697   5C80 ED A0       > ldi
1697   5C82 ED A0       > ldi
1697   5C84 ED A0       > ldi
1697   5C86 ED A0       > ldi
1697   5C88 ED A0       > ldi
1697   5C8A ED A0       > ldi
1697   5C8C ED A0       > ldi
1697   5C8E ED A0       > ldi
1697   5C90 ED A0       > ldi
1697   5C92 ED A0       > ldi
1697   5C94 ED A0       > ldi
1697   5C96 ED A0       > ldi
1697   5C98 ED A0       > ldi
1697   5C9A ED A0       > ldi
1697   5C9C ED A0       > ldi
1697   5C9E ED A0       > ldi
1697   5CA0 ED A0       > ldi
1697   5CA2 ED A0       > ldi
1697   5CA4 ED A0       > ldi
1697   5CA6 ED A0       > ldi
1697   5CA8 ED A0       > ldi
1697   5CAA ED A0       > ldi
1697   5CAC ED A0       > ldi
1697   5CAE ED A0       > ldi
1697   5CB0 ED A0       > ldi
1697   5CB2 ED A0       > ldi
1697   5CB4 ED A0       > ldi
1697   5CB6 ED A0       > ldi
1697   5CB8 ED A0       > ldi
1697   5CBA ED A0       > ldi
1697   5CBC ED A0       > ldi
1697   5CBE ED A0       > ldi
1697   5CC0 ED A0       > ldi
1697   5CC2 ED A0       > ldi
1697   5CC4 ED A0       > ldi
1697   5CC6 ED A0       > ldi
1697   5CC8 ED A0       > ldi
1697   5CCA ED A0       > ldi
1697   5CCC ED A0       > ldi
1697   5CCE ED A0       > ldi
1697   5CD0 ED A0       > ldi
1697   5CD2 ED A0       > ldi
1697   5CD4 ED A0       > ldi
1697   5CD6 ED A0       > ldi
1697   5CD8 ED A0       > ldi
1697   5CDA ED A0       > ldi
1697   5CDC ED A0       > ldi
1697   5CDE ED A0       > ldi
1697   5CE0 ED A0       > ldi
1697   5CE2 ED A0       > ldi
1697   5CE4 ED A0       > ldi
1697   5CE6 ED A0       > ldi
1697   5CE8 ED A0       > ldi
1697   5CEA ED A0       > ldi
1697   5CEC ED A0       > ldi
1697   5CEE ED A0       > ldi
1697   5CF0 ED A0       > ldi
1697   5CF2 ED A0       > ldi
1697   5CF4 ED A0       > ldi
1697   5CF6 ED A0       > ldi
1697   5CF8 ED A0       > ldi
1697   5CFA ED A0       > ldi
1697   5CFC ED A0       > ldi
1697   5CFE ED A0       > ldi
1697   5D00 ED A0       > ldi
1697   5D02 ED A0       > ldi
1697   5D04 ED A0       > ldi
1697   5D06 ED A0       > ldi
1697   5D08 ED A0       > ldi
1697   5D0A ED A0       > ldi
1697   5D0C ED A0       > ldi
1697   5D0E ED A0       > ldi
1697   5D10 ED A0       > ldi
1697   5D12 ED A0       > ldi
1697   5D14 ED A0       > ldi
1697   5D16 ED A0       > ldi
1697   5D18 ED A0       > ldi
1697   5D1A ED A0       > ldi
1697   5D1C ED A0       > ldi
1697   5D1E ED A0       > ldi
1697   5D20 ED A0       > ldi
1697   5D22 ED A0       > ldi
1697   5D24 ED A0       > ldi
1697   5D26 ED A0       > ldi
1697   5D28 ED A0       > ldi
1697   5D2A ED A0       > ldi
1697   5D2C ED A0       > ldi
1697   5D2E ED A0       > ldi
1697   5D30 ED A0       > ldi
1697   5D32 ED A0       > ldi
1697   5D34 ED A0       > ldi
1697   5D36 ED A0       > ldi
1697   5D38 ED A0       > ldi
1697   5D3A ED A0       > ldi
1697   5D3C ED A0       > ldi
1697   5D3E ED A0       > ldi
1697   5D40 ED A0       > ldi
1697   5D42 ED A0       > ldi
1697   5D44 ED A0       > ldi
1697   5D46 ED A0       > ldi
1697   5D48 ED A0       > ldi
1697   5D4A ED A0       > ldi
1697   5D4C ED A0       > ldi
1697   5D4E ED A0       > ldi
1697   5D50 ED A0       > ldi
1697   5D52 ED A0       > ldi
1697   5D54 ED A0       > ldi
1697   5D56 ED A0       > ldi
1697   5D58 ED A0       > ldi
1697   5D5A ED A0       > ldi
1697   5D5C ED A0       > ldi
1697   5D5E ED A0       > ldi
1697   5D60 ED A0       > ldi
1697   5D62 ED A0       > ldi
1697   5D64 ED A0       > ldi
1697   5D66 ED A0       > ldi
1697   5D68 ED A0       > ldi
1697   5D6A ED A0       > ldi
1697   5D6C ED A0       > ldi
1697   5D6E ED A0       > ldi
1697   5D70 ED A0       > ldi
1697   5D72 ED A0       > ldi
1697   5D74 ED A0       > ldi
1697   5D76 ED A0       > ldi
1697   5D78 ED A0       > ldi
1697   5D7A ED A0       > ldi
1697   5D7C ED A0       > ldi
1697   5D7E ED A0       > ldi
1697   5D80 ED A0       > ldi
1697   5D82 ED A0       > ldi
1697   5D84 ED A0       > ldi
1697   5D86 ED A0       > ldi
1697   5D88 ED A0       > ldi
1697   5D8A ED A0       > ldi
1697   5D8C ED A0       > ldi
1697   5D8E ED A0       > ldi
1697   5D90 ED A0       > ldi
1697   5D92 ED A0       > ldi
1697   5D94 ED A0       > ldi
1697   5D96 ED A0       > ldi
1697   5D98 ED A0       > ldi
1697   5D9A ED A0       > ldi
1697   5D9C ED A0       > ldi
1697   5D9E ED A0       > ldi
1697   5DA0 ED A0       > ldi
1697   5DA2 ED A0       > ldi
1697   5DA4 ED A0       > ldi
1697   5DA6 ED A0       > ldi
1697   5DA8 ED A0       > ldi
1697   5DAA ED A0       > ldi
1697   5DAC ED A0       > ldi
1697   5DAE ED A0       > ldi
1697   5DB0 ED A0       > ldi
1697   5DB2 ED A0       > ldi
1697   5DB4 ED A0       > ldi
1697   5DB6 ED A0       > ldi
1697   5DB8 ED A0       > ldi
1697   5DBA ED A0       > ldi
1697   5DBC ED A0       > ldi
1697   5DBE ED A0       > ldi
1697   5DC0 ED A0       > ldi
1697   5DC2 ED A0       > ldi
1697   5DC4 ED A0       > ldi
1697   5DC6 ED A0       > ldi
1697   5DC8 ED A0       > ldi
1697   5DCA ED A0       > ldi
1697   5DCC ED A0       > ldi
1697   5DCE ED A0       > ldi
1697   5DD0 ED A0       > ldi
1697   5DD2 ED A0       > ldi
1697   5DD4 ED A0       > ldi
1697   5DD6 ED A0       > ldi
1697   5DD8 ED A0       > ldi
1697   5DDA ED A0       > ldi
1697   5DDC ED A0       > ldi
1697   5DDE ED A0       > ldi
1697   5DE0 ED A0       > ldi
1697   5DE2 ED A0       > ldi
1697   5DE4 ED A0       > ldi
1697   5DE6 ED A0       > ldi
1697   5DE8 ED A0       > ldi
1697   5DEA ED A0       > ldi
1697   5DEC ED A0       > ldi
1697   5DEE ED A0       > ldi
1697   5DF0 ED A0       > ldi
1697   5DF2 ED A0       > ldi
1697   5DF4 ED A0       > ldi
1697   5DF6 ED A0       > ldi
1697   5DF8 ED A0       > ldi
1697   5DFA ED A0       > ldi
1697   5DFC ED A0       > ldi
1697   5DFE ED A0       > ldi
1697   5E00 ED A0       > ldi
1697   5E02 ED A0       > ldi
1697   5E04 ED A0       > ldi
1697   5E06 ED A0       > ldi
1697   5E08 ED A0       > ldi
1697   5E0A ED A0       > ldi
1697   5E0C ED A0       > ldi
1697   5E0E ED A0       > ldi
1697   5E10 ED A0       > ldi
1697   5E12 ED A0       > ldi
1697   5E14 ED A0       > ldi
1697   5E16 ED A0       > ldi
1697   5E18 ED A0       > ldi
1697   5E1A ED A0       > ldi
1697   5E1C ED A0       > ldi
1697   5E1E ED A0       > ldi
1697   5E20 ED A0       > ldi
1697   5E22 ED A0       > ldi
1697   5E24 ED A0       > ldi
1697   5E26 ED A0       > ldi
1697   5E28 ED A0       > ldi
1697   5E2A ED A0       > ldi
1697   5E2C ED A0       > ldi
1697   5E2E ED A0       > ldi
1697   5E30 ED A0       > ldi
1697   5E32 ED A0       > ldi
1697   5E34 ED A0       > ldi
1697   5E36 ED A0       > ldi
1697   5E38 ED A0       > ldi
1697   5E3A ED A0       > ldi
1697   5E3C ED A0       > ldi
1698   5E3E EB          	ex	de,hl
1699   5E3F 00          	nop
1700   5E40 3A 00 7B    	ld	a, (PORTSPI)	; descarta CRC
1701   5E43 00          	nop
1702   5E44 3A 00 7B    	ld	a, (PORTSPI)
1703   5E47             .fim: 
1704   5E47 AF          	xor	a		; zera carry para informar leitura sem erros
1705   5E48 C3 E6 55    	jp		terminaLeituraEscritaBloco
1706   5E4B             
1707   5E4B             ; ------------------------------------------------
1708   5E4B             ; Converte blocos para bytes. Na pratica faz
1709   5E4B             ; BC DE = (BC DE) * 512
1710   5E4B             ; ------------------------------------------------
1711   5E4B             blocoParaByte: 
1712   5E4B 41          	ld	b, c
1713   5E4C 4A          	ld	c, d
1714   5E4D 53          	ld	d, e
1715   5E4E 1E 00       	ld	e, 0
1716   5E50 CB 22       	sla	d
1717   5E52 CB 11       	rl	c
1718   5E54 CB 10       	rl	b
1719   5E56 C9          	ret
1720   5E57             
1721   5E57             ; ------------------------------------------------
1722   5E57             ; Funcoes utilitarias
1723   5E57             ; ------------------------------------------------
1724   5E57             
1725   5E57             ; ------------------------------------------------
1726   5E57             ; Imprime string na tela apontada por DE
1727   5E57             ; Destroi todos os registradores
1728   5E57             ; ------------------------------------------------
1729   5E57             printString: 
1730   5E57 1A          	ld	a, (de)
1731   5E58 B7          	or	a
1732   5E59 C8          	ret	z
1733   5E5A CD A2 00    	call	CHPUT
1734   5E5D 13          	inc	de
1735   5E5E 18 F7       	jr	printString
1736   5E60             
1737   5E60             
1738   5E60             ; ------------------------------------------------
1739   5E60             ; Converte o byte em A para string em decimal no
1740   5E60             ; buffer apontado por DE
1741   5E60             ; Destroi AF, BC, HL, DE
1742   5E60             ; ------------------------------------------------
1743   5E60             DecToAscii: 
1744   5E60 26 00       	ld	h, 0
1745   5E62 6F          	ld	l, a		; copiar A para HL
1746   5E63 FD 36 34 01 	ld	(iy+TEMP), 1	; flag para indicar que devemos cortar os zeros a esquerda
1747   5E67 01 9C FF    	ld	bc, -100	; centenas
1748   5E6A CD 78 5E    	call	.num1
1749   5E6D 0E F6       	ld	c, -10		; dezenas
1750   5E6F CD 78 5E    	call	.num1
1751   5E72 FD 36 34 02 	ld	(iy+TEMP), 2	; unidade deve exibir 0 se for zero e nao corta-lo
1752   5E76 0E FF       	ld	c, -1		; unidades
1753   5E78             .num1: 
1754   5E78 3E 2F       	ld	a, '0'-1
1755   5E7A             .num2: 
1756   5E7A 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1757   5E7B 09          	add	hl, bc		; somar com negativo
1758   5E7C 38 FC       	jr	c,.num2		; ainda nao zeramos
1759   5E7E ED 42       	sbc	hl, bc		; retoma valor original
1760   5E80 FD 35 34    	dec	(iy+TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1761   5E83 20 08       	jr	nz,.naozero
1762   5E85 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1763   5E87 20 04       	jr	nz,.naozero
1764   5E89 FD 34 34    	inc	(iy+TEMP)	; se for zero, nao salvamos e voltamos a flag
1765   5E8C C9          	ret
1766   5E8D             .naozero: 
1767   5E8D 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1768   5E8E 13          	inc	de		; incrementa ponteiro de destino
1769   5E8F C9          	ret
1770   5E90             
1771   5E90             ; ------------------------------------------------
1772   5E90             ; Converte o byte em A para string em hexa no
1773   5E90             ; buffer apontado por DE
1774   5E90             ; Destroi AF, C, DE
1775   5E90             ; ------------------------------------------------
1776   5E90             HexToAscii: 
1777   5E90 4F          	ld	c, a
1778   5E91 1F          	rra
1779   5E92 1F          	rra
1780   5E93 1F          	rra
1781   5E94 1F          	rra
1782   5E95 CD 99 5E    	call	.conv
1783   5E98 79          	ld  	a, c
1784   5E99             .conv: 
1785   5E99 E6 0F       	and	$0F
1786   5E9B C6 90       	add	a, $90
1787   5E9D 27          	daa
1788   5E9E CE 40       	adc	a, $40
1789   5EA0 27          	daa
1790   5EA1 12          	ld	(de), a
1791   5EA2 13          	inc	de
1792   5EA3 C9          	ret
1793   5EA4             
1794   5EA4             ; ------------------------------------------------
1795   5EA4             ; Converte o byte em A para string em decimal e
1796   5EA4             ; imprime na tela
1797   5EA4             ; Destroi AF, BC, HL, DE
1798   5EA4             ; ------------------------------------------------
1799   5EA4             printDecToAscii: 
1800   5EA4 26 00       	ld	h, 0
1801   5EA6 6F          	ld	l, a		; copiar A para HL
1802   5EA7 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1803   5EA9 11 9C FF    	ld	de, -100	; centenas
1804   5EAC CD B8 5E    	call	.num1
1805   5EAF 1E F6       	ld	e, -10		; dezenas
1806   5EB1 CD B8 5E    	call	.num1
1807   5EB4 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1808   5EB6 1E FF       	ld	e, -1		; unidades
1809   5EB8             .num1: 
1810   5EB8 3E 2F       	ld	a, '0'-1
1811   5EBA             .num2: 
1812   5EBA 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1813   5EBB 19          	add	hl, de		; somar com negativo
1814   5EBC 38 FC       	jr	c,.num2		; ainda nao zeramos
1815   5EBE ED 52       	sbc	hl, de		; retoma valor original
1816   5EC0 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1817   5EC2 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1818   5EC4 20 02       	jr	nz,.naozero
1819   5EC6 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1820   5EC7 C9          	ret
1821   5EC8             .naozero: 
1822   5EC8 E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1823   5EC9 C5          	push	bc
1824   5ECA CD A2 00    	call	CHPUT
1825   5ECD C1          	pop	bc
1826   5ECE E1          	pop	hl
1827   5ECF C9          	ret
1828   5ED0             
1829   5ED0             ; ------------------------------------------------
1830   5ED0             ; Procura pelo nome do fabricante em uma tabela.
1831   5ED0             ; A contem o byte do fabricante
1832   5ED0             ; Devolve HL apontando para o buffer do fabricante
1833   5ED0             ; e BC com o comprimento do texto
1834   5ED0             ; Destroi AF, BC, HL
1835   5ED0             ; ------------------------------------------------
1836   5ED0             pegaFabricante: 
1837   5ED0 4F          	ld	c, a
1838   5ED1 21 F2 5E    	ld	hl, tblFabricantes
1839   5ED4             
1840   5ED4             .loop: 
1841   5ED4 7E          	ld	a, (hl)
1842   5ED5 23          	inc	hl
1843   5ED6 B9          	cp	c
1844   5ED7 28 0C       	jr	z,.achado
1845   5ED9 B7          	or	a
1846   5EDA 28 09       	jr	z,.achado
1847   5EDC C5          	push	bc
1848   5EDD CD E5 5E    	call	.achado
1849   5EE0 09          	add	hl, bc
1850   5EE1 23          	inc	hl
1851   5EE2 C1          	pop	bc
1852   5EE3 18 EF       	jr	.loop
1853   5EE5             
1854   5EE5             .achado: 
1855   5EE5 0E 00       	ld	c, 0
1856   5EE7 E5          	push	hl
1857   5EE8 AF          	xor	a
1858   5EE9             .loop2: 
1859   5EE9 0C          	inc	c
1860   5EEA 23          	inc	hl
1861   5EEB BE          	cp	(hl)
1862   5EEC 20 FB       	jr	nz,.loop2
1863   5EEE E1          	pop	hl
1864   5EEF 06 00       	ld	b, 0
1865   5EF1 C9          	ret
1866   5EF2             
1867   5EF2             ; ---------------------------------------------------------------------------
1868   5EF2             tblFabricantes: 
1869   5EF2 01          	db	1
1870   5EF3             	db	"Panasonic",0
1870   5EF3 50616E61736F6E696300
1871   5EFD 02          	db	2
1872   5EFE             	db	"Toshiba",0
1872   5EFE 546F736869626100
1873   5F06 03          	db	3
1874   5F07             	db	"SanDisk",0
1874   5F07 53616E4469736B00
1875   5F0F 04          	db	4
1876   5F10             	db	"SMI-S",0
1876   5F10 534D492D5300
1877   5F16 06          	db	6
1878   5F17             	db	"Renesas",0
1878   5F17 52656E6573617300
1879   5F1F 11          	db	17
1880   5F20             	db	"Dane-Elec",0
1880   5F20 44616E652D456C656300
1881   5F2A 13          	db	19
1882   5F2B             	db	"KingMax",0
1882   5F2B 4B696E674D617800
1883   5F33 15          	db	21
1884   5F34             	db	"Samsung",0
1884   5F34 53616D73756E6700
1885   5F3C 18          	db	24
1886   5F3D             	db	"Infineon",0
1886   5F3D 496E66696E656F6E00
1887   5F46 1A          	db	26
1888   5F47 50 51 49 00 	db	"PQI",0
1889   5F4B 1B          	db	27
1890   5F4C 536F6E7900  	db	"Sony",0
1891   5F51 1C          	db	28
1892   5F52             	db	"Transcend",0
1892   5F52 5472616E7363656E6400
1893   5F5C 1D          	db	29
1894   5F5D             	db	"A-DATA",0
1894   5F5D 412D4441544100
1895   5F64 1F          	db	31
1896   5F65             	db	"SiliconPower",0
1896   5F65 53696C69636F6E506F77657200
1897   5F72 27          	db	39
1898   5F73             	db	"Verbatim",0
1898   5F73 566572626174696D00
1899   5F7C 41          	db	65
1900   5F7D 4F 4B 49 00 	db	"OKI",0
1901   5F81 73          	db	115
1902   5F82             	db	"SilverHT",0
1902   5F82 53696C766572485400
1903   5F8B 89          	db	137
1904   5F8C             	db	"L.Data",0
1904   5F8C 4C2E4461746100
1905   5F93 00          	db	0
1906   5F94             	db	"Generico",0
1906   5F94 47656E657269636F00
1907   5F9D             
1908   5F9D             ; ------------------------------------------------
1909   5F9D             strTitle: 
1910   5F9D             	db	"FBLabs SDHC driver "
1910   5F9D 46424C61627320534448432064726976657220
1911   5FB0             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
1911   5FB0 76312E302E35
1912   5FB6 0D 0A 00    	db	13,10,0
1913   5FB9             
1914   5FB9             strBootpaused: 
1915   5FB9             	db	"Paused. Press <i> to show the copyright info.",13,10,0
1915   5FB9 5061757365642E205072657373203C693E20746F2073686F772074686520636F
1915   5FD9 7079726967687420696E666F2E0D0A00
1916   5FE9             
1917   5FE9             strCopyright: 
1918   5FE9             	db	"Copyright (c) 2014 Fabio Belavenuto",13,10
1918   5FE9 436F7079726967687420286329203230313420466162696F2042656C6176656E
1918   6009 75746F0D0A
1919   600E             	db	"Licenced under CERN OHL v1.1",13,10
1919   600E 4C6963656E63656420756E646572204345524E204F484C2076312E310D0A
1920   602C             	db	"http://ohwr.org/cernohl",13,10
1920   602C 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
1921   6045             	db	"PCB designed by Luciano Sturaro",13,10
1921   6045 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
1921   6065 0A
1922   6066             	; fall throw
1923   6066             strCrLf: 
1924   6066 0D 0A 00    	db	13,10,0
1925   6069             strCartao: 
1926   6069             	db	"Slot ",0
1926   6069 536C6F742000
1927   606F             strVazio: 
1928   606F             	db	"Empty",13,10,0
1928   606F 456D7074790D0A00
1929   6077             strNaoIdentificado: 
1930   6077             	db	"Unknown!",13,10,0
1930   6077 556E6B6E6F776E210D0A00
1931   6082             			;----------------------------------------
1932   6082             strMr_mp_desativada: 
1933   6082             	db	"Slot expander/Mapper/MegaRAM disabled",13,10,0
1933   6082 536C6F7420657870616E6465722F4D61707065722F4D65676152414D20646973
1933   60A2 61626C65640D0A00
1934   60AA             strMapper: 
1935   60AA             	db	"Slot expanded and Memory Mapper enabled",13,10,0
1935   60AA 536C6F7420657870616E64656420616E64204D656D6F7279204D617070657220
1935   60CA 656E61626C65640D0A00
1936   60D4             strMegaram: 
1937   60D4             	db	"Slot expander and MegaRAM enabled",13,10,0
1937   60D4 536C6F7420657870616E64657220616E64204D65676152414D20656E61626C65
1937   60F4 640D0A00
1938   60F8             strSDV1: 
1939   60F8             	db	"SDV1 - ",0
1939   60F8 53445631202D2000
1940   6100             strSDV2: 
1941   6100             	db	"SDV2 - ",0
1941   6100 53445632202D2000
1942   6108             
1943   6108             ;-----------------------------------------------------------------------------
1944   6108             ;
1945   6108             ; End of the driver code
1946   6108             
1947   6108             DRV_END: 
1948   6108             
1949   6108 FF          	ds	3ED0h-(DRV_END-DRV_START), $FF
1950   7FD0             
1951   7FD0             
