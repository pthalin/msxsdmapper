0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 7B00h~7EFFh	: SPI data transfer window (read/write)
0015   0000             ; 7F00h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	If no SD card is selected:
0018   0000             ;	b7-b2 : always 0
0019   0000             ;	b1 : SW1 status (Driver selection)
0020   0000             ;	b0 : SW0 status. 0=RAM disabled, 1=RAM enabled
0021   0000             ;	If any SD card is selected:
0022   0000             ;	b7-b3 : always 0
0023   0000             ;	b2 : 1=Write protecton enabled for SD card slot selected
0024   0000             ;	b1 : 0=SD card present on slot selected
0025   0000             ;	b0 : 1=SD Card on slot selected changed since last read
0026   0000             ;	<write>
0027   0000             ;	b0	: SD card slot-0 chip-select (1=selected)
0028   0000             ;	b1	: SD card slot-1 chip-select (1=selected)
0029   0000             
0030   0000             ; 7F02h		: 8-bit timer (97.65625 KHz frequency, 10.24uS resolution) (read/write)
0031   0000             ; When a value is written, the timer will decrease it until it reaches zero
0032   0000             
0033   0000             	output	"driver.bin"
0034   0000             
0035   0000             ;-----------------------------------------------------------------------------
0036   0000             ;
0037   0000             ; Driver configuration constants
0038   0000             ;
0039   0000             
0040   0000             ;Driver type:
0041   0000             ;   0 for drive-based
0042   0000             ;   1 for device-based
0043   0000             
0044   0000             DRV_TYPE	equ	1
0045   0000             
0046   0000             ;Hot-plug devices support (device-based drivers only):
0047   0000             ;   0 for no hot-plug support
0048   0000             ;   1 for hot-plug support
0049   0000             
0050   0000             DRV_HOTPLUG	equ	0
0051   0000             
0052   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0053   0000             
0054   0000             ;Driver version
0055   0000             
0056   0000             VER_MAIN	equ	1
0057   0000             VER_SEC		equ	0
0058   0000             VER_REV		equ	8
0059   0000             
0060   0000             ;-----------------------------------------------------------------------------
0061   0000             ; SPI addresses. Check the Technical info above for the bit contents
0062   0000             
0063   0000             SPIDATA		= $7B00
0064   0000             SPICTRL		= $7FF0
0065   0000             SPISTATUS	= $7FF0
0066   0000             TIMERREG	= $7FF1
0067   0000             
0068   0000             ; Interface status flags
0069   0000             IF_RAM		= 0		; 1=Interface RAM is enabled
0070   0000             IF_DRVER	= 1		; RAM mode: 0=MegaRAM, 1=MemoryMapper
0071   0000             IF_M_RAM	= (1 shl IF_RAM)		; bitmask for IF_RAM
0072   0000             IF_M_DRVER	= (1 shl IF_DRVER)		; bitmask for IF_DRVER
0073   0000             
0074   0000             ; card slot status flags
0075   0000             SD_DSKCHG	= 0		; SD card changed since last status check
0076   0000             SD_PRESENT	= 1		; SD card present
0077   0000             SD_WRTPROT	= 2		; SD card is write protected
0078   0000             SD_M_DSKCHG	= (1 shl SD_DSKCHG)		; bitmask for SD_DSKCHG
0079   0000             SD_M_PRESENT	= (1 shl SD_PRESENT)		; bitmask for SD_PRESENT
0080   0000             SD_M_WRTPROT	= (1 shl SD_WRTPROT)		; bitmask for SD_WRTPROT
0081   0000             
0082   0000             ; SPI commands: 
0083   0000             CMD0	= 0  | $40
0084   0000             CMD1	= 1  | $40
0085   0000             CMD8	= 8  | $40
0086   0000             CMD9	= 9  | $40
0087   0000             CMD10	= 10 | $40
0088   0000             CMD12	= 12 | $40
0089   0000             CMD16	= 16 | $40
0090   0000             CMD17	= 17 | $40
0091   0000             CMD18	= 18 | $40
0092   0000             CMD24	= 24 | $40
0093   0000             CMD25	= 25 | $40
0094   0000             CMD55	= 55 | $40
0095   0000             CMD58	= 58 | $40
0096   0000             ACMD23	= 23 | $40
0097   0000             ACMD41	= 41 | $40
0098   0000             
0099   0000             ; Work area variables 
0100   0000              STRUCT WRKAREA
0101   0000~            BCSD 		ds 16	; Card Specific Data
0102   0000~            BCID1		ds 16	; Card-ID of card1
0103   0000~            BCID2		ds 16	; Card-ID of card2
0104   0000~            NUMSD		db 	; Currently selected card: 1 or 2 
0105   0000~            CARDFLAGS	db 	; Flags that indicate card-change or card error 
0106   0000~            NUMBLOCKS	db 	; Number of blocks in multi-block operations 
0107   0000~            BLOCKS1		ds 3	; 3 bytes. Size of card1, in blocks.
0108   0000~            BLOCKS2		ds 3	; 3 bytes. Size of card2, in blocks.
0109   0000~            TEMP		db	; Temporary data
0110   0000~            TRLDIR		ds 8	; R800 data transfer helper 
0111   0000              ENDS
0112   0000             
0113   0000             
0114   0000             ;-----------------------------------------------------------------------------
0115   0000             ;
0116   0000             ; Standard BIOS and work area entries
0117   0000             INITXT	= $006C		; Inicializa SCREEN0
0118   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0119   0000             CHGET	= $009F		; Get character from keyboard buffer
0120   0000             CHPUT	= $00A2		; A=char
0121   0000             CLS	= $00C3		; Chamar com A=0
0122   0000             ERAFNK	= $00CC		; Erase function key display
0123   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0124   0000             KILBUF	= $0156		; Clear keyboard buffer
0125   0000             EXTROM	= $015F
0126   0000             CHGCPU	= #0180
0127   0000             GETCPU	= #0183
0128   0000             
0129   0000             ; subROM functions
0130   0000             SDFSCR	= $0185
0131   0000             REDCLK	= $01F5
0132   0000             
0133   0000             
0134   0000             ; System variables
0135   0000             MSXVER	= $002D
0136   0000             LINL40	= $F3AE		; Width
0137   0000             LINLEN	= $F3B0
0138   0000             INTFLG	= $FC9B
0139   0000             SCRMOD	= $FCAF
0140   0000             
0141   0000             
0142   0000             ;-----------------------------------------------------------------------------
0143   0000             
0144   0000             
0145   0000             	org		$4000
0146   4000             
0147   4000 FF          	ds		256, $FF		; 256 dummy bytes
0148   4100             
0149   4100             DRV_START: 
0150   4100             
0151   4100             ;-----------------------------------------------------------------------------
0152   4100             ;
0153   4100             ; Miscellaneous constants
0154   4100             ;
0155   4100             
0156   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0157   4100             ;It is used by some of the kernel page 0 routines.
0158   4100             
0159   4100             CODE_ADD: 	equ	0F84Ch
0160   4100             
0161   4100             
0162   4100             ;-----------------------------------------------------------------------------
0163   4100             ;
0164   4100             ; Error codes for DEV_RW
0165   4100             ;
0166   4100             
0167   4100             ENCOMP	equ	0FFh
0168   4100             EWRERR	equ	0FEh
0169   4100             EDISK	equ	0FDh
0170   4100             ENRDY	equ	0FCh
0171   4100             EDATA	equ	0FAh
0172   4100             ERNF	equ	0F9h
0173   4100             EWPROT	equ	0F8h
0174   4100             EUFORM	equ	0F7h
0175   4100             ESEEK	equ	0F3h
0176   4100             EIFORM	equ	0F0h
0177   4100             EIDEVL	equ	0B5h
0178   4100             EIPARM	equ	08Bh
0179   4100             
0180   4100             ;-----------------------------------------------------------------------------
0181   4100             ;
0182   4100             ; Routines and information available on kernel page 0
0183   4100             ;
0184   4100             
0185   4100             ;* Get in A the current slot for page 1. Corrupts F.
0186   4100             ;  Must be called by using CALBNK to bank 0:
0187   4100             ;    xor a
0188   4100             ;    ld ix,GSLOT1
0189   4100             ;    call CALBNK
0190   4100             
0191   4100             GSLOT1	equ	402Dh
0192   4100             
0193   4100             
0194   4100             ;* This routine reads a byte from another bank.
0195   4100             ;  Must be called by using CALBNK to the desired bank,
0196   4100             ;  passing the address to be read in HL:
0197   4100             ;    ld a,<bank number>
0198   4100             ;    ld hl,<byte address>
0199   4100             ;    ld ix,RDBANK
0200   4100             ;    call CALBNK
0201   4100             
0202   4100             RDBANK	equ	403Ch
0203   4100             
0204   4100             
0205   4100             ;* This routine temporarily switches kernel main bank
0206   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0207   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0208   4100             ;  It is necessary to use this routine to invoke CALBAS
0209   4100             ;  (so that kernel bank is correct in case of BASIC error)
0210   4100             ;  and to invoke DOS functions via F37Dh hook.
0211   4100             ;
0212   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0213   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0214   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0215   4100             
0216   4100             CALLB0	equ	403Fh
0217   4100             
0218   4100             
0219   4100             ;* Call a routine in another bank.
0220   4100             ;  Must be used if the driver spawns across more than one bank.
0221   4100             ;
0222   4100             ;  Input:  A = bank number
0223   4100             ;          IX = routine address
0224   4100             ;          AF' = AF for the routine
0225   4100             ;          HL' = Ix for the routine
0226   4100             ;          BC, DE, HL, IY = input for the routine
0227   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0228   4100             
0229   4100             CALBNK	equ	4042h
0230   4100             
0231   4100             
0232   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0233   4100             ;  which will in turn contain a pointer to the allocated page 3
0234   4100             ;  work area for that slot (0 if no work area was allocated).
0235   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0236   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0237   4100             ;  Corrupts F.
0238   4100             ;  Must be called by using CALBNK to bank 0:
0239   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0240   4100             ;    ex af,af'
0241   4100             ;    xor a
0242   4100             ;    ld ix,GWORK
0243   4100             ;    call CALBNK
0244   4100             
0245   4100             GWORK	equ	4045h
0246   4100             
0247   4100             
0248   4100             ;* This address contains one byte that tells how many banks
0249   4100             ;  form the Nextor kernel (or alternatively, the first bank
0250   4100             ;  number of the driver).
0251   4100             
0252   4100             K_SIZE	equ	40FEh
0253   4100             
0254   4100             
0255   4100             ;* This address contains one byte with the current bank number.
0256   4100             
0257   4100             CUR_BANK	equ	40FFh
0258   4100             
0259   4100             
0260   4100             ;-----------------------------------------------------------------------------
0261   4100             ;
0262   4100             ; Built-in format choice strings
0263   4100             ;
0264   4100             
0265   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0266   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0267   4100             
0268   4100             
0269   4100             ;-----------------------------------------------------------------------------
0270   4100             ;
0271   4100             ; Driver signature
0272   4100             ;
0273   4100             	db	"NEXTOR_DRIVER",0
0273   4100 4E4558544F525F44524956455200
0274   410E             
0275   410E             
0276   410E             ;-----------------------------------------------------------------------------
0277   410E             ;
0278   410E             ; Driver flags:
0279   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0280   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0281   410E             
0282   410E 01          	db 1+(2*DRV_HOTPLUG)
0283   410F             
0284   410F             ;-----------------------------------------------------------------------------
0285   410F             ;
0286   410F             ; Reserved byte
0287   410F             ;
0288   410F 00          	db	0
0289   4110             
0290   4110             ;-----------------------------------------------------------------------------
0291   4110             ;
0292   4110             ; Driver name
0293   4110             ;
0294   4110             
0295   4110             DRV_NAME: 
0296   4110             	db	"FBLabs SDHC"
0296   4110 46424C6162732053444843
0297   411B 20          	ds	32-($-DRV_NAME)," "
0298   4130             
0299   4130             
0300   4130             ;-----------------------------------------------------------------------------
0301   4130             ;
0302   4130             ; Jump table for the driver public routines
0303   4130             ;
0304   4130             
0305   4130             	; These routines are mandatory for all drivers
0306   4130                     ; (but probably you need to implement only DRV_INIT)
0307   4130             
0308   4130 C3 6C 41    	jp	DRV_TIMI
0309   4133 C3 40 42    	jp	DRV_VERSION
0310   4136 C3 6D 41    	jp	DRV_INIT
0311   4139 C3 47 42    	jp	DRV_BASSTAT
0312   413C C3 49 42    	jp	DRV_BASDEV
0313   413F C3 4B 42    	jp	DRV_EXTBIO
0314   4142 C3 4C 42    	jp	DRV_DIRECT0
0315   4145 C3 4C 42    	jp	DRV_DIRECT1
0316   4148 C3 4C 42    	jp	DRV_DIRECT2
0317   414B C3 4C 42    	jp	DRV_DIRECT3
0318   414E C3 4C 42    	jp	DRV_DIRECT4
0319   4151             
0320   4151 00          	ds	15
0321   4160             
0322   4160             	; These routines are mandatory for device-based drivers
0323   4160             
0324   4160 C3 4D 42    	jp	DEV_RW
0325   4163 C3 CF 42    	jp	DEV_INFO
0326   4166 C3 57 43    	jp	DEV_STATUS
0327   4169 C3 98 43    	jp	LUN_INFO
0328   416C             
0329   416C             
0330   416C             ;=====
0331   416C             ;=====  END of data that must be at fixed addresses
0332   416C             ;=====
0333   416C             
0334   416C             
0335   416C             ;-----------------------------------------------------------------------------
0336   416C             ;
0337   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0338   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0339   416C             
0340   416C             DRV_TIMI: 
0341   416C C9          	ret
0342   416D             
0343   416D             ;-----------------------------------------------------------------------------
0344   416D             ;
0345   416D             ; Driver initialization routine, it is called twice:
0346   416D             ;
0347   416D             ; 1) First execution, for information gathering.
0348   416D             ;    Input:
0349   416D             ;      A = 0
0350   416D             ;      B = number of available drives
0351   416D             ;      HL = maximum size of allocatable work area in page 3
0352   416D             ;    Output:
0353   416D             ;      A = number of required drives (for drive-based driver only)
0354   416D             ;      HL = size of required work area in page 3
0355   416D             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0356   416D             ;
0357   416D             ; 2) Second execution, for work area and hardware initialization.
0358   416D             ;    Input:
0359   416D             ;      A = 1
0360   416D             ;      B = number of allocated drives for this controller
0361   416D             ;
0362   416D             ;    The work area address can be obtained by using GWORK.
0363   416D             ;
0364   416D             ;    If first execution requests more work area than available,
0365   416D             ;    second execution will not be done and DRV_TIMI will not be hooked
0366   416D             ;    to the timer interrupt.
0367   416D             ;
0368   416D             ;    If first execution requests more drives than available,
0369   416D             ;    as many drives as possible will be allocated, and the initialization
0370   416D             ;    procedure will continue the normal way
0371   416D             ;    (for drive-based drivers only. Device-based drivers always
0372   416D             ;     get two allocated drives.)
0373   416D             
0374   416D             DRV_INIT: 
0375   416D B7          	or	a		; Is this the 1st call? 
0376   416E 20 0F       	jr	nz,.call2
0377   4170             ; 1st call:
0378   4170 21 3A 00    	ld	hl,WRKAREA.TRLDIR ; size of work area needed for the Z80
0379   4173 3A 2D 00    	ld	a,(MSXVER)
0380   4176 FE 03       	cp	3		; MSX Turbo-R?
0381   4178 3F          	ccf
0382   4179 D0          	ret	nc		; No, return with Cy off
0383   417A 21 42 00    	ld	hl,WRKAREA	; size of work area needed for the TR
0384   417D B7          	or	a		; Clear Cy
0385   417E C9          	ret
0386   417F             
0387   417F             
0388   417F             .call2: 
0389   417F             ; 2nd call: 
0390   417F             .call2ini: 
0391   417F CD DA 58           	call	MYSETSCR		; Set the screen mode
0392   4182 CD D7 43    	call	pegaWorkArea		; HL=IY=Work area pointer
0393   4185             
0394   4185 11 8F 59    	ld	de,strTitle		; prints the title 
0395   4188 CD 94 57    	call	printString
0396   418B             
0397   418B             
0398   418B             .sdhcinit: 	; FBLabs SDHC Interface initialization
0399   418B CD 22 42    	call	.printmode		; Print the switches configuration
0400   418E AF          	xor	a			; zera flags do cartao
0401   418F FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
0402   4192             
0403   4192 3E 01       	ld	a, 1			; detectar cartao 1
0404   4194 CD AD 41    	call	.detecta
0405   4197 3E 02       	ld	a, 2			; detectar cartao 2
0406   4199 CD AD 41    	call	.detecta
0407   419C 01 00 00    	ld	bc, 0
0408   419F 1E 05       	ld	e, 5
0409   41A1             
0410   41A1 CD 6D 59    	call	INSTR800HLP		; Install R800 data copy on workarea
0411   41A4             
0412   41A4 CD 1E 59    	call	INICHKSTOP		; Check if the STOP key was pressed
0413   41A7             
0414   41A7 11 5F 5A    	ld	de, strCrLf
0415   41AA C3 94 57    	jp	printString
0416   41AD             
0417   41AD             .detecta: 
0418   41AD FD 77 30    	ld	(iy+WRKAREA.NUMSD), a	; Save the requested card slot
0419   41B0 11 62 5A    	ld	de, strCartao
0420   41B3 CD 94 57    	call	printString
0421   41B6 FD 4E 30    	ld	c, (iy+WRKAREA.NUMSD)
0422   41B9 79          	ld	a,c
0423   41BA C6 30       	add	'0'
0424   41BC CD A2 00    	call	CHPUT
0425   41BF 3E 3A       	ld	a, ':'
0426   41C1 CD A2 00    	call	CHPUT
0427   41C4 3E 20       	ld	a, ' '
0428   41C6 CD A2 00    	call	CHPUT
0429   41C9 79          	ld	a,c			; Get card slot#
0430   41CA             ;	cpl				; invert bits
0431   41CA             ;	and	3
0432   41CA 32 F0 7F    	ld	(SPICTRL), a		; Select card slot
0433   41CD 3A F0 7F    	ld	a, (SPISTATUS)		; get card slot status
0434   41D0 CD A4 45    	call	disableSDs
0435   41D3 E6 02       	and	SD_M_PRESENT		; Is there an card present?
0436   41D5 28 06       	jr	z,.naoVazio		; Yes, skip
0437   41D7 11 68 5A    	ld	de, strVazio		; Empty SD card slot message
0438   41DA C3 94 57    	jp	printString
0439   41DD             ;	jp	.marcaErro
0440   41DD             .naoVazio: 
0441   41DD CD 57 44    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0442   41E0 30 09       	jr	nc,.detectou
0443   41E2 CD A4 45    	call	disableSDs
0444   41E5 11 70 5A    	ld	de, strNaoIdentificado
0445   41E8 C3 94 57    	jp	printString
0446   41EB             ;.marcaErro:
0447   41EB             ;	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0448   41EB             .detectou: 
0449   41EB CD 2F 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0450   41EE DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0451   41F1 11 D8 5A    	ld	de, strSDV1	; e imprimir
0452   41F4 B7          	or	a
0453   41F5 28 03       	jr	z,.pula1
0454   41F7 11 E0 5A    	ld	de, strSDV2
0455   41FA             .pula1: 
0456   41FA CD 94 57    	call	printString
0457   41FD 3E 28       	ld	a,'('
0458   41FF CD A2 00    	call	CHPUT
0459   4202 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0460   4205 CD E1 57    	call	printDecToAscii	; Imprimir Manufacturer ID
0461   4208 3E 29       	ld	a,')'
0462   420A CD A2 00    	call	CHPUT
0463   420D 3E 20       	ld	a,' '
0464   420F CD A2 00    	call	CHPUT
0465   4212 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0466   4215 CD 0D 58    	call	pegaFabricante	; achar nome do fabricante
0467   4218 EB          	ex	de,hl
0468   4219 CD 94 57    	call	printString	; e imprimir
0469   421C 11 5F 5A    	ld	de,strCrLf
0470   421F C3 94 57    	jp	printString
0471   4222             
0472   4222             
0473   4222             .printmode: 		; Print the two switches configuration
0474   4222 AF          	xor	a			; 0=Interface status
0475   4223 32 F0 7F    	ld	(SPICTRL),a
0476   4226 3A F0 7F    	ld	a, (SPISTATUS)		; Check if the mapper/megaRAM is active
0477   4229 E6 01       	and	IF_M_RAM		; Is the RAM enabled?
0478   422B 11 7B 5A    	ld	de,strMr_mp_desativada
0479   422E 28 0D       	jr	z,.print		; No, skip
0480   4230 3A F0 7F    	ld	a, (SPISTATUS)		; ativa, testar se eh mapper ou megaram
0481   4233 E6 02       	and	IF_M_DRVER
0482   4235 11 A3 5A    	ld	de,strDrvMain
0483   4238 20 03       	jr	nz,.print
0484   423A 11 BA 5A    	ld	de, strDrvDev
0485   423D             .print: 
0486   423D C3 94 57    	jp	printString
0487   4240             
0488   4240             ;-----------------------------------------------------------------------------
0489   4240             ;
0490   4240             ; Obtain driver version
0491   4240             ;
0492   4240             ; Input:  -
0493   4240             ; Output: A = Main version number
0494   4240             ;         B = Secondary version number
0495   4240             ;         C = Revision number
0496   4240             
0497   4240             DRV_VERSION: 
0498   4240 3E 01       	ld	a, VER_MAIN
0499   4242 06 00       	ld	b, VER_SEC
0500   4244 0E 08       	ld	c, VER_REV
0501   4246 C9          	ret
0502   4247             
0503   4247             
0504   4247             ;-----------------------------------------------------------------------------
0505   4247             ;
0506   4247             ; BASIC expanded statement ("CALL") handler.
0507   4247             ; Works the expected way, except that if invoking CALBAS is needed,
0508   4247             ; it must be done via the CALLB0 routine in kernel page 0.
0509   4247             
0510   4247             DRV_BASSTAT: 
0511   4247 37          	scf
0512   4248 C9          	ret
0513   4249             
0514   4249             
0515   4249             ;-----------------------------------------------------------------------------
0516   4249             ;
0517   4249             ; BASIC expanded device handler.
0518   4249             ; Works the expected way, except that if invoking CALBAS is needed,
0519   4249             ; it must be done via the CALLB0 routine in kernel page 0.
0520   4249             
0521   4249             DRV_BASDEV: 
0522   4249 37          	scf
0523   424A C9          	ret
0524   424B             
0525   424B             ;-----------------------------------------------------------------------------
0526   424B             ;
0527   424B             ; Extended BIOS hook.
0528   424B             ; Works the expected way, except that it must return
0529   424B             ; D'=1 if the old hook must be called, D'=0 otherwise.
0530   424B             ; It is entered with D'=1.
0531   424B             
0532   424B             DRV_EXTBIO: 
0533   424B C9          	ret
0534   424C             
0535   424C             ;-----------------------------------------------------------------------------
0536   424C             ;
0537   424C             ; Direct calls entry points.
0538   424C             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0539   424C             ; in kernel banks 0 and 3 will be redirected
0540   424C             ; to DIRECT0/1/2/3/4 respectively.
0541   424C             ; Receives all register data from the caller except IX and AF'.
0542   424C             
0543   424C             DRV_DIRECT0: 
0544   424C             DRV_DIRECT1: 
0545   424C             DRV_DIRECT2: 
0546   424C             DRV_DIRECT3: 
0547   424C             DRV_DIRECT4: 
0548   424C C9          	ret
0549   424D             
0550   424D             
0551   424D             ;=====
0552   424D             ;=====  BEGIN of DEVICE-BASED specific routines
0553   424D             ;=====
0554   424D             
0555   424D             ;-----------------------------------------------------------------------------
0556   424D             ;
0557   424D             ; Read or write logical sectors from/to a logical unit
0558   424D             ;
0559   424D             ;Input:    Cy=0 to read, 1 to write
0560   424D             ;          A = Device number, 1 to 7
0561   424D             ;          B = Number of sectors to read or write
0562   424D             ;          C = Logical unit number, 1 to 7
0563   424D             ;          HL = Source or destination memory address for the transfer
0564   424D             ;          DE = Address where the 4 byte sector number is stored.
0565   424D             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0566   424D             ;              0: Ok
0567   424D             ;              .IDEVL: Invalid device or LUN
0568   424D             ;              .NRDY: Not ready
0569   424D             ;              .DISK: General unknown disk error
0570   424D             ;              .DATA: CRC error when reading
0571   424D             ;              .RNF: Sector not found
0572   424D             ;              .UFORM: Unformatted disk
0573   424D             ;              .WPROT: Write protected media, or read-only logical unit
0574   424D             ;              .WRERR: Write error
0575   424D             ;              .NCOMP: Incompatible disk.
0576   424D             ;              .SEEK: Seek error.
0577   424D             ;          B = Number of sectors actually read (in case of error only)
0578   424D             
0579   424D             DEV_RW: 
0580   424D F5          	push	af
0581   424F BF FE 03    	cp	a, 3		; somente 2 dispositivos
0582   4251 30 1C       	jr	nc,.saicomerroidl
0583   4253 0D          	dec	c		; somente 1 logical unit
0584   4254 20 19       	jr	nz,.saicomerroidl
0585   4256 CD D7 43    	call	pegaWorkArea	; IY=Work area pointer
0586   4259 FD 77 30    	ld	(iy+WRKAREA.NUMSD),a
0587   425C FD 70 32    	ld	(iy+WRKAREA.NUMBLOCKS),b	; save the number of blocks to transfer 
0588   425F CD 46 46    	call	setaSDAtual
0589   4262 3A F0 7F    	ld	a,(SPISTATUS)	; Get this card slot status
0590   4265 E6 02       	and	SD_M_PRESENT	; Is ther a card present?
0591   4267 28 0C       	jr	z,.cardok	; Yes, skip
0592   4269 F1          	pop	af
0593   426A 3E FC       	ld	a, ENRDY	; Not ready
0594   426C 06 00       	ld	b, 0
0595   426E C9          	ret
0596   426F             .saicomerroidl: 
0597   426F F1          	pop	af
0598   4270 3E B5       	ld	a, EIDEVL	; error: Invalid device or LUN 
0599   4272 06 00       	ld	b, 0
0600   4274 C9          	ret
0601   4275             .cardok: 
0602   4275             ;	exx
0603   4275 D5 E5       	push	de,hl
0604   4277 CD 2F 44    	call	calculaCIDoffset	; ix=CID offset 
0605   427A DD 7E 0F    	ld	a,(ix+15)	; verificar se eh SDV1 ou SDV2
0606   427D DD 6F       	ld	ixl,a		; ixl=SDcard version
0607   427F E1 D1       	pop	hl,de
0608   4281 F1          	pop	af		; a=Device number, f=read/write flag 
0609   4282             ;	exx			; hl=Source/dest Address, de=Pointer to sect#
0610   4282             ;	ld	ixh, b 		; ixh=Number of blocks to transfer
0611   4282 38 1F       	jr	c,escrita	; Skip if it's a write operation 
0612   4284             leitura: 
0613   4284 1A          	ld	a, (de)		; 1. n. bloco
0614   4285 F5          	push	af
0615   4286 13          	inc	de
0616   4287 1A          	ld	a, (de)		; 2. n. bloco
0617   4288 F5          	push	af
0618   4289 13          	inc	de
0619   428A 1A          	ld	a, (de)		; 3. n. bloco
0620   428B 4F          	ld	c, a
0621   428C 13          	inc	de
0622   428D 1A          	ld	a, (de)		; 4. n. bloco
0623   428E 13          	inc	de
0624   428F 47          	ld	b, a
0625   4290 F1          	pop	af
0626   4291 57          	ld	d, a
0627   4292 F1          	pop	af		; HL = ponteiro destino
0628   4293 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0629   4294 CD 15 4F    	call	LerBloco	; chamar rotina de leitura de dados
0630   4297 30 08       	jr	nc,.ok
0631   4299 CD 18 44    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0632   429C             ;	ld	a, ENRDY	; Not ready
0633   429C 3E FD       	ld	a, EDISK	; General unknown disk error
0634   429E 06 00       	ld	b, 0		; informar que lemos 0 blocos
0635   42A0 C9          	ret
0636   42A1             .ok: 
0637   42A1 AF          	xor	a		; tudo OK, informar ao Nextor
0638   42A2 C9          	ret
0639   42A3             
0640   42A3             escrita: 
0641   42A3             	; Test if the card is write protected
0642   42A3 3A F0 7F    	ld	a,(SPISTATUS)	; Get this card slot status
0643   42A6 E6 04       	and	SD_M_WRTPROT	; Is the card write protected?
0644   42A8 28 05       	jr	z,.ok
0645   42AA 3E F8       	ld	a, EWPROT	; disco protegido
0646   42AC 06 00       	ld	b,0		; 0 blocks were written
0647   42AE C9          	ret
0648   42AF             .ok: 
0649   42AF 1A          	ld	a, (de)		; 1. n. bloco
0650   42B0 F5          	push	af
0651   42B1 13          	inc	de
0652   42B2 1A          	ld	a, (de)		; 2. n. bloco
0653   42B3 F5          	push	af
0654   42B4 13          	inc	de
0655   42B5 1A          	ld	a, (de)		; 3. n. bloco
0656   42B6 13          	inc	de
0657   42B7 4F          	ld	c, a
0658   42B8 1A          	ld	a, (de)		; 4. n. bloco
0659   42B9 13          	inc	de
0660   42BA 47          	ld	b, a
0661   42BB F1          	pop	af
0662   42BC 57          	ld	d, a
0663   42BD F1          	pop	af		; HL = ponteiro destino
0664   42BE 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0665   42BF CD 52 46    	call	GravarBloco	; chamar rotina de gravacao de dados
0666   42C2 30 09       	jr	nc,.ok2
0667   42C4             ;	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0668   42C4 FD 7E 32    	ld	a,(iy+WRKAREA.NUMBLOCKS) ; Get the number of requested blocks
0669   42C7 DD 94       	sub	ixh		; subtract the number of remaining blocks
0670   42C9 47          	ld	b,a		; b=number of blocks written
0671   42CA 3E FE       	ld	a,EWRERR	; Write error
0672   42CC C9          	ret
0673   42CD             .ok2: 
0674   42CD AF          	xor	a			; gravacao sem erros!
0675   42CE C9          	ret
0676   42CF             
0677   42CF             ;-----------------------------------------------------------------------------
0678   42CF             ;
0679   42CF             ; Device information gathering
0680   42CF             ;
0681   42CF             ;Input:   A = Device index, 1 to 7
0682   42CF             ;         B = Information to return:
0683   42CF             ;             0: Basic information
0684   42CF             ;             1: Manufacturer name string
0685   42CF             ;             2: Device name string
0686   42CF             ;             3: Serial number string
0687   42CF             ;         HL = Pointer to a buffer in RAM
0688   42CF             ;Output:  A = Error code:
0689   42CF             ;             0: Ok
0690   42CF             ;             1: Device not available or invalid device index
0691   42CF             ;             2: Information not available, or invalid information index
0692   42CF             ;         When basic information is requested,
0693   42CF             ;         buffer filled with the following information:
0694   42CF             ;
0695   42CF             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0696   42CF             ;        units (which is functionally equivalent to having only one).
0697   42CF             ;+1 (1): Device flags, always zero in Beta 2.
0698   42CF             ;
0699   42CF             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0700   42CF             ; left justified and padded with spaces. All the strings are optional,
0701   42CF             ; if not available, an error must be returned.
0702   42CF             ; If a string is provided by the device in binary format, it must be reported
0703   42CF             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0704   42CF             ; The maximum length for a string is 64 characters;
0705   42CF             ; if the string is actually longer, the leftmost 64 characters
0706   42CF             ; should be provided.
0707   42CF             ;
0708   42CF             ; In the case of the serial number string, the same rules for the strings
0709   42CF             ; apply, except that it must be provided right-justified,
0710   42CF             ; and if it is too long, the rightmost characters must be
0711   42CF             ; provided, not the leftmost.
0712   42CF             
0713   42CF             DEV_INFO: 
0714   42D0 BF FE 03    	cp	a,3		; somente 2 dispositivos
0715   42D2 38 03       	jr	c,.devok
0716   42D4 3E 01       	ld	a,1		; invalid device index
0717   42D6 C9          	ret
0718   42D7             .devok: 
0719   42D7 CD D7 43    	call	pegaWorkArea	; IY=Work area pointer
0720   42DA FD 77 30    	ld	(iy+WRKAREA.NUMSD),a
0721   42DD CD 46 46    	call	setaSDAtual
0722   42E0 04          	inc	b
0723   42E1 10 06       	djnz	.naoBasic
0724   42E3             
0725   42E3             ; Basic information:
0726   42E3 36 01       	ld	(hl), 1		; 1 logical unit somente
0727   42E5 23          	inc	hl
0728   42E6 AF          	xor	a
0729   42E7 77          	ld	(hl),a		; reservado, deve ser 0
0730   42E8 C9          	ret			; retorna com A=0 (OK)
0731   42E9             
0732   42E9             .naoBasic: 
0733   42E9 3E 02       	ld	a,2
0734   42EB             ;	ret	c		; No card present? Quit with info not available
0735   42EB             
0736   42EB E5          	push	hl
0737   42EC CD 2F 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0738   42EF E1          	pop	hl
0739   42F0 10 26       	djnz	.naoManuf
0740   42F2             ; Manufacturer Name:
0741   42F2 E5          	push	hl		; salva ponteiro do buffer
0742   42F3 06 40       	ld	b, 64		; preenche buffer com espaco
0743   42F5 3E 20       	ld	a, ' '
0744   42F7             .loop1: 
0745   42F7 77          	ld	(hl), a
0746   42F8 23          	inc	hl
0747   42F9 10 FC       	djnz	.loop1
0748   42FB D1          	pop	de		; recuperamos ponteiro do buffer em DE
0749   42FC 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0750   42FE 12          	ld	(de), a
0751   42FF 13          	inc	de
0752   4300 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0753   4303 CD 9D 57    	call	DecToAscii
0754   4306 3E 29       	ld	a, ')'
0755   4308 12          	ld	(de), a
0756   4309 13          	inc	de
0757   430A 3E 20       	ld	a, ' '
0758   430C 12          	ld	(de), a
0759   430D 13          	inc	de
0760   430E DD 7E 00    	ld	a, (ix)		; byte do fabricante
0761   4311 CD 0D 58    	call	pegaFabricante	; pegar nome do fabricante em HL
0762   4314 ED B0       	ldir			; e colocar no buffer
0763   4316 AF          	xor	a		; Return with A=0 (Ok)
0764   4317 C9          	ret
0765   4318             
0766   4318             .naoManuf: 
0767   4318 10 1A       	djnz	.naoProduct
0768   431A             ; Product Name:
0769   431A E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0770   431B DD E5       	push	ix
0771   431D E1          	pop	hl		; joga IX para HL
0772   431E 16 00       	ld	d, 0
0773   4320 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0774   4322 19          	add	hl, de
0775   4323 D1          	pop	de		; recupera buffer do Nextor em DE
0776   4324 01 05 00    	ld	bc, 5		; 5 caracteres
0777   4327 ED B0       	ldir			; copia nome do produto
0778   4329 EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0779   432A 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0780   432C 3E 20       	ld	a, ' '
0781   432E             .loop2: 
0782   432E 77          	ld	(hl), a
0783   432F 23          	inc	hl
0784   4330 10 FC       	djnz	.loop2
0785   4332 AF          	xor	a		; Return with A=0 (Ok)
0786   4333 C9          	ret
0787   4334             
0788   4334             .naoProduct: 
0789   4334             ; Serial Number:
0790   4334 36 30       	ld	(hl),'0'	; Coloca prefixo "0x"
0791   4336 23          	inc	hl
0792   4337 36 78       	ld	(hl), 'x'
0793   4339 23          	inc	hl
0794   433A E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0795   433B DD E5       	push	ix
0796   433D E1          	pop	hl		; joga IX para HL
0797   433E 16 00       	ld	d, 0
0798   4340 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0799   4342 19          	add	hl, de
0800   4343 D1          	pop	de		; recupera buffer do nextor em DE
0801   4344 06 04       	ld	b, 4		; 4 bytes do serial
0802   4346             .loop3: 
0803   4346 7E          	ld	a, (hl)
0804   4347 CD CD 57    	call	HexToAscii	; converter HEXA para ASCII
0805   434A 23          	inc	hl
0806   434B 10 F9       	djnz	.loop3
0807   434D 06 36       	ld	b, 54		; Coloca espaco no restante
0808   434F 3E 20       	ld	a, ' '
0809   4351             .loop4: 
0810   4351 12          	ld	(de), a
0811   4352 13          	inc	de
0812   4353 10 FC       	djnz	.loop4
0813   4355 AF          	xor	a		; Return with A=0 (Ok)
0814   4356 C9          	ret
0815   4357             
0816   4357             ;-----------------------------------------------------------------------------
0817   4357             ;
0818   4357             ; Obtain device status
0819   4357             ;
0820   4357             ;Input:   A = Device index, 1 to 7
0821   4357             ;         B = Logical unit number, 1 to 7
0822   4357             ;             0 to return the status of the device itself.
0823   4357             ;Output:  A = Status for the specified logical unit,
0824   4357             ;             or for the whole device if 0 was specified:
0825   4357             ;                0: The device or logical unit is not available, or the
0826   4357             ;                   device or logical unit number supplied is invalid.
0827   4357             ;                1: The device or logical unit is available and has not
0828   4357             ;                   changed since the last status request.
0829   4357             ;                2: The device or logical unit is available and has changed
0830   4357             ;                   since the last status request
0831   4357             ;                   (for devices, the device has been unplugged and a
0832   4357             ;                    different device has been plugged which has been
0833   4357             ;                    assigned the same device index; for logical units,
0834   4357             ;                    the media has been changed).
0835   4357             ;                3: The device or logical unit is available, but it is not
0836   4357             ;                   possible to determine whether it has been changed
0837   4357             ;                   or not since the last status request.
0838   4357             ;
0839   4357             ; Devices not supporting hot-plugging must always return status value 1.
0840   4357             ; Non removable logical units may return values 0 and 1.
0841   4357             ;
0842   4357             ; The returned status is always relative to the previous invokation of
0843   4357             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0844   4357             
0845   4357             DEV_STATUS: 
0846   4358 BF FE 03    	cp	a,3		; 2 dispositivos somente
0847   435A 30 39       	jr	nc,.saicomerro
0848   435C 05          	dec	b		; 1 logical unit somente
0849   435D 20 36       	jr	nz,.saicomerro
0850   435F             
0851   435F F5          	push	af
0852   4360 CD D7 43    	call	pegaWorkArea	; HL=IY=Work area pointer
0853   4363 F1          	pop	af
0854   4364 FD 77 30    	ld	(iy+WRKAREA.NUMSD),a	; salva numero do device atual (1 ou 2)
0855   4367 4F          	ld	c, a
0856   4368 32 F0 7F    	ld	(SPICTRL), a	; selects SD
0857   436B 3A F0 7F    	ld	a, (SPISTATUS)	; testar se cartao esta inserido
0858   436E CD A4 45    	call	disableSDs
0859   4371 E6 02       	and	$02
0860   4373 20 1D       	jr	nz,.cartaoComErro	; se slot do cartao estiver vazio, marcamos o erro nas flags
0861   4375 FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; testar bit de erro do cartao nas flags
0862   4378 A1          	and	c
0863   4379 28 14       	jr	z,.semMudanca	; cartao nao marcado com erro, pula
0864   437B CD 57 44    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0865   437E 38 12       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0866   4380 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)		; conseguimos detectar, tira erro nas flags
0867   4383 2F          	cpl			; inverte bits para fazer o AND
0868   4384 4F          	ld	c, a
0869   4385 FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)
0870   4388 A1          	and	c			; limpa bit
0871   4389 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
0872   438C             .comMudanca: 
0873   438C 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0874   438E C9          	ret
0875   438F             .semMudanca: 
0876   438F 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0877   4391 C9          	ret
0878   4392             .cartaoComErro: 
0879   4392 CD 18 44    	call	marcaErroCartao	; marcar erro do cartao nas flags
0880   4395             .saicomerro: 
0881   4395 3E 00       	ld	a, 0		; informa erro
0882   4397 C9          	ret
0883   4398             
0884   4398             ;-----------------------------------------------------------------------------
0885   4398             ;
0886   4398             ; Obtain logical unit information
0887   4398             ;
0888   4398             ;Input:   A  = Device index, 1 to 7
0889   4398             ;         B  = Logical unit number, 1 to 7
0890   4398             ;         HL = Pointer to buffer in RAM.
0891   4398             ;Output:  A = 0: Ok, buffer filled with information.
0892   4398             ;             1: Error, device or logical unit not available,
0893   4398             ;                or device index or logical unit number invalid.
0894   4398             ;         On success, buffer filled with the following information:
0895   4398             ;
0896   4398             ;+0 (1): Medium type:
0897   4398             ;        0: Block device
0898   4398             ;        1: CD or DVD reader or recorder
0899   4398             ;        2-254: Unused. Additional codes may be defined in the future.
0900   4398             ;        255: Other
0901   4398             ;+1 (2): Sector size, 0 if this information does not apply or is
0902   4398             ;        not available.
0903   4398             ;+3 (4): Total number of available sectors.
0904   4398             ;        0 if this information does not apply or is not available.
0905   4398             ;+7 (1): Flags:
0906   4398             ;        bit 0: 1 if the medium is removable.
0907   4398             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0908   4398             ;               be write protected or write enabled is not considered
0909   4398             ;               to be read-only.
0910   4398             ;        bit 2: 1 if the LUN is a floppy disk drive.
0911   4398             ;+8 (2): Number of cylinders
0912   4398             ;+10 (1): Number of heads
0913   4398             ;+11 (1): Number of sectors per track
0914   4398             ;
0915   4398             ; Number of cylinders, heads and sectors apply to hard disks only.
0916   4398             ; For other types of device, these fields must be zero.
0917   4398             
0918   4398             LUN_INFO: 
0919   4399 BF FE 03    	cp	a, 3		; somente 2 dispositivo
0920   439B 30 0A       	jr	nc,.saicomerro
0921   439D 05          	dec	b		; somente 1 logical unit
0922   439E 20 07       	jr	nz,.saicomerro
0923   43A0 E5          	push	hl
0924   43A1 CD EF 43    	call	testaCartao
0925   43A4 E1          	pop	hl
0926   43A5 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0927   43A7             .saicomerro: 
0928   43A7 3E 01       	ld	a, 1		; informar erro
0929   43A9 C9          	ret
0930   43AA             .ok: 
0931   43AA E5          	push	hl
0932   43AB CD 43 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0933   43AE E1          	pop	hl		; do cartao dependendo do cartao atual solicitado
0934   43AF AF          	xor	a
0935   43B0 77          	ld	(hl), a		; Informar que o dispositivo eh do tipo block device
0936   43B1 23          	inc	hl
0937   43B2 77          	ld	(hl), a		; tamanho de um bloco = 512 bytes (coloca $00, $02 que é $200 = 512)
0938   43B3 23          	inc	hl
0939   43B4 3E 02       	ld	a, 2
0940   43B6 77          	ld	(hl), a
0941   43B7 23          	inc	hl
0942   43B8 DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0943   43BB 77          	ld	(hl), a
0944   43BC 23          	inc	hl
0945   43BD DD 7E 01    	ld	a, (ix+1)
0946   43C0 77          	ld	(hl), a
0947   43C1 23          	inc	hl
0948   43C2 DD 7E 02    	ld	a, (ix+2)
0949   43C5 77          	ld	(hl), a
0950   43C6 23          	inc	hl
0951   43C7 AF          	xor	a		; cartoes SD tem total de blocos em 24 bits, mas o Nextor pede numero de
0952   43C8 77          	ld	(hl), a 	; 32 bits, entao coloca 0 no MSB
0953   43C9 23          	inc	hl
0954   43CA 3E 01       	ld	a, 1		; flags: dispositivo R/W removivel
0955   43CC 77          	ld	(hl), a
0956   43CD 23          	inc	hl
0957   43CE AF          	xor	a		; CHS = 0
0958   43CF 77          	ld	(hl), a
0959   43D0 23          	inc	hl
0960   43D1 77          	ld	(hl), a
0961   43D2 23          	inc	hl
0962   43D3 77          	ld	(hl), a
0963   43D4 23          	inc	hl
0964   43D5 AF          	xor	a		; informar que dados foram preenchidos
0965   43D6 C9          	ret
0966   43D7             
0967   43D7             ;=====
0968   43D7             ;=====  END of DEVICE-BASED specific routines
0969   43D7             ;=====
0970   43D7             
0971   43D7             ;------------------------------------------------
0972   43D7             ; Rotinas auxiliares
0973   43D7             ;------------------------------------------------
0974   43D7             
0975   43D7             ;------------------------------------------------
0976   43D7             ; Pedir ao Nextor o ponteiro de dados de trabalho
0977   43D7             ; na RAM e colocar em HL e IY
0978   43D7             ; Output: 
0979   43D7             ; IY = WorkArea pointer
0980   43D7             ; Modifies: IX
0981   43D7             ;------------------------------------------------
0982   43D7             pegaWorkArea: 
0983   43D7 F5 E5       	push	af,hl
0984   43D9 AF          	xor	a		; Pegar endereco da area de trabalho
0985   43DA 08          	ex	af,af'
0986   43DB AF          	xor	a
0987   43DC DD 21 45 40 	ld	ix, GWORK
0988   43E0 CD 42 40    	call	CALBNK
0989   43E3 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
0990   43E6 DD 66 01    	ld	h,(ix+1)
0991   43E9 E5          	push	hl
0992   43EA FD E1       	pop	iy		; em IY temos o mesmo ponteiro
0993   43EC E1 F1       	pop	hl,af
0994   43EE C9          	ret
0995   43EF             
0996   43EF             ;------------------------------------------------
0997   43EF             ; Testa se cartao esta inserido e/ou houve erro
0998   43EF             ; na ultima vez que foi acessado. Carry indica
0999   43EF             ; erro
1000   43EF             ; Destroi AF, HL, IX, C
1001   43EF             ;------------------------------------------------
1002   43EF             testaCartao: 
1003   43EF F5          	push	af
1004   43F0 CD D7 43    	call	pegaWorkArea	; HL=IY=Work area pointer
1005   43F3 F1          	pop	af
1006   43F4 FD 77 30    	ld	(iy+WRKAREA.NUMSD), a	; salva numero do device atual (1 ou 2)
1007   43F7 4F          	ld	c, a
1008   43F8 32 F0 7F    	ld	(SPICTRL), a	; Selects SD
1009   43FB 3A F0 7F    	ld	a, (SPISTATUS)	; testar se cartao esta inserido
1010   43FE CD A4 45    	call	disableSDs
1011   4401 E6 02       	and	$02
1012   4403 20 0A       	jr	nz,.saicomerro				
1013   4405 FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; testar bit de erro do cartao nas flags
1014   4408 A1          	and	c
1015   4409 28 02       	jr	z,.ok
1016   440B 37          	scf			; indica erro
1017   440C C9          	ret
1018   440D             .ok: 
1019   440D AF          	xor	a		; zera carry indicando sem erro
1020   440E C9          	ret
1021   440F             .saicomerro: 
1022   440F FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; marca bit de erro nas flags
1023   4412 B1          	or	c
1024   4413 FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1025   4416 37          	scf
1026   4417 C9          	ret
1027   4418             
1028   4418             ;------------------------------------------------
1029   4418             ; Marcar bit de erro nas flags
1030   4418             ; Destroi AF, C
1031   4418             ;------------------------------------------------
1032   4418             marcaErroCartao: 
1033   4418 FD 4E 30    	ld	c, (iy+WRKAREA.NUMSD)		; cartao atual (1 ou 2)
1034   441B FD 7E 31    	ld	a, (iy+WRKAREA.CARDFLAGS)	; marcar erro
1035   441E B1          	or	c
1036   441F FD 77 31    	ld	(iy+WRKAREA.CARDFLAGS), a
1037   4422 C9          	ret
1038   4423             
1039   4423             ;------------------------------------------------
1040   4423             ; Testar se cartao atual esta protegido contra
1041   4423             ; gravacao, A=0 se protegido
1042   4423             ; Destroi AF, C
1043   4423             ;------------------------------------------------
1044   4423             testaWP: 
1045   4423 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; cartao atual (1 ou 2)
1046   4426 32 F0 7F    	ld	(SPICTRL), a
1047   4429 3A F0 7F    	ld	a, (SPISTATUS)	; testar se cartao esta protegido
1048   442C             ;	call	disableSDs
1049   442C E6 04       	and	$04
1050   442E C9          	ret			; se A for 0 cartao esta protegido
1051   442F             
1052   442F             ;------------------------------------------------
1053   442F             ; Calcula offset do buffer na RAM em HL e IX para
1054   442F             ; os dados do CID dependendo do cartao atual
1055   442F             ; Destroi AF, DE, HL e IX
1056   442F             ;------------------------------------------------
1057   442F             calculaCIDoffset: 
1058   442F FD E5       	push	iy		; copiamos IY para HL
1059   4431 E1          	pop	hl
1060   4432 16 00       	ld	d, 0
1061   4434 1E 10       	ld	e, WRKAREA.BCID1	; DE aponta para buffer BCID1
1062   4436 FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; vamos fazer IX apontar para o buffer correto
1063   4439 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1064   443A 28 02       	jr	z,.c1
1065   443C 1E 20       	ld	e, WRKAREA.BCID2	; DE aponta para buffer BCID2
1066   443E             .c1: 
1067   443E 19          	add	hl, de		; HL aponta para buffer correto
1068   443F E5          	push	hl		
1069   4440 DD E1       	pop	ix		; vamos colocar HL em IX
1070   4442 C9          	ret
1071   4443             
1072   4443             ;------------------------------------------------
1073   4443             ; Calcula offset do buffer na RAM para os dados
1074   4443             ; do total de blocos dependendo do cartao atual
1075   4443             ; Offset fica em HL e IX
1076   4443             ; Destroi AF, DE, HL e IX
1077   4443             ;------------------------------------------------
1078   4443             calculaBLOCOSoffset: 
1079   4443 FD E5       	push	iy		; copiamos IY para HL
1080   4445 E1          	pop	hl
1081   4446 16 00       	ld	d, 0
1082   4448 1E 33       	ld	e, WRKAREA.BLOCKS1	; DE aponta para buffer BLOCKS1
1083   444A FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)	; Vamos fazer IX apontar para o buffer correto
1084   444D 3D          	dec	a		; dependendo do cartao: BLOCKS1 ou BLOCKS2
1085   444E 28 02       	jr	z,.c1
1086   4450 1E 36       	ld	e, WRKAREA.BLOCKS2	; DE aponta para buffer BLOCKS2
1087   4452             .c1: 
1088   4452 19          	add	hl, de		; HL aponta para buffer correto
1089   4453 E5          	push	hl		
1090   4454 DD E1       	pop	ix		; Vamos colocar HL em IX
1091   4456 C9          	ret
1092   4457             
1093   4457             
1094   4457             ;------------------------------------------------
1095   4457             ; Minhas funcoes para cartao SD
1096   4457             ;------------------------------------------------
1097   4457             
1098   4457             ;------------------------------------------------
1099   4457             ; Processo de inicializacao e deteccao do cartao.
1100   4457             ; Detecta se cartao responde, qual versao (SDV1
1101   4457             ; ou SDV2), faz a leitura do CSD e CID e calcula
1102   4457             ; o numero de blocos do cartao, colocando o CID
1103   4457             ; e total de blocos no buffer correto dependendo
1104   4457             ; do cartao 1 ou 2.
1105   4457             ; Retorna erro no carry. Se for 0 indica deteccao
1106   4457             ; com sucesso.
1107   4457             ; Destroi todos os registradores
1108   4457             ;------------------------------------------------
1109   4457             detectaCartao: 
1110   4457 CD 85 45    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1111   445A D8          	ret	c			; retorna se erro
1112   445B CD 26 45    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1113   445E D8          	ret	c
1114   445F FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1115   4461 E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1116   4462 3E 49       	ld	a, CMD9		; ler CSD
1117   4464 CD 47 45    	call	lerBlocoCxD
1118   4467 D8          	ret	c
1119   4468 CD 2F 44    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1120   446B 3E 4A       	ld	a, CMD10	; ler CID
1121   446D CD 47 45    	call	lerBlocoCxD
1122   4470 D8          	ret	c
1123   4471 3E 7A       	ld	a, CMD58	; ler OCR
1124   4473 11 00 00    	ld	de, 0
1125   4476 CD D5 45    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1126   4479 D8          	ret	c
1127   447A 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1128   447B E6 40       	and	$40
1129   447D DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1130   4480 CC 1B 45    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1131   4483 D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1132   4484 CD A4 45    	call	disableSDs
1133   4487             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1134   4487 CD 43 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1135   448A FD E5       	push	iy		; copiamos IY para HL
1136   448C E1          	pop	hl
1137   448D 16 00       	ld	d, 0
1138   448F 1E 05       	ld	e, WRKAREA.BCSD+5
1139   4491 19          	add	hl, de		; HL aponta para buffer BCSD+5
1140   4492 FD 7E 00    	ld	a, (iy+WRKAREA.BCSD)
1141   4495 E6 C0       	and	$C0		; testa versao do registro CSD
1142   4497 28 06       	jr	z,.calculaCSD1
1143   4499 FE 40       	cp	$40
1144   449B 28 54       	jr	z,.calculaCSD2
1145   449D 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1146   449E C9          	ret
1147   449F             
1148   449F             ; -----------------------------------
1149   449F             ; Registro CSD versao 1, calcular da
1150   449F             ; maneira correta para a versao 1
1151   449F             ; -----------------------------------
1152   449F             .calculaCSD1: 
1153   449F 7E          	ld	a, (hl)
1154   44A0 E6 0F       	and	$0F		; isola READ_BL_LEN
1155   44A2 F5          	push	af
1156   44A3 23          	inc	hl
1157   44A4 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1158   44A5 E6 03       	and	3
1159   44A7 57          	ld	d, a
1160   44A8 23          	inc	hl
1161   44A9 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1162   44AA 23          	inc	hl
1163   44AB 7E          	ld	a, (hl)
1164   44AC E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1165   44AE 87          	add	a, a		; rotaciona a esquerda
1166   44AF CB 13       	rl	e		; rotaciona para DE
1167   44B1 CB 12       	rl	d
1168   44B3 87          	add	a, a		; mais uma rotacao
1169   44B4 CB 13       	rl	e		; rotaciona para DE
1170   44B6 CB 12       	rl	d
1171   44B8 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1172   44B9 23          	inc	hl
1173   44BA 7E          	ld	a, (hl)		; proximo byte
1174   44BB E6 03       	and	3		; 2 bits de C_SIZE_MUL
1175   44BD 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1176   44BE 23          	inc	hl						
1177   44BF 7E          	ld	a, (hl)		; proximo byte
1178   44C0 E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1179   44C2 87          	add	a, a		; rotaciona para esquerda jogando no carry
1180   44C3 CB 10       	rl	b		; rotaciona para B
1181   44C5 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1182   44C6 04          	inc	b		; faz B = C_SIZE_MUL + 2
1183   44C7 F1          	pop	af		; volta em A o READ_BL_LEN
1184   44C8 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1185   44C9 01 00 00    	ld	bc, 0
1186   44CC CD E5 44    	call	.eleva2
1187   44CF 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1188   44D0 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1189   44D1 48          	ld	c, b
1190   44D2 06 00       	ld	b, 0
1191   44D4 CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1192   44D6 CB 1A       	rr	d		; rotacionamos D e E
1193   44D8 CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1194   44DA             .salvaBlocos: 
1195   44DA DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1196   44DD DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1197   44E0 DD 73 00    	ld	(ix), e
1198   44E3 AF          	xor	a		; limpa carry
1199   44E4 C9          	ret
1200   44E5             
1201   44E5             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1202   44E5             				; BC = 0
1203   44E5             				; DE = C_SIZE
1204   44E5 CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1205   44E7 CB 12       	rl	d
1206   44E9 CB 11       	rl	c
1207   44EB CB 10       	rl	b
1208   44ED 3D          	dec	a		; subtraimos 1
1209   44EE 20 F5       	jr	nz,.eleva2
1210   44F0 C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1211   44F1             
1212   44F1             ; -----------------------------------
1213   44F1             ; Registro CSD versao 2, calcular da
1214   44F1             ; maneira correta para a versao 2
1215   44F1             ; -----------------------------------
1216   44F1             .calculaCSD2: 
1217   44F1 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1218   44F2 23          	inc	hl
1219   44F3 7E          	ld	a, (hl)
1220   44F4 E6 3F       	and	$3F
1221   44F6 4F          	ld	c, a
1222   44F7 23          	inc	hl
1223   44F8 56          	ld	d, (hl)
1224   44F9 23          	inc	hl
1225   44FA 5E          	ld	e, (hl)
1226   44FB CD 07 45    	call	.inc32		; soma 1
1227   44FE CD 0F 45    	call	.desloca32	; multiplica por 512
1228   4501 CD 14 45    	call	.rotaciona24	; multiplica por 2
1229   4504 C3 DA 44    	jp		.salvaBlocos
1230   4507             
1231   4507             .inc32: 
1232   4507 1C          	inc	e
1233   4508 C0          	ret	nz
1234   4509 14          	inc	d
1235   450A C0          	ret	nz
1236   450B 0C          	inc	c
1237   450C C0          	ret	nz
1238   450D 04          	inc	b
1239   450E C9          	ret
1240   450F             
1241   450F             .desloca32: 
1242   450F 41          	ld	b, c
1243   4510 4A          	ld	c, d
1244   4511 53          	ld	d, e
1245   4512 1E 00       	ld	e, 0
1246   4514             .rotaciona24: 
1247   4514 CB 22       	sla	d
1248   4516 CB 11       	rl	c
1249   4518 CB 10       	rl	b
1250   451A C9          	ret
1251   451B             
1252   451B             ; ------------------------------------------------
1253   451B             ; Setar o tamanho do bloco para 512 se o cartao
1254   451B             ; for SDV1
1255   451B             ; ------------------------------------------------
1256   451B             mudarTamanhoBlocoPara512: 
1257   451B 3E 50       	ld	a, CMD16
1258   451D 01 00 00    	ld	bc, 0
1259   4520 11 00 02    	ld	de, 512
1260   4523 C3 C0 45    	jp	SD_SEND_CMD_GET_ERROR
1261   4526             
1262   4526             ; ------------------------------------------------
1263   4526             ; Tenta inicializar um cartao SDV2, se houver erro
1264   4526             ; o cartao deve ser SDV1
1265   4526             ; ------------------------------------------------
1266   4526             testaSDCV2: 
1267   4526 3E 48       	ld	a, CMD8
1268   4528 11 AA 01    	ld	de, $1AA
1269   452B CD D5 45    	call	SD_SEND_CMD_2_ARGS_GET_R3
1270   452E 21 B9 45    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1271   4531 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1272   4533 21 AB 45    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1273   4536             .pula: 
1274   4536 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1275   4539             .loop: 
1276   4539 C5          	push	bc
1277   453A CD 46 45    	call	.jumpHL		; chamar rotina correta em HL
1278   453D C1          	pop	bc
1279   453E D0          	ret	nc
1280   453F 10 F8       	djnz	.loop
1281   4541 0D          	dec	c
1282   4542 20 F5       	jr	nz,.loop
1283   4544 37          	scf
1284   4545 C9          	ret
1285   4546             .jumpHL: 
1286   4546 E9          	jp	(hl)		; chamar rotina correta em HL
1287   4547             
1288   4547             ; ------------------------------------------------
1289   4547             ; Ler registro CID ou CSD, o comando vem em A
1290   4547             ; ------------------------------------------------
1291   4547             lerBlocoCxD: 
1292   4547 CD BB 45    	call	SD_SEND_CMD_NO_ARGS
1293   454A D8          	ret	c
1294   454B CD 1A 46    	call	WAIT_RESP_FE
1295   454E D8          	ret	c
1296   454F EB          	ex	de,hl
1297   4550             
1298   4550             	; Check for a Z80 or R800
1299   4550             ;	or 	a		; Clear Cy
1300   4550 3E 14       	ld	a,20
1301   4552 ED F9       	db	#ED,#F9		; mulub a,a
1302   4554 21 00 7B    	ld	hl, SPIDATA
1303   4557 38 25       	jr	c,.r800		; Use LDIR for R800
1304   4559 ED A0       > ldi	
1304   455B ED A0       > ldi	
1304   455D ED A0       > ldi	
1304   455F ED A0       > ldi	
1304   4561 ED A0       > ldi	
1304   4563 ED A0       > ldi	
1304   4565 ED A0       > ldi	
1304   4567 ED A0       > ldi	
1304   4569 ED A0       > ldi	
1304   456B ED A0       > ldi	
1304   456D ED A0       > ldi	
1304   456F ED A0       > ldi	
1304   4571 ED A0       > ldi	
1304   4573 ED A0       > ldi	
1304   4575 ED A0       > ldi	
1304   4577 ED A0       > ldi	
1305   4579             .end
1306   4579 7E           	ld	a, (hl)
1307   457A 7E          	ld	a, (hl)		; byte de resposta
1308   457B B7          	or	a
1309   457C EB          	ex	de,hl
1310   457D             ;	jr	disableSDs
1311   457D C9          	ret
1312   457E             
1313   457E             .r800: 
1314   457E 01 10 00    	ld	bc,16
1315   4581 ED B0       	ldir
1316   4583 18 F4       	jr	.end
1317   4585             
1318   4585             ; ------------------------------------------------
1319   4585             ; Algoritmo para inicializar um cartao SD
1320   4585             ; Destroi AF, B, DE
1321   4585             ; ------------------------------------------------
1322   4585             iniciaSD: 
1323   4585 CD A4 45    	call	disableSDs
1324   4588             
1325   4588 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1326   458A             enviaClocksInicio: 
1327   458A 3E FF       	ld	a, $FF		; manter MOSI em 1
1328   458C 32 00 7B    	ld	(SPIDATA), a
1329   458F 10 F9       	djnz	enviaClocksInicio
1330   4591 CD 46 46    	call	setaSDAtual	; ativar cartao atual
1331   4594 06 08       	ld	b, 8		; 8 tentativas para CMD0
1332   4596             SD_SEND_CMD0: 
1333   4596 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1334   4598 11 00 00    	ld	de, 0
1335   459B C5          	push	bc
1336   459C CD C8 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1337   459F C1          	pop	bc
1338   45A0 D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1339   45A1 10 F3       	djnz	SD_SEND_CMD0
1340   45A3 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1341   45A4             	; fall throw
1342   45A4             
1343   45A4             ; ------------------------------------------------
1344   45A4             ; Desabilitar (de-selecionar) todos os cartoes
1345   45A4             ; Nao destroi registradores
1346   45A4             ; ------------------------------------------------
1347   45A4             disableSDs: 
1348   45A4 F5          	push	af
1349   45A5 AF          	xor	a
1350   45A6 32 F0 7F    	ld	(SPICTRL), a
1351   45A9 F1          	pop	af
1352   45AA C9          	ret
1353   45AB             
1354   45AB             ; ------------------------------------------------
1355   45AB             ; Enviar comando ACMD41
1356   45AB             ; ------------------------------------------------
1357   45AB             SD_SEND_ACMD41: 
1358   45AB 3E 77       	ld	a, CMD55
1359   45AD CD BB 45    	call	SD_SEND_CMD_NO_ARGS
1360   45B0 3E 69       	ld	a, ACMD41
1361   45B2 01 00 40    	ld	bc, $4000
1362   45B5 51          	ld	d, c
1363   45B6 59          	ld	e, c
1364   45B7 18 07       	jr		SD_SEND_CMD_GET_ERROR
1365   45B9             
1366   45B9             ; ------------------------------------------------
1367   45B9             ; Enviar CMD1 para cartao. Carry indica erro
1368   45B9             ; Destroi AF, BC, DE
1369   45B9             ; ------------------------------------------------
1370   45B9             SD_SEND_CMD1: 
1371   45B9 3E 41       	ld	a, CMD1
1372   45BB             SD_SEND_CMD_NO_ARGS: 
1373   45BB 01 00 00    	ld	bc, 0
1374   45BE 50          	ld	d, b
1375   45BF 59          	ld	e, c
1376   45C0             SD_SEND_CMD_GET_ERROR: 
1377   45C0 CD EE 45    	call	SD_SEND_CMD
1378   45C3 B7          	or	a
1379   45C4 C8          	ret	z			; se A=0 nao houve erro, retornar
1380   45C5             	; fall throw
1381   45C5             
1382   45C5             ; ------------------------------------------------
1383   45C5             ; Informar erro
1384   45C5             ; Nao destroi registradores
1385   45C5             ; ------------------------------------------------
1386   45C5             setaErro: 
1387   45C5 37          	scf
1388   45C6 18 DC       	jr		disableSDs
1389   45C8             
1390   45C8             ; ------------------------------------------------
1391   45C8             ; Enviar comando em A com 2 bytes de parametros
1392   45C8             ; em DE e testar retorno BUSY
1393   45C8             ; Retorna em A a resposta do cartao
1394   45C8             ; Destroi AF, BC
1395   45C8             ; ------------------------------------------------
1396   45C8             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1397   45C8 01 00 00    	ld	bc, 0
1398   45CB CD EE 45    	call	SD_SEND_CMD
1399   45CE 47          	ld	b, a
1400   45CF E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1401   45D1 78          	ld	a, b
1402   45D2 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1403   45D4 C9          	ret			; sem erros
1404   45D5             
1405   45D5             ; ------------------------------------------------
1406   45D5             ; Enviar comando em A com 2 bytes de parametros
1407   45D5             ; em DE e ler resposta do tipo R3 em BC DE
1408   45D5             ; Retorna em A a resposta do cartao
1409   45D5             ; Destroi AF, BC, DE, HL
1410   45D5             ; ------------------------------------------------
1411   45D5             SD_SEND_CMD_2_ARGS_GET_R3: 
1412   45D5 CD C8 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1413   45D8 D8          	ret	c
1414   45D9 F5          	push	af
1415   45DA CD 28 46    	call	WAIT_RESP_NO_FF
1416   45DD 67          	ld	h, a
1417   45DE CD 28 46    	call	WAIT_RESP_NO_FF
1418   45E1 6F          	ld	l, a
1419   45E2 CD 28 46    	call	WAIT_RESP_NO_FF
1420   45E5 57          	ld	d, a
1421   45E6 CD 28 46    	call	WAIT_RESP_NO_FF
1422   45E9 5F          	ld	e, a
1423   45EA 44          	ld	b, h
1424   45EB 4D          	ld	c, l
1425   45EC F1          	pop	af
1426   45ED C9          	ret
1427   45EE             
1428   45EE             ; ------------------------------------------------
1429   45EE             ; Enviar comando em A com 4 bytes de parametros
1430   45EE             ; em BC DE e enviar CRC correto se for CMD0 ou 
1431   45EE             ; CMD8 e aguardar processamento do cartao
1432   45EE             ; Output  : A=0 if there was no error
1433   45EE             ; Modifies:  AF, B, AF'
1434   45EE             ; ------------------------------------------------
1435   45EE             SD_SEND_CMD: 
1436   45EE CD 46 46    	call	setaSDAtual
1437   45F1 32 00 7B    	ld	(SPIDATA), a
1438   45F4 F5          	push	af
1439   45F5 78          	ld	a, b
1440   45F6 32 00 7B    	ld	(SPIDATA), a
1441   45F9 79          	ld	a, c
1442   45FA 32 00 7B    	ld	(SPIDATA), a
1443   45FD 7A          	ld	a, d
1444   45FE 32 00 7B    	ld	(SPIDATA), a
1445   4601 7B          	ld	a, e
1446   4602 32 00 7B    	ld	(SPIDATA), a
1447   4605 F1          	pop	af
1448   4606 FE 40       	cp	CMD0
1449   4608 06 95       	ld	b, $95		; CRC para CMD0
1450   460A 28 08       	jr	z,enviaCRC
1451   460C FE 48       	cp	CMD8
1452   460E 06 87       	ld	b, $87		; CRC para CMD8
1453   4610 28 02       	jr	z,enviaCRC
1454   4612 06 FF       	ld	b, $FF		; CRC dummy
1455   4614             enviaCRC: 
1456   4614 78          	ld	a, b
1457   4615 32 00 7B    	ld	(SPIDATA), a
1458   4618 18 0E       	jr	WAIT_RESP_NO_FF
1459   461A             
1460   461A             ; ------------------------------------------------
1461   461A             ; Esperar que resposta do cartao seja $FE
1462   461A             ; Destroi AF, B
1463   461A             ; ------------------------------------------------
1464   461A             WAIT_RESP_FE: 
1465   461A 06 0A       	ld	b, 10		; 10 tentativas
1466   461C             .loop: 
1467   461C C5          	push	bc
1468   461D CD 28 46    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1469   4620 C1          	pop	bc
1470   4621 FE FE       	cp	$FE		; resposta é $FE ?
1471   4623 C8          	ret	z		; sim, retornamos com carry=0
1472   4624 10 F6       	djnz	.loop
1473   4626 37          	scf			; erro, carry=1
1474   4627 C9          	ret
1475   4628             
1476   4628             ; ------------------------------------------------
1477   4628             ; Esperar que resposta do cartao seja diferente
1478   4628             ; de $FF
1479   4628             ; Destroi AF, BC
1480   4628             ; ------------------------------------------------
1481   4628             WAIT_RESP_NO_FF: 
1482   4628 01 01 00    	ld	bc, 1		; 256 tentativas
1483   462B             .loop: 
1484   462B 3A 00 7B    	ld	a, (SPIDATA)
1485   462E FE FF       	cp	$FF		; testa $FF
1486   4630 C0          	ret		nz		; sai se nao for $FF
1487   4631 10 F8       	djnz	.loop
1488   4633 0D          	dec	c
1489   4634 20 F5       	jr	nz,.loop
1490   4636 C9          	ret
1491   4637             
1492   4637             ; ------------------------------------------------
1493   4637             ; Esperar que resposta do cartao seja diferente
1494   4637             ; de $00
1495   4637             ; Destroi A, BC
1496   4637             ; ------------------------------------------------
1497   4637             WAIT_RESP_NO_00: 
1498   4637 01 80 00    	ld	bc, 128		; 32768 tentativas
1499   463A             .loop: 
1500   463A 3A 00 7B    	ld	a, (SPIDATA)
1501   463D B7          	or	a
1502   463E C0          	ret	nz			; se resposta for <> $00, sai
1503   463F 10 F9       	djnz	.loop
1504   4641 0D          	dec	c
1505   4642 20 F6       	jr	nz,.loop
1506   4644 37          	scf			; erro
1507   4645 C9          	ret
1508   4646             
1509   4646             ; ------------------------------------------------
1510   4646             ; Sets the requested card slot and check its status
1511   4646             ; In case it detects that the card was changed, it will call the detection
1512   4646             ; routine to re-dectect the card type
1513   4646             ; Input: Target card slot
1514   4646             ; Output: Cy = No SD card is present
1515   4646             ;         A: 0=The same card is still present
1516   4646             ;            1=The card was changed since the last check
1517   4646             ; ------------------------------------------------
1518   4646             setaSDAtual: 
1519   4646 F5          	push	af
1520   4647 3A 00 7B    	ld	a, (SPIDATA)	; dummy read
1521   464A FD 7E 30    	ld	a, (iy+WRKAREA.NUMSD)
1522   464D 32 F0 7F    	ld	(SPICTRL), a
1523   4650 F1          	pop	af
1524   4651 C9          	ret
1525   4652             
1526   4652              IFDEF BLA
1527   4652~            	ld	a, (SPIDATA)	; dummy read
1528   4652~            	ld	a, (iy+WRKAREA.NUMSD)
1529   4652~            ;	cpl			; invert bits
1530   4652~            ;	and	3
1531   4652~            	ld	(SPICTRL), a
1532   4652~            	;
1533   4652~            	ld	a,(SPISTATUS)	; Get this card slot status
1534   4652~            	bit	SD_PRESENT,a	; Is there a card present?
1535   4652~            	scf
1536   4652~            	ret	nz		; No, return with error
1537   4652~            1538   4652~            	; ***Workaround for the problem that Nextor doesn't call DEV_STATUS to
1539   4652~            	; check if the media has changed before every disk operation, so we
1540   4652~            	; need to always check if it changed.
1541   4652~            	and	SD_M_DSKCHG	; Was the card changed since last checked?
1542   4652~            	ret	z		; No, return
1543   4652~            	push	bc,de,hl,ix
1544   4652~            	call	detectaCartao	; Detect the new card
1545   4652~            	pop	ix,hl,de,bc
1546   4652~            	ret	c		; Error? Then return
1547   4652~            	ld	a,1
1548   4652~            	ret
1549   4652              ENDIF ; BLA
1550   4652             
1551   4652             ; ------------------------------------------------
1552   4652             ; Grava um bloco de 512 bytes no cartao
1553   4652             ; HL = aponta para o inicio dos dados
1554   4652             ; BC:DE = contem o numero do bloco (BCDE = 32 bits)
1555   4652             ; IXH = Number of blocks
1556   4652             ; IXL = SDcard version (0 or 1)
1557   4652             ; Modifies:  AF, BC, DE, HL, IXL
1558   4652             ; ------------------------------------------------
1559   4652             GravarBloco: 
1560   4652 DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1561   4655 B7          	or	a
1562   4656 CC 88 57    	call	z,blocoParaByte		; se for SDV1 coverter blocos para bytes
1563   4659             ;	call	setaSDAtual	; selecionar cartao atual
1564   4659 FD 7E 32    	ld	a, (iy+WRKAREA.NUMBLOCKS)	; testar se Nextor quer gravar 1 ou mais blocos
1565   465C 3D          	dec	a
1566   465D CA DA 4A    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1567   4660             
1568   4660             ; multiplos blocos
1569   4660 C5          	push	bc
1570   4661 D5          	push	de
1571   4662 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1572   4664 CD BB 45    	call	SD_SEND_CMD_NO_ARGS
1573   4667 3E 57       	ld	a, ACMD23
1574   4669 01 00 00    	ld	bc, 0
1575   466C 51          	ld	d, c
1576   466D FD 5E 32    	ld	e, (iy+WRKAREA.NUMBLOCKS)	; parametro = total de blocos a gravar
1577   4670 CD C0 45    	call	SD_SEND_CMD_GET_ERROR
1578   4673 D1          	pop	de
1579   4674 C1          	pop	bc
1580   4675 DA 11 4F    	jp	c,terminaLeituraEscritaBloco	; erro no ACMD23
1581   4678 3E 59       	ld	a, CMD25	; comando CMD25 = write multiple blocks
1582   467A CD C0 45    	call	SD_SEND_CMD_GET_ERROR
1583   467D DA 11 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1584   4680             .loop: 
1585   4680 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados sao
1586   4682 32 00 7B    	ld	(SPIDATA),a	; dados para gravacao
1587   4685             	; Check for a Z80 or R800
1588   4685 EB          	ex	de,hl
1589   4686             ;	or 	a		; Clear Cy
1590   4686 3E 14       	ld	a,20
1591   4688 ED F9       	db	#ED,#F9		; mulub a,a
1592   468A EB          	ex	de,hl
1593   468B 11 00 7B    	ld	de, SPIDATA
1594   468E DA CB 4A    	jp	c,.r800m	; Use LDIR for R800
1595   4691 ED A0       > ldi		
1595   4693 ED A0       > ldi		
1595   4695 ED A0       > ldi		
1595   4697 ED A0       > ldi		
1595   4699 ED A0       > ldi		
1595   469B ED A0       > ldi		
1595   469D ED A0       > ldi		
1595   469F ED A0       > ldi		
1595   46A1 ED A0       > ldi		
1595   46A3 ED A0       > ldi		
1595   46A5 ED A0       > ldi		
1595   46A7 ED A0       > ldi		
1595   46A9 ED A0       > ldi		
1595   46AB ED A0       > ldi		
1595   46AD ED A0       > ldi		
1595   46AF ED A0       > ldi		
1595   46B1 ED A0       > ldi		
1595   46B3 ED A0       > ldi		
1595   46B5 ED A0       > ldi		
1595   46B7 ED A0       > ldi		
1595   46B9 ED A0       > ldi		
1595   46BB ED A0       > ldi		
1595   46BD ED A0       > ldi		
1595   46BF ED A0       > ldi		
1595   46C1 ED A0       > ldi		
1595   46C3 ED A0       > ldi		
1595   46C5 ED A0       > ldi		
1595   46C7 ED A0       > ldi		
1595   46C9 ED A0       > ldi		
1595   46CB ED A0       > ldi		
1595   46CD ED A0       > ldi		
1595   46CF ED A0       > ldi		
1595   46D1 ED A0       > ldi		
1595   46D3 ED A0       > ldi		
1595   46D5 ED A0       > ldi		
1595   46D7 ED A0       > ldi		
1595   46D9 ED A0       > ldi		
1595   46DB ED A0       > ldi		
1595   46DD ED A0       > ldi		
1595   46DF ED A0       > ldi		
1595   46E1 ED A0       > ldi		
1595   46E3 ED A0       > ldi		
1595   46E5 ED A0       > ldi		
1595   46E7 ED A0       > ldi		
1595   46E9 ED A0       > ldi		
1595   46EB ED A0       > ldi		
1595   46ED ED A0       > ldi		
1595   46EF ED A0       > ldi		
1595   46F1 ED A0       > ldi		
1595   46F3 ED A0       > ldi		
1595   46F5 ED A0       > ldi		
1595   46F7 ED A0       > ldi		
1595   46F9 ED A0       > ldi		
1595   46FB ED A0       > ldi		
1595   46FD ED A0       > ldi		
1595   46FF ED A0       > ldi		
1595   4701 ED A0       > ldi		
1595   4703 ED A0       > ldi		
1595   4705 ED A0       > ldi		
1595   4707 ED A0       > ldi		
1595   4709 ED A0       > ldi		
1595   470B ED A0       > ldi		
1595   470D ED A0       > ldi		
1595   470F ED A0       > ldi		
1595   4711 ED A0       > ldi		
1595   4713 ED A0       > ldi		
1595   4715 ED A0       > ldi		
1595   4717 ED A0       > ldi		
1595   4719 ED A0       > ldi		
1595   471B ED A0       > ldi		
1595   471D ED A0       > ldi		
1595   471F ED A0       > ldi		
1595   4721 ED A0       > ldi		
1595   4723 ED A0       > ldi		
1595   4725 ED A0       > ldi		
1595   4727 ED A0       > ldi		
1595   4729 ED A0       > ldi		
1595   472B ED A0       > ldi		
1595   472D ED A0       > ldi		
1595   472F ED A0       > ldi		
1595   4731 ED A0       > ldi		
1595   4733 ED A0       > ldi		
1595   4735 ED A0       > ldi		
1595   4737 ED A0       > ldi		
1595   4739 ED A0       > ldi		
1595   473B ED A0       > ldi		
1595   473D ED A0       > ldi		
1595   473F ED A0       > ldi		
1595   4741 ED A0       > ldi		
1595   4743 ED A0       > ldi		
1595   4745 ED A0       > ldi		
1595   4747 ED A0       > ldi		
1595   4749 ED A0       > ldi		
1595   474B ED A0       > ldi		
1595   474D ED A0       > ldi		
1595   474F ED A0       > ldi		
1595   4751 ED A0       > ldi		
1595   4753 ED A0       > ldi		
1595   4755 ED A0       > ldi		
1595   4757 ED A0       > ldi		
1595   4759 ED A0       > ldi		
1595   475B ED A0       > ldi		
1595   475D ED A0       > ldi		
1595   475F ED A0       > ldi		
1595   4761 ED A0       > ldi		
1595   4763 ED A0       > ldi		
1595   4765 ED A0       > ldi		
1595   4767 ED A0       > ldi		
1595   4769 ED A0       > ldi		
1595   476B ED A0       > ldi		
1595   476D ED A0       > ldi		
1595   476F ED A0       > ldi		
1595   4771 ED A0       > ldi		
1595   4773 ED A0       > ldi		
1595   4775 ED A0       > ldi		
1595   4777 ED A0       > ldi		
1595   4779 ED A0       > ldi		
1595   477B ED A0       > ldi		
1595   477D ED A0       > ldi		
1595   477F ED A0       > ldi		
1595   4781 ED A0       > ldi		
1595   4783 ED A0       > ldi		
1595   4785 ED A0       > ldi		
1595   4787 ED A0       > ldi		
1595   4789 ED A0       > ldi		
1595   478B ED A0       > ldi		
1595   478D ED A0       > ldi		
1595   478F ED A0       > ldi		
1595   4791 ED A0       > ldi		
1595   4793 ED A0       > ldi		
1595   4795 ED A0       > ldi		
1595   4797 ED A0       > ldi		
1595   4799 ED A0       > ldi		
1595   479B ED A0       > ldi		
1595   479D ED A0       > ldi		
1595   479F ED A0       > ldi		
1595   47A1 ED A0       > ldi		
1595   47A3 ED A0       > ldi		
1595   47A5 ED A0       > ldi		
1595   47A7 ED A0       > ldi		
1595   47A9 ED A0       > ldi		
1595   47AB ED A0       > ldi		
1595   47AD ED A0       > ldi		
1595   47AF ED A0       > ldi		
1595   47B1 ED A0       > ldi		
1595   47B3 ED A0       > ldi		
1595   47B5 ED A0       > ldi		
1595   47B7 ED A0       > ldi		
1595   47B9 ED A0       > ldi		
1595   47BB ED A0       > ldi		
1595   47BD ED A0       > ldi		
1595   47BF ED A0       > ldi		
1595   47C1 ED A0       > ldi		
1595   47C3 ED A0       > ldi		
1595   47C5 ED A0       > ldi		
1595   47C7 ED A0       > ldi		
1595   47C9 ED A0       > ldi		
1595   47CB ED A0       > ldi		
1595   47CD ED A0       > ldi		
1595   47CF ED A0       > ldi		
1595   47D1 ED A0       > ldi		
1595   47D3 ED A0       > ldi		
1595   47D5 ED A0       > ldi		
1595   47D7 ED A0       > ldi		
1595   47D9 ED A0       > ldi		
1595   47DB ED A0       > ldi		
1595   47DD ED A0       > ldi		
1595   47DF ED A0       > ldi		
1595   47E1 ED A0       > ldi		
1595   47E3 ED A0       > ldi		
1595   47E5 ED A0       > ldi		
1595   47E7 ED A0       > ldi		
1595   47E9 ED A0       > ldi		
1595   47EB ED A0       > ldi		
1595   47ED ED A0       > ldi		
1595   47EF ED A0       > ldi		
1595   47F1 ED A0       > ldi		
1595   47F3 ED A0       > ldi		
1595   47F5 ED A0       > ldi		
1595   47F7 ED A0       > ldi		
1595   47F9 ED A0       > ldi		
1595   47FB ED A0       > ldi		
1595   47FD ED A0       > ldi		
1595   47FF ED A0       > ldi		
1595   4801 ED A0       > ldi		
1595   4803 ED A0       > ldi		
1595   4805 ED A0       > ldi		
1595   4807 ED A0       > ldi		
1595   4809 ED A0       > ldi		
1595   480B ED A0       > ldi		
1595   480D ED A0       > ldi		
1595   480F ED A0       > ldi		
1595   4811 ED A0       > ldi		
1595   4813 ED A0       > ldi		
1595   4815 ED A0       > ldi		
1595   4817 ED A0       > ldi		
1595   4819 ED A0       > ldi		
1595   481B ED A0       > ldi		
1595   481D ED A0       > ldi		
1595   481F ED A0       > ldi		
1595   4821 ED A0       > ldi		
1595   4823 ED A0       > ldi		
1595   4825 ED A0       > ldi		
1595   4827 ED A0       > ldi		
1595   4829 ED A0       > ldi		
1595   482B ED A0       > ldi		
1595   482D ED A0       > ldi		
1595   482F ED A0       > ldi		
1595   4831 ED A0       > ldi		
1595   4833 ED A0       > ldi		
1595   4835 ED A0       > ldi		
1595   4837 ED A0       > ldi		
1595   4839 ED A0       > ldi		
1595   483B ED A0       > ldi		
1595   483D ED A0       > ldi		
1595   483F ED A0       > ldi		
1595   4841 ED A0       > ldi		
1595   4843 ED A0       > ldi		
1595   4845 ED A0       > ldi		
1595   4847 ED A0       > ldi		
1595   4849 ED A0       > ldi		
1595   484B ED A0       > ldi		
1595   484D ED A0       > ldi		
1595   484F ED A0       > ldi		
1595   4851 ED A0       > ldi		
1595   4853 ED A0       > ldi		
1595   4855 ED A0       > ldi		
1595   4857 ED A0       > ldi		
1595   4859 ED A0       > ldi		
1595   485B ED A0       > ldi		
1595   485D ED A0       > ldi		
1595   485F ED A0       > ldi		
1595   4861 ED A0       > ldi		
1595   4863 ED A0       > ldi		
1595   4865 ED A0       > ldi		
1595   4867 ED A0       > ldi		
1595   4869 ED A0       > ldi		
1595   486B ED A0       > ldi		
1595   486D ED A0       > ldi		
1595   486F ED A0       > ldi		
1595   4871 ED A0       > ldi		
1595   4873 ED A0       > ldi		
1595   4875 ED A0       > ldi		
1595   4877 ED A0       > ldi		
1595   4879 ED A0       > ldi		
1595   487B ED A0       > ldi		
1595   487D ED A0       > ldi		
1595   487F ED A0       > ldi		
1595   4881 ED A0       > ldi		
1595   4883 ED A0       > ldi		
1595   4885 ED A0       > ldi		
1595   4887 ED A0       > ldi		
1595   4889 ED A0       > ldi		
1595   488B ED A0       > ldi		
1595   488D ED A0       > ldi		
1595   488F ED A0       > ldi		
1595   4891 ED A0       > ldi		
1595   4893 ED A0       > ldi		
1595   4895 ED A0       > ldi		
1595   4897 ED A0       > ldi		
1595   4899 ED A0       > ldi		
1595   489B ED A0       > ldi		
1595   489D ED A0       > ldi		
1595   489F ED A0       > ldi		
1595   48A1 ED A0       > ldi		
1595   48A3 ED A0       > ldi		
1595   48A5 ED A0       > ldi		
1595   48A7 ED A0       > ldi		
1595   48A9 ED A0       > ldi		
1595   48AB ED A0       > ldi		
1595   48AD ED A0       > ldi		
1595   48AF ED A0       > ldi		
1595   48B1 ED A0       > ldi		
1595   48B3 ED A0       > ldi		
1595   48B5 ED A0       > ldi		
1595   48B7 ED A0       > ldi		
1595   48B9 ED A0       > ldi		
1595   48BB ED A0       > ldi		
1595   48BD ED A0       > ldi		
1595   48BF ED A0       > ldi		
1595   48C1 ED A0       > ldi		
1595   48C3 ED A0       > ldi		
1595   48C5 ED A0       > ldi		
1595   48C7 ED A0       > ldi		
1595   48C9 ED A0       > ldi		
1595   48CB ED A0       > ldi		
1595   48CD ED A0       > ldi		
1595   48CF ED A0       > ldi		
1595   48D1 ED A0       > ldi		
1595   48D3 ED A0       > ldi		
1595   48D5 ED A0       > ldi		
1595   48D7 ED A0       > ldi		
1595   48D9 ED A0       > ldi		
1595   48DB ED A0       > ldi		
1595   48DD ED A0       > ldi		
1595   48DF ED A0       > ldi		
1595   48E1 ED A0       > ldi		
1595   48E3 ED A0       > ldi		
1595   48E5 ED A0       > ldi		
1595   48E7 ED A0       > ldi		
1595   48E9 ED A0       > ldi		
1595   48EB ED A0       > ldi		
1595   48ED ED A0       > ldi		
1595   48EF ED A0       > ldi		
1595   48F1 ED A0       > ldi		
1595   48F3 ED A0       > ldi		
1595   48F5 ED A0       > ldi		
1595   48F7 ED A0       > ldi		
1595   48F9 ED A0       > ldi		
1595   48FB ED A0       > ldi		
1595   48FD ED A0       > ldi		
1595   48FF ED A0       > ldi		
1595   4901 ED A0       > ldi		
1595   4903 ED A0       > ldi		
1595   4905 ED A0       > ldi		
1595   4907 ED A0       > ldi		
1595   4909 ED A0       > ldi		
1595   490B ED A0       > ldi		
1595   490D ED A0       > ldi		
1595   490F ED A0       > ldi		
1595   4911 ED A0       > ldi		
1595   4913 ED A0       > ldi		
1595   4915 ED A0       > ldi		
1595   4917 ED A0       > ldi		
1595   4919 ED A0       > ldi		
1595   491B ED A0       > ldi		
1595   491D ED A0       > ldi		
1595   491F ED A0       > ldi		
1595   4921 ED A0       > ldi		
1595   4923 ED A0       > ldi		
1595   4925 ED A0       > ldi		
1595   4927 ED A0       > ldi		
1595   4929 ED A0       > ldi		
1595   492B ED A0       > ldi		
1595   492D ED A0       > ldi		
1595   492F ED A0       > ldi		
1595   4931 ED A0       > ldi		
1595   4933 ED A0       > ldi		
1595   4935 ED A0       > ldi		
1595   4937 ED A0       > ldi		
1595   4939 ED A0       > ldi		
1595   493B ED A0       > ldi		
1595   493D ED A0       > ldi		
1595   493F ED A0       > ldi		
1595   4941 ED A0       > ldi		
1595   4943 ED A0       > ldi		
1595   4945 ED A0       > ldi		
1595   4947 ED A0       > ldi		
1595   4949 ED A0       > ldi		
1595   494B ED A0       > ldi		
1595   494D ED A0       > ldi		
1595   494F ED A0       > ldi		
1595   4951 ED A0       > ldi		
1595   4953 ED A0       > ldi		
1595   4955 ED A0       > ldi		
1595   4957 ED A0       > ldi		
1595   4959 ED A0       > ldi		
1595   495B ED A0       > ldi		
1595   495D ED A0       > ldi		
1595   495F ED A0       > ldi		
1595   4961 ED A0       > ldi		
1595   4963 ED A0       > ldi		
1595   4965 ED A0       > ldi		
1595   4967 ED A0       > ldi		
1595   4969 ED A0       > ldi		
1595   496B ED A0       > ldi		
1595   496D ED A0       > ldi		
1595   496F ED A0       > ldi		
1595   4971 ED A0       > ldi		
1595   4973 ED A0       > ldi		
1595   4975 ED A0       > ldi		
1595   4977 ED A0       > ldi		
1595   4979 ED A0       > ldi		
1595   497B ED A0       > ldi		
1595   497D ED A0       > ldi		
1595   497F ED A0       > ldi		
1595   4981 ED A0       > ldi		
1595   4983 ED A0       > ldi		
1595   4985 ED A0       > ldi		
1595   4987 ED A0       > ldi		
1595   4989 ED A0       > ldi		
1595   498B ED A0       > ldi		
1595   498D ED A0       > ldi		
1595   498F ED A0       > ldi		
1595   4991 ED A0       > ldi		
1595   4993 ED A0       > ldi		
1595   4995 ED A0       > ldi		
1595   4997 ED A0       > ldi		
1595   4999 ED A0       > ldi		
1595   499B ED A0       > ldi		
1595   499D ED A0       > ldi		
1595   499F ED A0       > ldi		
1595   49A1 ED A0       > ldi		
1595   49A3 ED A0       > ldi		
1595   49A5 ED A0       > ldi		
1595   49A7 ED A0       > ldi		
1595   49A9 ED A0       > ldi		
1595   49AB ED A0       > ldi		
1595   49AD ED A0       > ldi		
1595   49AF ED A0       > ldi		
1595   49B1 ED A0       > ldi		
1595   49B3 ED A0       > ldi		
1595   49B5 ED A0       > ldi		
1595   49B7 ED A0       > ldi		
1595   49B9 ED A0       > ldi		
1595   49BB ED A0       > ldi		
1595   49BD ED A0       > ldi		
1595   49BF ED A0       > ldi		
1595   49C1 ED A0       > ldi		
1595   49C3 ED A0       > ldi		
1595   49C5 ED A0       > ldi		
1595   49C7 ED A0       > ldi		
1595   49C9 ED A0       > ldi		
1595   49CB ED A0       > ldi		
1595   49CD ED A0       > ldi		
1595   49CF ED A0       > ldi		
1595   49D1 ED A0       > ldi		
1595   49D3 ED A0       > ldi		
1595   49D5 ED A0       > ldi		
1595   49D7 ED A0       > ldi		
1595   49D9 ED A0       > ldi		
1595   49DB ED A0       > ldi		
1595   49DD ED A0       > ldi		
1595   49DF ED A0       > ldi		
1595   49E1 ED A0       > ldi		
1595   49E3 ED A0       > ldi		
1595   49E5 ED A0       > ldi		
1595   49E7 ED A0       > ldi		
1595   49E9 ED A0       > ldi		
1595   49EB ED A0       > ldi		
1595   49ED ED A0       > ldi		
1595   49EF ED A0       > ldi		
1595   49F1 ED A0       > ldi		
1595   49F3 ED A0       > ldi		
1595   49F5 ED A0       > ldi		
1595   49F7 ED A0       > ldi		
1595   49F9 ED A0       > ldi		
1595   49FB ED A0       > ldi		
1595   49FD ED A0       > ldi		
1595   49FF ED A0       > ldi		
1595   4A01 ED A0       > ldi		
1595   4A03 ED A0       > ldi		
1595   4A05 ED A0       > ldi		
1595   4A07 ED A0       > ldi		
1595   4A09 ED A0       > ldi		
1595   4A0B ED A0       > ldi		
1595   4A0D ED A0       > ldi		
1595   4A0F ED A0       > ldi		
1595   4A11 ED A0       > ldi		
1595   4A13 ED A0       > ldi		
1595   4A15 ED A0       > ldi		
1595   4A17 ED A0       > ldi		
1595   4A19 ED A0       > ldi		
1595   4A1B ED A0       > ldi		
1595   4A1D ED A0       > ldi		
1595   4A1F ED A0       > ldi		
1595   4A21 ED A0       > ldi		
1595   4A23 ED A0       > ldi		
1595   4A25 ED A0       > ldi		
1595   4A27 ED A0       > ldi		
1595   4A29 ED A0       > ldi		
1595   4A2B ED A0       > ldi		
1595   4A2D ED A0       > ldi		
1595   4A2F ED A0       > ldi		
1595   4A31 ED A0       > ldi		
1595   4A33 ED A0       > ldi		
1595   4A35 ED A0       > ldi		
1595   4A37 ED A0       > ldi		
1595   4A39 ED A0       > ldi		
1595   4A3B ED A0       > ldi		
1595   4A3D ED A0       > ldi		
1595   4A3F ED A0       > ldi		
1595   4A41 ED A0       > ldi		
1595   4A43 ED A0       > ldi		
1595   4A45 ED A0       > ldi		
1595   4A47 ED A0       > ldi		
1595   4A49 ED A0       > ldi		
1595   4A4B ED A0       > ldi		
1595   4A4D ED A0       > ldi		
1595   4A4F ED A0       > ldi		
1595   4A51 ED A0       > ldi		
1595   4A53 ED A0       > ldi		
1595   4A55 ED A0       > ldi		
1595   4A57 ED A0       > ldi		
1595   4A59 ED A0       > ldi		
1595   4A5B ED A0       > ldi		
1595   4A5D ED A0       > ldi		
1595   4A5F ED A0       > ldi		
1595   4A61 ED A0       > ldi		
1595   4A63 ED A0       > ldi		
1595   4A65 ED A0       > ldi		
1595   4A67 ED A0       > ldi		
1595   4A69 ED A0       > ldi		
1595   4A6B ED A0       > ldi		
1595   4A6D ED A0       > ldi		
1595   4A6F ED A0       > ldi		
1595   4A71 ED A0       > ldi		
1595   4A73 ED A0       > ldi		
1595   4A75 ED A0       > ldi		
1595   4A77 ED A0       > ldi		
1595   4A79 ED A0       > ldi		
1595   4A7B ED A0       > ldi		
1595   4A7D ED A0       > ldi		
1595   4A7F ED A0       > ldi		
1595   4A81 ED A0       > ldi		
1595   4A83 ED A0       > ldi		
1595   4A85 ED A0       > ldi		
1595   4A87 ED A0       > ldi		
1595   4A89 ED A0       > ldi		
1595   4A8B ED A0       > ldi		
1595   4A8D ED A0       > ldi		
1595   4A8F ED A0       > ldi		
1596   4A91             .part2m: 
1597   4A91 3E FF       	ld	a, $FF		; envia dummy CRC
1598   4A93 32 00 7B    	ld	(SPIDATA),a
1599   4A96 32 00 7B    	ld	(SPIDATA),a
1600   4A99 CD 28 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1601   4A9C E6 1F       	and	$1F		; testa bits erro
1602   4A9E FE 05       	cp	5
1603   4AA0 37          	scf
1604   4AA1 C2 11 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1605   4AA4 CD 37 46    	call	WAIT_RESP_NO_00	; esperar cartao
1606   4AA7 DA 11 4F    	jp	c,terminaLeituraEscritaBloco
1607   4AAA FD 7E 32    	ld	a, (iy+WRKAREA.NUMBLOCKS)	; testar se tem mais blocos para gravar
1608   4AAD 3D          	dec	a
1609   4AAE FD 77 32    	ld	(iy+WRKAREA.NUMBLOCKS), a
1610   4AB1 C2 80 46    	jp	nz,.loop
1611   4AB4 3A 00 7B    	ld	a, (SPIDATA)	; acabou os blocos, fazer 2 dummy reads
1612   4AB7 3A 00 7B    	ld	a, (SPIDATA)
1613   4ABA 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1614   4ABC 32 00 7B    	ld	(SPIDATA),a
1615   4ABF 3A 00 7B    	ld	a, (SPIDATA)	; dummy reads
1616   4AC2 3A 00 7B    	ld	a, (SPIDATA)
1617   4AC5 CD 37 46    	call	WAIT_RESP_NO_00	; esperar cartao
1618   4AC8 C3 10 4F    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1619   4ACB             
1620   4ACB 01 00 02    .r800m: 	ld	bc,512
1621   4ACE ED B0       	ldir
1622   4AD0 18 BF       	jr	.part2m
1623   4AD2             
1624   4AD2 01 00 02    .r800s: 	ld	bc,512
1625   4AD5 ED B0       	ldir
1626   4AD7 C3 F2 4E    	jp	.part2s
1627   4ADA             
1628   4ADA             .umBloco: 
1629   4ADA 3E 58       	ld	a, CMD24	; gravar somente um bloco com comando CMD24 = Write Single Block
1630   4ADC CD C0 45    	call	SD_SEND_CMD_GET_ERROR
1631   4ADF DA 11 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1632   4AE2             
1633   4AE2 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1634   4AE4 32 00 7B    	ld	(SPIDATA),a
1635   4AE7             
1636   4AE7             	; Check for a Z80 or R800
1637   4AE7 EB          	ex	de,hl
1638   4AE8             ;	or 	a		; Clear Cy
1639   4AE8 3E 14       	ld	a,20
1640   4AEA ED F9       	db	#ED,#F9		; mulub a,a
1641   4AEC EB          	ex	de,hl
1642   4AED 11 00 7B    	ld	de, SPIDATA
1643   4AF0 38 E0       	jr	c,.r800s	; Use LDIR for R800
1644   4AF2 ED A0       > ldi
1644   4AF4 ED A0       > ldi
1644   4AF6 ED A0       > ldi
1644   4AF8 ED A0       > ldi
1644   4AFA ED A0       > ldi
1644   4AFC ED A0       > ldi
1644   4AFE ED A0       > ldi
1644   4B00 ED A0       > ldi
1644   4B02 ED A0       > ldi
1644   4B04 ED A0       > ldi
1644   4B06 ED A0       > ldi
1644   4B08 ED A0       > ldi
1644   4B0A ED A0       > ldi
1644   4B0C ED A0       > ldi
1644   4B0E ED A0       > ldi
1644   4B10 ED A0       > ldi
1644   4B12 ED A0       > ldi
1644   4B14 ED A0       > ldi
1644   4B16 ED A0       > ldi
1644   4B18 ED A0       > ldi
1644   4B1A ED A0       > ldi
1644   4B1C ED A0       > ldi
1644   4B1E ED A0       > ldi
1644   4B20 ED A0       > ldi
1644   4B22 ED A0       > ldi
1644   4B24 ED A0       > ldi
1644   4B26 ED A0       > ldi
1644   4B28 ED A0       > ldi
1644   4B2A ED A0       > ldi
1644   4B2C ED A0       > ldi
1644   4B2E ED A0       > ldi
1644   4B30 ED A0       > ldi
1644   4B32 ED A0       > ldi
1644   4B34 ED A0       > ldi
1644   4B36 ED A0       > ldi
1644   4B38 ED A0       > ldi
1644   4B3A ED A0       > ldi
1644   4B3C ED A0       > ldi
1644   4B3E ED A0       > ldi
1644   4B40 ED A0       > ldi
1644   4B42 ED A0       > ldi
1644   4B44 ED A0       > ldi
1644   4B46 ED A0       > ldi
1644   4B48 ED A0       > ldi
1644   4B4A ED A0       > ldi
1644   4B4C ED A0       > ldi
1644   4B4E ED A0       > ldi
1644   4B50 ED A0       > ldi
1644   4B52 ED A0       > ldi
1644   4B54 ED A0       > ldi
1644   4B56 ED A0       > ldi
1644   4B58 ED A0       > ldi
1644   4B5A ED A0       > ldi
1644   4B5C ED A0       > ldi
1644   4B5E ED A0       > ldi
1644   4B60 ED A0       > ldi
1644   4B62 ED A0       > ldi
1644   4B64 ED A0       > ldi
1644   4B66 ED A0       > ldi
1644   4B68 ED A0       > ldi
1644   4B6A ED A0       > ldi
1644   4B6C ED A0       > ldi
1644   4B6E ED A0       > ldi
1644   4B70 ED A0       > ldi
1644   4B72 ED A0       > ldi
1644   4B74 ED A0       > ldi
1644   4B76 ED A0       > ldi
1644   4B78 ED A0       > ldi
1644   4B7A ED A0       > ldi
1644   4B7C ED A0       > ldi
1644   4B7E ED A0       > ldi
1644   4B80 ED A0       > ldi
1644   4B82 ED A0       > ldi
1644   4B84 ED A0       > ldi
1644   4B86 ED A0       > ldi
1644   4B88 ED A0       > ldi
1644   4B8A ED A0       > ldi
1644   4B8C ED A0       > ldi
1644   4B8E ED A0       > ldi
1644   4B90 ED A0       > ldi
1644   4B92 ED A0       > ldi
1644   4B94 ED A0       > ldi
1644   4B96 ED A0       > ldi
1644   4B98 ED A0       > ldi
1644   4B9A ED A0       > ldi
1644   4B9C ED A0       > ldi
1644   4B9E ED A0       > ldi
1644   4BA0 ED A0       > ldi
1644   4BA2 ED A0       > ldi
1644   4BA4 ED A0       > ldi
1644   4BA6 ED A0       > ldi
1644   4BA8 ED A0       > ldi
1644   4BAA ED A0       > ldi
1644   4BAC ED A0       > ldi
1644   4BAE ED A0       > ldi
1644   4BB0 ED A0       > ldi
1644   4BB2 ED A0       > ldi
1644   4BB4 ED A0       > ldi
1644   4BB6 ED A0       > ldi
1644   4BB8 ED A0       > ldi
1644   4BBA ED A0       > ldi
1644   4BBC ED A0       > ldi
1644   4BBE ED A0       > ldi
1644   4BC0 ED A0       > ldi
1644   4BC2 ED A0       > ldi
1644   4BC4 ED A0       > ldi
1644   4BC6 ED A0       > ldi
1644   4BC8 ED A0       > ldi
1644   4BCA ED A0       > ldi
1644   4BCC ED A0       > ldi
1644   4BCE ED A0       > ldi
1644   4BD0 ED A0       > ldi
1644   4BD2 ED A0       > ldi
1644   4BD4 ED A0       > ldi
1644   4BD6 ED A0       > ldi
1644   4BD8 ED A0       > ldi
1644   4BDA ED A0       > ldi
1644   4BDC ED A0       > ldi
1644   4BDE ED A0       > ldi
1644   4BE0 ED A0       > ldi
1644   4BE2 ED A0       > ldi
1644   4BE4 ED A0       > ldi
1644   4BE6 ED A0       > ldi
1644   4BE8 ED A0       > ldi
1644   4BEA ED A0       > ldi
1644   4BEC ED A0       > ldi
1644   4BEE ED A0       > ldi
1644   4BF0 ED A0       > ldi
1644   4BF2 ED A0       > ldi
1644   4BF4 ED A0       > ldi
1644   4BF6 ED A0       > ldi
1644   4BF8 ED A0       > ldi
1644   4BFA ED A0       > ldi
1644   4BFC ED A0       > ldi
1644   4BFE ED A0       > ldi
1644   4C00 ED A0       > ldi
1644   4C02 ED A0       > ldi
1644   4C04 ED A0       > ldi
1644   4C06 ED A0       > ldi
1644   4C08 ED A0       > ldi
1644   4C0A ED A0       > ldi
1644   4C0C ED A0       > ldi
1644   4C0E ED A0       > ldi
1644   4C10 ED A0       > ldi
1644   4C12 ED A0       > ldi
1644   4C14 ED A0       > ldi
1644   4C16 ED A0       > ldi
1644   4C18 ED A0       > ldi
1644   4C1A ED A0       > ldi
1644   4C1C ED A0       > ldi
1644   4C1E ED A0       > ldi
1644   4C20 ED A0       > ldi
1644   4C22 ED A0       > ldi
1644   4C24 ED A0       > ldi
1644   4C26 ED A0       > ldi
1644   4C28 ED A0       > ldi
1644   4C2A ED A0       > ldi
1644   4C2C ED A0       > ldi
1644   4C2E ED A0       > ldi
1644   4C30 ED A0       > ldi
1644   4C32 ED A0       > ldi
1644   4C34 ED A0       > ldi
1644   4C36 ED A0       > ldi
1644   4C38 ED A0       > ldi
1644   4C3A ED A0       > ldi
1644   4C3C ED A0       > ldi
1644   4C3E ED A0       > ldi
1644   4C40 ED A0       > ldi
1644   4C42 ED A0       > ldi
1644   4C44 ED A0       > ldi
1644   4C46 ED A0       > ldi
1644   4C48 ED A0       > ldi
1644   4C4A ED A0       > ldi
1644   4C4C ED A0       > ldi
1644   4C4E ED A0       > ldi
1644   4C50 ED A0       > ldi
1644   4C52 ED A0       > ldi
1644   4C54 ED A0       > ldi
1644   4C56 ED A0       > ldi
1644   4C58 ED A0       > ldi
1644   4C5A ED A0       > ldi
1644   4C5C ED A0       > ldi
1644   4C5E ED A0       > ldi
1644   4C60 ED A0       > ldi
1644   4C62 ED A0       > ldi
1644   4C64 ED A0       > ldi
1644   4C66 ED A0       > ldi
1644   4C68 ED A0       > ldi
1644   4C6A ED A0       > ldi
1644   4C6C ED A0       > ldi
1644   4C6E ED A0       > ldi
1644   4C70 ED A0       > ldi
1644   4C72 ED A0       > ldi
1644   4C74 ED A0       > ldi
1644   4C76 ED A0       > ldi
1644   4C78 ED A0       > ldi
1644   4C7A ED A0       > ldi
1644   4C7C ED A0       > ldi
1644   4C7E ED A0       > ldi
1644   4C80 ED A0       > ldi
1644   4C82 ED A0       > ldi
1644   4C84 ED A0       > ldi
1644   4C86 ED A0       > ldi
1644   4C88 ED A0       > ldi
1644   4C8A ED A0       > ldi
1644   4C8C ED A0       > ldi
1644   4C8E ED A0       > ldi
1644   4C90 ED A0       > ldi
1644   4C92 ED A0       > ldi
1644   4C94 ED A0       > ldi
1644   4C96 ED A0       > ldi
1644   4C98 ED A0       > ldi
1644   4C9A ED A0       > ldi
1644   4C9C ED A0       > ldi
1644   4C9E ED A0       > ldi
1644   4CA0 ED A0       > ldi
1644   4CA2 ED A0       > ldi
1644   4CA4 ED A0       > ldi
1644   4CA6 ED A0       > ldi
1644   4CA8 ED A0       > ldi
1644   4CAA ED A0       > ldi
1644   4CAC ED A0       > ldi
1644   4CAE ED A0       > ldi
1644   4CB0 ED A0       > ldi
1644   4CB2 ED A0       > ldi
1644   4CB4 ED A0       > ldi
1644   4CB6 ED A0       > ldi
1644   4CB8 ED A0       > ldi
1644   4CBA ED A0       > ldi
1644   4CBC ED A0       > ldi
1644   4CBE ED A0       > ldi
1644   4CC0 ED A0       > ldi
1644   4CC2 ED A0       > ldi
1644   4CC4 ED A0       > ldi
1644   4CC6 ED A0       > ldi
1644   4CC8 ED A0       > ldi
1644   4CCA ED A0       > ldi
1644   4CCC ED A0       > ldi
1644   4CCE ED A0       > ldi
1644   4CD0 ED A0       > ldi
1644   4CD2 ED A0       > ldi
1644   4CD4 ED A0       > ldi
1644   4CD6 ED A0       > ldi
1644   4CD8 ED A0       > ldi
1644   4CDA ED A0       > ldi
1644   4CDC ED A0       > ldi
1644   4CDE ED A0       > ldi
1644   4CE0 ED A0       > ldi
1644   4CE2 ED A0       > ldi
1644   4CE4 ED A0       > ldi
1644   4CE6 ED A0       > ldi
1644   4CE8 ED A0       > ldi
1644   4CEA ED A0       > ldi
1644   4CEC ED A0       > ldi
1644   4CEE ED A0       > ldi
1644   4CF0 ED A0       > ldi
1644   4CF2 ED A0       > ldi
1644   4CF4 ED A0       > ldi
1644   4CF6 ED A0       > ldi
1644   4CF8 ED A0       > ldi
1644   4CFA ED A0       > ldi
1644   4CFC ED A0       > ldi
1644   4CFE ED A0       > ldi
1644   4D00 ED A0       > ldi
1644   4D02 ED A0       > ldi
1644   4D04 ED A0       > ldi
1644   4D06 ED A0       > ldi
1644   4D08 ED A0       > ldi
1644   4D0A ED A0       > ldi
1644   4D0C ED A0       > ldi
1644   4D0E ED A0       > ldi
1644   4D10 ED A0       > ldi
1644   4D12 ED A0       > ldi
1644   4D14 ED A0       > ldi
1644   4D16 ED A0       > ldi
1644   4D18 ED A0       > ldi
1644   4D1A ED A0       > ldi
1644   4D1C ED A0       > ldi
1644   4D1E ED A0       > ldi
1644   4D20 ED A0       > ldi
1644   4D22 ED A0       > ldi
1644   4D24 ED A0       > ldi
1644   4D26 ED A0       > ldi
1644   4D28 ED A0       > ldi
1644   4D2A ED A0       > ldi
1644   4D2C ED A0       > ldi
1644   4D2E ED A0       > ldi
1644   4D30 ED A0       > ldi
1644   4D32 ED A0       > ldi
1644   4D34 ED A0       > ldi
1644   4D36 ED A0       > ldi
1644   4D38 ED A0       > ldi
1644   4D3A ED A0       > ldi
1644   4D3C ED A0       > ldi
1644   4D3E ED A0       > ldi
1644   4D40 ED A0       > ldi
1644   4D42 ED A0       > ldi
1644   4D44 ED A0       > ldi
1644   4D46 ED A0       > ldi
1644   4D48 ED A0       > ldi
1644   4D4A ED A0       > ldi
1644   4D4C ED A0       > ldi
1644   4D4E ED A0       > ldi
1644   4D50 ED A0       > ldi
1644   4D52 ED A0       > ldi
1644   4D54 ED A0       > ldi
1644   4D56 ED A0       > ldi
1644   4D58 ED A0       > ldi
1644   4D5A ED A0       > ldi
1644   4D5C ED A0       > ldi
1644   4D5E ED A0       > ldi
1644   4D60 ED A0       > ldi
1644   4D62 ED A0       > ldi
1644   4D64 ED A0       > ldi
1644   4D66 ED A0       > ldi
1644   4D68 ED A0       > ldi
1644   4D6A ED A0       > ldi
1644   4D6C ED A0       > ldi
1644   4D6E ED A0       > ldi
1644   4D70 ED A0       > ldi
1644   4D72 ED A0       > ldi
1644   4D74 ED A0       > ldi
1644   4D76 ED A0       > ldi
1644   4D78 ED A0       > ldi
1644   4D7A ED A0       > ldi
1644   4D7C ED A0       > ldi
1644   4D7E ED A0       > ldi
1644   4D80 ED A0       > ldi
1644   4D82 ED A0       > ldi
1644   4D84 ED A0       > ldi
1644   4D86 ED A0       > ldi
1644   4D88 ED A0       > ldi
1644   4D8A ED A0       > ldi
1644   4D8C ED A0       > ldi
1644   4D8E ED A0       > ldi
1644   4D90 ED A0       > ldi
1644   4D92 ED A0       > ldi
1644   4D94 ED A0       > ldi
1644   4D96 ED A0       > ldi
1644   4D98 ED A0       > ldi
1644   4D9A ED A0       > ldi
1644   4D9C ED A0       > ldi
1644   4D9E ED A0       > ldi
1644   4DA0 ED A0       > ldi
1644   4DA2 ED A0       > ldi
1644   4DA4 ED A0       > ldi
1644   4DA6 ED A0       > ldi
1644   4DA8 ED A0       > ldi
1644   4DAA ED A0       > ldi
1644   4DAC ED A0       > ldi
1644   4DAE ED A0       > ldi
1644   4DB0 ED A0       > ldi
1644   4DB2 ED A0       > ldi
1644   4DB4 ED A0       > ldi
1644   4DB6 ED A0       > ldi
1644   4DB8 ED A0       > ldi
1644   4DBA ED A0       > ldi
1644   4DBC ED A0       > ldi
1644   4DBE ED A0       > ldi
1644   4DC0 ED A0       > ldi
1644   4DC2 ED A0       > ldi
1644   4DC4 ED A0       > ldi
1644   4DC6 ED A0       > ldi
1644   4DC8 ED A0       > ldi
1644   4DCA ED A0       > ldi
1644   4DCC ED A0       > ldi
1644   4DCE ED A0       > ldi
1644   4DD0 ED A0       > ldi
1644   4DD2 ED A0       > ldi
1644   4DD4 ED A0       > ldi
1644   4DD6 ED A0       > ldi
1644   4DD8 ED A0       > ldi
1644   4DDA ED A0       > ldi
1644   4DDC ED A0       > ldi
1644   4DDE ED A0       > ldi
1644   4DE0 ED A0       > ldi
1644   4DE2 ED A0       > ldi
1644   4DE4 ED A0       > ldi
1644   4DE6 ED A0       > ldi
1644   4DE8 ED A0       > ldi
1644   4DEA ED A0       > ldi
1644   4DEC ED A0       > ldi
1644   4DEE ED A0       > ldi
1644   4DF0 ED A0       > ldi
1644   4DF2 ED A0       > ldi
1644   4DF4 ED A0       > ldi
1644   4DF6 ED A0       > ldi
1644   4DF8 ED A0       > ldi
1644   4DFA ED A0       > ldi
1644   4DFC ED A0       > ldi
1644   4DFE ED A0       > ldi
1644   4E00 ED A0       > ldi
1644   4E02 ED A0       > ldi
1644   4E04 ED A0       > ldi
1644   4E06 ED A0       > ldi
1644   4E08 ED A0       > ldi
1644   4E0A ED A0       > ldi
1644   4E0C ED A0       > ldi
1644   4E0E ED A0       > ldi
1644   4E10 ED A0       > ldi
1644   4E12 ED A0       > ldi
1644   4E14 ED A0       > ldi
1644   4E16 ED A0       > ldi
1644   4E18 ED A0       > ldi
1644   4E1A ED A0       > ldi
1644   4E1C ED A0       > ldi
1644   4E1E ED A0       > ldi
1644   4E20 ED A0       > ldi
1644   4E22 ED A0       > ldi
1644   4E24 ED A0       > ldi
1644   4E26 ED A0       > ldi
1644   4E28 ED A0       > ldi
1644   4E2A ED A0       > ldi
1644   4E2C ED A0       > ldi
1644   4E2E ED A0       > ldi
1644   4E30 ED A0       > ldi
1644   4E32 ED A0       > ldi
1644   4E34 ED A0       > ldi
1644   4E36 ED A0       > ldi
1644   4E38 ED A0       > ldi
1644   4E3A ED A0       > ldi
1644   4E3C ED A0       > ldi
1644   4E3E ED A0       > ldi
1644   4E40 ED A0       > ldi
1644   4E42 ED A0       > ldi
1644   4E44 ED A0       > ldi
1644   4E46 ED A0       > ldi
1644   4E48 ED A0       > ldi
1644   4E4A ED A0       > ldi
1644   4E4C ED A0       > ldi
1644   4E4E ED A0       > ldi
1644   4E50 ED A0       > ldi
1644   4E52 ED A0       > ldi
1644   4E54 ED A0       > ldi
1644   4E56 ED A0       > ldi
1644   4E58 ED A0       > ldi
1644   4E5A ED A0       > ldi
1644   4E5C ED A0       > ldi
1644   4E5E ED A0       > ldi
1644   4E60 ED A0       > ldi
1644   4E62 ED A0       > ldi
1644   4E64 ED A0       > ldi
1644   4E66 ED A0       > ldi
1644   4E68 ED A0       > ldi
1644   4E6A ED A0       > ldi
1644   4E6C ED A0       > ldi
1644   4E6E ED A0       > ldi
1644   4E70 ED A0       > ldi
1644   4E72 ED A0       > ldi
1644   4E74 ED A0       > ldi
1644   4E76 ED A0       > ldi
1644   4E78 ED A0       > ldi
1644   4E7A ED A0       > ldi
1644   4E7C ED A0       > ldi
1644   4E7E ED A0       > ldi
1644   4E80 ED A0       > ldi
1644   4E82 ED A0       > ldi
1644   4E84 ED A0       > ldi
1644   4E86 ED A0       > ldi
1644   4E88 ED A0       > ldi
1644   4E8A ED A0       > ldi
1644   4E8C ED A0       > ldi
1644   4E8E ED A0       > ldi
1644   4E90 ED A0       > ldi
1644   4E92 ED A0       > ldi
1644   4E94 ED A0       > ldi
1644   4E96 ED A0       > ldi
1644   4E98 ED A0       > ldi
1644   4E9A ED A0       > ldi
1644   4E9C ED A0       > ldi
1644   4E9E ED A0       > ldi
1644   4EA0 ED A0       > ldi
1644   4EA2 ED A0       > ldi
1644   4EA4 ED A0       > ldi
1644   4EA6 ED A0       > ldi
1644   4EA8 ED A0       > ldi
1644   4EAA ED A0       > ldi
1644   4EAC ED A0       > ldi
1644   4EAE ED A0       > ldi
1644   4EB0 ED A0       > ldi
1644   4EB2 ED A0       > ldi
1644   4EB4 ED A0       > ldi
1644   4EB6 ED A0       > ldi
1644   4EB8 ED A0       > ldi
1644   4EBA ED A0       > ldi
1644   4EBC ED A0       > ldi
1644   4EBE ED A0       > ldi
1644   4EC0 ED A0       > ldi
1644   4EC2 ED A0       > ldi
1644   4EC4 ED A0       > ldi
1644   4EC6 ED A0       > ldi
1644   4EC8 ED A0       > ldi
1644   4ECA ED A0       > ldi
1644   4ECC ED A0       > ldi
1644   4ECE ED A0       > ldi
1644   4ED0 ED A0       > ldi
1644   4ED2 ED A0       > ldi
1644   4ED4 ED A0       > ldi
1644   4ED6 ED A0       > ldi
1644   4ED8 ED A0       > ldi
1644   4EDA ED A0       > ldi
1644   4EDC ED A0       > ldi
1644   4EDE ED A0       > ldi
1644   4EE0 ED A0       > ldi
1644   4EE2 ED A0       > ldi
1644   4EE4 ED A0       > ldi
1644   4EE6 ED A0       > ldi
1644   4EE8 ED A0       > ldi
1644   4EEA ED A0       > ldi
1644   4EEC ED A0       > ldi
1644   4EEE ED A0       > ldi
1644   4EF0 ED A0       > ldi
1645   4EF2             .part2s: 
1646   4EF2 01 00 02    	ld	bc,512
1647   4EF5 ED B0       	ldir
1648   4EF7 3E FF       	ld	a, $FF		; envia dummy CRC
1649   4EF9 32 00 7B    	ld	(SPIDATA),a
1650   4EFC 32 00 7B    	ld	(SPIDATA),a
1651   4EFF CD 28 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1652   4F02 E6 1F       	and	$1F		; testa bits erro
1653   4F04 FE 05       	cp	5
1654   4F06 37          	scf
1655   4F07 C2 11 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1656   4F0A             .esp: 
1657   4F0A CD 28 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1658   4F0D B7          	or	a
1659   4F0E 28 FA       	jr	z,.esp
1660   4F10             .fim: 
1661   4F10 AF          	xor	a		; zera carry e informa nenhum erro
1662   4F11             terminaLeituraEscritaBloco: 
1663   4F11             ;	push	af
1664   4F11 CD A4 45    	call	disableSDs	; desabilitar todos os cartoes
1665   4F14             ;	pop	af
1666   4F14 C9          	ret
1667   4F15             
1668   4F15             
1669   4F15             ; ------------------------------------------------
1670   4F15             ; Ler um bloco de 512 bytes do cartao
1671   4F15             ; HL =  aponta para o inicio dos dados
1672   4F15             ; BC:DE = contem o numero do bloco (BCDE = 32 bits)
1673   4F15             ; IXH = Number of blocks
1674   4F15             ; IXL = SDcard version (0 or 1)
1675   4F15             ; Destroi AF, BC, DE, HL, IXL
1676   4F15             ; ------------------------------------------------
1677   4F15             LerBloco: 
1678   4F15 FD 7E 32    	ld	a,(iy+WRKAREA.NUMBLOCKS)	; save the number of blocks to transfer 
1679   4F18 DD 67       	ld	ixh,a		; ixh=Number of blocks
1680   4F1A             ;	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1681   4F1A DD 7D       	ld	a,ixl
1682   4F1C B7          	or	a
1683   4F1D CC 88 57    	call	z,blocoParaByte	; se for SDV1 coverter blocos para bytes
1684   4F20             ;	call	setaSDAtual
1685   4F20             
1686   4F20             
1687   4F20             
1688   4F20 FD 7E 32    	ld	a, (iy+WRKAREA.NUMBLOCKS)	; testar se Nextor quer ler um ou mais blocos
1689   4F23 3D          	dec	a
1690   4F24 CA 68 53    	jp	z,.umBloco	; somente um bloco, pular
1691   4F27             
1692   4F27             ; multiplos blocos
1693   4F27 3E 52       	ld	a, CMD18	; ler multiplos blocos com CMD18 = Read Multiple Blocks
1694   4F29 CD C0 45    	call	SD_SEND_CMD_GET_ERROR
1695   4F2C DA 11 4F    	jp	c,terminaLeituraEscritaBloco
1696   4F2F             .loop: 
1697   4F2F CD 1A 46    	call	WAIT_RESP_FE
1698   4F32 DA 11 4F    	jp	c,terminaLeituraEscritaBloco
1699   4F35 EB          	ex	de,hl
1700   4F36             	; Check for a Z80 or R800
1701   4F36             ;	or 	a		; Clear Cy
1702   4F36 3E 14       	ld	a,20
1703   4F38 ED F9       	db	#ED,#F9		; mulub a,a
1704   4F3A 21 00 7B    	ld	hl, SPIDATA
1705   4F3D DA 59 53    	jp	c,.r800m	; Use LDIR for R800
1706   4F40 ED A0       > ldi
1706   4F42 ED A0       > ldi
1706   4F44 ED A0       > ldi
1706   4F46 ED A0       > ldi
1706   4F48 ED A0       > ldi
1706   4F4A ED A0       > ldi
1706   4F4C ED A0       > ldi
1706   4F4E ED A0       > ldi
1706   4F50 ED A0       > ldi
1706   4F52 ED A0       > ldi
1706   4F54 ED A0       > ldi
1706   4F56 ED A0       > ldi
1706   4F58 ED A0       > ldi
1706   4F5A ED A0       > ldi
1706   4F5C ED A0       > ldi
1706   4F5E ED A0       > ldi
1706   4F60 ED A0       > ldi
1706   4F62 ED A0       > ldi
1706   4F64 ED A0       > ldi
1706   4F66 ED A0       > ldi
1706   4F68 ED A0       > ldi
1706   4F6A ED A0       > ldi
1706   4F6C ED A0       > ldi
1706   4F6E ED A0       > ldi
1706   4F70 ED A0       > ldi
1706   4F72 ED A0       > ldi
1706   4F74 ED A0       > ldi
1706   4F76 ED A0       > ldi
1706   4F78 ED A0       > ldi
1706   4F7A ED A0       > ldi
1706   4F7C ED A0       > ldi
1706   4F7E ED A0       > ldi
1706   4F80 ED A0       > ldi
1706   4F82 ED A0       > ldi
1706   4F84 ED A0       > ldi
1706   4F86 ED A0       > ldi
1706   4F88 ED A0       > ldi
1706   4F8A ED A0       > ldi
1706   4F8C ED A0       > ldi
1706   4F8E ED A0       > ldi
1706   4F90 ED A0       > ldi
1706   4F92 ED A0       > ldi
1706   4F94 ED A0       > ldi
1706   4F96 ED A0       > ldi
1706   4F98 ED A0       > ldi
1706   4F9A ED A0       > ldi
1706   4F9C ED A0       > ldi
1706   4F9E ED A0       > ldi
1706   4FA0 ED A0       > ldi
1706   4FA2 ED A0       > ldi
1706   4FA4 ED A0       > ldi
1706   4FA6 ED A0       > ldi
1706   4FA8 ED A0       > ldi
1706   4FAA ED A0       > ldi
1706   4FAC ED A0       > ldi
1706   4FAE ED A0       > ldi
1706   4FB0 ED A0       > ldi
1706   4FB2 ED A0       > ldi
1706   4FB4 ED A0       > ldi
1706   4FB6 ED A0       > ldi
1706   4FB8 ED A0       > ldi
1706   4FBA ED A0       > ldi
1706   4FBC ED A0       > ldi
1706   4FBE ED A0       > ldi
1706   4FC0 ED A0       > ldi
1706   4FC2 ED A0       > ldi
1706   4FC4 ED A0       > ldi
1706   4FC6 ED A0       > ldi
1706   4FC8 ED A0       > ldi
1706   4FCA ED A0       > ldi
1706   4FCC ED A0       > ldi
1706   4FCE ED A0       > ldi
1706   4FD0 ED A0       > ldi
1706   4FD2 ED A0       > ldi
1706   4FD4 ED A0       > ldi
1706   4FD6 ED A0       > ldi
1706   4FD8 ED A0       > ldi
1706   4FDA ED A0       > ldi
1706   4FDC ED A0       > ldi
1706   4FDE ED A0       > ldi
1706   4FE0 ED A0       > ldi
1706   4FE2 ED A0       > ldi
1706   4FE4 ED A0       > ldi
1706   4FE6 ED A0       > ldi
1706   4FE8 ED A0       > ldi
1706   4FEA ED A0       > ldi
1706   4FEC ED A0       > ldi
1706   4FEE ED A0       > ldi
1706   4FF0 ED A0       > ldi
1706   4FF2 ED A0       > ldi
1706   4FF4 ED A0       > ldi
1706   4FF6 ED A0       > ldi
1706   4FF8 ED A0       > ldi
1706   4FFA ED A0       > ldi
1706   4FFC ED A0       > ldi
1706   4FFE ED A0       > ldi
1706   5000 ED A0       > ldi
1706   5002 ED A0       > ldi
1706   5004 ED A0       > ldi
1706   5006 ED A0       > ldi
1706   5008 ED A0       > ldi
1706   500A ED A0       > ldi
1706   500C ED A0       > ldi
1706   500E ED A0       > ldi
1706   5010 ED A0       > ldi
1706   5012 ED A0       > ldi
1706   5014 ED A0       > ldi
1706   5016 ED A0       > ldi
1706   5018 ED A0       > ldi
1706   501A ED A0       > ldi
1706   501C ED A0       > ldi
1706   501E ED A0       > ldi
1706   5020 ED A0       > ldi
1706   5022 ED A0       > ldi
1706   5024 ED A0       > ldi
1706   5026 ED A0       > ldi
1706   5028 ED A0       > ldi
1706   502A ED A0       > ldi
1706   502C ED A0       > ldi
1706   502E ED A0       > ldi
1706   5030 ED A0       > ldi
1706   5032 ED A0       > ldi
1706   5034 ED A0       > ldi
1706   5036 ED A0       > ldi
1706   5038 ED A0       > ldi
1706   503A ED A0       > ldi
1706   503C ED A0       > ldi
1706   503E ED A0       > ldi
1706   5040 ED A0       > ldi
1706   5042 ED A0       > ldi
1706   5044 ED A0       > ldi
1706   5046 ED A0       > ldi
1706   5048 ED A0       > ldi
1706   504A ED A0       > ldi
1706   504C ED A0       > ldi
1706   504E ED A0       > ldi
1706   5050 ED A0       > ldi
1706   5052 ED A0       > ldi
1706   5054 ED A0       > ldi
1706   5056 ED A0       > ldi
1706   5058 ED A0       > ldi
1706   505A ED A0       > ldi
1706   505C ED A0       > ldi
1706   505E ED A0       > ldi
1706   5060 ED A0       > ldi
1706   5062 ED A0       > ldi
1706   5064 ED A0       > ldi
1706   5066 ED A0       > ldi
1706   5068 ED A0       > ldi
1706   506A ED A0       > ldi
1706   506C ED A0       > ldi
1706   506E ED A0       > ldi
1706   5070 ED A0       > ldi
1706   5072 ED A0       > ldi
1706   5074 ED A0       > ldi
1706   5076 ED A0       > ldi
1706   5078 ED A0       > ldi
1706   507A ED A0       > ldi
1706   507C ED A0       > ldi
1706   507E ED A0       > ldi
1706   5080 ED A0       > ldi
1706   5082 ED A0       > ldi
1706   5084 ED A0       > ldi
1706   5086 ED A0       > ldi
1706   5088 ED A0       > ldi
1706   508A ED A0       > ldi
1706   508C ED A0       > ldi
1706   508E ED A0       > ldi
1706   5090 ED A0       > ldi
1706   5092 ED A0       > ldi
1706   5094 ED A0       > ldi
1706   5096 ED A0       > ldi
1706   5098 ED A0       > ldi
1706   509A ED A0       > ldi
1706   509C ED A0       > ldi
1706   509E ED A0       > ldi
1706   50A0 ED A0       > ldi
1706   50A2 ED A0       > ldi
1706   50A4 ED A0       > ldi
1706   50A6 ED A0       > ldi
1706   50A8 ED A0       > ldi
1706   50AA ED A0       > ldi
1706   50AC ED A0       > ldi
1706   50AE ED A0       > ldi
1706   50B0 ED A0       > ldi
1706   50B2 ED A0       > ldi
1706   50B4 ED A0       > ldi
1706   50B6 ED A0       > ldi
1706   50B8 ED A0       > ldi
1706   50BA ED A0       > ldi
1706   50BC ED A0       > ldi
1706   50BE ED A0       > ldi
1706   50C0 ED A0       > ldi
1706   50C2 ED A0       > ldi
1706   50C4 ED A0       > ldi
1706   50C6 ED A0       > ldi
1706   50C8 ED A0       > ldi
1706   50CA ED A0       > ldi
1706   50CC ED A0       > ldi
1706   50CE ED A0       > ldi
1706   50D0 ED A0       > ldi
1706   50D2 ED A0       > ldi
1706   50D4 ED A0       > ldi
1706   50D6 ED A0       > ldi
1706   50D8 ED A0       > ldi
1706   50DA ED A0       > ldi
1706   50DC ED A0       > ldi
1706   50DE ED A0       > ldi
1706   50E0 ED A0       > ldi
1706   50E2 ED A0       > ldi
1706   50E4 ED A0       > ldi
1706   50E6 ED A0       > ldi
1706   50E8 ED A0       > ldi
1706   50EA ED A0       > ldi
1706   50EC ED A0       > ldi
1706   50EE ED A0       > ldi
1706   50F0 ED A0       > ldi
1706   50F2 ED A0       > ldi
1706   50F4 ED A0       > ldi
1706   50F6 ED A0       > ldi
1706   50F8 ED A0       > ldi
1706   50FA ED A0       > ldi
1706   50FC ED A0       > ldi
1706   50FE ED A0       > ldi
1706   5100 ED A0       > ldi
1706   5102 ED A0       > ldi
1706   5104 ED A0       > ldi
1706   5106 ED A0       > ldi
1706   5108 ED A0       > ldi
1706   510A ED A0       > ldi
1706   510C ED A0       > ldi
1706   510E ED A0       > ldi
1706   5110 ED A0       > ldi
1706   5112 ED A0       > ldi
1706   5114 ED A0       > ldi
1706   5116 ED A0       > ldi
1706   5118 ED A0       > ldi
1706   511A ED A0       > ldi
1706   511C ED A0       > ldi
1706   511E ED A0       > ldi
1706   5120 ED A0       > ldi
1706   5122 ED A0       > ldi
1706   5124 ED A0       > ldi
1706   5126 ED A0       > ldi
1706   5128 ED A0       > ldi
1706   512A ED A0       > ldi
1706   512C ED A0       > ldi
1706   512E ED A0       > ldi
1706   5130 ED A0       > ldi
1706   5132 ED A0       > ldi
1706   5134 ED A0       > ldi
1706   5136 ED A0       > ldi
1706   5138 ED A0       > ldi
1706   513A ED A0       > ldi
1706   513C ED A0       > ldi
1706   513E ED A0       > ldi
1706   5140 ED A0       > ldi
1706   5142 ED A0       > ldi
1706   5144 ED A0       > ldi
1706   5146 ED A0       > ldi
1706   5148 ED A0       > ldi
1706   514A ED A0       > ldi
1706   514C ED A0       > ldi
1706   514E ED A0       > ldi
1706   5150 ED A0       > ldi
1706   5152 ED A0       > ldi
1706   5154 ED A0       > ldi
1706   5156 ED A0       > ldi
1706   5158 ED A0       > ldi
1706   515A ED A0       > ldi
1706   515C ED A0       > ldi
1706   515E ED A0       > ldi
1706   5160 ED A0       > ldi
1706   5162 ED A0       > ldi
1706   5164 ED A0       > ldi
1706   5166 ED A0       > ldi
1706   5168 ED A0       > ldi
1706   516A ED A0       > ldi
1706   516C ED A0       > ldi
1706   516E ED A0       > ldi
1706   5170 ED A0       > ldi
1706   5172 ED A0       > ldi
1706   5174 ED A0       > ldi
1706   5176 ED A0       > ldi
1706   5178 ED A0       > ldi
1706   517A ED A0       > ldi
1706   517C ED A0       > ldi
1706   517E ED A0       > ldi
1706   5180 ED A0       > ldi
1706   5182 ED A0       > ldi
1706   5184 ED A0       > ldi
1706   5186 ED A0       > ldi
1706   5188 ED A0       > ldi
1706   518A ED A0       > ldi
1706   518C ED A0       > ldi
1706   518E ED A0       > ldi
1706   5190 ED A0       > ldi
1706   5192 ED A0       > ldi
1706   5194 ED A0       > ldi
1706   5196 ED A0       > ldi
1706   5198 ED A0       > ldi
1706   519A ED A0       > ldi
1706   519C ED A0       > ldi
1706   519E ED A0       > ldi
1706   51A0 ED A0       > ldi
1706   51A2 ED A0       > ldi
1706   51A4 ED A0       > ldi
1706   51A6 ED A0       > ldi
1706   51A8 ED A0       > ldi
1706   51AA ED A0       > ldi
1706   51AC ED A0       > ldi
1706   51AE ED A0       > ldi
1706   51B0 ED A0       > ldi
1706   51B2 ED A0       > ldi
1706   51B4 ED A0       > ldi
1706   51B6 ED A0       > ldi
1706   51B8 ED A0       > ldi
1706   51BA ED A0       > ldi
1706   51BC ED A0       > ldi
1706   51BE ED A0       > ldi
1706   51C0 ED A0       > ldi
1706   51C2 ED A0       > ldi
1706   51C4 ED A0       > ldi
1706   51C6 ED A0       > ldi
1706   51C8 ED A0       > ldi
1706   51CA ED A0       > ldi
1706   51CC ED A0       > ldi
1706   51CE ED A0       > ldi
1706   51D0 ED A0       > ldi
1706   51D2 ED A0       > ldi
1706   51D4 ED A0       > ldi
1706   51D6 ED A0       > ldi
1706   51D8 ED A0       > ldi
1706   51DA ED A0       > ldi
1706   51DC ED A0       > ldi
1706   51DE ED A0       > ldi
1706   51E0 ED A0       > ldi
1706   51E2 ED A0       > ldi
1706   51E4 ED A0       > ldi
1706   51E6 ED A0       > ldi
1706   51E8 ED A0       > ldi
1706   51EA ED A0       > ldi
1706   51EC ED A0       > ldi
1706   51EE ED A0       > ldi
1706   51F0 ED A0       > ldi
1706   51F2 ED A0       > ldi
1706   51F4 ED A0       > ldi
1706   51F6 ED A0       > ldi
1706   51F8 ED A0       > ldi
1706   51FA ED A0       > ldi
1706   51FC ED A0       > ldi
1706   51FE ED A0       > ldi
1706   5200 ED A0       > ldi
1706   5202 ED A0       > ldi
1706   5204 ED A0       > ldi
1706   5206 ED A0       > ldi
1706   5208 ED A0       > ldi
1706   520A ED A0       > ldi
1706   520C ED A0       > ldi
1706   520E ED A0       > ldi
1706   5210 ED A0       > ldi
1706   5212 ED A0       > ldi
1706   5214 ED A0       > ldi
1706   5216 ED A0       > ldi
1706   5218 ED A0       > ldi
1706   521A ED A0       > ldi
1706   521C ED A0       > ldi
1706   521E ED A0       > ldi
1706   5220 ED A0       > ldi
1706   5222 ED A0       > ldi
1706   5224 ED A0       > ldi
1706   5226 ED A0       > ldi
1706   5228 ED A0       > ldi
1706   522A ED A0       > ldi
1706   522C ED A0       > ldi
1706   522E ED A0       > ldi
1706   5230 ED A0       > ldi
1706   5232 ED A0       > ldi
1706   5234 ED A0       > ldi
1706   5236 ED A0       > ldi
1706   5238 ED A0       > ldi
1706   523A ED A0       > ldi
1706   523C ED A0       > ldi
1706   523E ED A0       > ldi
1706   5240 ED A0       > ldi
1706   5242 ED A0       > ldi
1706   5244 ED A0       > ldi
1706   5246 ED A0       > ldi
1706   5248 ED A0       > ldi
1706   524A ED A0       > ldi
1706   524C ED A0       > ldi
1706   524E ED A0       > ldi
1706   5250 ED A0       > ldi
1706   5252 ED A0       > ldi
1706   5254 ED A0       > ldi
1706   5256 ED A0       > ldi
1706   5258 ED A0       > ldi
1706   525A ED A0       > ldi
1706   525C ED A0       > ldi
1706   525E ED A0       > ldi
1706   5260 ED A0       > ldi
1706   5262 ED A0       > ldi
1706   5264 ED A0       > ldi
1706   5266 ED A0       > ldi
1706   5268 ED A0       > ldi
1706   526A ED A0       > ldi
1706   526C ED A0       > ldi
1706   526E ED A0       > ldi
1706   5270 ED A0       > ldi
1706   5272 ED A0       > ldi
1706   5274 ED A0       > ldi
1706   5276 ED A0       > ldi
1706   5278 ED A0       > ldi
1706   527A ED A0       > ldi
1706   527C ED A0       > ldi
1706   527E ED A0       > ldi
1706   5280 ED A0       > ldi
1706   5282 ED A0       > ldi
1706   5284 ED A0       > ldi
1706   5286 ED A0       > ldi
1706   5288 ED A0       > ldi
1706   528A ED A0       > ldi
1706   528C ED A0       > ldi
1706   528E ED A0       > ldi
1706   5290 ED A0       > ldi
1706   5292 ED A0       > ldi
1706   5294 ED A0       > ldi
1706   5296 ED A0       > ldi
1706   5298 ED A0       > ldi
1706   529A ED A0       > ldi
1706   529C ED A0       > ldi
1706   529E ED A0       > ldi
1706   52A0 ED A0       > ldi
1706   52A2 ED A0       > ldi
1706   52A4 ED A0       > ldi
1706   52A6 ED A0       > ldi
1706   52A8 ED A0       > ldi
1706   52AA ED A0       > ldi
1706   52AC ED A0       > ldi
1706   52AE ED A0       > ldi
1706   52B0 ED A0       > ldi
1706   52B2 ED A0       > ldi
1706   52B4 ED A0       > ldi
1706   52B6 ED A0       > ldi
1706   52B8 ED A0       > ldi
1706   52BA ED A0       > ldi
1706   52BC ED A0       > ldi
1706   52BE ED A0       > ldi
1706   52C0 ED A0       > ldi
1706   52C2 ED A0       > ldi
1706   52C4 ED A0       > ldi
1706   52C6 ED A0       > ldi
1706   52C8 ED A0       > ldi
1706   52CA ED A0       > ldi
1706   52CC ED A0       > ldi
1706   52CE ED A0       > ldi
1706   52D0 ED A0       > ldi
1706   52D2 ED A0       > ldi
1706   52D4 ED A0       > ldi
1706   52D6 ED A0       > ldi
1706   52D8 ED A0       > ldi
1706   52DA ED A0       > ldi
1706   52DC ED A0       > ldi
1706   52DE ED A0       > ldi
1706   52E0 ED A0       > ldi
1706   52E2 ED A0       > ldi
1706   52E4 ED A0       > ldi
1706   52E6 ED A0       > ldi
1706   52E8 ED A0       > ldi
1706   52EA ED A0       > ldi
1706   52EC ED A0       > ldi
1706   52EE ED A0       > ldi
1706   52F0 ED A0       > ldi
1706   52F2 ED A0       > ldi
1706   52F4 ED A0       > ldi
1706   52F6 ED A0       > ldi
1706   52F8 ED A0       > ldi
1706   52FA ED A0       > ldi
1706   52FC ED A0       > ldi
1706   52FE ED A0       > ldi
1706   5300 ED A0       > ldi
1706   5302 ED A0       > ldi
1706   5304 ED A0       > ldi
1706   5306 ED A0       > ldi
1706   5308 ED A0       > ldi
1706   530A ED A0       > ldi
1706   530C ED A0       > ldi
1706   530E ED A0       > ldi
1706   5310 ED A0       > ldi
1706   5312 ED A0       > ldi
1706   5314 ED A0       > ldi
1706   5316 ED A0       > ldi
1706   5318 ED A0       > ldi
1706   531A ED A0       > ldi
1706   531C ED A0       > ldi
1706   531E ED A0       > ldi
1706   5320 ED A0       > ldi
1706   5322 ED A0       > ldi
1706   5324 ED A0       > ldi
1706   5326 ED A0       > ldi
1706   5328 ED A0       > ldi
1706   532A ED A0       > ldi
1706   532C ED A0       > ldi
1706   532E ED A0       > ldi
1706   5330 ED A0       > ldi
1706   5332 ED A0       > ldi
1706   5334 ED A0       > ldi
1706   5336 ED A0       > ldi
1706   5338 ED A0       > ldi
1706   533A ED A0       > ldi
1706   533C ED A0       > ldi
1706   533E ED A0       > ldi
1707   5340             .part2m: 
1708   5340 EB          	ex	de,hl
1709   5341 3A 00 7B    	ld	a, (SPIDATA)	; descarta CRC
1710   5344 3A 00 7B    	ld	a, (SPIDATA)
1711   5347 FD 7E 32    	ld	a, (iy+WRKAREA.NUMBLOCKS)	; testar se tem mais blocos para ler
1712   534A 3D          	dec	a
1713   534B FD 77 32    	ld	(iy+WRKAREA.NUMBLOCKS), a
1714   534E C2 2F 4F    	jp	nz,.loop
1715   5351 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1716   5353 CD BB 45    	call	SD_SEND_CMD_NO_ARGS
1717   5356 C3 84 57    	jp	.fim
1718   5359             
1719   5359 01 00 02    .r800m:  ld	bc,512
1720   535C ED B0       	ldir
1721   535E 18 E0       	jr	.part2m
1722   5360             
1723   5360 01 00 02    .r800s: 	ld	bc,512
1724   5363 ED B0       	ldir
1725   5365 C3 80 57    	jp	.part2s
1726   5368             
1727   5368             .umBloco: 
1728   5368 3E 51       	ld	a, CMD17	; ler somente um bloco com CMD17 = Read Single Block
1729   536A CD C0 45    	call	SD_SEND_CMD_GET_ERROR
1730   536D DA 11 4F    	jp	c,terminaLeituraEscritaBloco
1731   5370             
1732   5370 CD 1A 46    	call	WAIT_RESP_FE
1733   5373 DA 11 4F    	jp	c,terminaLeituraEscritaBloco
1734   5376 EB          	ex	de,hl
1735   5377             
1736   5377             	; Check for a Z80 or R800
1737   5377             ;	or 	a		; Clear Cy
1738   5377 3E 14       	ld	a,20
1739   5379 ED F9       	db	#ED,#F9		; mulub a,a
1740   537B 21 00 7B    	ld	hl, SPIDATA
1741   537E 38 E0       	jr	c,.r800s	; Use LDIR for R800
1742   5380 ED A0       > ldi
1742   5382 ED A0       > ldi
1742   5384 ED A0       > ldi
1742   5386 ED A0       > ldi
1742   5388 ED A0       > ldi
1742   538A ED A0       > ldi
1742   538C ED A0       > ldi
1742   538E ED A0       > ldi
1742   5390 ED A0       > ldi
1742   5392 ED A0       > ldi
1742   5394 ED A0       > ldi
1742   5396 ED A0       > ldi
1742   5398 ED A0       > ldi
1742   539A ED A0       > ldi
1742   539C ED A0       > ldi
1742   539E ED A0       > ldi
1742   53A0 ED A0       > ldi
1742   53A2 ED A0       > ldi
1742   53A4 ED A0       > ldi
1742   53A6 ED A0       > ldi
1742   53A8 ED A0       > ldi
1742   53AA ED A0       > ldi
1742   53AC ED A0       > ldi
1742   53AE ED A0       > ldi
1742   53B0 ED A0       > ldi
1742   53B2 ED A0       > ldi
1742   53B4 ED A0       > ldi
1742   53B6 ED A0       > ldi
1742   53B8 ED A0       > ldi
1742   53BA ED A0       > ldi
1742   53BC ED A0       > ldi
1742   53BE ED A0       > ldi
1742   53C0 ED A0       > ldi
1742   53C2 ED A0       > ldi
1742   53C4 ED A0       > ldi
1742   53C6 ED A0       > ldi
1742   53C8 ED A0       > ldi
1742   53CA ED A0       > ldi
1742   53CC ED A0       > ldi
1742   53CE ED A0       > ldi
1742   53D0 ED A0       > ldi
1742   53D2 ED A0       > ldi
1742   53D4 ED A0       > ldi
1742   53D6 ED A0       > ldi
1742   53D8 ED A0       > ldi
1742   53DA ED A0       > ldi
1742   53DC ED A0       > ldi
1742   53DE ED A0       > ldi
1742   53E0 ED A0       > ldi
1742   53E2 ED A0       > ldi
1742   53E4 ED A0       > ldi
1742   53E6 ED A0       > ldi
1742   53E8 ED A0       > ldi
1742   53EA ED A0       > ldi
1742   53EC ED A0       > ldi
1742   53EE ED A0       > ldi
1742   53F0 ED A0       > ldi
1742   53F2 ED A0       > ldi
1742   53F4 ED A0       > ldi
1742   53F6 ED A0       > ldi
1742   53F8 ED A0       > ldi
1742   53FA ED A0       > ldi
1742   53FC ED A0       > ldi
1742   53FE ED A0       > ldi
1742   5400 ED A0       > ldi
1742   5402 ED A0       > ldi
1742   5404 ED A0       > ldi
1742   5406 ED A0       > ldi
1742   5408 ED A0       > ldi
1742   540A ED A0       > ldi
1742   540C ED A0       > ldi
1742   540E ED A0       > ldi
1742   5410 ED A0       > ldi
1742   5412 ED A0       > ldi
1742   5414 ED A0       > ldi
1742   5416 ED A0       > ldi
1742   5418 ED A0       > ldi
1742   541A ED A0       > ldi
1742   541C ED A0       > ldi
1742   541E ED A0       > ldi
1742   5420 ED A0       > ldi
1742   5422 ED A0       > ldi
1742   5424 ED A0       > ldi
1742   5426 ED A0       > ldi
1742   5428 ED A0       > ldi
1742   542A ED A0       > ldi
1742   542C ED A0       > ldi
1742   542E ED A0       > ldi
1742   5430 ED A0       > ldi
1742   5432 ED A0       > ldi
1742   5434 ED A0       > ldi
1742   5436 ED A0       > ldi
1742   5438 ED A0       > ldi
1742   543A ED A0       > ldi
1742   543C ED A0       > ldi
1742   543E ED A0       > ldi
1742   5440 ED A0       > ldi
1742   5442 ED A0       > ldi
1742   5444 ED A0       > ldi
1742   5446 ED A0       > ldi
1742   5448 ED A0       > ldi
1742   544A ED A0       > ldi
1742   544C ED A0       > ldi
1742   544E ED A0       > ldi
1742   5450 ED A0       > ldi
1742   5452 ED A0       > ldi
1742   5454 ED A0       > ldi
1742   5456 ED A0       > ldi
1742   5458 ED A0       > ldi
1742   545A ED A0       > ldi
1742   545C ED A0       > ldi
1742   545E ED A0       > ldi
1742   5460 ED A0       > ldi
1742   5462 ED A0       > ldi
1742   5464 ED A0       > ldi
1742   5466 ED A0       > ldi
1742   5468 ED A0       > ldi
1742   546A ED A0       > ldi
1742   546C ED A0       > ldi
1742   546E ED A0       > ldi
1742   5470 ED A0       > ldi
1742   5472 ED A0       > ldi
1742   5474 ED A0       > ldi
1742   5476 ED A0       > ldi
1742   5478 ED A0       > ldi
1742   547A ED A0       > ldi
1742   547C ED A0       > ldi
1742   547E ED A0       > ldi
1742   5480 ED A0       > ldi
1742   5482 ED A0       > ldi
1742   5484 ED A0       > ldi
1742   5486 ED A0       > ldi
1742   5488 ED A0       > ldi
1742   548A ED A0       > ldi
1742   548C ED A0       > ldi
1742   548E ED A0       > ldi
1742   5490 ED A0       > ldi
1742   5492 ED A0       > ldi
1742   5494 ED A0       > ldi
1742   5496 ED A0       > ldi
1742   5498 ED A0       > ldi
1742   549A ED A0       > ldi
1742   549C ED A0       > ldi
1742   549E ED A0       > ldi
1742   54A0 ED A0       > ldi
1742   54A2 ED A0       > ldi
1742   54A4 ED A0       > ldi
1742   54A6 ED A0       > ldi
1742   54A8 ED A0       > ldi
1742   54AA ED A0       > ldi
1742   54AC ED A0       > ldi
1742   54AE ED A0       > ldi
1742   54B0 ED A0       > ldi
1742   54B2 ED A0       > ldi
1742   54B4 ED A0       > ldi
1742   54B6 ED A0       > ldi
1742   54B8 ED A0       > ldi
1742   54BA ED A0       > ldi
1742   54BC ED A0       > ldi
1742   54BE ED A0       > ldi
1742   54C0 ED A0       > ldi
1742   54C2 ED A0       > ldi
1742   54C4 ED A0       > ldi
1742   54C6 ED A0       > ldi
1742   54C8 ED A0       > ldi
1742   54CA ED A0       > ldi
1742   54CC ED A0       > ldi
1742   54CE ED A0       > ldi
1742   54D0 ED A0       > ldi
1742   54D2 ED A0       > ldi
1742   54D4 ED A0       > ldi
1742   54D6 ED A0       > ldi
1742   54D8 ED A0       > ldi
1742   54DA ED A0       > ldi
1742   54DC ED A0       > ldi
1742   54DE ED A0       > ldi
1742   54E0 ED A0       > ldi
1742   54E2 ED A0       > ldi
1742   54E4 ED A0       > ldi
1742   54E6 ED A0       > ldi
1742   54E8 ED A0       > ldi
1742   54EA ED A0       > ldi
1742   54EC ED A0       > ldi
1742   54EE ED A0       > ldi
1742   54F0 ED A0       > ldi
1742   54F2 ED A0       > ldi
1742   54F4 ED A0       > ldi
1742   54F6 ED A0       > ldi
1742   54F8 ED A0       > ldi
1742   54FA ED A0       > ldi
1742   54FC ED A0       > ldi
1742   54FE ED A0       > ldi
1742   5500 ED A0       > ldi
1742   5502 ED A0       > ldi
1742   5504 ED A0       > ldi
1742   5506 ED A0       > ldi
1742   5508 ED A0       > ldi
1742   550A ED A0       > ldi
1742   550C ED A0       > ldi
1742   550E ED A0       > ldi
1742   5510 ED A0       > ldi
1742   5512 ED A0       > ldi
1742   5514 ED A0       > ldi
1742   5516 ED A0       > ldi
1742   5518 ED A0       > ldi
1742   551A ED A0       > ldi
1742   551C ED A0       > ldi
1742   551E ED A0       > ldi
1742   5520 ED A0       > ldi
1742   5522 ED A0       > ldi
1742   5524 ED A0       > ldi
1742   5526 ED A0       > ldi
1742   5528 ED A0       > ldi
1742   552A ED A0       > ldi
1742   552C ED A0       > ldi
1742   552E ED A0       > ldi
1742   5530 ED A0       > ldi
1742   5532 ED A0       > ldi
1742   5534 ED A0       > ldi
1742   5536 ED A0       > ldi
1742   5538 ED A0       > ldi
1742   553A ED A0       > ldi
1742   553C ED A0       > ldi
1742   553E ED A0       > ldi
1742   5540 ED A0       > ldi
1742   5542 ED A0       > ldi
1742   5544 ED A0       > ldi
1742   5546 ED A0       > ldi
1742   5548 ED A0       > ldi
1742   554A ED A0       > ldi
1742   554C ED A0       > ldi
1742   554E ED A0       > ldi
1742   5550 ED A0       > ldi
1742   5552 ED A0       > ldi
1742   5554 ED A0       > ldi
1742   5556 ED A0       > ldi
1742   5558 ED A0       > ldi
1742   555A ED A0       > ldi
1742   555C ED A0       > ldi
1742   555E ED A0       > ldi
1742   5560 ED A0       > ldi
1742   5562 ED A0       > ldi
1742   5564 ED A0       > ldi
1742   5566 ED A0       > ldi
1742   5568 ED A0       > ldi
1742   556A ED A0       > ldi
1742   556C ED A0       > ldi
1742   556E ED A0       > ldi
1742   5570 ED A0       > ldi
1742   5572 ED A0       > ldi
1742   5574 ED A0       > ldi
1742   5576 ED A0       > ldi
1742   5578 ED A0       > ldi
1742   557A ED A0       > ldi
1742   557C ED A0       > ldi
1742   557E ED A0       > ldi
1742   5580 ED A0       > ldi
1742   5582 ED A0       > ldi
1742   5584 ED A0       > ldi
1742   5586 ED A0       > ldi
1742   5588 ED A0       > ldi
1742   558A ED A0       > ldi
1742   558C ED A0       > ldi
1742   558E ED A0       > ldi
1742   5590 ED A0       > ldi
1742   5592 ED A0       > ldi
1742   5594 ED A0       > ldi
1742   5596 ED A0       > ldi
1742   5598 ED A0       > ldi
1742   559A ED A0       > ldi
1742   559C ED A0       > ldi
1742   559E ED A0       > ldi
1742   55A0 ED A0       > ldi
1742   55A2 ED A0       > ldi
1742   55A4 ED A0       > ldi
1742   55A6 ED A0       > ldi
1742   55A8 ED A0       > ldi
1742   55AA ED A0       > ldi
1742   55AC ED A0       > ldi
1742   55AE ED A0       > ldi
1742   55B0 ED A0       > ldi
1742   55B2 ED A0       > ldi
1742   55B4 ED A0       > ldi
1742   55B6 ED A0       > ldi
1742   55B8 ED A0       > ldi
1742   55BA ED A0       > ldi
1742   55BC ED A0       > ldi
1742   55BE ED A0       > ldi
1742   55C0 ED A0       > ldi
1742   55C2 ED A0       > ldi
1742   55C4 ED A0       > ldi
1742   55C6 ED A0       > ldi
1742   55C8 ED A0       > ldi
1742   55CA ED A0       > ldi
1742   55CC ED A0       > ldi
1742   55CE ED A0       > ldi
1742   55D0 ED A0       > ldi
1742   55D2 ED A0       > ldi
1742   55D4 ED A0       > ldi
1742   55D6 ED A0       > ldi
1742   55D8 ED A0       > ldi
1742   55DA ED A0       > ldi
1742   55DC ED A0       > ldi
1742   55DE ED A0       > ldi
1742   55E0 ED A0       > ldi
1742   55E2 ED A0       > ldi
1742   55E4 ED A0       > ldi
1742   55E6 ED A0       > ldi
1742   55E8 ED A0       > ldi
1742   55EA ED A0       > ldi
1742   55EC ED A0       > ldi
1742   55EE ED A0       > ldi
1742   55F0 ED A0       > ldi
1742   55F2 ED A0       > ldi
1742   55F4 ED A0       > ldi
1742   55F6 ED A0       > ldi
1742   55F8 ED A0       > ldi
1742   55FA ED A0       > ldi
1742   55FC ED A0       > ldi
1742   55FE ED A0       > ldi
1742   5600 ED A0       > ldi
1742   5602 ED A0       > ldi
1742   5604 ED A0       > ldi
1742   5606 ED A0       > ldi
1742   5608 ED A0       > ldi
1742   560A ED A0       > ldi
1742   560C ED A0       > ldi
1742   560E ED A0       > ldi
1742   5610 ED A0       > ldi
1742   5612 ED A0       > ldi
1742   5614 ED A0       > ldi
1742   5616 ED A0       > ldi
1742   5618 ED A0       > ldi
1742   561A ED A0       > ldi
1742   561C ED A0       > ldi
1742   561E ED A0       > ldi
1742   5620 ED A0       > ldi
1742   5622 ED A0       > ldi
1742   5624 ED A0       > ldi
1742   5626 ED A0       > ldi
1742   5628 ED A0       > ldi
1742   562A ED A0       > ldi
1742   562C ED A0       > ldi
1742   562E ED A0       > ldi
1742   5630 ED A0       > ldi
1742   5632 ED A0       > ldi
1742   5634 ED A0       > ldi
1742   5636 ED A0       > ldi
1742   5638 ED A0       > ldi
1742   563A ED A0       > ldi
1742   563C ED A0       > ldi
1742   563E ED A0       > ldi
1742   5640 ED A0       > ldi
1742   5642 ED A0       > ldi
1742   5644 ED A0       > ldi
1742   5646 ED A0       > ldi
1742   5648 ED A0       > ldi
1742   564A ED A0       > ldi
1742   564C ED A0       > ldi
1742   564E ED A0       > ldi
1742   5650 ED A0       > ldi
1742   5652 ED A0       > ldi
1742   5654 ED A0       > ldi
1742   5656 ED A0       > ldi
1742   5658 ED A0       > ldi
1742   565A ED A0       > ldi
1742   565C ED A0       > ldi
1742   565E ED A0       > ldi
1742   5660 ED A0       > ldi
1742   5662 ED A0       > ldi
1742   5664 ED A0       > ldi
1742   5666 ED A0       > ldi
1742   5668 ED A0       > ldi
1742   566A ED A0       > ldi
1742   566C ED A0       > ldi
1742   566E ED A0       > ldi
1742   5670 ED A0       > ldi
1742   5672 ED A0       > ldi
1742   5674 ED A0       > ldi
1742   5676 ED A0       > ldi
1742   5678 ED A0       > ldi
1742   567A ED A0       > ldi
1742   567C ED A0       > ldi
1742   567E ED A0       > ldi
1742   5680 ED A0       > ldi
1742   5682 ED A0       > ldi
1742   5684 ED A0       > ldi
1742   5686 ED A0       > ldi
1742   5688 ED A0       > ldi
1742   568A ED A0       > ldi
1742   568C ED A0       > ldi
1742   568E ED A0       > ldi
1742   5690 ED A0       > ldi
1742   5692 ED A0       > ldi
1742   5694 ED A0       > ldi
1742   5696 ED A0       > ldi
1742   5698 ED A0       > ldi
1742   569A ED A0       > ldi
1742   569C ED A0       > ldi
1742   569E ED A0       > ldi
1742   56A0 ED A0       > ldi
1742   56A2 ED A0       > ldi
1742   56A4 ED A0       > ldi
1742   56A6 ED A0       > ldi
1742   56A8 ED A0       > ldi
1742   56AA ED A0       > ldi
1742   56AC ED A0       > ldi
1742   56AE ED A0       > ldi
1742   56B0 ED A0       > ldi
1742   56B2 ED A0       > ldi
1742   56B4 ED A0       > ldi
1742   56B6 ED A0       > ldi
1742   56B8 ED A0       > ldi
1742   56BA ED A0       > ldi
1742   56BC ED A0       > ldi
1742   56BE ED A0       > ldi
1742   56C0 ED A0       > ldi
1742   56C2 ED A0       > ldi
1742   56C4 ED A0       > ldi
1742   56C6 ED A0       > ldi
1742   56C8 ED A0       > ldi
1742   56CA ED A0       > ldi
1742   56CC ED A0       > ldi
1742   56CE ED A0       > ldi
1742   56D0 ED A0       > ldi
1742   56D2 ED A0       > ldi
1742   56D4 ED A0       > ldi
1742   56D6 ED A0       > ldi
1742   56D8 ED A0       > ldi
1742   56DA ED A0       > ldi
1742   56DC ED A0       > ldi
1742   56DE ED A0       > ldi
1742   56E0 ED A0       > ldi
1742   56E2 ED A0       > ldi
1742   56E4 ED A0       > ldi
1742   56E6 ED A0       > ldi
1742   56E8 ED A0       > ldi
1742   56EA ED A0       > ldi
1742   56EC ED A0       > ldi
1742   56EE ED A0       > ldi
1742   56F0 ED A0       > ldi
1742   56F2 ED A0       > ldi
1742   56F4 ED A0       > ldi
1742   56F6 ED A0       > ldi
1742   56F8 ED A0       > ldi
1742   56FA ED A0       > ldi
1742   56FC ED A0       > ldi
1742   56FE ED A0       > ldi
1742   5700 ED A0       > ldi
1742   5702 ED A0       > ldi
1742   5704 ED A0       > ldi
1742   5706 ED A0       > ldi
1742   5708 ED A0       > ldi
1742   570A ED A0       > ldi
1742   570C ED A0       > ldi
1742   570E ED A0       > ldi
1742   5710 ED A0       > ldi
1742   5712 ED A0       > ldi
1742   5714 ED A0       > ldi
1742   5716 ED A0       > ldi
1742   5718 ED A0       > ldi
1742   571A ED A0       > ldi
1742   571C ED A0       > ldi
1742   571E ED A0       > ldi
1742   5720 ED A0       > ldi
1742   5722 ED A0       > ldi
1742   5724 ED A0       > ldi
1742   5726 ED A0       > ldi
1742   5728 ED A0       > ldi
1742   572A ED A0       > ldi
1742   572C ED A0       > ldi
1742   572E ED A0       > ldi
1742   5730 ED A0       > ldi
1742   5732 ED A0       > ldi
1742   5734 ED A0       > ldi
1742   5736 ED A0       > ldi
1742   5738 ED A0       > ldi
1742   573A ED A0       > ldi
1742   573C ED A0       > ldi
1742   573E ED A0       > ldi
1742   5740 ED A0       > ldi
1742   5742 ED A0       > ldi
1742   5744 ED A0       > ldi
1742   5746 ED A0       > ldi
1742   5748 ED A0       > ldi
1742   574A ED A0       > ldi
1742   574C ED A0       > ldi
1742   574E ED A0       > ldi
1742   5750 ED A0       > ldi
1742   5752 ED A0       > ldi
1742   5754 ED A0       > ldi
1742   5756 ED A0       > ldi
1742   5758 ED A0       > ldi
1742   575A ED A0       > ldi
1742   575C ED A0       > ldi
1742   575E ED A0       > ldi
1742   5760 ED A0       > ldi
1742   5762 ED A0       > ldi
1742   5764 ED A0       > ldi
1742   5766 ED A0       > ldi
1742   5768 ED A0       > ldi
1742   576A ED A0       > ldi
1742   576C ED A0       > ldi
1742   576E ED A0       > ldi
1742   5770 ED A0       > ldi
1742   5772 ED A0       > ldi
1742   5774 ED A0       > ldi
1742   5776 ED A0       > ldi
1742   5778 ED A0       > ldi
1742   577A ED A0       > ldi
1742   577C ED A0       > ldi
1742   577E ED A0       > ldi
1743   5780             .part2s: 
1744   5780 EB          	ex	de,hl
1745   5781 3A 00 7B    	ld	a, (SPIDATA)	; descarta CRC
1746   5784             .fim: 
1747   5784 AF          	xor	a		; zera carry para informar leitura sem erros
1748   5785 C3 11 4F    	jp	terminaLeituraEscritaBloco
1749   5788             
1750   5788             
1751   5788             ; ------------------------------------------------
1752   5788             ; Converte blocos para bytes. Na pratica faz
1753   5788             ; BC DE = (BC DE) * 512
1754   5788             ; ------------------------------------------------
1755   5788             blocoParaByte: 
1756   5788 41          	ld	b, c
1757   5789 4A          	ld	c, d
1758   578A 53          	ld	d, e
1759   578B 1E 00       	ld	e, 0
1760   578D CB 22       	sla	d
1761   578F CB 11       	rl	c
1762   5791 CB 10       	rl	b
1763   5793 C9          	ret
1764   5794             
1765   5794             ; ------------------------------------------------
1766   5794             ; Funcoes utilitarias
1767   5794             ; ------------------------------------------------
1768   5794             
1769   5794             
1770   5794             ; ------------------------------------------------
1771   5794             ; Imprime string na tela apontada por DE
1772   5794             ; Destroi todos os registradores
1773   5794             ; ------------------------------------------------
1774   5794             printString: 
1775   5794 1A          	ld	a, (de)
1776   5795 B7          	or	a
1777   5796 C8          	ret	z
1778   5797 CD A2 00    	call	CHPUT
1779   579A 13          	inc	de
1780   579B 18 F7       	jr	printString
1781   579D             
1782   579D             
1783   579D             ; ------------------------------------------------
1784   579D             ; Converte o byte em A para string em decimal no
1785   579D             ; buffer apontado por DE
1786   579D             ; Destroi AF, BC, HL, DE
1787   579D             ; ------------------------------------------------
1788   579D             DecToAscii: 
1789   579D 26 00       	ld	h, 0
1790   579F 6F          	ld	l, a		; copiar A para HL
1791   57A0 FD 36 39 01 	ld	(iy+WRKAREA.TEMP),1	; flag para indicar que devemos cortar os zeros a esquerda
1792   57A4 01 9C FF    	ld	bc, -100	; centenas
1793   57A7 CD B5 57    	call	.num1
1794   57AA 0E F6       	ld	c, -10		; dezenas
1795   57AC CD B5 57    	call	.num1
1796   57AF FD 36 39 02 	ld	(iy+WRKAREA.TEMP),2	; unidade deve exibir 0 se for zero e nao corta-lo
1797   57B3 0E FF       	ld	c, -1		; unidades
1798   57B5             .num1: 
1799   57B5 3E 2F       	ld	a, '0'-1
1800   57B7             .num2: 
1801   57B7 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1802   57B8 09          	add	hl, bc		; somar com negativo
1803   57B9 38 FC       	jr	c,.num2		; ainda nao zeramos
1804   57BB ED 42       	sbc	hl, bc		; retoma valor original
1805   57BD FD 35 39    	dec	(iy+WRKAREA.TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1806   57C0 20 08       	jr	nz,.naozero
1807   57C2 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1808   57C4 20 04       	jr	nz,.naozero
1809   57C6 FD 34 39    	inc	(iy+WRKAREA.TEMP)	; se for zero, nao salvamos e voltamos a flag
1810   57C9 C9          	ret
1811   57CA             .naozero: 
1812   57CA 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1813   57CB 13          	inc	de		; incrementa ponteiro de destino
1814   57CC C9          	ret
1815   57CD             
1816   57CD             ; ------------------------------------------------
1817   57CD             ; Converte o byte em A para string em hexa no
1818   57CD             ; buffer apontado por DE
1819   57CD             ; Destroi AF, C, DE
1820   57CD             ; ------------------------------------------------
1821   57CD             HexToAscii: 
1822   57CD 4F          	ld	c, a
1823   57CE 1F          	rra
1824   57CF 1F          	rra
1825   57D0 1F          	rra
1826   57D1 1F          	rra
1827   57D2 CD D6 57    	call	.conv
1828   57D5 79          	ld  	a, c
1829   57D6             .conv: 
1830   57D6 E6 0F       	and	$0F
1831   57D8 C6 90       	add	a, $90
1832   57DA 27          	daa
1833   57DB CE 40       	adc	a, $40
1834   57DD 27          	daa
1835   57DE 12          	ld	(de), a
1836   57DF 13          	inc	de
1837   57E0 C9          	ret
1838   57E1             
1839   57E1             ; ------------------------------------------------
1840   57E1             ; Converte o byte em A para string em decimal e
1841   57E1             ; imprime na tela
1842   57E1             ; Destroi AF, BC, HL, DE
1843   57E1             ; ------------------------------------------------
1844   57E1             printDecToAscii: 
1845   57E1 26 00       	ld	h, 0
1846   57E3 6F          	ld	l, a		; copiar A para HL
1847   57E4 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1848   57E6 11 9C FF    	ld	de, -100	; centenas
1849   57E9 CD F5 57    	call	.num1
1850   57EC 1E F6       	ld	e, -10		; dezenas
1851   57EE CD F5 57    	call	.num1
1852   57F1 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1853   57F3 1E FF       	ld	e, -1		; unidades
1854   57F5             .num1: 
1855   57F5 3E 2F       	ld	a, '0'-1
1856   57F7             .num2: 
1857   57F7 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1858   57F8 19          	add	hl, de		; somar com negativo
1859   57F9 38 FC       	jr	c,.num2		; ainda nao zeramos
1860   57FB ED 52       	sbc	hl, de		; retoma valor original
1861   57FD 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1862   57FF FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1863   5801 20 02       	jr	nz,.naozero
1864   5803 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1865   5804 C9          	ret
1866   5805             .naozero: 
1867   5805 E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1868   5806 C5          	push	bc
1869   5807 CD A2 00    	call	CHPUT
1870   580A C1          	pop	bc
1871   580B E1          	pop	hl
1872   580C C9          	ret
1873   580D             
1874   580D             ; ------------------------------------------------
1875   580D             ; Procura pelo nome do fabricante em uma tabela.
1876   580D             ; A contem o byte do fabricante
1877   580D             ; Devolve HL apontando para o buffer do fabricante
1878   580D             ; e BC com o comprimento do texto
1879   580D             ; Destroi AF, BC, HL
1880   580D             ; ------------------------------------------------
1881   580D             pegaFabricante: 
1882   580D 4F          	ld	c, a
1883   580E 21 2F 58    	ld	hl, tblFabricantes
1884   5811             
1885   5811             .loop: 
1886   5811 7E          	ld	a, (hl)
1887   5812 23          	inc	hl
1888   5813 B9          	cp	c
1889   5814 28 0C       	jr	z,.achado
1890   5816 B7          	or	a
1891   5817 28 09       	jr	z,.achado
1892   5819 C5          	push	bc
1893   581A CD 22 58    	call	.achado
1894   581D 09          	add	hl, bc
1895   581E 23          	inc	hl
1896   581F C1          	pop	bc
1897   5820 18 EF       	jr	.loop
1898   5822             
1899   5822             .achado: 
1900   5822 0E 00       	ld	c, 0
1901   5824 E5          	push	hl
1902   5825 AF          	xor	a
1903   5826             .loop2: 
1904   5826 0C          	inc	c
1905   5827 23          	inc	hl
1906   5828 BE          	cp	(hl)
1907   5829 20 FB       	jr	nz,.loop2
1908   582B E1          	pop	hl
1909   582C 06 00       	ld	b, 0
1910   582E C9          	ret
1911   582F             
1912   582F             tblFabricantes: 
1913   582F 01          	db	1
1914   5830             	db	"Panasonic",0
1914   5830 50616E61736F6E696300
1915   583A 02          	db	2
1916   583B             	db	"Toshiba",0
1916   583B 546F736869626100
1917   5843 03          	db	3
1918   5844             	db	"SanDisk",0
1918   5844 53616E4469736B00
1919   584C 04          	db	4
1920   584D             	db	"SMI-S",0
1920   584D 534D492D5300
1921   5853 06          	db	6
1922   5854             	db	"Renesas",0
1922   5854 52656E6573617300
1923   585C 11          	db	17
1924   585D             	db	"Dane-Elec",0
1924   585D 44616E652D456C656300
1925   5867 13          	db	19
1926   5868             	db	"KingMax",0
1926   5868 4B696E674D617800
1927   5870 15          	db	21
1928   5871             	db	"Samsung",0
1928   5871 53616D73756E6700
1929   5879 18          	db	24
1930   587A             	db	"Infineon",0
1930   587A 496E66696E656F6E00
1931   5883 1A          	db	26
1932   5884 50 51 49 00 	db	"PQI",0
1933   5888 1B          	db	27
1934   5889 536F6E7900  	db	"Sony",0
1935   588E 1C          	db	28
1936   588F             	db	"Transcend",0
1936   588F 5472616E7363656E6400
1937   5899 1D          	db	29
1938   589A             	db	"A-DATA",0
1938   589A 412D4441544100
1939   58A1 1F          	db	31
1940   58A2             	db	"SiliconPower",0
1940   58A2 53696C69636F6E506F77657200
1941   58AF 27          	db	39
1942   58B0             	db	"Verbatim",0
1942   58B0 566572626174696D00
1943   58B9 41          	db	65
1944   58BA 4F 4B 49 00 	db	"OKI",0
1945   58BE 73          	db	115
1946   58BF             	db	"SilverHT",0
1946   58BF 53696C766572485400
1947   58C8 89          	db	137
1948   58C9             	db	"L.Data",0
1948   58C9 4C2E4461746100
1949   58D0 00          	db	0
1950   58D1             	db	"Generico",0
1950   58D1 47656E657269636F00
1951   58DA             
1952   58DA             
1953   58DA             ; ------------------------------------------------
1954   58DA             ; Restore screen parameters on MSX>=2 if they're
1955   58DA             ; not set yet
1956   58DA             ; ------------------------------------------------
1957   58DA             MYSETSCR: 
1958   58DA 3A 2D 00    	ld	a,(MSXVER)
1959   58DD B7          	or	a			; MSX1?
1960   58DE 20 08       	jr	nz,.notMSX1		; No, skip
1961   58E0             .MSX1: 
1962   58E0 3A AF FC    	ld	a,(SCRMOD)
1963   58E3 B7          	or	a			; SCREEN0 already?
1964   58E4 C8          	ret	z			; Yes, quit
1965   58E5 C3 6C 00    	jp	INITXT			; set screen0
1966   58E8             
1967   58E8             .notMSX1: 
1968   58E8 0E 23       	ld	c,$23			; Block-2, R#3
1969   58EA DD 21 F5 01 	ld 	ix,REDCLK
1970   58EE CD 5F 01    	call	EXTROM
1971   58F1 E6 01       	and	1
1972   58F3 47          	ld	b,a
1973   58F4 3A AF FC    	ld	a,(SCRMOD)
1974   58F7 B8          	cp	b
1975   58F8 20 1C       	jr	nz,.restore
1976   58FA 0C          	inc	c
1977   58FB DD 21 F5 01 	ld 	ix,REDCLK
1978   58FF CD 5F 01    	call	EXTROM
1979   5902 47          	ld	b,a
1980   5903 0C          	inc	c
1981   5904 DD 21 F5 01 	ld 	ix,REDCLK
1982   5908 CD 5F 01    	call	EXTROM
1983   590B 87          	add	a,a
1984   590C 87          	add	a,a
1985   590D 87          	add	a,a
1986   590E 87          	add	a,a
1987   590F B0          	or	b
1988   5910 47          	ld	b,a
1989   5911 3A B0 F3    	ld	a,(LINLEN)
1990   5914 B8          	cp	b
1991   5915 C8          	ret	z
1992   5916             .restore: 
1993   5916 AF          	xor	a		; Don't displat the function keys
1994   5917 DD 21 85 01 	ld	ix,SDFSCR
1995   591B C3 5F 01    	jp	EXTROM
1996   591E             
1997   591E             ; ------------------------------------------------
1998   591E             ; Check if the STOP key was signaled on DRV_INIT
1999   591E             ; ------------------------------------------------
2000   591E             INICHKSTOP: 
2001   591E 3A 9B FC    	ld	a,(INTFLG)
2002   5921 FE 04       	cp	4			; Was STOP pressed?
2003   5923 C0          	ret	nz			; No, quit as fast as possible 
2004   5924             
2005   5924             	; Handle STOP to pause and read messages, and ask for the copyright info
2006   5924 11 AE 59    	ld	de,strBootpaused
2007   5927 CD 94 57    	call	printString
2008   592A 3E 07       .wait1: 	ld	a,7
2009   592C CD 41 01    	call	SNSMAT
2010   592F E6 10       	and	$10			; Is STOP still pressed?
2011   5931 28 F7       	jr	z,.wait1		; Wait for STOP to be released
2012   5933 AF          	xor	a
2013   5934 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
2014   5937 06 00       	ld	b,0			; b=inhibit 'i' key flag
2015   5939 CD 9C 00    .wait2:  call	CHSNS
2016   593C C4 59 59    	call	nz,.chkikey		; Wait until a key is pressed
2017   593F 3A 9B FC    	ld	a,(INTFLG)
2018   5942 FE 04       	cp	4			; Was STOP pressed?
2019   5944 20 F3       	jr	nz,.wait2		; No, return
2020   5946 AF          	xor	a
2021   5947 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
2022   594A CD 56 01    	call	KILBUF
2023   594D 06 1E       	ld	b,30			; Since the user is trying pause the
2024   594F 76          .wait3: 	halt				; boot messages, this gives him enough
2025   5950             					; time to react and pause the next
2026   5950             					; driver
2027   5950 3A 9B FC    	ld	a,(INTFLG)
2028   5953 FE 04       	cp	4			; Was STOP pressed?
2029   5955 C8          	ret	z			; quit so the next driver can process it
2030   5956 10 F7       	djnz	.wait3			; The user will have the impression
2031   5958             					; that he has a perfect timing.   ;)
2032   5958 C9          	ret
2033   5959             
2034   5959             .chkikey: 
2035   5959 CB 40       	bit	0,b			; Was the copyright message shown?
2036   595B C0          	ret	nz			; Yes, return
2037   595C CD 9F 00    	call	CHGET
2038   595F FE 69       	cp	'i'
2039   5961 28 03       	jr	z,.showcopyright
2040   5963 FE 49       	cp	'I'
2041   5965 C0          	ret	nz
2042   5966             .showcopyright: 
2043   5966 04          	inc	b			; Inhibit further presses of the i key 
2044   5967 11 DE 59    	ld	de,strCopyright
2045   596A C3 94 57    	jp	printString
2046   596D             
2047   596D             
2048   596D             
2049   596D             ; ------------------------------------------------
2050   596D             ; Install the R800 data transfer helper routine on WorkArea 
2051   596D             ; ------------------------------------------------
2052   596D             INSTR800HLP: 
2053   596D 3A 2D 00    	ld	a,(MSXVER)
2054   5970 FE 03       	cp	3		; MSX Turbo-R?
2055   5972 D8          	ret	c		; No, return
2056   5973 CD 80 59    	call	GTR800LDIR
2057   5976 EB          	ex	de,hl
2058   5977 21 88 59    	ld	hl,R800DATHLP
2059   597A 01 07 00    	ld	bc,R800DATHLP.end-R800DATHLP
2060   597D ED B0       	ldir
2061   597F C9          	ret
2062   5980             
2063   5980             ; ------------------------------------------------
2064   5980             ; Obtain the pointer to the R800 data transfer helper routine
2065   5980             ; Input   : IY=Pointer to the WorkArea
2066   5980             ; Output  : HL=pointer to R800 data transfer helper routine 
2067   5980             ; Modifies: DE
2068   5980             ; ------------------------------------------------
2069   5980             GTR800LDIR: 
2070   5980 FD E5       	push	iy
2071   5982 E1          	pop	hl			; hl=WorkArea
2072   5983 11 3A 00    	ld	de,WRKAREA.TRLDIR
2073   5986 19          	add	hl,de
2074   5987 C9          	ret
2075   5988             
2076   5988             ; ------------------------------------------------
2077   5988             ; R800 data transfer routine, copied to the WorkArea
2078   5988             ; ------------------------------------------------
2079   5988             R800DATHLP: 
2080   5988 D9          	exx
2081   5989 01 00 02    	ld	bc,512
2082   598C ED B0       	ldir
2083   598E C9          	ret
2084   598F             .end
2085   598F              
2086   598F             
2087   598F             
2088   598F             ; ==========================================================================
2089   598F             strTitle: 
2090   598F             	db	13,"FBLabs SDHC driver ",27,'J'
2090   598F 0D46424C616273205344484320647269766572201B4A
2091   59A5             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
2091   59A5 76312E302E38
2092   59AB 0D 0A 00    	db	13,10,0
2093   59AE             
2094   59AE             strBootpaused: 
2095   59AE             	db	"Paused. Press <i> to show the copyright info.",13,10,0
2095   59AE 5061757365642E205072657373203C693E20746F2073686F772074686520636F
2095   59CE 7079726967687420696E666F2E0D0A00
2096   59DE             
2097   59DE             strCopyright: 
2098   59DE             	db	"(c) 2014 Fabio Belavenuto",13,10
2098   59DE 286329203230313420466162696F2042656C6176656E75746F0D0A
2099   59F9             	db	"(c) 2017 FRS",13,10
2099   59F9 2863292032303137204652530D0A
2100   5A07             	db	"Licenced under CERN OHL v1.1",13,10
2100   5A07 4C6963656E63656420756E646572204345524E204F484C2076312E310D0A
2101   5A25             	db	"http://ohwr.org/cernohl",13,10
2101   5A25 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
2102   5A3E             	db	"PCB designed by Luciano Sturaro",13,10
2102   5A3E 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
2102   5A5E 0A
2103   5A5F             	; fall throw
2104   5A5F             strCrLf: 
2105   5A5F 0D 0A 00    	db	13,10,0
2106   5A62             strCartao: 
2107   5A62             	db	"Slot ",0
2107   5A62 536C6F742000
2108   5A68             strVazio: 
2109   5A68             	db	"Empty",13,10,0
2109   5A68 456D7074790D0A00
2110   5A70             strNaoIdentificado: 
2111   5A70             	db	"Unknown!",13,10,0
2111   5A70 556E6B6E6F776E210D0A00
2112   5A7B             			;----------------------------------------
2113   5A7B             strMr_mp_desativada: 
2114   5A7B             	db	"Slot expander/Mapper/MegaRAM disabled",13,10,0
2114   5A7B 536C6F7420657870616E6465722F4D61707065722F4D65676152414D20646973
2114   5A9B 61626C65640D0A00
2115   5AA3             strDrvMain: 
2116   5AA3             	db	"Driver main selected",13,10,0
2116   5AA3 447269766572206D61696E2073656C65637465640D0A00
2117   5ABA             strDrvDev: 
2118   5ABA             	db	"Driver development selected",13,10,0
2118   5ABA 44726976657220646576656C6F706D656E742073656C65637465640D0A00
2119   5AD8             strSDV1: 
2120   5AD8             	db	"SDV1 - ",0
2120   5AD8 53445631202D2000
2121   5AE0             strSDV2: 
2122   5AE0             	db	"SDV2 - ",0
2122   5AE0 53445632202D2000
2123   5AE8             
2124   5AE8             ;-----------------------------------------------------------------------------
2125   5AE8             ;
2126   5AE8             ; End of the driver code
2127   5AE8             
2128   5AE8             DRV_END: 
2129   5AE8             
2130   5AE8             ;	ds	3ED0h-(DRV_END-DRV_START), $FF
2131   5AE8 FF          	ds	$7B00-$, #FF
2132   7B00             
2133   7B00             
