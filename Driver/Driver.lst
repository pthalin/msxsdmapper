0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 7B00h~7EFFh	: SPI data transfer window (read/write)
0015   0000             ; 7F00h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	b0	: 0=SD card present on slot-0
0018   0000             ;	b1	: 0=SD card present on slot-1
0019   0000             ;	b2	: 1=Write protecton enabled for SD card slot-0
0020   0000             ;	b3	: 1=Write protecton enabled for SD card slot-1
0021   0000             ;	b4	: SW0 status. 0=RAM enabled, 1=RAM disabled
0022   0000             ;	b5	: SW1 status. 0=RAM mode: MegaRAM, 1=RAM mode: Memory Mapper
0023   0000             ;	b6	: Reserved for future use. Must be masked out from readings.
0024   0000             ;	b7	: 1=SPI transfer busy. 0=No ongoing SPI transfer
0025   0000             ;	<write>
0026   0000             ;	b0	: SD card slot-0 chip-select (0=selected)
0027   0000             ;	b1	: SD card slot-1 chip-select (0=selected)
0028   0000             
0029   0000             ; 7F01h		: Mode configuration register (write only)
0030   0000             ;	b0	: 0=ROM mode, SPI interface disabled, 1=SPI interface enabled
0031   0000             
0032   0000             
0033   0000             
0034   0000             	output	"driver.bin"
0035   0000             
0036   0000             ;-----------------------------------------------------------------------------
0037   0000             ;
0038   0000             ; Driver configuration constants
0039   0000             ;
0040   0000             
0041   0000             ;Driver type:
0042   0000             ;   0 for drive-based
0043   0000             ;   1 for device-based
0044   0000             
0045   0000             DRV_TYPE	equ	1
0046   0000             
0047   0000             ;Hot-plug devices support (device-based drivers only):
0048   0000             ;   0 for no hot-plug support
0049   0000             ;   1 for hot-plug support
0050   0000             
0051   0000             DRV_HOTPLUG	equ	0
0052   0000             
0053   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0054   0000             
0055   0000             ;Driver version
0056   0000             
0057   0000             VER_MAIN	equ	1
0058   0000             VER_SEC		equ	0
0059   0000             VER_REV		equ	6
0060   0000             
0061   0000             ;-----------------------------------------------------------------------------
0062   0000             ; Enderecos SPI
0063   0000             
0064   0000             SPIDATA		= $7B00
0065   0000             SPICTRL		= $7F00
0066   0000             SPISTATUS	= $7F00
0067   0000             
0068   0000             ; Comandos SPI:
0069   0000             CMD0	= 0  | $40
0070   0000             CMD1	= 1  | $40
0071   0000             CMD8	= 8  | $40
0072   0000             CMD9	= 9  | $40
0073   0000             CMD10	= 10 | $40
0074   0000             CMD12	= 12 | $40
0075   0000             CMD16	= 16 | $40
0076   0000             CMD17	= 17 | $40
0077   0000             CMD18	= 18 | $40
0078   0000             CMD24	= 24 | $40
0079   0000             CMD25	= 25 | $40
0080   0000             CMD55	= 55 | $40
0081   0000             CMD58	= 58 | $40
0082   0000             ACMD23	= 23 | $40
0083   0000             ACMD41	= 41 | $40
0084   0000             
0085   0000             ; Offsets da area de trabalho
0086   0000             
0087   0000             BCSD 		= 0
0088   0000             BCID1		= 16
0089   0000             BCID2		= 32
0090   0000             NUMSD		= 48	; 1 se cartao 1, 2 se cartao 2
0091   0000             FLAGSCARTAO	= 49	; Flag indicando se houve mudanca ou erro de cartao
0092   0000             NUMBLOCOS	= 50	; 1 byte
0093   0000             TEMP		= 52	; 1 byte
0094   0000             BLOCOS1		= 56	; 3 bytes
0095   0000             BLOCOS2		= 60	; 3 bytes
0096   0000             
0097   0000             
0098   0000             
0099   0000             ;-----------------------------------------------------------------------------
0100   0000             ;
0101   0000             ; Standard BIOS and work area entries
0102   0000             INITXT	= $006C		; Inicializa SCREEN0
0103   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0104   0000             CHGET	= $009F		; Get character from keyboard buffer
0105   0000             CHPUT	= $00A2		; A=char
0106   0000             CLS	= $00C3		; Chamar com A=0
0107   0000             ERAFNK	= $00CC		; Erase function key display
0108   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0109   0000             KILBUF	= $0156		; Clear keyboard buffer
0110   0000             EXTROM	= $015F
0111   0000             
0112   0000             ; subROM functions
0113   0000             SDFSCR	= $0185
0114   0000             REDCLK	= $01F5
0115   0000             
0116   0000             
0117   0000             ; System variables
0118   0000             MSXVER	= $002D
0119   0000             LINL40	= $F3AE		; Width
0120   0000             LINLEN	= $F3B0
0121   0000             INTFLG	= $FC9B
0122   0000             SCRMOD	= $FCAF
0123   0000             
0124   0000             
0125   0000             ;-----------------------------------------------------------------------------
0126   0000             
0127   0000             
0128   0000             	org		$4000
0129   4000             
0130   4000 FF          	ds		256, $FF		; 256 dummy bytes
0131   4100             
0132   4100             DRV_START: 
0133   4100             
0134   4100             ;-----------------------------------------------------------------------------
0135   4100             ;
0136   4100             ; Miscellaneous constants
0137   4100             ;
0138   4100             
0139   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0140   4100             ;It is used by some of the kernel page 0 routines.
0141   4100             
0142   4100             CODE_ADD: 	equ	0F84Ch
0143   4100             
0144   4100             
0145   4100             ;-----------------------------------------------------------------------------
0146   4100             ;
0147   4100             ; Error codes for DEV_RW
0148   4100             ;
0149   4100             
0150   4100             ENCOMP	equ	0FFh
0151   4100             EWRERR	equ	0FEh
0152   4100             EDISK	equ	0FDh
0153   4100             ENRDY	equ	0FCh
0154   4100             EDATA	equ	0FAh
0155   4100             ERNF	equ	0F9h
0156   4100             EWPROT	equ	0F8h
0157   4100             EUFORM	equ	0F7h
0158   4100             ESEEK	equ	0F3h
0159   4100             EIFORM	equ	0F0h
0160   4100             EIDEVL	equ	0B5h
0161   4100             EIPARM	equ	08Bh
0162   4100             
0163   4100             ;-----------------------------------------------------------------------------
0164   4100             ;
0165   4100             ; Routines and information available on kernel page 0
0166   4100             ;
0167   4100             
0168   4100             ;* Get in A the current slot for page 1. Corrupts F.
0169   4100             ;  Must be called by using CALBNK to bank 0:
0170   4100             ;    xor a
0171   4100             ;    ld ix,GSLOT1
0172   4100             ;    call CALBNK
0173   4100             
0174   4100             GSLOT1	equ	402Dh
0175   4100             
0176   4100             
0177   4100             ;* This routine reads a byte from another bank.
0178   4100             ;  Must be called by using CALBNK to the desired bank,
0179   4100             ;  passing the address to be read in HL:
0180   4100             ;    ld a,<bank number>
0181   4100             ;    ld hl,<byte address>
0182   4100             ;    ld ix,RDBANK
0183   4100             ;    call CALBNK
0184   4100             
0185   4100             RDBANK	equ	403Ch
0186   4100             
0187   4100             
0188   4100             ;* This routine temporarily switches kernel main bank
0189   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0190   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0191   4100             ;  It is necessary to use this routine to invoke CALBAS
0192   4100             ;  (so that kernel bank is correct in case of BASIC error)
0193   4100             ;  and to invoke DOS functions via F37Dh hook.
0194   4100             ;
0195   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0196   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0197   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0198   4100             
0199   4100             CALLB0	equ	403Fh
0200   4100             
0201   4100             
0202   4100             ;* Call a routine in another bank.
0203   4100             ;  Must be used if the driver spawns across more than one bank.
0204   4100             ;
0205   4100             ;  Input:  A = bank number
0206   4100             ;          IX = routine address
0207   4100             ;          AF' = AF for the routine
0208   4100             ;          HL' = Ix for the routine
0209   4100             ;          BC, DE, HL, IY = input for the routine
0210   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0211   4100             
0212   4100             CALBNK	equ	4042h
0213   4100             
0214   4100             
0215   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0216   4100             ;  which will in turn contain a pointer to the allocated page 3
0217   4100             ;  work area for that slot (0 if no work area was allocated).
0218   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0219   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0220   4100             ;  Corrupts F.
0221   4100             ;  Must be called by using CALBNK to bank 0:
0222   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0223   4100             ;    ex af,af'
0224   4100             ;    xor a
0225   4100             ;    ld ix,GWORK
0226   4100             ;    call CALBNK
0227   4100             
0228   4100             GWORK	equ	4045h
0229   4100             
0230   4100             
0231   4100             ;* This address contains one byte that tells how many banks
0232   4100             ;  form the Nextor kernel (or alternatively, the first bank
0233   4100             ;  number of the driver).
0234   4100             
0235   4100             K_SIZE	equ	40FEh
0236   4100             
0237   4100             
0238   4100             ;* This address contains one byte with the current bank number.
0239   4100             
0240   4100             CUR_BANK	equ	40FFh
0241   4100             
0242   4100             
0243   4100             ;-----------------------------------------------------------------------------
0244   4100             ;
0245   4100             ; Built-in format choice strings
0246   4100             ;
0247   4100             
0248   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0249   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0250   4100             
0251   4100             
0252   4100             ;-----------------------------------------------------------------------------
0253   4100             ;
0254   4100             ; Driver signature
0255   4100             ;
0256   4100             	db	"NEXTOR_DRIVER",0
0256   4100 4E4558544F525F44524956455200
0257   410E             
0258   410E             
0259   410E             ;-----------------------------------------------------------------------------
0260   410E             ;
0261   410E             ; Driver flags:
0262   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0263   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0264   410E             
0265   410E 01          	db 1+(2*DRV_HOTPLUG)
0266   410F             
0267   410F             ;-----------------------------------------------------------------------------
0268   410F             ;
0269   410F             ; Reserved byte
0270   410F             ;
0271   410F 00          	db	0
0272   4110             
0273   4110             ;-----------------------------------------------------------------------------
0274   4110             ;
0275   4110             ; Driver name
0276   4110             ;
0277   4110             
0278   4110             DRV_NAME: 
0279   4110             	db	"SDMapper Driver"
0279   4110 53444D617070657220447269766572
0280   411F 20          	ds	32-($-DRV_NAME)," "
0281   4130             
0282   4130             
0283   4130             ;-----------------------------------------------------------------------------
0284   4130             ;
0285   4130             ; Jump table for the driver public routines
0286   4130             ;
0287   4130             
0288   4130             	; These routines are mandatory for all drivers
0289   4130                     ; (but probably you need to implement only DRV_INIT)
0290   4130             
0291   4130 C3 6C 41    	jp	DRV_TIMI
0292   4133 C3 85 42    	jp	DRV_VERSION
0293   4136 C3 6D 41    	jp	DRV_INIT
0294   4139 C3 8C 42    	jp	DRV_BASSTAT
0295   413C C3 8E 42    	jp	DRV_BASDEV
0296   413F C3 90 42    	jp	DRV_EXTBIO
0297   4142 C3 91 42    	jp	DRV_DIRECT0
0298   4145 C3 91 42    	jp	DRV_DIRECT1
0299   4148 C3 91 42    	jp	DRV_DIRECT2
0300   414B C3 91 42    	jp	DRV_DIRECT3
0301   414E C3 91 42    	jp	DRV_DIRECT4
0302   4151             
0303   4151 00          	ds	15
0304   4160             
0305   4160             	; These routines are mandatory for device-based drivers
0306   4160             
0307   4160 C3 92 42    	jp	DEV_RW
0308   4163 C3 03 43    	jp	DEV_INFO
0309   4166 C3 89 43    	jp	DEV_STATUS
0310   4169 C3 CA 43    	jp	LUN_INFO
0311   416C             
0312   416C             
0313   416C             ;=====
0314   416C             ;=====  END of data that must be at fixed addresses
0315   416C             ;=====
0316   416C             
0317   416C             
0318   416C             ;-----------------------------------------------------------------------------
0319   416C             ;
0320   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0321   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0322   416C             
0323   416C             DRV_TIMI: 
0324   416C C9          	ret
0325   416D             
0326   416D             ;-----------------------------------------------------------------------------
0327   416D             ;
0328   416D             ; Driver initialization routine, it is called twice:
0329   416D             ;
0330   416D             ; 1) First execution, for information gathering.
0331   416D             ;    Input:
0332   416D             ;      A = 0
0333   416D             ;      B = number of available drives
0334   416D             ;      HL = maximum size of allocatable work area in page 3
0335   416D             ;    Output:
0336   416D             ;      A = number of required drives (for drive-based driver only)
0337   416D             ;      HL = size of required work area in page 3
0338   416D             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0339   416D             ;
0340   416D             ; 2) Second execution, for work area and hardware initialization.
0341   416D             ;    Input:
0342   416D             ;      A = 1
0343   416D             ;      B = number of allocated drives for this controller
0344   416D             ;
0345   416D             ;    The work area address can be obtained by using GWORK.
0346   416D             ;
0347   416D             ;    If first execution requests more work area than available,
0348   416D             ;    second execution will not be done and DRV_TIMI will not be hooked
0349   416D             ;    to the timer interrupt.
0350   416D             ;
0351   416D             ;    If first execution requests more drives than available,
0352   416D             ;    as many drives as possible will be allocated, and the initialization
0353   416D             ;    procedure will continue the normal way
0354   416D             ;    (for drive-based drivers only. Device-based drivers always
0355   416D             ;     get two allocated drives.)
0356   416D             
0357   416D             DRV_INIT: 
0358   416D B7          	or	a		; Is this the 1st call? 
0359   416E 21 40 00    	ld	hl, 64		; 64 bytes of work area is needed 
0360   4171 C8          	ret	z		; Yes, return
0361   4172             
0362   4172             ; 2nd call: 
0363   4172 CD 12 59    	call	MYSETSCR		; Set the screen mode
0364   4175 CD 09 44    	call	pegaWorkArea		; HL=IY=Work area pointer
0365   4178             
0366   4178 11 4F 59    	ld	de,strTitle		; prints the title 
0367   417B CD CC 57    	call	printString
0368   417E CD D8 45    	call	disableSDs
0369   4181 CD 6A 42    	call	SDMAPPERINIT		; SD-Mapper exclusive init
0370   4184             
0371   4184             SDHCDEVINIT: 	; FBLabs SDHC Interface initialization
0372   4184 AF          	xor	a			; zera flags do cartao
0373   4185 FD 77 31    	ld	(iy+FLAGSCARTAO), a
0374   4188 3E 01       	ld	a, 1			; detectar cartao 1
0375   418A CD ED 41    	call	.detecta
0376   418D 3E 02       	ld	a, 2			; detectar cartao 2
0377   418F CD ED 41    	call	.detecta
0378   4192 01 00 00    	ld	bc, 0
0379   4195 1E 05       	ld	e, 5
0380   4197             
0381   4197             .chkStop:  ; Check if the STOP key was signaled
0382   4197 3A 9B FC    	ld	a,(INTFLG)
0383   419A FE 04       	cp	4			; Was STOP pressed?
0384   419C 20 35       	jr	nz,.end			; No, quit as fast as possible 
0385   419E             
0386   419E             	; Handle STOP to pause and read messages, and ask for the copyright info
0387   419E 11 6B 59    	ld	de,strBootpaused
0388   41A1 CD CC 57    	call	printString
0389   41A4 3E 07       .wait1: 	ld	a,7
0390   41A6 CD 41 01    	call	SNSMAT
0391   41A9 E6 10       	and	$10			; Is STOP still pressed?
0392   41AB 28 F7       	jr	z,.wait1		; Wait for STOP to be released
0393   41AD AF          	xor	a
0394   41AE 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0395   41B1 06 00       	ld	b,0			; b=inhibit 'i' key flag
0396   41B3 CD 9C 00    .wait2:  call	CHSNS
0397   41B6 C4 D9 41    	call	nz,.chkikey		; Wait until a key is pressed
0398   41B9 3A 9B FC    	ld	a,(INTFLG)
0399   41BC FE 04       	cp	4			; Was STOP pressed?
0400   41BE 20 F3       	jr	nz,.wait2		; No, return
0401   41C0 AF          	xor	a
0402   41C1 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0403   41C4 CD 56 01    	call	KILBUF
0404   41C7 06 1E       	ld	b,30			; Since the user is trying pause the
0405   41C9 76          .wait3: 	halt				; boot messages, this gives him enough
0406   41CA             					; time to react and pause the next
0407   41CA             					; driver
0408   41CA 3A 9B FC    	ld	a,(INTFLG)
0409   41CD FE 04       	cp	4			; Was STOP pressed?
0410   41CF 28 02       	jr	z,.end			; quit so the next driver can process it
0411   41D1 10 F6       	djnz	.wait3			; The user will have the impression
0412   41D3             					; that he has a perfect timing.   ;)
0413   41D3             
0414   41D3             
0415   41D3             .end
0416   41D3 11 18 5A     	ld	de, strCrLf
0417   41D6 C3 CC 57    	jp	printString
0418   41D9             
0419   41D9             .chkikey: 
0420   41D9 CB 40       	bit	0,b			; Was the copyright message shown?
0421   41DB C0          	ret	nz			; Yes, return
0422   41DC CD 9F 00    	call	CHGET
0423   41DF FE 69       	cp	'i'
0424   41E1 28 03       	jr	z,.showcopyright
0425   41E3 FE 49       	cp	'I'
0426   41E5 C0          	ret	nz
0427   41E6             .showcopyright: 
0428   41E6 04          	inc	b			; Inhibit further presses of the i key 
0429   41E7 11 9B 59    	ld	de,strCopyright
0430   41EA C3 CC 57    	jp	printString
0431   41ED             
0432   41ED             .detecta: 
0433   41ED FD 77 30    	ld	(iy+NUMSD), a		; processo de deteccao dos cartoes
0434   41F0 11 1B 5A    	ld	de, strCartao
0435   41F3 CD CC 57    	call	printString
0436   41F6 FD 7E 30    	ld	a, (iy+NUMSD)
0437   41F9 C6 30       	add	'0'
0438   41FB CD A2 00    	call	CHPUT
0439   41FE 3E 3A       	ld	a, ':'
0440   4200 CD A2 00    	call	CHPUT
0441   4203 3E 20       	ld	a, ' '
0442   4205 CD A2 00    	call	CHPUT
0443   4208 FD 7E 30    	ld	a, (iy+NUMSD)
0444   420B 32 00 7F    	ld	(SPICTRL), a
0445   420E 3A 00 7F    	ld	a, (SPISTATUS)		; testar se cartao esta inserido
0446   4211 CD D8 45    	call	disableSDs
0447   4214 E6 02       	and	$02
0448   4216 28 09       	jr	z,.naoVazio
0449   4218 11 21 5A    	ld	de, strVazio		; nao tem cartao no slot
0450   421B CD CC 57    	call	printString
0451   421E C3 2F 42    	jp	.marcaErro
0452   4221             .naoVazio: 
0453   4221 CD 8A 44    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0454   4224 30 0C       	jr	nc,.detectou
0455   4226 CD D8 45    	call	disableSDs
0456   4229 11 29 5A    	ld	de, strNaoIdentificado
0457   422C CD CC 57    	call	printString
0458   422F             .marcaErro: 
0459   422F C3 48 44    	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0460   4232             .detectou: 
0461   4232 CD 62 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0462   4235 DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0463   4238 11 AA 5A    	ld	de, strSDV1	; e imprimir
0464   423B B7          	or	a
0465   423C 28 03       	jr	z,.pula1
0466   423E 11 B2 5A    	ld	de, strSDV2
0467   4241             .pula1: 
0468   4241 CD CC 57    	call	printString
0469   4244 3E 28       	ld	a,'('
0470   4246 CD A2 00    	call	CHPUT
0471   4249 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0472   424C CD 19 58    	call	printDecToAscii	; Imprimir Manufacturer ID
0473   424F 3E 29       	ld	a,')'
0474   4251 CD A2 00    	call	CHPUT
0475   4254 3E 20       	ld	a,' '
0476   4256 CD A2 00    	call	CHPUT
0477   4259 DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0478   425C CD 45 58    	call	pegaFabricante	; achar nome do fabricante
0479   425F EB          	ex	de,hl
0480   4260 CD CC 57    	call	printString	; e imprimir
0481   4263 11 18 5A    	ld	de,strCrLf
0482   4266 CD CC 57    	call	printString
0483   4269 C9          	ret
0484   426A             
0485   426A             
0486   426A             SDMAPPERINIT: 		; This block is exclusive for the SD-Mapper
0487   426A 11 34 5A    	ld	de, strMr_mp_desativada
0488   426D 3A 00 7F    	ld	a, (SPISTATUS)		; testar se mapper/megaram esta ativa
0489   4270 E6 01       	and	$01
0490   4272 28 0E       	jr	z,.print		; desativada, pula
0491   4274 11 5C 5A    	ld	de, strMapper
0492   4277 3A 00 7F    	ld	a, (SPISTATUS)		; ativa, testar se eh mapper ou megaram
0493   427A E6 02       	and	$02
0494   427C C2 CC 57    	jp	nz,printString
0495   427F 11 86 5A    	ld	de, strMegaram		; Megaram ativa
0496   4282             .print: 
0497   4282 C3 CC 57    	jp	printString
0498   4285             
0499   4285             ;-----------------------------------------------------------------------------
0500   4285             ;
0501   4285             ; Obtain driver version
0502   4285             ;
0503   4285             ; Input:  -
0504   4285             ; Output: A = Main version number
0505   4285             ;         B = Secondary version number
0506   4285             ;         C = Revision number
0507   4285             
0508   4285             DRV_VERSION: 
0509   4285 3E 01       	ld	a, VER_MAIN
0510   4287 06 00       	ld	b, VER_SEC
0511   4289 0E 06       	ld	c, VER_REV
0512   428B C9          	ret
0513   428C             
0514   428C             
0515   428C             ;-----------------------------------------------------------------------------
0516   428C             ;
0517   428C             ; BASIC expanded statement ("CALL") handler.
0518   428C             ; Works the expected way, except that if invoking CALBAS is needed,
0519   428C             ; it must be done via the CALLB0 routine in kernel page 0.
0520   428C             
0521   428C             DRV_BASSTAT: 
0522   428C 37          	scf
0523   428D C9          	ret
0524   428E             
0525   428E             
0526   428E             ;-----------------------------------------------------------------------------
0527   428E             ;
0528   428E             ; BASIC expanded device handler.
0529   428E             ; Works the expected way, except that if invoking CALBAS is needed,
0530   428E             ; it must be done via the CALLB0 routine in kernel page 0.
0531   428E             
0532   428E             DRV_BASDEV: 
0533   428E 37          	scf
0534   428F C9          	ret
0535   4290             
0536   4290             ;-----------------------------------------------------------------------------
0537   4290             ;
0538   4290             ; Extended BIOS hook.
0539   4290             ; Works the expected way, except that it must return
0540   4290             ; D'=1 if the old hook must be called, D'=0 otherwise.
0541   4290             ; It is entered with D'=1.
0542   4290             
0543   4290             DRV_EXTBIO: 
0544   4290 C9          	ret
0545   4291             
0546   4291             ;-----------------------------------------------------------------------------
0547   4291             ;
0548   4291             ; Direct calls entry points.
0549   4291             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0550   4291             ; in kernel banks 0 and 3 will be redirected
0551   4291             ; to DIRECT0/1/2/3/4 respectively.
0552   4291             ; Receives all register data from the caller except IX and AF'.
0553   4291             
0554   4291             DRV_DIRECT0: 
0555   4291             DRV_DIRECT1: 
0556   4291             DRV_DIRECT2: 
0557   4291             DRV_DIRECT3: 
0558   4291             DRV_DIRECT4: 
0559   4291 C9          	ret
0560   4292             
0561   4292             
0562   4292             ;=====
0563   4292             ;=====  BEGIN of DEVICE-BASED specific routines
0564   4292             ;=====
0565   4292             
0566   4292             ;-----------------------------------------------------------------------------
0567   4292             ;
0568   4292             ; Read or write logical sectors from/to a logical unit
0569   4292             ;
0570   4292             ;Input:    Cy=0 to read, 1 to write
0571   4292             ;          A = Device number, 1 to 7
0572   4292             ;          B = Number of sectors to read or write
0573   4292             ;          C = Logical unit number, 1 to 7
0574   4292             ;          HL = Source or destination memory address for the transfer
0575   4292             ;          DE = Address where the 4 byte sector number is stored.
0576   4292             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0577   4292             ;              0: Ok
0578   4292             ;              .IDEVL: Invalid device or LUN
0579   4292             ;              .NRDY: Not ready
0580   4292             ;              .DISK: General unknown disk error
0581   4292             ;              .DATA: CRC error when reading
0582   4292             ;              .RNF: Sector not found
0583   4292             ;              .UFORM: Unformatted disk
0584   4292             ;              .WPROT: Write protected media, or read-only logical unit
0585   4292             ;              .WRERR: Write error
0586   4292             ;              .NCOMP: Incompatible disk.
0587   4292             ;              .SEEK: Seek error.
0588   4292             ;          B = Number of sectors actually read (in case of error only)
0589   4292             
0590   4292             DEV_RW: 
0591   4292 F5          	push	af
0592   4294 BF FE 03    	cp	a, 3		; somente 2 dispositivos
0593   4296 30 10       	jr	nc,.saicomerroidl
0594   4298 0D          	dec	c		; somente 1 logical unit
0595   4299 20 0D       	jr	nz,.saicomerroidl
0596   429B E5          	push	hl
0597   429C CD 1F 44    	call	testaCartao	; verificar se cartao esta OK
0598   429F E1          	pop	hl
0599   42A0 30 0C       	jr	nc,.ok
0600   42A2 F1          	pop	af		; retira AF guardado no inicio
0601   42A3 3E FC       	ld	a, ENRDY	; Not ready
0602   42A5             ;	ld	a, EDISK	; General unknown disk error
0603   42A5 06 00       	ld	b, 0
0604   42A7 C9          	ret
0605   42A8             .saicomerroidl: 
0606   42A8 F1          	pop	af		; retira AF guardado no inicio
0607   42A9 3E B5       	ld	a, EIDEVL	; informar erro
0608   42AB 06 00       	ld	b, 0
0609   42AD C9          	ret
0610   42AE             .ok: 
0611   42AE FD 70 32    	ld	(iy+NUMBLOCOS), b	; guarda numero de blocos para ler/gravar
0612   42B1 E5          	push	hl
0613   42B2 D5          	push	de
0614   42B3 CD 62 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0615   42B6 D1          	pop	de
0616   42B7 E1          	pop	hl
0617   42B8 F1          	pop	af		; retira AF guardado no inicio, para saber se eh leitura ou escrita
0618   42B9 38 1F       	jr	c,escrita	; se for escrita pulamos
0619   42BB             leitura: 
0620   42BB 1A          	ld	a, (de)		; 1. n. bloco
0621   42BC F5          	push	af
0622   42BD 13          	inc	de
0623   42BE 1A          	ld	a, (de)		; 2. n. bloco
0624   42BF F5          	push	af
0625   42C0 13          	inc	de
0626   42C1 1A          	ld	a, (de)		; 3. n. bloco
0627   42C2 4F          	ld	c, a
0628   42C3 13          	inc	de
0629   42C4 1A          	ld	a, (de)		; 4. n. bloco
0630   42C5 13          	inc	de
0631   42C6 47          	ld	b, a
0632   42C7 F1          	pop	af
0633   42C8 57          	ld	d, a
0634   42C9 F1          	pop	af		; HL = ponteiro destino
0635   42CA 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0636   42CB CD 4E 4F    	call	LerBloco	; chamar rotina de leitura de dados
0637   42CE 30 08       	jr	nc,.ok
0638   42D0 CD 48 44    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0639   42D3             ;	ld	a, ENRDY	; Not ready
0640   42D3 3E FD       	ld	a, EDISK	; General unknown disk error
0641   42D5 06 00       	ld	b, 0		; informar que lemos 0 blocos
0642   42D7 C9          	ret
0643   42D8             .ok: 
0644   42D8 AF          	xor	a		; tudo OK, informar ao Nextor
0645   42D9 C9          	ret
0646   42DA             
0647   42DA             escrita: 
0648   42DA CD 53 44    	call	testaWP		; testar se cartao esta protegido contra escrita
0649   42DD 28 05       	jr	z,.ok
0650   42DF 3E F8       	ld	a, EWPROT	; disco protegido
0651   42E1 06 00       	ld	b, 0
0652   42E3 C9          	ret
0653   42E4             .ok: 
0654   42E4 1A          	ld	a, (de)		; 1. n. bloco
0655   42E5 F5          	push	af
0656   42E6 13          	inc	de
0657   42E7 1A          	ld	a, (de)		; 2. n. bloco
0658   42E8 F5          	push	af
0659   42E9 13          	inc	de
0660   42EA 1A          	ld	a, (de)		; 3. n. bloco
0661   42EB 13          	inc	de
0662   42EC 4F          	ld	c, a
0663   42ED 1A          	ld	a, (de)		; 4. n. bloco
0664   42EE 13          	inc	de
0665   42EF 47          	ld	b, a
0666   42F0 F1          	pop	af
0667   42F1 57          	ld	d, a
0668   42F2 F1          	pop	af		; HL = ponteiro destino
0669   42F3 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0670   42F4 CD 86 46    	call	GravarBloco	; chamar rotina de gravacao de dados
0671   42F7 30 08       	jr	nc,.ok2
0672   42F9 CD 48 44    	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0673   42FC 3E FE       	ld	a,EWRERR	; Write error
0674   42FE 06 00       	ld	b,0
0675   4300 C9          	ret
0676   4301             .ok2: 
0677   4301 AF          	xor	a			; gravacao sem erros!
0678   4302 C9          	ret
0679   4303             
0680   4303             ;-----------------------------------------------------------------------------
0681   4303             ;
0682   4303             ; Device information gathering
0683   4303             ;
0684   4303             ;Input:   A = Device index, 1 to 7
0685   4303             ;         B = Information to return:
0686   4303             ;             0: Basic information
0687   4303             ;             1: Manufacturer name string
0688   4303             ;             2: Device name string
0689   4303             ;             3: Serial number string
0690   4303             ;         HL = Pointer to a buffer in RAM
0691   4303             ;Output:  A = Error code:
0692   4303             ;             0: Ok
0693   4303             ;             1: Device not available or invalid device index
0694   4303             ;             2: Information not available, or invalid information index
0695   4303             ;         When basic information is requested,
0696   4303             ;         buffer filled with the following information:
0697   4303             ;
0698   4303             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0699   4303             ;        units (which is functionally equivalent to having only one).
0700   4303             ;+1 (1): Device flags, always zero in Beta 2.
0701   4303             ;
0702   4303             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0703   4303             ; left justified and padded with spaces. All the strings are optional,
0704   4303             ; if not available, an error must be returned.
0705   4303             ; If a string is provided by the device in binary format, it must be reported
0706   4303             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0707   4303             ; The maximum length for a string is 64 characters;
0708   4303             ; if the string is actually longer, the leftmost 64 characters
0709   4303             ; should be provided.
0710   4303             ;
0711   4303             ; In the case of the serial number string, the same rules for the strings
0712   4303             ; apply, except that it must be provided right-justified,
0713   4303             ; and if it is too long, the rightmost characters must be
0714   4303             ; provided, not the leftmost.
0715   4303             
0716   4303             DEV_INFO: 
0717   4303 04          	inc	b
0718   4305 BF FE 03    	cp	a,3		; somente 2 dispositivos
0719   4307 30 07       	jr	nc,.saicomerro
0720   4309 E5          	push	hl
0721   430A CD 1F 44    	call	testaCartao	; verificar se cartao esta OK
0722   430D E1          	pop	hl
0723   430E 30 03       	jr	nc,.ok		; nao houve erro
0724   4310             .saicomerro: 
0725   4310 3E 01       	ld	a, 1		; informar erro
0726   4312 C9          	ret
0727   4313             
0728   4313             .ok: 
0729   4313 10 07       	djnz	.naoBasic
0730   4315             ; Basic information:
0731   4315 3E 01       	ld	a,1		; 1 logical unit somente
0732   4317 77          	ld	(hl), a
0733   4318 AF          	xor	a		; reservado, deve ser 0
0734   4319 23          	inc	hl
0735   431A 77          	ld	(hl), a
0736   431B C9          	ret			; retorna com A=0 (OK)
0737   431C             
0738   431C             .naoBasic: 
0739   431C E5          	push	hl
0740   431D CD 62 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0741   4320 E1          	pop	hl
0742   4321 10 25       	djnz	.naoManuf
0743   4323             ; Manufacturer Name:
0744   4323 E5          	push	hl		; salva ponteiro do buffer
0745   4324 06 40       	ld	b, 64		; preenche buffer com espaco
0746   4326 3E 20       	ld	a, ' '
0747   4328             .loop1: 
0748   4328 77          	ld	(hl), a
0749   4329 23          	inc	hl
0750   432A 10 FC       	djnz	.loop1
0751   432C D1          	pop	de		; recuperamos ponteiro do buffer em DE
0752   432D 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0753   432F 12          	ld	(de), a
0754   4330 13          	inc	de
0755   4331 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0756   4334 CD D5 57    	call	DecToAscii
0757   4337 3E 29       	ld	a, ')'
0758   4339 12          	ld	(de), a
0759   433A 13          	inc	de
0760   433B 3E 20       	ld	a, ' '
0761   433D 12          	ld	(de), a
0762   433E 13          	inc	de
0763   433F DD 7E 00    	ld	a, (ix)		; byte do fabricante
0764   4342 CD 45 58    	call	pegaFabricante	; pegar nome do fabricante em HL
0765   4345 ED B0       	ldir			; e colocar no buffer
0766   4347 C9          	ret
0767   4348             
0768   4348             .naoManuf: 
0769   4348 10 1A       	djnz	.naoProduct
0770   434A             ; Product Name:
0771   434A E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0772   434B DD E5       	push	ix
0773   434D E1          	pop	hl		; joga IX para HL
0774   434E 16 00       	ld	d, 0
0775   4350 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0776   4352 19          	add	hl, de
0777   4353 D1          	pop	de		; recupera buffer do Nextor em DE
0778   4354 01 05 00    	ld	bc, 5		; 5 caracteres
0779   4357 ED B0       	ldir			; copia nome do produto
0780   4359 EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0781   435A 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0782   435C 3E 20       	ld	a, ' '
0783   435E             .loop2: 
0784   435E 77          	ld	(hl), a
0785   435F 23          	inc	hl
0786   4360 10 FC       	djnz	.loop2
0787   4362 AF          	xor	a		; informar sem erros
0788   4363 C9          	ret
0789   4364             
0790   4364             .naoProduct: 
0791   4364             ; Serial:
0792   4364 3E 30       	ld	a, '0'		; Coloca prefixo "0x"
0793   4366 77          	ld	(hl), a
0794   4367 23          	inc	hl
0795   4368 3E 78       	ld	a, 'x'
0796   436A 77          	ld	(hl), a
0797   436B 23          	inc	hl
0798   436C E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0799   436D DD E5       	push	ix
0800   436F E1          	pop	hl		; joga IX para HL
0801   4370 16 00       	ld	d, 0
0802   4372 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0803   4374 19          	add	hl, de
0804   4375 D1          	pop	de		; recupera buffer do nextor em DE
0805   4376 06 04       	ld	b, 4		; 4 bytes do serial
0806   4378             .loop3: 
0807   4378 7E          	ld	a, (hl)
0808   4379 CD 05 58    	call	HexToAscii	; converter HEXA para ASCII
0809   437C 23          	inc	hl
0810   437D 10 F9       	djnz	.loop3
0811   437F 06 36       	ld	b, 54		; Coloca espaco no restante
0812   4381 3E 20       	ld	a, ' '
0813   4383             .loop4: 
0814   4383 12          	ld	(de), a
0815   4384 13          	inc	de
0816   4385 10 FC       	djnz	.loop4
0817   4387 AF          	xor	a		; informar sem erros
0818   4388 C9          	ret
0819   4389             
0820   4389             ;-----------------------------------------------------------------------------
0821   4389             ;
0822   4389             ; Obtain device status
0823   4389             ;
0824   4389             ;Input:   A = Device index, 1 to 7
0825   4389             ;         B = Logical unit number, 1 to 7
0826   4389             ;             0 to return the status of the device itself.
0827   4389             ;Output:  A = Status for the specified logical unit,
0828   4389             ;             or for the whole device if 0 was specified:
0829   4389             ;                0: The device or logical unit is not available, or the
0830   4389             ;                   device or logical unit number supplied is invalid.
0831   4389             ;                1: The device or logical unit is available and has not
0832   4389             ;                   changed since the last status request.
0833   4389             ;                2: The device or logical unit is available and has changed
0834   4389             ;                   since the last status request
0835   4389             ;                   (for devices, the device has been unplugged and a
0836   4389             ;                    different device has been plugged which has been
0837   4389             ;                    assigned the same device index; for logical units,
0838   4389             ;                    the media has been changed).
0839   4389             ;                3: The device or logical unit is available, but it is not
0840   4389             ;                   possible to determine whether it has been changed
0841   4389             ;                   or not since the last status request.
0842   4389             ;
0843   4389             ; Devices not supporting hot-plugging must always return status value 1.
0844   4389             ; Non removable logical units may return values 0 and 1.
0845   4389             ;
0846   4389             ; The returned status is always relative to the previous invokation of
0847   4389             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0848   4389             
0849   4389             DEV_STATUS: 
0850   438A BF FE 03    	cp	a,3		; 2 dispositivos somente
0851   438C 30 39       	jr	nc,.saicomerro
0852   438E 05          	dec	b		; 1 logical unit somente
0853   438F 20 36       	jr	nz,.saicomerro
0854   4391             
0855   4391 F5          	push	af
0856   4392 CD 09 44    	call	pegaWorkArea	; HL=IY=Work area pointer
0857   4395 F1          	pop	af
0858   4396 FD 77 30    	ld	(iy+NUMSD),a	; salva numero do device atual (1 ou 2)
0859   4399 4F          	ld	c, a
0860   439A 32 00 7F    	ld	(SPICTRL), a	; selects SD
0861   439D 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta inserido
0862   43A0 CD D8 45    	call	disableSDs
0863   43A3 E6 02       	and	$02
0864   43A5 20 1D       	jr	nz,.cartaoComErro	; se slot do cartao estiver vazio, marcamos o erro nas flags
0865   43A7 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
0866   43AA A1          	and	c
0867   43AB 28 14       	jr	z,.semMudanca	; cartao nao marcado com erro, pula
0868   43AD CD 8A 44    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0869   43B0 38 12       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0870   43B2 FD 7E 30    	ld	a, (iy+NUMSD)		; conseguimos detectar, tira erro nas flags
0871   43B5 2F          	cpl			; inverte bits para fazer o AND
0872   43B6 4F          	ld	c, a
0873   43B7 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)
0874   43BA A1          	and	c			; limpa bit
0875   43BB FD 77 31    	ld	(iy+FLAGSCARTAO), a
0876   43BE             .comMudanca: 
0877   43BE 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0878   43C0 C9          	ret
0879   43C1             .semMudanca: 
0880   43C1 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0881   43C3 C9          	ret
0882   43C4             .cartaoComErro: 
0883   43C4 CD 48 44    	call	marcaErroCartao	; marcar erro do cartao nas flags
0884   43C7             .saicomerro: 
0885   43C7 3E 00       	ld	a, 0		; informa erro
0886   43C9 C9          	ret
0887   43CA             
0888   43CA             ;-----------------------------------------------------------------------------
0889   43CA             ;
0890   43CA             ; Obtain logical unit information
0891   43CA             ;
0892   43CA             ;Input:   A  = Device index, 1 to 7
0893   43CA             ;         B  = Logical unit number, 1 to 7
0894   43CA             ;         HL = Pointer to buffer in RAM.
0895   43CA             ;Output:  A = 0: Ok, buffer filled with information.
0896   43CA             ;             1: Error, device or logical unit not available,
0897   43CA             ;                or device index or logical unit number invalid.
0898   43CA             ;         On success, buffer filled with the following information:
0899   43CA             ;
0900   43CA             ;+0 (1): Medium type:
0901   43CA             ;        0: Block device
0902   43CA             ;        1: CD or DVD reader or recorder
0903   43CA             ;        2-254: Unused. Additional codes may be defined in the future.
0904   43CA             ;        255: Other
0905   43CA             ;+1 (2): Sector size, 0 if this information does not apply or is
0906   43CA             ;        not available.
0907   43CA             ;+3 (4): Total number of available sectors.
0908   43CA             ;        0 if this information does not apply or is not available.
0909   43CA             ;+7 (1): Flags:
0910   43CA             ;        bit 0: 1 if the medium is removable.
0911   43CA             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0912   43CA             ;               be write protected or write enabled is not considered
0913   43CA             ;               to be read-only.
0914   43CA             ;        bit 2: 1 if the LUN is a floppy disk drive.
0915   43CA             ;+8 (2): Number of cylinders
0916   43CA             ;+10 (1): Number of heads
0917   43CA             ;+11 (1): Number of sectors per track
0918   43CA             ;
0919   43CA             ; Number of cylinders, heads and sectors apply to hard disks only.
0920   43CA             ; For other types of device, these fields must be zero.
0921   43CA             
0922   43CA             LUN_INFO: 
0923   43CB BF FE 03    	cp	a, 3		; somente 2 dispositivo
0924   43CD 30 0A       	jr	nc,.saicomerro
0925   43CF 05          	dec	b		; somente 1 logical unit
0926   43D0 20 07       	jr	nz,.saicomerro
0927   43D2 E5          	push	hl
0928   43D3 CD 1F 44    	call	testaCartao
0929   43D6 E1          	pop	hl
0930   43D7 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0931   43D9             .saicomerro: 
0932   43D9 3E 01       	ld	a, 1		; informar erro
0933   43DB C9          	ret
0934   43DC             .ok: 
0935   43DC E5          	push	hl
0936   43DD CD 76 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0937   43E0 E1          	pop	hl		; do cartao dependendo do cartao atual solicitado
0938   43E1 AF          	xor	a
0939   43E2 77          	ld	(hl), a		; Informar que o dispositivo eh do tipo block device
0940   43E3 23          	inc	hl
0941   43E4 77          	ld	(hl), a		; tamanho de um bloco = 512 bytes (coloca $00, $02 que é $200 = 512)
0942   43E5 23          	inc	hl
0943   43E6 3E 02       	ld	a, 2
0944   43E8 77          	ld	(hl), a
0945   43E9 23          	inc	hl
0946   43EA DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0947   43ED 77          	ld	(hl), a
0948   43EE 23          	inc	hl
0949   43EF DD 7E 01    	ld	a, (ix+1)
0950   43F2 77          	ld	(hl), a
0951   43F3 23          	inc	hl
0952   43F4 DD 7E 02    	ld	a, (ix+2)
0953   43F7 77          	ld	(hl), a
0954   43F8 23          	inc	hl
0955   43F9 AF          	xor	a		; cartoes SD tem total de blocos em 24 bits, mas o Nextor pede numero de
0956   43FA 77          	ld	(hl), a 	; 32 bits, entao coloca 0 no MSB
0957   43FB 23          	inc	hl
0958   43FC 3E 01       	ld	a, 1		; flags: dispositivo R/W removivel
0959   43FE 77          	ld	(hl), a
0960   43FF 23          	inc	hl
0961   4400 AF          	xor	a		; CHS = 0
0962   4401 77          	ld	(hl), a
0963   4402 23          	inc	hl
0964   4403 77          	ld	(hl), a
0965   4404 23          	inc	hl
0966   4405 77          	ld	(hl), a
0967   4406 23          	inc	hl
0968   4407 AF          	xor	a		; informar que dados foram preenchidos
0969   4408 C9          	ret
0970   4409             
0971   4409             ;=====
0972   4409             ;=====  END of DEVICE-BASED specific routines
0973   4409             ;=====
0974   4409             
0975   4409             ;------------------------------------------------
0976   4409             ; Rotinas auxiliares
0977   4409             ;------------------------------------------------
0978   4409             
0979   4409             ;------------------------------------------------
0980   4409             ; Pedir ao Nextor o ponteiro de dados de trabalho
0981   4409             ; na RAM e colocar em HL e IY
0982   4409             ; Destroi HL e IY
0983   4409             ;------------------------------------------------
0984   4409             pegaWorkArea: 
0985   4409 F5          	push	af
0986   440A AF          	xor	a		; Pegar endereco da area de trabalho
0987   440B 08          	ex	af,af'
0988   440C AF          	xor	a
0989   440D DD 21 45 40 	ld	ix, GWORK
0990   4411 CD 42 40    	call	CALBNK
0991   4414 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
0992   4417 DD 66 01    	ld	h,(ix+1)
0993   441A E5          	push	hl
0994   441B FD E1       	pop	iy		; em IY temos o mesmo ponteiro
0995   441D F1          	pop	af
0996   441E C9          	ret
0997   441F             
0998   441F             ;------------------------------------------------
0999   441F             ; Testa se cartao esta inserido e/ou houve erro
1000   441F             ; na ultima vez que foi acessado. Carry indica
1001   441F             ; erro
1002   441F             ; Destroi AF, HL, IX, C
1003   441F             ;------------------------------------------------
1004   441F             testaCartao: 
1005   441F F5          	push	af
1006   4420 CD 09 44    	call	pegaWorkArea	; HL=IY=Work area pointer
1007   4423 F1          	pop	af
1008   4424 FD 77 30    	ld	(iy+NUMSD), a	; salva numero do device atual (1 ou 2)
1009   4427 4F          	ld	c, a
1010   4428 32 00 7F    	ld	(SPICTRL), a	; Selects SD
1011   442B 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta inserido
1012   442E CD D8 45    	call	disableSDs
1013   4431 E6 02       	and	$02
1014   4433 20 0A       	jr	nz,.saicomerro				
1015   4435 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
1016   4438 A1          	and	c
1017   4439 28 02       	jr	z,.ok
1018   443B 37          	scf			; indica erro
1019   443C C9          	ret
1020   443D             .ok: 
1021   443D AF          	xor	a		; zera carry indicando sem erro
1022   443E C9          	ret
1023   443F             .saicomerro: 
1024   443F FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marca bit de erro nas flags
1025   4442 B1          	or	c
1026   4443 FD 77 31    	ld	(iy+FLAGSCARTAO), a
1027   4446 37          	scf
1028   4447 C9          	ret
1029   4448             
1030   4448             ;------------------------------------------------
1031   4448             ; Marcar bit de erro nas flags
1032   4448             ; Destroi AF, C
1033   4448             ;------------------------------------------------
1034   4448             marcaErroCartao: 
1035   4448 FD 4E 30    	ld	c, (iy+NUMSD)		; cartao atual (1 ou 2)
1036   444B FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marcar erro
1037   444E B1          	or	c
1038   444F FD 77 31    	ld	(iy+FLAGSCARTAO), a
1039   4452 C9          	ret
1040   4453             
1041   4453             ;------------------------------------------------
1042   4453             ; Testar se cartao atual esta protegido contra
1043   4453             ; gravacao, A=0 se protegido
1044   4453             ; Destroi AF, C
1045   4453             ;------------------------------------------------
1046   4453             testaWP: 
1047   4453 FD 7E 30    	ld	a, (iy+NUMSD)	; cartao atual (1 ou 2)
1048   4456 32 00 7F    	ld	(SPICTRL), a
1049   4459 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta protegido
1050   445C CD D8 45    	call	disableSDs
1051   445F E6 04       	and	$04
1052   4461 C9          	ret			; se A for 0 cartao esta protegido
1053   4462             
1054   4462             ;------------------------------------------------
1055   4462             ; Calcula offset do buffer na RAM em HL e IX para
1056   4462             ; os dados do CID dependendo do cartao atual
1057   4462             ; Destroi AF, DE, HL e IX
1058   4462             ;------------------------------------------------
1059   4462             calculaCIDoffset: 
1060   4462 FD E5       	push	iy		; copiamos IY para HL
1061   4464 E1          	pop	hl
1062   4465 16 00       	ld	d, 0
1063   4467 1E 10       	ld	e, BCID1	; DE aponta para buffer BCID1
1064   4469 FD 7E 30    	ld	a, (iy+NUMSD)	; vamos fazer IX apontar para o buffer correto
1065   446C 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1066   446D 28 02       	jr	z,.c1
1067   446F 1E 20       	ld	e, BCID2	; DE aponta para buffer BCID2
1068   4471             .c1: 
1069   4471 19          	add	hl, de		; HL aponta para buffer correto
1070   4472 E5          	push	hl		
1071   4473 DD E1       	pop	ix		; vamos colocar HL em IX
1072   4475 C9          	ret
1073   4476             
1074   4476             ;------------------------------------------------
1075   4476             ; Calcula offset do buffer na RAM para os dados
1076   4476             ; do total de blocos dependendo do cartao atual
1077   4476             ; Offset fica em HL e IX
1078   4476             ; Destroi AF, DE, HL e IX
1079   4476             ;------------------------------------------------
1080   4476             calculaBLOCOSoffset: 
1081   4476 FD E5       	push	iy		; copiamos IY para HL
1082   4478 E1          	pop	hl
1083   4479 16 00       	ld	d, 0
1084   447B 1E 38       	ld	e, BLOCOS1	; DE aponta para buffer BLOCOS1
1085   447D FD 7E 30    	ld	a, (iy+NUMSD)	; Vamos fazer IX apontar para o buffer correto
1086   4480 3D          	dec	a		; dependendo do cartao: BLOCOS1 ou BLOCOS2
1087   4481 28 02       	jr	z,.c1
1088   4483 1E 3C       	ld	e, BLOCOS2	; DE aponta para buffer BLOCOS2
1089   4485             .c1: 
1090   4485 19          	add	hl, de		; HL aponta para buffer correto
1091   4486 E5          	push	hl		
1092   4487 DD E1       	pop	ix		; Vamos colocar HL em IX
1093   4489 C9          	ret
1094   448A             
1095   448A             
1096   448A             ;------------------------------------------------
1097   448A             ; Minhas funcoes para cartao SD
1098   448A             ;------------------------------------------------
1099   448A             
1100   448A             ;------------------------------------------------
1101   448A             ; Processo de inicializacao e deteccao do cartao.
1102   448A             ; Detecta se cartao responde, qual versao (SDV1
1103   448A             ; ou SDV2), faz a leitura do CSD e CID e calcula
1104   448A             ; o numero de blocos do cartao, colocando o CID
1105   448A             ; e total de blocos no buffer correto dependendo
1106   448A             ; do cartao 1 ou 2.
1107   448A             ; Retorna erro no carry. Se for 0 indica deteccao
1108   448A             ; com sucesso.
1109   448A             ; Destroi todos os registradores
1110   448A             ;------------------------------------------------
1111   448A             detectaCartao: 
1112   448A CD B9 45    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1113   448D D8          	ret	c			; retorna se erro
1114   448E CD 59 45    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1115   4491 D8          	ret	c
1116   4492 FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1117   4494 E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1118   4495 3E 49       	ld	a, CMD9		; ler CSD
1119   4497 CD 7A 45    	call	lerBlocoCxD
1120   449A D8          	ret	c
1121   449B CD 62 44    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1122   449E 3E 4A       	ld	a, CMD10	; ler CID
1123   44A0 CD 7A 45    	call	lerBlocoCxD
1124   44A3 D8          	ret	c
1125   44A4 3E 7A       	ld	a, CMD58	; ler OCR
1126   44A6 11 00 00    	ld	de, 0
1127   44A9 CD 09 46    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1128   44AC D8          	ret	c
1129   44AD 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1130   44AE E6 40       	and	$40
1131   44B0 DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1132   44B3 CC 4E 45    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1133   44B6 D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1134   44B7 CD D8 45    	call	disableSDs
1135   44BA             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1136   44BA CD 76 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1137   44BD FD E5       	push	iy		; copiamos IY para HL
1138   44BF E1          	pop	hl
1139   44C0 16 00       	ld	d, 0
1140   44C2 1E 05       	ld	e, BCSD+5
1141   44C4 19          	add	hl, de		; HL aponta para buffer BCSD+5
1142   44C5 FD 7E 00    	ld	a, (iy+BCSD)
1143   44C8 E6 C0       	and	$C0		; testa versao do registro CSD
1144   44CA 28 06       	jr	z,.calculaCSD1
1145   44CC FE 40       	cp	$40
1146   44CE 28 54       	jr	z,.calculaCSD2
1147   44D0 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1148   44D1 C9          	ret
1149   44D2             
1150   44D2             ; -----------------------------------
1151   44D2             ; Registro CSD versao 1, calcular da
1152   44D2             ; maneira correta para a versao 1
1153   44D2             ; -----------------------------------
1154   44D2             .calculaCSD1: 
1155   44D2 7E          	ld	a, (hl)
1156   44D3 E6 0F       	and	$0F		; isola READ_BL_LEN
1157   44D5 F5          	push	af
1158   44D6 23          	inc	hl
1159   44D7 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1160   44D8 E6 03       	and	3
1161   44DA 57          	ld	d, a
1162   44DB 23          	inc	hl
1163   44DC 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1164   44DD 23          	inc	hl
1165   44DE 7E          	ld	a, (hl)
1166   44DF E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1167   44E1 87          	add	a, a		; rotaciona a esquerda
1168   44E2 CB 13       	rl	e		; rotaciona para DE
1169   44E4 CB 12       	rl	d
1170   44E6 87          	add	a, a		; mais uma rotacao
1171   44E7 CB 13       	rl	e		; rotaciona para DE
1172   44E9 CB 12       	rl	d
1173   44EB 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1174   44EC 23          	inc	hl
1175   44ED 7E          	ld	a, (hl)		; proximo byte
1176   44EE E6 03       	and	3		; 2 bits de C_SIZE_MUL
1177   44F0 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1178   44F1 23          	inc	hl						
1179   44F2 7E          	ld	a, (hl)		; proximo byte
1180   44F3 E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1181   44F5 87          	add	a, a		; rotaciona para esquerda jogando no carry
1182   44F6 CB 10       	rl	b		; rotaciona para B
1183   44F8 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1184   44F9 04          	inc	b		; faz B = C_SIZE_MUL + 2
1185   44FA F1          	pop	af		; volta em A o READ_BL_LEN
1186   44FB 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1187   44FC 01 00 00    	ld	bc, 0
1188   44FF CD 18 45    	call	.eleva2
1189   4502 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1190   4503 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1191   4504 48          	ld	c, b
1192   4505 06 00       	ld	b, 0
1193   4507 CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1194   4509 CB 1A       	rr	d		; rotacionamos D e E
1195   450B CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1196   450D             .salvaBlocos: 
1197   450D DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1198   4510 DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1199   4513 DD 73 00    	ld	(ix), e
1200   4516 AF          	xor	a		; limpa carry
1201   4517 C9          	ret
1202   4518             
1203   4518             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1204   4518             				; BC = 0
1205   4518             				; DE = C_SIZE
1206   4518 CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1207   451A CB 12       	rl	d
1208   451C CB 11       	rl	c
1209   451E CB 10       	rl	b
1210   4520 3D          	dec	a		; subtraimos 1
1211   4521 20 F5       	jr	nz,.eleva2
1212   4523 C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1213   4524             
1214   4524             ; -----------------------------------
1215   4524             ; Registro CSD versao 2, calcular da
1216   4524             ; maneira correta para a versao 2
1217   4524             ; -----------------------------------
1218   4524             .calculaCSD2: 
1219   4524 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1220   4525 23          	inc	hl
1221   4526 7E          	ld	a, (hl)
1222   4527 E6 3F       	and	$3F
1223   4529 4F          	ld	c, a
1224   452A 23          	inc	hl
1225   452B 56          	ld	d, (hl)
1226   452C 23          	inc	hl
1227   452D 5E          	ld	e, (hl)
1228   452E CD 3A 45    	call	.inc32		; soma 1
1229   4531 CD 42 45    	call	.desloca32	; multiplica por 512
1230   4534 CD 47 45    	call	.rotaciona24	; multiplica por 2
1231   4537 C3 0D 45    	jp		.salvaBlocos
1232   453A             
1233   453A             .inc32: 
1234   453A 1C          	inc	e
1235   453B C0          	ret	nz
1236   453C 14          	inc	d
1237   453D C0          	ret	nz
1238   453E 0C          	inc	c
1239   453F C0          	ret	nz
1240   4540 04          	inc	b
1241   4541 C9          	ret
1242   4542             
1243   4542             .desloca32: 
1244   4542 41          	ld	b, c
1245   4543 4A          	ld	c, d
1246   4544 53          	ld	d, e
1247   4545 1E 00       	ld	e, 0
1248   4547             .rotaciona24: 
1249   4547 CB 22       	sla	d
1250   4549 CB 11       	rl	c
1251   454B CB 10       	rl	b
1252   454D C9          	ret
1253   454E             
1254   454E             ; ------------------------------------------------
1255   454E             ; Setar o tamanho do bloco para 512 se o cartao
1256   454E             ; for SDV1
1257   454E             ; ------------------------------------------------
1258   454E             mudarTamanhoBlocoPara512: 
1259   454E 3E 50       	ld	a, CMD16
1260   4550 01 00 00    	ld	bc, 0
1261   4553 11 00 02    	ld	de, 512
1262   4556 C3 F4 45    	jp	SD_SEND_CMD_GET_ERROR
1263   4559             
1264   4559             ; ------------------------------------------------
1265   4559             ; Tenta inicializar um cartao SDV2, se houver erro
1266   4559             ; o cartao deve ser SDV1
1267   4559             ; ------------------------------------------------
1268   4559             testaSDCV2: 
1269   4559 3E 48       	ld	a, CMD8
1270   455B 11 AA 01    	ld	de, $1AA
1271   455E CD 09 46    	call	SD_SEND_CMD_2_ARGS_GET_R3
1272   4561 21 ED 45    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1273   4564 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1274   4566 21 DF 45    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1275   4569             .pula: 
1276   4569 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1277   456C             .loop: 
1278   456C C5          	push	bc
1279   456D CD 79 45    	call	.jumpHL		; chamar rotina correta em HL
1280   4570 C1          	pop	bc
1281   4571 D0          	ret	nc
1282   4572 10 F8       	djnz	.loop
1283   4574 0D          	dec	c
1284   4575 20 F5       	jr	nz,.loop
1285   4577 37          	scf
1286   4578 C9          	ret
1287   4579             .jumpHL: 
1288   4579 E9          	jp	(hl)		; chamar rotina correta em HL
1289   457A             
1290   457A             ; ------------------------------------------------
1291   457A             ; Ler registro CID ou CSD, o comando vem em A
1292   457A             ; ------------------------------------------------
1293   457A             lerBlocoCxD: 
1294   457A CD EF 45    	call	SD_SEND_CMD_NO_ARGS
1295   457D D8          	ret	c
1296   457E CD 4E 46    	call	WAIT_RESP_FE
1297   4581 D8          	ret	c
1298   4582 EB          	ex	de,hl
1299   4583             
1300   4583             	; Check for a Z80 or R800
1301   4583             ;	or 	a		; Clear Cy
1302   4583 3E 14       	ld	a,20
1303   4585 ED F9       	db	#ED,#F9		; mulub a,a
1304   4587 21 00 7B    	ld	hl, SPIDATA
1305   458A 38 26       	jr	c,.r800		; Use LDIR for R800
1306   458C ED A0       > ldi	
1306   458E ED A0       > ldi	
1306   4590 ED A0       > ldi	
1306   4592 ED A0       > ldi	
1306   4594 ED A0       > ldi	
1306   4596 ED A0       > ldi	
1306   4598 ED A0       > ldi	
1306   459A ED A0       > ldi	
1306   459C ED A0       > ldi	
1306   459E ED A0       > ldi	
1306   45A0 ED A0       > ldi	
1306   45A2 ED A0       > ldi	
1306   45A4 ED A0       > ldi	
1306   45A6 ED A0       > ldi	
1306   45A8 ED A0       > ldi	
1306   45AA ED A0       > ldi	
1307   45AC             .end
1308   45AC 7E           	ld	a, (hl)
1309   45AD 7E          	ld	a, (hl)		; byte de resposta
1310   45AE B7          	or	a
1311   45AF EB          	ex	de,hl
1312   45B0 18 26       	jr		disableSDs
1313   45B2             
1314   45B2             .r800: 
1315   45B2 01 10 00    	ld	bc,16
1316   45B5 ED B0       	ldir
1317   45B7 18 F3       	jr	.end
1318   45B9             
1319   45B9             ; ------------------------------------------------
1320   45B9             ; Algoritmo para inicializar um cartao SD
1321   45B9             ; Destroi AF, B, DE
1322   45B9             ; ------------------------------------------------
1323   45B9             iniciaSD: 
1324   45B9 CD D8 45    	call	disableSDs
1325   45BC             
1326   45BC 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1327   45BE             enviaClocksInicio: 
1328   45BE 3E FF       	ld	a, $FF		; manter MOSI em 1
1329   45C0 32 00 7B    	ld	(SPIDATA), a
1330   45C3 10 F9       	djnz	enviaClocksInicio
1331   45C5 CD 7A 46    	call	setaSDAtual	; ativar cartao atual
1332   45C8 06 08       	ld	b, 8		; 8 tentativas para CMD0
1333   45CA             SD_SEND_CMD0: 
1334   45CA 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1335   45CC 11 00 00    	ld	de, 0
1336   45CF C5          	push	bc
1337   45D0 CD FC 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1338   45D3 C1          	pop	bc
1339   45D4 D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1340   45D5 10 F3       	djnz	SD_SEND_CMD0
1341   45D7 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1342   45D8             	; fall throw
1343   45D8             
1344   45D8             ; ------------------------------------------------
1345   45D8             ; Desabilitar (de-selecionar) todos os cartoes
1346   45D8             ; Nao destroi registradores
1347   45D8             ; ------------------------------------------------
1348   45D8             disableSDs: 
1349   45D8 F5          	push	af
1350   45D9 AF          	xor	a
1351   45DA 32 00 7F    	ld	(SPICTRL), a
1352   45DD F1          	pop	af
1353   45DE C9          	ret
1354   45DF             
1355   45DF             ; ------------------------------------------------
1356   45DF             ; Enviar comando ACMD41
1357   45DF             ; ------------------------------------------------
1358   45DF             SD_SEND_ACMD41: 
1359   45DF 3E 77       	ld	a, CMD55
1360   45E1 CD EF 45    	call	SD_SEND_CMD_NO_ARGS
1361   45E4 3E 69       	ld	a, ACMD41
1362   45E6 01 00 40    	ld	bc, $4000
1363   45E9 51          	ld	d, c
1364   45EA 59          	ld	e, c
1365   45EB 18 07       	jr		SD_SEND_CMD_GET_ERROR
1366   45ED             
1367   45ED             ; ------------------------------------------------
1368   45ED             ; Enviar CMD1 para cartao. Carry indica erro
1369   45ED             ; Destroi AF, BC, DE
1370   45ED             ; ------------------------------------------------
1371   45ED             SD_SEND_CMD1: 
1372   45ED 3E 41       	ld	a, CMD1
1373   45EF             SD_SEND_CMD_NO_ARGS: 
1374   45EF 01 00 00    	ld	bc, 0
1375   45F2 50          	ld	d, b
1376   45F3 59          	ld	e, c
1377   45F4             SD_SEND_CMD_GET_ERROR: 
1378   45F4 CD 22 46    	call	SD_SEND_CMD
1379   45F7 B7          	or	a
1380   45F8 C8          	ret	z			; se A=0 nao houve erro, retornar
1381   45F9             	; fall throw
1382   45F9             
1383   45F9             ; ------------------------------------------------
1384   45F9             ; Informar erro
1385   45F9             ; Nao destroi registradores
1386   45F9             ; ------------------------------------------------
1387   45F9             setaErro: 
1388   45F9 37          	scf
1389   45FA 18 DC       	jr		disableSDs
1390   45FC             
1391   45FC             ; ------------------------------------------------
1392   45FC             ; Enviar comando em A com 2 bytes de parametros
1393   45FC             ; em DE e testar retorno BUSY
1394   45FC             ; Retorna em A a resposta do cartao
1395   45FC             ; Destroi AF, BC
1396   45FC             ; ------------------------------------------------
1397   45FC             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1398   45FC 01 00 00    	ld	bc, 0
1399   45FF CD 22 46    	call	SD_SEND_CMD
1400   4602 47          	ld	b, a
1401   4603 E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1402   4605 78          	ld	a, b
1403   4606 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1404   4608 C9          	ret			; sem erros
1405   4609             
1406   4609             ; ------------------------------------------------
1407   4609             ; Enviar comando em A com 2 bytes de parametros
1408   4609             ; em DE e ler resposta do tipo R3 em BC DE
1409   4609             ; Retorna em A a resposta do cartao
1410   4609             ; Destroi AF, BC, DE, HL
1411   4609             ; ------------------------------------------------
1412   4609             SD_SEND_CMD_2_ARGS_GET_R3: 
1413   4609 CD FC 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1414   460C D8          	ret	c
1415   460D F5          	push	af
1416   460E CD 5C 46    	call	WAIT_RESP_NO_FF
1417   4611 67          	ld	h, a
1418   4612 CD 5C 46    	call	WAIT_RESP_NO_FF
1419   4615 6F          	ld	l, a
1420   4616 CD 5C 46    	call	WAIT_RESP_NO_FF
1421   4619 57          	ld	d, a
1422   461A CD 5C 46    	call	WAIT_RESP_NO_FF
1423   461D 5F          	ld	e, a
1424   461E 44          	ld	b, h
1425   461F 4D          	ld	c, l
1426   4620 F1          	pop	af
1427   4621 C9          	ret
1428   4622             
1429   4622             ; ------------------------------------------------
1430   4622             ; Enviar comando em A com 4 bytes de parametros
1431   4622             ; em BC DE e enviar CRC correto se for CMD0 ou 
1432   4622             ; CMD8 e aguardar processamento do cartao
1433   4622             ; Destroi AF, BC
1434   4622             ; ------------------------------------------------
1435   4622             SD_SEND_CMD: 
1436   4622 CD 7A 46    	call	setaSDAtual
1437   4625 32 00 7B    	ld	(SPIDATA), a
1438   4628 F5          	push	af
1439   4629 78          	ld	a, b
1440   462A 32 00 7B    	ld	(SPIDATA), a
1441   462D 79          	ld	a, c
1442   462E 32 00 7B    	ld	(SPIDATA), a
1443   4631 7A          	ld	a, d
1444   4632 32 00 7B    	ld	(SPIDATA), a
1445   4635 7B          	ld	a, e
1446   4636 32 00 7B    	ld	(SPIDATA), a
1447   4639 F1          	pop	af
1448   463A FE 40       	cp	CMD0
1449   463C 06 95       	ld	b, $95		; CRC para CMD0
1450   463E 28 08       	jr	z,enviaCRC
1451   4640 FE 48       	cp	CMD8
1452   4642 06 87       	ld	b, $87		; CRC para CMD8
1453   4644 28 02       	jr	z,enviaCRC
1454   4646 06 FF       	ld	b, $FF		; CRC dummy
1455   4648             enviaCRC: 
1456   4648 78          	ld	a, b
1457   4649 32 00 7B    	ld	(SPIDATA), a
1458   464C 18 0E       	jr	WAIT_RESP_NO_FF
1459   464E             
1460   464E             ; ------------------------------------------------
1461   464E             ; Esperar que resposta do cartao seja $FE
1462   464E             ; Destroi AF, B
1463   464E             ; ------------------------------------------------
1464   464E             WAIT_RESP_FE: 
1465   464E 06 0A       	ld	b, 10		; 10 tentativas
1466   4650             .loop: 
1467   4650 C5          	push	bc
1468   4651 CD 5C 46    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1469   4654 C1          	pop	bc
1470   4655 FE FE       	cp	$FE		; resposta é $FE ?
1471   4657 C8          	ret	z		; sim, retornamos com carry=0
1472   4658 10 F6       	djnz	.loop
1473   465A 37          	scf			; erro, carry=1
1474   465B C9          	ret
1475   465C             
1476   465C             ; ------------------------------------------------
1477   465C             ; Esperar que resposta do cartao seja diferente
1478   465C             ; de $FF
1479   465C             ; Destroi AF, BC
1480   465C             ; ------------------------------------------------
1481   465C             WAIT_RESP_NO_FF: 
1482   465C 01 01 00    	ld	bc, 1		; 256 tentativas
1483   465F             .loop: 
1484   465F 3A 00 7B    	ld	a, (SPIDATA)
1485   4662 FE FF       	cp	$FF		; testa $FF
1486   4664 C0          	ret		nz		; sai se nao for $FF
1487   4665 10 F8       	djnz	.loop
1488   4667 0D          	dec	c
1489   4668 20 F5       	jr	nz,.loop
1490   466A C9          	ret
1491   466B             
1492   466B             ; ------------------------------------------------
1493   466B             ; Esperar que resposta do cartao seja diferente
1494   466B             ; de $00
1495   466B             ; Destroi A, BC
1496   466B             ; ------------------------------------------------
1497   466B             WAIT_RESP_NO_00: 
1498   466B 01 80 00    	ld	bc, 128		; 32768 tentativas
1499   466E             .loop: 
1500   466E 3A 00 7B    	ld	a, (SPIDATA)
1501   4671 B7          	or	a
1502   4672 C0          	ret	nz			; se resposta for <> $00, sai
1503   4673 10 F9       	djnz	.loop
1504   4675 0D          	dec	c
1505   4676 20 F6       	jr	nz,.loop
1506   4678 37          	scf			; erro
1507   4679 C9          	ret
1508   467A             
1509   467A             ; ------------------------------------------------
1510   467A             ; Ativa (seleciona) cartao atual
1511   467A             ; Nao destroi registradores
1512   467A             ; ------------------------------------------------
1513   467A             setaSDAtual: 
1514   467A F5          	push	af
1515   467B 3A 00 7B    	ld	a, (SPIDATA)	; dummy read
1516   467E FD 7E 30    	ld	a, (iy+NUMSD)
1517   4681 32 00 7F    	ld	(SPICTRL), a
1518   4684 F1          	pop	af
1519   4685 C9          	ret
1520   4686             
1521   4686             
1522   4686             ; ------------------------------------------------
1523   4686             ; Grava um bloco de 512 bytes no cartao
1524   4686             ; HL aponta para o inicio dos dados
1525   4686             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1526   4686             ; Destroi AF, BC, DE, HL
1527   4686             ; ------------------------------------------------
1528   4686             GravarBloco: 
1529   4686 DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1530   4689 B7          	or	a
1531   468A CC C0 57    	call	z,blocoParaByte		; se for SDV1 coverter blocos para bytes
1532   468D CD 7A 46    	call	setaSDAtual	; selecionar cartao atual
1533   4690 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer gravar 1 ou mais blocos
1534   4693 3D          	dec	a
1535   4694 CA 11 4B    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1536   4697             
1537   4697             ; multiplos blocos
1538   4697 C5          	push	bc
1539   4698 D5          	push	de
1540   4699 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1541   469B CD EF 45    	call	SD_SEND_CMD_NO_ARGS
1542   469E 3E 57       	ld	a, ACMD23
1543   46A0 01 00 00    	ld	bc, 0
1544   46A3 51          	ld	d, c
1545   46A4 FD 5E 32    	ld	e, (iy+NUMBLOCOS)	; parametro = total de blocos a gravar
1546   46A7 CD F4 45    	call	SD_SEND_CMD_GET_ERROR
1547   46AA D1          	pop	de
1548   46AB C1          	pop	bc
1549   46AC DA 48 4F    	jp	c,terminaLeituraEscritaBloco	; erro no ACMD23
1550   46AF 3E 59       	ld	a, CMD25	; comando CMD25 = write multiple blocks
1551   46B1 CD F4 45    	call	SD_SEND_CMD_GET_ERROR
1552   46B4 DA 48 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1553   46B7             .loop: 
1554   46B7 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados sao
1555   46B9 32 00 7B    	ld	(SPIDATA),a	; dados para gravacao
1556   46BC             	; Check for a Z80 or R800
1557   46BC EB          	ex	de,hl
1558   46BD             ;	or 	a		; Clear Cy
1559   46BD 3E 14       	ld	a,20
1560   46BF ED F9       	db	#ED,#F9		; mulub a,a
1561   46C1 EB          	ex	de,hl
1562   46C2 11 00 7B    	ld	de, SPIDATA
1563   46C5 DA 02 4B    	jp	c,.r800m	; Use LDIR for R800
1564   46C8 ED A0       > ldi		
1564   46CA ED A0       > ldi		
1564   46CC ED A0       > ldi		
1564   46CE ED A0       > ldi		
1564   46D0 ED A0       > ldi		
1564   46D2 ED A0       > ldi		
1564   46D4 ED A0       > ldi		
1564   46D6 ED A0       > ldi		
1564   46D8 ED A0       > ldi		
1564   46DA ED A0       > ldi		
1564   46DC ED A0       > ldi		
1564   46DE ED A0       > ldi		
1564   46E0 ED A0       > ldi		
1564   46E2 ED A0       > ldi		
1564   46E4 ED A0       > ldi		
1564   46E6 ED A0       > ldi		
1564   46E8 ED A0       > ldi		
1564   46EA ED A0       > ldi		
1564   46EC ED A0       > ldi		
1564   46EE ED A0       > ldi		
1564   46F0 ED A0       > ldi		
1564   46F2 ED A0       > ldi		
1564   46F4 ED A0       > ldi		
1564   46F6 ED A0       > ldi		
1564   46F8 ED A0       > ldi		
1564   46FA ED A0       > ldi		
1564   46FC ED A0       > ldi		
1564   46FE ED A0       > ldi		
1564   4700 ED A0       > ldi		
1564   4702 ED A0       > ldi		
1564   4704 ED A0       > ldi		
1564   4706 ED A0       > ldi		
1564   4708 ED A0       > ldi		
1564   470A ED A0       > ldi		
1564   470C ED A0       > ldi		
1564   470E ED A0       > ldi		
1564   4710 ED A0       > ldi		
1564   4712 ED A0       > ldi		
1564   4714 ED A0       > ldi		
1564   4716 ED A0       > ldi		
1564   4718 ED A0       > ldi		
1564   471A ED A0       > ldi		
1564   471C ED A0       > ldi		
1564   471E ED A0       > ldi		
1564   4720 ED A0       > ldi		
1564   4722 ED A0       > ldi		
1564   4724 ED A0       > ldi		
1564   4726 ED A0       > ldi		
1564   4728 ED A0       > ldi		
1564   472A ED A0       > ldi		
1564   472C ED A0       > ldi		
1564   472E ED A0       > ldi		
1564   4730 ED A0       > ldi		
1564   4732 ED A0       > ldi		
1564   4734 ED A0       > ldi		
1564   4736 ED A0       > ldi		
1564   4738 ED A0       > ldi		
1564   473A ED A0       > ldi		
1564   473C ED A0       > ldi		
1564   473E ED A0       > ldi		
1564   4740 ED A0       > ldi		
1564   4742 ED A0       > ldi		
1564   4744 ED A0       > ldi		
1564   4746 ED A0       > ldi		
1564   4748 ED A0       > ldi		
1564   474A ED A0       > ldi		
1564   474C ED A0       > ldi		
1564   474E ED A0       > ldi		
1564   4750 ED A0       > ldi		
1564   4752 ED A0       > ldi		
1564   4754 ED A0       > ldi		
1564   4756 ED A0       > ldi		
1564   4758 ED A0       > ldi		
1564   475A ED A0       > ldi		
1564   475C ED A0       > ldi		
1564   475E ED A0       > ldi		
1564   4760 ED A0       > ldi		
1564   4762 ED A0       > ldi		
1564   4764 ED A0       > ldi		
1564   4766 ED A0       > ldi		
1564   4768 ED A0       > ldi		
1564   476A ED A0       > ldi		
1564   476C ED A0       > ldi		
1564   476E ED A0       > ldi		
1564   4770 ED A0       > ldi		
1564   4772 ED A0       > ldi		
1564   4774 ED A0       > ldi		
1564   4776 ED A0       > ldi		
1564   4778 ED A0       > ldi		
1564   477A ED A0       > ldi		
1564   477C ED A0       > ldi		
1564   477E ED A0       > ldi		
1564   4780 ED A0       > ldi		
1564   4782 ED A0       > ldi		
1564   4784 ED A0       > ldi		
1564   4786 ED A0       > ldi		
1564   4788 ED A0       > ldi		
1564   478A ED A0       > ldi		
1564   478C ED A0       > ldi		
1564   478E ED A0       > ldi		
1564   4790 ED A0       > ldi		
1564   4792 ED A0       > ldi		
1564   4794 ED A0       > ldi		
1564   4796 ED A0       > ldi		
1564   4798 ED A0       > ldi		
1564   479A ED A0       > ldi		
1564   479C ED A0       > ldi		
1564   479E ED A0       > ldi		
1564   47A0 ED A0       > ldi		
1564   47A2 ED A0       > ldi		
1564   47A4 ED A0       > ldi		
1564   47A6 ED A0       > ldi		
1564   47A8 ED A0       > ldi		
1564   47AA ED A0       > ldi		
1564   47AC ED A0       > ldi		
1564   47AE ED A0       > ldi		
1564   47B0 ED A0       > ldi		
1564   47B2 ED A0       > ldi		
1564   47B4 ED A0       > ldi		
1564   47B6 ED A0       > ldi		
1564   47B8 ED A0       > ldi		
1564   47BA ED A0       > ldi		
1564   47BC ED A0       > ldi		
1564   47BE ED A0       > ldi		
1564   47C0 ED A0       > ldi		
1564   47C2 ED A0       > ldi		
1564   47C4 ED A0       > ldi		
1564   47C6 ED A0       > ldi		
1564   47C8 ED A0       > ldi		
1564   47CA ED A0       > ldi		
1564   47CC ED A0       > ldi		
1564   47CE ED A0       > ldi		
1564   47D0 ED A0       > ldi		
1564   47D2 ED A0       > ldi		
1564   47D4 ED A0       > ldi		
1564   47D6 ED A0       > ldi		
1564   47D8 ED A0       > ldi		
1564   47DA ED A0       > ldi		
1564   47DC ED A0       > ldi		
1564   47DE ED A0       > ldi		
1564   47E0 ED A0       > ldi		
1564   47E2 ED A0       > ldi		
1564   47E4 ED A0       > ldi		
1564   47E6 ED A0       > ldi		
1564   47E8 ED A0       > ldi		
1564   47EA ED A0       > ldi		
1564   47EC ED A0       > ldi		
1564   47EE ED A0       > ldi		
1564   47F0 ED A0       > ldi		
1564   47F2 ED A0       > ldi		
1564   47F4 ED A0       > ldi		
1564   47F6 ED A0       > ldi		
1564   47F8 ED A0       > ldi		
1564   47FA ED A0       > ldi		
1564   47FC ED A0       > ldi		
1564   47FE ED A0       > ldi		
1564   4800 ED A0       > ldi		
1564   4802 ED A0       > ldi		
1564   4804 ED A0       > ldi		
1564   4806 ED A0       > ldi		
1564   4808 ED A0       > ldi		
1564   480A ED A0       > ldi		
1564   480C ED A0       > ldi		
1564   480E ED A0       > ldi		
1564   4810 ED A0       > ldi		
1564   4812 ED A0       > ldi		
1564   4814 ED A0       > ldi		
1564   4816 ED A0       > ldi		
1564   4818 ED A0       > ldi		
1564   481A ED A0       > ldi		
1564   481C ED A0       > ldi		
1564   481E ED A0       > ldi		
1564   4820 ED A0       > ldi		
1564   4822 ED A0       > ldi		
1564   4824 ED A0       > ldi		
1564   4826 ED A0       > ldi		
1564   4828 ED A0       > ldi		
1564   482A ED A0       > ldi		
1564   482C ED A0       > ldi		
1564   482E ED A0       > ldi		
1564   4830 ED A0       > ldi		
1564   4832 ED A0       > ldi		
1564   4834 ED A0       > ldi		
1564   4836 ED A0       > ldi		
1564   4838 ED A0       > ldi		
1564   483A ED A0       > ldi		
1564   483C ED A0       > ldi		
1564   483E ED A0       > ldi		
1564   4840 ED A0       > ldi		
1564   4842 ED A0       > ldi		
1564   4844 ED A0       > ldi		
1564   4846 ED A0       > ldi		
1564   4848 ED A0       > ldi		
1564   484A ED A0       > ldi		
1564   484C ED A0       > ldi		
1564   484E ED A0       > ldi		
1564   4850 ED A0       > ldi		
1564   4852 ED A0       > ldi		
1564   4854 ED A0       > ldi		
1564   4856 ED A0       > ldi		
1564   4858 ED A0       > ldi		
1564   485A ED A0       > ldi		
1564   485C ED A0       > ldi		
1564   485E ED A0       > ldi		
1564   4860 ED A0       > ldi		
1564   4862 ED A0       > ldi		
1564   4864 ED A0       > ldi		
1564   4866 ED A0       > ldi		
1564   4868 ED A0       > ldi		
1564   486A ED A0       > ldi		
1564   486C ED A0       > ldi		
1564   486E ED A0       > ldi		
1564   4870 ED A0       > ldi		
1564   4872 ED A0       > ldi		
1564   4874 ED A0       > ldi		
1564   4876 ED A0       > ldi		
1564   4878 ED A0       > ldi		
1564   487A ED A0       > ldi		
1564   487C ED A0       > ldi		
1564   487E ED A0       > ldi		
1564   4880 ED A0       > ldi		
1564   4882 ED A0       > ldi		
1564   4884 ED A0       > ldi		
1564   4886 ED A0       > ldi		
1564   4888 ED A0       > ldi		
1564   488A ED A0       > ldi		
1564   488C ED A0       > ldi		
1564   488E ED A0       > ldi		
1564   4890 ED A0       > ldi		
1564   4892 ED A0       > ldi		
1564   4894 ED A0       > ldi		
1564   4896 ED A0       > ldi		
1564   4898 ED A0       > ldi		
1564   489A ED A0       > ldi		
1564   489C ED A0       > ldi		
1564   489E ED A0       > ldi		
1564   48A0 ED A0       > ldi		
1564   48A2 ED A0       > ldi		
1564   48A4 ED A0       > ldi		
1564   48A6 ED A0       > ldi		
1564   48A8 ED A0       > ldi		
1564   48AA ED A0       > ldi		
1564   48AC ED A0       > ldi		
1564   48AE ED A0       > ldi		
1564   48B0 ED A0       > ldi		
1564   48B2 ED A0       > ldi		
1564   48B4 ED A0       > ldi		
1564   48B6 ED A0       > ldi		
1564   48B8 ED A0       > ldi		
1564   48BA ED A0       > ldi		
1564   48BC ED A0       > ldi		
1564   48BE ED A0       > ldi		
1564   48C0 ED A0       > ldi		
1564   48C2 ED A0       > ldi		
1564   48C4 ED A0       > ldi		
1564   48C6 ED A0       > ldi		
1564   48C8 ED A0       > ldi		
1564   48CA ED A0       > ldi		
1564   48CC ED A0       > ldi		
1564   48CE ED A0       > ldi		
1564   48D0 ED A0       > ldi		
1564   48D2 ED A0       > ldi		
1564   48D4 ED A0       > ldi		
1564   48D6 ED A0       > ldi		
1564   48D8 ED A0       > ldi		
1564   48DA ED A0       > ldi		
1564   48DC ED A0       > ldi		
1564   48DE ED A0       > ldi		
1564   48E0 ED A0       > ldi		
1564   48E2 ED A0       > ldi		
1564   48E4 ED A0       > ldi		
1564   48E6 ED A0       > ldi		
1564   48E8 ED A0       > ldi		
1564   48EA ED A0       > ldi		
1564   48EC ED A0       > ldi		
1564   48EE ED A0       > ldi		
1564   48F0 ED A0       > ldi		
1564   48F2 ED A0       > ldi		
1564   48F4 ED A0       > ldi		
1564   48F6 ED A0       > ldi		
1564   48F8 ED A0       > ldi		
1564   48FA ED A0       > ldi		
1564   48FC ED A0       > ldi		
1564   48FE ED A0       > ldi		
1564   4900 ED A0       > ldi		
1564   4902 ED A0       > ldi		
1564   4904 ED A0       > ldi		
1564   4906 ED A0       > ldi		
1564   4908 ED A0       > ldi		
1564   490A ED A0       > ldi		
1564   490C ED A0       > ldi		
1564   490E ED A0       > ldi		
1564   4910 ED A0       > ldi		
1564   4912 ED A0       > ldi		
1564   4914 ED A0       > ldi		
1564   4916 ED A0       > ldi		
1564   4918 ED A0       > ldi		
1564   491A ED A0       > ldi		
1564   491C ED A0       > ldi		
1564   491E ED A0       > ldi		
1564   4920 ED A0       > ldi		
1564   4922 ED A0       > ldi		
1564   4924 ED A0       > ldi		
1564   4926 ED A0       > ldi		
1564   4928 ED A0       > ldi		
1564   492A ED A0       > ldi		
1564   492C ED A0       > ldi		
1564   492E ED A0       > ldi		
1564   4930 ED A0       > ldi		
1564   4932 ED A0       > ldi		
1564   4934 ED A0       > ldi		
1564   4936 ED A0       > ldi		
1564   4938 ED A0       > ldi		
1564   493A ED A0       > ldi		
1564   493C ED A0       > ldi		
1564   493E ED A0       > ldi		
1564   4940 ED A0       > ldi		
1564   4942 ED A0       > ldi		
1564   4944 ED A0       > ldi		
1564   4946 ED A0       > ldi		
1564   4948 ED A0       > ldi		
1564   494A ED A0       > ldi		
1564   494C ED A0       > ldi		
1564   494E ED A0       > ldi		
1564   4950 ED A0       > ldi		
1564   4952 ED A0       > ldi		
1564   4954 ED A0       > ldi		
1564   4956 ED A0       > ldi		
1564   4958 ED A0       > ldi		
1564   495A ED A0       > ldi		
1564   495C ED A0       > ldi		
1564   495E ED A0       > ldi		
1564   4960 ED A0       > ldi		
1564   4962 ED A0       > ldi		
1564   4964 ED A0       > ldi		
1564   4966 ED A0       > ldi		
1564   4968 ED A0       > ldi		
1564   496A ED A0       > ldi		
1564   496C ED A0       > ldi		
1564   496E ED A0       > ldi		
1564   4970 ED A0       > ldi		
1564   4972 ED A0       > ldi		
1564   4974 ED A0       > ldi		
1564   4976 ED A0       > ldi		
1564   4978 ED A0       > ldi		
1564   497A ED A0       > ldi		
1564   497C ED A0       > ldi		
1564   497E ED A0       > ldi		
1564   4980 ED A0       > ldi		
1564   4982 ED A0       > ldi		
1564   4984 ED A0       > ldi		
1564   4986 ED A0       > ldi		
1564   4988 ED A0       > ldi		
1564   498A ED A0       > ldi		
1564   498C ED A0       > ldi		
1564   498E ED A0       > ldi		
1564   4990 ED A0       > ldi		
1564   4992 ED A0       > ldi		
1564   4994 ED A0       > ldi		
1564   4996 ED A0       > ldi		
1564   4998 ED A0       > ldi		
1564   499A ED A0       > ldi		
1564   499C ED A0       > ldi		
1564   499E ED A0       > ldi		
1564   49A0 ED A0       > ldi		
1564   49A2 ED A0       > ldi		
1564   49A4 ED A0       > ldi		
1564   49A6 ED A0       > ldi		
1564   49A8 ED A0       > ldi		
1564   49AA ED A0       > ldi		
1564   49AC ED A0       > ldi		
1564   49AE ED A0       > ldi		
1564   49B0 ED A0       > ldi		
1564   49B2 ED A0       > ldi		
1564   49B4 ED A0       > ldi		
1564   49B6 ED A0       > ldi		
1564   49B8 ED A0       > ldi		
1564   49BA ED A0       > ldi		
1564   49BC ED A0       > ldi		
1564   49BE ED A0       > ldi		
1564   49C0 ED A0       > ldi		
1564   49C2 ED A0       > ldi		
1564   49C4 ED A0       > ldi		
1564   49C6 ED A0       > ldi		
1564   49C8 ED A0       > ldi		
1564   49CA ED A0       > ldi		
1564   49CC ED A0       > ldi		
1564   49CE ED A0       > ldi		
1564   49D0 ED A0       > ldi		
1564   49D2 ED A0       > ldi		
1564   49D4 ED A0       > ldi		
1564   49D6 ED A0       > ldi		
1564   49D8 ED A0       > ldi		
1564   49DA ED A0       > ldi		
1564   49DC ED A0       > ldi		
1564   49DE ED A0       > ldi		
1564   49E0 ED A0       > ldi		
1564   49E2 ED A0       > ldi		
1564   49E4 ED A0       > ldi		
1564   49E6 ED A0       > ldi		
1564   49E8 ED A0       > ldi		
1564   49EA ED A0       > ldi		
1564   49EC ED A0       > ldi		
1564   49EE ED A0       > ldi		
1564   49F0 ED A0       > ldi		
1564   49F2 ED A0       > ldi		
1564   49F4 ED A0       > ldi		
1564   49F6 ED A0       > ldi		
1564   49F8 ED A0       > ldi		
1564   49FA ED A0       > ldi		
1564   49FC ED A0       > ldi		
1564   49FE ED A0       > ldi		
1564   4A00 ED A0       > ldi		
1564   4A02 ED A0       > ldi		
1564   4A04 ED A0       > ldi		
1564   4A06 ED A0       > ldi		
1564   4A08 ED A0       > ldi		
1564   4A0A ED A0       > ldi		
1564   4A0C ED A0       > ldi		
1564   4A0E ED A0       > ldi		
1564   4A10 ED A0       > ldi		
1564   4A12 ED A0       > ldi		
1564   4A14 ED A0       > ldi		
1564   4A16 ED A0       > ldi		
1564   4A18 ED A0       > ldi		
1564   4A1A ED A0       > ldi		
1564   4A1C ED A0       > ldi		
1564   4A1E ED A0       > ldi		
1564   4A20 ED A0       > ldi		
1564   4A22 ED A0       > ldi		
1564   4A24 ED A0       > ldi		
1564   4A26 ED A0       > ldi		
1564   4A28 ED A0       > ldi		
1564   4A2A ED A0       > ldi		
1564   4A2C ED A0       > ldi		
1564   4A2E ED A0       > ldi		
1564   4A30 ED A0       > ldi		
1564   4A32 ED A0       > ldi		
1564   4A34 ED A0       > ldi		
1564   4A36 ED A0       > ldi		
1564   4A38 ED A0       > ldi		
1564   4A3A ED A0       > ldi		
1564   4A3C ED A0       > ldi		
1564   4A3E ED A0       > ldi		
1564   4A40 ED A0       > ldi		
1564   4A42 ED A0       > ldi		
1564   4A44 ED A0       > ldi		
1564   4A46 ED A0       > ldi		
1564   4A48 ED A0       > ldi		
1564   4A4A ED A0       > ldi		
1564   4A4C ED A0       > ldi		
1564   4A4E ED A0       > ldi		
1564   4A50 ED A0       > ldi		
1564   4A52 ED A0       > ldi		
1564   4A54 ED A0       > ldi		
1564   4A56 ED A0       > ldi		
1564   4A58 ED A0       > ldi		
1564   4A5A ED A0       > ldi		
1564   4A5C ED A0       > ldi		
1564   4A5E ED A0       > ldi		
1564   4A60 ED A0       > ldi		
1564   4A62 ED A0       > ldi		
1564   4A64 ED A0       > ldi		
1564   4A66 ED A0       > ldi		
1564   4A68 ED A0       > ldi		
1564   4A6A ED A0       > ldi		
1564   4A6C ED A0       > ldi		
1564   4A6E ED A0       > ldi		
1564   4A70 ED A0       > ldi		
1564   4A72 ED A0       > ldi		
1564   4A74 ED A0       > ldi		
1564   4A76 ED A0       > ldi		
1564   4A78 ED A0       > ldi		
1564   4A7A ED A0       > ldi		
1564   4A7C ED A0       > ldi		
1564   4A7E ED A0       > ldi		
1564   4A80 ED A0       > ldi		
1564   4A82 ED A0       > ldi		
1564   4A84 ED A0       > ldi		
1564   4A86 ED A0       > ldi		
1564   4A88 ED A0       > ldi		
1564   4A8A ED A0       > ldi		
1564   4A8C ED A0       > ldi		
1564   4A8E ED A0       > ldi		
1564   4A90 ED A0       > ldi		
1564   4A92 ED A0       > ldi		
1564   4A94 ED A0       > ldi		
1564   4A96 ED A0       > ldi		
1564   4A98 ED A0       > ldi		
1564   4A9A ED A0       > ldi		
1564   4A9C ED A0       > ldi		
1564   4A9E ED A0       > ldi		
1564   4AA0 ED A0       > ldi		
1564   4AA2 ED A0       > ldi		
1564   4AA4 ED A0       > ldi		
1564   4AA6 ED A0       > ldi		
1564   4AA8 ED A0       > ldi		
1564   4AAA ED A0       > ldi		
1564   4AAC ED A0       > ldi		
1564   4AAE ED A0       > ldi		
1564   4AB0 ED A0       > ldi		
1564   4AB2 ED A0       > ldi		
1564   4AB4 ED A0       > ldi		
1564   4AB6 ED A0       > ldi		
1564   4AB8 ED A0       > ldi		
1564   4ABA ED A0       > ldi		
1564   4ABC ED A0       > ldi		
1564   4ABE ED A0       > ldi		
1564   4AC0 ED A0       > ldi		
1564   4AC2 ED A0       > ldi		
1564   4AC4 ED A0       > ldi		
1564   4AC6 ED A0       > ldi		
1565   4AC8             .part2m: 
1566   4AC8 3E FF       	ld	a, $FF		; envia dummy CRC
1567   4ACA 32 00 7B    	ld	(SPIDATA),a
1568   4ACD 32 00 7B    	ld	(SPIDATA),a
1569   4AD0 CD 5C 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1570   4AD3 E6 1F       	and	$1F		; testa bits erro
1571   4AD5 FE 05       	cp	5
1572   4AD7 37          	scf
1573   4AD8 C2 48 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1574   4ADB CD 6B 46    	call	WAIT_RESP_NO_00	; esperar cartao
1575   4ADE DA 48 4F    	jp	c,terminaLeituraEscritaBloco
1576   4AE1 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para gravar
1577   4AE4 3D          	dec	a
1578   4AE5 FD 77 32    	ld	(iy+NUMBLOCOS), a
1579   4AE8 C2 B7 46    	jp	nz,.loop
1580   4AEB 3A 00 7B    	ld	a, (SPIDATA)	; acabou os blocos, fazer 2 dummy reads
1581   4AEE 3A 00 7B    	ld	a, (SPIDATA)
1582   4AF1 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1583   4AF3 32 00 7B    	ld	(SPIDATA),a
1584   4AF6 3A 00 7B    	ld	a, (SPIDATA)	; dummy reads
1585   4AF9 3A 00 7B    	ld	a, (SPIDATA)
1586   4AFC CD 6B 46    	call	WAIT_RESP_NO_00	; esperar cartao
1587   4AFF C3 47 4F    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1588   4B02             
1589   4B02 01 00 02    .r800m: 	ld	bc,512
1590   4B05 ED B0       	ldir
1591   4B07 18 BF       	jr	.part2m
1592   4B09             
1593   4B09 01 00 02    .r800s: 	ld	bc,512
1594   4B0C ED B0       	ldir
1595   4B0E C3 29 4F    	jp	.part2s
1596   4B11             
1597   4B11             .umBloco: 
1598   4B11 3E 58       	ld	a, CMD24	; gravar somente um bloco com comando CMD24 = Write Single Block
1599   4B13 CD F4 45    	call	SD_SEND_CMD_GET_ERROR
1600   4B16 DA 48 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1601   4B19             
1602   4B19 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1603   4B1B 32 00 7B    	ld	(SPIDATA),a
1604   4B1E             
1605   4B1E             	; Check for a Z80 or R800
1606   4B1E EB          	ex	de,hl
1607   4B1F             ;	or 	a		; Clear Cy
1608   4B1F 3E 14       	ld	a,20
1609   4B21 ED F9       	db	#ED,#F9		; mulub a,a
1610   4B23 EB          	ex	de,hl
1611   4B24 11 00 7B    	ld	de, SPIDATA
1612   4B27 38 E0       	jr	c,.r800s	; Use LDIR for R800
1613   4B29 ED A0       > ldi
1613   4B2B ED A0       > ldi
1613   4B2D ED A0       > ldi
1613   4B2F ED A0       > ldi
1613   4B31 ED A0       > ldi
1613   4B33 ED A0       > ldi
1613   4B35 ED A0       > ldi
1613   4B37 ED A0       > ldi
1613   4B39 ED A0       > ldi
1613   4B3B ED A0       > ldi
1613   4B3D ED A0       > ldi
1613   4B3F ED A0       > ldi
1613   4B41 ED A0       > ldi
1613   4B43 ED A0       > ldi
1613   4B45 ED A0       > ldi
1613   4B47 ED A0       > ldi
1613   4B49 ED A0       > ldi
1613   4B4B ED A0       > ldi
1613   4B4D ED A0       > ldi
1613   4B4F ED A0       > ldi
1613   4B51 ED A0       > ldi
1613   4B53 ED A0       > ldi
1613   4B55 ED A0       > ldi
1613   4B57 ED A0       > ldi
1613   4B59 ED A0       > ldi
1613   4B5B ED A0       > ldi
1613   4B5D ED A0       > ldi
1613   4B5F ED A0       > ldi
1613   4B61 ED A0       > ldi
1613   4B63 ED A0       > ldi
1613   4B65 ED A0       > ldi
1613   4B67 ED A0       > ldi
1613   4B69 ED A0       > ldi
1613   4B6B ED A0       > ldi
1613   4B6D ED A0       > ldi
1613   4B6F ED A0       > ldi
1613   4B71 ED A0       > ldi
1613   4B73 ED A0       > ldi
1613   4B75 ED A0       > ldi
1613   4B77 ED A0       > ldi
1613   4B79 ED A0       > ldi
1613   4B7B ED A0       > ldi
1613   4B7D ED A0       > ldi
1613   4B7F ED A0       > ldi
1613   4B81 ED A0       > ldi
1613   4B83 ED A0       > ldi
1613   4B85 ED A0       > ldi
1613   4B87 ED A0       > ldi
1613   4B89 ED A0       > ldi
1613   4B8B ED A0       > ldi
1613   4B8D ED A0       > ldi
1613   4B8F ED A0       > ldi
1613   4B91 ED A0       > ldi
1613   4B93 ED A0       > ldi
1613   4B95 ED A0       > ldi
1613   4B97 ED A0       > ldi
1613   4B99 ED A0       > ldi
1613   4B9B ED A0       > ldi
1613   4B9D ED A0       > ldi
1613   4B9F ED A0       > ldi
1613   4BA1 ED A0       > ldi
1613   4BA3 ED A0       > ldi
1613   4BA5 ED A0       > ldi
1613   4BA7 ED A0       > ldi
1613   4BA9 ED A0       > ldi
1613   4BAB ED A0       > ldi
1613   4BAD ED A0       > ldi
1613   4BAF ED A0       > ldi
1613   4BB1 ED A0       > ldi
1613   4BB3 ED A0       > ldi
1613   4BB5 ED A0       > ldi
1613   4BB7 ED A0       > ldi
1613   4BB9 ED A0       > ldi
1613   4BBB ED A0       > ldi
1613   4BBD ED A0       > ldi
1613   4BBF ED A0       > ldi
1613   4BC1 ED A0       > ldi
1613   4BC3 ED A0       > ldi
1613   4BC5 ED A0       > ldi
1613   4BC7 ED A0       > ldi
1613   4BC9 ED A0       > ldi
1613   4BCB ED A0       > ldi
1613   4BCD ED A0       > ldi
1613   4BCF ED A0       > ldi
1613   4BD1 ED A0       > ldi
1613   4BD3 ED A0       > ldi
1613   4BD5 ED A0       > ldi
1613   4BD7 ED A0       > ldi
1613   4BD9 ED A0       > ldi
1613   4BDB ED A0       > ldi
1613   4BDD ED A0       > ldi
1613   4BDF ED A0       > ldi
1613   4BE1 ED A0       > ldi
1613   4BE3 ED A0       > ldi
1613   4BE5 ED A0       > ldi
1613   4BE7 ED A0       > ldi
1613   4BE9 ED A0       > ldi
1613   4BEB ED A0       > ldi
1613   4BED ED A0       > ldi
1613   4BEF ED A0       > ldi
1613   4BF1 ED A0       > ldi
1613   4BF3 ED A0       > ldi
1613   4BF5 ED A0       > ldi
1613   4BF7 ED A0       > ldi
1613   4BF9 ED A0       > ldi
1613   4BFB ED A0       > ldi
1613   4BFD ED A0       > ldi
1613   4BFF ED A0       > ldi
1613   4C01 ED A0       > ldi
1613   4C03 ED A0       > ldi
1613   4C05 ED A0       > ldi
1613   4C07 ED A0       > ldi
1613   4C09 ED A0       > ldi
1613   4C0B ED A0       > ldi
1613   4C0D ED A0       > ldi
1613   4C0F ED A0       > ldi
1613   4C11 ED A0       > ldi
1613   4C13 ED A0       > ldi
1613   4C15 ED A0       > ldi
1613   4C17 ED A0       > ldi
1613   4C19 ED A0       > ldi
1613   4C1B ED A0       > ldi
1613   4C1D ED A0       > ldi
1613   4C1F ED A0       > ldi
1613   4C21 ED A0       > ldi
1613   4C23 ED A0       > ldi
1613   4C25 ED A0       > ldi
1613   4C27 ED A0       > ldi
1613   4C29 ED A0       > ldi
1613   4C2B ED A0       > ldi
1613   4C2D ED A0       > ldi
1613   4C2F ED A0       > ldi
1613   4C31 ED A0       > ldi
1613   4C33 ED A0       > ldi
1613   4C35 ED A0       > ldi
1613   4C37 ED A0       > ldi
1613   4C39 ED A0       > ldi
1613   4C3B ED A0       > ldi
1613   4C3D ED A0       > ldi
1613   4C3F ED A0       > ldi
1613   4C41 ED A0       > ldi
1613   4C43 ED A0       > ldi
1613   4C45 ED A0       > ldi
1613   4C47 ED A0       > ldi
1613   4C49 ED A0       > ldi
1613   4C4B ED A0       > ldi
1613   4C4D ED A0       > ldi
1613   4C4F ED A0       > ldi
1613   4C51 ED A0       > ldi
1613   4C53 ED A0       > ldi
1613   4C55 ED A0       > ldi
1613   4C57 ED A0       > ldi
1613   4C59 ED A0       > ldi
1613   4C5B ED A0       > ldi
1613   4C5D ED A0       > ldi
1613   4C5F ED A0       > ldi
1613   4C61 ED A0       > ldi
1613   4C63 ED A0       > ldi
1613   4C65 ED A0       > ldi
1613   4C67 ED A0       > ldi
1613   4C69 ED A0       > ldi
1613   4C6B ED A0       > ldi
1613   4C6D ED A0       > ldi
1613   4C6F ED A0       > ldi
1613   4C71 ED A0       > ldi
1613   4C73 ED A0       > ldi
1613   4C75 ED A0       > ldi
1613   4C77 ED A0       > ldi
1613   4C79 ED A0       > ldi
1613   4C7B ED A0       > ldi
1613   4C7D ED A0       > ldi
1613   4C7F ED A0       > ldi
1613   4C81 ED A0       > ldi
1613   4C83 ED A0       > ldi
1613   4C85 ED A0       > ldi
1613   4C87 ED A0       > ldi
1613   4C89 ED A0       > ldi
1613   4C8B ED A0       > ldi
1613   4C8D ED A0       > ldi
1613   4C8F ED A0       > ldi
1613   4C91 ED A0       > ldi
1613   4C93 ED A0       > ldi
1613   4C95 ED A0       > ldi
1613   4C97 ED A0       > ldi
1613   4C99 ED A0       > ldi
1613   4C9B ED A0       > ldi
1613   4C9D ED A0       > ldi
1613   4C9F ED A0       > ldi
1613   4CA1 ED A0       > ldi
1613   4CA3 ED A0       > ldi
1613   4CA5 ED A0       > ldi
1613   4CA7 ED A0       > ldi
1613   4CA9 ED A0       > ldi
1613   4CAB ED A0       > ldi
1613   4CAD ED A0       > ldi
1613   4CAF ED A0       > ldi
1613   4CB1 ED A0       > ldi
1613   4CB3 ED A0       > ldi
1613   4CB5 ED A0       > ldi
1613   4CB7 ED A0       > ldi
1613   4CB9 ED A0       > ldi
1613   4CBB ED A0       > ldi
1613   4CBD ED A0       > ldi
1613   4CBF ED A0       > ldi
1613   4CC1 ED A0       > ldi
1613   4CC3 ED A0       > ldi
1613   4CC5 ED A0       > ldi
1613   4CC7 ED A0       > ldi
1613   4CC9 ED A0       > ldi
1613   4CCB ED A0       > ldi
1613   4CCD ED A0       > ldi
1613   4CCF ED A0       > ldi
1613   4CD1 ED A0       > ldi
1613   4CD3 ED A0       > ldi
1613   4CD5 ED A0       > ldi
1613   4CD7 ED A0       > ldi
1613   4CD9 ED A0       > ldi
1613   4CDB ED A0       > ldi
1613   4CDD ED A0       > ldi
1613   4CDF ED A0       > ldi
1613   4CE1 ED A0       > ldi
1613   4CE3 ED A0       > ldi
1613   4CE5 ED A0       > ldi
1613   4CE7 ED A0       > ldi
1613   4CE9 ED A0       > ldi
1613   4CEB ED A0       > ldi
1613   4CED ED A0       > ldi
1613   4CEF ED A0       > ldi
1613   4CF1 ED A0       > ldi
1613   4CF3 ED A0       > ldi
1613   4CF5 ED A0       > ldi
1613   4CF7 ED A0       > ldi
1613   4CF9 ED A0       > ldi
1613   4CFB ED A0       > ldi
1613   4CFD ED A0       > ldi
1613   4CFF ED A0       > ldi
1613   4D01 ED A0       > ldi
1613   4D03 ED A0       > ldi
1613   4D05 ED A0       > ldi
1613   4D07 ED A0       > ldi
1613   4D09 ED A0       > ldi
1613   4D0B ED A0       > ldi
1613   4D0D ED A0       > ldi
1613   4D0F ED A0       > ldi
1613   4D11 ED A0       > ldi
1613   4D13 ED A0       > ldi
1613   4D15 ED A0       > ldi
1613   4D17 ED A0       > ldi
1613   4D19 ED A0       > ldi
1613   4D1B ED A0       > ldi
1613   4D1D ED A0       > ldi
1613   4D1F ED A0       > ldi
1613   4D21 ED A0       > ldi
1613   4D23 ED A0       > ldi
1613   4D25 ED A0       > ldi
1613   4D27 ED A0       > ldi
1613   4D29 ED A0       > ldi
1613   4D2B ED A0       > ldi
1613   4D2D ED A0       > ldi
1613   4D2F ED A0       > ldi
1613   4D31 ED A0       > ldi
1613   4D33 ED A0       > ldi
1613   4D35 ED A0       > ldi
1613   4D37 ED A0       > ldi
1613   4D39 ED A0       > ldi
1613   4D3B ED A0       > ldi
1613   4D3D ED A0       > ldi
1613   4D3F ED A0       > ldi
1613   4D41 ED A0       > ldi
1613   4D43 ED A0       > ldi
1613   4D45 ED A0       > ldi
1613   4D47 ED A0       > ldi
1613   4D49 ED A0       > ldi
1613   4D4B ED A0       > ldi
1613   4D4D ED A0       > ldi
1613   4D4F ED A0       > ldi
1613   4D51 ED A0       > ldi
1613   4D53 ED A0       > ldi
1613   4D55 ED A0       > ldi
1613   4D57 ED A0       > ldi
1613   4D59 ED A0       > ldi
1613   4D5B ED A0       > ldi
1613   4D5D ED A0       > ldi
1613   4D5F ED A0       > ldi
1613   4D61 ED A0       > ldi
1613   4D63 ED A0       > ldi
1613   4D65 ED A0       > ldi
1613   4D67 ED A0       > ldi
1613   4D69 ED A0       > ldi
1613   4D6B ED A0       > ldi
1613   4D6D ED A0       > ldi
1613   4D6F ED A0       > ldi
1613   4D71 ED A0       > ldi
1613   4D73 ED A0       > ldi
1613   4D75 ED A0       > ldi
1613   4D77 ED A0       > ldi
1613   4D79 ED A0       > ldi
1613   4D7B ED A0       > ldi
1613   4D7D ED A0       > ldi
1613   4D7F ED A0       > ldi
1613   4D81 ED A0       > ldi
1613   4D83 ED A0       > ldi
1613   4D85 ED A0       > ldi
1613   4D87 ED A0       > ldi
1613   4D89 ED A0       > ldi
1613   4D8B ED A0       > ldi
1613   4D8D ED A0       > ldi
1613   4D8F ED A0       > ldi
1613   4D91 ED A0       > ldi
1613   4D93 ED A0       > ldi
1613   4D95 ED A0       > ldi
1613   4D97 ED A0       > ldi
1613   4D99 ED A0       > ldi
1613   4D9B ED A0       > ldi
1613   4D9D ED A0       > ldi
1613   4D9F ED A0       > ldi
1613   4DA1 ED A0       > ldi
1613   4DA3 ED A0       > ldi
1613   4DA5 ED A0       > ldi
1613   4DA7 ED A0       > ldi
1613   4DA9 ED A0       > ldi
1613   4DAB ED A0       > ldi
1613   4DAD ED A0       > ldi
1613   4DAF ED A0       > ldi
1613   4DB1 ED A0       > ldi
1613   4DB3 ED A0       > ldi
1613   4DB5 ED A0       > ldi
1613   4DB7 ED A0       > ldi
1613   4DB9 ED A0       > ldi
1613   4DBB ED A0       > ldi
1613   4DBD ED A0       > ldi
1613   4DBF ED A0       > ldi
1613   4DC1 ED A0       > ldi
1613   4DC3 ED A0       > ldi
1613   4DC5 ED A0       > ldi
1613   4DC7 ED A0       > ldi
1613   4DC9 ED A0       > ldi
1613   4DCB ED A0       > ldi
1613   4DCD ED A0       > ldi
1613   4DCF ED A0       > ldi
1613   4DD1 ED A0       > ldi
1613   4DD3 ED A0       > ldi
1613   4DD5 ED A0       > ldi
1613   4DD7 ED A0       > ldi
1613   4DD9 ED A0       > ldi
1613   4DDB ED A0       > ldi
1613   4DDD ED A0       > ldi
1613   4DDF ED A0       > ldi
1613   4DE1 ED A0       > ldi
1613   4DE3 ED A0       > ldi
1613   4DE5 ED A0       > ldi
1613   4DE7 ED A0       > ldi
1613   4DE9 ED A0       > ldi
1613   4DEB ED A0       > ldi
1613   4DED ED A0       > ldi
1613   4DEF ED A0       > ldi
1613   4DF1 ED A0       > ldi
1613   4DF3 ED A0       > ldi
1613   4DF5 ED A0       > ldi
1613   4DF7 ED A0       > ldi
1613   4DF9 ED A0       > ldi
1613   4DFB ED A0       > ldi
1613   4DFD ED A0       > ldi
1613   4DFF ED A0       > ldi
1613   4E01 ED A0       > ldi
1613   4E03 ED A0       > ldi
1613   4E05 ED A0       > ldi
1613   4E07 ED A0       > ldi
1613   4E09 ED A0       > ldi
1613   4E0B ED A0       > ldi
1613   4E0D ED A0       > ldi
1613   4E0F ED A0       > ldi
1613   4E11 ED A0       > ldi
1613   4E13 ED A0       > ldi
1613   4E15 ED A0       > ldi
1613   4E17 ED A0       > ldi
1613   4E19 ED A0       > ldi
1613   4E1B ED A0       > ldi
1613   4E1D ED A0       > ldi
1613   4E1F ED A0       > ldi
1613   4E21 ED A0       > ldi
1613   4E23 ED A0       > ldi
1613   4E25 ED A0       > ldi
1613   4E27 ED A0       > ldi
1613   4E29 ED A0       > ldi
1613   4E2B ED A0       > ldi
1613   4E2D ED A0       > ldi
1613   4E2F ED A0       > ldi
1613   4E31 ED A0       > ldi
1613   4E33 ED A0       > ldi
1613   4E35 ED A0       > ldi
1613   4E37 ED A0       > ldi
1613   4E39 ED A0       > ldi
1613   4E3B ED A0       > ldi
1613   4E3D ED A0       > ldi
1613   4E3F ED A0       > ldi
1613   4E41 ED A0       > ldi
1613   4E43 ED A0       > ldi
1613   4E45 ED A0       > ldi
1613   4E47 ED A0       > ldi
1613   4E49 ED A0       > ldi
1613   4E4B ED A0       > ldi
1613   4E4D ED A0       > ldi
1613   4E4F ED A0       > ldi
1613   4E51 ED A0       > ldi
1613   4E53 ED A0       > ldi
1613   4E55 ED A0       > ldi
1613   4E57 ED A0       > ldi
1613   4E59 ED A0       > ldi
1613   4E5B ED A0       > ldi
1613   4E5D ED A0       > ldi
1613   4E5F ED A0       > ldi
1613   4E61 ED A0       > ldi
1613   4E63 ED A0       > ldi
1613   4E65 ED A0       > ldi
1613   4E67 ED A0       > ldi
1613   4E69 ED A0       > ldi
1613   4E6B ED A0       > ldi
1613   4E6D ED A0       > ldi
1613   4E6F ED A0       > ldi
1613   4E71 ED A0       > ldi
1613   4E73 ED A0       > ldi
1613   4E75 ED A0       > ldi
1613   4E77 ED A0       > ldi
1613   4E79 ED A0       > ldi
1613   4E7B ED A0       > ldi
1613   4E7D ED A0       > ldi
1613   4E7F ED A0       > ldi
1613   4E81 ED A0       > ldi
1613   4E83 ED A0       > ldi
1613   4E85 ED A0       > ldi
1613   4E87 ED A0       > ldi
1613   4E89 ED A0       > ldi
1613   4E8B ED A0       > ldi
1613   4E8D ED A0       > ldi
1613   4E8F ED A0       > ldi
1613   4E91 ED A0       > ldi
1613   4E93 ED A0       > ldi
1613   4E95 ED A0       > ldi
1613   4E97 ED A0       > ldi
1613   4E99 ED A0       > ldi
1613   4E9B ED A0       > ldi
1613   4E9D ED A0       > ldi
1613   4E9F ED A0       > ldi
1613   4EA1 ED A0       > ldi
1613   4EA3 ED A0       > ldi
1613   4EA5 ED A0       > ldi
1613   4EA7 ED A0       > ldi
1613   4EA9 ED A0       > ldi
1613   4EAB ED A0       > ldi
1613   4EAD ED A0       > ldi
1613   4EAF ED A0       > ldi
1613   4EB1 ED A0       > ldi
1613   4EB3 ED A0       > ldi
1613   4EB5 ED A0       > ldi
1613   4EB7 ED A0       > ldi
1613   4EB9 ED A0       > ldi
1613   4EBB ED A0       > ldi
1613   4EBD ED A0       > ldi
1613   4EBF ED A0       > ldi
1613   4EC1 ED A0       > ldi
1613   4EC3 ED A0       > ldi
1613   4EC5 ED A0       > ldi
1613   4EC7 ED A0       > ldi
1613   4EC9 ED A0       > ldi
1613   4ECB ED A0       > ldi
1613   4ECD ED A0       > ldi
1613   4ECF ED A0       > ldi
1613   4ED1 ED A0       > ldi
1613   4ED3 ED A0       > ldi
1613   4ED5 ED A0       > ldi
1613   4ED7 ED A0       > ldi
1613   4ED9 ED A0       > ldi
1613   4EDB ED A0       > ldi
1613   4EDD ED A0       > ldi
1613   4EDF ED A0       > ldi
1613   4EE1 ED A0       > ldi
1613   4EE3 ED A0       > ldi
1613   4EE5 ED A0       > ldi
1613   4EE7 ED A0       > ldi
1613   4EE9 ED A0       > ldi
1613   4EEB ED A0       > ldi
1613   4EED ED A0       > ldi
1613   4EEF ED A0       > ldi
1613   4EF1 ED A0       > ldi
1613   4EF3 ED A0       > ldi
1613   4EF5 ED A0       > ldi
1613   4EF7 ED A0       > ldi
1613   4EF9 ED A0       > ldi
1613   4EFB ED A0       > ldi
1613   4EFD ED A0       > ldi
1613   4EFF ED A0       > ldi
1613   4F01 ED A0       > ldi
1613   4F03 ED A0       > ldi
1613   4F05 ED A0       > ldi
1613   4F07 ED A0       > ldi
1613   4F09 ED A0       > ldi
1613   4F0B ED A0       > ldi
1613   4F0D ED A0       > ldi
1613   4F0F ED A0       > ldi
1613   4F11 ED A0       > ldi
1613   4F13 ED A0       > ldi
1613   4F15 ED A0       > ldi
1613   4F17 ED A0       > ldi
1613   4F19 ED A0       > ldi
1613   4F1B ED A0       > ldi
1613   4F1D ED A0       > ldi
1613   4F1F ED A0       > ldi
1613   4F21 ED A0       > ldi
1613   4F23 ED A0       > ldi
1613   4F25 ED A0       > ldi
1613   4F27 ED A0       > ldi
1614   4F29             .part2s: 
1615   4F29 01 00 02    	ld	bc,512
1616   4F2C ED B0       	ldir
1617   4F2E 3E FF       	ld	a, $FF		; envia dummy CRC
1618   4F30 32 00 7B    	ld	(SPIDATA),a
1619   4F33 32 00 7B    	ld	(SPIDATA),a
1620   4F36 CD 5C 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1621   4F39 E6 1F       	and	$1F		; testa bits erro
1622   4F3B FE 05       	cp	5
1623   4F3D 37          	scf
1624   4F3E C2 48 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1625   4F41             .esp: 
1626   4F41 CD 5C 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1627   4F44 B7          	or	a
1628   4F45 28 FA       	jr	z,.esp
1629   4F47             .fim: 
1630   4F47 AF          	xor	a		; zera carry e informa nenhum erro
1631   4F48             terminaLeituraEscritaBloco: 
1632   4F48 F5          	push	af
1633   4F49 CD D8 45    	call	disableSDs	; desabilitar todos os cartoes
1634   4F4C F1          	pop	af
1635   4F4D C9          	ret
1636   4F4E             
1637   4F4E             
1638   4F4E             ; ------------------------------------------------
1639   4F4E             ; Ler um bloco de 512 bytes do cartao
1640   4F4E             ; HL aponta para o inicio dos dados
1641   4F4E             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1642   4F4E             ; Destroi AF, BC, DE, HL
1643   4F4E             ; ------------------------------------------------
1644   4F4E             LerBloco: 
1645   4F4E DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1646   4F51 B7          	or	a
1647   4F52 CC C0 57    	call	z,blocoParaByte	; se for SDV1 coverter blocos para bytes
1648   4F55 CD 7A 46    	call	setaSDAtual
1649   4F58             
1650   4F58             
1651   4F58             
1652   4F58 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer ler um ou mais blocos
1653   4F5B 3D          	dec	a
1654   4F5C CA A0 53    	jp	z,.umBloco	; somente um bloco, pular
1655   4F5F             
1656   4F5F             ; multiplos blocos
1657   4F5F 3E 52       	ld	a, CMD18	; ler multiplos blocos com CMD18 = Read Multiple Blocks
1658   4F61 CD F4 45    	call	SD_SEND_CMD_GET_ERROR
1659   4F64 DA 48 4F    	jp	c,terminaLeituraEscritaBloco
1660   4F67             .loop: 
1661   4F67 CD 4E 46    	call	WAIT_RESP_FE
1662   4F6A DA 48 4F    	jp	c,terminaLeituraEscritaBloco
1663   4F6D EB          	ex	de,hl
1664   4F6E             	; Check for a Z80 or R800
1665   4F6E             ;	or 	a		; Clear Cy
1666   4F6E 3E 14       	ld	a,20
1667   4F70 ED F9       	db	#ED,#F9		; mulub a,a
1668   4F72 21 00 7B    	ld	hl, SPIDATA
1669   4F75 DA 91 53    	jp	c,.r800m	; Use LDIR for R800
1670   4F78 ED A0       > ldi
1670   4F7A ED A0       > ldi
1670   4F7C ED A0       > ldi
1670   4F7E ED A0       > ldi
1670   4F80 ED A0       > ldi
1670   4F82 ED A0       > ldi
1670   4F84 ED A0       > ldi
1670   4F86 ED A0       > ldi
1670   4F88 ED A0       > ldi
1670   4F8A ED A0       > ldi
1670   4F8C ED A0       > ldi
1670   4F8E ED A0       > ldi
1670   4F90 ED A0       > ldi
1670   4F92 ED A0       > ldi
1670   4F94 ED A0       > ldi
1670   4F96 ED A0       > ldi
1670   4F98 ED A0       > ldi
1670   4F9A ED A0       > ldi
1670   4F9C ED A0       > ldi
1670   4F9E ED A0       > ldi
1670   4FA0 ED A0       > ldi
1670   4FA2 ED A0       > ldi
1670   4FA4 ED A0       > ldi
1670   4FA6 ED A0       > ldi
1670   4FA8 ED A0       > ldi
1670   4FAA ED A0       > ldi
1670   4FAC ED A0       > ldi
1670   4FAE ED A0       > ldi
1670   4FB0 ED A0       > ldi
1670   4FB2 ED A0       > ldi
1670   4FB4 ED A0       > ldi
1670   4FB6 ED A0       > ldi
1670   4FB8 ED A0       > ldi
1670   4FBA ED A0       > ldi
1670   4FBC ED A0       > ldi
1670   4FBE ED A0       > ldi
1670   4FC0 ED A0       > ldi
1670   4FC2 ED A0       > ldi
1670   4FC4 ED A0       > ldi
1670   4FC6 ED A0       > ldi
1670   4FC8 ED A0       > ldi
1670   4FCA ED A0       > ldi
1670   4FCC ED A0       > ldi
1670   4FCE ED A0       > ldi
1670   4FD0 ED A0       > ldi
1670   4FD2 ED A0       > ldi
1670   4FD4 ED A0       > ldi
1670   4FD6 ED A0       > ldi
1670   4FD8 ED A0       > ldi
1670   4FDA ED A0       > ldi
1670   4FDC ED A0       > ldi
1670   4FDE ED A0       > ldi
1670   4FE0 ED A0       > ldi
1670   4FE2 ED A0       > ldi
1670   4FE4 ED A0       > ldi
1670   4FE6 ED A0       > ldi
1670   4FE8 ED A0       > ldi
1670   4FEA ED A0       > ldi
1670   4FEC ED A0       > ldi
1670   4FEE ED A0       > ldi
1670   4FF0 ED A0       > ldi
1670   4FF2 ED A0       > ldi
1670   4FF4 ED A0       > ldi
1670   4FF6 ED A0       > ldi
1670   4FF8 ED A0       > ldi
1670   4FFA ED A0       > ldi
1670   4FFC ED A0       > ldi
1670   4FFE ED A0       > ldi
1670   5000 ED A0       > ldi
1670   5002 ED A0       > ldi
1670   5004 ED A0       > ldi
1670   5006 ED A0       > ldi
1670   5008 ED A0       > ldi
1670   500A ED A0       > ldi
1670   500C ED A0       > ldi
1670   500E ED A0       > ldi
1670   5010 ED A0       > ldi
1670   5012 ED A0       > ldi
1670   5014 ED A0       > ldi
1670   5016 ED A0       > ldi
1670   5018 ED A0       > ldi
1670   501A ED A0       > ldi
1670   501C ED A0       > ldi
1670   501E ED A0       > ldi
1670   5020 ED A0       > ldi
1670   5022 ED A0       > ldi
1670   5024 ED A0       > ldi
1670   5026 ED A0       > ldi
1670   5028 ED A0       > ldi
1670   502A ED A0       > ldi
1670   502C ED A0       > ldi
1670   502E ED A0       > ldi
1670   5030 ED A0       > ldi
1670   5032 ED A0       > ldi
1670   5034 ED A0       > ldi
1670   5036 ED A0       > ldi
1670   5038 ED A0       > ldi
1670   503A ED A0       > ldi
1670   503C ED A0       > ldi
1670   503E ED A0       > ldi
1670   5040 ED A0       > ldi
1670   5042 ED A0       > ldi
1670   5044 ED A0       > ldi
1670   5046 ED A0       > ldi
1670   5048 ED A0       > ldi
1670   504A ED A0       > ldi
1670   504C ED A0       > ldi
1670   504E ED A0       > ldi
1670   5050 ED A0       > ldi
1670   5052 ED A0       > ldi
1670   5054 ED A0       > ldi
1670   5056 ED A0       > ldi
1670   5058 ED A0       > ldi
1670   505A ED A0       > ldi
1670   505C ED A0       > ldi
1670   505E ED A0       > ldi
1670   5060 ED A0       > ldi
1670   5062 ED A0       > ldi
1670   5064 ED A0       > ldi
1670   5066 ED A0       > ldi
1670   5068 ED A0       > ldi
1670   506A ED A0       > ldi
1670   506C ED A0       > ldi
1670   506E ED A0       > ldi
1670   5070 ED A0       > ldi
1670   5072 ED A0       > ldi
1670   5074 ED A0       > ldi
1670   5076 ED A0       > ldi
1670   5078 ED A0       > ldi
1670   507A ED A0       > ldi
1670   507C ED A0       > ldi
1670   507E ED A0       > ldi
1670   5080 ED A0       > ldi
1670   5082 ED A0       > ldi
1670   5084 ED A0       > ldi
1670   5086 ED A0       > ldi
1670   5088 ED A0       > ldi
1670   508A ED A0       > ldi
1670   508C ED A0       > ldi
1670   508E ED A0       > ldi
1670   5090 ED A0       > ldi
1670   5092 ED A0       > ldi
1670   5094 ED A0       > ldi
1670   5096 ED A0       > ldi
1670   5098 ED A0       > ldi
1670   509A ED A0       > ldi
1670   509C ED A0       > ldi
1670   509E ED A0       > ldi
1670   50A0 ED A0       > ldi
1670   50A2 ED A0       > ldi
1670   50A4 ED A0       > ldi
1670   50A6 ED A0       > ldi
1670   50A8 ED A0       > ldi
1670   50AA ED A0       > ldi
1670   50AC ED A0       > ldi
1670   50AE ED A0       > ldi
1670   50B0 ED A0       > ldi
1670   50B2 ED A0       > ldi
1670   50B4 ED A0       > ldi
1670   50B6 ED A0       > ldi
1670   50B8 ED A0       > ldi
1670   50BA ED A0       > ldi
1670   50BC ED A0       > ldi
1670   50BE ED A0       > ldi
1670   50C0 ED A0       > ldi
1670   50C2 ED A0       > ldi
1670   50C4 ED A0       > ldi
1670   50C6 ED A0       > ldi
1670   50C8 ED A0       > ldi
1670   50CA ED A0       > ldi
1670   50CC ED A0       > ldi
1670   50CE ED A0       > ldi
1670   50D0 ED A0       > ldi
1670   50D2 ED A0       > ldi
1670   50D4 ED A0       > ldi
1670   50D6 ED A0       > ldi
1670   50D8 ED A0       > ldi
1670   50DA ED A0       > ldi
1670   50DC ED A0       > ldi
1670   50DE ED A0       > ldi
1670   50E0 ED A0       > ldi
1670   50E2 ED A0       > ldi
1670   50E4 ED A0       > ldi
1670   50E6 ED A0       > ldi
1670   50E8 ED A0       > ldi
1670   50EA ED A0       > ldi
1670   50EC ED A0       > ldi
1670   50EE ED A0       > ldi
1670   50F0 ED A0       > ldi
1670   50F2 ED A0       > ldi
1670   50F4 ED A0       > ldi
1670   50F6 ED A0       > ldi
1670   50F8 ED A0       > ldi
1670   50FA ED A0       > ldi
1670   50FC ED A0       > ldi
1670   50FE ED A0       > ldi
1670   5100 ED A0       > ldi
1670   5102 ED A0       > ldi
1670   5104 ED A0       > ldi
1670   5106 ED A0       > ldi
1670   5108 ED A0       > ldi
1670   510A ED A0       > ldi
1670   510C ED A0       > ldi
1670   510E ED A0       > ldi
1670   5110 ED A0       > ldi
1670   5112 ED A0       > ldi
1670   5114 ED A0       > ldi
1670   5116 ED A0       > ldi
1670   5118 ED A0       > ldi
1670   511A ED A0       > ldi
1670   511C ED A0       > ldi
1670   511E ED A0       > ldi
1670   5120 ED A0       > ldi
1670   5122 ED A0       > ldi
1670   5124 ED A0       > ldi
1670   5126 ED A0       > ldi
1670   5128 ED A0       > ldi
1670   512A ED A0       > ldi
1670   512C ED A0       > ldi
1670   512E ED A0       > ldi
1670   5130 ED A0       > ldi
1670   5132 ED A0       > ldi
1670   5134 ED A0       > ldi
1670   5136 ED A0       > ldi
1670   5138 ED A0       > ldi
1670   513A ED A0       > ldi
1670   513C ED A0       > ldi
1670   513E ED A0       > ldi
1670   5140 ED A0       > ldi
1670   5142 ED A0       > ldi
1670   5144 ED A0       > ldi
1670   5146 ED A0       > ldi
1670   5148 ED A0       > ldi
1670   514A ED A0       > ldi
1670   514C ED A0       > ldi
1670   514E ED A0       > ldi
1670   5150 ED A0       > ldi
1670   5152 ED A0       > ldi
1670   5154 ED A0       > ldi
1670   5156 ED A0       > ldi
1670   5158 ED A0       > ldi
1670   515A ED A0       > ldi
1670   515C ED A0       > ldi
1670   515E ED A0       > ldi
1670   5160 ED A0       > ldi
1670   5162 ED A0       > ldi
1670   5164 ED A0       > ldi
1670   5166 ED A0       > ldi
1670   5168 ED A0       > ldi
1670   516A ED A0       > ldi
1670   516C ED A0       > ldi
1670   516E ED A0       > ldi
1670   5170 ED A0       > ldi
1670   5172 ED A0       > ldi
1670   5174 ED A0       > ldi
1670   5176 ED A0       > ldi
1670   5178 ED A0       > ldi
1670   517A ED A0       > ldi
1670   517C ED A0       > ldi
1670   517E ED A0       > ldi
1670   5180 ED A0       > ldi
1670   5182 ED A0       > ldi
1670   5184 ED A0       > ldi
1670   5186 ED A0       > ldi
1670   5188 ED A0       > ldi
1670   518A ED A0       > ldi
1670   518C ED A0       > ldi
1670   518E ED A0       > ldi
1670   5190 ED A0       > ldi
1670   5192 ED A0       > ldi
1670   5194 ED A0       > ldi
1670   5196 ED A0       > ldi
1670   5198 ED A0       > ldi
1670   519A ED A0       > ldi
1670   519C ED A0       > ldi
1670   519E ED A0       > ldi
1670   51A0 ED A0       > ldi
1670   51A2 ED A0       > ldi
1670   51A4 ED A0       > ldi
1670   51A6 ED A0       > ldi
1670   51A8 ED A0       > ldi
1670   51AA ED A0       > ldi
1670   51AC ED A0       > ldi
1670   51AE ED A0       > ldi
1670   51B0 ED A0       > ldi
1670   51B2 ED A0       > ldi
1670   51B4 ED A0       > ldi
1670   51B6 ED A0       > ldi
1670   51B8 ED A0       > ldi
1670   51BA ED A0       > ldi
1670   51BC ED A0       > ldi
1670   51BE ED A0       > ldi
1670   51C0 ED A0       > ldi
1670   51C2 ED A0       > ldi
1670   51C4 ED A0       > ldi
1670   51C6 ED A0       > ldi
1670   51C8 ED A0       > ldi
1670   51CA ED A0       > ldi
1670   51CC ED A0       > ldi
1670   51CE ED A0       > ldi
1670   51D0 ED A0       > ldi
1670   51D2 ED A0       > ldi
1670   51D4 ED A0       > ldi
1670   51D6 ED A0       > ldi
1670   51D8 ED A0       > ldi
1670   51DA ED A0       > ldi
1670   51DC ED A0       > ldi
1670   51DE ED A0       > ldi
1670   51E0 ED A0       > ldi
1670   51E2 ED A0       > ldi
1670   51E4 ED A0       > ldi
1670   51E6 ED A0       > ldi
1670   51E8 ED A0       > ldi
1670   51EA ED A0       > ldi
1670   51EC ED A0       > ldi
1670   51EE ED A0       > ldi
1670   51F0 ED A0       > ldi
1670   51F2 ED A0       > ldi
1670   51F4 ED A0       > ldi
1670   51F6 ED A0       > ldi
1670   51F8 ED A0       > ldi
1670   51FA ED A0       > ldi
1670   51FC ED A0       > ldi
1670   51FE ED A0       > ldi
1670   5200 ED A0       > ldi
1670   5202 ED A0       > ldi
1670   5204 ED A0       > ldi
1670   5206 ED A0       > ldi
1670   5208 ED A0       > ldi
1670   520A ED A0       > ldi
1670   520C ED A0       > ldi
1670   520E ED A0       > ldi
1670   5210 ED A0       > ldi
1670   5212 ED A0       > ldi
1670   5214 ED A0       > ldi
1670   5216 ED A0       > ldi
1670   5218 ED A0       > ldi
1670   521A ED A0       > ldi
1670   521C ED A0       > ldi
1670   521E ED A0       > ldi
1670   5220 ED A0       > ldi
1670   5222 ED A0       > ldi
1670   5224 ED A0       > ldi
1670   5226 ED A0       > ldi
1670   5228 ED A0       > ldi
1670   522A ED A0       > ldi
1670   522C ED A0       > ldi
1670   522E ED A0       > ldi
1670   5230 ED A0       > ldi
1670   5232 ED A0       > ldi
1670   5234 ED A0       > ldi
1670   5236 ED A0       > ldi
1670   5238 ED A0       > ldi
1670   523A ED A0       > ldi
1670   523C ED A0       > ldi
1670   523E ED A0       > ldi
1670   5240 ED A0       > ldi
1670   5242 ED A0       > ldi
1670   5244 ED A0       > ldi
1670   5246 ED A0       > ldi
1670   5248 ED A0       > ldi
1670   524A ED A0       > ldi
1670   524C ED A0       > ldi
1670   524E ED A0       > ldi
1670   5250 ED A0       > ldi
1670   5252 ED A0       > ldi
1670   5254 ED A0       > ldi
1670   5256 ED A0       > ldi
1670   5258 ED A0       > ldi
1670   525A ED A0       > ldi
1670   525C ED A0       > ldi
1670   525E ED A0       > ldi
1670   5260 ED A0       > ldi
1670   5262 ED A0       > ldi
1670   5264 ED A0       > ldi
1670   5266 ED A0       > ldi
1670   5268 ED A0       > ldi
1670   526A ED A0       > ldi
1670   526C ED A0       > ldi
1670   526E ED A0       > ldi
1670   5270 ED A0       > ldi
1670   5272 ED A0       > ldi
1670   5274 ED A0       > ldi
1670   5276 ED A0       > ldi
1670   5278 ED A0       > ldi
1670   527A ED A0       > ldi
1670   527C ED A0       > ldi
1670   527E ED A0       > ldi
1670   5280 ED A0       > ldi
1670   5282 ED A0       > ldi
1670   5284 ED A0       > ldi
1670   5286 ED A0       > ldi
1670   5288 ED A0       > ldi
1670   528A ED A0       > ldi
1670   528C ED A0       > ldi
1670   528E ED A0       > ldi
1670   5290 ED A0       > ldi
1670   5292 ED A0       > ldi
1670   5294 ED A0       > ldi
1670   5296 ED A0       > ldi
1670   5298 ED A0       > ldi
1670   529A ED A0       > ldi
1670   529C ED A0       > ldi
1670   529E ED A0       > ldi
1670   52A0 ED A0       > ldi
1670   52A2 ED A0       > ldi
1670   52A4 ED A0       > ldi
1670   52A6 ED A0       > ldi
1670   52A8 ED A0       > ldi
1670   52AA ED A0       > ldi
1670   52AC ED A0       > ldi
1670   52AE ED A0       > ldi
1670   52B0 ED A0       > ldi
1670   52B2 ED A0       > ldi
1670   52B4 ED A0       > ldi
1670   52B6 ED A0       > ldi
1670   52B8 ED A0       > ldi
1670   52BA ED A0       > ldi
1670   52BC ED A0       > ldi
1670   52BE ED A0       > ldi
1670   52C0 ED A0       > ldi
1670   52C2 ED A0       > ldi
1670   52C4 ED A0       > ldi
1670   52C6 ED A0       > ldi
1670   52C8 ED A0       > ldi
1670   52CA ED A0       > ldi
1670   52CC ED A0       > ldi
1670   52CE ED A0       > ldi
1670   52D0 ED A0       > ldi
1670   52D2 ED A0       > ldi
1670   52D4 ED A0       > ldi
1670   52D6 ED A0       > ldi
1670   52D8 ED A0       > ldi
1670   52DA ED A0       > ldi
1670   52DC ED A0       > ldi
1670   52DE ED A0       > ldi
1670   52E0 ED A0       > ldi
1670   52E2 ED A0       > ldi
1670   52E4 ED A0       > ldi
1670   52E6 ED A0       > ldi
1670   52E8 ED A0       > ldi
1670   52EA ED A0       > ldi
1670   52EC ED A0       > ldi
1670   52EE ED A0       > ldi
1670   52F0 ED A0       > ldi
1670   52F2 ED A0       > ldi
1670   52F4 ED A0       > ldi
1670   52F6 ED A0       > ldi
1670   52F8 ED A0       > ldi
1670   52FA ED A0       > ldi
1670   52FC ED A0       > ldi
1670   52FE ED A0       > ldi
1670   5300 ED A0       > ldi
1670   5302 ED A0       > ldi
1670   5304 ED A0       > ldi
1670   5306 ED A0       > ldi
1670   5308 ED A0       > ldi
1670   530A ED A0       > ldi
1670   530C ED A0       > ldi
1670   530E ED A0       > ldi
1670   5310 ED A0       > ldi
1670   5312 ED A0       > ldi
1670   5314 ED A0       > ldi
1670   5316 ED A0       > ldi
1670   5318 ED A0       > ldi
1670   531A ED A0       > ldi
1670   531C ED A0       > ldi
1670   531E ED A0       > ldi
1670   5320 ED A0       > ldi
1670   5322 ED A0       > ldi
1670   5324 ED A0       > ldi
1670   5326 ED A0       > ldi
1670   5328 ED A0       > ldi
1670   532A ED A0       > ldi
1670   532C ED A0       > ldi
1670   532E ED A0       > ldi
1670   5330 ED A0       > ldi
1670   5332 ED A0       > ldi
1670   5334 ED A0       > ldi
1670   5336 ED A0       > ldi
1670   5338 ED A0       > ldi
1670   533A ED A0       > ldi
1670   533C ED A0       > ldi
1670   533E ED A0       > ldi
1670   5340 ED A0       > ldi
1670   5342 ED A0       > ldi
1670   5344 ED A0       > ldi
1670   5346 ED A0       > ldi
1670   5348 ED A0       > ldi
1670   534A ED A0       > ldi
1670   534C ED A0       > ldi
1670   534E ED A0       > ldi
1670   5350 ED A0       > ldi
1670   5352 ED A0       > ldi
1670   5354 ED A0       > ldi
1670   5356 ED A0       > ldi
1670   5358 ED A0       > ldi
1670   535A ED A0       > ldi
1670   535C ED A0       > ldi
1670   535E ED A0       > ldi
1670   5360 ED A0       > ldi
1670   5362 ED A0       > ldi
1670   5364 ED A0       > ldi
1670   5366 ED A0       > ldi
1670   5368 ED A0       > ldi
1670   536A ED A0       > ldi
1670   536C ED A0       > ldi
1670   536E ED A0       > ldi
1670   5370 ED A0       > ldi
1670   5372 ED A0       > ldi
1670   5374 ED A0       > ldi
1670   5376 ED A0       > ldi
1671   5378             .part2m: 
1672   5378 EB          	ex	de,hl
1673   5379 3A 00 7B    	ld	a, (SPIDATA)	; descarta CRC
1674   537C 3A 00 7B    	ld	a, (SPIDATA)
1675   537F FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para ler
1676   5382 3D          	dec	a
1677   5383 FD 77 32    	ld	(iy+NUMBLOCOS), a
1678   5386 C2 67 4F    	jp	nz,.loop
1679   5389 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1680   538B CD EF 45    	call	SD_SEND_CMD_NO_ARGS
1681   538E C3 BC 57    	jp	.fim
1682   5391             
1683   5391 01 00 02    .r800m:  ld	bc,512
1684   5394 ED B0       	ldir
1685   5396 18 E0       	jr	.part2m
1686   5398             
1687   5398 01 00 02    .r800s: 	ld	bc,512
1688   539B ED B0       	ldir
1689   539D C3 B8 57    	jp	.part2s
1690   53A0             
1691   53A0             .umBloco: 
1692   53A0 3E 51       	ld	a, CMD17	; ler somente um bloco com CMD17 = Read Single Block
1693   53A2 CD F4 45    	call	SD_SEND_CMD_GET_ERROR
1694   53A5 DA 48 4F    	jp	c,terminaLeituraEscritaBloco
1695   53A8             
1696   53A8 CD 4E 46    	call	WAIT_RESP_FE
1697   53AB DA 48 4F    	jp	c,terminaLeituraEscritaBloco
1698   53AE EB          	ex	de,hl
1699   53AF             
1700   53AF             	; Check for a Z80 or R800
1701   53AF             ;	or 	a		; Clear Cy
1702   53AF 3E 14       	ld	a,20
1703   53B1 ED F9       	db	#ED,#F9		; mulub a,a
1704   53B3 21 00 7B    	ld	hl, SPIDATA
1705   53B6 38 E0       	jr	c,.r800s	; Use LDIR for R800
1706   53B8 ED A0       > ldi
1706   53BA ED A0       > ldi
1706   53BC ED A0       > ldi
1706   53BE ED A0       > ldi
1706   53C0 ED A0       > ldi
1706   53C2 ED A0       > ldi
1706   53C4 ED A0       > ldi
1706   53C6 ED A0       > ldi
1706   53C8 ED A0       > ldi
1706   53CA ED A0       > ldi
1706   53CC ED A0       > ldi
1706   53CE ED A0       > ldi
1706   53D0 ED A0       > ldi
1706   53D2 ED A0       > ldi
1706   53D4 ED A0       > ldi
1706   53D6 ED A0       > ldi
1706   53D8 ED A0       > ldi
1706   53DA ED A0       > ldi
1706   53DC ED A0       > ldi
1706   53DE ED A0       > ldi
1706   53E0 ED A0       > ldi
1706   53E2 ED A0       > ldi
1706   53E4 ED A0       > ldi
1706   53E6 ED A0       > ldi
1706   53E8 ED A0       > ldi
1706   53EA ED A0       > ldi
1706   53EC ED A0       > ldi
1706   53EE ED A0       > ldi
1706   53F0 ED A0       > ldi
1706   53F2 ED A0       > ldi
1706   53F4 ED A0       > ldi
1706   53F6 ED A0       > ldi
1706   53F8 ED A0       > ldi
1706   53FA ED A0       > ldi
1706   53FC ED A0       > ldi
1706   53FE ED A0       > ldi
1706   5400 ED A0       > ldi
1706   5402 ED A0       > ldi
1706   5404 ED A0       > ldi
1706   5406 ED A0       > ldi
1706   5408 ED A0       > ldi
1706   540A ED A0       > ldi
1706   540C ED A0       > ldi
1706   540E ED A0       > ldi
1706   5410 ED A0       > ldi
1706   5412 ED A0       > ldi
1706   5414 ED A0       > ldi
1706   5416 ED A0       > ldi
1706   5418 ED A0       > ldi
1706   541A ED A0       > ldi
1706   541C ED A0       > ldi
1706   541E ED A0       > ldi
1706   5420 ED A0       > ldi
1706   5422 ED A0       > ldi
1706   5424 ED A0       > ldi
1706   5426 ED A0       > ldi
1706   5428 ED A0       > ldi
1706   542A ED A0       > ldi
1706   542C ED A0       > ldi
1706   542E ED A0       > ldi
1706   5430 ED A0       > ldi
1706   5432 ED A0       > ldi
1706   5434 ED A0       > ldi
1706   5436 ED A0       > ldi
1706   5438 ED A0       > ldi
1706   543A ED A0       > ldi
1706   543C ED A0       > ldi
1706   543E ED A0       > ldi
1706   5440 ED A0       > ldi
1706   5442 ED A0       > ldi
1706   5444 ED A0       > ldi
1706   5446 ED A0       > ldi
1706   5448 ED A0       > ldi
1706   544A ED A0       > ldi
1706   544C ED A0       > ldi
1706   544E ED A0       > ldi
1706   5450 ED A0       > ldi
1706   5452 ED A0       > ldi
1706   5454 ED A0       > ldi
1706   5456 ED A0       > ldi
1706   5458 ED A0       > ldi
1706   545A ED A0       > ldi
1706   545C ED A0       > ldi
1706   545E ED A0       > ldi
1706   5460 ED A0       > ldi
1706   5462 ED A0       > ldi
1706   5464 ED A0       > ldi
1706   5466 ED A0       > ldi
1706   5468 ED A0       > ldi
1706   546A ED A0       > ldi
1706   546C ED A0       > ldi
1706   546E ED A0       > ldi
1706   5470 ED A0       > ldi
1706   5472 ED A0       > ldi
1706   5474 ED A0       > ldi
1706   5476 ED A0       > ldi
1706   5478 ED A0       > ldi
1706   547A ED A0       > ldi
1706   547C ED A0       > ldi
1706   547E ED A0       > ldi
1706   5480 ED A0       > ldi
1706   5482 ED A0       > ldi
1706   5484 ED A0       > ldi
1706   5486 ED A0       > ldi
1706   5488 ED A0       > ldi
1706   548A ED A0       > ldi
1706   548C ED A0       > ldi
1706   548E ED A0       > ldi
1706   5490 ED A0       > ldi
1706   5492 ED A0       > ldi
1706   5494 ED A0       > ldi
1706   5496 ED A0       > ldi
1706   5498 ED A0       > ldi
1706   549A ED A0       > ldi
1706   549C ED A0       > ldi
1706   549E ED A0       > ldi
1706   54A0 ED A0       > ldi
1706   54A2 ED A0       > ldi
1706   54A4 ED A0       > ldi
1706   54A6 ED A0       > ldi
1706   54A8 ED A0       > ldi
1706   54AA ED A0       > ldi
1706   54AC ED A0       > ldi
1706   54AE ED A0       > ldi
1706   54B0 ED A0       > ldi
1706   54B2 ED A0       > ldi
1706   54B4 ED A0       > ldi
1706   54B6 ED A0       > ldi
1706   54B8 ED A0       > ldi
1706   54BA ED A0       > ldi
1706   54BC ED A0       > ldi
1706   54BE ED A0       > ldi
1706   54C0 ED A0       > ldi
1706   54C2 ED A0       > ldi
1706   54C4 ED A0       > ldi
1706   54C6 ED A0       > ldi
1706   54C8 ED A0       > ldi
1706   54CA ED A0       > ldi
1706   54CC ED A0       > ldi
1706   54CE ED A0       > ldi
1706   54D0 ED A0       > ldi
1706   54D2 ED A0       > ldi
1706   54D4 ED A0       > ldi
1706   54D6 ED A0       > ldi
1706   54D8 ED A0       > ldi
1706   54DA ED A0       > ldi
1706   54DC ED A0       > ldi
1706   54DE ED A0       > ldi
1706   54E0 ED A0       > ldi
1706   54E2 ED A0       > ldi
1706   54E4 ED A0       > ldi
1706   54E6 ED A0       > ldi
1706   54E8 ED A0       > ldi
1706   54EA ED A0       > ldi
1706   54EC ED A0       > ldi
1706   54EE ED A0       > ldi
1706   54F0 ED A0       > ldi
1706   54F2 ED A0       > ldi
1706   54F4 ED A0       > ldi
1706   54F6 ED A0       > ldi
1706   54F8 ED A0       > ldi
1706   54FA ED A0       > ldi
1706   54FC ED A0       > ldi
1706   54FE ED A0       > ldi
1706   5500 ED A0       > ldi
1706   5502 ED A0       > ldi
1706   5504 ED A0       > ldi
1706   5506 ED A0       > ldi
1706   5508 ED A0       > ldi
1706   550A ED A0       > ldi
1706   550C ED A0       > ldi
1706   550E ED A0       > ldi
1706   5510 ED A0       > ldi
1706   5512 ED A0       > ldi
1706   5514 ED A0       > ldi
1706   5516 ED A0       > ldi
1706   5518 ED A0       > ldi
1706   551A ED A0       > ldi
1706   551C ED A0       > ldi
1706   551E ED A0       > ldi
1706   5520 ED A0       > ldi
1706   5522 ED A0       > ldi
1706   5524 ED A0       > ldi
1706   5526 ED A0       > ldi
1706   5528 ED A0       > ldi
1706   552A ED A0       > ldi
1706   552C ED A0       > ldi
1706   552E ED A0       > ldi
1706   5530 ED A0       > ldi
1706   5532 ED A0       > ldi
1706   5534 ED A0       > ldi
1706   5536 ED A0       > ldi
1706   5538 ED A0       > ldi
1706   553A ED A0       > ldi
1706   553C ED A0       > ldi
1706   553E ED A0       > ldi
1706   5540 ED A0       > ldi
1706   5542 ED A0       > ldi
1706   5544 ED A0       > ldi
1706   5546 ED A0       > ldi
1706   5548 ED A0       > ldi
1706   554A ED A0       > ldi
1706   554C ED A0       > ldi
1706   554E ED A0       > ldi
1706   5550 ED A0       > ldi
1706   5552 ED A0       > ldi
1706   5554 ED A0       > ldi
1706   5556 ED A0       > ldi
1706   5558 ED A0       > ldi
1706   555A ED A0       > ldi
1706   555C ED A0       > ldi
1706   555E ED A0       > ldi
1706   5560 ED A0       > ldi
1706   5562 ED A0       > ldi
1706   5564 ED A0       > ldi
1706   5566 ED A0       > ldi
1706   5568 ED A0       > ldi
1706   556A ED A0       > ldi
1706   556C ED A0       > ldi
1706   556E ED A0       > ldi
1706   5570 ED A0       > ldi
1706   5572 ED A0       > ldi
1706   5574 ED A0       > ldi
1706   5576 ED A0       > ldi
1706   5578 ED A0       > ldi
1706   557A ED A0       > ldi
1706   557C ED A0       > ldi
1706   557E ED A0       > ldi
1706   5580 ED A0       > ldi
1706   5582 ED A0       > ldi
1706   5584 ED A0       > ldi
1706   5586 ED A0       > ldi
1706   5588 ED A0       > ldi
1706   558A ED A0       > ldi
1706   558C ED A0       > ldi
1706   558E ED A0       > ldi
1706   5590 ED A0       > ldi
1706   5592 ED A0       > ldi
1706   5594 ED A0       > ldi
1706   5596 ED A0       > ldi
1706   5598 ED A0       > ldi
1706   559A ED A0       > ldi
1706   559C ED A0       > ldi
1706   559E ED A0       > ldi
1706   55A0 ED A0       > ldi
1706   55A2 ED A0       > ldi
1706   55A4 ED A0       > ldi
1706   55A6 ED A0       > ldi
1706   55A8 ED A0       > ldi
1706   55AA ED A0       > ldi
1706   55AC ED A0       > ldi
1706   55AE ED A0       > ldi
1706   55B0 ED A0       > ldi
1706   55B2 ED A0       > ldi
1706   55B4 ED A0       > ldi
1706   55B6 ED A0       > ldi
1706   55B8 ED A0       > ldi
1706   55BA ED A0       > ldi
1706   55BC ED A0       > ldi
1706   55BE ED A0       > ldi
1706   55C0 ED A0       > ldi
1706   55C2 ED A0       > ldi
1706   55C4 ED A0       > ldi
1706   55C6 ED A0       > ldi
1706   55C8 ED A0       > ldi
1706   55CA ED A0       > ldi
1706   55CC ED A0       > ldi
1706   55CE ED A0       > ldi
1706   55D0 ED A0       > ldi
1706   55D2 ED A0       > ldi
1706   55D4 ED A0       > ldi
1706   55D6 ED A0       > ldi
1706   55D8 ED A0       > ldi
1706   55DA ED A0       > ldi
1706   55DC ED A0       > ldi
1706   55DE ED A0       > ldi
1706   55E0 ED A0       > ldi
1706   55E2 ED A0       > ldi
1706   55E4 ED A0       > ldi
1706   55E6 ED A0       > ldi
1706   55E8 ED A0       > ldi
1706   55EA ED A0       > ldi
1706   55EC ED A0       > ldi
1706   55EE ED A0       > ldi
1706   55F0 ED A0       > ldi
1706   55F2 ED A0       > ldi
1706   55F4 ED A0       > ldi
1706   55F6 ED A0       > ldi
1706   55F8 ED A0       > ldi
1706   55FA ED A0       > ldi
1706   55FC ED A0       > ldi
1706   55FE ED A0       > ldi
1706   5600 ED A0       > ldi
1706   5602 ED A0       > ldi
1706   5604 ED A0       > ldi
1706   5606 ED A0       > ldi
1706   5608 ED A0       > ldi
1706   560A ED A0       > ldi
1706   560C ED A0       > ldi
1706   560E ED A0       > ldi
1706   5610 ED A0       > ldi
1706   5612 ED A0       > ldi
1706   5614 ED A0       > ldi
1706   5616 ED A0       > ldi
1706   5618 ED A0       > ldi
1706   561A ED A0       > ldi
1706   561C ED A0       > ldi
1706   561E ED A0       > ldi
1706   5620 ED A0       > ldi
1706   5622 ED A0       > ldi
1706   5624 ED A0       > ldi
1706   5626 ED A0       > ldi
1706   5628 ED A0       > ldi
1706   562A ED A0       > ldi
1706   562C ED A0       > ldi
1706   562E ED A0       > ldi
1706   5630 ED A0       > ldi
1706   5632 ED A0       > ldi
1706   5634 ED A0       > ldi
1706   5636 ED A0       > ldi
1706   5638 ED A0       > ldi
1706   563A ED A0       > ldi
1706   563C ED A0       > ldi
1706   563E ED A0       > ldi
1706   5640 ED A0       > ldi
1706   5642 ED A0       > ldi
1706   5644 ED A0       > ldi
1706   5646 ED A0       > ldi
1706   5648 ED A0       > ldi
1706   564A ED A0       > ldi
1706   564C ED A0       > ldi
1706   564E ED A0       > ldi
1706   5650 ED A0       > ldi
1706   5652 ED A0       > ldi
1706   5654 ED A0       > ldi
1706   5656 ED A0       > ldi
1706   5658 ED A0       > ldi
1706   565A ED A0       > ldi
1706   565C ED A0       > ldi
1706   565E ED A0       > ldi
1706   5660 ED A0       > ldi
1706   5662 ED A0       > ldi
1706   5664 ED A0       > ldi
1706   5666 ED A0       > ldi
1706   5668 ED A0       > ldi
1706   566A ED A0       > ldi
1706   566C ED A0       > ldi
1706   566E ED A0       > ldi
1706   5670 ED A0       > ldi
1706   5672 ED A0       > ldi
1706   5674 ED A0       > ldi
1706   5676 ED A0       > ldi
1706   5678 ED A0       > ldi
1706   567A ED A0       > ldi
1706   567C ED A0       > ldi
1706   567E ED A0       > ldi
1706   5680 ED A0       > ldi
1706   5682 ED A0       > ldi
1706   5684 ED A0       > ldi
1706   5686 ED A0       > ldi
1706   5688 ED A0       > ldi
1706   568A ED A0       > ldi
1706   568C ED A0       > ldi
1706   568E ED A0       > ldi
1706   5690 ED A0       > ldi
1706   5692 ED A0       > ldi
1706   5694 ED A0       > ldi
1706   5696 ED A0       > ldi
1706   5698 ED A0       > ldi
1706   569A ED A0       > ldi
1706   569C ED A0       > ldi
1706   569E ED A0       > ldi
1706   56A0 ED A0       > ldi
1706   56A2 ED A0       > ldi
1706   56A4 ED A0       > ldi
1706   56A6 ED A0       > ldi
1706   56A8 ED A0       > ldi
1706   56AA ED A0       > ldi
1706   56AC ED A0       > ldi
1706   56AE ED A0       > ldi
1706   56B0 ED A0       > ldi
1706   56B2 ED A0       > ldi
1706   56B4 ED A0       > ldi
1706   56B6 ED A0       > ldi
1706   56B8 ED A0       > ldi
1706   56BA ED A0       > ldi
1706   56BC ED A0       > ldi
1706   56BE ED A0       > ldi
1706   56C0 ED A0       > ldi
1706   56C2 ED A0       > ldi
1706   56C4 ED A0       > ldi
1706   56C6 ED A0       > ldi
1706   56C8 ED A0       > ldi
1706   56CA ED A0       > ldi
1706   56CC ED A0       > ldi
1706   56CE ED A0       > ldi
1706   56D0 ED A0       > ldi
1706   56D2 ED A0       > ldi
1706   56D4 ED A0       > ldi
1706   56D6 ED A0       > ldi
1706   56D8 ED A0       > ldi
1706   56DA ED A0       > ldi
1706   56DC ED A0       > ldi
1706   56DE ED A0       > ldi
1706   56E0 ED A0       > ldi
1706   56E2 ED A0       > ldi
1706   56E4 ED A0       > ldi
1706   56E6 ED A0       > ldi
1706   56E8 ED A0       > ldi
1706   56EA ED A0       > ldi
1706   56EC ED A0       > ldi
1706   56EE ED A0       > ldi
1706   56F0 ED A0       > ldi
1706   56F2 ED A0       > ldi
1706   56F4 ED A0       > ldi
1706   56F6 ED A0       > ldi
1706   56F8 ED A0       > ldi
1706   56FA ED A0       > ldi
1706   56FC ED A0       > ldi
1706   56FE ED A0       > ldi
1706   5700 ED A0       > ldi
1706   5702 ED A0       > ldi
1706   5704 ED A0       > ldi
1706   5706 ED A0       > ldi
1706   5708 ED A0       > ldi
1706   570A ED A0       > ldi
1706   570C ED A0       > ldi
1706   570E ED A0       > ldi
1706   5710 ED A0       > ldi
1706   5712 ED A0       > ldi
1706   5714 ED A0       > ldi
1706   5716 ED A0       > ldi
1706   5718 ED A0       > ldi
1706   571A ED A0       > ldi
1706   571C ED A0       > ldi
1706   571E ED A0       > ldi
1706   5720 ED A0       > ldi
1706   5722 ED A0       > ldi
1706   5724 ED A0       > ldi
1706   5726 ED A0       > ldi
1706   5728 ED A0       > ldi
1706   572A ED A0       > ldi
1706   572C ED A0       > ldi
1706   572E ED A0       > ldi
1706   5730 ED A0       > ldi
1706   5732 ED A0       > ldi
1706   5734 ED A0       > ldi
1706   5736 ED A0       > ldi
1706   5738 ED A0       > ldi
1706   573A ED A0       > ldi
1706   573C ED A0       > ldi
1706   573E ED A0       > ldi
1706   5740 ED A0       > ldi
1706   5742 ED A0       > ldi
1706   5744 ED A0       > ldi
1706   5746 ED A0       > ldi
1706   5748 ED A0       > ldi
1706   574A ED A0       > ldi
1706   574C ED A0       > ldi
1706   574E ED A0       > ldi
1706   5750 ED A0       > ldi
1706   5752 ED A0       > ldi
1706   5754 ED A0       > ldi
1706   5756 ED A0       > ldi
1706   5758 ED A0       > ldi
1706   575A ED A0       > ldi
1706   575C ED A0       > ldi
1706   575E ED A0       > ldi
1706   5760 ED A0       > ldi
1706   5762 ED A0       > ldi
1706   5764 ED A0       > ldi
1706   5766 ED A0       > ldi
1706   5768 ED A0       > ldi
1706   576A ED A0       > ldi
1706   576C ED A0       > ldi
1706   576E ED A0       > ldi
1706   5770 ED A0       > ldi
1706   5772 ED A0       > ldi
1706   5774 ED A0       > ldi
1706   5776 ED A0       > ldi
1706   5778 ED A0       > ldi
1706   577A ED A0       > ldi
1706   577C ED A0       > ldi
1706   577E ED A0       > ldi
1706   5780 ED A0       > ldi
1706   5782 ED A0       > ldi
1706   5784 ED A0       > ldi
1706   5786 ED A0       > ldi
1706   5788 ED A0       > ldi
1706   578A ED A0       > ldi
1706   578C ED A0       > ldi
1706   578E ED A0       > ldi
1706   5790 ED A0       > ldi
1706   5792 ED A0       > ldi
1706   5794 ED A0       > ldi
1706   5796 ED A0       > ldi
1706   5798 ED A0       > ldi
1706   579A ED A0       > ldi
1706   579C ED A0       > ldi
1706   579E ED A0       > ldi
1706   57A0 ED A0       > ldi
1706   57A2 ED A0       > ldi
1706   57A4 ED A0       > ldi
1706   57A6 ED A0       > ldi
1706   57A8 ED A0       > ldi
1706   57AA ED A0       > ldi
1706   57AC ED A0       > ldi
1706   57AE ED A0       > ldi
1706   57B0 ED A0       > ldi
1706   57B2 ED A0       > ldi
1706   57B4 ED A0       > ldi
1706   57B6 ED A0       > ldi
1707   57B8             .part2s: 
1708   57B8 EB          	ex	de,hl
1709   57B9 3A 00 7B    	ld	a, (SPIDATA)	; descarta CRC
1710   57BC             .fim: 
1711   57BC AF          	xor	a		; zera carry para informar leitura sem erros
1712   57BD C3 48 4F    	jp	terminaLeituraEscritaBloco
1713   57C0             
1714   57C0             
1715   57C0             ; ------------------------------------------------
1716   57C0             ; Converte blocos para bytes. Na pratica faz
1717   57C0             ; BC DE = (BC DE) * 512
1718   57C0             ; ------------------------------------------------
1719   57C0             blocoParaByte: 
1720   57C0 41          	ld	b, c
1721   57C1 4A          	ld	c, d
1722   57C2 53          	ld	d, e
1723   57C3 1E 00       	ld	e, 0
1724   57C5 CB 22       	sla	d
1725   57C7 CB 11       	rl	c
1726   57C9 CB 10       	rl	b
1727   57CB C9          	ret
1728   57CC             
1729   57CC             ; ------------------------------------------------
1730   57CC             ; Funcoes utilitarias
1731   57CC             ; ------------------------------------------------
1732   57CC             
1733   57CC             
1734   57CC             ; ------------------------------------------------
1735   57CC             ; Imprime string na tela apontada por DE
1736   57CC             ; Destroi todos os registradores
1737   57CC             ; ------------------------------------------------
1738   57CC             printString: 
1739   57CC 1A          	ld	a, (de)
1740   57CD B7          	or	a
1741   57CE C8          	ret	z
1742   57CF CD A2 00    	call	CHPUT
1743   57D2 13          	inc	de
1744   57D3 18 F7       	jr	printString
1745   57D5             
1746   57D5             
1747   57D5             ; ------------------------------------------------
1748   57D5             ; Converte o byte em A para string em decimal no
1749   57D5             ; buffer apontado por DE
1750   57D5             ; Destroi AF, BC, HL, DE
1751   57D5             ; ------------------------------------------------
1752   57D5             DecToAscii: 
1753   57D5 26 00       	ld	h, 0
1754   57D7 6F          	ld	l, a		; copiar A para HL
1755   57D8 FD 36 34 01 	ld	(iy+TEMP), 1	; flag para indicar que devemos cortar os zeros a esquerda
1756   57DC 01 9C FF    	ld	bc, -100	; centenas
1757   57DF CD ED 57    	call	.num1
1758   57E2 0E F6       	ld	c, -10		; dezenas
1759   57E4 CD ED 57    	call	.num1
1760   57E7 FD 36 34 02 	ld	(iy+TEMP), 2	; unidade deve exibir 0 se for zero e nao corta-lo
1761   57EB 0E FF       	ld	c, -1		; unidades
1762   57ED             .num1: 
1763   57ED 3E 2F       	ld	a, '0'-1
1764   57EF             .num2: 
1765   57EF 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1766   57F0 09          	add	hl, bc		; somar com negativo
1767   57F1 38 FC       	jr	c,.num2		; ainda nao zeramos
1768   57F3 ED 42       	sbc	hl, bc		; retoma valor original
1769   57F5 FD 35 34    	dec	(iy+TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1770   57F8 20 08       	jr	nz,.naozero
1771   57FA FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1772   57FC 20 04       	jr	nz,.naozero
1773   57FE FD 34 34    	inc	(iy+TEMP)	; se for zero, nao salvamos e voltamos a flag
1774   5801 C9          	ret
1775   5802             .naozero: 
1776   5802 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1777   5803 13          	inc	de		; incrementa ponteiro de destino
1778   5804 C9          	ret
1779   5805             
1780   5805             ; ------------------------------------------------
1781   5805             ; Converte o byte em A para string em hexa no
1782   5805             ; buffer apontado por DE
1783   5805             ; Destroi AF, C, DE
1784   5805             ; ------------------------------------------------
1785   5805             HexToAscii: 
1786   5805 4F          	ld	c, a
1787   5806 1F          	rra
1788   5807 1F          	rra
1789   5808 1F          	rra
1790   5809 1F          	rra
1791   580A CD 0E 58    	call	.conv
1792   580D 79          	ld  	a, c
1793   580E             .conv: 
1794   580E E6 0F       	and	$0F
1795   5810 C6 90       	add	a, $90
1796   5812 27          	daa
1797   5813 CE 40       	adc	a, $40
1798   5815 27          	daa
1799   5816 12          	ld	(de), a
1800   5817 13          	inc	de
1801   5818 C9          	ret
1802   5819             
1803   5819             ; ------------------------------------------------
1804   5819             ; Converte o byte em A para string em decimal e
1805   5819             ; imprime na tela
1806   5819             ; Destroi AF, BC, HL, DE
1807   5819             ; ------------------------------------------------
1808   5819             printDecToAscii: 
1809   5819 26 00       	ld	h, 0
1810   581B 6F          	ld	l, a		; copiar A para HL
1811   581C 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1812   581E 11 9C FF    	ld	de, -100	; centenas
1813   5821 CD 2D 58    	call	.num1
1814   5824 1E F6       	ld	e, -10		; dezenas
1815   5826 CD 2D 58    	call	.num1
1816   5829 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1817   582B 1E FF       	ld	e, -1		; unidades
1818   582D             .num1: 
1819   582D 3E 2F       	ld	a, '0'-1
1820   582F             .num2: 
1821   582F 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1822   5830 19          	add	hl, de		; somar com negativo
1823   5831 38 FC       	jr	c,.num2		; ainda nao zeramos
1824   5833 ED 52       	sbc	hl, de		; retoma valor original
1825   5835 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1826   5837 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1827   5839 20 02       	jr	nz,.naozero
1828   583B 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1829   583C C9          	ret
1830   583D             .naozero: 
1831   583D E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1832   583E C5          	push	bc
1833   583F CD A2 00    	call	CHPUT
1834   5842 C1          	pop	bc
1835   5843 E1          	pop	hl
1836   5844 C9          	ret
1837   5845             
1838   5845             ; ------------------------------------------------
1839   5845             ; Procura pelo nome do fabricante em uma tabela.
1840   5845             ; A contem o byte do fabricante
1841   5845             ; Devolve HL apontando para o buffer do fabricante
1842   5845             ; e BC com o comprimento do texto
1843   5845             ; Destroi AF, BC, HL
1844   5845             ; ------------------------------------------------
1845   5845             pegaFabricante: 
1846   5845 4F          	ld	c, a
1847   5846 21 67 58    	ld	hl, tblFabricantes
1848   5849             
1849   5849             .loop: 
1850   5849 7E          	ld	a, (hl)
1851   584A 23          	inc	hl
1852   584B B9          	cp	c
1853   584C 28 0C       	jr	z,.achado
1854   584E B7          	or	a
1855   584F 28 09       	jr	z,.achado
1856   5851 C5          	push	bc
1857   5852 CD 5A 58    	call	.achado
1858   5855 09          	add	hl, bc
1859   5856 23          	inc	hl
1860   5857 C1          	pop	bc
1861   5858 18 EF       	jr	.loop
1862   585A             
1863   585A             .achado: 
1864   585A 0E 00       	ld	c, 0
1865   585C E5          	push	hl
1866   585D AF          	xor	a
1867   585E             .loop2: 
1868   585E 0C          	inc	c
1869   585F 23          	inc	hl
1870   5860 BE          	cp	(hl)
1871   5861 20 FB       	jr	nz,.loop2
1872   5863 E1          	pop	hl
1873   5864 06 00       	ld	b, 0
1874   5866 C9          	ret
1875   5867             
1876   5867             tblFabricantes: 
1877   5867 01          	db	1
1878   5868             	db	"Panasonic",0
1878   5868 50616E61736F6E696300
1879   5872 02          	db	2
1880   5873             	db	"Toshiba",0
1880   5873 546F736869626100
1881   587B 03          	db	3
1882   587C             	db	"SanDisk",0
1882   587C 53616E4469736B00
1883   5884 04          	db	4
1884   5885             	db	"SMI-S",0
1884   5885 534D492D5300
1885   588B 06          	db	6
1886   588C             	db	"Renesas",0
1886   588C 52656E6573617300
1887   5894 11          	db	17
1888   5895             	db	"Dane-Elec",0
1888   5895 44616E652D456C656300
1889   589F 13          	db	19
1890   58A0             	db	"KingMax",0
1890   58A0 4B696E674D617800
1891   58A8 15          	db	21
1892   58A9             	db	"Samsung",0
1892   58A9 53616D73756E6700
1893   58B1 18          	db	24
1894   58B2             	db	"Infineon",0
1894   58B2 496E66696E656F6E00
1895   58BB 1A          	db	26
1896   58BC 50 51 49 00 	db	"PQI",0
1897   58C0 1B          	db	27
1898   58C1 536F6E7900  	db	"Sony",0
1899   58C6 1C          	db	28
1900   58C7             	db	"Transcend",0
1900   58C7 5472616E7363656E6400
1901   58D1 1D          	db	29
1902   58D2             	db	"A-DATA",0
1902   58D2 412D4441544100
1903   58D9 1F          	db	31
1904   58DA             	db	"SiliconPower",0
1904   58DA 53696C69636F6E506F77657200
1905   58E7 27          	db	39
1906   58E8             	db	"Verbatim",0
1906   58E8 566572626174696D00
1907   58F1 41          	db	65
1908   58F2 4F 4B 49 00 	db	"OKI",0
1909   58F6 73          	db	115
1910   58F7             	db	"SilverHT",0
1910   58F7 53696C766572485400
1911   5900 89          	db	137
1912   5901             	db	"L.Data",0
1912   5901 4C2E4461746100
1913   5908 00          	db	0
1914   5909             	db	"Generico",0
1914   5909 47656E657269636F00
1915   5912             
1916   5912             
1917   5912             ; ------------------------------------------------
1918   5912             ; Restore screen parameters on MSX>=2 if they're
1919   5912             ; not set yet
1920   5912             ; ------------------------------------------------
1921   5912             MYSETSCR: 
1922   5912 3A 2D 00    	ld	a,(MSXVER)
1923   5915 B7          	or	a			; MSX1?
1924   5916 CA 6C 00    	jp	z,INITXT		; Yes, change do screen-0
1925   5919             
1926   5919 0E 23       	ld	c,$23			; Block-2, R#3
1927   591B DD 21 F5 01 	ld 	ix,REDCLK
1928   591F CD 5F 01    	call	EXTROM
1929   5922 E6 01       	and	1
1930   5924 47          	ld	b,a
1931   5925 3A AF FC    	ld	a,(SCRMOD)
1932   5928 B8          	cp	b
1933   5929 20 1C       	jr	nz,.restore
1934   592B 0C          	inc	c
1935   592C DD 21 F5 01 	ld 	ix,REDCLK
1936   5930 CD 5F 01    	call	EXTROM
1937   5933 47          	ld	b,a
1938   5934 0C          	inc	c
1939   5935 DD 21 F5 01 	ld 	ix,REDCLK
1940   5939 CD 5F 01    	call	EXTROM
1941   593C 87          	add	a,a
1942   593D 87          	add	a,a
1943   593E 87          	add	a,a
1944   593F 87          	add	a,a
1945   5940 B0          	or	b
1946   5941 47          	ld	b,a
1947   5942 3A B0 F3    	ld	a,(LINLEN)
1948   5945 B8          	cp	b
1949   5946 C8          	ret	z
1950   5947             .restore: 
1951   5947 AF          	xor	a		; Don't displat the function keys
1952   5948 DD 21 85 01 	ld	ix,SDFSCR
1953   594C C3 5F 01    	jp	EXTROM
1954   594F             
1955   594F             
1956   594F             
1957   594F             ; ==========================================================================
1958   594F             strTitle: 
1959   594F             	db	"FBLabs SDHC driver "
1959   594F 46424C61627320534448432064726976657220
1960   5962             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
1960   5962 76312E302E36
1961   5968 0D 0A 00    	db	13,10,0
1962   596B             
1963   596B             strBootpaused: 
1964   596B             	db	"Paused. Press <i> to show the copyright info.",13,10,0
1964   596B 5061757365642E205072657373203C693E20746F2073686F772074686520636F
1964   598B 7079726967687420696E666F2E0D0A00
1965   599B             
1966   599B             strCopyright: 
1967   599B             	db	"Copyright (c) 2014 Fabio Belavenuto",13,10
1967   599B 436F7079726967687420286329203230313420466162696F2042656C6176656E
1967   59BB 75746F0D0A
1968   59C0             	db	"Licenced under CERN OHL v1.1",13,10
1968   59C0 4C6963656E63656420756E646572204345524E204F484C2076312E310D0A
1969   59DE             	db	"http://ohwr.org/cernohl",13,10
1969   59DE 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
1970   59F7             	db	"PCB designed by Luciano Sturaro",13,10
1970   59F7 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
1970   5A17 0A
1971   5A18             	; fall throw
1972   5A18             strCrLf: 
1973   5A18 0D 0A 00    	db	13,10,0
1974   5A1B             strCartao: 
1975   5A1B             	db	"Slot ",0
1975   5A1B 536C6F742000
1976   5A21             strVazio: 
1977   5A21             	db	"Empty",13,10,0
1977   5A21 456D7074790D0A00
1978   5A29             strNaoIdentificado: 
1979   5A29             	db	"Unknown!",13,10,0
1979   5A29 556E6B6E6F776E210D0A00
1980   5A34             			;----------------------------------------
1981   5A34             strMr_mp_desativada: 
1982   5A34             	db	"Slot expander/Mapper/MegaRAM disabled",13,10,0
1982   5A34 536C6F7420657870616E6465722F4D61707065722F4D65676152414D20646973
1982   5A54 61626C65640D0A00
1983   5A5C             strMapper: 
1984   5A5C             	db	"Slot expanded and Memory Mapper enabled",13,10,0
1984   5A5C 536C6F7420657870616E64656420616E64204D656D6F7279204D617070657220
1984   5A7C 656E61626C65640D0A00
1985   5A86             strMegaram: 
1986   5A86             	db	"Slot expander and MegaRAM enabled",13,10,0
1986   5A86 536C6F7420657870616E64657220616E64204D65676152414D20656E61626C65
1986   5AA6 640D0A00
1987   5AAA             strSDV1: 
1988   5AAA             	db	"SDV1 - ",0
1988   5AAA 53445631202D2000
1989   5AB2             strSDV2: 
1990   5AB2             	db	"SDV2 - ",0
1990   5AB2 53445632202D2000
1991   5ABA             
1992   5ABA             ;-----------------------------------------------------------------------------
1993   5ABA             ;
1994   5ABA             ; End of the driver code
1995   5ABA             
1996   5ABA             DRV_END: 
1997   5ABA             
1998   5ABA FF          	ds	3ED0h-(DRV_END-DRV_START), $FF
1999   7FD0             
2000   7FD0             
