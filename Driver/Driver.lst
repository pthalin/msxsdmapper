0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 7B00h~7EFFh	: SPI data transfer window (read/write)
0015   0000             ; 7F00h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	b0	: 0=SD card present on slot-0
0018   0000             ;	b1	: 0=SD card present on slot-1
0019   0000             ;	b2	: 0=Write protecton enabled for SD card slot-0
0020   0000             ;	b3	: 0=Write protecton enabled for SD card slot-1
0021   0000             ;	b4	: SW0 status. 0=RAM enabled, 1=RAM disabled
0022   0000             ;	b5	: SW1 status. 0=RAM mode: MegaRAM, 1=RAM mode: Memory Mapper
0023   0000             ;	b6	: Reserved for future use. Must be masked out from readings.
0024   0000             ;	b7	: 1=SPI transfer busy. 0=No ongoing SPI transfer
0025   0000             ;	<write>
0026   0000             ;	b0	: SD card slot-0 chip-select (0=selected)
0027   0000             ;	b1	: SD card slot-1 chip-select (0=selected)
0028   0000             
0029   0000             ; 7F01h		: Mode configuration register (write only)
0030   0000             ;	b0	: 0=ROM mode, SPI interface disabled, 1=SPI interface enabled
0031   0000             
0032   0000             
0033   0000             
0034   0000             	output	"driver.bin"
0035   0000             
0036   0000             ;-----------------------------------------------------------------------------
0037   0000             ;
0038   0000             ; Driver configuration constants
0039   0000             ;
0040   0000             
0041   0000             ;Driver type:
0042   0000             ;   0 for drive-based
0043   0000             ;   1 for device-based
0044   0000             
0045   0000             DRV_TYPE	equ	1
0046   0000             
0047   0000             ;Hot-plug devices support (device-based drivers only):
0048   0000             ;   0 for no hot-plug support
0049   0000             ;   1 for hot-plug support
0050   0000             
0051   0000             DRV_HOTPLUG	equ	0
0052   0000             
0053   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0054   0000             
0055   0000             ;Driver version
0056   0000             
0057   0000             VER_MAIN	equ	1
0058   0000             VER_SEC		equ	0
0059   0000             VER_REV		equ	6
0060   0000             
0061   0000             ;-----------------------------------------------------------------------------
0062   0000             ; Enderecos SPI
0063   0000             
0064   0000             SPIDATA		= $7B00
0065   0000             SPICTRL		= $7F00
0066   0000             SPISTATUS	= $7F00
0067   0000             
0068   0000             ; Comandos SPI:
0069   0000             CMD0	= 0  | $40
0070   0000             CMD1	= 1  | $40
0071   0000             CMD8	= 8  | $40
0072   0000             CMD9	= 9  | $40
0073   0000             CMD10	= 10 | $40
0074   0000             CMD12	= 12 | $40
0075   0000             CMD16	= 16 | $40
0076   0000             CMD17	= 17 | $40
0077   0000             CMD18	= 18 | $40
0078   0000             CMD24	= 24 | $40
0079   0000             CMD25	= 25 | $40
0080   0000             CMD55	= 55 | $40
0081   0000             CMD58	= 58 | $40
0082   0000             ACMD23	= 23 | $40
0083   0000             ACMD41	= 41 | $40
0084   0000             
0085   0000             ; Offsets da area de trabalho
0086   0000             
0087   0000             BCSD 		= 0
0088   0000             BCID1		= 16
0089   0000             BCID2		= 32
0090   0000             NUMSD		= 48	; 1 se cartao 1, 2 se cartao 2
0091   0000             FLAGSCARTAO	= 49	; Flag indicando se houve mudanca ou erro de cartao
0092   0000             NUMBLOCOS	= 50	; 1 byte
0093   0000             TEMP		= 52	; 1 byte
0094   0000             BLOCOS1		= 56	; 3 bytes
0095   0000             BLOCOS2		= 60	; 3 bytes
0096   0000             
0097   0000             
0098   0000             
0099   0000             ;-----------------------------------------------------------------------------
0100   0000             ;
0101   0000             ; Standard BIOS and work area entries
0102   0000             INITXT	= $006C		; Inicializa SCREEN0
0103   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0104   0000             CHGET	= $009F		; Get character from keyboard buffer
0105   0000             CHPUT	= $00A2		; A=char
0106   0000             CLS	= $00C3		; Chamar com A=0
0107   0000             ERAFNK	= $00CC		; Erase function key display
0108   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0109   0000             KILBUF	= $0156		; Clear keyboard buffer
0110   0000             EXTROM	= $015F
0111   0000             
0112   0000             ; subROM functions
0113   0000             SDFSCR	= $0185
0114   0000             REDCLK	= $01F5
0115   0000             
0116   0000             
0117   0000             ; System variables
0118   0000             MSXVER	= $002D
0119   0000             LINL40	= $F3AE		; Width
0120   0000             LINLEN	= $F3B0
0121   0000             INTFLG	= $FC9B
0122   0000             SCRMOD	= $FCAF
0123   0000             
0124   0000             
0125   0000             ;-----------------------------------------------------------------------------
0126   0000             
0127   0000             
0128   0000             	org		$4000
0129   4000             
0130   4000 FF          	ds		256, $FF		; 256 dummy bytes
0131   4100             
0132   4100             DRV_START: 
0133   4100             
0134   4100             ;-----------------------------------------------------------------------------
0135   4100             ;
0136   4100             ; Miscellaneous constants
0137   4100             ;
0138   4100             
0139   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0140   4100             ;It is used by some of the kernel page 0 routines.
0141   4100             
0142   4100             CODE_ADD: 	equ	0F84Ch
0143   4100             
0144   4100             
0145   4100             ;-----------------------------------------------------------------------------
0146   4100             ;
0147   4100             ; Error codes for DEV_RW
0148   4100             ;
0149   4100             
0150   4100             ENCOMP	equ	0FFh
0151   4100             EWRERR	equ	0FEh
0152   4100             EDISK	equ	0FDh
0153   4100             ENRDY	equ	0FCh
0154   4100             EDATA	equ	0FAh
0155   4100             ERNF	equ	0F9h
0156   4100             EWPROT	equ	0F8h
0157   4100             EUFORM	equ	0F7h
0158   4100             ESEEK	equ	0F3h
0159   4100             EIFORM	equ	0F0h
0160   4100             EIDEVL	equ	0B5h
0161   4100             EIPARM	equ	08Bh
0162   4100             
0163   4100             ;-----------------------------------------------------------------------------
0164   4100             ;
0165   4100             ; Routines and information available on kernel page 0
0166   4100             ;
0167   4100             
0168   4100             ;* Get in A the current slot for page 1. Corrupts F.
0169   4100             ;  Must be called by using CALBNK to bank 0:
0170   4100             ;    xor a
0171   4100             ;    ld ix,GSLOT1
0172   4100             ;    call CALBNK
0173   4100             
0174   4100             GSLOT1	equ	402Dh
0175   4100             
0176   4100             
0177   4100             ;* This routine reads a byte from another bank.
0178   4100             ;  Must be called by using CALBNK to the desired bank,
0179   4100             ;  passing the address to be read in HL:
0180   4100             ;    ld a,<bank number>
0181   4100             ;    ld hl,<byte address>
0182   4100             ;    ld ix,RDBANK
0183   4100             ;    call CALBNK
0184   4100             
0185   4100             RDBANK	equ	403Ch
0186   4100             
0187   4100             
0188   4100             ;* This routine temporarily switches kernel main bank
0189   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0190   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0191   4100             ;  It is necessary to use this routine to invoke CALBAS
0192   4100             ;  (so that kernel bank is correct in case of BASIC error)
0193   4100             ;  and to invoke DOS functions via F37Dh hook.
0194   4100             ;
0195   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0196   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0197   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0198   4100             
0199   4100             CALLB0	equ	403Fh
0200   4100             
0201   4100             
0202   4100             ;* Call a routine in another bank.
0203   4100             ;  Must be used if the driver spawns across more than one bank.
0204   4100             ;
0205   4100             ;  Input:  A = bank number
0206   4100             ;          IX = routine address
0207   4100             ;          AF' = AF for the routine
0208   4100             ;          HL' = Ix for the routine
0209   4100             ;          BC, DE, HL, IY = input for the routine
0210   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0211   4100             
0212   4100             CALBNK	equ	4042h
0213   4100             
0214   4100             
0215   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0216   4100             ;  which will in turn contain a pointer to the allocated page 3
0217   4100             ;  work area for that slot (0 if no work area was allocated).
0218   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0219   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0220   4100             ;  Corrupts F.
0221   4100             ;  Must be called by using CALBNK to bank 0:
0222   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0223   4100             ;    ex af,af'
0224   4100             ;    xor a
0225   4100             ;    ld ix,GWORK
0226   4100             ;    call CALBNK
0227   4100             
0228   4100             GWORK	equ	4045h
0229   4100             
0230   4100             
0231   4100             ;* This address contains one byte that tells how many banks
0232   4100             ;  form the Nextor kernel (or alternatively, the first bank
0233   4100             ;  number of the driver).
0234   4100             
0235   4100             K_SIZE	equ	40FEh
0236   4100             
0237   4100             
0238   4100             ;* This address contains one byte with the current bank number.
0239   4100             
0240   4100             CUR_BANK	equ	40FFh
0241   4100             
0242   4100             
0243   4100             ;-----------------------------------------------------------------------------
0244   4100             ;
0245   4100             ; Built-in format choice strings
0246   4100             ;
0247   4100             
0248   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0249   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0250   4100             
0251   4100             
0252   4100             ;-----------------------------------------------------------------------------
0253   4100             ;
0254   4100             ; Driver signature
0255   4100             ;
0256   4100             	db	"NEXTOR_DRIVER",0
0256   4100 4E4558544F525F44524956455200
0257   410E             
0258   410E             
0259   410E             ;-----------------------------------------------------------------------------
0260   410E             ;
0261   410E             ; Driver flags:
0262   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0263   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0264   410E             
0265   410E 01          	db 1+(2*DRV_HOTPLUG)
0266   410F             
0267   410F             ;-----------------------------------------------------------------------------
0268   410F             ;
0269   410F             ; Reserved byte
0270   410F             ;
0271   410F 00          	db	0
0272   4110             
0273   4110             ;-----------------------------------------------------------------------------
0274   4110             ;
0275   4110             ; Driver name
0276   4110             ;
0277   4110             
0278   4110             DRV_NAME: 
0279   4110             	db	"SDMapper Driver"
0279   4110 53444D617070657220447269766572
0280   411F 20          	ds	32-($-DRV_NAME)," "
0281   4130             
0282   4130             
0283   4130             ;-----------------------------------------------------------------------------
0284   4130             ;
0285   4130             ; Jump table for the driver public routines
0286   4130             ;
0287   4130             
0288   4130             	; These routines are mandatory for all drivers
0289   4130                     ; (but probably you need to implement only DRV_INIT)
0290   4130             
0291   4130 C3 6C 41    	jp	DRV_TIMI
0292   4133 C3 7B 42    	jp	DRV_VERSION
0293   4136 C3 6D 41    	jp	DRV_INIT
0294   4139 C3 82 42    	jp	DRV_BASSTAT
0295   413C C3 84 42    	jp	DRV_BASDEV
0296   413F C3 86 42    	jp	DRV_EXTBIO
0297   4142 C3 87 42    	jp	DRV_DIRECT0
0298   4145 C3 87 42    	jp	DRV_DIRECT1
0299   4148 C3 87 42    	jp	DRV_DIRECT2
0300   414B C3 87 42    	jp	DRV_DIRECT3
0301   414E C3 87 42    	jp	DRV_DIRECT4
0302   4151             
0303   4151 00          	ds	15
0304   4160             
0305   4160             	; These routines are mandatory for device-based drivers
0306   4160             
0307   4160 C3 88 42    	jp	DEV_RW
0308   4163 C3 F9 42    	jp	DEV_INFO
0309   4166 C3 7F 43    	jp	DEV_STATUS
0310   4169 C3 B9 43    	jp	LUN_INFO
0311   416C             
0312   416C             
0313   416C             ;=====
0314   416C             ;=====  END of data that must be at fixed addresses
0315   416C             ;=====
0316   416C             
0317   416C             
0318   416C             ;-----------------------------------------------------------------------------
0319   416C             ;
0320   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0321   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0322   416C             
0323   416C             DRV_TIMI: 
0324   416C C9          	ret
0325   416D             
0326   416D             ;-----------------------------------------------------------------------------
0327   416D             ;
0328   416D             ; Driver initialization routine, it is called twice:
0329   416D             ;
0330   416D             ; 1) First execution, for information gathering.
0331   416D             ;    Input:
0332   416D             ;      A = 0
0333   416D             ;      B = number of available drives
0334   416D             ;      HL = maximum size of allocatable work area in page 3
0335   416D             ;    Output:
0336   416D             ;      A = number of required drives (for drive-based driver only)
0337   416D             ;      HL = size of required work area in page 3
0338   416D             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0339   416D             ;
0340   416D             ; 2) Second execution, for work area and hardware initialization.
0341   416D             ;    Input:
0342   416D             ;      A = 1
0343   416D             ;      B = number of allocated drives for this controller
0344   416D             ;
0345   416D             ;    The work area address can be obtained by using GWORK.
0346   416D             ;
0347   416D             ;    If first execution requests more work area than available,
0348   416D             ;    second execution will not be done and DRV_TIMI will not be hooked
0349   416D             ;    to the timer interrupt.
0350   416D             ;
0351   416D             ;    If first execution requests more drives than available,
0352   416D             ;    as many drives as possible will be allocated, and the initialization
0353   416D             ;    procedure will continue the normal way
0354   416D             ;    (for drive-based drivers only. Device-based drivers always
0355   416D             ;     get two allocated drives.)
0356   416D             
0357   416D             DRV_INIT: 
0358   416D B7          	or	a		; Is this the 1st call? 
0359   416E 21 40 00    	ld	hl, 64		; 64 bytes of work area is needed 
0360   4171 C8          	ret	z		; Yes, return
0361   4172             
0362   4172             ; 2nd call: 
0363   4172 CD F9 58    	call	MYSETSCR		; Set the screen mode
0364   4175 CD F8 43    	call	pegaWorkArea		; HL=IY=Work area pointer
0365   4178             
0366   4178 11 36 59    	ld	de,strTitle		; prints the title 
0367   417B CD B3 57    	call	printString
0368   417E             
0369   417E CD 60 42    	call	SDMAPPERINIT		; SD-Mapper exclusive init
0370   4181             
0371   4181             SDHCDEVINIT: 	; FBLabs SDHC Interface initialization
0372   4181 AF          	xor	a			; zera flags do cartao
0373   4182 FD 77 31    	ld	(iy+FLAGSCARTAO), a
0374   4185 3E 01       	ld	a, 1			; detectar cartao 1
0375   4187 CD EA 41    	call	.detecta
0376   418A 3E 02       	ld	a, 2			; detectar cartao 2
0377   418C CD EA 41    	call	.detecta
0378   418F 01 00 00    	ld	bc, 0
0379   4192 1E 05       	ld	e, 5
0380   4194             
0381   4194             .chkStop:  ; Check if the STOP key was signaled
0382   4194 3A 9B FC    	ld	a,(INTFLG)
0383   4197 FE 04       	cp	4			; Was STOP pressed?
0384   4199 20 35       	jr	nz,.end			; No, quit as fast as possible 
0385   419B             
0386   419B             	; Handle STOP to pause and read messages, and ask for the copyright info
0387   419B 11 52 59    	ld	de,strBootpaused
0388   419E CD B3 57    	call	printString
0389   41A1 3E 07       .wait1: 	ld	a,7
0390   41A3 CD 41 01    	call	SNSMAT
0391   41A6 E6 10       	and	$10			; Is STOP still pressed?
0392   41A8 28 F7       	jr	z,.wait1		; Wait for STOP to be released
0393   41AA AF          	xor	a
0394   41AB 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0395   41AE 06 00       	ld	b,0			; b=inhibit 'i' key flag
0396   41B0 CD 9C 00    .wait2:  call	CHSNS
0397   41B3 C4 D6 41    	call	nz,.chkikey		; Wait until a key is pressed
0398   41B6 3A 9B FC    	ld	a,(INTFLG)
0399   41B9 FE 04       	cp	4			; Was STOP pressed?
0400   41BB 20 F3       	jr	nz,.wait2		; No, return
0401   41BD AF          	xor	a
0402   41BE 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0403   41C1 CD 56 01    	call	KILBUF
0404   41C4 06 1E       	ld	b,30			; Since the user is trying pause the
0405   41C6 76          .wait3: 	halt				; boot messages, this gives him enough
0406   41C7             					; time to react and pause the next
0407   41C7             					; driver
0408   41C7 3A 9B FC    	ld	a,(INTFLG)
0409   41CA FE 04       	cp	4			; Was STOP pressed?
0410   41CC 28 02       	jr	z,.end			; quit so the next driver can process it
0411   41CE 10 F6       	djnz	.wait3			; The user will have the impression
0412   41D0             					; that he has a perfect timing.   ;)
0413   41D0             
0414   41D0             
0415   41D0             .end
0416   41D0 11 FF 59     	ld	de, strCrLf
0417   41D3 C3 B3 57    	jp	printString
0418   41D6             
0419   41D6             .chkikey: 
0420   41D6 CB 40       	bit	0,b			; Was the copyright message shown?
0421   41D8 C0          	ret	nz			; Yes, return
0422   41D9 CD 9F 00    	call	CHGET
0423   41DC FE 69       	cp	'i'
0424   41DE 28 03       	jr	z,.showcopyright
0425   41E0 FE 49       	cp	'I'
0426   41E2 C0          	ret	nz
0427   41E3             .showcopyright: 
0428   41E3 04          	inc	b			; Inhibit further presses of the i key 
0429   41E4 11 82 59    	ld	de,strCopyright
0430   41E7 C3 B3 57    	jp	printString
0431   41EA             
0432   41EA             .detecta: 
0433   41EA FD 77 30    	ld	(iy+NUMSD), a		; processo de deteccao dos cartoes
0434   41ED 11 02 5A    	ld	de, strCartao
0435   41F0 CD B3 57    	call	printString
0436   41F3 FD 7E 30    	ld	a, (iy+NUMSD)
0437   41F6 C6 30       	add	'0'
0438   41F8 CD A2 00    	call	CHPUT
0439   41FB 3E 3A       	ld	a, ':'
0440   41FD CD A2 00    	call	CHPUT
0441   4200 3E 20       	ld	a, ' '
0442   4202 CD A2 00    	call	CHPUT
0443   4205 FD 4E 30    	ld	c, (iy+NUMSD)
0444   4208 3A 00 7F    	ld	a, (SPISTATUS)		; testar se cartao esta inserido
0445   420B A1          	and	c			; C contem 1 se cartao 1, 2 se cartao 2
0446   420C 28 09       	jr	z,.naoVazio
0447   420E 11 08 5A    	ld	de, strVazio		; nao tem cartao no slot
0448   4211 CD B3 57    	call	printString
0449   4214 C3 25 42    	jp	.marcaErro
0450   4217             .naoVazio: 
0451   4217 CD 6F 44    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0452   421A 30 0C       	jr	nc,.detectou
0453   421C CD BD 45    	call	desabilitaSDs
0454   421F 11 10 5A    	ld	de, strNaoIdentificado
0455   4222 CD B3 57    	call	printString
0456   4225             .marcaErro: 
0457   4225 C3 30 44    	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0458   4228             .detectou: 
0459   4228 CD 47 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0460   422B DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0461   422E 11 91 5A    	ld	de, strSDV1	; e imprimir
0462   4231 B7          	or	a
0463   4232 28 03       	jr	z,.pula1
0464   4234 11 99 5A    	ld	de, strSDV2
0465   4237             .pula1: 
0466   4237 CD B3 57    	call	printString
0467   423A 3E 28       	ld	a,'('
0468   423C CD A2 00    	call	CHPUT
0469   423F DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0470   4242 CD 00 58    	call	printDecToAscii	; Imprimir Manufacturer ID
0471   4245 3E 29       	ld	a,')'
0472   4247 CD A2 00    	call	CHPUT
0473   424A 3E 20       	ld	a,' '
0474   424C CD A2 00    	call	CHPUT
0475   424F DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0476   4252 CD 2C 58    	call	pegaFabricante	; achar nome do fabricante
0477   4255 EB          	ex	de,hl
0478   4256 CD B3 57    	call	printString	; e imprimir
0479   4259 11 FF 59    	ld	de,strCrLf
0480   425C CD B3 57    	call	printString
0481   425F C9          	ret
0482   4260             
0483   4260             
0484   4260             SDMAPPERINIT: 		; This block is exclusive for the SD-Mapper
0485   4260 11 1B 5A    	ld	de, strMr_mp_desativada
0486   4263 3A 00 7F    	ld	a, (SPISTATUS)		; testar se mapper/megaram esta ativa
0487   4266 E6 10       	and	$10
0488   4268 28 0E       	jr	z,.print		; desativada, pula
0489   426A 11 43 5A    	ld	de, strMapper
0490   426D 3A 00 7F    	ld	a, (SPISTATUS)		; ativa, testar se eh mapper ou megaram
0491   4270 E6 20       	and	$20
0492   4272 C2 B3 57    	jp	nz,printString
0493   4275 11 6D 5A    	ld	de, strMegaram		; Megaram ativa
0494   4278             .print: 
0495   4278 C3 B3 57    	jp	printString
0496   427B             
0497   427B             ;-----------------------------------------------------------------------------
0498   427B             ;
0499   427B             ; Obtain driver version
0500   427B             ;
0501   427B             ; Input:  -
0502   427B             ; Output: A = Main version number
0503   427B             ;         B = Secondary version number
0504   427B             ;         C = Revision number
0505   427B             
0506   427B             DRV_VERSION: 
0507   427B 3E 01       	ld	a, VER_MAIN
0508   427D 06 00       	ld	b, VER_SEC
0509   427F 0E 06       	ld	c, VER_REV
0510   4281 C9          	ret
0511   4282             
0512   4282             
0513   4282             ;-----------------------------------------------------------------------------
0514   4282             ;
0515   4282             ; BASIC expanded statement ("CALL") handler.
0516   4282             ; Works the expected way, except that if invoking CALBAS is needed,
0517   4282             ; it must be done via the CALLB0 routine in kernel page 0.
0518   4282             
0519   4282             DRV_BASSTAT: 
0520   4282 37          	scf
0521   4283 C9          	ret
0522   4284             
0523   4284             
0524   4284             ;-----------------------------------------------------------------------------
0525   4284             ;
0526   4284             ; BASIC expanded device handler.
0527   4284             ; Works the expected way, except that if invoking CALBAS is needed,
0528   4284             ; it must be done via the CALLB0 routine in kernel page 0.
0529   4284             
0530   4284             DRV_BASDEV: 
0531   4284 37          	scf
0532   4285 C9          	ret
0533   4286             
0534   4286             ;-----------------------------------------------------------------------------
0535   4286             ;
0536   4286             ; Extended BIOS hook.
0537   4286             ; Works the expected way, except that it must return
0538   4286             ; D'=1 if the old hook must be called, D'=0 otherwise.
0539   4286             ; It is entered with D'=1.
0540   4286             
0541   4286             DRV_EXTBIO: 
0542   4286 C9          	ret
0543   4287             
0544   4287             ;-----------------------------------------------------------------------------
0545   4287             ;
0546   4287             ; Direct calls entry points.
0547   4287             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0548   4287             ; in kernel banks 0 and 3 will be redirected
0549   4287             ; to DIRECT0/1/2/3/4 respectively.
0550   4287             ; Receives all register data from the caller except IX and AF'.
0551   4287             
0552   4287             DRV_DIRECT0: 
0553   4287             DRV_DIRECT1: 
0554   4287             DRV_DIRECT2: 
0555   4287             DRV_DIRECT3: 
0556   4287             DRV_DIRECT4: 
0557   4287 C9          	ret
0558   4288             
0559   4288             
0560   4288             ;=====
0561   4288             ;=====  BEGIN of DEVICE-BASED specific routines
0562   4288             ;=====
0563   4288             
0564   4288             ;-----------------------------------------------------------------------------
0565   4288             ;
0566   4288             ; Read or write logical sectors from/to a logical unit
0567   4288             ;
0568   4288             ;Input:    Cy=0 to read, 1 to write
0569   4288             ;          A = Device number, 1 to 7
0570   4288             ;          B = Number of sectors to read or write
0571   4288             ;          C = Logical unit number, 1 to 7
0572   4288             ;          HL = Source or destination memory address for the transfer
0573   4288             ;          DE = Address where the 4 byte sector number is stored.
0574   4288             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0575   4288             ;              0: Ok
0576   4288             ;              .IDEVL: Invalid device or LUN
0577   4288             ;              .NRDY: Not ready
0578   4288             ;              .DISK: General unknown disk error
0579   4288             ;              .DATA: CRC error when reading
0580   4288             ;              .RNF: Sector not found
0581   4288             ;              .UFORM: Unformatted disk
0582   4288             ;              .WPROT: Write protected media, or read-only logical unit
0583   4288             ;              .WRERR: Write error
0584   4288             ;              .NCOMP: Incompatible disk.
0585   4288             ;              .SEEK: Seek error.
0586   4288             ;          B = Number of sectors actually read (in case of error only)
0587   4288             
0588   4288             DEV_RW: 
0589   4288 F5          	push	af
0590   428A BF FE 03    	cp	a, 3		; somente 2 dispositivos
0591   428C 30 10       	jr	nc,.saicomerroidl
0592   428E 0D          	dec	c		; somente 1 logical unit
0593   428F 20 0D       	jr	nz,.saicomerroidl
0594   4291 E5          	push	hl
0595   4292 CD 0E 44    	call	testaCartao	; verificar se cartao esta OK
0596   4295 E1          	pop	hl
0597   4296 30 0C       	jr	nc,.ok
0598   4298 F1          	pop	af		; retira AF guardado no inicio
0599   4299 3E FC       	ld	a, ENRDY	; Not ready
0600   429B             ;	ld	a, EDISK	; General unknown disk error
0601   429B 06 00       	ld	b, 0
0602   429D C9          	ret
0603   429E             .saicomerroidl: 
0604   429E F1          	pop	af		; retira AF guardado no inicio
0605   429F 3E B5       	ld	a, EIDEVL	; informar erro
0606   42A1 06 00       	ld	b, 0
0607   42A3 C9          	ret
0608   42A4             .ok: 
0609   42A4 FD 70 32    	ld	(iy+NUMBLOCOS), b	; guarda numero de blocos para ler/gravar
0610   42A7 E5          	push	hl
0611   42A8 D5          	push	de
0612   42A9 CD 47 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0613   42AC D1          	pop	de
0614   42AD E1          	pop	hl
0615   42AE F1          	pop	af		; retira AF guardado no inicio, para saber se eh leitura ou escrita
0616   42AF 38 1F       	jr	c,escrita	; se for escrita pulamos
0617   42B1             leitura: 
0618   42B1 1A          	ld	a, (de)		; 1. n. bloco
0619   42B2 F5          	push	af
0620   42B3 13          	inc	de
0621   42B4 1A          	ld	a, (de)		; 2. n. bloco
0622   42B5 F5          	push	af
0623   42B6 13          	inc	de
0624   42B7 1A          	ld	a, (de)		; 3. n. bloco
0625   42B8 4F          	ld	c, a
0626   42B9 13          	inc	de
0627   42BA 1A          	ld	a, (de)		; 4. n. bloco
0628   42BB 13          	inc	de
0629   42BC 47          	ld	b, a
0630   42BD F1          	pop	af
0631   42BE 57          	ld	d, a
0632   42BF F1          	pop	af		; HL = ponteiro destino
0633   42C0 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0634   42C1 CD 35 4F    	call	LerBloco	; chamar rotina de leitura de dados
0635   42C4 30 08       	jr	nc,.ok
0636   42C6 CD 30 44    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0637   42C9             ;	ld	a, ENRDY	; Not ready
0638   42C9 3E FD       	ld	a, EDISK	; General unknown disk error
0639   42CB 06 00       	ld	b, 0		; informar que lemos 0 blocos
0640   42CD C9          	ret
0641   42CE             .ok: 
0642   42CE AF          	xor	a		; tudo OK, informar ao Nextor
0643   42CF C9          	ret
0644   42D0             
0645   42D0             escrita: 
0646   42D0 CD 3B 44    	call	testaWP		; testar se cartao esta protegido contra escrita
0647   42D3 28 05       	jr	z,.ok
0648   42D5 3E F8       	ld	a, EWPROT	; disco protegido
0649   42D7 06 00       	ld	b, 0
0650   42D9 C9          	ret
0651   42DA             .ok: 
0652   42DA 1A          	ld	a, (de)		; 1. n. bloco
0653   42DB F5          	push	af
0654   42DC 13          	inc	de
0655   42DD 1A          	ld	a, (de)		; 2. n. bloco
0656   42DE F5          	push	af
0657   42DF 13          	inc	de
0658   42E0 1A          	ld	a, (de)		; 3. n. bloco
0659   42E1 13          	inc	de
0660   42E2 4F          	ld	c, a
0661   42E3 1A          	ld	a, (de)		; 4. n. bloco
0662   42E4 13          	inc	de
0663   42E5 47          	ld	b, a
0664   42E6 F1          	pop	af
0665   42E7 57          	ld	d, a
0666   42E8 F1          	pop	af		; HL = ponteiro destino
0667   42E9 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0668   42EA CD 6D 46    	call	GravarBloco	; chamar rotina de gravacao de dados
0669   42ED 30 08       	jr	nc,.ok2
0670   42EF CD 30 44    	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0671   42F2 3E FE       	ld	a,EWRERR	; Write error
0672   42F4 06 00       	ld	b,0
0673   42F6 C9          	ret
0674   42F7             .ok2: 
0675   42F7 AF          	xor	a			; gravacao sem erros!
0676   42F8 C9          	ret
0677   42F9             
0678   42F9             ;-----------------------------------------------------------------------------
0679   42F9             ;
0680   42F9             ; Device information gathering
0681   42F9             ;
0682   42F9             ;Input:   A = Device index, 1 to 7
0683   42F9             ;         B = Information to return:
0684   42F9             ;             0: Basic information
0685   42F9             ;             1: Manufacturer name string
0686   42F9             ;             2: Device name string
0687   42F9             ;             3: Serial number string
0688   42F9             ;         HL = Pointer to a buffer in RAM
0689   42F9             ;Output:  A = Error code:
0690   42F9             ;             0: Ok
0691   42F9             ;             1: Device not available or invalid device index
0692   42F9             ;             2: Information not available, or invalid information index
0693   42F9             ;         When basic information is requested,
0694   42F9             ;         buffer filled with the following information:
0695   42F9             ;
0696   42F9             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0697   42F9             ;        units (which is functionally equivalent to having only one).
0698   42F9             ;+1 (1): Device flags, always zero in Beta 2.
0699   42F9             ;
0700   42F9             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0701   42F9             ; left justified and padded with spaces. All the strings are optional,
0702   42F9             ; if not available, an error must be returned.
0703   42F9             ; If a string is provided by the device in binary format, it must be reported
0704   42F9             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0705   42F9             ; The maximum length for a string is 64 characters;
0706   42F9             ; if the string is actually longer, the leftmost 64 characters
0707   42F9             ; should be provided.
0708   42F9             ;
0709   42F9             ; In the case of the serial number string, the same rules for the strings
0710   42F9             ; apply, except that it must be provided right-justified,
0711   42F9             ; and if it is too long, the rightmost characters must be
0712   42F9             ; provided, not the leftmost.
0713   42F9             
0714   42F9             DEV_INFO: 
0715   42F9 04          	inc	b
0716   42FB BF FE 03    	cp	a,3		; somente 2 dispositivos
0717   42FD 30 07       	jr	nc,.saicomerro
0718   42FF E5          	push	hl
0719   4300 CD 0E 44    	call	testaCartao	; verificar se cartao esta OK
0720   4303 E1          	pop	hl
0721   4304 30 03       	jr	nc,.ok		; nao houve erro
0722   4306             .saicomerro: 
0723   4306 3E 01       	ld	a, 1		; informar erro
0724   4308 C9          	ret
0725   4309             
0726   4309             .ok: 
0727   4309 10 07       	djnz	.naoBasic
0728   430B             ; Basic information:
0729   430B 3E 01       	ld	a,1		; 1 logical unit somente
0730   430D 77          	ld	(hl), a
0731   430E AF          	xor	a		; reservado, deve ser 0
0732   430F 23          	inc	hl
0733   4310 77          	ld	(hl), a
0734   4311 C9          	ret			; retorna com A=0 (OK)
0735   4312             
0736   4312             .naoBasic: 
0737   4312 E5          	push	hl
0738   4313 CD 47 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0739   4316 E1          	pop	hl
0740   4317 10 25       	djnz	.naoManuf
0741   4319             ; Manufacturer Name:
0742   4319 E5          	push	hl		; salva ponteiro do buffer
0743   431A 06 40       	ld	b, 64		; preenche buffer com espaco
0744   431C 3E 20       	ld	a, ' '
0745   431E             .loop1: 
0746   431E 77          	ld	(hl), a
0747   431F 23          	inc	hl
0748   4320 10 FC       	djnz	.loop1
0749   4322 D1          	pop	de		; recuperamos ponteiro do buffer em DE
0750   4323 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0751   4325 12          	ld	(de), a
0752   4326 13          	inc	de
0753   4327 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0754   432A CD BC 57    	call	DecToAscii
0755   432D 3E 29       	ld	a, ')'
0756   432F 12          	ld	(de), a
0757   4330 13          	inc	de
0758   4331 3E 20       	ld	a, ' '
0759   4333 12          	ld	(de), a
0760   4334 13          	inc	de
0761   4335 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0762   4338 CD 2C 58    	call	pegaFabricante	; pegar nome do fabricante em HL
0763   433B ED B0       	ldir			; e colocar no buffer
0764   433D C9          	ret
0765   433E             
0766   433E             .naoManuf: 
0767   433E 10 1A       	djnz	.naoProduct
0768   4340             ; Product Name:
0769   4340 E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0770   4341 DD E5       	push	ix
0771   4343 E1          	pop	hl		; joga IX para HL
0772   4344 16 00       	ld	d, 0
0773   4346 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0774   4348 19          	add	hl, de
0775   4349 D1          	pop	de		; recupera buffer do Nextor em DE
0776   434A 01 05 00    	ld	bc, 5		; 5 caracteres
0777   434D ED B0       	ldir			; copia nome do produto
0778   434F EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0779   4350 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0780   4352 3E 20       	ld	a, ' '
0781   4354             .loop2: 
0782   4354 77          	ld	(hl), a
0783   4355 23          	inc	hl
0784   4356 10 FC       	djnz	.loop2
0785   4358 AF          	xor	a		; informar sem erros
0786   4359 C9          	ret
0787   435A             
0788   435A             .naoProduct: 
0789   435A             ; Serial:
0790   435A 3E 30       	ld	a, '0'		; Coloca prefixo "0x"
0791   435C 77          	ld	(hl), a
0792   435D 23          	inc	hl
0793   435E 3E 78       	ld	a, 'x'
0794   4360 77          	ld	(hl), a
0795   4361 23          	inc	hl
0796   4362 E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0797   4363 DD E5       	push	ix
0798   4365 E1          	pop	hl		; joga IX para HL
0799   4366 16 00       	ld	d, 0
0800   4368 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0801   436A 19          	add	hl, de
0802   436B D1          	pop	de		; recupera buffer do nextor em DE
0803   436C 06 04       	ld	b, 4		; 4 bytes do serial
0804   436E             .loop3: 
0805   436E 7E          	ld	a, (hl)
0806   436F CD EC 57    	call	HexToAscii	; converter HEXA para ASCII
0807   4372 23          	inc	hl
0808   4373 10 F9       	djnz	.loop3
0809   4375 06 36       	ld	b, 54		; Coloca espaco no restante
0810   4377 3E 20       	ld	a, ' '
0811   4379             .loop4: 
0812   4379 12          	ld	(de), a
0813   437A 13          	inc	de
0814   437B 10 FC       	djnz	.loop4
0815   437D AF          	xor	a		; informar sem erros
0816   437E C9          	ret
0817   437F             
0818   437F             ;-----------------------------------------------------------------------------
0819   437F             ;
0820   437F             ; Obtain device status
0821   437F             ;
0822   437F             ;Input:   A = Device index, 1 to 7
0823   437F             ;         B = Logical unit number, 1 to 7
0824   437F             ;             0 to return the status of the device itself.
0825   437F             ;Output:  A = Status for the specified logical unit,
0826   437F             ;             or for the whole device if 0 was specified:
0827   437F             ;                0: The device or logical unit is not available, or the
0828   437F             ;                   device or logical unit number supplied is invalid.
0829   437F             ;                1: The device or logical unit is available and has not
0830   437F             ;                   changed since the last status request.
0831   437F             ;                2: The device or logical unit is available and has changed
0832   437F             ;                   since the last status request
0833   437F             ;                   (for devices, the device has been unplugged and a
0834   437F             ;                    different device has been plugged which has been
0835   437F             ;                    assigned the same device index; for logical units,
0836   437F             ;                    the media has been changed).
0837   437F             ;                3: The device or logical unit is available, but it is not
0838   437F             ;                   possible to determine whether it has been changed
0839   437F             ;                   or not since the last status request.
0840   437F             ;
0841   437F             ; Devices not supporting hot-plugging must always return status value 1.
0842   437F             ; Non removable logical units may return values 0 and 1.
0843   437F             ;
0844   437F             ; The returned status is always relative to the previous invokation of
0845   437F             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0846   437F             
0847   437F             DEV_STATUS: 
0848   4380 BF FE 03    	cp	a,3		; 2 dispositivos somente
0849   4382 30 32       	jr	nc,.saicomerro
0850   4384 05          	dec	b		; 1 logical unit somente
0851   4385 20 2F       	jr	nz,.saicomerro
0852   4387             
0853   4387 F5          	push	af
0854   4388 CD F8 43    	call	pegaWorkArea	; HL=IY=Work area pointer
0855   438B F1          	pop	af
0856   438C FD 77 30    	ld	(iy+NUMSD),a	; salva numero do device atual (1 ou 2)
0857   438F 4F          	ld	c,a		; c=device number
0858   4390 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta inserido
0859   4393 A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
0860   4394 20 1D       	jr	nz,.cartaoComErro	; se slot do cartao estiver vazio, marcamos o erro nas flags
0861   4396 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
0862   4399 A1          	and	c
0863   439A 28 14       	jr	z,.semMudanca	; cartao nao marcado com erro, pula
0864   439C CD 6F 44    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0865   439F 38 12       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0866   43A1 FD 7E 30    	ld	a, (iy+NUMSD)		; conseguimos detectar, tira erro nas flags
0867   43A4 2F          	cpl			; inverte bits para fazer o AND
0868   43A5 4F          	ld	c, a
0869   43A6 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)
0870   43A9 A1          	and	c			; limpa bit
0871   43AA FD 77 31    	ld	(iy+FLAGSCARTAO), a
0872   43AD             .comMudanca: 
0873   43AD 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0874   43AF C9          	ret
0875   43B0             .semMudanca: 
0876   43B0 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0877   43B2 C9          	ret
0878   43B3             .cartaoComErro: 
0879   43B3 CD 30 44    	call	marcaErroCartao	; marcar erro do cartao nas flags
0880   43B6             .saicomerro: 
0881   43B6 3E 00       	ld	a, 0		; informa erro
0882   43B8 C9          	ret
0883   43B9             
0884   43B9             ;-----------------------------------------------------------------------------
0885   43B9             ;
0886   43B9             ; Obtain logical unit information
0887   43B9             ;
0888   43B9             ;Input:   A  = Device index, 1 to 7
0889   43B9             ;         B  = Logical unit number, 1 to 7
0890   43B9             ;         HL = Pointer to buffer in RAM.
0891   43B9             ;Output:  A = 0: Ok, buffer filled with information.
0892   43B9             ;             1: Error, device or logical unit not available,
0893   43B9             ;                or device index or logical unit number invalid.
0894   43B9             ;         On success, buffer filled with the following information:
0895   43B9             ;
0896   43B9             ;+0 (1): Medium type:
0897   43B9             ;        0: Block device
0898   43B9             ;        1: CD or DVD reader or recorder
0899   43B9             ;        2-254: Unused. Additional codes may be defined in the future.
0900   43B9             ;        255: Other
0901   43B9             ;+1 (2): Sector size, 0 if this information does not apply or is
0902   43B9             ;        not available.
0903   43B9             ;+3 (4): Total number of available sectors.
0904   43B9             ;        0 if this information does not apply or is not available.
0905   43B9             ;+7 (1): Flags:
0906   43B9             ;        bit 0: 1 if the medium is removable.
0907   43B9             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0908   43B9             ;               be write protected or write enabled is not considered
0909   43B9             ;               to be read-only.
0910   43B9             ;        bit 2: 1 if the LUN is a floppy disk drive.
0911   43B9             ;+8 (2): Number of cylinders
0912   43B9             ;+10 (1): Number of heads
0913   43B9             ;+11 (1): Number of sectors per track
0914   43B9             ;
0915   43B9             ; Number of cylinders, heads and sectors apply to hard disks only.
0916   43B9             ; For other types of device, these fields must be zero.
0917   43B9             
0918   43B9             LUN_INFO: 
0919   43BA BF FE 03    	cp	a, 3		; somente 2 dispositivo
0920   43BC 30 0A       	jr	nc,.saicomerro
0921   43BE 05          	dec	b		; somente 1 logical unit
0922   43BF 20 07       	jr	nz,.saicomerro
0923   43C1 E5          	push	hl
0924   43C2 CD 0E 44    	call	testaCartao
0925   43C5 E1          	pop	hl
0926   43C6 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0927   43C8             .saicomerro: 
0928   43C8 3E 01       	ld	a, 1		; informar erro
0929   43CA C9          	ret
0930   43CB             .ok: 
0931   43CB E5          	push	hl
0932   43CC CD 5B 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0933   43CF E1          	pop	hl		; do cartao dependendo do cartao atual solicitado
0934   43D0 AF          	xor	a
0935   43D1 77          	ld	(hl), a		; Informar que o dispositivo eh do tipo block device
0936   43D2 23          	inc	hl
0937   43D3 77          	ld	(hl), a		; tamanho de um bloco = 512 bytes (coloca $00, $02 que é $200 = 512)
0938   43D4 23          	inc	hl
0939   43D5 3E 02       	ld	a, 2
0940   43D7 77          	ld	(hl), a
0941   43D8 23          	inc	hl
0942   43D9 DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0943   43DC 77          	ld	(hl), a
0944   43DD 23          	inc	hl
0945   43DE DD 7E 01    	ld	a, (ix+1)
0946   43E1 77          	ld	(hl), a
0947   43E2 23          	inc	hl
0948   43E3 DD 7E 02    	ld	a, (ix+2)
0949   43E6 77          	ld	(hl), a
0950   43E7 23          	inc	hl
0951   43E8 AF          	xor	a		; cartoes SD tem total de blocos em 24 bits, mas o Nextor pede numero de
0952   43E9 77          	ld	(hl), a 	; 32 bits, entao coloca 0 no MSB
0953   43EA 23          	inc	hl
0954   43EB 3E 01       	ld	a, 1		; flags: dispositivo R/W removivel
0955   43ED 77          	ld	(hl), a
0956   43EE 23          	inc	hl
0957   43EF AF          	xor	a		; CHS = 0
0958   43F0 77          	ld	(hl), a
0959   43F1 23          	inc	hl
0960   43F2 77          	ld	(hl), a
0961   43F3 23          	inc	hl
0962   43F4 77          	ld	(hl), a
0963   43F5 23          	inc	hl
0964   43F6 AF          	xor	a		; informar que dados foram preenchidos
0965   43F7 C9          	ret
0966   43F8             
0967   43F8             ;=====
0968   43F8             ;=====  END of DEVICE-BASED specific routines
0969   43F8             ;=====
0970   43F8             
0971   43F8             ;------------------------------------------------
0972   43F8             ; Rotinas auxiliares
0973   43F8             ;------------------------------------------------
0974   43F8             
0975   43F8             ;------------------------------------------------
0976   43F8             ; Pedir ao Nextor o ponteiro de dados de trabalho
0977   43F8             ; na RAM e colocar em HL e IY
0978   43F8             ; Destroi HL e IY
0979   43F8             ;------------------------------------------------
0980   43F8             pegaWorkArea: 
0981   43F8 F5          	push	af
0982   43F9 AF          	xor	a		; Pegar endereco da area de trabalho
0983   43FA 08          	ex	af,af'
0984   43FB AF          	xor	a
0985   43FC DD 21 45 40 	ld	ix, GWORK
0986   4400 CD 42 40    	call	CALBNK
0987   4403 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
0988   4406 DD 66 01    	ld	h,(ix+1)
0989   4409 E5          	push	hl
0990   440A FD E1       	pop	iy		; em IY temos o mesmo ponteiro
0991   440C F1          	pop	af
0992   440D C9          	ret
0993   440E             
0994   440E             ;------------------------------------------------
0995   440E             ; Testa se cartao esta inserido e/ou houve erro
0996   440E             ; na ultima vez que foi acessado. Carry indica
0997   440E             ; erro
0998   440E             ; Destroi AF, HL, IX, C
0999   440E             ;------------------------------------------------
1000   440E             testaCartao: 
1001   440E F5          	push	af
1002   440F CD F8 43    	call	pegaWorkArea	; HL=IY=Work area pointer
1003   4412 F1          	pop	af
1004   4413 FD 77 30    	ld	(iy+NUMSD), a	; salva numero do device atual (1 ou 2)
1005   4416 4F          	ld	c, a
1006   4417 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta inserido
1007   441A A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
1008   441B 20 0A       	jr	nz,.saicomerro				
1009   441D FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
1010   4420 A1          	and	c
1011   4421 28 02       	jr	z,.ok
1012   4423 37          	scf			; indica erro
1013   4424 C9          	ret
1014   4425             .ok: 
1015   4425 AF          	xor	a		; zera carry indicando sem erro
1016   4426 C9          	ret
1017   4427             .saicomerro: 
1018   4427 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marca bit de erro nas flags
1019   442A B1          	or	c
1020   442B FD 77 31    	ld	(iy+FLAGSCARTAO), a
1021   442E 37          	scf
1022   442F C9          	ret
1023   4430             
1024   4430             ;------------------------------------------------
1025   4430             ; Marcar bit de erro nas flags
1026   4430             ; Destroi AF, C
1027   4430             ;------------------------------------------------
1028   4430             marcaErroCartao: 
1029   4430 FD 4E 30    	ld	c, (iy+NUMSD)		; cartao atual (1 ou 2)
1030   4433 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marcar erro
1031   4436 B1          	or	c
1032   4437 FD 77 31    	ld	(iy+FLAGSCARTAO), a
1033   443A C9          	ret
1034   443B             
1035   443B             ;------------------------------------------------
1036   443B             ; Testar se cartao atual esta protegido contra
1037   443B             ; gravacao, A=0 se protegido
1038   443B             ; Destroi AF, C
1039   443B             ;------------------------------------------------
1040   443B             testaWP: 
1041   443B FD 4E 30    	ld	c, (iy+NUMSD)	; cartao atual (1 ou 2)
1042   443E CB 01       	rlc	c		; desloca para apontar para bits 2 ou 3 para cartoes 1 ou 2 respectivamente
1043   4440 CB 01       	rlc	c
1044   4442 3A 00 7F    	ld	a, (SPISTATUS)	; testar se cartao esta protegido
1045   4445 A1          	and	c
1046   4446 C9          	ret			; se A for 0 cartao esta protegido
1047   4447             
1048   4447             ;------------------------------------------------
1049   4447             ; Calcula offset do buffer na RAM em HL e IX para
1050   4447             ; os dados do CID dependendo do cartao atual
1051   4447             ; Destroi AF, DE, HL e IX
1052   4447             ;------------------------------------------------
1053   4447             calculaCIDoffset: 
1054   4447 FD E5       	push	iy		; copiamos IY para HL
1055   4449 E1          	pop	hl
1056   444A 16 00       	ld	d, 0
1057   444C 1E 10       	ld	e, BCID1	; DE aponta para buffer BCID1
1058   444E FD 7E 30    	ld	a, (iy+NUMSD)	; vamos fazer IX apontar para o buffer correto
1059   4451 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1060   4452 28 02       	jr	z,.c1
1061   4454 1E 20       	ld	e, BCID2	; DE aponta para buffer BCID2
1062   4456             .c1: 
1063   4456 19          	add	hl, de		; HL aponta para buffer correto
1064   4457 E5          	push	hl		
1065   4458 DD E1       	pop	ix		; vamos colocar HL em IX
1066   445A C9          	ret
1067   445B             
1068   445B             ;------------------------------------------------
1069   445B             ; Calcula offset do buffer na RAM para os dados
1070   445B             ; do total de blocos dependendo do cartao atual
1071   445B             ; Offset fica em HL e IX
1072   445B             ; Destroi AF, DE, HL e IX
1073   445B             ;------------------------------------------------
1074   445B             calculaBLOCOSoffset: 
1075   445B FD E5       	push	iy		; copiamos IY para HL
1076   445D E1          	pop	hl
1077   445E 16 00       	ld	d, 0
1078   4460 1E 38       	ld	e, BLOCOS1	; DE aponta para buffer BLOCOS1
1079   4462 FD 7E 30    	ld	a, (iy+NUMSD)	; Vamos fazer IX apontar para o buffer correto
1080   4465 3D          	dec	a		; dependendo do cartao: BLOCOS1 ou BLOCOS2
1081   4466 28 02       	jr	z,.c1
1082   4468 1E 3C       	ld	e, BLOCOS2	; DE aponta para buffer BLOCOS2
1083   446A             .c1: 
1084   446A 19          	add	hl, de		; HL aponta para buffer correto
1085   446B E5          	push	hl		
1086   446C DD E1       	pop	ix		; Vamos colocar HL em IX
1087   446E C9          	ret
1088   446F             
1089   446F             
1090   446F             ;------------------------------------------------
1091   446F             ; Minhas funcoes para cartao SD
1092   446F             ;------------------------------------------------
1093   446F             
1094   446F             ;------------------------------------------------
1095   446F             ; Processo de inicializacao e deteccao do cartao.
1096   446F             ; Detecta se cartao responde, qual versao (SDV1
1097   446F             ; ou SDV2), faz a leitura do CSD e CID e calcula
1098   446F             ; o numero de blocos do cartao, colocando o CID
1099   446F             ; e total de blocos no buffer correto dependendo
1100   446F             ; do cartao 1 ou 2.
1101   446F             ; Retorna erro no carry. Se for 0 indica deteccao
1102   446F             ; com sucesso.
1103   446F             ; Destroi todos os registradores
1104   446F             ;------------------------------------------------
1105   446F             detectaCartao: 
1106   446F CD 9E 45    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1107   4472 D8          	ret	c			; retorna se erro
1108   4473 CD 3E 45    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1109   4476 D8          	ret	c
1110   4477 FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1111   4479 E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1112   447A 3E 49       	ld	a, CMD9		; ler CSD
1113   447C CD 5F 45    	call	lerBlocoCxD
1114   447F D8          	ret	c
1115   4480 CD 47 44    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1116   4483 3E 4A       	ld	a, CMD10	; ler CID
1117   4485 CD 5F 45    	call	lerBlocoCxD
1118   4488 D8          	ret	c
1119   4489 3E 7A       	ld	a, CMD58	; ler OCR
1120   448B 11 00 00    	ld	de, 0
1121   448E CD EF 45    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1122   4491 D8          	ret	c
1123   4492 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1124   4493 E6 40       	and	$40
1125   4495 DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1126   4498 CC 33 45    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1127   449B D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1128   449C CD BD 45    	call	desabilitaSDs
1129   449F             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1130   449F CD 5B 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1131   44A2 FD E5       	push	iy		; copiamos IY para HL
1132   44A4 E1          	pop	hl
1133   44A5 16 00       	ld	d, 0
1134   44A7 1E 05       	ld	e, BCSD+5
1135   44A9 19          	add	hl, de		; HL aponta para buffer BCSD+5
1136   44AA FD 7E 00    	ld	a, (iy+BCSD)
1137   44AD E6 C0       	and	$C0		; testa versao do registro CSD
1138   44AF 28 06       	jr	z,.calculaCSD1
1139   44B1 FE 40       	cp	$40
1140   44B3 28 54       	jr	z,.calculaCSD2
1141   44B5 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1142   44B6 C9          	ret
1143   44B7             
1144   44B7             ; -----------------------------------
1145   44B7             ; Registro CSD versao 1, calcular da
1146   44B7             ; maneira correta para a versao 1
1147   44B7             ; -----------------------------------
1148   44B7             .calculaCSD1: 
1149   44B7 7E          	ld	a, (hl)
1150   44B8 E6 0F       	and	$0F		; isola READ_BL_LEN
1151   44BA F5          	push	af
1152   44BB 23          	inc	hl
1153   44BC 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1154   44BD E6 03       	and	3
1155   44BF 57          	ld	d, a
1156   44C0 23          	inc	hl
1157   44C1 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1158   44C2 23          	inc	hl
1159   44C3 7E          	ld	a, (hl)
1160   44C4 E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1161   44C6 87          	add	a, a		; rotaciona a esquerda
1162   44C7 CB 13       	rl	e		; rotaciona para DE
1163   44C9 CB 12       	rl	d
1164   44CB 87          	add	a, a		; mais uma rotacao
1165   44CC CB 13       	rl	e		; rotaciona para DE
1166   44CE CB 12       	rl	d
1167   44D0 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1168   44D1 23          	inc	hl
1169   44D2 7E          	ld	a, (hl)		; proximo byte
1170   44D3 E6 03       	and	3		; 2 bits de C_SIZE_MUL
1171   44D5 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1172   44D6 23          	inc	hl						
1173   44D7 7E          	ld	a, (hl)		; proximo byte
1174   44D8 E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1175   44DA 87          	add	a, a		; rotaciona para esquerda jogando no carry
1176   44DB CB 10       	rl	b		; rotaciona para B
1177   44DD 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1178   44DE 04          	inc	b		; faz B = C_SIZE_MUL + 2
1179   44DF F1          	pop	af		; volta em A o READ_BL_LEN
1180   44E0 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1181   44E1 01 00 00    	ld	bc, 0
1182   44E4 CD FD 44    	call	.eleva2
1183   44E7 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1184   44E8 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1185   44E9 48          	ld	c, b
1186   44EA 06 00       	ld	b, 0
1187   44EC CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1188   44EE CB 1A       	rr	d		; rotacionamos D e E
1189   44F0 CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1190   44F2             .salvaBlocos: 
1191   44F2 DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1192   44F5 DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1193   44F8 DD 73 00    	ld	(ix), e
1194   44FB AF          	xor	a		; limpa carry
1195   44FC C9          	ret
1196   44FD             
1197   44FD             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1198   44FD             				; BC = 0
1199   44FD             				; DE = C_SIZE
1200   44FD CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1201   44FF CB 12       	rl	d
1202   4501 CB 11       	rl	c
1203   4503 CB 10       	rl	b
1204   4505 3D          	dec	a		; subtraimos 1
1205   4506 20 F5       	jr	nz,.eleva2
1206   4508 C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1207   4509             
1208   4509             ; -----------------------------------
1209   4509             ; Registro CSD versao 2, calcular da
1210   4509             ; maneira correta para a versao 2
1211   4509             ; -----------------------------------
1212   4509             .calculaCSD2: 
1213   4509 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1214   450A 23          	inc	hl
1215   450B 7E          	ld	a, (hl)
1216   450C E6 3F       	and	$3F
1217   450E 4F          	ld	c, a
1218   450F 23          	inc	hl
1219   4510 56          	ld	d, (hl)
1220   4511 23          	inc	hl
1221   4512 5E          	ld	e, (hl)
1222   4513 CD 1F 45    	call	.inc32		; soma 1
1223   4516 CD 27 45    	call	.desloca32	; multiplica por 512
1224   4519 CD 2C 45    	call	.rotaciona24	; multiplica por 2
1225   451C C3 F2 44    	jp		.salvaBlocos
1226   451F             
1227   451F             .inc32: 
1228   451F 1C          	inc	e
1229   4520 C0          	ret	nz
1230   4521 14          	inc	d
1231   4522 C0          	ret	nz
1232   4523 0C          	inc	c
1233   4524 C0          	ret	nz
1234   4525 04          	inc	b
1235   4526 C9          	ret
1236   4527             
1237   4527             .desloca32: 
1238   4527 41          	ld	b, c
1239   4528 4A          	ld	c, d
1240   4529 53          	ld	d, e
1241   452A 1E 00       	ld	e, 0
1242   452C             .rotaciona24: 
1243   452C CB 22       	sla	d
1244   452E CB 11       	rl	c
1245   4530 CB 10       	rl	b
1246   4532 C9          	ret
1247   4533             
1248   4533             ; ------------------------------------------------
1249   4533             ; Setar o tamanho do bloco para 512 se o cartao
1250   4533             ; for SDV1
1251   4533             ; ------------------------------------------------
1252   4533             mudarTamanhoBlocoPara512: 
1253   4533 3E 50       	ld	a, CMD16
1254   4535 01 00 00    	ld	bc, 0
1255   4538 11 00 02    	ld	de, 512
1256   453B C3 DA 45    	jp	SD_SEND_CMD_GET_ERROR
1257   453E             
1258   453E             ; ------------------------------------------------
1259   453E             ; Tenta inicializar um cartao SDV2, se houver erro
1260   453E             ; o cartao deve ser SDV1
1261   453E             ; ------------------------------------------------
1262   453E             testaSDCV2: 
1263   453E 3E 48       	ld	a, CMD8
1264   4540 11 AA 01    	ld	de, $1AA
1265   4543 CD EF 45    	call	SD_SEND_CMD_2_ARGS_GET_R3
1266   4546 21 D3 45    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1267   4549 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1268   454B 21 C5 45    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1269   454E             .pula: 
1270   454E 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1271   4551             .loop: 
1272   4551 C5          	push	bc
1273   4552 CD 5E 45    	call	.jumpHL		; chamar rotina correta em HL
1274   4555 C1          	pop	bc
1275   4556 D0          	ret	nc
1276   4557 10 F8       	djnz	.loop
1277   4559 0D          	dec	c
1278   455A 20 F5       	jr	nz,.loop
1279   455C 37          	scf
1280   455D C9          	ret
1281   455E             .jumpHL: 
1282   455E E9          	jp	(hl)		; chamar rotina correta em HL
1283   455F             
1284   455F             ; ------------------------------------------------
1285   455F             ; Ler registro CID ou CSD, o comando vem em A
1286   455F             ; ------------------------------------------------
1287   455F             lerBlocoCxD: 
1288   455F CD D5 45    	call	SD_SEND_CMD_NO_ARGS
1289   4562 D8          	ret	c
1290   4563 CD 34 46    	call	WAIT_RESP_FE
1291   4566 D8          	ret	c
1292   4567 EB          	ex	de,hl
1293   4568             
1294   4568             	; Check for a Z80 or R800
1295   4568             ;	or 	a		; Clear Cy
1296   4568 3E 14       	ld	a,20
1297   456A ED F9       	db	#ED,#F9		; mulub a,a
1298   456C 21 00 7B    	ld	hl, SPIDATA
1299   456F 38 26       	jr	c,.r800		; Use LDIR for R800
1300   4571 ED A0       > ldi	
1300   4573 ED A0       > ldi	
1300   4575 ED A0       > ldi	
1300   4577 ED A0       > ldi	
1300   4579 ED A0       > ldi	
1300   457B ED A0       > ldi	
1300   457D ED A0       > ldi	
1300   457F ED A0       > ldi	
1300   4581 ED A0       > ldi	
1300   4583 ED A0       > ldi	
1300   4585 ED A0       > ldi	
1300   4587 ED A0       > ldi	
1300   4589 ED A0       > ldi	
1300   458B ED A0       > ldi	
1300   458D ED A0       > ldi	
1300   458F ED A0       > ldi	
1301   4591             .end
1302   4591 7E           	ld	a, (hl)
1303   4592 7E          	ld	a, (hl)		; byte de resposta
1304   4593 B7          	or	a
1305   4594 EB          	ex	de,hl
1306   4595 18 26       	jr		desabilitaSDs
1307   4597             
1308   4597             .r800: 
1309   4597 01 10 00    	ld	bc,16
1310   459A ED B0       	ldir
1311   459C 18 F3       	jr	.end
1312   459E             
1313   459E             ; ------------------------------------------------
1314   459E             ; Algoritmo para inicializar um cartao SD
1315   459E             ; Destroi AF, B, DE
1316   459E             ; ------------------------------------------------
1317   459E             iniciaSD: 
1318   459E CD BD 45    	call	desabilitaSDs
1319   45A1             
1320   45A1 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1321   45A3             enviaClocksInicio: 
1322   45A3 3E FF       	ld	a, $FF		; manter MOSI em 1
1323   45A5 32 00 7B    	ld	(SPIDATA), a
1324   45A8 10 F9       	djnz	enviaClocksInicio
1325   45AA CD 60 46    	call	setaSDAtual	; ativar cartao atual
1326   45AD 06 08       	ld	b, 8		; 8 tentativas para CMD0
1327   45AF             SD_SEND_CMD0: 
1328   45AF 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1329   45B1 11 00 00    	ld	de, 0
1330   45B4 C5          	push	bc
1331   45B5 CD E2 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1332   45B8 C1          	pop	bc
1333   45B9 D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1334   45BA 10 F3       	djnz	SD_SEND_CMD0
1335   45BC 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1336   45BD             	; fall throw
1337   45BD             
1338   45BD             ; ------------------------------------------------
1339   45BD             ; Desabilitar (de-selecionar) todos os cartoes
1340   45BD             ; Nao destroi registradores
1341   45BD             ; ------------------------------------------------
1342   45BD             desabilitaSDs: 
1343   45BD F5          	push	af
1344   45BE 3E FF       	ld	a, $FF		; todos os /CS em 1
1345   45C0 32 00 7F    	ld	(SPICTRL), a
1346   45C3 F1          	pop	af
1347   45C4 C9          	ret
1348   45C5             
1349   45C5             ; ------------------------------------------------
1350   45C5             ; Enviar comando ACMD41
1351   45C5             ; ------------------------------------------------
1352   45C5             SD_SEND_ACMD41: 
1353   45C5 3E 77       	ld	a, CMD55
1354   45C7 CD D5 45    	call	SD_SEND_CMD_NO_ARGS
1355   45CA 3E 69       	ld	a, ACMD41
1356   45CC 01 00 40    	ld	bc, $4000
1357   45CF 51          	ld	d, c
1358   45D0 59          	ld	e, c
1359   45D1 18 07       	jr		SD_SEND_CMD_GET_ERROR
1360   45D3             
1361   45D3             ; ------------------------------------------------
1362   45D3             ; Enviar CMD1 para cartao. Carry indica erro
1363   45D3             ; Destroi AF, BC, DE
1364   45D3             ; ------------------------------------------------
1365   45D3             SD_SEND_CMD1: 
1366   45D3 3E 41       	ld	a, CMD1
1367   45D5             SD_SEND_CMD_NO_ARGS: 
1368   45D5 01 00 00    	ld	bc, 0
1369   45D8 50          	ld	d, b
1370   45D9 59          	ld	e, c
1371   45DA             SD_SEND_CMD_GET_ERROR: 
1372   45DA CD 08 46    	call	SD_SEND_CMD
1373   45DD B7          	or	a
1374   45DE C8          	ret	z			; se A=0 nao houve erro, retornar
1375   45DF             	; fall throw
1376   45DF             
1377   45DF             ; ------------------------------------------------
1378   45DF             ; Informar erro
1379   45DF             ; Nao destroi registradores
1380   45DF             ; ------------------------------------------------
1381   45DF             setaErro: 
1382   45DF 37          	scf
1383   45E0 18 DB       	jr		desabilitaSDs
1384   45E2             
1385   45E2             ; ------------------------------------------------
1386   45E2             ; Enviar comando em A com 2 bytes de parametros
1387   45E2             ; em DE e testar retorno BUSY
1388   45E2             ; Retorna em A a resposta do cartao
1389   45E2             ; Destroi AF, BC
1390   45E2             ; ------------------------------------------------
1391   45E2             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1392   45E2 01 00 00    	ld	bc, 0
1393   45E5 CD 08 46    	call	SD_SEND_CMD
1394   45E8 47          	ld	b, a
1395   45E9 E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1396   45EB 78          	ld	a, b
1397   45EC 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1398   45EE C9          	ret			; sem erros
1399   45EF             
1400   45EF             ; ------------------------------------------------
1401   45EF             ; Enviar comando em A com 2 bytes de parametros
1402   45EF             ; em DE e ler resposta do tipo R3 em BC DE
1403   45EF             ; Retorna em A a resposta do cartao
1404   45EF             ; Destroi AF, BC, DE, HL
1405   45EF             ; ------------------------------------------------
1406   45EF             SD_SEND_CMD_2_ARGS_GET_R3: 
1407   45EF CD E2 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1408   45F2 D8          	ret	c
1409   45F3 F5          	push	af
1410   45F4 CD 42 46    	call	WAIT_RESP_NO_FF
1411   45F7 67          	ld	h, a
1412   45F8 CD 42 46    	call	WAIT_RESP_NO_FF
1413   45FB 6F          	ld	l, a
1414   45FC CD 42 46    	call	WAIT_RESP_NO_FF
1415   45FF 57          	ld	d, a
1416   4600 CD 42 46    	call	WAIT_RESP_NO_FF
1417   4603 5F          	ld	e, a
1418   4604 44          	ld	b, h
1419   4605 4D          	ld	c, l
1420   4606 F1          	pop	af
1421   4607 C9          	ret
1422   4608             
1423   4608             ; ------------------------------------------------
1424   4608             ; Enviar comando em A com 4 bytes de parametros
1425   4608             ; em BC DE e enviar CRC correto se for CMD0 ou 
1426   4608             ; CMD8 e aguardar processamento do cartao
1427   4608             ; Destroi AF, BC
1428   4608             ; ------------------------------------------------
1429   4608             SD_SEND_CMD: 
1430   4608 CD 60 46    	call	setaSDAtual
1431   460B 32 00 7B    	ld	(SPIDATA), a
1432   460E F5          	push	af
1433   460F 78          	ld	a, b
1434   4610 32 00 7B    	ld	(SPIDATA), a
1435   4613 79          	ld	a, c
1436   4614 32 00 7B    	ld	(SPIDATA), a
1437   4617 7A          	ld	a, d
1438   4618 32 00 7B    	ld	(SPIDATA), a
1439   461B 7B          	ld	a, e
1440   461C 32 00 7B    	ld	(SPIDATA), a
1441   461F F1          	pop	af
1442   4620 FE 40       	cp	CMD0
1443   4622 06 95       	ld	b, $95		; CRC para CMD0
1444   4624 28 08       	jr	z,enviaCRC
1445   4626 FE 48       	cp	CMD8
1446   4628 06 87       	ld	b, $87		; CRC para CMD8
1447   462A 28 02       	jr	z,enviaCRC
1448   462C 06 FF       	ld	b, $FF		; CRC dummy
1449   462E             enviaCRC: 
1450   462E 78          	ld	a, b
1451   462F 32 00 7B    	ld	(SPIDATA), a
1452   4632 18 0E       	jr	WAIT_RESP_NO_FF
1453   4634             
1454   4634             ; ------------------------------------------------
1455   4634             ; Esperar que resposta do cartao seja $FE
1456   4634             ; Destroi AF, B
1457   4634             ; ------------------------------------------------
1458   4634             WAIT_RESP_FE: 
1459   4634 06 0A       	ld	b, 10		; 10 tentativas
1460   4636             .loop: 
1461   4636 C5          	push	bc
1462   4637 CD 42 46    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1463   463A C1          	pop	bc
1464   463B FE FE       	cp	$FE		; resposta é $FE ?
1465   463D C8          	ret	z		; sim, retornamos com carry=0
1466   463E 10 F6       	djnz	.loop
1467   4640 37          	scf			; erro, carry=1
1468   4641 C9          	ret
1469   4642             
1470   4642             ; ------------------------------------------------
1471   4642             ; Esperar que resposta do cartao seja diferente
1472   4642             ; de $FF
1473   4642             ; Destroi AF, BC
1474   4642             ; ------------------------------------------------
1475   4642             WAIT_RESP_NO_FF: 
1476   4642 01 01 00    	ld	bc, 1		; 256 tentativas
1477   4645             .loop: 
1478   4645 3A 00 7B    	ld	a, (SPIDATA)
1479   4648 FE FF       	cp	$FF		; testa $FF
1480   464A C0          	ret		nz		; sai se nao for $FF
1481   464B 10 F8       	djnz	.loop
1482   464D 0D          	dec	c
1483   464E 20 F5       	jr	nz,.loop
1484   4650 C9          	ret
1485   4651             
1486   4651             ; ------------------------------------------------
1487   4651             ; Esperar que resposta do cartao seja diferente
1488   4651             ; de $00
1489   4651             ; Destroi A, BC
1490   4651             ; ------------------------------------------------
1491   4651             WAIT_RESP_NO_00: 
1492   4651 01 80 00    	ld	bc, 128		; 32768 tentativas
1493   4654             .loop: 
1494   4654 3A 00 7B    	ld	a, (SPIDATA)
1495   4657 B7          	or	a
1496   4658 C0          	ret	nz			; se resposta for <> $00, sai
1497   4659 10 F9       	djnz	.loop
1498   465B 0D          	dec	c
1499   465C 20 F6       	jr	nz,.loop
1500   465E 37          	scf			; erro
1501   465F C9          	ret
1502   4660             
1503   4660             ; ------------------------------------------------
1504   4660             ; Ativa (seleciona) cartao atual baixando seu /CS
1505   4660             ; Nao destroi registradores
1506   4660             ; ------------------------------------------------
1507   4660             setaSDAtual: 
1508   4660 F5          	push	af
1509   4661 3A 00 7B    	ld	a, (SPIDATA)	; dummy read
1510   4664 FD 7E 30    	ld	a, (iy+NUMSD)
1511   4667 2F          	cpl			; inverte bits
1512   4668 32 00 7F    	ld	(SPICTRL), a
1513   466B F1          	pop	af
1514   466C C9          	ret
1515   466D             
1516   466D             
1517   466D             ; ------------------------------------------------
1518   466D             ; Grava um bloco de 512 bytes no cartao
1519   466D             ; HL aponta para o inicio dos dados
1520   466D             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1521   466D             ; Destroi AF, BC, DE, HL
1522   466D             ; ------------------------------------------------
1523   466D             GravarBloco: 
1524   466D DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1525   4670 B7          	or	a
1526   4671 CC A7 57    	call	z,blocoParaByte		; se for SDV1 coverter blocos para bytes
1527   4674 CD 60 46    	call	setaSDAtual	; selecionar cartao atual
1528   4677 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer gravar 1 ou mais blocos
1529   467A 3D          	dec	a
1530   467B CA F8 4A    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1531   467E             
1532   467E             ; multiplos blocos
1533   467E C5          	push	bc
1534   467F D5          	push	de
1535   4680 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1536   4682 CD D5 45    	call	SD_SEND_CMD_NO_ARGS
1537   4685 3E 57       	ld	a, ACMD23
1538   4687 01 00 00    	ld	bc, 0
1539   468A 51          	ld	d, c
1540   468B FD 5E 32    	ld	e, (iy+NUMBLOCOS)	; parametro = total de blocos a gravar
1541   468E CD DA 45    	call	SD_SEND_CMD_GET_ERROR
1542   4691 D1          	pop	de
1543   4692 C1          	pop	bc
1544   4693 DA 2F 4F    	jp	c,terminaLeituraEscritaBloco	; erro no ACMD23
1545   4696 3E 59       	ld	a, CMD25	; comando CMD25 = write multiple blocks
1546   4698 CD DA 45    	call	SD_SEND_CMD_GET_ERROR
1547   469B DA 2F 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1548   469E             .loop: 
1549   469E 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados sao
1550   46A0 32 00 7B    	ld	(SPIDATA),a	; dados para gravacao
1551   46A3             	; Check for a Z80 or R800
1552   46A3 EB          	ex	de,hl
1553   46A4             ;	or 	a		; Clear Cy
1554   46A4 3E 14       	ld	a,20
1555   46A6 ED F9       	db	#ED,#F9		; mulub a,a
1556   46A8 EB          	ex	de,hl
1557   46A9 11 00 7B    	ld	de, SPIDATA
1558   46AC DA E9 4A    	jp	c,.r800m	; Use LDIR for R800
1559   46AF ED A0       > ldi		
1559   46B1 ED A0       > ldi		
1559   46B3 ED A0       > ldi		
1559   46B5 ED A0       > ldi		
1559   46B7 ED A0       > ldi		
1559   46B9 ED A0       > ldi		
1559   46BB ED A0       > ldi		
1559   46BD ED A0       > ldi		
1559   46BF ED A0       > ldi		
1559   46C1 ED A0       > ldi		
1559   46C3 ED A0       > ldi		
1559   46C5 ED A0       > ldi		
1559   46C7 ED A0       > ldi		
1559   46C9 ED A0       > ldi		
1559   46CB ED A0       > ldi		
1559   46CD ED A0       > ldi		
1559   46CF ED A0       > ldi		
1559   46D1 ED A0       > ldi		
1559   46D3 ED A0       > ldi		
1559   46D5 ED A0       > ldi		
1559   46D7 ED A0       > ldi		
1559   46D9 ED A0       > ldi		
1559   46DB ED A0       > ldi		
1559   46DD ED A0       > ldi		
1559   46DF ED A0       > ldi		
1559   46E1 ED A0       > ldi		
1559   46E3 ED A0       > ldi		
1559   46E5 ED A0       > ldi		
1559   46E7 ED A0       > ldi		
1559   46E9 ED A0       > ldi		
1559   46EB ED A0       > ldi		
1559   46ED ED A0       > ldi		
1559   46EF ED A0       > ldi		
1559   46F1 ED A0       > ldi		
1559   46F3 ED A0       > ldi		
1559   46F5 ED A0       > ldi		
1559   46F7 ED A0       > ldi		
1559   46F9 ED A0       > ldi		
1559   46FB ED A0       > ldi		
1559   46FD ED A0       > ldi		
1559   46FF ED A0       > ldi		
1559   4701 ED A0       > ldi		
1559   4703 ED A0       > ldi		
1559   4705 ED A0       > ldi		
1559   4707 ED A0       > ldi		
1559   4709 ED A0       > ldi		
1559   470B ED A0       > ldi		
1559   470D ED A0       > ldi		
1559   470F ED A0       > ldi		
1559   4711 ED A0       > ldi		
1559   4713 ED A0       > ldi		
1559   4715 ED A0       > ldi		
1559   4717 ED A0       > ldi		
1559   4719 ED A0       > ldi		
1559   471B ED A0       > ldi		
1559   471D ED A0       > ldi		
1559   471F ED A0       > ldi		
1559   4721 ED A0       > ldi		
1559   4723 ED A0       > ldi		
1559   4725 ED A0       > ldi		
1559   4727 ED A0       > ldi		
1559   4729 ED A0       > ldi		
1559   472B ED A0       > ldi		
1559   472D ED A0       > ldi		
1559   472F ED A0       > ldi		
1559   4731 ED A0       > ldi		
1559   4733 ED A0       > ldi		
1559   4735 ED A0       > ldi		
1559   4737 ED A0       > ldi		
1559   4739 ED A0       > ldi		
1559   473B ED A0       > ldi		
1559   473D ED A0       > ldi		
1559   473F ED A0       > ldi		
1559   4741 ED A0       > ldi		
1559   4743 ED A0       > ldi		
1559   4745 ED A0       > ldi		
1559   4747 ED A0       > ldi		
1559   4749 ED A0       > ldi		
1559   474B ED A0       > ldi		
1559   474D ED A0       > ldi		
1559   474F ED A0       > ldi		
1559   4751 ED A0       > ldi		
1559   4753 ED A0       > ldi		
1559   4755 ED A0       > ldi		
1559   4757 ED A0       > ldi		
1559   4759 ED A0       > ldi		
1559   475B ED A0       > ldi		
1559   475D ED A0       > ldi		
1559   475F ED A0       > ldi		
1559   4761 ED A0       > ldi		
1559   4763 ED A0       > ldi		
1559   4765 ED A0       > ldi		
1559   4767 ED A0       > ldi		
1559   4769 ED A0       > ldi		
1559   476B ED A0       > ldi		
1559   476D ED A0       > ldi		
1559   476F ED A0       > ldi		
1559   4771 ED A0       > ldi		
1559   4773 ED A0       > ldi		
1559   4775 ED A0       > ldi		
1559   4777 ED A0       > ldi		
1559   4779 ED A0       > ldi		
1559   477B ED A0       > ldi		
1559   477D ED A0       > ldi		
1559   477F ED A0       > ldi		
1559   4781 ED A0       > ldi		
1559   4783 ED A0       > ldi		
1559   4785 ED A0       > ldi		
1559   4787 ED A0       > ldi		
1559   4789 ED A0       > ldi		
1559   478B ED A0       > ldi		
1559   478D ED A0       > ldi		
1559   478F ED A0       > ldi		
1559   4791 ED A0       > ldi		
1559   4793 ED A0       > ldi		
1559   4795 ED A0       > ldi		
1559   4797 ED A0       > ldi		
1559   4799 ED A0       > ldi		
1559   479B ED A0       > ldi		
1559   479D ED A0       > ldi		
1559   479F ED A0       > ldi		
1559   47A1 ED A0       > ldi		
1559   47A3 ED A0       > ldi		
1559   47A5 ED A0       > ldi		
1559   47A7 ED A0       > ldi		
1559   47A9 ED A0       > ldi		
1559   47AB ED A0       > ldi		
1559   47AD ED A0       > ldi		
1559   47AF ED A0       > ldi		
1559   47B1 ED A0       > ldi		
1559   47B3 ED A0       > ldi		
1559   47B5 ED A0       > ldi		
1559   47B7 ED A0       > ldi		
1559   47B9 ED A0       > ldi		
1559   47BB ED A0       > ldi		
1559   47BD ED A0       > ldi		
1559   47BF ED A0       > ldi		
1559   47C1 ED A0       > ldi		
1559   47C3 ED A0       > ldi		
1559   47C5 ED A0       > ldi		
1559   47C7 ED A0       > ldi		
1559   47C9 ED A0       > ldi		
1559   47CB ED A0       > ldi		
1559   47CD ED A0       > ldi		
1559   47CF ED A0       > ldi		
1559   47D1 ED A0       > ldi		
1559   47D3 ED A0       > ldi		
1559   47D5 ED A0       > ldi		
1559   47D7 ED A0       > ldi		
1559   47D9 ED A0       > ldi		
1559   47DB ED A0       > ldi		
1559   47DD ED A0       > ldi		
1559   47DF ED A0       > ldi		
1559   47E1 ED A0       > ldi		
1559   47E3 ED A0       > ldi		
1559   47E5 ED A0       > ldi		
1559   47E7 ED A0       > ldi		
1559   47E9 ED A0       > ldi		
1559   47EB ED A0       > ldi		
1559   47ED ED A0       > ldi		
1559   47EF ED A0       > ldi		
1559   47F1 ED A0       > ldi		
1559   47F3 ED A0       > ldi		
1559   47F5 ED A0       > ldi		
1559   47F7 ED A0       > ldi		
1559   47F9 ED A0       > ldi		
1559   47FB ED A0       > ldi		
1559   47FD ED A0       > ldi		
1559   47FF ED A0       > ldi		
1559   4801 ED A0       > ldi		
1559   4803 ED A0       > ldi		
1559   4805 ED A0       > ldi		
1559   4807 ED A0       > ldi		
1559   4809 ED A0       > ldi		
1559   480B ED A0       > ldi		
1559   480D ED A0       > ldi		
1559   480F ED A0       > ldi		
1559   4811 ED A0       > ldi		
1559   4813 ED A0       > ldi		
1559   4815 ED A0       > ldi		
1559   4817 ED A0       > ldi		
1559   4819 ED A0       > ldi		
1559   481B ED A0       > ldi		
1559   481D ED A0       > ldi		
1559   481F ED A0       > ldi		
1559   4821 ED A0       > ldi		
1559   4823 ED A0       > ldi		
1559   4825 ED A0       > ldi		
1559   4827 ED A0       > ldi		
1559   4829 ED A0       > ldi		
1559   482B ED A0       > ldi		
1559   482D ED A0       > ldi		
1559   482F ED A0       > ldi		
1559   4831 ED A0       > ldi		
1559   4833 ED A0       > ldi		
1559   4835 ED A0       > ldi		
1559   4837 ED A0       > ldi		
1559   4839 ED A0       > ldi		
1559   483B ED A0       > ldi		
1559   483D ED A0       > ldi		
1559   483F ED A0       > ldi		
1559   4841 ED A0       > ldi		
1559   4843 ED A0       > ldi		
1559   4845 ED A0       > ldi		
1559   4847 ED A0       > ldi		
1559   4849 ED A0       > ldi		
1559   484B ED A0       > ldi		
1559   484D ED A0       > ldi		
1559   484F ED A0       > ldi		
1559   4851 ED A0       > ldi		
1559   4853 ED A0       > ldi		
1559   4855 ED A0       > ldi		
1559   4857 ED A0       > ldi		
1559   4859 ED A0       > ldi		
1559   485B ED A0       > ldi		
1559   485D ED A0       > ldi		
1559   485F ED A0       > ldi		
1559   4861 ED A0       > ldi		
1559   4863 ED A0       > ldi		
1559   4865 ED A0       > ldi		
1559   4867 ED A0       > ldi		
1559   4869 ED A0       > ldi		
1559   486B ED A0       > ldi		
1559   486D ED A0       > ldi		
1559   486F ED A0       > ldi		
1559   4871 ED A0       > ldi		
1559   4873 ED A0       > ldi		
1559   4875 ED A0       > ldi		
1559   4877 ED A0       > ldi		
1559   4879 ED A0       > ldi		
1559   487B ED A0       > ldi		
1559   487D ED A0       > ldi		
1559   487F ED A0       > ldi		
1559   4881 ED A0       > ldi		
1559   4883 ED A0       > ldi		
1559   4885 ED A0       > ldi		
1559   4887 ED A0       > ldi		
1559   4889 ED A0       > ldi		
1559   488B ED A0       > ldi		
1559   488D ED A0       > ldi		
1559   488F ED A0       > ldi		
1559   4891 ED A0       > ldi		
1559   4893 ED A0       > ldi		
1559   4895 ED A0       > ldi		
1559   4897 ED A0       > ldi		
1559   4899 ED A0       > ldi		
1559   489B ED A0       > ldi		
1559   489D ED A0       > ldi		
1559   489F ED A0       > ldi		
1559   48A1 ED A0       > ldi		
1559   48A3 ED A0       > ldi		
1559   48A5 ED A0       > ldi		
1559   48A7 ED A0       > ldi		
1559   48A9 ED A0       > ldi		
1559   48AB ED A0       > ldi		
1559   48AD ED A0       > ldi		
1559   48AF ED A0       > ldi		
1559   48B1 ED A0       > ldi		
1559   48B3 ED A0       > ldi		
1559   48B5 ED A0       > ldi		
1559   48B7 ED A0       > ldi		
1559   48B9 ED A0       > ldi		
1559   48BB ED A0       > ldi		
1559   48BD ED A0       > ldi		
1559   48BF ED A0       > ldi		
1559   48C1 ED A0       > ldi		
1559   48C3 ED A0       > ldi		
1559   48C5 ED A0       > ldi		
1559   48C7 ED A0       > ldi		
1559   48C9 ED A0       > ldi		
1559   48CB ED A0       > ldi		
1559   48CD ED A0       > ldi		
1559   48CF ED A0       > ldi		
1559   48D1 ED A0       > ldi		
1559   48D3 ED A0       > ldi		
1559   48D5 ED A0       > ldi		
1559   48D7 ED A0       > ldi		
1559   48D9 ED A0       > ldi		
1559   48DB ED A0       > ldi		
1559   48DD ED A0       > ldi		
1559   48DF ED A0       > ldi		
1559   48E1 ED A0       > ldi		
1559   48E3 ED A0       > ldi		
1559   48E5 ED A0       > ldi		
1559   48E7 ED A0       > ldi		
1559   48E9 ED A0       > ldi		
1559   48EB ED A0       > ldi		
1559   48ED ED A0       > ldi		
1559   48EF ED A0       > ldi		
1559   48F1 ED A0       > ldi		
1559   48F3 ED A0       > ldi		
1559   48F5 ED A0       > ldi		
1559   48F7 ED A0       > ldi		
1559   48F9 ED A0       > ldi		
1559   48FB ED A0       > ldi		
1559   48FD ED A0       > ldi		
1559   48FF ED A0       > ldi		
1559   4901 ED A0       > ldi		
1559   4903 ED A0       > ldi		
1559   4905 ED A0       > ldi		
1559   4907 ED A0       > ldi		
1559   4909 ED A0       > ldi		
1559   490B ED A0       > ldi		
1559   490D ED A0       > ldi		
1559   490F ED A0       > ldi		
1559   4911 ED A0       > ldi		
1559   4913 ED A0       > ldi		
1559   4915 ED A0       > ldi		
1559   4917 ED A0       > ldi		
1559   4919 ED A0       > ldi		
1559   491B ED A0       > ldi		
1559   491D ED A0       > ldi		
1559   491F ED A0       > ldi		
1559   4921 ED A0       > ldi		
1559   4923 ED A0       > ldi		
1559   4925 ED A0       > ldi		
1559   4927 ED A0       > ldi		
1559   4929 ED A0       > ldi		
1559   492B ED A0       > ldi		
1559   492D ED A0       > ldi		
1559   492F ED A0       > ldi		
1559   4931 ED A0       > ldi		
1559   4933 ED A0       > ldi		
1559   4935 ED A0       > ldi		
1559   4937 ED A0       > ldi		
1559   4939 ED A0       > ldi		
1559   493B ED A0       > ldi		
1559   493D ED A0       > ldi		
1559   493F ED A0       > ldi		
1559   4941 ED A0       > ldi		
1559   4943 ED A0       > ldi		
1559   4945 ED A0       > ldi		
1559   4947 ED A0       > ldi		
1559   4949 ED A0       > ldi		
1559   494B ED A0       > ldi		
1559   494D ED A0       > ldi		
1559   494F ED A0       > ldi		
1559   4951 ED A0       > ldi		
1559   4953 ED A0       > ldi		
1559   4955 ED A0       > ldi		
1559   4957 ED A0       > ldi		
1559   4959 ED A0       > ldi		
1559   495B ED A0       > ldi		
1559   495D ED A0       > ldi		
1559   495F ED A0       > ldi		
1559   4961 ED A0       > ldi		
1559   4963 ED A0       > ldi		
1559   4965 ED A0       > ldi		
1559   4967 ED A0       > ldi		
1559   4969 ED A0       > ldi		
1559   496B ED A0       > ldi		
1559   496D ED A0       > ldi		
1559   496F ED A0       > ldi		
1559   4971 ED A0       > ldi		
1559   4973 ED A0       > ldi		
1559   4975 ED A0       > ldi		
1559   4977 ED A0       > ldi		
1559   4979 ED A0       > ldi		
1559   497B ED A0       > ldi		
1559   497D ED A0       > ldi		
1559   497F ED A0       > ldi		
1559   4981 ED A0       > ldi		
1559   4983 ED A0       > ldi		
1559   4985 ED A0       > ldi		
1559   4987 ED A0       > ldi		
1559   4989 ED A0       > ldi		
1559   498B ED A0       > ldi		
1559   498D ED A0       > ldi		
1559   498F ED A0       > ldi		
1559   4991 ED A0       > ldi		
1559   4993 ED A0       > ldi		
1559   4995 ED A0       > ldi		
1559   4997 ED A0       > ldi		
1559   4999 ED A0       > ldi		
1559   499B ED A0       > ldi		
1559   499D ED A0       > ldi		
1559   499F ED A0       > ldi		
1559   49A1 ED A0       > ldi		
1559   49A3 ED A0       > ldi		
1559   49A5 ED A0       > ldi		
1559   49A7 ED A0       > ldi		
1559   49A9 ED A0       > ldi		
1559   49AB ED A0       > ldi		
1559   49AD ED A0       > ldi		
1559   49AF ED A0       > ldi		
1559   49B1 ED A0       > ldi		
1559   49B3 ED A0       > ldi		
1559   49B5 ED A0       > ldi		
1559   49B7 ED A0       > ldi		
1559   49B9 ED A0       > ldi		
1559   49BB ED A0       > ldi		
1559   49BD ED A0       > ldi		
1559   49BF ED A0       > ldi		
1559   49C1 ED A0       > ldi		
1559   49C3 ED A0       > ldi		
1559   49C5 ED A0       > ldi		
1559   49C7 ED A0       > ldi		
1559   49C9 ED A0       > ldi		
1559   49CB ED A0       > ldi		
1559   49CD ED A0       > ldi		
1559   49CF ED A0       > ldi		
1559   49D1 ED A0       > ldi		
1559   49D3 ED A0       > ldi		
1559   49D5 ED A0       > ldi		
1559   49D7 ED A0       > ldi		
1559   49D9 ED A0       > ldi		
1559   49DB ED A0       > ldi		
1559   49DD ED A0       > ldi		
1559   49DF ED A0       > ldi		
1559   49E1 ED A0       > ldi		
1559   49E3 ED A0       > ldi		
1559   49E5 ED A0       > ldi		
1559   49E7 ED A0       > ldi		
1559   49E9 ED A0       > ldi		
1559   49EB ED A0       > ldi		
1559   49ED ED A0       > ldi		
1559   49EF ED A0       > ldi		
1559   49F1 ED A0       > ldi		
1559   49F3 ED A0       > ldi		
1559   49F5 ED A0       > ldi		
1559   49F7 ED A0       > ldi		
1559   49F9 ED A0       > ldi		
1559   49FB ED A0       > ldi		
1559   49FD ED A0       > ldi		
1559   49FF ED A0       > ldi		
1559   4A01 ED A0       > ldi		
1559   4A03 ED A0       > ldi		
1559   4A05 ED A0       > ldi		
1559   4A07 ED A0       > ldi		
1559   4A09 ED A0       > ldi		
1559   4A0B ED A0       > ldi		
1559   4A0D ED A0       > ldi		
1559   4A0F ED A0       > ldi		
1559   4A11 ED A0       > ldi		
1559   4A13 ED A0       > ldi		
1559   4A15 ED A0       > ldi		
1559   4A17 ED A0       > ldi		
1559   4A19 ED A0       > ldi		
1559   4A1B ED A0       > ldi		
1559   4A1D ED A0       > ldi		
1559   4A1F ED A0       > ldi		
1559   4A21 ED A0       > ldi		
1559   4A23 ED A0       > ldi		
1559   4A25 ED A0       > ldi		
1559   4A27 ED A0       > ldi		
1559   4A29 ED A0       > ldi		
1559   4A2B ED A0       > ldi		
1559   4A2D ED A0       > ldi		
1559   4A2F ED A0       > ldi		
1559   4A31 ED A0       > ldi		
1559   4A33 ED A0       > ldi		
1559   4A35 ED A0       > ldi		
1559   4A37 ED A0       > ldi		
1559   4A39 ED A0       > ldi		
1559   4A3B ED A0       > ldi		
1559   4A3D ED A0       > ldi		
1559   4A3F ED A0       > ldi		
1559   4A41 ED A0       > ldi		
1559   4A43 ED A0       > ldi		
1559   4A45 ED A0       > ldi		
1559   4A47 ED A0       > ldi		
1559   4A49 ED A0       > ldi		
1559   4A4B ED A0       > ldi		
1559   4A4D ED A0       > ldi		
1559   4A4F ED A0       > ldi		
1559   4A51 ED A0       > ldi		
1559   4A53 ED A0       > ldi		
1559   4A55 ED A0       > ldi		
1559   4A57 ED A0       > ldi		
1559   4A59 ED A0       > ldi		
1559   4A5B ED A0       > ldi		
1559   4A5D ED A0       > ldi		
1559   4A5F ED A0       > ldi		
1559   4A61 ED A0       > ldi		
1559   4A63 ED A0       > ldi		
1559   4A65 ED A0       > ldi		
1559   4A67 ED A0       > ldi		
1559   4A69 ED A0       > ldi		
1559   4A6B ED A0       > ldi		
1559   4A6D ED A0       > ldi		
1559   4A6F ED A0       > ldi		
1559   4A71 ED A0       > ldi		
1559   4A73 ED A0       > ldi		
1559   4A75 ED A0       > ldi		
1559   4A77 ED A0       > ldi		
1559   4A79 ED A0       > ldi		
1559   4A7B ED A0       > ldi		
1559   4A7D ED A0       > ldi		
1559   4A7F ED A0       > ldi		
1559   4A81 ED A0       > ldi		
1559   4A83 ED A0       > ldi		
1559   4A85 ED A0       > ldi		
1559   4A87 ED A0       > ldi		
1559   4A89 ED A0       > ldi		
1559   4A8B ED A0       > ldi		
1559   4A8D ED A0       > ldi		
1559   4A8F ED A0       > ldi		
1559   4A91 ED A0       > ldi		
1559   4A93 ED A0       > ldi		
1559   4A95 ED A0       > ldi		
1559   4A97 ED A0       > ldi		
1559   4A99 ED A0       > ldi		
1559   4A9B ED A0       > ldi		
1559   4A9D ED A0       > ldi		
1559   4A9F ED A0       > ldi		
1559   4AA1 ED A0       > ldi		
1559   4AA3 ED A0       > ldi		
1559   4AA5 ED A0       > ldi		
1559   4AA7 ED A0       > ldi		
1559   4AA9 ED A0       > ldi		
1559   4AAB ED A0       > ldi		
1559   4AAD ED A0       > ldi		
1560   4AAF             .part2m: 
1561   4AAF 3E FF       	ld	a, $FF		; envia dummy CRC
1562   4AB1 32 00 7B    	ld	(SPIDATA),a
1563   4AB4 32 00 7B    	ld	(SPIDATA),a
1564   4AB7 CD 42 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1565   4ABA E6 1F       	and	$1F		; testa bits erro
1566   4ABC FE 05       	cp	5
1567   4ABE 37          	scf
1568   4ABF C2 2F 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1569   4AC2 CD 51 46    	call	WAIT_RESP_NO_00	; esperar cartao
1570   4AC5 DA 2F 4F    	jp	c,terminaLeituraEscritaBloco
1571   4AC8 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para gravar
1572   4ACB 3D          	dec	a
1573   4ACC FD 77 32    	ld	(iy+NUMBLOCOS), a
1574   4ACF C2 9E 46    	jp	nz,.loop
1575   4AD2 3A 00 7B    	ld	a, (SPIDATA)	; acabou os blocos, fazer 2 dummy reads
1576   4AD5 3A 00 7B    	ld	a, (SPIDATA)
1577   4AD8 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1578   4ADA 32 00 7B    	ld	(SPIDATA),a
1579   4ADD 3A 00 7B    	ld	a, (SPIDATA)	; dummy reads
1580   4AE0 3A 00 7B    	ld	a, (SPIDATA)
1581   4AE3 CD 51 46    	call	WAIT_RESP_NO_00	; esperar cartao
1582   4AE6 C3 2E 4F    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1583   4AE9             
1584   4AE9 01 00 02    .r800m: 	ld	bc,512
1585   4AEC ED B0       	ldir
1586   4AEE 18 BF       	jr	.part2m
1587   4AF0             
1588   4AF0 01 00 02    .r800s: 	ld	bc,512
1589   4AF3 ED B0       	ldir
1590   4AF5 C3 10 4F    	jp	.part2s
1591   4AF8             
1592   4AF8             .umBloco: 
1593   4AF8 3E 58       	ld	a, CMD24	; gravar somente um bloco com comando CMD24 = Write Single Block
1594   4AFA CD DA 45    	call	SD_SEND_CMD_GET_ERROR
1595   4AFD DA 2F 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1596   4B00             
1597   4B00 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1598   4B02 32 00 7B    	ld	(SPIDATA),a
1599   4B05             
1600   4B05             	; Check for a Z80 or R800
1601   4B05 EB          	ex	de,hl
1602   4B06             ;	or 	a		; Clear Cy
1603   4B06 3E 14       	ld	a,20
1604   4B08 ED F9       	db	#ED,#F9		; mulub a,a
1605   4B0A EB          	ex	de,hl
1606   4B0B 11 00 7B    	ld	de, SPIDATA
1607   4B0E 38 E0       	jr	c,.r800s	; Use LDIR for R800
1608   4B10 ED A0       > ldi
1608   4B12 ED A0       > ldi
1608   4B14 ED A0       > ldi
1608   4B16 ED A0       > ldi
1608   4B18 ED A0       > ldi
1608   4B1A ED A0       > ldi
1608   4B1C ED A0       > ldi
1608   4B1E ED A0       > ldi
1608   4B20 ED A0       > ldi
1608   4B22 ED A0       > ldi
1608   4B24 ED A0       > ldi
1608   4B26 ED A0       > ldi
1608   4B28 ED A0       > ldi
1608   4B2A ED A0       > ldi
1608   4B2C ED A0       > ldi
1608   4B2E ED A0       > ldi
1608   4B30 ED A0       > ldi
1608   4B32 ED A0       > ldi
1608   4B34 ED A0       > ldi
1608   4B36 ED A0       > ldi
1608   4B38 ED A0       > ldi
1608   4B3A ED A0       > ldi
1608   4B3C ED A0       > ldi
1608   4B3E ED A0       > ldi
1608   4B40 ED A0       > ldi
1608   4B42 ED A0       > ldi
1608   4B44 ED A0       > ldi
1608   4B46 ED A0       > ldi
1608   4B48 ED A0       > ldi
1608   4B4A ED A0       > ldi
1608   4B4C ED A0       > ldi
1608   4B4E ED A0       > ldi
1608   4B50 ED A0       > ldi
1608   4B52 ED A0       > ldi
1608   4B54 ED A0       > ldi
1608   4B56 ED A0       > ldi
1608   4B58 ED A0       > ldi
1608   4B5A ED A0       > ldi
1608   4B5C ED A0       > ldi
1608   4B5E ED A0       > ldi
1608   4B60 ED A0       > ldi
1608   4B62 ED A0       > ldi
1608   4B64 ED A0       > ldi
1608   4B66 ED A0       > ldi
1608   4B68 ED A0       > ldi
1608   4B6A ED A0       > ldi
1608   4B6C ED A0       > ldi
1608   4B6E ED A0       > ldi
1608   4B70 ED A0       > ldi
1608   4B72 ED A0       > ldi
1608   4B74 ED A0       > ldi
1608   4B76 ED A0       > ldi
1608   4B78 ED A0       > ldi
1608   4B7A ED A0       > ldi
1608   4B7C ED A0       > ldi
1608   4B7E ED A0       > ldi
1608   4B80 ED A0       > ldi
1608   4B82 ED A0       > ldi
1608   4B84 ED A0       > ldi
1608   4B86 ED A0       > ldi
1608   4B88 ED A0       > ldi
1608   4B8A ED A0       > ldi
1608   4B8C ED A0       > ldi
1608   4B8E ED A0       > ldi
1608   4B90 ED A0       > ldi
1608   4B92 ED A0       > ldi
1608   4B94 ED A0       > ldi
1608   4B96 ED A0       > ldi
1608   4B98 ED A0       > ldi
1608   4B9A ED A0       > ldi
1608   4B9C ED A0       > ldi
1608   4B9E ED A0       > ldi
1608   4BA0 ED A0       > ldi
1608   4BA2 ED A0       > ldi
1608   4BA4 ED A0       > ldi
1608   4BA6 ED A0       > ldi
1608   4BA8 ED A0       > ldi
1608   4BAA ED A0       > ldi
1608   4BAC ED A0       > ldi
1608   4BAE ED A0       > ldi
1608   4BB0 ED A0       > ldi
1608   4BB2 ED A0       > ldi
1608   4BB4 ED A0       > ldi
1608   4BB6 ED A0       > ldi
1608   4BB8 ED A0       > ldi
1608   4BBA ED A0       > ldi
1608   4BBC ED A0       > ldi
1608   4BBE ED A0       > ldi
1608   4BC0 ED A0       > ldi
1608   4BC2 ED A0       > ldi
1608   4BC4 ED A0       > ldi
1608   4BC6 ED A0       > ldi
1608   4BC8 ED A0       > ldi
1608   4BCA ED A0       > ldi
1608   4BCC ED A0       > ldi
1608   4BCE ED A0       > ldi
1608   4BD0 ED A0       > ldi
1608   4BD2 ED A0       > ldi
1608   4BD4 ED A0       > ldi
1608   4BD6 ED A0       > ldi
1608   4BD8 ED A0       > ldi
1608   4BDA ED A0       > ldi
1608   4BDC ED A0       > ldi
1608   4BDE ED A0       > ldi
1608   4BE0 ED A0       > ldi
1608   4BE2 ED A0       > ldi
1608   4BE4 ED A0       > ldi
1608   4BE6 ED A0       > ldi
1608   4BE8 ED A0       > ldi
1608   4BEA ED A0       > ldi
1608   4BEC ED A0       > ldi
1608   4BEE ED A0       > ldi
1608   4BF0 ED A0       > ldi
1608   4BF2 ED A0       > ldi
1608   4BF4 ED A0       > ldi
1608   4BF6 ED A0       > ldi
1608   4BF8 ED A0       > ldi
1608   4BFA ED A0       > ldi
1608   4BFC ED A0       > ldi
1608   4BFE ED A0       > ldi
1608   4C00 ED A0       > ldi
1608   4C02 ED A0       > ldi
1608   4C04 ED A0       > ldi
1608   4C06 ED A0       > ldi
1608   4C08 ED A0       > ldi
1608   4C0A ED A0       > ldi
1608   4C0C ED A0       > ldi
1608   4C0E ED A0       > ldi
1608   4C10 ED A0       > ldi
1608   4C12 ED A0       > ldi
1608   4C14 ED A0       > ldi
1608   4C16 ED A0       > ldi
1608   4C18 ED A0       > ldi
1608   4C1A ED A0       > ldi
1608   4C1C ED A0       > ldi
1608   4C1E ED A0       > ldi
1608   4C20 ED A0       > ldi
1608   4C22 ED A0       > ldi
1608   4C24 ED A0       > ldi
1608   4C26 ED A0       > ldi
1608   4C28 ED A0       > ldi
1608   4C2A ED A0       > ldi
1608   4C2C ED A0       > ldi
1608   4C2E ED A0       > ldi
1608   4C30 ED A0       > ldi
1608   4C32 ED A0       > ldi
1608   4C34 ED A0       > ldi
1608   4C36 ED A0       > ldi
1608   4C38 ED A0       > ldi
1608   4C3A ED A0       > ldi
1608   4C3C ED A0       > ldi
1608   4C3E ED A0       > ldi
1608   4C40 ED A0       > ldi
1608   4C42 ED A0       > ldi
1608   4C44 ED A0       > ldi
1608   4C46 ED A0       > ldi
1608   4C48 ED A0       > ldi
1608   4C4A ED A0       > ldi
1608   4C4C ED A0       > ldi
1608   4C4E ED A0       > ldi
1608   4C50 ED A0       > ldi
1608   4C52 ED A0       > ldi
1608   4C54 ED A0       > ldi
1608   4C56 ED A0       > ldi
1608   4C58 ED A0       > ldi
1608   4C5A ED A0       > ldi
1608   4C5C ED A0       > ldi
1608   4C5E ED A0       > ldi
1608   4C60 ED A0       > ldi
1608   4C62 ED A0       > ldi
1608   4C64 ED A0       > ldi
1608   4C66 ED A0       > ldi
1608   4C68 ED A0       > ldi
1608   4C6A ED A0       > ldi
1608   4C6C ED A0       > ldi
1608   4C6E ED A0       > ldi
1608   4C70 ED A0       > ldi
1608   4C72 ED A0       > ldi
1608   4C74 ED A0       > ldi
1608   4C76 ED A0       > ldi
1608   4C78 ED A0       > ldi
1608   4C7A ED A0       > ldi
1608   4C7C ED A0       > ldi
1608   4C7E ED A0       > ldi
1608   4C80 ED A0       > ldi
1608   4C82 ED A0       > ldi
1608   4C84 ED A0       > ldi
1608   4C86 ED A0       > ldi
1608   4C88 ED A0       > ldi
1608   4C8A ED A0       > ldi
1608   4C8C ED A0       > ldi
1608   4C8E ED A0       > ldi
1608   4C90 ED A0       > ldi
1608   4C92 ED A0       > ldi
1608   4C94 ED A0       > ldi
1608   4C96 ED A0       > ldi
1608   4C98 ED A0       > ldi
1608   4C9A ED A0       > ldi
1608   4C9C ED A0       > ldi
1608   4C9E ED A0       > ldi
1608   4CA0 ED A0       > ldi
1608   4CA2 ED A0       > ldi
1608   4CA4 ED A0       > ldi
1608   4CA6 ED A0       > ldi
1608   4CA8 ED A0       > ldi
1608   4CAA ED A0       > ldi
1608   4CAC ED A0       > ldi
1608   4CAE ED A0       > ldi
1608   4CB0 ED A0       > ldi
1608   4CB2 ED A0       > ldi
1608   4CB4 ED A0       > ldi
1608   4CB6 ED A0       > ldi
1608   4CB8 ED A0       > ldi
1608   4CBA ED A0       > ldi
1608   4CBC ED A0       > ldi
1608   4CBE ED A0       > ldi
1608   4CC0 ED A0       > ldi
1608   4CC2 ED A0       > ldi
1608   4CC4 ED A0       > ldi
1608   4CC6 ED A0       > ldi
1608   4CC8 ED A0       > ldi
1608   4CCA ED A0       > ldi
1608   4CCC ED A0       > ldi
1608   4CCE ED A0       > ldi
1608   4CD0 ED A0       > ldi
1608   4CD2 ED A0       > ldi
1608   4CD4 ED A0       > ldi
1608   4CD6 ED A0       > ldi
1608   4CD8 ED A0       > ldi
1608   4CDA ED A0       > ldi
1608   4CDC ED A0       > ldi
1608   4CDE ED A0       > ldi
1608   4CE0 ED A0       > ldi
1608   4CE2 ED A0       > ldi
1608   4CE4 ED A0       > ldi
1608   4CE6 ED A0       > ldi
1608   4CE8 ED A0       > ldi
1608   4CEA ED A0       > ldi
1608   4CEC ED A0       > ldi
1608   4CEE ED A0       > ldi
1608   4CF0 ED A0       > ldi
1608   4CF2 ED A0       > ldi
1608   4CF4 ED A0       > ldi
1608   4CF6 ED A0       > ldi
1608   4CF8 ED A0       > ldi
1608   4CFA ED A0       > ldi
1608   4CFC ED A0       > ldi
1608   4CFE ED A0       > ldi
1608   4D00 ED A0       > ldi
1608   4D02 ED A0       > ldi
1608   4D04 ED A0       > ldi
1608   4D06 ED A0       > ldi
1608   4D08 ED A0       > ldi
1608   4D0A ED A0       > ldi
1608   4D0C ED A0       > ldi
1608   4D0E ED A0       > ldi
1608   4D10 ED A0       > ldi
1608   4D12 ED A0       > ldi
1608   4D14 ED A0       > ldi
1608   4D16 ED A0       > ldi
1608   4D18 ED A0       > ldi
1608   4D1A ED A0       > ldi
1608   4D1C ED A0       > ldi
1608   4D1E ED A0       > ldi
1608   4D20 ED A0       > ldi
1608   4D22 ED A0       > ldi
1608   4D24 ED A0       > ldi
1608   4D26 ED A0       > ldi
1608   4D28 ED A0       > ldi
1608   4D2A ED A0       > ldi
1608   4D2C ED A0       > ldi
1608   4D2E ED A0       > ldi
1608   4D30 ED A0       > ldi
1608   4D32 ED A0       > ldi
1608   4D34 ED A0       > ldi
1608   4D36 ED A0       > ldi
1608   4D38 ED A0       > ldi
1608   4D3A ED A0       > ldi
1608   4D3C ED A0       > ldi
1608   4D3E ED A0       > ldi
1608   4D40 ED A0       > ldi
1608   4D42 ED A0       > ldi
1608   4D44 ED A0       > ldi
1608   4D46 ED A0       > ldi
1608   4D48 ED A0       > ldi
1608   4D4A ED A0       > ldi
1608   4D4C ED A0       > ldi
1608   4D4E ED A0       > ldi
1608   4D50 ED A0       > ldi
1608   4D52 ED A0       > ldi
1608   4D54 ED A0       > ldi
1608   4D56 ED A0       > ldi
1608   4D58 ED A0       > ldi
1608   4D5A ED A0       > ldi
1608   4D5C ED A0       > ldi
1608   4D5E ED A0       > ldi
1608   4D60 ED A0       > ldi
1608   4D62 ED A0       > ldi
1608   4D64 ED A0       > ldi
1608   4D66 ED A0       > ldi
1608   4D68 ED A0       > ldi
1608   4D6A ED A0       > ldi
1608   4D6C ED A0       > ldi
1608   4D6E ED A0       > ldi
1608   4D70 ED A0       > ldi
1608   4D72 ED A0       > ldi
1608   4D74 ED A0       > ldi
1608   4D76 ED A0       > ldi
1608   4D78 ED A0       > ldi
1608   4D7A ED A0       > ldi
1608   4D7C ED A0       > ldi
1608   4D7E ED A0       > ldi
1608   4D80 ED A0       > ldi
1608   4D82 ED A0       > ldi
1608   4D84 ED A0       > ldi
1608   4D86 ED A0       > ldi
1608   4D88 ED A0       > ldi
1608   4D8A ED A0       > ldi
1608   4D8C ED A0       > ldi
1608   4D8E ED A0       > ldi
1608   4D90 ED A0       > ldi
1608   4D92 ED A0       > ldi
1608   4D94 ED A0       > ldi
1608   4D96 ED A0       > ldi
1608   4D98 ED A0       > ldi
1608   4D9A ED A0       > ldi
1608   4D9C ED A0       > ldi
1608   4D9E ED A0       > ldi
1608   4DA0 ED A0       > ldi
1608   4DA2 ED A0       > ldi
1608   4DA4 ED A0       > ldi
1608   4DA6 ED A0       > ldi
1608   4DA8 ED A0       > ldi
1608   4DAA ED A0       > ldi
1608   4DAC ED A0       > ldi
1608   4DAE ED A0       > ldi
1608   4DB0 ED A0       > ldi
1608   4DB2 ED A0       > ldi
1608   4DB4 ED A0       > ldi
1608   4DB6 ED A0       > ldi
1608   4DB8 ED A0       > ldi
1608   4DBA ED A0       > ldi
1608   4DBC ED A0       > ldi
1608   4DBE ED A0       > ldi
1608   4DC0 ED A0       > ldi
1608   4DC2 ED A0       > ldi
1608   4DC4 ED A0       > ldi
1608   4DC6 ED A0       > ldi
1608   4DC8 ED A0       > ldi
1608   4DCA ED A0       > ldi
1608   4DCC ED A0       > ldi
1608   4DCE ED A0       > ldi
1608   4DD0 ED A0       > ldi
1608   4DD2 ED A0       > ldi
1608   4DD4 ED A0       > ldi
1608   4DD6 ED A0       > ldi
1608   4DD8 ED A0       > ldi
1608   4DDA ED A0       > ldi
1608   4DDC ED A0       > ldi
1608   4DDE ED A0       > ldi
1608   4DE0 ED A0       > ldi
1608   4DE2 ED A0       > ldi
1608   4DE4 ED A0       > ldi
1608   4DE6 ED A0       > ldi
1608   4DE8 ED A0       > ldi
1608   4DEA ED A0       > ldi
1608   4DEC ED A0       > ldi
1608   4DEE ED A0       > ldi
1608   4DF0 ED A0       > ldi
1608   4DF2 ED A0       > ldi
1608   4DF4 ED A0       > ldi
1608   4DF6 ED A0       > ldi
1608   4DF8 ED A0       > ldi
1608   4DFA ED A0       > ldi
1608   4DFC ED A0       > ldi
1608   4DFE ED A0       > ldi
1608   4E00 ED A0       > ldi
1608   4E02 ED A0       > ldi
1608   4E04 ED A0       > ldi
1608   4E06 ED A0       > ldi
1608   4E08 ED A0       > ldi
1608   4E0A ED A0       > ldi
1608   4E0C ED A0       > ldi
1608   4E0E ED A0       > ldi
1608   4E10 ED A0       > ldi
1608   4E12 ED A0       > ldi
1608   4E14 ED A0       > ldi
1608   4E16 ED A0       > ldi
1608   4E18 ED A0       > ldi
1608   4E1A ED A0       > ldi
1608   4E1C ED A0       > ldi
1608   4E1E ED A0       > ldi
1608   4E20 ED A0       > ldi
1608   4E22 ED A0       > ldi
1608   4E24 ED A0       > ldi
1608   4E26 ED A0       > ldi
1608   4E28 ED A0       > ldi
1608   4E2A ED A0       > ldi
1608   4E2C ED A0       > ldi
1608   4E2E ED A0       > ldi
1608   4E30 ED A0       > ldi
1608   4E32 ED A0       > ldi
1608   4E34 ED A0       > ldi
1608   4E36 ED A0       > ldi
1608   4E38 ED A0       > ldi
1608   4E3A ED A0       > ldi
1608   4E3C ED A0       > ldi
1608   4E3E ED A0       > ldi
1608   4E40 ED A0       > ldi
1608   4E42 ED A0       > ldi
1608   4E44 ED A0       > ldi
1608   4E46 ED A0       > ldi
1608   4E48 ED A0       > ldi
1608   4E4A ED A0       > ldi
1608   4E4C ED A0       > ldi
1608   4E4E ED A0       > ldi
1608   4E50 ED A0       > ldi
1608   4E52 ED A0       > ldi
1608   4E54 ED A0       > ldi
1608   4E56 ED A0       > ldi
1608   4E58 ED A0       > ldi
1608   4E5A ED A0       > ldi
1608   4E5C ED A0       > ldi
1608   4E5E ED A0       > ldi
1608   4E60 ED A0       > ldi
1608   4E62 ED A0       > ldi
1608   4E64 ED A0       > ldi
1608   4E66 ED A0       > ldi
1608   4E68 ED A0       > ldi
1608   4E6A ED A0       > ldi
1608   4E6C ED A0       > ldi
1608   4E6E ED A0       > ldi
1608   4E70 ED A0       > ldi
1608   4E72 ED A0       > ldi
1608   4E74 ED A0       > ldi
1608   4E76 ED A0       > ldi
1608   4E78 ED A0       > ldi
1608   4E7A ED A0       > ldi
1608   4E7C ED A0       > ldi
1608   4E7E ED A0       > ldi
1608   4E80 ED A0       > ldi
1608   4E82 ED A0       > ldi
1608   4E84 ED A0       > ldi
1608   4E86 ED A0       > ldi
1608   4E88 ED A0       > ldi
1608   4E8A ED A0       > ldi
1608   4E8C ED A0       > ldi
1608   4E8E ED A0       > ldi
1608   4E90 ED A0       > ldi
1608   4E92 ED A0       > ldi
1608   4E94 ED A0       > ldi
1608   4E96 ED A0       > ldi
1608   4E98 ED A0       > ldi
1608   4E9A ED A0       > ldi
1608   4E9C ED A0       > ldi
1608   4E9E ED A0       > ldi
1608   4EA0 ED A0       > ldi
1608   4EA2 ED A0       > ldi
1608   4EA4 ED A0       > ldi
1608   4EA6 ED A0       > ldi
1608   4EA8 ED A0       > ldi
1608   4EAA ED A0       > ldi
1608   4EAC ED A0       > ldi
1608   4EAE ED A0       > ldi
1608   4EB0 ED A0       > ldi
1608   4EB2 ED A0       > ldi
1608   4EB4 ED A0       > ldi
1608   4EB6 ED A0       > ldi
1608   4EB8 ED A0       > ldi
1608   4EBA ED A0       > ldi
1608   4EBC ED A0       > ldi
1608   4EBE ED A0       > ldi
1608   4EC0 ED A0       > ldi
1608   4EC2 ED A0       > ldi
1608   4EC4 ED A0       > ldi
1608   4EC6 ED A0       > ldi
1608   4EC8 ED A0       > ldi
1608   4ECA ED A0       > ldi
1608   4ECC ED A0       > ldi
1608   4ECE ED A0       > ldi
1608   4ED0 ED A0       > ldi
1608   4ED2 ED A0       > ldi
1608   4ED4 ED A0       > ldi
1608   4ED6 ED A0       > ldi
1608   4ED8 ED A0       > ldi
1608   4EDA ED A0       > ldi
1608   4EDC ED A0       > ldi
1608   4EDE ED A0       > ldi
1608   4EE0 ED A0       > ldi
1608   4EE2 ED A0       > ldi
1608   4EE4 ED A0       > ldi
1608   4EE6 ED A0       > ldi
1608   4EE8 ED A0       > ldi
1608   4EEA ED A0       > ldi
1608   4EEC ED A0       > ldi
1608   4EEE ED A0       > ldi
1608   4EF0 ED A0       > ldi
1608   4EF2 ED A0       > ldi
1608   4EF4 ED A0       > ldi
1608   4EF6 ED A0       > ldi
1608   4EF8 ED A0       > ldi
1608   4EFA ED A0       > ldi
1608   4EFC ED A0       > ldi
1608   4EFE ED A0       > ldi
1608   4F00 ED A0       > ldi
1608   4F02 ED A0       > ldi
1608   4F04 ED A0       > ldi
1608   4F06 ED A0       > ldi
1608   4F08 ED A0       > ldi
1608   4F0A ED A0       > ldi
1608   4F0C ED A0       > ldi
1608   4F0E ED A0       > ldi
1609   4F10             .part2s: 
1610   4F10 01 00 02    	ld	bc,512
1611   4F13 ED B0       	ldir
1612   4F15 3E FF       	ld	a, $FF		; envia dummy CRC
1613   4F17 32 00 7B    	ld	(SPIDATA),a
1614   4F1A 32 00 7B    	ld	(SPIDATA),a
1615   4F1D CD 42 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1616   4F20 E6 1F       	and	$1F		; testa bits erro
1617   4F22 FE 05       	cp	5
1618   4F24 37          	scf
1619   4F25 C2 2F 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1620   4F28             .esp: 
1621   4F28 CD 42 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1622   4F2B B7          	or	a
1623   4F2C 28 FA       	jr	z,.esp
1624   4F2E             .fim: 
1625   4F2E AF          	xor	a		; zera carry e informa nenhum erro
1626   4F2F             terminaLeituraEscritaBloco: 
1627   4F2F F5          	push	af
1628   4F30 CD BD 45    	call	desabilitaSDs	; desabilitar todos os cartoes
1629   4F33 F1          	pop	af
1630   4F34 C9          	ret
1631   4F35             
1632   4F35             
1633   4F35             ; ------------------------------------------------
1634   4F35             ; Ler um bloco de 512 bytes do cartao
1635   4F35             ; HL aponta para o inicio dos dados
1636   4F35             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1637   4F35             ; Destroi AF, BC, DE, HL
1638   4F35             ; ------------------------------------------------
1639   4F35             LerBloco: 
1640   4F35 DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1641   4F38 B7          	or	a
1642   4F39 CC A7 57    	call	z,blocoParaByte	; se for SDV1 coverter blocos para bytes
1643   4F3C CD 60 46    	call	setaSDAtual
1644   4F3F             
1645   4F3F             
1646   4F3F             
1647   4F3F FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer ler um ou mais blocos
1648   4F42 3D          	dec	a
1649   4F43 CA 87 53    	jp	z,.umBloco	; somente um bloco, pular
1650   4F46             
1651   4F46             ; multiplos blocos
1652   4F46 3E 52       	ld	a, CMD18	; ler multiplos blocos com CMD18 = Read Multiple Blocks
1653   4F48 CD DA 45    	call	SD_SEND_CMD_GET_ERROR
1654   4F4B DA 2F 4F    	jp	c,terminaLeituraEscritaBloco
1655   4F4E             .loop: 
1656   4F4E CD 34 46    	call	WAIT_RESP_FE
1657   4F51 DA 2F 4F    	jp	c,terminaLeituraEscritaBloco
1658   4F54 EB          	ex	de,hl
1659   4F55             	; Check for a Z80 or R800
1660   4F55             ;	or 	a		; Clear Cy
1661   4F55 3E 14       	ld	a,20
1662   4F57 ED F9       	db	#ED,#F9		; mulub a,a
1663   4F59 21 00 7B    	ld	hl, SPIDATA
1664   4F5C DA 78 53    	jp	c,.r800m	; Use LDIR for R800
1665   4F5F ED A0       > ldi
1665   4F61 ED A0       > ldi
1665   4F63 ED A0       > ldi
1665   4F65 ED A0       > ldi
1665   4F67 ED A0       > ldi
1665   4F69 ED A0       > ldi
1665   4F6B ED A0       > ldi
1665   4F6D ED A0       > ldi
1665   4F6F ED A0       > ldi
1665   4F71 ED A0       > ldi
1665   4F73 ED A0       > ldi
1665   4F75 ED A0       > ldi
1665   4F77 ED A0       > ldi
1665   4F79 ED A0       > ldi
1665   4F7B ED A0       > ldi
1665   4F7D ED A0       > ldi
1665   4F7F ED A0       > ldi
1665   4F81 ED A0       > ldi
1665   4F83 ED A0       > ldi
1665   4F85 ED A0       > ldi
1665   4F87 ED A0       > ldi
1665   4F89 ED A0       > ldi
1665   4F8B ED A0       > ldi
1665   4F8D ED A0       > ldi
1665   4F8F ED A0       > ldi
1665   4F91 ED A0       > ldi
1665   4F93 ED A0       > ldi
1665   4F95 ED A0       > ldi
1665   4F97 ED A0       > ldi
1665   4F99 ED A0       > ldi
1665   4F9B ED A0       > ldi
1665   4F9D ED A0       > ldi
1665   4F9F ED A0       > ldi
1665   4FA1 ED A0       > ldi
1665   4FA3 ED A0       > ldi
1665   4FA5 ED A0       > ldi
1665   4FA7 ED A0       > ldi
1665   4FA9 ED A0       > ldi
1665   4FAB ED A0       > ldi
1665   4FAD ED A0       > ldi
1665   4FAF ED A0       > ldi
1665   4FB1 ED A0       > ldi
1665   4FB3 ED A0       > ldi
1665   4FB5 ED A0       > ldi
1665   4FB7 ED A0       > ldi
1665   4FB9 ED A0       > ldi
1665   4FBB ED A0       > ldi
1665   4FBD ED A0       > ldi
1665   4FBF ED A0       > ldi
1665   4FC1 ED A0       > ldi
1665   4FC3 ED A0       > ldi
1665   4FC5 ED A0       > ldi
1665   4FC7 ED A0       > ldi
1665   4FC9 ED A0       > ldi
1665   4FCB ED A0       > ldi
1665   4FCD ED A0       > ldi
1665   4FCF ED A0       > ldi
1665   4FD1 ED A0       > ldi
1665   4FD3 ED A0       > ldi
1665   4FD5 ED A0       > ldi
1665   4FD7 ED A0       > ldi
1665   4FD9 ED A0       > ldi
1665   4FDB ED A0       > ldi
1665   4FDD ED A0       > ldi
1665   4FDF ED A0       > ldi
1665   4FE1 ED A0       > ldi
1665   4FE3 ED A0       > ldi
1665   4FE5 ED A0       > ldi
1665   4FE7 ED A0       > ldi
1665   4FE9 ED A0       > ldi
1665   4FEB ED A0       > ldi
1665   4FED ED A0       > ldi
1665   4FEF ED A0       > ldi
1665   4FF1 ED A0       > ldi
1665   4FF3 ED A0       > ldi
1665   4FF5 ED A0       > ldi
1665   4FF7 ED A0       > ldi
1665   4FF9 ED A0       > ldi
1665   4FFB ED A0       > ldi
1665   4FFD ED A0       > ldi
1665   4FFF ED A0       > ldi
1665   5001 ED A0       > ldi
1665   5003 ED A0       > ldi
1665   5005 ED A0       > ldi
1665   5007 ED A0       > ldi
1665   5009 ED A0       > ldi
1665   500B ED A0       > ldi
1665   500D ED A0       > ldi
1665   500F ED A0       > ldi
1665   5011 ED A0       > ldi
1665   5013 ED A0       > ldi
1665   5015 ED A0       > ldi
1665   5017 ED A0       > ldi
1665   5019 ED A0       > ldi
1665   501B ED A0       > ldi
1665   501D ED A0       > ldi
1665   501F ED A0       > ldi
1665   5021 ED A0       > ldi
1665   5023 ED A0       > ldi
1665   5025 ED A0       > ldi
1665   5027 ED A0       > ldi
1665   5029 ED A0       > ldi
1665   502B ED A0       > ldi
1665   502D ED A0       > ldi
1665   502F ED A0       > ldi
1665   5031 ED A0       > ldi
1665   5033 ED A0       > ldi
1665   5035 ED A0       > ldi
1665   5037 ED A0       > ldi
1665   5039 ED A0       > ldi
1665   503B ED A0       > ldi
1665   503D ED A0       > ldi
1665   503F ED A0       > ldi
1665   5041 ED A0       > ldi
1665   5043 ED A0       > ldi
1665   5045 ED A0       > ldi
1665   5047 ED A0       > ldi
1665   5049 ED A0       > ldi
1665   504B ED A0       > ldi
1665   504D ED A0       > ldi
1665   504F ED A0       > ldi
1665   5051 ED A0       > ldi
1665   5053 ED A0       > ldi
1665   5055 ED A0       > ldi
1665   5057 ED A0       > ldi
1665   5059 ED A0       > ldi
1665   505B ED A0       > ldi
1665   505D ED A0       > ldi
1665   505F ED A0       > ldi
1665   5061 ED A0       > ldi
1665   5063 ED A0       > ldi
1665   5065 ED A0       > ldi
1665   5067 ED A0       > ldi
1665   5069 ED A0       > ldi
1665   506B ED A0       > ldi
1665   506D ED A0       > ldi
1665   506F ED A0       > ldi
1665   5071 ED A0       > ldi
1665   5073 ED A0       > ldi
1665   5075 ED A0       > ldi
1665   5077 ED A0       > ldi
1665   5079 ED A0       > ldi
1665   507B ED A0       > ldi
1665   507D ED A0       > ldi
1665   507F ED A0       > ldi
1665   5081 ED A0       > ldi
1665   5083 ED A0       > ldi
1665   5085 ED A0       > ldi
1665   5087 ED A0       > ldi
1665   5089 ED A0       > ldi
1665   508B ED A0       > ldi
1665   508D ED A0       > ldi
1665   508F ED A0       > ldi
1665   5091 ED A0       > ldi
1665   5093 ED A0       > ldi
1665   5095 ED A0       > ldi
1665   5097 ED A0       > ldi
1665   5099 ED A0       > ldi
1665   509B ED A0       > ldi
1665   509D ED A0       > ldi
1665   509F ED A0       > ldi
1665   50A1 ED A0       > ldi
1665   50A3 ED A0       > ldi
1665   50A5 ED A0       > ldi
1665   50A7 ED A0       > ldi
1665   50A9 ED A0       > ldi
1665   50AB ED A0       > ldi
1665   50AD ED A0       > ldi
1665   50AF ED A0       > ldi
1665   50B1 ED A0       > ldi
1665   50B3 ED A0       > ldi
1665   50B5 ED A0       > ldi
1665   50B7 ED A0       > ldi
1665   50B9 ED A0       > ldi
1665   50BB ED A0       > ldi
1665   50BD ED A0       > ldi
1665   50BF ED A0       > ldi
1665   50C1 ED A0       > ldi
1665   50C3 ED A0       > ldi
1665   50C5 ED A0       > ldi
1665   50C7 ED A0       > ldi
1665   50C9 ED A0       > ldi
1665   50CB ED A0       > ldi
1665   50CD ED A0       > ldi
1665   50CF ED A0       > ldi
1665   50D1 ED A0       > ldi
1665   50D3 ED A0       > ldi
1665   50D5 ED A0       > ldi
1665   50D7 ED A0       > ldi
1665   50D9 ED A0       > ldi
1665   50DB ED A0       > ldi
1665   50DD ED A0       > ldi
1665   50DF ED A0       > ldi
1665   50E1 ED A0       > ldi
1665   50E3 ED A0       > ldi
1665   50E5 ED A0       > ldi
1665   50E7 ED A0       > ldi
1665   50E9 ED A0       > ldi
1665   50EB ED A0       > ldi
1665   50ED ED A0       > ldi
1665   50EF ED A0       > ldi
1665   50F1 ED A0       > ldi
1665   50F3 ED A0       > ldi
1665   50F5 ED A0       > ldi
1665   50F7 ED A0       > ldi
1665   50F9 ED A0       > ldi
1665   50FB ED A0       > ldi
1665   50FD ED A0       > ldi
1665   50FF ED A0       > ldi
1665   5101 ED A0       > ldi
1665   5103 ED A0       > ldi
1665   5105 ED A0       > ldi
1665   5107 ED A0       > ldi
1665   5109 ED A0       > ldi
1665   510B ED A0       > ldi
1665   510D ED A0       > ldi
1665   510F ED A0       > ldi
1665   5111 ED A0       > ldi
1665   5113 ED A0       > ldi
1665   5115 ED A0       > ldi
1665   5117 ED A0       > ldi
1665   5119 ED A0       > ldi
1665   511B ED A0       > ldi
1665   511D ED A0       > ldi
1665   511F ED A0       > ldi
1665   5121 ED A0       > ldi
1665   5123 ED A0       > ldi
1665   5125 ED A0       > ldi
1665   5127 ED A0       > ldi
1665   5129 ED A0       > ldi
1665   512B ED A0       > ldi
1665   512D ED A0       > ldi
1665   512F ED A0       > ldi
1665   5131 ED A0       > ldi
1665   5133 ED A0       > ldi
1665   5135 ED A0       > ldi
1665   5137 ED A0       > ldi
1665   5139 ED A0       > ldi
1665   513B ED A0       > ldi
1665   513D ED A0       > ldi
1665   513F ED A0       > ldi
1665   5141 ED A0       > ldi
1665   5143 ED A0       > ldi
1665   5145 ED A0       > ldi
1665   5147 ED A0       > ldi
1665   5149 ED A0       > ldi
1665   514B ED A0       > ldi
1665   514D ED A0       > ldi
1665   514F ED A0       > ldi
1665   5151 ED A0       > ldi
1665   5153 ED A0       > ldi
1665   5155 ED A0       > ldi
1665   5157 ED A0       > ldi
1665   5159 ED A0       > ldi
1665   515B ED A0       > ldi
1665   515D ED A0       > ldi
1665   515F ED A0       > ldi
1665   5161 ED A0       > ldi
1665   5163 ED A0       > ldi
1665   5165 ED A0       > ldi
1665   5167 ED A0       > ldi
1665   5169 ED A0       > ldi
1665   516B ED A0       > ldi
1665   516D ED A0       > ldi
1665   516F ED A0       > ldi
1665   5171 ED A0       > ldi
1665   5173 ED A0       > ldi
1665   5175 ED A0       > ldi
1665   5177 ED A0       > ldi
1665   5179 ED A0       > ldi
1665   517B ED A0       > ldi
1665   517D ED A0       > ldi
1665   517F ED A0       > ldi
1665   5181 ED A0       > ldi
1665   5183 ED A0       > ldi
1665   5185 ED A0       > ldi
1665   5187 ED A0       > ldi
1665   5189 ED A0       > ldi
1665   518B ED A0       > ldi
1665   518D ED A0       > ldi
1665   518F ED A0       > ldi
1665   5191 ED A0       > ldi
1665   5193 ED A0       > ldi
1665   5195 ED A0       > ldi
1665   5197 ED A0       > ldi
1665   5199 ED A0       > ldi
1665   519B ED A0       > ldi
1665   519D ED A0       > ldi
1665   519F ED A0       > ldi
1665   51A1 ED A0       > ldi
1665   51A3 ED A0       > ldi
1665   51A5 ED A0       > ldi
1665   51A7 ED A0       > ldi
1665   51A9 ED A0       > ldi
1665   51AB ED A0       > ldi
1665   51AD ED A0       > ldi
1665   51AF ED A0       > ldi
1665   51B1 ED A0       > ldi
1665   51B3 ED A0       > ldi
1665   51B5 ED A0       > ldi
1665   51B7 ED A0       > ldi
1665   51B9 ED A0       > ldi
1665   51BB ED A0       > ldi
1665   51BD ED A0       > ldi
1665   51BF ED A0       > ldi
1665   51C1 ED A0       > ldi
1665   51C3 ED A0       > ldi
1665   51C5 ED A0       > ldi
1665   51C7 ED A0       > ldi
1665   51C9 ED A0       > ldi
1665   51CB ED A0       > ldi
1665   51CD ED A0       > ldi
1665   51CF ED A0       > ldi
1665   51D1 ED A0       > ldi
1665   51D3 ED A0       > ldi
1665   51D5 ED A0       > ldi
1665   51D7 ED A0       > ldi
1665   51D9 ED A0       > ldi
1665   51DB ED A0       > ldi
1665   51DD ED A0       > ldi
1665   51DF ED A0       > ldi
1665   51E1 ED A0       > ldi
1665   51E3 ED A0       > ldi
1665   51E5 ED A0       > ldi
1665   51E7 ED A0       > ldi
1665   51E9 ED A0       > ldi
1665   51EB ED A0       > ldi
1665   51ED ED A0       > ldi
1665   51EF ED A0       > ldi
1665   51F1 ED A0       > ldi
1665   51F3 ED A0       > ldi
1665   51F5 ED A0       > ldi
1665   51F7 ED A0       > ldi
1665   51F9 ED A0       > ldi
1665   51FB ED A0       > ldi
1665   51FD ED A0       > ldi
1665   51FF ED A0       > ldi
1665   5201 ED A0       > ldi
1665   5203 ED A0       > ldi
1665   5205 ED A0       > ldi
1665   5207 ED A0       > ldi
1665   5209 ED A0       > ldi
1665   520B ED A0       > ldi
1665   520D ED A0       > ldi
1665   520F ED A0       > ldi
1665   5211 ED A0       > ldi
1665   5213 ED A0       > ldi
1665   5215 ED A0       > ldi
1665   5217 ED A0       > ldi
1665   5219 ED A0       > ldi
1665   521B ED A0       > ldi
1665   521D ED A0       > ldi
1665   521F ED A0       > ldi
1665   5221 ED A0       > ldi
1665   5223 ED A0       > ldi
1665   5225 ED A0       > ldi
1665   5227 ED A0       > ldi
1665   5229 ED A0       > ldi
1665   522B ED A0       > ldi
1665   522D ED A0       > ldi
1665   522F ED A0       > ldi
1665   5231 ED A0       > ldi
1665   5233 ED A0       > ldi
1665   5235 ED A0       > ldi
1665   5237 ED A0       > ldi
1665   5239 ED A0       > ldi
1665   523B ED A0       > ldi
1665   523D ED A0       > ldi
1665   523F ED A0       > ldi
1665   5241 ED A0       > ldi
1665   5243 ED A0       > ldi
1665   5245 ED A0       > ldi
1665   5247 ED A0       > ldi
1665   5249 ED A0       > ldi
1665   524B ED A0       > ldi
1665   524D ED A0       > ldi
1665   524F ED A0       > ldi
1665   5251 ED A0       > ldi
1665   5253 ED A0       > ldi
1665   5255 ED A0       > ldi
1665   5257 ED A0       > ldi
1665   5259 ED A0       > ldi
1665   525B ED A0       > ldi
1665   525D ED A0       > ldi
1665   525F ED A0       > ldi
1665   5261 ED A0       > ldi
1665   5263 ED A0       > ldi
1665   5265 ED A0       > ldi
1665   5267 ED A0       > ldi
1665   5269 ED A0       > ldi
1665   526B ED A0       > ldi
1665   526D ED A0       > ldi
1665   526F ED A0       > ldi
1665   5271 ED A0       > ldi
1665   5273 ED A0       > ldi
1665   5275 ED A0       > ldi
1665   5277 ED A0       > ldi
1665   5279 ED A0       > ldi
1665   527B ED A0       > ldi
1665   527D ED A0       > ldi
1665   527F ED A0       > ldi
1665   5281 ED A0       > ldi
1665   5283 ED A0       > ldi
1665   5285 ED A0       > ldi
1665   5287 ED A0       > ldi
1665   5289 ED A0       > ldi
1665   528B ED A0       > ldi
1665   528D ED A0       > ldi
1665   528F ED A0       > ldi
1665   5291 ED A0       > ldi
1665   5293 ED A0       > ldi
1665   5295 ED A0       > ldi
1665   5297 ED A0       > ldi
1665   5299 ED A0       > ldi
1665   529B ED A0       > ldi
1665   529D ED A0       > ldi
1665   529F ED A0       > ldi
1665   52A1 ED A0       > ldi
1665   52A3 ED A0       > ldi
1665   52A5 ED A0       > ldi
1665   52A7 ED A0       > ldi
1665   52A9 ED A0       > ldi
1665   52AB ED A0       > ldi
1665   52AD ED A0       > ldi
1665   52AF ED A0       > ldi
1665   52B1 ED A0       > ldi
1665   52B3 ED A0       > ldi
1665   52B5 ED A0       > ldi
1665   52B7 ED A0       > ldi
1665   52B9 ED A0       > ldi
1665   52BB ED A0       > ldi
1665   52BD ED A0       > ldi
1665   52BF ED A0       > ldi
1665   52C1 ED A0       > ldi
1665   52C3 ED A0       > ldi
1665   52C5 ED A0       > ldi
1665   52C7 ED A0       > ldi
1665   52C9 ED A0       > ldi
1665   52CB ED A0       > ldi
1665   52CD ED A0       > ldi
1665   52CF ED A0       > ldi
1665   52D1 ED A0       > ldi
1665   52D3 ED A0       > ldi
1665   52D5 ED A0       > ldi
1665   52D7 ED A0       > ldi
1665   52D9 ED A0       > ldi
1665   52DB ED A0       > ldi
1665   52DD ED A0       > ldi
1665   52DF ED A0       > ldi
1665   52E1 ED A0       > ldi
1665   52E3 ED A0       > ldi
1665   52E5 ED A0       > ldi
1665   52E7 ED A0       > ldi
1665   52E9 ED A0       > ldi
1665   52EB ED A0       > ldi
1665   52ED ED A0       > ldi
1665   52EF ED A0       > ldi
1665   52F1 ED A0       > ldi
1665   52F3 ED A0       > ldi
1665   52F5 ED A0       > ldi
1665   52F7 ED A0       > ldi
1665   52F9 ED A0       > ldi
1665   52FB ED A0       > ldi
1665   52FD ED A0       > ldi
1665   52FF ED A0       > ldi
1665   5301 ED A0       > ldi
1665   5303 ED A0       > ldi
1665   5305 ED A0       > ldi
1665   5307 ED A0       > ldi
1665   5309 ED A0       > ldi
1665   530B ED A0       > ldi
1665   530D ED A0       > ldi
1665   530F ED A0       > ldi
1665   5311 ED A0       > ldi
1665   5313 ED A0       > ldi
1665   5315 ED A0       > ldi
1665   5317 ED A0       > ldi
1665   5319 ED A0       > ldi
1665   531B ED A0       > ldi
1665   531D ED A0       > ldi
1665   531F ED A0       > ldi
1665   5321 ED A0       > ldi
1665   5323 ED A0       > ldi
1665   5325 ED A0       > ldi
1665   5327 ED A0       > ldi
1665   5329 ED A0       > ldi
1665   532B ED A0       > ldi
1665   532D ED A0       > ldi
1665   532F ED A0       > ldi
1665   5331 ED A0       > ldi
1665   5333 ED A0       > ldi
1665   5335 ED A0       > ldi
1665   5337 ED A0       > ldi
1665   5339 ED A0       > ldi
1665   533B ED A0       > ldi
1665   533D ED A0       > ldi
1665   533F ED A0       > ldi
1665   5341 ED A0       > ldi
1665   5343 ED A0       > ldi
1665   5345 ED A0       > ldi
1665   5347 ED A0       > ldi
1665   5349 ED A0       > ldi
1665   534B ED A0       > ldi
1665   534D ED A0       > ldi
1665   534F ED A0       > ldi
1665   5351 ED A0       > ldi
1665   5353 ED A0       > ldi
1665   5355 ED A0       > ldi
1665   5357 ED A0       > ldi
1665   5359 ED A0       > ldi
1665   535B ED A0       > ldi
1665   535D ED A0       > ldi
1666   535F             .part2m: 
1667   535F EB          	ex	de,hl
1668   5360 3A 00 7B    	ld	a, (SPIDATA)	; descarta CRC
1669   5363 3A 00 7B    	ld	a, (SPIDATA)
1670   5366 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para ler
1671   5369 3D          	dec	a
1672   536A FD 77 32    	ld	(iy+NUMBLOCOS), a
1673   536D C2 4E 4F    	jp	nz,.loop
1674   5370 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1675   5372 CD D5 45    	call	SD_SEND_CMD_NO_ARGS
1676   5375 C3 A3 57    	jp	.fim
1677   5378             
1678   5378 01 00 02    .r800m:  ld	bc,512
1679   537B ED B0       	ldir
1680   537D 18 E0       	jr	.part2m
1681   537F             
1682   537F 01 00 02    .r800s: 	ld	bc,512
1683   5382 ED B0       	ldir
1684   5384 C3 9F 57    	jp	.part2s
1685   5387             
1686   5387             .umBloco: 
1687   5387 3E 51       	ld	a, CMD17	; ler somente um bloco com CMD17 = Read Single Block
1688   5389 CD DA 45    	call	SD_SEND_CMD_GET_ERROR
1689   538C DA 2F 4F    	jp	c,terminaLeituraEscritaBloco
1690   538F             
1691   538F CD 34 46    	call	WAIT_RESP_FE
1692   5392 DA 2F 4F    	jp	c,terminaLeituraEscritaBloco
1693   5395 EB          	ex	de,hl
1694   5396             
1695   5396             	; Check for a Z80 or R800
1696   5396             ;	or 	a		; Clear Cy
1697   5396 3E 14       	ld	a,20
1698   5398 ED F9       	db	#ED,#F9		; mulub a,a
1699   539A 21 00 7B    	ld	hl, SPIDATA
1700   539D 38 E0       	jr	c,.r800s	; Use LDIR for R800
1701   539F ED A0       > ldi
1701   53A1 ED A0       > ldi
1701   53A3 ED A0       > ldi
1701   53A5 ED A0       > ldi
1701   53A7 ED A0       > ldi
1701   53A9 ED A0       > ldi
1701   53AB ED A0       > ldi
1701   53AD ED A0       > ldi
1701   53AF ED A0       > ldi
1701   53B1 ED A0       > ldi
1701   53B3 ED A0       > ldi
1701   53B5 ED A0       > ldi
1701   53B7 ED A0       > ldi
1701   53B9 ED A0       > ldi
1701   53BB ED A0       > ldi
1701   53BD ED A0       > ldi
1701   53BF ED A0       > ldi
1701   53C1 ED A0       > ldi
1701   53C3 ED A0       > ldi
1701   53C5 ED A0       > ldi
1701   53C7 ED A0       > ldi
1701   53C9 ED A0       > ldi
1701   53CB ED A0       > ldi
1701   53CD ED A0       > ldi
1701   53CF ED A0       > ldi
1701   53D1 ED A0       > ldi
1701   53D3 ED A0       > ldi
1701   53D5 ED A0       > ldi
1701   53D7 ED A0       > ldi
1701   53D9 ED A0       > ldi
1701   53DB ED A0       > ldi
1701   53DD ED A0       > ldi
1701   53DF ED A0       > ldi
1701   53E1 ED A0       > ldi
1701   53E3 ED A0       > ldi
1701   53E5 ED A0       > ldi
1701   53E7 ED A0       > ldi
1701   53E9 ED A0       > ldi
1701   53EB ED A0       > ldi
1701   53ED ED A0       > ldi
1701   53EF ED A0       > ldi
1701   53F1 ED A0       > ldi
1701   53F3 ED A0       > ldi
1701   53F5 ED A0       > ldi
1701   53F7 ED A0       > ldi
1701   53F9 ED A0       > ldi
1701   53FB ED A0       > ldi
1701   53FD ED A0       > ldi
1701   53FF ED A0       > ldi
1701   5401 ED A0       > ldi
1701   5403 ED A0       > ldi
1701   5405 ED A0       > ldi
1701   5407 ED A0       > ldi
1701   5409 ED A0       > ldi
1701   540B ED A0       > ldi
1701   540D ED A0       > ldi
1701   540F ED A0       > ldi
1701   5411 ED A0       > ldi
1701   5413 ED A0       > ldi
1701   5415 ED A0       > ldi
1701   5417 ED A0       > ldi
1701   5419 ED A0       > ldi
1701   541B ED A0       > ldi
1701   541D ED A0       > ldi
1701   541F ED A0       > ldi
1701   5421 ED A0       > ldi
1701   5423 ED A0       > ldi
1701   5425 ED A0       > ldi
1701   5427 ED A0       > ldi
1701   5429 ED A0       > ldi
1701   542B ED A0       > ldi
1701   542D ED A0       > ldi
1701   542F ED A0       > ldi
1701   5431 ED A0       > ldi
1701   5433 ED A0       > ldi
1701   5435 ED A0       > ldi
1701   5437 ED A0       > ldi
1701   5439 ED A0       > ldi
1701   543B ED A0       > ldi
1701   543D ED A0       > ldi
1701   543F ED A0       > ldi
1701   5441 ED A0       > ldi
1701   5443 ED A0       > ldi
1701   5445 ED A0       > ldi
1701   5447 ED A0       > ldi
1701   5449 ED A0       > ldi
1701   544B ED A0       > ldi
1701   544D ED A0       > ldi
1701   544F ED A0       > ldi
1701   5451 ED A0       > ldi
1701   5453 ED A0       > ldi
1701   5455 ED A0       > ldi
1701   5457 ED A0       > ldi
1701   5459 ED A0       > ldi
1701   545B ED A0       > ldi
1701   545D ED A0       > ldi
1701   545F ED A0       > ldi
1701   5461 ED A0       > ldi
1701   5463 ED A0       > ldi
1701   5465 ED A0       > ldi
1701   5467 ED A0       > ldi
1701   5469 ED A0       > ldi
1701   546B ED A0       > ldi
1701   546D ED A0       > ldi
1701   546F ED A0       > ldi
1701   5471 ED A0       > ldi
1701   5473 ED A0       > ldi
1701   5475 ED A0       > ldi
1701   5477 ED A0       > ldi
1701   5479 ED A0       > ldi
1701   547B ED A0       > ldi
1701   547D ED A0       > ldi
1701   547F ED A0       > ldi
1701   5481 ED A0       > ldi
1701   5483 ED A0       > ldi
1701   5485 ED A0       > ldi
1701   5487 ED A0       > ldi
1701   5489 ED A0       > ldi
1701   548B ED A0       > ldi
1701   548D ED A0       > ldi
1701   548F ED A0       > ldi
1701   5491 ED A0       > ldi
1701   5493 ED A0       > ldi
1701   5495 ED A0       > ldi
1701   5497 ED A0       > ldi
1701   5499 ED A0       > ldi
1701   549B ED A0       > ldi
1701   549D ED A0       > ldi
1701   549F ED A0       > ldi
1701   54A1 ED A0       > ldi
1701   54A3 ED A0       > ldi
1701   54A5 ED A0       > ldi
1701   54A7 ED A0       > ldi
1701   54A9 ED A0       > ldi
1701   54AB ED A0       > ldi
1701   54AD ED A0       > ldi
1701   54AF ED A0       > ldi
1701   54B1 ED A0       > ldi
1701   54B3 ED A0       > ldi
1701   54B5 ED A0       > ldi
1701   54B7 ED A0       > ldi
1701   54B9 ED A0       > ldi
1701   54BB ED A0       > ldi
1701   54BD ED A0       > ldi
1701   54BF ED A0       > ldi
1701   54C1 ED A0       > ldi
1701   54C3 ED A0       > ldi
1701   54C5 ED A0       > ldi
1701   54C7 ED A0       > ldi
1701   54C9 ED A0       > ldi
1701   54CB ED A0       > ldi
1701   54CD ED A0       > ldi
1701   54CF ED A0       > ldi
1701   54D1 ED A0       > ldi
1701   54D3 ED A0       > ldi
1701   54D5 ED A0       > ldi
1701   54D7 ED A0       > ldi
1701   54D9 ED A0       > ldi
1701   54DB ED A0       > ldi
1701   54DD ED A0       > ldi
1701   54DF ED A0       > ldi
1701   54E1 ED A0       > ldi
1701   54E3 ED A0       > ldi
1701   54E5 ED A0       > ldi
1701   54E7 ED A0       > ldi
1701   54E9 ED A0       > ldi
1701   54EB ED A0       > ldi
1701   54ED ED A0       > ldi
1701   54EF ED A0       > ldi
1701   54F1 ED A0       > ldi
1701   54F3 ED A0       > ldi
1701   54F5 ED A0       > ldi
1701   54F7 ED A0       > ldi
1701   54F9 ED A0       > ldi
1701   54FB ED A0       > ldi
1701   54FD ED A0       > ldi
1701   54FF ED A0       > ldi
1701   5501 ED A0       > ldi
1701   5503 ED A0       > ldi
1701   5505 ED A0       > ldi
1701   5507 ED A0       > ldi
1701   5509 ED A0       > ldi
1701   550B ED A0       > ldi
1701   550D ED A0       > ldi
1701   550F ED A0       > ldi
1701   5511 ED A0       > ldi
1701   5513 ED A0       > ldi
1701   5515 ED A0       > ldi
1701   5517 ED A0       > ldi
1701   5519 ED A0       > ldi
1701   551B ED A0       > ldi
1701   551D ED A0       > ldi
1701   551F ED A0       > ldi
1701   5521 ED A0       > ldi
1701   5523 ED A0       > ldi
1701   5525 ED A0       > ldi
1701   5527 ED A0       > ldi
1701   5529 ED A0       > ldi
1701   552B ED A0       > ldi
1701   552D ED A0       > ldi
1701   552F ED A0       > ldi
1701   5531 ED A0       > ldi
1701   5533 ED A0       > ldi
1701   5535 ED A0       > ldi
1701   5537 ED A0       > ldi
1701   5539 ED A0       > ldi
1701   553B ED A0       > ldi
1701   553D ED A0       > ldi
1701   553F ED A0       > ldi
1701   5541 ED A0       > ldi
1701   5543 ED A0       > ldi
1701   5545 ED A0       > ldi
1701   5547 ED A0       > ldi
1701   5549 ED A0       > ldi
1701   554B ED A0       > ldi
1701   554D ED A0       > ldi
1701   554F ED A0       > ldi
1701   5551 ED A0       > ldi
1701   5553 ED A0       > ldi
1701   5555 ED A0       > ldi
1701   5557 ED A0       > ldi
1701   5559 ED A0       > ldi
1701   555B ED A0       > ldi
1701   555D ED A0       > ldi
1701   555F ED A0       > ldi
1701   5561 ED A0       > ldi
1701   5563 ED A0       > ldi
1701   5565 ED A0       > ldi
1701   5567 ED A0       > ldi
1701   5569 ED A0       > ldi
1701   556B ED A0       > ldi
1701   556D ED A0       > ldi
1701   556F ED A0       > ldi
1701   5571 ED A0       > ldi
1701   5573 ED A0       > ldi
1701   5575 ED A0       > ldi
1701   5577 ED A0       > ldi
1701   5579 ED A0       > ldi
1701   557B ED A0       > ldi
1701   557D ED A0       > ldi
1701   557F ED A0       > ldi
1701   5581 ED A0       > ldi
1701   5583 ED A0       > ldi
1701   5585 ED A0       > ldi
1701   5587 ED A0       > ldi
1701   5589 ED A0       > ldi
1701   558B ED A0       > ldi
1701   558D ED A0       > ldi
1701   558F ED A0       > ldi
1701   5591 ED A0       > ldi
1701   5593 ED A0       > ldi
1701   5595 ED A0       > ldi
1701   5597 ED A0       > ldi
1701   5599 ED A0       > ldi
1701   559B ED A0       > ldi
1701   559D ED A0       > ldi
1701   559F ED A0       > ldi
1701   55A1 ED A0       > ldi
1701   55A3 ED A0       > ldi
1701   55A5 ED A0       > ldi
1701   55A7 ED A0       > ldi
1701   55A9 ED A0       > ldi
1701   55AB ED A0       > ldi
1701   55AD ED A0       > ldi
1701   55AF ED A0       > ldi
1701   55B1 ED A0       > ldi
1701   55B3 ED A0       > ldi
1701   55B5 ED A0       > ldi
1701   55B7 ED A0       > ldi
1701   55B9 ED A0       > ldi
1701   55BB ED A0       > ldi
1701   55BD ED A0       > ldi
1701   55BF ED A0       > ldi
1701   55C1 ED A0       > ldi
1701   55C3 ED A0       > ldi
1701   55C5 ED A0       > ldi
1701   55C7 ED A0       > ldi
1701   55C9 ED A0       > ldi
1701   55CB ED A0       > ldi
1701   55CD ED A0       > ldi
1701   55CF ED A0       > ldi
1701   55D1 ED A0       > ldi
1701   55D3 ED A0       > ldi
1701   55D5 ED A0       > ldi
1701   55D7 ED A0       > ldi
1701   55D9 ED A0       > ldi
1701   55DB ED A0       > ldi
1701   55DD ED A0       > ldi
1701   55DF ED A0       > ldi
1701   55E1 ED A0       > ldi
1701   55E3 ED A0       > ldi
1701   55E5 ED A0       > ldi
1701   55E7 ED A0       > ldi
1701   55E9 ED A0       > ldi
1701   55EB ED A0       > ldi
1701   55ED ED A0       > ldi
1701   55EF ED A0       > ldi
1701   55F1 ED A0       > ldi
1701   55F3 ED A0       > ldi
1701   55F5 ED A0       > ldi
1701   55F7 ED A0       > ldi
1701   55F9 ED A0       > ldi
1701   55FB ED A0       > ldi
1701   55FD ED A0       > ldi
1701   55FF ED A0       > ldi
1701   5601 ED A0       > ldi
1701   5603 ED A0       > ldi
1701   5605 ED A0       > ldi
1701   5607 ED A0       > ldi
1701   5609 ED A0       > ldi
1701   560B ED A0       > ldi
1701   560D ED A0       > ldi
1701   560F ED A0       > ldi
1701   5611 ED A0       > ldi
1701   5613 ED A0       > ldi
1701   5615 ED A0       > ldi
1701   5617 ED A0       > ldi
1701   5619 ED A0       > ldi
1701   561B ED A0       > ldi
1701   561D ED A0       > ldi
1701   561F ED A0       > ldi
1701   5621 ED A0       > ldi
1701   5623 ED A0       > ldi
1701   5625 ED A0       > ldi
1701   5627 ED A0       > ldi
1701   5629 ED A0       > ldi
1701   562B ED A0       > ldi
1701   562D ED A0       > ldi
1701   562F ED A0       > ldi
1701   5631 ED A0       > ldi
1701   5633 ED A0       > ldi
1701   5635 ED A0       > ldi
1701   5637 ED A0       > ldi
1701   5639 ED A0       > ldi
1701   563B ED A0       > ldi
1701   563D ED A0       > ldi
1701   563F ED A0       > ldi
1701   5641 ED A0       > ldi
1701   5643 ED A0       > ldi
1701   5645 ED A0       > ldi
1701   5647 ED A0       > ldi
1701   5649 ED A0       > ldi
1701   564B ED A0       > ldi
1701   564D ED A0       > ldi
1701   564F ED A0       > ldi
1701   5651 ED A0       > ldi
1701   5653 ED A0       > ldi
1701   5655 ED A0       > ldi
1701   5657 ED A0       > ldi
1701   5659 ED A0       > ldi
1701   565B ED A0       > ldi
1701   565D ED A0       > ldi
1701   565F ED A0       > ldi
1701   5661 ED A0       > ldi
1701   5663 ED A0       > ldi
1701   5665 ED A0       > ldi
1701   5667 ED A0       > ldi
1701   5669 ED A0       > ldi
1701   566B ED A0       > ldi
1701   566D ED A0       > ldi
1701   566F ED A0       > ldi
1701   5671 ED A0       > ldi
1701   5673 ED A0       > ldi
1701   5675 ED A0       > ldi
1701   5677 ED A0       > ldi
1701   5679 ED A0       > ldi
1701   567B ED A0       > ldi
1701   567D ED A0       > ldi
1701   567F ED A0       > ldi
1701   5681 ED A0       > ldi
1701   5683 ED A0       > ldi
1701   5685 ED A0       > ldi
1701   5687 ED A0       > ldi
1701   5689 ED A0       > ldi
1701   568B ED A0       > ldi
1701   568D ED A0       > ldi
1701   568F ED A0       > ldi
1701   5691 ED A0       > ldi
1701   5693 ED A0       > ldi
1701   5695 ED A0       > ldi
1701   5697 ED A0       > ldi
1701   5699 ED A0       > ldi
1701   569B ED A0       > ldi
1701   569D ED A0       > ldi
1701   569F ED A0       > ldi
1701   56A1 ED A0       > ldi
1701   56A3 ED A0       > ldi
1701   56A5 ED A0       > ldi
1701   56A7 ED A0       > ldi
1701   56A9 ED A0       > ldi
1701   56AB ED A0       > ldi
1701   56AD ED A0       > ldi
1701   56AF ED A0       > ldi
1701   56B1 ED A0       > ldi
1701   56B3 ED A0       > ldi
1701   56B5 ED A0       > ldi
1701   56B7 ED A0       > ldi
1701   56B9 ED A0       > ldi
1701   56BB ED A0       > ldi
1701   56BD ED A0       > ldi
1701   56BF ED A0       > ldi
1701   56C1 ED A0       > ldi
1701   56C3 ED A0       > ldi
1701   56C5 ED A0       > ldi
1701   56C7 ED A0       > ldi
1701   56C9 ED A0       > ldi
1701   56CB ED A0       > ldi
1701   56CD ED A0       > ldi
1701   56CF ED A0       > ldi
1701   56D1 ED A0       > ldi
1701   56D3 ED A0       > ldi
1701   56D5 ED A0       > ldi
1701   56D7 ED A0       > ldi
1701   56D9 ED A0       > ldi
1701   56DB ED A0       > ldi
1701   56DD ED A0       > ldi
1701   56DF ED A0       > ldi
1701   56E1 ED A0       > ldi
1701   56E3 ED A0       > ldi
1701   56E5 ED A0       > ldi
1701   56E7 ED A0       > ldi
1701   56E9 ED A0       > ldi
1701   56EB ED A0       > ldi
1701   56ED ED A0       > ldi
1701   56EF ED A0       > ldi
1701   56F1 ED A0       > ldi
1701   56F3 ED A0       > ldi
1701   56F5 ED A0       > ldi
1701   56F7 ED A0       > ldi
1701   56F9 ED A0       > ldi
1701   56FB ED A0       > ldi
1701   56FD ED A0       > ldi
1701   56FF ED A0       > ldi
1701   5701 ED A0       > ldi
1701   5703 ED A0       > ldi
1701   5705 ED A0       > ldi
1701   5707 ED A0       > ldi
1701   5709 ED A0       > ldi
1701   570B ED A0       > ldi
1701   570D ED A0       > ldi
1701   570F ED A0       > ldi
1701   5711 ED A0       > ldi
1701   5713 ED A0       > ldi
1701   5715 ED A0       > ldi
1701   5717 ED A0       > ldi
1701   5719 ED A0       > ldi
1701   571B ED A0       > ldi
1701   571D ED A0       > ldi
1701   571F ED A0       > ldi
1701   5721 ED A0       > ldi
1701   5723 ED A0       > ldi
1701   5725 ED A0       > ldi
1701   5727 ED A0       > ldi
1701   5729 ED A0       > ldi
1701   572B ED A0       > ldi
1701   572D ED A0       > ldi
1701   572F ED A0       > ldi
1701   5731 ED A0       > ldi
1701   5733 ED A0       > ldi
1701   5735 ED A0       > ldi
1701   5737 ED A0       > ldi
1701   5739 ED A0       > ldi
1701   573B ED A0       > ldi
1701   573D ED A0       > ldi
1701   573F ED A0       > ldi
1701   5741 ED A0       > ldi
1701   5743 ED A0       > ldi
1701   5745 ED A0       > ldi
1701   5747 ED A0       > ldi
1701   5749 ED A0       > ldi
1701   574B ED A0       > ldi
1701   574D ED A0       > ldi
1701   574F ED A0       > ldi
1701   5751 ED A0       > ldi
1701   5753 ED A0       > ldi
1701   5755 ED A0       > ldi
1701   5757 ED A0       > ldi
1701   5759 ED A0       > ldi
1701   575B ED A0       > ldi
1701   575D ED A0       > ldi
1701   575F ED A0       > ldi
1701   5761 ED A0       > ldi
1701   5763 ED A0       > ldi
1701   5765 ED A0       > ldi
1701   5767 ED A0       > ldi
1701   5769 ED A0       > ldi
1701   576B ED A0       > ldi
1701   576D ED A0       > ldi
1701   576F ED A0       > ldi
1701   5771 ED A0       > ldi
1701   5773 ED A0       > ldi
1701   5775 ED A0       > ldi
1701   5777 ED A0       > ldi
1701   5779 ED A0       > ldi
1701   577B ED A0       > ldi
1701   577D ED A0       > ldi
1701   577F ED A0       > ldi
1701   5781 ED A0       > ldi
1701   5783 ED A0       > ldi
1701   5785 ED A0       > ldi
1701   5787 ED A0       > ldi
1701   5789 ED A0       > ldi
1701   578B ED A0       > ldi
1701   578D ED A0       > ldi
1701   578F ED A0       > ldi
1701   5791 ED A0       > ldi
1701   5793 ED A0       > ldi
1701   5795 ED A0       > ldi
1701   5797 ED A0       > ldi
1701   5799 ED A0       > ldi
1701   579B ED A0       > ldi
1701   579D ED A0       > ldi
1702   579F             .part2s: 
1703   579F EB          	ex	de,hl
1704   57A0 3A 00 7B    	ld	a, (SPIDATA)	; descarta CRC
1705   57A3             .fim: 
1706   57A3 AF          	xor	a		; zera carry para informar leitura sem erros
1707   57A4 C3 2F 4F    	jp	terminaLeituraEscritaBloco
1708   57A7             
1709   57A7             
1710   57A7             ; ------------------------------------------------
1711   57A7             ; Converte blocos para bytes. Na pratica faz
1712   57A7             ; BC DE = (BC DE) * 512
1713   57A7             ; ------------------------------------------------
1714   57A7             blocoParaByte: 
1715   57A7 41          	ld	b, c
1716   57A8 4A          	ld	c, d
1717   57A9 53          	ld	d, e
1718   57AA 1E 00       	ld	e, 0
1719   57AC CB 22       	sla	d
1720   57AE CB 11       	rl	c
1721   57B0 CB 10       	rl	b
1722   57B2 C9          	ret
1723   57B3             
1724   57B3             ; ------------------------------------------------
1725   57B3             ; Funcoes utilitarias
1726   57B3             ; ------------------------------------------------
1727   57B3             
1728   57B3             
1729   57B3             ; ------------------------------------------------
1730   57B3             ; Imprime string na tela apontada por DE
1731   57B3             ; Destroi todos os registradores
1732   57B3             ; ------------------------------------------------
1733   57B3             printString: 
1734   57B3 1A          	ld	a, (de)
1735   57B4 B7          	or	a
1736   57B5 C8          	ret	z
1737   57B6 CD A2 00    	call	CHPUT
1738   57B9 13          	inc	de
1739   57BA 18 F7       	jr	printString
1740   57BC             
1741   57BC             
1742   57BC             ; ------------------------------------------------
1743   57BC             ; Converte o byte em A para string em decimal no
1744   57BC             ; buffer apontado por DE
1745   57BC             ; Destroi AF, BC, HL, DE
1746   57BC             ; ------------------------------------------------
1747   57BC             DecToAscii: 
1748   57BC 26 00       	ld	h, 0
1749   57BE 6F          	ld	l, a		; copiar A para HL
1750   57BF FD 36 34 01 	ld	(iy+TEMP), 1	; flag para indicar que devemos cortar os zeros a esquerda
1751   57C3 01 9C FF    	ld	bc, -100	; centenas
1752   57C6 CD D4 57    	call	.num1
1753   57C9 0E F6       	ld	c, -10		; dezenas
1754   57CB CD D4 57    	call	.num1
1755   57CE FD 36 34 02 	ld	(iy+TEMP), 2	; unidade deve exibir 0 se for zero e nao corta-lo
1756   57D2 0E FF       	ld	c, -1		; unidades
1757   57D4             .num1: 
1758   57D4 3E 2F       	ld	a, '0'-1
1759   57D6             .num2: 
1760   57D6 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1761   57D7 09          	add	hl, bc		; somar com negativo
1762   57D8 38 FC       	jr	c,.num2		; ainda nao zeramos
1763   57DA ED 42       	sbc	hl, bc		; retoma valor original
1764   57DC FD 35 34    	dec	(iy+TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1765   57DF 20 08       	jr	nz,.naozero
1766   57E1 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1767   57E3 20 04       	jr	nz,.naozero
1768   57E5 FD 34 34    	inc	(iy+TEMP)	; se for zero, nao salvamos e voltamos a flag
1769   57E8 C9          	ret
1770   57E9             .naozero: 
1771   57E9 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1772   57EA 13          	inc	de		; incrementa ponteiro de destino
1773   57EB C9          	ret
1774   57EC             
1775   57EC             ; ------------------------------------------------
1776   57EC             ; Converte o byte em A para string em hexa no
1777   57EC             ; buffer apontado por DE
1778   57EC             ; Destroi AF, C, DE
1779   57EC             ; ------------------------------------------------
1780   57EC             HexToAscii: 
1781   57EC 4F          	ld	c, a
1782   57ED 1F          	rra
1783   57EE 1F          	rra
1784   57EF 1F          	rra
1785   57F0 1F          	rra
1786   57F1 CD F5 57    	call	.conv
1787   57F4 79          	ld  	a, c
1788   57F5             .conv: 
1789   57F5 E6 0F       	and	$0F
1790   57F7 C6 90       	add	a, $90
1791   57F9 27          	daa
1792   57FA CE 40       	adc	a, $40
1793   57FC 27          	daa
1794   57FD 12          	ld	(de), a
1795   57FE 13          	inc	de
1796   57FF C9          	ret
1797   5800             
1798   5800             ; ------------------------------------------------
1799   5800             ; Converte o byte em A para string em decimal e
1800   5800             ; imprime na tela
1801   5800             ; Destroi AF, BC, HL, DE
1802   5800             ; ------------------------------------------------
1803   5800             printDecToAscii: 
1804   5800 26 00       	ld	h, 0
1805   5802 6F          	ld	l, a		; copiar A para HL
1806   5803 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1807   5805 11 9C FF    	ld	de, -100	; centenas
1808   5808 CD 14 58    	call	.num1
1809   580B 1E F6       	ld	e, -10		; dezenas
1810   580D CD 14 58    	call	.num1
1811   5810 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1812   5812 1E FF       	ld	e, -1		; unidades
1813   5814             .num1: 
1814   5814 3E 2F       	ld	a, '0'-1
1815   5816             .num2: 
1816   5816 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1817   5817 19          	add	hl, de		; somar com negativo
1818   5818 38 FC       	jr	c,.num2		; ainda nao zeramos
1819   581A ED 52       	sbc	hl, de		; retoma valor original
1820   581C 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1821   581E FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1822   5820 20 02       	jr	nz,.naozero
1823   5822 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1824   5823 C9          	ret
1825   5824             .naozero: 
1826   5824 E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1827   5825 C5          	push	bc
1828   5826 CD A2 00    	call	CHPUT
1829   5829 C1          	pop	bc
1830   582A E1          	pop	hl
1831   582B C9          	ret
1832   582C             
1833   582C             ; ------------------------------------------------
1834   582C             ; Procura pelo nome do fabricante em uma tabela.
1835   582C             ; A contem o byte do fabricante
1836   582C             ; Devolve HL apontando para o buffer do fabricante
1837   582C             ; e BC com o comprimento do texto
1838   582C             ; Destroi AF, BC, HL
1839   582C             ; ------------------------------------------------
1840   582C             pegaFabricante: 
1841   582C 4F          	ld	c, a
1842   582D 21 4E 58    	ld	hl, tblFabricantes
1843   5830             
1844   5830             .loop: 
1845   5830 7E          	ld	a, (hl)
1846   5831 23          	inc	hl
1847   5832 B9          	cp	c
1848   5833 28 0C       	jr	z,.achado
1849   5835 B7          	or	a
1850   5836 28 09       	jr	z,.achado
1851   5838 C5          	push	bc
1852   5839 CD 41 58    	call	.achado
1853   583C 09          	add	hl, bc
1854   583D 23          	inc	hl
1855   583E C1          	pop	bc
1856   583F 18 EF       	jr	.loop
1857   5841             
1858   5841             .achado: 
1859   5841 0E 00       	ld	c, 0
1860   5843 E5          	push	hl
1861   5844 AF          	xor	a
1862   5845             .loop2: 
1863   5845 0C          	inc	c
1864   5846 23          	inc	hl
1865   5847 BE          	cp	(hl)
1866   5848 20 FB       	jr	nz,.loop2
1867   584A E1          	pop	hl
1868   584B 06 00       	ld	b, 0
1869   584D C9          	ret
1870   584E             
1871   584E             tblFabricantes: 
1872   584E 01          	db	1
1873   584F             	db	"Panasonic",0
1873   584F 50616E61736F6E696300
1874   5859 02          	db	2
1875   585A             	db	"Toshiba",0
1875   585A 546F736869626100
1876   5862 03          	db	3
1877   5863             	db	"SanDisk",0
1877   5863 53616E4469736B00
1878   586B 04          	db	4
1879   586C             	db	"SMI-S",0
1879   586C 534D492D5300
1880   5872 06          	db	6
1881   5873             	db	"Renesas",0
1881   5873 52656E6573617300
1882   587B 11          	db	17
1883   587C             	db	"Dane-Elec",0
1883   587C 44616E652D456C656300
1884   5886 13          	db	19
1885   5887             	db	"KingMax",0
1885   5887 4B696E674D617800
1886   588F 15          	db	21
1887   5890             	db	"Samsung",0
1887   5890 53616D73756E6700
1888   5898 18          	db	24
1889   5899             	db	"Infineon",0
1889   5899 496E66696E656F6E00
1890   58A2 1A          	db	26
1891   58A3 50 51 49 00 	db	"PQI",0
1892   58A7 1B          	db	27
1893   58A8 536F6E7900  	db	"Sony",0
1894   58AD 1C          	db	28
1895   58AE             	db	"Transcend",0
1895   58AE 5472616E7363656E6400
1896   58B8 1D          	db	29
1897   58B9             	db	"A-DATA",0
1897   58B9 412D4441544100
1898   58C0 1F          	db	31
1899   58C1             	db	"SiliconPower",0
1899   58C1 53696C69636F6E506F77657200
1900   58CE 27          	db	39
1901   58CF             	db	"Verbatim",0
1901   58CF 566572626174696D00
1902   58D8 41          	db	65
1903   58D9 4F 4B 49 00 	db	"OKI",0
1904   58DD 73          	db	115
1905   58DE             	db	"SilverHT",0
1905   58DE 53696C766572485400
1906   58E7 89          	db	137
1907   58E8             	db	"L.Data",0
1907   58E8 4C2E4461746100
1908   58EF 00          	db	0
1909   58F0             	db	"Generico",0
1909   58F0 47656E657269636F00
1910   58F9             
1911   58F9             
1912   58F9             ; ------------------------------------------------
1913   58F9             ; Restore screen parameters on MSX>=2 if they're
1914   58F9             ; not set yet
1915   58F9             ; ------------------------------------------------
1916   58F9             MYSETSCR: 
1917   58F9 3A 2D 00    	ld	a,(MSXVER)
1918   58FC B7          	or	a			; MSX1?
1919   58FD CA 6C 00    	jp	z,INITXT		; Yes, change do screen-0
1920   5900             
1921   5900 0E 23       	ld	c,$23			; Block-2, R#3
1922   5902 DD 21 F5 01 	ld 	ix,REDCLK
1923   5906 CD 5F 01    	call	EXTROM
1924   5909 E6 01       	and	1
1925   590B 47          	ld	b,a
1926   590C 3A AF FC    	ld	a,(SCRMOD)
1927   590F B8          	cp	b
1928   5910 20 1C       	jr	nz,.restore
1929   5912 0C          	inc	c
1930   5913 DD 21 F5 01 	ld 	ix,REDCLK
1931   5917 CD 5F 01    	call	EXTROM
1932   591A 47          	ld	b,a
1933   591B 0C          	inc	c
1934   591C DD 21 F5 01 	ld 	ix,REDCLK
1935   5920 CD 5F 01    	call	EXTROM
1936   5923 87          	add	a,a
1937   5924 87          	add	a,a
1938   5925 87          	add	a,a
1939   5926 87          	add	a,a
1940   5927 B0          	or	b
1941   5928 47          	ld	b,a
1942   5929 3A B0 F3    	ld	a,(LINLEN)
1943   592C B8          	cp	b
1944   592D C8          	ret	z
1945   592E             .restore: 
1946   592E AF          	xor	a		; Don't displat the function keys
1947   592F DD 21 85 01 	ld	ix,SDFSCR
1948   5933 C3 5F 01    	jp	EXTROM
1949   5936             
1950   5936             
1951   5936             
1952   5936             ; ==========================================================================
1953   5936             strTitle: 
1954   5936             	db	"FBLabs SDHC driver "
1954   5936 46424C61627320534448432064726976657220
1955   5949             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
1955   5949 76312E302E36
1956   594F 0D 0A 00    	db	13,10,0
1957   5952             
1958   5952             strBootpaused: 
1959   5952             	db	"Paused. Press <i> to show the copyright info.",13,10,0
1959   5952 5061757365642E205072657373203C693E20746F2073686F772074686520636F
1959   5972 7079726967687420696E666F2E0D0A00
1960   5982             
1961   5982             strCopyright: 
1962   5982             	db	"Copyright (c) 2014 Fabio Belavenuto",13,10
1962   5982 436F7079726967687420286329203230313420466162696F2042656C6176656E
1962   59A2 75746F0D0A
1963   59A7             	db	"Licenced under CERN OHL v1.1",13,10
1963   59A7 4C6963656E63656420756E646572204345524E204F484C2076312E310D0A
1964   59C5             	db	"http://ohwr.org/cernohl",13,10
1964   59C5 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
1965   59DE             	db	"PCB designed by Luciano Sturaro",13,10
1965   59DE 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
1965   59FE 0A
1966   59FF             	; fall throw
1967   59FF             strCrLf: 
1968   59FF 0D 0A 00    	db	13,10,0
1969   5A02             strCartao: 
1970   5A02             	db	"Slot ",0
1970   5A02 536C6F742000
1971   5A08             strVazio: 
1972   5A08             	db	"Empty",13,10,0
1972   5A08 456D7074790D0A00
1973   5A10             strNaoIdentificado: 
1974   5A10             	db	"Unknown!",13,10,0
1974   5A10 556E6B6E6F776E210D0A00
1975   5A1B             			;----------------------------------------
1976   5A1B             strMr_mp_desativada: 
1977   5A1B             	db	"Slot expander/Mapper/MegaRAM disabled",13,10,0
1977   5A1B 536C6F7420657870616E6465722F4D61707065722F4D65676152414D20646973
1977   5A3B 61626C65640D0A00
1978   5A43             strMapper: 
1979   5A43             	db	"Slot expanded and Memory Mapper enabled",13,10,0
1979   5A43 536C6F7420657870616E64656420616E64204D656D6F7279204D617070657220
1979   5A63 656E61626C65640D0A00
1980   5A6D             strMegaram: 
1981   5A6D             	db	"Slot expander and MegaRAM enabled",13,10,0
1981   5A6D 536C6F7420657870616E64657220616E64204D65676152414D20656E61626C65
1981   5A8D 640D0A00
1982   5A91             strSDV1: 
1983   5A91             	db	"SDV1 - ",0
1983   5A91 53445631202D2000
1984   5A99             strSDV2: 
1985   5A99             	db	"SDV2 - ",0
1985   5A99 53445632202D2000
1986   5AA1             
1987   5AA1             ;-----------------------------------------------------------------------------
1988   5AA1             ;
1989   5AA1             ; End of the driver code
1990   5AA1             
1991   5AA1             DRV_END: 
1992   5AA1             
1993   5AA1 FF          	ds	3ED0h-(DRV_END-DRV_START), $FF
1994   7FD0             
1995   7FD0             
