0001   0000             ; Projeto MSX SD Mapper
0002   0000             
0003   0000             ; Copyright (c) 2014 Fabio Belavenuto
0004   0000             ; Enhanced by FRS
0005   0000             
0006   0000             ; This documentation describes Open Hardware and is licensed under the CERN OHL v. 1.1.
0007   0000             ; You may redistribute and modify this documentation under the terms of the
0008   0000             ; CERN OHL v.1.1. (http://ohwr.org/cernohl). This documentation is distributed
0009   0000             ; WITHOUT ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING OF MERCHANTABILITY,
0010   0000             ; SATISFACTORY QUALITY AND FITNESS FOR A PARTICULAR PURPOSE.
0011   0000             ; Please see the CERN OHL v.1.1 for applicable conditions
0012   0000             
0013   0000             ; Technical info:
0014   0000             ; 7B00h~7EFFh	: SPI data transfer window (read/write)
0015   0000             ; 7F00h		: Interface status and card select register (read/write)
0016   0000             ;	<read>
0017   0000             ;	b0	: 0=SD card present on slot-0
0018   0000             ;	b1	: 0=SD card present on slot-1
0019   0000             ;	b2	: 0=Write protecton enabled for SD card slot-0
0020   0000             ;	b3	: 0=Write protecton enabled for SD card slot-1
0021   0000             ;	b4	: SW0 status. 0=RAM enabled, 1=RAM disabled
0022   0000             ;	b5	: SW1 status. 0=RAM mode: MegaRAM, 1=RAM mode: Memory Mapper
0023   0000             ;	b6	: Reserved for future use. Must be masked out from readings.
0024   0000             ;	b7	: 1=SPI transfer busy. 0=No ongoing SPI transfer
0025   0000             ;	<write>
0026   0000             ;	b0	: SD card slot-0 chip-select (0=selected)
0027   0000             ;	b1	: SD card slot-1 chip-select (0=selected)
0028   0000             
0029   0000             
0030   0000             	output	"driver.bin"
0031   0000             
0032   0000             ;-----------------------------------------------------------------------------
0033   0000             ;
0034   0000             ; Driver configuration constants
0035   0000             ;
0036   0000             
0037   0000             ;Driver type:
0038   0000             ;   0 for drive-based
0039   0000             ;   1 for device-based
0040   0000             
0041   0000             DRV_TYPE	equ	1
0042   0000             
0043   0000             ;Hot-plug devices support (device-based drivers only):
0044   0000             ;   0 for no hot-plug support
0045   0000             ;   1 for hot-plug support
0046   0000             
0047   0000             DRV_HOTPLUG	equ	0
0048   0000             
0049   0000             DEBUG	equ	0	;Set to 1 for debugging, 0 to normal operation
0050   0000             
0051   0000             ;Driver version
0052   0000             
0053   0000             VER_MAIN	equ	1
0054   0000             VER_SEC		equ	0
0055   0000             VER_REV		equ	6
0056   0000             
0057   0000             ;-----------------------------------------------------------------------------
0058   0000             ; Enderecos SPI
0059   0000             
0060   0000             PORTCFG		= $7F00
0061   0000             PORTSPI		= $7B00
0062   0000             
0063   0000             ; Comandos SPI:
0064   0000             CMD0	= 0  | $40
0065   0000             CMD1	= 1  | $40
0066   0000             CMD8	= 8  | $40
0067   0000             CMD9	= 9  | $40
0068   0000             CMD10	= 10 | $40
0069   0000             CMD12	= 12 | $40
0070   0000             CMD16	= 16 | $40
0071   0000             CMD17	= 17 | $40
0072   0000             CMD18	= 18 | $40
0073   0000             CMD24	= 24 | $40
0074   0000             CMD25	= 25 | $40
0075   0000             CMD55	= 55 | $40
0076   0000             CMD58	= 58 | $40
0077   0000             ACMD23	= 23 | $40
0078   0000             ACMD41	= 41 | $40
0079   0000             
0080   0000             ; Offsets da area de trabalho
0081   0000             
0082   0000             BCSD 		= 0
0083   0000             BCID1		= 16
0084   0000             BCID2		= 32
0085   0000             NUMSD		= 48	; 1 se cartao 1, 2 se cartao 2
0086   0000             FLAGSCARTAO	= 49	; Flag indicando se houve mudanca ou erro de cartao
0087   0000             NUMBLOCOS	= 50	; 1 byte
0088   0000             TEMP		= 52	; 1 byte
0089   0000             BLOCOS1		= 56	; 3 bytes
0090   0000             BLOCOS2		= 60	; 3 bytes
0091   0000             
0092   0000             
0093   0000             
0094   0000             ;-----------------------------------------------------------------------------
0095   0000             ;
0096   0000             ; Standard BIOS and work area entries
0097   0000             INITXT	= $006C		; Inicializa SCREEN0
0098   0000             CHSNS	= $009C		; Sense keyboard buffer for character
0099   0000             CHGET	= $009F		; Get character from keyboard buffer
0100   0000             CHPUT	= $00A2		; A=char
0101   0000             CLS	= $00C3		; Chamar com A=0
0102   0000             ERAFNK	= $00CC		; Erase function key display
0103   0000             SNSMAT	= $0141		; Read row of keyboard matrix
0104   0000             KILBUF	= $0156		; Clear keyboard buffer
0105   0000             EXTROM	= $015F
0106   0000             
0107   0000             ; subROM functions
0108   0000             SDFSCR	= $0185
0109   0000             REDCLK	= $01F5
0110   0000             
0111   0000             
0112   0000             ; System variables
0113   0000             MSXVER	= $002D
0114   0000             LINL40	= $F3AE		; Width
0115   0000             LINLEN	= $F3B0
0116   0000             INTFLG	= $FC9B
0117   0000             SCRMOD	= $FCAF
0118   0000             
0119   0000             
0120   0000             ;-----------------------------------------------------------------------------
0121   0000             
0122   0000             
0123   0000             	org		$4000
0124   4000             
0125   4000 FF          	ds		256, $FF		; 256 dummy bytes
0126   4100             
0127   4100             DRV_START: 
0128   4100             
0129   4100             ;-----------------------------------------------------------------------------
0130   4100             ;
0131   4100             ; Miscellaneous constants
0132   4100             ;
0133   4100             
0134   4100             ;This is a 2 byte buffer to store the address of code to be executed.
0135   4100             ;It is used by some of the kernel page 0 routines.
0136   4100             
0137   4100             CODE_ADD: 	equ	0F84Ch
0138   4100             
0139   4100             
0140   4100             ;-----------------------------------------------------------------------------
0141   4100             ;
0142   4100             ; Error codes for DEV_RW
0143   4100             ;
0144   4100             
0145   4100             ENCOMP	equ	0FFh
0146   4100             EWRERR	equ	0FEh
0147   4100             EDISK	equ	0FDh
0148   4100             ENRDY	equ	0FCh
0149   4100             EDATA	equ	0FAh
0150   4100             ERNF	equ	0F9h
0151   4100             EWPROT	equ	0F8h
0152   4100             EUFORM	equ	0F7h
0153   4100             ESEEK	equ	0F3h
0154   4100             EIFORM	equ	0F0h
0155   4100             EIDEVL	equ	0B5h
0156   4100             EIPARM	equ	08Bh
0157   4100             
0158   4100             ;-----------------------------------------------------------------------------
0159   4100             ;
0160   4100             ; Routines and information available on kernel page 0
0161   4100             ;
0162   4100             
0163   4100             ;* Get in A the current slot for page 1. Corrupts F.
0164   4100             ;  Must be called by using CALBNK to bank 0:
0165   4100             ;    xor a
0166   4100             ;    ld ix,GSLOT1
0167   4100             ;    call CALBNK
0168   4100             
0169   4100             GSLOT1	equ	402Dh
0170   4100             
0171   4100             
0172   4100             ;* This routine reads a byte from another bank.
0173   4100             ;  Must be called by using CALBNK to the desired bank,
0174   4100             ;  passing the address to be read in HL:
0175   4100             ;    ld a,<bank number>
0176   4100             ;    ld hl,<byte address>
0177   4100             ;    ld ix,RDBANK
0178   4100             ;    call CALBNK
0179   4100             
0180   4100             RDBANK	equ	403Ch
0181   4100             
0182   4100             
0183   4100             ;* This routine temporarily switches kernel main bank
0184   4100             ;  (usually bank 0, but will be 3 when running in MSX-DOS 1 mode),
0185   4100             ;  then invokes the routine whose address is at (CODE_ADD).
0186   4100             ;  It is necessary to use this routine to invoke CALBAS
0187   4100             ;  (so that kernel bank is correct in case of BASIC error)
0188   4100             ;  and to invoke DOS functions via F37Dh hook.
0189   4100             ;
0190   4100             ;  Input:  Address of code to invoke in (CODE_ADD).
0191   4100             ;          AF, BC, DE, HL, IX, IY passed to the called routine.
0192   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0193   4100             
0194   4100             CALLB0	equ	403Fh
0195   4100             
0196   4100             
0197   4100             ;* Call a routine in another bank.
0198   4100             ;  Must be used if the driver spawns across more than one bank.
0199   4100             ;
0200   4100             ;  Input:  A = bank number
0201   4100             ;          IX = routine address
0202   4100             ;          AF' = AF for the routine
0203   4100             ;          HL' = Ix for the routine
0204   4100             ;          BC, DE, HL, IY = input for the routine
0205   4100             ;  Output: AF, BC, DE, HL, IX, IY returned from the called routine.
0206   4100             
0207   4100             CALBNK	equ	4042h
0208   4100             
0209   4100             
0210   4100             ;* Get in IX the address of the SLTWRK entry for the slot passed in A,
0211   4100             ;  which will in turn contain a pointer to the allocated page 3
0212   4100             ;  work area for that slot (0 if no work area was allocated).
0213   4100             ;  If A=0, then it uses the slot currently switched in page 1.
0214   4100             ;  Returns A=current slot for page 1, if A=0 was passed.
0215   4100             ;  Corrupts F.
0216   4100             ;  Must be called by using CALBNK to bank 0:
0217   4100             ;    ld a,<slot number> (xor a for current page 1 slot)
0218   4100             ;    ex af,af'
0219   4100             ;    xor a
0220   4100             ;    ld ix,GWORK
0221   4100             ;    call CALBNK
0222   4100             
0223   4100             GWORK	equ	4045h
0224   4100             
0225   4100             
0226   4100             ;* This address contains one byte that tells how many banks
0227   4100             ;  form the Nextor kernel (or alternatively, the first bank
0228   4100             ;  number of the driver).
0229   4100             
0230   4100             K_SIZE	equ	40FEh
0231   4100             
0232   4100             
0233   4100             ;* This address contains one byte with the current bank number.
0234   4100             
0235   4100             CUR_BANK	equ	40FFh
0236   4100             
0237   4100             
0238   4100             ;-----------------------------------------------------------------------------
0239   4100             ;
0240   4100             ; Built-in format choice strings
0241   4100             ;
0242   4100             
0243   4100             NULL_MSG  equ     781Fh	;Null string (disk can't be formatted)
0244   4100             SING_DBL  equ     7820h ;"1-Single side / 2-Double side"
0245   4100             
0246   4100             
0247   4100             ;-----------------------------------------------------------------------------
0248   4100             ;
0249   4100             ; Driver signature
0250   4100             ;
0251   4100             	db	"NEXTOR_DRIVER",0
0251   4100 4E4558544F525F44524956455200
0252   410E             
0253   410E             
0254   410E             ;-----------------------------------------------------------------------------
0255   410E             ;
0256   410E             ; Driver flags:
0257   410E             ;    bit 0: 0 for drive-based, 1 for device-based
0258   410E             ;    bit 1: 1 for hot-plug devices supported (device-based drivers only)
0259   410E             
0260   410E 01          	db 1+(2*DRV_HOTPLUG)
0261   410F             
0262   410F             ;-----------------------------------------------------------------------------
0263   410F             ;
0264   410F             ; Reserved byte
0265   410F             ;
0266   410F 00          	db	0
0267   4110             
0268   4110             ;-----------------------------------------------------------------------------
0269   4110             ;
0270   4110             ; Driver name
0271   4110             ;
0272   4110             
0273   4110             DRV_NAME: 
0274   4110             	db	"SDMapper Driver"
0274   4110 53444D617070657220447269766572
0275   411F 20          	ds	32-($-DRV_NAME)," "
0276   4130             
0277   4130             
0278   4130             ;-----------------------------------------------------------------------------
0279   4130             ;
0280   4130             ; Jump table for the driver public routines
0281   4130             ;
0282   4130             
0283   4130             	; These routines are mandatory for all drivers
0284   4130                     ; (but probably you need to implement only DRV_INIT)
0285   4130             
0286   4130 C3 6C 41    	jp	DRV_TIMI
0287   4133 C3 7B 42    	jp	DRV_VERSION
0288   4136 C3 6D 41    	jp	DRV_INIT
0289   4139 C3 82 42    	jp	DRV_BASSTAT
0290   413C C3 84 42    	jp	DRV_BASDEV
0291   413F C3 86 42    	jp	DRV_EXTBIO
0292   4142 C3 87 42    	jp	DRV_DIRECT0
0293   4145 C3 87 42    	jp	DRV_DIRECT1
0294   4148 C3 87 42    	jp	DRV_DIRECT2
0295   414B C3 87 42    	jp	DRV_DIRECT3
0296   414E C3 87 42    	jp	DRV_DIRECT4
0297   4151             
0298   4151 00          	ds	15
0299   4160             
0300   4160             	; These routines are mandatory for device-based drivers
0301   4160             
0302   4160 C3 88 42    	jp	DEV_RW
0303   4163 C3 F9 42    	jp	DEV_INFO
0304   4166 C3 7F 43    	jp	DEV_STATUS
0305   4169 C3 B9 43    	jp	LUN_INFO
0306   416C             
0307   416C             
0308   416C             ;=====
0309   416C             ;=====  END of data that must be at fixed addresses
0310   416C             ;=====
0311   416C             
0312   416C             
0313   416C             ;-----------------------------------------------------------------------------
0314   416C             ;
0315   416C             ; Timer interrupt routine, it will be called on each timer interrupt
0316   416C             ; (at 50 or 60Hz), but only if DRV_INIT returns Cy=1 on its first execution.
0317   416C             
0318   416C             DRV_TIMI: 
0319   416C C9          	ret
0320   416D             
0321   416D             
0322   416D             ;-----------------------------------------------------------------------------
0323   416D             ;
0324   416D             ; Driver initialization routine, it is called twice:
0325   416D             ;
0326   416D             ; 1) First execution, for information gathering.
0327   416D             ;    Input:
0328   416D             ;      A = 0
0329   416D             ;      B = number of available drives
0330   416D             ;      HL = maximum size of allocatable work area in page 3
0331   416D             ;    Output:
0332   416D             ;      A = number of required drives (for drive-based driver only)
0333   416D             ;      HL = size of required work area in page 3
0334   416D             ;      Cy = 1 if DRV_TIMI must be hooked to the timer interrupt, 0 otherwise
0335   416D             ;
0336   416D             ; 2) Second execution, for work area and hardware initialization.
0337   416D             ;    Input:
0338   416D             ;      A = 1
0339   416D             ;      B = number of allocated drives for this controller
0340   416D             ;
0341   416D             ;    The work area address can be obtained by using GWORK.
0342   416D             ;
0343   416D             ;    If first execution requests more work area than available,
0344   416D             ;    second execution will not be done and DRV_TIMI will not be hooked
0345   416D             ;    to the timer interrupt.
0346   416D             ;
0347   416D             ;    If first execution requests more drives than available,
0348   416D             ;    as many drives as possible will be allocated, and the initialization
0349   416D             ;    procedure will continue the normal way
0350   416D             ;    (for drive-based drivers only. Device-based drivers always
0351   416D             ;     get two allocated drives.)
0352   416D             
0353   416D             DRV_INIT: 
0354   416D B7          	or	a		; Is this the 1st call? 
0355   416E 21 40 00    	ld	hl, 64		; 64 bytes of work area is needed 
0356   4171 C8          	ret	z		; Yes, return
0357   4172             
0358   4172             ; 2nd call: 
0359   4172 CD F9 58    	call	MYSETSCR		; Set the screen mode
0360   4175 CD F8 43    	call	pegaWorkArea		; HL=IY=Work area pointer
0361   4178             
0362   4178 11 36 59    	ld	de,strTitle		; prints the title 
0363   417B CD B3 57    	call	printString
0364   417E             
0365   417E CD 60 42    	call	SDMAPPERINIT		; SD-Mapper exclusive init
0366   4181             
0367   4181             SDHCDEVINIT: 	; FBLabs SDHC Interface initialization
0368   4181 AF          	xor	a			; zera flags do cartao
0369   4182 FD 77 31    	ld	(iy+FLAGSCARTAO), a
0370   4185 3E 01       	ld	a, 1			; detectar cartao 1
0371   4187 CD EA 41    	call	.detecta
0372   418A 3E 02       	ld	a, 2			; detectar cartao 2
0373   418C CD EA 41    	call	.detecta
0374   418F 01 00 00    	ld	bc, 0
0375   4192 1E 05       	ld	e, 5
0376   4194             
0377   4194             .chkStop:  ; Check if the STOP key was signaled
0378   4194 3A 9B FC    	ld	a,(INTFLG)
0379   4197 FE 04       	cp	4			; Was STOP pressed?
0380   4199 20 35       	jr	nz,.end			; No, quit as fast as possible 
0381   419B             
0382   419B             	; Handle STOP to pause and read messages, and ask for the copyright info
0383   419B 11 52 59    	ld	de,strBootpaused
0384   419E CD B3 57    	call	printString
0385   41A1 3E 07       .wait1: 	ld	a,7
0386   41A3 CD 41 01    	call	SNSMAT
0387   41A6 E6 10       	and	$10			; Is STOP still pressed?
0388   41A8 28 F7       	jr	z,.wait1		; Wait for STOP to be released
0389   41AA AF          	xor	a
0390   41AB 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0391   41AE 06 00       	ld	b,0			; b=inhibit 'i' key flag
0392   41B0 CD 9C 00    .wait2:  call	CHSNS
0393   41B3 C4 D6 41    	call	nz,.chkikey		; Wait until a key is pressed
0394   41B6 3A 9B FC    	ld	a,(INTFLG)
0395   41B9 FE 04       	cp	4			; Was STOP pressed?
0396   41BB 20 F3       	jr	nz,.wait2		; No, return
0397   41BD AF          	xor	a
0398   41BE 32 9B FC    	ld	(INTFLG),a		; Clear STOP flag
0399   41C1 CD 56 01    	call	KILBUF
0400   41C4 06 1E       	ld	b,30			; Since the user is trying pause the
0401   41C6 76          .wait3: 	halt				; boot messages, this gives him enough
0402   41C7             					; time to react and pause the next
0403   41C7             					; driver
0404   41C7 3A 9B FC    	ld	a,(INTFLG)
0405   41CA FE 04       	cp	4			; Was STOP pressed?
0406   41CC 28 02       	jr	z,.end			; quit so the next driver can process it
0407   41CE 10 F6       	djnz	.wait3			; The user will have the impression
0408   41D0             					; that he has a perfect timing.   ;)
0409   41D0             
0410   41D0             
0411   41D0             .end
0412   41D0 11 FF 59     	ld	de, strCrLf
0413   41D3 C3 B3 57    	jp	printString
0414   41D6             
0415   41D6             .chkikey: 
0416   41D6 CB 40       	bit	0,b			; Was the copyright message shown?
0417   41D8 C0          	ret	nz			; Yes, return
0418   41D9 CD 9F 00    	call	CHGET
0419   41DC FE 69       	cp	'i'
0420   41DE 28 03       	jr	z,.showcopyright
0421   41E0 FE 49       	cp	'I'
0422   41E2 C0          	ret	nz
0423   41E3             .showcopyright: 
0424   41E3 04          	inc	b			; Inhibit further presses of the i key 
0425   41E4 11 82 59    	ld	de,strCopyright
0426   41E7 C3 B3 57    	jp	printString
0427   41EA             
0428   41EA             .detecta: 
0429   41EA FD 77 30    	ld	(iy+NUMSD), a		; processo de deteccao dos cartoes
0430   41ED 11 02 5A    	ld	de, strCartao
0431   41F0 CD B3 57    	call	printString
0432   41F3 FD 7E 30    	ld	a, (iy+NUMSD)
0433   41F6 C6 30       	add	'0'
0434   41F8 CD A2 00    	call	CHPUT
0435   41FB 3E 3A       	ld	a, ':'
0436   41FD CD A2 00    	call	CHPUT
0437   4200 3E 20       	ld	a, ' '
0438   4202 CD A2 00    	call	CHPUT
0439   4205 FD 4E 30    	ld	c, (iy+NUMSD)
0440   4208 3A 00 7F    	ld	a, (PORTCFG)		; testar se cartao esta inserido
0441   420B A1          	and	c			; C contem 1 se cartao 1, 2 se cartao 2
0442   420C 28 09       	jr	z,.naoVazio
0443   420E 11 08 5A    	ld	de, strVazio		; nao tem cartao no slot
0444   4211 CD B3 57    	call	printString
0445   4214 C3 25 42    	jp	.marcaErro
0446   4217             .naoVazio: 
0447   4217 CD 6F 44    	call	detectaCartao		; tem cartao no slot, inicializar e detectar
0448   421A 30 0C       	jr	nc,.detectou
0449   421C CD BD 45    	call	desabilitaSDs
0450   421F 11 10 5A    	ld	de, strNaoIdentificado
0451   4222 CD B3 57    	call	printString
0452   4225             .marcaErro: 
0453   4225 C3 30 44    	jp	marcaErroCartao		; slot vazio ou erro de deteccao, marcar nas flags
0454   4228             .detectou: 
0455   4228 CD 47 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0456   422B DD 7E 0F    	ld	a,(ix+15)	; pegar byte SDV1 ou SDV2
0457   422E 11 91 5A    	ld	de, strSDV1	; e imprimir
0458   4231 B7          	or	a
0459   4232 28 03       	jr	z,.pula1
0460   4234 11 99 5A    	ld	de, strSDV2
0461   4237             .pula1: 
0462   4237 CD B3 57    	call	printString
0463   423A 3E 28       	ld	a,'('
0464   423C CD A2 00    	call	CHPUT
0465   423F DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0466   4242 CD 00 58    	call	printDecToAscii	; Imprimir Manufacturer ID
0467   4245 3E 29       	ld	a,')'
0468   4247 CD A2 00    	call	CHPUT
0469   424A 3E 20       	ld	a,' '
0470   424C CD A2 00    	call	CHPUT
0471   424F DD 7E 00    	ld	a,(ix)		; pegar byte do fabricante
0472   4252 CD 2C 58    	call	pegaFabricante	; achar nome do fabricante
0473   4255 EB          	ex	de,hl
0474   4256 CD B3 57    	call	printString	; e imprimir
0475   4259 11 FF 59    	ld	de,strCrLf
0476   425C CD B3 57    	call	printString
0477   425F C9          	ret
0478   4260             
0479   4260             
0480   4260             SDMAPPERINIT: 		; This block is exclusive for the SD-Mapper
0481   4260 11 1B 5A    	ld	de, strMr_mp_desativada
0482   4263 3A 00 7F    	ld	a, (PORTCFG)		; testar se mapper/megaram esta ativa
0483   4266 E6 10       	and	$10
0484   4268 28 0E       	jr	z,.print		; desativada, pula
0485   426A 11 43 5A    	ld	de, strMapper
0486   426D 3A 00 7F    	ld	a, (PORTCFG)		; ativa, testar se eh mapper ou megaram
0487   4270 E6 20       	and	$20
0488   4272 C2 B3 57    	jp	nz,printString
0489   4275 11 6D 5A    	ld	de, strMegaram		; Megaram ativa
0490   4278             .print: 
0491   4278 C3 B3 57    	jp	printString
0492   427B             
0493   427B             ;-----------------------------------------------------------------------------
0494   427B             ;
0495   427B             ; Obtain driver version
0496   427B             ;
0497   427B             ; Input:  -
0498   427B             ; Output: A = Main version number
0499   427B             ;         B = Secondary version number
0500   427B             ;         C = Revision number
0501   427B             
0502   427B             DRV_VERSION: 
0503   427B 3E 01       	ld	a, VER_MAIN
0504   427D 06 00       	ld	b, VER_SEC
0505   427F 0E 06       	ld	c, VER_REV
0506   4281 C9          	ret
0507   4282             
0508   4282             
0509   4282             ;-----------------------------------------------------------------------------
0510   4282             ;
0511   4282             ; BASIC expanded statement ("CALL") handler.
0512   4282             ; Works the expected way, except that if invoking CALBAS is needed,
0513   4282             ; it must be done via the CALLB0 routine in kernel page 0.
0514   4282             
0515   4282             DRV_BASSTAT: 
0516   4282 37          	scf
0517   4283 C9          	ret
0518   4284             
0519   4284             
0520   4284             ;-----------------------------------------------------------------------------
0521   4284             ;
0522   4284             ; BASIC expanded device handler.
0523   4284             ; Works the expected way, except that if invoking CALBAS is needed,
0524   4284             ; it must be done via the CALLB0 routine in kernel page 0.
0525   4284             
0526   4284             DRV_BASDEV: 
0527   4284 37          	scf
0528   4285 C9          	ret
0529   4286             
0530   4286             ;-----------------------------------------------------------------------------
0531   4286             ;
0532   4286             ; Extended BIOS hook.
0533   4286             ; Works the expected way, except that it must return
0534   4286             ; D'=1 if the old hook must be called, D'=0 otherwise.
0535   4286             ; It is entered with D'=1.
0536   4286             
0537   4286             DRV_EXTBIO: 
0538   4286 C9          	ret
0539   4287             
0540   4287             ;-----------------------------------------------------------------------------
0541   4287             ;
0542   4287             ; Direct calls entry points.
0543   4287             ; Calls to addresses 7850h, 7853h, 7856h, 7859h and 785Ch
0544   4287             ; in kernel banks 0 and 3 will be redirected
0545   4287             ; to DIRECT0/1/2/3/4 respectively.
0546   4287             ; Receives all register data from the caller except IX and AF'.
0547   4287             
0548   4287             DRV_DIRECT0: 
0549   4287             DRV_DIRECT1: 
0550   4287             DRV_DIRECT2: 
0551   4287             DRV_DIRECT3: 
0552   4287             DRV_DIRECT4: 
0553   4287 C9          	ret
0554   4288             
0555   4288             
0556   4288             ;=====
0557   4288             ;=====  BEGIN of DEVICE-BASED specific routines
0558   4288             ;=====
0559   4288             
0560   4288             ;-----------------------------------------------------------------------------
0561   4288             ;
0562   4288             ; Read or write logical sectors from/to a logical unit
0563   4288             ;
0564   4288             ;Input:    Cy=0 to read, 1 to write
0565   4288             ;          A = Device number, 1 to 7
0566   4288             ;          B = Number of sectors to read or write
0567   4288             ;          C = Logical unit number, 1 to 7
0568   4288             ;          HL = Source or destination memory address for the transfer
0569   4288             ;          DE = Address where the 4 byte sector number is stored.
0570   4288             ;Output:   A = Error code (the same codes of MSX-DOS are used):
0571   4288             ;              0: Ok
0572   4288             ;              .IDEVL: Invalid device or LUN
0573   4288             ;              .NRDY: Not ready
0574   4288             ;              .DISK: General unknown disk error
0575   4288             ;              .DATA: CRC error when reading
0576   4288             ;              .RNF: Sector not found
0577   4288             ;              .UFORM: Unformatted disk
0578   4288             ;              .WPROT: Write protected media, or read-only logical unit
0579   4288             ;              .WRERR: Write error
0580   4288             ;              .NCOMP: Incompatible disk.
0581   4288             ;              .SEEK: Seek error.
0582   4288             ;          B = Number of sectors actually read (in case of error only)
0583   4288             
0584   4288             DEV_RW: 
0585   4288 F5          	push	af
0586   428A BF FE 03    	cp	a, 3		; somente 2 dispositivos
0587   428C 30 10       	jr	nc,.saicomerroidl
0588   428E 0D          	dec	c		; somente 1 logical unit
0589   428F 20 0D       	jr	nz,.saicomerroidl
0590   4291 E5          	push	hl
0591   4292 CD 0E 44    	call	testaCartao	; verificar se cartao esta OK
0592   4295 E1          	pop	hl
0593   4296 30 0C       	jr	nc,.ok
0594   4298 F1          	pop	af		; retira AF guardado no inicio
0595   4299 3E FC       	ld	a, ENRDY	; Not ready
0596   429B             ;	ld	a, EDISK	; General unknown disk error
0597   429B 06 00       	ld	b, 0
0598   429D C9          	ret
0599   429E             .saicomerroidl: 
0600   429E F1          	pop	af		; retira AF guardado no inicio
0601   429F 3E B5       	ld	a, EIDEVL	; informar erro
0602   42A1 06 00       	ld	b, 0
0603   42A3 C9          	ret
0604   42A4             .ok: 
0605   42A4 FD 70 32    	ld	(iy+NUMBLOCOS), b	; guarda numero de blocos para ler/gravar
0606   42A7 E5          	push	hl
0607   42A8 D5          	push	de
0608   42A9 CD 47 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0609   42AC D1          	pop	de
0610   42AD E1          	pop	hl
0611   42AE F1          	pop	af		; retira AF guardado no inicio, para saber se eh leitura ou escrita
0612   42AF 38 1F       	jr	c,escrita	; se for escrita pulamos
0613   42B1             leitura: 
0614   42B1 1A          	ld	a, (de)		; 1. n. bloco
0615   42B2 F5          	push	af
0616   42B3 13          	inc	de
0617   42B4 1A          	ld	a, (de)		; 2. n. bloco
0618   42B5 F5          	push	af
0619   42B6 13          	inc	de
0620   42B7 1A          	ld	a, (de)		; 3. n. bloco
0621   42B8 4F          	ld	c, a
0622   42B9 13          	inc	de
0623   42BA 1A          	ld	a, (de)		; 4. n. bloco
0624   42BB 13          	inc	de
0625   42BC 47          	ld	b, a
0626   42BD F1          	pop	af
0627   42BE 57          	ld	d, a
0628   42BF F1          	pop	af		; HL = ponteiro destino
0629   42C0 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0630   42C1 CD 35 4F    	call	LerBloco	; chamar rotina de leitura de dados
0631   42C4 30 08       	jr	nc,.ok
0632   42C6 CD 30 44    	call	marcaErroCartao		; ocorreu erro na leitura, marcar erro
0633   42C9             ;	ld	a, ENRDY	; Not ready
0634   42C9 3E FD       	ld	a, EDISK	; General unknown disk error
0635   42CB 06 00       	ld	b, 0		; informar que lemos 0 blocos
0636   42CD C9          	ret
0637   42CE             .ok: 
0638   42CE AF          	xor	a		; tudo OK, informar ao Nextor
0639   42CF C9          	ret
0640   42D0             
0641   42D0             escrita: 
0642   42D0 CD 3B 44    	call	testaWP		; testar se cartao esta protegido contra escrita
0643   42D3 28 05       	jr	z,.ok
0644   42D5 3E F8       	ld	a, EWPROT	; disco protegido
0645   42D7 06 00       	ld	b, 0
0646   42D9 C9          	ret
0647   42DA             .ok: 
0648   42DA 1A          	ld	a, (de)		; 1. n. bloco
0649   42DB F5          	push	af
0650   42DC 13          	inc	de
0651   42DD 1A          	ld	a, (de)		; 2. n. bloco
0652   42DE F5          	push	af
0653   42DF 13          	inc	de
0654   42E0 1A          	ld	a, (de)		; 3. n. bloco
0655   42E1 13          	inc	de
0656   42E2 4F          	ld	c, a
0657   42E3 1A          	ld	a, (de)		; 4. n. bloco
0658   42E4 13          	inc	de
0659   42E5 47          	ld	b, a
0660   42E6 F1          	pop	af
0661   42E7 57          	ld	d, a
0662   42E8 F1          	pop	af		; HL = ponteiro destino
0663   42E9 5F          	ld	e, a		; BC DE = 32 bits numero do bloco
0664   42EA CD 6D 46    	call	GravarBloco	; chamar rotina de gravacao de dados
0665   42ED 30 08       	jr	nc,.ok2
0666   42EF CD 30 44    	call	marcaErroCartao		; ocorreu erro, marcar nas flags
0667   42F2 3E FE       	ld	a,EWRERR	; Write error
0668   42F4 06 00       	ld	b,0
0669   42F6 C9          	ret
0670   42F7             .ok2: 
0671   42F7 AF          	xor	a			; gravacao sem erros!
0672   42F8 C9          	ret
0673   42F9             
0674   42F9             ;-----------------------------------------------------------------------------
0675   42F9             ;
0676   42F9             ; Device information gathering
0677   42F9             ;
0678   42F9             ;Input:   A = Device index, 1 to 7
0679   42F9             ;         B = Information to return:
0680   42F9             ;             0: Basic information
0681   42F9             ;             1: Manufacturer name string
0682   42F9             ;             2: Device name string
0683   42F9             ;             3: Serial number string
0684   42F9             ;         HL = Pointer to a buffer in RAM
0685   42F9             ;Output:  A = Error code:
0686   42F9             ;             0: Ok
0687   42F9             ;             1: Device not available or invalid device index
0688   42F9             ;             2: Information not available, or invalid information index
0689   42F9             ;         When basic information is requested,
0690   42F9             ;         buffer filled with the following information:
0691   42F9             ;
0692   42F9             ;+0 (1): Numer of logical units, from 1 to 7. 1 if the device has no logical
0693   42F9             ;        units (which is functionally equivalent to having only one).
0694   42F9             ;+1 (1): Device flags, always zero in Beta 2.
0695   42F9             ;
0696   42F9             ; The strings must be printable ASCII string (ASCII codes 32 to 126),
0697   42F9             ; left justified and padded with spaces. All the strings are optional,
0698   42F9             ; if not available, an error must be returned.
0699   42F9             ; If a string is provided by the device in binary format, it must be reported
0700   42F9             ; as an hexadecimal, upper-cased string, preceded by the prefix "0x".
0701   42F9             ; The maximum length for a string is 64 characters;
0702   42F9             ; if the string is actually longer, the leftmost 64 characters
0703   42F9             ; should be provided.
0704   42F9             ;
0705   42F9             ; In the case of the serial number string, the same rules for the strings
0706   42F9             ; apply, except that it must be provided right-justified,
0707   42F9             ; and if it is too long, the rightmost characters must be
0708   42F9             ; provided, not the leftmost.
0709   42F9             
0710   42F9             DEV_INFO: 
0711   42F9 04          	inc	b
0712   42FB BF FE 03    	cp	a,3		; somente 2 dispositivos
0713   42FD 30 07       	jr	nc,.saicomerro
0714   42FF E5          	push	hl
0715   4300 CD 0E 44    	call	testaCartao	; verificar se cartao esta OK
0716   4303 E1          	pop	hl
0717   4304 30 03       	jr	nc,.ok		; nao houve erro
0718   4306             .saicomerro: 
0719   4306 3E 01       	ld	a, 1		; informar erro
0720   4308 C9          	ret
0721   4309             
0722   4309             .ok: 
0723   4309 10 07       	djnz	.naoBasic
0724   430B             ; Basic information:
0725   430B 3E 01       	ld	a,1		; 1 logical unit somente
0726   430D 77          	ld	(hl), a
0727   430E AF          	xor	a		; reservado, deve ser 0
0728   430F 23          	inc	hl
0729   4310 77          	ld	(hl), a
0730   4311 C9          	ret			; retorna com A=0 (OK)
0731   4312             
0732   4312             .naoBasic: 
0733   4312 E5          	push	hl
0734   4313 CD 47 44    	call	calculaCIDoffset	; calculamos em IX a posicao correta do offset CID dependendo do cartao atual
0735   4316 E1          	pop	hl
0736   4317 10 25       	djnz	.naoManuf
0737   4319             ; Manufacturer Name:
0738   4319 E5          	push	hl		; salva ponteiro do buffer
0739   431A 06 40       	ld	b, 64		; preenche buffer com espaco
0740   431C 3E 20       	ld	a, ' '
0741   431E             .loop1: 
0742   431E 77          	ld	(hl), a
0743   431F 23          	inc	hl
0744   4320 10 FC       	djnz	.loop1
0745   4322 D1          	pop	de		; recuperamos ponteiro do buffer em DE
0746   4323 3E 28       	ld	a, '('		; colocamos (xx) xxx no buffer
0747   4325 12          	ld	(de), a
0748   4326 13          	inc	de
0749   4327 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0750   432A CD BC 57    	call	DecToAscii
0751   432D 3E 29       	ld	a, ')'
0752   432F 12          	ld	(de), a
0753   4330 13          	inc	de
0754   4331 3E 20       	ld	a, ' '
0755   4333 12          	ld	(de), a
0756   4334 13          	inc	de
0757   4335 DD 7E 00    	ld	a, (ix)		; byte do fabricante
0758   4338 CD 2C 58    	call	pegaFabricante	; pegar nome do fabricante em HL
0759   433B ED B0       	ldir			; e colocar no buffer
0760   433D C9          	ret
0761   433E             
0762   433E             .naoManuf: 
0763   433E 10 1A       	djnz	.naoProduct
0764   4340             ; Product Name:
0765   4340 E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0766   4341 DD E5       	push	ix
0767   4343 E1          	pop	hl		; joga IX para HL
0768   4344 16 00       	ld	d, 0
0769   4346 1E 03       	ld	e, 3		; adiciona offset do productname em HL
0770   4348 19          	add	hl, de
0771   4349 D1          	pop	de		; recupera buffer do Nextor em DE
0772   434A 01 05 00    	ld	bc, 5		; 5 caracteres
0773   434D ED B0       	ldir			; copia nome do produto
0774   434F EB          	ex	de,hl		; troca DE com HL, agora HL aponta para Buffer do nextor atualizado
0775   4350 06 3B       	ld	b, 59		; Coloca espaco no restante do buffer
0776   4352 3E 20       	ld	a, ' '
0777   4354             .loop2: 
0778   4354 77          	ld	(hl), a
0779   4355 23          	inc	hl
0780   4356 10 FC       	djnz	.loop2
0781   4358 AF          	xor	a		; informar sem erros
0782   4359 C9          	ret
0783   435A             
0784   435A             .naoProduct: 
0785   435A             ; Serial:
0786   435A 3E 30       	ld	a, '0'		; Coloca prefixo "0x"
0787   435C 77          	ld	(hl), a
0788   435D 23          	inc	hl
0789   435E 3E 78       	ld	a, 'x'
0790   4360 77          	ld	(hl), a
0791   4361 23          	inc	hl
0792   4362 E5          	push	hl		; guarda HL que aponta para buffer do Nextor
0793   4363 DD E5       	push	ix
0794   4365 E1          	pop	hl		; joga IX para HL
0795   4366 16 00       	ld	d, 0
0796   4368 1E 09       	ld	e, 9		; adiciona offset do productname em HL
0797   436A 19          	add	hl, de
0798   436B D1          	pop	de		; recupera buffer do nextor em DE
0799   436C 06 04       	ld	b, 4		; 4 bytes do serial
0800   436E             .loop3: 
0801   436E 7E          	ld	a, (hl)
0802   436F CD EC 57    	call	HexToAscii	; converter HEXA para ASCII
0803   4372 23          	inc	hl
0804   4373 10 F9       	djnz	.loop3
0805   4375 06 36       	ld	b, 54		; Coloca espaco no restante
0806   4377 3E 20       	ld	a, ' '
0807   4379             .loop4: 
0808   4379 12          	ld	(de), a
0809   437A 13          	inc	de
0810   437B 10 FC       	djnz	.loop4
0811   437D AF          	xor	a		; informar sem erros
0812   437E C9          	ret
0813   437F             
0814   437F             ;-----------------------------------------------------------------------------
0815   437F             ;
0816   437F             ; Obtain device status
0817   437F             ;
0818   437F             ;Input:   A = Device index, 1 to 7
0819   437F             ;         B = Logical unit number, 1 to 7
0820   437F             ;             0 to return the status of the device itself.
0821   437F             ;Output:  A = Status for the specified logical unit,
0822   437F             ;             or for the whole device if 0 was specified:
0823   437F             ;                0: The device or logical unit is not available, or the
0824   437F             ;                   device or logical unit number supplied is invalid.
0825   437F             ;                1: The device or logical unit is available and has not
0826   437F             ;                   changed since the last status request.
0827   437F             ;                2: The device or logical unit is available and has changed
0828   437F             ;                   since the last status request
0829   437F             ;                   (for devices, the device has been unplugged and a
0830   437F             ;                    different device has been plugged which has been
0831   437F             ;                    assigned the same device index; for logical units,
0832   437F             ;                    the media has been changed).
0833   437F             ;                3: The device or logical unit is available, but it is not
0834   437F             ;                   possible to determine whether it has been changed
0835   437F             ;                   or not since the last status request.
0836   437F             ;
0837   437F             ; Devices not supporting hot-plugging must always return status value 1.
0838   437F             ; Non removable logical units may return values 0 and 1.
0839   437F             ;
0840   437F             ; The returned status is always relative to the previous invokation of
0841   437F             ; DEV_STATUS itself. Please read the Driver Developer Guide for more info.
0842   437F             
0843   437F             DEV_STATUS: 
0844   4380 BF FE 03    	cp	a,3		; 2 dispositivos somente
0845   4382 30 32       	jr	nc,.saicomerro
0846   4384 05          	dec	b		; 1 logical unit somente
0847   4385 20 2F       	jr	nz,.saicomerro
0848   4387             
0849   4387 F5          	push	af
0850   4388 CD F8 43    	call	pegaWorkArea	; HL=IY=Work area pointer
0851   438B F1          	pop	af
0852   438C FD 77 30    	ld	(iy+NUMSD),a	; salva numero do device atual (1 ou 2)
0853   438F 4F          	ld	c,a		; c=device number
0854   4390 3A 00 7F    	ld	a, (PORTCFG)	; testar se cartao esta inserido
0855   4393 A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
0856   4394 20 1D       	jr	nz,.cartaoComErro	; se slot do cartao estiver vazio, marcamos o erro nas flags
0857   4396 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
0858   4399 A1          	and	c
0859   439A 28 14       	jr	z,.semMudanca	; cartao nao marcado com erro, pula
0860   439C CD 6F 44    	call	detectaCartao	; erro na deteccao do cartao, tentar re-detectar
0861   439F 38 12       	jr	c,.cartaoComErro	; nao conseguimos detectar, sai com erro
0862   43A1 FD 7E 30    	ld	a, (iy+NUMSD)		; conseguimos detectar, tira erro nas flags
0863   43A4 2F          	cpl			; inverte bits para fazer o AND
0864   43A5 4F          	ld	c, a
0865   43A6 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)
0866   43A9 A1          	and	c			; limpa bit
0867   43AA FD 77 31    	ld	(iy+FLAGSCARTAO), a
0868   43AD             .comMudanca: 
0869   43AD 3E 02       	ld	a, 2		; informa ao Nextor que cartao esta OK e mudou
0870   43AF C9          	ret
0871   43B0             .semMudanca: 
0872   43B0 3E 01       	ld	a, 1		; informa ao Nextor que cartao esta OK e nao mudou
0873   43B2 C9          	ret
0874   43B3             .cartaoComErro: 
0875   43B3 CD 30 44    	call	marcaErroCartao	; marcar erro do cartao nas flags
0876   43B6             .saicomerro: 
0877   43B6 3E 00       	ld	a, 0		; informa erro
0878   43B8 C9          	ret
0879   43B9             
0880   43B9             ;-----------------------------------------------------------------------------
0881   43B9             ;
0882   43B9             ; Obtain logical unit information
0883   43B9             ;
0884   43B9             ;Input:   A  = Device index, 1 to 7
0885   43B9             ;         B  = Logical unit number, 1 to 7
0886   43B9             ;         HL = Pointer to buffer in RAM.
0887   43B9             ;Output:  A = 0: Ok, buffer filled with information.
0888   43B9             ;             1: Error, device or logical unit not available,
0889   43B9             ;                or device index or logical unit number invalid.
0890   43B9             ;         On success, buffer filled with the following information:
0891   43B9             ;
0892   43B9             ;+0 (1): Medium type:
0893   43B9             ;        0: Block device
0894   43B9             ;        1: CD or DVD reader or recorder
0895   43B9             ;        2-254: Unused. Additional codes may be defined in the future.
0896   43B9             ;        255: Other
0897   43B9             ;+1 (2): Sector size, 0 if this information does not apply or is
0898   43B9             ;        not available.
0899   43B9             ;+3 (4): Total number of available sectors.
0900   43B9             ;        0 if this information does not apply or is not available.
0901   43B9             ;+7 (1): Flags:
0902   43B9             ;        bit 0: 1 if the medium is removable.
0903   43B9             ;        bit 1: 1 if the medium is read only. A medium that can dinamically
0904   43B9             ;               be write protected or write enabled is not considered
0905   43B9             ;               to be read-only.
0906   43B9             ;        bit 2: 1 if the LUN is a floppy disk drive.
0907   43B9             ;+8 (2): Number of cylinders
0908   43B9             ;+10 (1): Number of heads
0909   43B9             ;+11 (1): Number of sectors per track
0910   43B9             ;
0911   43B9             ; Number of cylinders, heads and sectors apply to hard disks only.
0912   43B9             ; For other types of device, these fields must be zero.
0913   43B9             
0914   43B9             LUN_INFO: 
0915   43BA BF FE 03    	cp	a, 3		; somente 2 dispositivo
0916   43BC 30 0A       	jr	nc,.saicomerro
0917   43BE 05          	dec	b		; somente 1 logical unit
0918   43BF 20 07       	jr	nz,.saicomerro
0919   43C1 E5          	push	hl
0920   43C2 CD 0E 44    	call	testaCartao
0921   43C5 E1          	pop	hl
0922   43C6 30 03       	jr	nc,.ok		; nao tem erro com o cartao
0923   43C8             .saicomerro: 
0924   43C8 3E 01       	ld	a, 1		; informar erro
0925   43CA C9          	ret
0926   43CB             .ok: 
0927   43CB E5          	push	hl
0928   43CC CD 5B 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
0929   43CF E1          	pop	hl		; do cartao dependendo do cartao atual solicitado
0930   43D0 AF          	xor	a
0931   43D1 77          	ld	(hl), a		; Informar que o dispositivo eh do tipo block device
0932   43D2 23          	inc	hl
0933   43D3 77          	ld	(hl), a		; tamanho de um bloco = 512 bytes (coloca $00, $02 que é $200 = 512)
0934   43D4 23          	inc	hl
0935   43D5 3E 02       	ld	a, 2
0936   43D7 77          	ld	(hl), a
0937   43D8 23          	inc	hl
0938   43D9 DD 7E 00    	ld	a, (ix)		; copia numero de blocos total
0939   43DC 77          	ld	(hl), a
0940   43DD 23          	inc	hl
0941   43DE DD 7E 01    	ld	a, (ix+1)
0942   43E1 77          	ld	(hl), a
0943   43E2 23          	inc	hl
0944   43E3 DD 7E 02    	ld	a, (ix+2)
0945   43E6 77          	ld	(hl), a
0946   43E7 23          	inc	hl
0947   43E8 AF          	xor	a		; cartoes SD tem total de blocos em 24 bits, mas o Nextor pede numero de
0948   43E9 77          	ld	(hl), a 	; 32 bits, entao coloca 0 no MSB
0949   43EA 23          	inc	hl
0950   43EB 3E 01       	ld	a, 1		; flags: dispositivo R/W removivel
0951   43ED 77          	ld	(hl), a
0952   43EE 23          	inc	hl
0953   43EF AF          	xor	a		; CHS = 0
0954   43F0 77          	ld	(hl), a
0955   43F1 23          	inc	hl
0956   43F2 77          	ld	(hl), a
0957   43F3 23          	inc	hl
0958   43F4 77          	ld	(hl), a
0959   43F5 23          	inc	hl
0960   43F6 AF          	xor	a		; informar que dados foram preenchidos
0961   43F7 C9          	ret
0962   43F8             
0963   43F8             ;=====
0964   43F8             ;=====  END of DEVICE-BASED specific routines
0965   43F8             ;=====
0966   43F8             
0967   43F8             ;------------------------------------------------
0968   43F8             ; Rotinas auxiliares
0969   43F8             ;------------------------------------------------
0970   43F8             
0971   43F8             ;------------------------------------------------
0972   43F8             ; Pedir ao Nextor o ponteiro de dados de trabalho
0973   43F8             ; na RAM e colocar em HL e IY
0974   43F8             ; Destroi HL e IY
0975   43F8             ;------------------------------------------------
0976   43F8             pegaWorkArea: 
0977   43F8 F5          	push	af
0978   43F9 AF          	xor	a		; Pegar endereco da area de trabalho
0979   43FA 08          	ex	af,af'
0980   43FB AF          	xor	a
0981   43FC DD 21 45 40 	ld	ix, GWORK
0982   4400 CD 42 40    	call	CALBNK
0983   4403 DD 6E 00    	ld	l,(ix)		; em HL tem o ponteiro da nossa area da RAM
0984   4406 DD 66 01    	ld	h,(ix+1)
0985   4409 E5          	push	hl
0986   440A FD E1       	pop	iy		; em IY temos o mesmo ponteiro
0987   440C F1          	pop	af
0988   440D C9          	ret
0989   440E             
0990   440E             ;------------------------------------------------
0991   440E             ; Testa se cartao esta inserido e/ou houve erro
0992   440E             ; na ultima vez que foi acessado. Carry indica
0993   440E             ; erro
0994   440E             ; Destroi AF, HL, IX, C
0995   440E             ;------------------------------------------------
0996   440E             testaCartao: 
0997   440E F5          	push	af
0998   440F CD F8 43    	call	pegaWorkArea	; HL=IY=Work area pointer
0999   4412 F1          	pop	af
1000   4413 FD 77 30    	ld	(iy+NUMSD), a	; salva numero do device atual (1 ou 2)
1001   4416 4F          	ld	c, a
1002   4417 3A 00 7F    	ld	a, (PORTCFG)	; testar se cartao esta inserido
1003   441A A1          	and	c		; C contem 1 se cartao 1, 2 se cartao 2
1004   441B 20 0A       	jr	nz,.saicomerro				
1005   441D FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; testar bit de erro do cartao nas flags
1006   4420 A1          	and	c
1007   4421 28 02       	jr	z,.ok
1008   4423 37          	scf			; indica erro
1009   4424 C9          	ret
1010   4425             .ok: 
1011   4425 AF          	xor	a		; zera carry indicando sem erro
1012   4426 C9          	ret
1013   4427             .saicomerro: 
1014   4427 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marca bit de erro nas flags
1015   442A B1          	or	c
1016   442B FD 77 31    	ld	(iy+FLAGSCARTAO), a
1017   442E 37          	scf
1018   442F C9          	ret
1019   4430             
1020   4430             ;------------------------------------------------
1021   4430             ; Marcar bit de erro nas flags
1022   4430             ; Destroi AF, C
1023   4430             ;------------------------------------------------
1024   4430             marcaErroCartao: 
1025   4430 FD 4E 30    	ld	c, (iy+NUMSD)		; cartao atual (1 ou 2)
1026   4433 FD 7E 31    	ld	a, (iy+FLAGSCARTAO)	; marcar erro
1027   4436 B1          	or	c
1028   4437 FD 77 31    	ld	(iy+FLAGSCARTAO), a
1029   443A C9          	ret
1030   443B             
1031   443B             ;------------------------------------------------
1032   443B             ; Testar se cartao atual esta protegido contra
1033   443B             ; gravacao, A=0 se protegido
1034   443B             ; Destroi AF, C
1035   443B             ;------------------------------------------------
1036   443B             testaWP: 
1037   443B FD 4E 30    	ld	c, (iy+NUMSD)	; cartao atual (1 ou 2)
1038   443E CB 01       	rlc	c		; desloca para apontar para bits 2 ou 3 para cartoes 1 ou 2 respectivamente
1039   4440 CB 01       	rlc	c
1040   4442 3A 00 7F    	ld	a, (PORTCFG)	; testar se cartao esta protegido
1041   4445 A1          	and	c
1042   4446 C9          	ret			; se A for 0 cartao esta protegido
1043   4447             
1044   4447             ;------------------------------------------------
1045   4447             ; Calcula offset do buffer na RAM em HL e IX para
1046   4447             ; os dados do CID dependendo do cartao atual
1047   4447             ; Destroi AF, DE, HL e IX
1048   4447             ;------------------------------------------------
1049   4447             calculaCIDoffset: 
1050   4447 FD E5       	push	iy		; copiamos IY para HL
1051   4449 E1          	pop	hl
1052   444A 16 00       	ld	d, 0
1053   444C 1E 10       	ld	e, BCID1	; DE aponta para buffer BCID1
1054   444E FD 7E 30    	ld	a, (iy+NUMSD)	; vamos fazer IX apontar para o buffer correto
1055   4451 3D          	dec	a		; dependendo do cartao: BCID1 ou BCID2
1056   4452 28 02       	jr	z,.c1
1057   4454 1E 20       	ld	e, BCID2	; DE aponta para buffer BCID2
1058   4456             .c1: 
1059   4456 19          	add	hl, de		; HL aponta para buffer correto
1060   4457 E5          	push	hl		
1061   4458 DD E1       	pop	ix		; vamos colocar HL em IX
1062   445A C9          	ret
1063   445B             
1064   445B             ;------------------------------------------------
1065   445B             ; Calcula offset do buffer na RAM para os dados
1066   445B             ; do total de blocos dependendo do cartao atual
1067   445B             ; Offset fica em HL e IX
1068   445B             ; Destroi AF, DE, HL e IX
1069   445B             ;------------------------------------------------
1070   445B             calculaBLOCOSoffset: 
1071   445B FD E5       	push	iy		; copiamos IY para HL
1072   445D E1          	pop	hl
1073   445E 16 00       	ld	d, 0
1074   4460 1E 38       	ld	e, BLOCOS1	; DE aponta para buffer BLOCOS1
1075   4462 FD 7E 30    	ld	a, (iy+NUMSD)	; Vamos fazer IX apontar para o buffer correto
1076   4465 3D          	dec	a		; dependendo do cartao: BLOCOS1 ou BLOCOS2
1077   4466 28 02       	jr	z,.c1
1078   4468 1E 3C       	ld	e, BLOCOS2	; DE aponta para buffer BLOCOS2
1079   446A             .c1: 
1080   446A 19          	add	hl, de		; HL aponta para buffer correto
1081   446B E5          	push	hl		
1082   446C DD E1       	pop	ix		; Vamos colocar HL em IX
1083   446E C9          	ret
1084   446F             
1085   446F             
1086   446F             ;------------------------------------------------
1087   446F             ; Minhas funcoes para cartao SD
1088   446F             ;------------------------------------------------
1089   446F             
1090   446F             ;------------------------------------------------
1091   446F             ; Processo de inicializacao e deteccao do cartao.
1092   446F             ; Detecta se cartao responde, qual versao (SDV1
1093   446F             ; ou SDV2), faz a leitura do CSD e CID e calcula
1094   446F             ; o numero de blocos do cartao, colocando o CID
1095   446F             ; e total de blocos no buffer correto dependendo
1096   446F             ; do cartao 1 ou 2.
1097   446F             ; Retorna erro no carry. Se for 0 indica deteccao
1098   446F             ; com sucesso.
1099   446F             ; Destroi todos os registradores
1100   446F             ;------------------------------------------------
1101   446F             detectaCartao: 
1102   446F CD 9E 45    	call	iniciaSD	; manda pulsos de clock e comandos iniciais
1103   4472 D8          	ret	c			; retorna se erro
1104   4473 CD 3E 45    	call	testaSDCV2	; tenta inicializar um cartao SDV2
1105   4476 D8          	ret	c
1106   4477 FD E5       	push	iy		; colocar em HL buffer da RAM de trabalho
1107   4479 E1          	pop	hl		; CSD esta no offset 0, nao precisamos somar
1108   447A 3E 49       	ld	a, CMD9		; ler CSD
1109   447C CD 5F 45    	call	lerBlocoCxD
1110   447F D8          	ret	c
1111   4480 CD 47 44    	call	calculaCIDoffset	; calculamos em IX e HL a posicao correta do offset CID dependendo do cartao atual
1112   4483 3E 4A       	ld	a, CMD10	; ler CID
1113   4485 CD 5F 45    	call	lerBlocoCxD
1114   4488 D8          	ret	c
1115   4489 3E 7A       	ld	a, CMD58	; ler OCR
1116   448B 11 00 00    	ld	de, 0
1117   448E CD EF 45    	call	SD_SEND_CMD_2_ARGS_GET_R3	; enviar comando e receber resposta tipo R3
1118   4491 D8          	ret	c
1119   4492 78          	ld	a, b		; testa bit CCS do OCR que informa se cartao eh SDV1 ou SDV2
1120   4493 E6 40       	and	$40
1121   4495 DD 77 0F    	ld	(ix+15), a	; salva informacao da versao do SD (V1 ou V2) no byte 15 do CID
1122   4498 CC 33 45    	call	z,mudarTamanhoBlocoPara512	; se bit CCS do OCR for 1, eh cartao SDV2 (Block address - SDHC ou SDXD)
1123   449B D8          	ret	c		; e nao precisamos mudar tamanho do bloco para 512
1124   449C CD BD 45    	call	desabilitaSDs
1125   449F             				; agora vamos calcular o total de blocos dependendo dos dados do CSD
1126   449F CD 5B 44    	call	calculaBLOCOSoffset	; calcular em IX e HL o offset correto do buffer que armazena total de blocos
1127   44A2 FD E5       	push	iy		; copiamos IY para HL
1128   44A4 E1          	pop	hl
1129   44A5 16 00       	ld	d, 0
1130   44A7 1E 05       	ld	e, BCSD+5
1131   44A9 19          	add	hl, de		; HL aponta para buffer BCSD+5
1132   44AA FD 7E 00    	ld	a, (iy+BCSD)
1133   44AD E6 C0       	and	$C0		; testa versao do registro CSD
1134   44AF 28 06       	jr	z,.calculaCSD1
1135   44B1 FE 40       	cp	$40
1136   44B3 28 54       	jr	z,.calculaCSD2
1137   44B5 37          	scf			; versao do registro CSD nao reconhecida, informa erro na deteccao
1138   44B6 C9          	ret
1139   44B7             
1140   44B7             ; -----------------------------------
1141   44B7             ; Registro CSD versao 1, calcular da
1142   44B7             ; maneira correta para a versao 1
1143   44B7             ; -----------------------------------
1144   44B7             .calculaCSD1: 
1145   44B7 7E          	ld	a, (hl)
1146   44B8 E6 0F       	and	$0F		; isola READ_BL_LEN
1147   44BA F5          	push	af
1148   44BB 23          	inc	hl
1149   44BC 7E          	ld	a, (hl)		; 2 primeiros bits de C_SIZE
1150   44BD E6 03       	and	3
1151   44BF 57          	ld	d, a
1152   44C0 23          	inc	hl
1153   44C1 5E          	ld	e, (hl)		; 8 bits de C_SIZE (DE contem os primeiros 10 bits de C_SIZE)
1154   44C2 23          	inc	hl
1155   44C3 7E          	ld	a, (hl)
1156   44C4 E6 C0       	and	$C0		; 2 ultimos bits de C_SIZE
1157   44C6 87          	add	a, a		; rotaciona a esquerda
1158   44C7 CB 13       	rl	e		; rotaciona para DE
1159   44C9 CB 12       	rl	d
1160   44CB 87          	add	a, a		; mais uma rotacao
1161   44CC CB 13       	rl	e		; rotaciona para DE
1162   44CE CB 12       	rl	d
1163   44D0 13          	inc	de		; agora DE contem todos os 12 bits de C_SIZE, incrementa 1
1164   44D1 23          	inc	hl
1165   44D2 7E          	ld	a, (hl)		; proximo byte
1166   44D3 E6 03       	and	3		; 2 bits de C_SIZE_MUL
1167   44D5 47          	ld	b, a		; B contem os 2 bits de C_SIZE_MUL
1168   44D6 23          	inc	hl						
1169   44D7 7E          	ld	a, (hl)		; proximo byte
1170   44D8 E6 80       	and	$80		; 1 bit de C_SIZE_MUL
1171   44DA 87          	add	a, a		; rotaciona para esquerda jogando no carry
1172   44DB CB 10       	rl	b		; rotaciona para B
1173   44DD 04          	inc	b		; agora B contem os 3 bits de C_SIZE_MUL
1174   44DE 04          	inc	b		; faz B = C_SIZE_MUL + 2
1175   44DF F1          	pop	af		; volta em A o READ_BL_LEN
1176   44E0 80          	add	a, b		; A = READ_BL_LEN + (C_SIZE_MUL+2)
1177   44E1 01 00 00    	ld	bc, 0
1178   44E4 CD FD 44    	call	.eleva2
1179   44E7 5A          	ld	e, d		; aqui temos 32 bits (BC DE) com o tamanho do cartao
1180   44E8 51          	ld	d, c		; ignoramos os 8 ultimos bits em E, fazemos BC DE => 0B CD (divide por 256)
1181   44E9 48          	ld	c, b
1182   44EA 06 00       	ld	b, 0
1183   44EC CB 39       	srl	c		; rotacionamos a direita o C, carry = LSB (divide por 2)
1184   44EE CB 1A       	rr	d		; rotacionamos D e E
1185   44F0 CB 1B       	rr	e		; no final BC DE contem tamanho do cartao / 512 = numero de blocos
1186   44F2             .salvaBlocos: 
1187   44F2 DD 71 02    	ld	(ix+2), c	; colocar no buffer BLOCOS correto a quantidade de blocos
1188   44F5 DD 72 01    	ld	(ix+1), d	; que o cartao (1 ou 2) tem
1189   44F8 DD 73 00    	ld	(ix), e
1190   44FB AF          	xor	a		; limpa carry
1191   44FC C9          	ret
1192   44FD             
1193   44FD             .eleva2: 			; aqui temos: A = (READ_BL_LEN + (C_SIZE_MUL+2))
1194   44FD             				; BC = 0
1195   44FD             				; DE = C_SIZE
1196   44FD CB 23       	sla	e		; rotacionamos C_SIZE por 'A' vezes
1197   44FF CB 12       	rl	d
1198   4501 CB 11       	rl	c
1199   4503 CB 10       	rl	b
1200   4505 3D          	dec	a		; subtraimos 1
1201   4506 20 F5       	jr	nz,.eleva2
1202   4508 C9          	ret			; em BC DE temos o tamanho do cartao (bytes) em 32 bits
1203   4509             
1204   4509             ; -----------------------------------
1205   4509             ; Registro CSD versao 2, calcular da
1206   4509             ; maneira correta para a versao 2
1207   4509             ; -----------------------------------
1208   4509             .calculaCSD2: 
1209   4509 23          	inc	hl		; HL ja aponta para BCSD+5, fazer HL apontar para BCSD+7
1210   450A 23          	inc	hl
1211   450B 7E          	ld	a, (hl)
1212   450C E6 3F       	and	$3F
1213   450E 4F          	ld	c, a
1214   450F 23          	inc	hl
1215   4510 56          	ld	d, (hl)
1216   4511 23          	inc	hl
1217   4512 5E          	ld	e, (hl)
1218   4513 CD 1F 45    	call	.inc32		; soma 1
1219   4516 CD 27 45    	call	.desloca32	; multiplica por 512
1220   4519 CD 2C 45    	call	.rotaciona24	; multiplica por 2
1221   451C C3 F2 44    	jp		.salvaBlocos
1222   451F             
1223   451F             .inc32: 
1224   451F 1C          	inc	e
1225   4520 C0          	ret	nz
1226   4521 14          	inc	d
1227   4522 C0          	ret	nz
1228   4523 0C          	inc	c
1229   4524 C0          	ret	nz
1230   4525 04          	inc	b
1231   4526 C9          	ret
1232   4527             
1233   4527             .desloca32: 
1234   4527 41          	ld	b, c
1235   4528 4A          	ld	c, d
1236   4529 53          	ld	d, e
1237   452A 1E 00       	ld	e, 0
1238   452C             .rotaciona24: 
1239   452C CB 22       	sla	d
1240   452E CB 11       	rl	c
1241   4530 CB 10       	rl	b
1242   4532 C9          	ret
1243   4533             
1244   4533             ; ------------------------------------------------
1245   4533             ; Setar o tamanho do bloco para 512 se o cartao
1246   4533             ; for SDV1
1247   4533             ; ------------------------------------------------
1248   4533             mudarTamanhoBlocoPara512: 
1249   4533 3E 50       	ld	a, CMD16
1250   4535 01 00 00    	ld	bc, 0
1251   4538 11 00 02    	ld	de, 512
1252   453B C3 DA 45    	jp	SD_SEND_CMD_GET_ERROR
1253   453E             
1254   453E             ; ------------------------------------------------
1255   453E             ; Tenta inicializar um cartao SDV2, se houver erro
1256   453E             ; o cartao deve ser SDV1
1257   453E             ; ------------------------------------------------
1258   453E             testaSDCV2: 
1259   453E 3E 48       	ld	a, CMD8
1260   4540 11 AA 01    	ld	de, $1AA
1261   4543 CD EF 45    	call	SD_SEND_CMD_2_ARGS_GET_R3
1262   4546 21 D3 45    	ld	hl, SD_SEND_CMD1	; HL aponta para rotina correta
1263   4549 38 03       	jr	c,.pula		; cartao recusou CMD8, enviar comando CMD1
1264   454B 21 C5 45    	ld	hl, SD_SEND_ACMD41	; cartao aceitou CMD8, enviar comando ACMD41
1265   454E             .pula: 
1266   454E 01 14 00    	ld	bc, 20		; B = 0, C = 20: 5120 tentativas
1267   4551             .loop: 
1268   4551 C5          	push	bc
1269   4552 CD 5E 45    	call	.jumpHL		; chamar rotina correta em HL
1270   4555 C1          	pop	bc
1271   4556 D0          	ret	nc
1272   4557 10 F8       	djnz	.loop
1273   4559 0D          	dec	c
1274   455A 20 F5       	jr	nz,.loop
1275   455C 37          	scf
1276   455D C9          	ret
1277   455E             .jumpHL: 
1278   455E E9          	jp	(hl)		; chamar rotina correta em HL
1279   455F             
1280   455F             ; ------------------------------------------------
1281   455F             ; Ler registro CID ou CSD, o comando vem em A
1282   455F             ; ------------------------------------------------
1283   455F             lerBlocoCxD: 
1284   455F CD D5 45    	call	SD_SEND_CMD_NO_ARGS
1285   4562 D8          	ret	c
1286   4563 CD 34 46    	call	WAIT_RESP_FE
1287   4566 D8          	ret	c
1288   4567 EB          	ex	de,hl
1289   4568             
1290   4568             	; Check for a Z80 or R800
1291   4568             ;	or 	a		; Clear Cy
1292   4568 3E 14       	ld	a,20
1293   456A ED F9       	db	#ED,#F9		; mulub a,a
1294   456C 21 00 7B    	ld	hl, PORTSPI
1295   456F 38 26       	jr	c,.r800		; Use LDIR for R800
1296   4571 ED A0       > ldi	
1296   4573 ED A0       > ldi	
1296   4575 ED A0       > ldi	
1296   4577 ED A0       > ldi	
1296   4579 ED A0       > ldi	
1296   457B ED A0       > ldi	
1296   457D ED A0       > ldi	
1296   457F ED A0       > ldi	
1296   4581 ED A0       > ldi	
1296   4583 ED A0       > ldi	
1296   4585 ED A0       > ldi	
1296   4587 ED A0       > ldi	
1296   4589 ED A0       > ldi	
1296   458B ED A0       > ldi	
1296   458D ED A0       > ldi	
1296   458F ED A0       > ldi	
1297   4591             .end
1298   4591 7E           	ld	a, (hl)
1299   4592 7E          	ld	a, (hl)		; byte de resposta
1300   4593 B7          	or	a
1301   4594 EB          	ex	de,hl
1302   4595 18 26       	jr		desabilitaSDs
1303   4597             
1304   4597             .r800: 
1305   4597 01 10 00    	ld	bc,16
1306   459A ED B0       	ldir
1307   459C 18 F3       	jr	.end
1308   459E             
1309   459E             ; ------------------------------------------------
1310   459E             ; Algoritmo para inicializar um cartao SD
1311   459E             ; Destroi AF, B, DE
1312   459E             ; ------------------------------------------------
1313   459E             iniciaSD: 
1314   459E CD BD 45    	call	desabilitaSDs
1315   45A1             
1316   45A1 06 0A       	ld	b, 10		; enviar 80 pulsos de clock com cartao desabilitado
1317   45A3             enviaClocksInicio: 
1318   45A3 3E FF       	ld	a, $FF		; manter MOSI em 1
1319   45A5 32 00 7B    	ld	(PORTSPI), a
1320   45A8 10 F9       	djnz	enviaClocksInicio
1321   45AA CD 60 46    	call	setaSDAtual	; ativar cartao atual
1322   45AD 06 08       	ld	b, 8		; 8 tentativas para CMD0
1323   45AF             SD_SEND_CMD0: 
1324   45AF 3E 40       	ld	a, CMD0		; primeiro comando: CMD0
1325   45B1 11 00 00    	ld	de, 0
1326   45B4 C5          	push	bc
1327   45B5 CD E2 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1328   45B8 C1          	pop	bc
1329   45B9 D0          	ret	nc			; retorna se cartao respondeu ao CMD0
1330   45BA 10 F3       	djnz	SD_SEND_CMD0
1331   45BC 37          	scf			; cartao nao respondeu ao CMD0, informar erro
1332   45BD             	; fall throw
1333   45BD             
1334   45BD             ; ------------------------------------------------
1335   45BD             ; Desabilitar (de-selecionar) todos os cartoes
1336   45BD             ; Nao destroi registradores
1337   45BD             ; ------------------------------------------------
1338   45BD             desabilitaSDs: 
1339   45BD F5          	push	af
1340   45BE 3E FF       	ld	a, $FF		; todos os /CS em 1
1341   45C0 32 00 7F    	ld	(PORTCFG), a
1342   45C3 F1          	pop	af
1343   45C4 C9          	ret
1344   45C5             
1345   45C5             ; ------------------------------------------------
1346   45C5             ; Enviar comando ACMD41
1347   45C5             ; ------------------------------------------------
1348   45C5             SD_SEND_ACMD41: 
1349   45C5 3E 77       	ld	a, CMD55
1350   45C7 CD D5 45    	call	SD_SEND_CMD_NO_ARGS
1351   45CA 3E 69       	ld	a, ACMD41
1352   45CC 01 00 40    	ld	bc, $4000
1353   45CF 51          	ld	d, c
1354   45D0 59          	ld	e, c
1355   45D1 18 07       	jr		SD_SEND_CMD_GET_ERROR
1356   45D3             
1357   45D3             ; ------------------------------------------------
1358   45D3             ; Enviar CMD1 para cartao. Carry indica erro
1359   45D3             ; Destroi AF, BC, DE
1360   45D3             ; ------------------------------------------------
1361   45D3             SD_SEND_CMD1: 
1362   45D3 3E 41       	ld	a, CMD1
1363   45D5             SD_SEND_CMD_NO_ARGS: 
1364   45D5 01 00 00    	ld	bc, 0
1365   45D8 50          	ld	d, b
1366   45D9 59          	ld	e, c
1367   45DA             SD_SEND_CMD_GET_ERROR: 
1368   45DA CD 08 46    	call	SD_SEND_CMD
1369   45DD B7          	or	a
1370   45DE C8          	ret	z			; se A=0 nao houve erro, retornar
1371   45DF             	; fall throw
1372   45DF             
1373   45DF             ; ------------------------------------------------
1374   45DF             ; Informar erro
1375   45DF             ; Nao destroi registradores
1376   45DF             ; ------------------------------------------------
1377   45DF             setaErro: 
1378   45DF 37          	scf
1379   45E0 18 DB       	jr		desabilitaSDs
1380   45E2             
1381   45E2             ; ------------------------------------------------
1382   45E2             ; Enviar comando em A com 2 bytes de parametros
1383   45E2             ; em DE e testar retorno BUSY
1384   45E2             ; Retorna em A a resposta do cartao
1385   45E2             ; Destroi AF, BC
1386   45E2             ; ------------------------------------------------
1387   45E2             SD_SEND_CMD_2_ARGS_TEST_BUSY: 
1388   45E2 01 00 00    	ld	bc, 0
1389   45E5 CD 08 46    	call	SD_SEND_CMD
1390   45E8 47          	ld	b, a
1391   45E9 E6 FE       	and	$FE		; testar bit 0 (flag BUSY)
1392   45EB 78          	ld	a, b
1393   45EC 20 F1       	jr	nz,setaErro	; BUSY em 1, informar erro
1394   45EE C9          	ret			; sem erros
1395   45EF             
1396   45EF             ; ------------------------------------------------
1397   45EF             ; Enviar comando em A com 2 bytes de parametros
1398   45EF             ; em DE e ler resposta do tipo R3 em BC DE
1399   45EF             ; Retorna em A a resposta do cartao
1400   45EF             ; Destroi AF, BC, DE, HL
1401   45EF             ; ------------------------------------------------
1402   45EF             SD_SEND_CMD_2_ARGS_GET_R3: 
1403   45EF CD E2 45    	call	SD_SEND_CMD_2_ARGS_TEST_BUSY
1404   45F2 D8          	ret	c
1405   45F3 F5          	push	af
1406   45F4 CD 42 46    	call	WAIT_RESP_NO_FF
1407   45F7 67          	ld	h, a
1408   45F8 CD 42 46    	call	WAIT_RESP_NO_FF
1409   45FB 6F          	ld	l, a
1410   45FC CD 42 46    	call	WAIT_RESP_NO_FF
1411   45FF 57          	ld	d, a
1412   4600 CD 42 46    	call	WAIT_RESP_NO_FF
1413   4603 5F          	ld	e, a
1414   4604 44          	ld	b, h
1415   4605 4D          	ld	c, l
1416   4606 F1          	pop	af
1417   4607 C9          	ret
1418   4608             
1419   4608             ; ------------------------------------------------
1420   4608             ; Enviar comando em A com 4 bytes de parametros
1421   4608             ; em BC DE e enviar CRC correto se for CMD0 ou 
1422   4608             ; CMD8 e aguardar processamento do cartao
1423   4608             ; Destroi AF, BC
1424   4608             ; ------------------------------------------------
1425   4608             SD_SEND_CMD: 
1426   4608 CD 60 46    	call	setaSDAtual
1427   460B 32 00 7B    	ld	(PORTSPI), a
1428   460E F5          	push	af
1429   460F 78          	ld	a, b
1430   4610 32 00 7B    	ld	(PORTSPI), a
1431   4613 79          	ld	a, c
1432   4614 32 00 7B    	ld	(PORTSPI), a
1433   4617 7A          	ld	a, d
1434   4618 32 00 7B    	ld	(PORTSPI), a
1435   461B 7B          	ld	a, e
1436   461C 32 00 7B    	ld	(PORTSPI), a
1437   461F F1          	pop	af
1438   4620 FE 40       	cp	CMD0
1439   4622 06 95       	ld	b, $95		; CRC para CMD0
1440   4624 28 08       	jr	z,enviaCRC
1441   4626 FE 48       	cp	CMD8
1442   4628 06 87       	ld	b, $87		; CRC para CMD8
1443   462A 28 02       	jr	z,enviaCRC
1444   462C 06 FF       	ld	b, $FF		; CRC dummy
1445   462E             enviaCRC: 
1446   462E 78          	ld	a, b
1447   462F 32 00 7B    	ld	(PORTSPI), a
1448   4632 18 0E       	jr	WAIT_RESP_NO_FF
1449   4634             
1450   4634             ; ------------------------------------------------
1451   4634             ; Esperar que resposta do cartao seja $FE
1452   4634             ; Destroi AF, B
1453   4634             ; ------------------------------------------------
1454   4634             WAIT_RESP_FE: 
1455   4634 06 0A       	ld	b, 10		; 10 tentativas
1456   4636             .loop: 
1457   4636 C5          	push	bc
1458   4637 CD 42 46    	call	WAIT_RESP_NO_FF	; esperar resposta diferente de $FF
1459   463A C1          	pop	bc
1460   463B FE FE       	cp	$FE		; resposta é $FE ?
1461   463D C8          	ret	z		; sim, retornamos com carry=0
1462   463E 10 F6       	djnz	.loop
1463   4640 37          	scf			; erro, carry=1
1464   4641 C9          	ret
1465   4642             
1466   4642             ; ------------------------------------------------
1467   4642             ; Esperar que resposta do cartao seja diferente
1468   4642             ; de $FF
1469   4642             ; Destroi AF, BC
1470   4642             ; ------------------------------------------------
1471   4642             WAIT_RESP_NO_FF: 
1472   4642 01 01 00    	ld	bc, 1		; 256 tentativas
1473   4645             .loop: 
1474   4645 3A 00 7B    	ld	a, (PORTSPI)
1475   4648 FE FF       	cp	$FF		; testa $FF
1476   464A C0          	ret		nz		; sai se nao for $FF
1477   464B 10 F8       	djnz	.loop
1478   464D 0D          	dec	c
1479   464E 20 F5       	jr	nz,.loop
1480   4650 C9          	ret
1481   4651             
1482   4651             ; ------------------------------------------------
1483   4651             ; Esperar que resposta do cartao seja diferente
1484   4651             ; de $00
1485   4651             ; Destroi A, BC
1486   4651             ; ------------------------------------------------
1487   4651             WAIT_RESP_NO_00: 
1488   4651 01 80 00    	ld	bc, 128		; 32768 tentativas
1489   4654             .loop: 
1490   4654 3A 00 7B    	ld	a, (PORTSPI)
1491   4657 B7          	or	a
1492   4658 C0          	ret	nz			; se resposta for <> $00, sai
1493   4659 10 F9       	djnz	.loop
1494   465B 0D          	dec	c
1495   465C 20 F6       	jr	nz,.loop
1496   465E 37          	scf			; erro
1497   465F C9          	ret
1498   4660             
1499   4660             ; ------------------------------------------------
1500   4660             ; Ativa (seleciona) cartao atual baixando seu /CS
1501   4660             ; Nao destroi registradores
1502   4660             ; ------------------------------------------------
1503   4660             setaSDAtual: 
1504   4660 F5          	push	af
1505   4661 3A 00 7B    	ld	a, (PORTSPI)	; dummy read
1506   4664 FD 7E 30    	ld	a, (iy+NUMSD)
1507   4667 2F          	cpl			; inverte bits
1508   4668 32 00 7F    	ld	(PORTCFG), a
1509   466B F1          	pop	af
1510   466C C9          	ret
1511   466D             
1512   466D             
1513   466D             ; ------------------------------------------------
1514   466D             ; Grava um bloco de 512 bytes no cartao
1515   466D             ; HL aponta para o inicio dos dados
1516   466D             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1517   466D             ; Destroi AF, BC, DE, HL
1518   466D             ; ------------------------------------------------
1519   466D             GravarBloco: 
1520   466D DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1521   4670 B7          	or	a
1522   4671 CC A7 57    	call	z,blocoParaByte		; se for SDV1 coverter blocos para bytes
1523   4674 CD 60 46    	call	setaSDAtual	; selecionar cartao atual
1524   4677 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer gravar 1 ou mais blocos
1525   467A 3D          	dec	a
1526   467B CA F8 4A    	jp	z,.umBloco	; somente um bloco, gravar usando CMD24
1527   467E             
1528   467E             ; multiplos blocos
1529   467E C5          	push	bc
1530   467F D5          	push	de
1531   4680 3E 77       	ld	a, CMD55	; Multiplos blocos, mandar ACMD23 com total de blocos
1532   4682 CD D5 45    	call	SD_SEND_CMD_NO_ARGS
1533   4685 3E 57       	ld	a, ACMD23
1534   4687 01 00 00    	ld	bc, 0
1535   468A 51          	ld	d, c
1536   468B FD 5E 32    	ld	e, (iy+NUMBLOCOS)	; parametro = total de blocos a gravar
1537   468E CD DA 45    	call	SD_SEND_CMD_GET_ERROR
1538   4691 D1          	pop	de
1539   4692 C1          	pop	bc
1540   4693 DA 2F 4F    	jp	c,terminaLeituraEscritaBloco	; erro no ACMD23
1541   4696 3E 59       	ld	a, CMD25	; comando CMD25 = write multiple blocks
1542   4698 CD DA 45    	call	SD_SEND_CMD_GET_ERROR
1543   469B DA 2F 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1544   469E             .loop: 
1545   469E 3E FC       	ld	a, $FC		; mandar $FC para indicar que os proximos dados sao
1546   46A0 32 00 7B    	ld	(PORTSPI),a	; dados para gravacao
1547   46A3             	; Check for a Z80 or R800
1548   46A3 EB          	ex	de,hl
1549   46A4             ;	or 	a		; Clear Cy
1550   46A4 3E 14       	ld	a,20
1551   46A6 ED F9       	db	#ED,#F9		; mulub a,a
1552   46A8 EB          	ex	de,hl
1553   46A9 11 00 7B    	ld	de, PORTSPI
1554   46AC DA E9 4A    	jp	c,.r800m	; Use LDIR for R800
1555   46AF ED A0       > ldi		
1555   46B1 ED A0       > ldi		
1555   46B3 ED A0       > ldi		
1555   46B5 ED A0       > ldi		
1555   46B7 ED A0       > ldi		
1555   46B9 ED A0       > ldi		
1555   46BB ED A0       > ldi		
1555   46BD ED A0       > ldi		
1555   46BF ED A0       > ldi		
1555   46C1 ED A0       > ldi		
1555   46C3 ED A0       > ldi		
1555   46C5 ED A0       > ldi		
1555   46C7 ED A0       > ldi		
1555   46C9 ED A0       > ldi		
1555   46CB ED A0       > ldi		
1555   46CD ED A0       > ldi		
1555   46CF ED A0       > ldi		
1555   46D1 ED A0       > ldi		
1555   46D3 ED A0       > ldi		
1555   46D5 ED A0       > ldi		
1555   46D7 ED A0       > ldi		
1555   46D9 ED A0       > ldi		
1555   46DB ED A0       > ldi		
1555   46DD ED A0       > ldi		
1555   46DF ED A0       > ldi		
1555   46E1 ED A0       > ldi		
1555   46E3 ED A0       > ldi		
1555   46E5 ED A0       > ldi		
1555   46E7 ED A0       > ldi		
1555   46E9 ED A0       > ldi		
1555   46EB ED A0       > ldi		
1555   46ED ED A0       > ldi		
1555   46EF ED A0       > ldi		
1555   46F1 ED A0       > ldi		
1555   46F3 ED A0       > ldi		
1555   46F5 ED A0       > ldi		
1555   46F7 ED A0       > ldi		
1555   46F9 ED A0       > ldi		
1555   46FB ED A0       > ldi		
1555   46FD ED A0       > ldi		
1555   46FF ED A0       > ldi		
1555   4701 ED A0       > ldi		
1555   4703 ED A0       > ldi		
1555   4705 ED A0       > ldi		
1555   4707 ED A0       > ldi		
1555   4709 ED A0       > ldi		
1555   470B ED A0       > ldi		
1555   470D ED A0       > ldi		
1555   470F ED A0       > ldi		
1555   4711 ED A0       > ldi		
1555   4713 ED A0       > ldi		
1555   4715 ED A0       > ldi		
1555   4717 ED A0       > ldi		
1555   4719 ED A0       > ldi		
1555   471B ED A0       > ldi		
1555   471D ED A0       > ldi		
1555   471F ED A0       > ldi		
1555   4721 ED A0       > ldi		
1555   4723 ED A0       > ldi		
1555   4725 ED A0       > ldi		
1555   4727 ED A0       > ldi		
1555   4729 ED A0       > ldi		
1555   472B ED A0       > ldi		
1555   472D ED A0       > ldi		
1555   472F ED A0       > ldi		
1555   4731 ED A0       > ldi		
1555   4733 ED A0       > ldi		
1555   4735 ED A0       > ldi		
1555   4737 ED A0       > ldi		
1555   4739 ED A0       > ldi		
1555   473B ED A0       > ldi		
1555   473D ED A0       > ldi		
1555   473F ED A0       > ldi		
1555   4741 ED A0       > ldi		
1555   4743 ED A0       > ldi		
1555   4745 ED A0       > ldi		
1555   4747 ED A0       > ldi		
1555   4749 ED A0       > ldi		
1555   474B ED A0       > ldi		
1555   474D ED A0       > ldi		
1555   474F ED A0       > ldi		
1555   4751 ED A0       > ldi		
1555   4753 ED A0       > ldi		
1555   4755 ED A0       > ldi		
1555   4757 ED A0       > ldi		
1555   4759 ED A0       > ldi		
1555   475B ED A0       > ldi		
1555   475D ED A0       > ldi		
1555   475F ED A0       > ldi		
1555   4761 ED A0       > ldi		
1555   4763 ED A0       > ldi		
1555   4765 ED A0       > ldi		
1555   4767 ED A0       > ldi		
1555   4769 ED A0       > ldi		
1555   476B ED A0       > ldi		
1555   476D ED A0       > ldi		
1555   476F ED A0       > ldi		
1555   4771 ED A0       > ldi		
1555   4773 ED A0       > ldi		
1555   4775 ED A0       > ldi		
1555   4777 ED A0       > ldi		
1555   4779 ED A0       > ldi		
1555   477B ED A0       > ldi		
1555   477D ED A0       > ldi		
1555   477F ED A0       > ldi		
1555   4781 ED A0       > ldi		
1555   4783 ED A0       > ldi		
1555   4785 ED A0       > ldi		
1555   4787 ED A0       > ldi		
1555   4789 ED A0       > ldi		
1555   478B ED A0       > ldi		
1555   478D ED A0       > ldi		
1555   478F ED A0       > ldi		
1555   4791 ED A0       > ldi		
1555   4793 ED A0       > ldi		
1555   4795 ED A0       > ldi		
1555   4797 ED A0       > ldi		
1555   4799 ED A0       > ldi		
1555   479B ED A0       > ldi		
1555   479D ED A0       > ldi		
1555   479F ED A0       > ldi		
1555   47A1 ED A0       > ldi		
1555   47A3 ED A0       > ldi		
1555   47A5 ED A0       > ldi		
1555   47A7 ED A0       > ldi		
1555   47A9 ED A0       > ldi		
1555   47AB ED A0       > ldi		
1555   47AD ED A0       > ldi		
1555   47AF ED A0       > ldi		
1555   47B1 ED A0       > ldi		
1555   47B3 ED A0       > ldi		
1555   47B5 ED A0       > ldi		
1555   47B7 ED A0       > ldi		
1555   47B9 ED A0       > ldi		
1555   47BB ED A0       > ldi		
1555   47BD ED A0       > ldi		
1555   47BF ED A0       > ldi		
1555   47C1 ED A0       > ldi		
1555   47C3 ED A0       > ldi		
1555   47C5 ED A0       > ldi		
1555   47C7 ED A0       > ldi		
1555   47C9 ED A0       > ldi		
1555   47CB ED A0       > ldi		
1555   47CD ED A0       > ldi		
1555   47CF ED A0       > ldi		
1555   47D1 ED A0       > ldi		
1555   47D3 ED A0       > ldi		
1555   47D5 ED A0       > ldi		
1555   47D7 ED A0       > ldi		
1555   47D9 ED A0       > ldi		
1555   47DB ED A0       > ldi		
1555   47DD ED A0       > ldi		
1555   47DF ED A0       > ldi		
1555   47E1 ED A0       > ldi		
1555   47E3 ED A0       > ldi		
1555   47E5 ED A0       > ldi		
1555   47E7 ED A0       > ldi		
1555   47E9 ED A0       > ldi		
1555   47EB ED A0       > ldi		
1555   47ED ED A0       > ldi		
1555   47EF ED A0       > ldi		
1555   47F1 ED A0       > ldi		
1555   47F3 ED A0       > ldi		
1555   47F5 ED A0       > ldi		
1555   47F7 ED A0       > ldi		
1555   47F9 ED A0       > ldi		
1555   47FB ED A0       > ldi		
1555   47FD ED A0       > ldi		
1555   47FF ED A0       > ldi		
1555   4801 ED A0       > ldi		
1555   4803 ED A0       > ldi		
1555   4805 ED A0       > ldi		
1555   4807 ED A0       > ldi		
1555   4809 ED A0       > ldi		
1555   480B ED A0       > ldi		
1555   480D ED A0       > ldi		
1555   480F ED A0       > ldi		
1555   4811 ED A0       > ldi		
1555   4813 ED A0       > ldi		
1555   4815 ED A0       > ldi		
1555   4817 ED A0       > ldi		
1555   4819 ED A0       > ldi		
1555   481B ED A0       > ldi		
1555   481D ED A0       > ldi		
1555   481F ED A0       > ldi		
1555   4821 ED A0       > ldi		
1555   4823 ED A0       > ldi		
1555   4825 ED A0       > ldi		
1555   4827 ED A0       > ldi		
1555   4829 ED A0       > ldi		
1555   482B ED A0       > ldi		
1555   482D ED A0       > ldi		
1555   482F ED A0       > ldi		
1555   4831 ED A0       > ldi		
1555   4833 ED A0       > ldi		
1555   4835 ED A0       > ldi		
1555   4837 ED A0       > ldi		
1555   4839 ED A0       > ldi		
1555   483B ED A0       > ldi		
1555   483D ED A0       > ldi		
1555   483F ED A0       > ldi		
1555   4841 ED A0       > ldi		
1555   4843 ED A0       > ldi		
1555   4845 ED A0       > ldi		
1555   4847 ED A0       > ldi		
1555   4849 ED A0       > ldi		
1555   484B ED A0       > ldi		
1555   484D ED A0       > ldi		
1555   484F ED A0       > ldi		
1555   4851 ED A0       > ldi		
1555   4853 ED A0       > ldi		
1555   4855 ED A0       > ldi		
1555   4857 ED A0       > ldi		
1555   4859 ED A0       > ldi		
1555   485B ED A0       > ldi		
1555   485D ED A0       > ldi		
1555   485F ED A0       > ldi		
1555   4861 ED A0       > ldi		
1555   4863 ED A0       > ldi		
1555   4865 ED A0       > ldi		
1555   4867 ED A0       > ldi		
1555   4869 ED A0       > ldi		
1555   486B ED A0       > ldi		
1555   486D ED A0       > ldi		
1555   486F ED A0       > ldi		
1555   4871 ED A0       > ldi		
1555   4873 ED A0       > ldi		
1555   4875 ED A0       > ldi		
1555   4877 ED A0       > ldi		
1555   4879 ED A0       > ldi		
1555   487B ED A0       > ldi		
1555   487D ED A0       > ldi		
1555   487F ED A0       > ldi		
1555   4881 ED A0       > ldi		
1555   4883 ED A0       > ldi		
1555   4885 ED A0       > ldi		
1555   4887 ED A0       > ldi		
1555   4889 ED A0       > ldi		
1555   488B ED A0       > ldi		
1555   488D ED A0       > ldi		
1555   488F ED A0       > ldi		
1555   4891 ED A0       > ldi		
1555   4893 ED A0       > ldi		
1555   4895 ED A0       > ldi		
1555   4897 ED A0       > ldi		
1555   4899 ED A0       > ldi		
1555   489B ED A0       > ldi		
1555   489D ED A0       > ldi		
1555   489F ED A0       > ldi		
1555   48A1 ED A0       > ldi		
1555   48A3 ED A0       > ldi		
1555   48A5 ED A0       > ldi		
1555   48A7 ED A0       > ldi		
1555   48A9 ED A0       > ldi		
1555   48AB ED A0       > ldi		
1555   48AD ED A0       > ldi		
1555   48AF ED A0       > ldi		
1555   48B1 ED A0       > ldi		
1555   48B3 ED A0       > ldi		
1555   48B5 ED A0       > ldi		
1555   48B7 ED A0       > ldi		
1555   48B9 ED A0       > ldi		
1555   48BB ED A0       > ldi		
1555   48BD ED A0       > ldi		
1555   48BF ED A0       > ldi		
1555   48C1 ED A0       > ldi		
1555   48C3 ED A0       > ldi		
1555   48C5 ED A0       > ldi		
1555   48C7 ED A0       > ldi		
1555   48C9 ED A0       > ldi		
1555   48CB ED A0       > ldi		
1555   48CD ED A0       > ldi		
1555   48CF ED A0       > ldi		
1555   48D1 ED A0       > ldi		
1555   48D3 ED A0       > ldi		
1555   48D5 ED A0       > ldi		
1555   48D7 ED A0       > ldi		
1555   48D9 ED A0       > ldi		
1555   48DB ED A0       > ldi		
1555   48DD ED A0       > ldi		
1555   48DF ED A0       > ldi		
1555   48E1 ED A0       > ldi		
1555   48E3 ED A0       > ldi		
1555   48E5 ED A0       > ldi		
1555   48E7 ED A0       > ldi		
1555   48E9 ED A0       > ldi		
1555   48EB ED A0       > ldi		
1555   48ED ED A0       > ldi		
1555   48EF ED A0       > ldi		
1555   48F1 ED A0       > ldi		
1555   48F3 ED A0       > ldi		
1555   48F5 ED A0       > ldi		
1555   48F7 ED A0       > ldi		
1555   48F9 ED A0       > ldi		
1555   48FB ED A0       > ldi		
1555   48FD ED A0       > ldi		
1555   48FF ED A0       > ldi		
1555   4901 ED A0       > ldi		
1555   4903 ED A0       > ldi		
1555   4905 ED A0       > ldi		
1555   4907 ED A0       > ldi		
1555   4909 ED A0       > ldi		
1555   490B ED A0       > ldi		
1555   490D ED A0       > ldi		
1555   490F ED A0       > ldi		
1555   4911 ED A0       > ldi		
1555   4913 ED A0       > ldi		
1555   4915 ED A0       > ldi		
1555   4917 ED A0       > ldi		
1555   4919 ED A0       > ldi		
1555   491B ED A0       > ldi		
1555   491D ED A0       > ldi		
1555   491F ED A0       > ldi		
1555   4921 ED A0       > ldi		
1555   4923 ED A0       > ldi		
1555   4925 ED A0       > ldi		
1555   4927 ED A0       > ldi		
1555   4929 ED A0       > ldi		
1555   492B ED A0       > ldi		
1555   492D ED A0       > ldi		
1555   492F ED A0       > ldi		
1555   4931 ED A0       > ldi		
1555   4933 ED A0       > ldi		
1555   4935 ED A0       > ldi		
1555   4937 ED A0       > ldi		
1555   4939 ED A0       > ldi		
1555   493B ED A0       > ldi		
1555   493D ED A0       > ldi		
1555   493F ED A0       > ldi		
1555   4941 ED A0       > ldi		
1555   4943 ED A0       > ldi		
1555   4945 ED A0       > ldi		
1555   4947 ED A0       > ldi		
1555   4949 ED A0       > ldi		
1555   494B ED A0       > ldi		
1555   494D ED A0       > ldi		
1555   494F ED A0       > ldi		
1555   4951 ED A0       > ldi		
1555   4953 ED A0       > ldi		
1555   4955 ED A0       > ldi		
1555   4957 ED A0       > ldi		
1555   4959 ED A0       > ldi		
1555   495B ED A0       > ldi		
1555   495D ED A0       > ldi		
1555   495F ED A0       > ldi		
1555   4961 ED A0       > ldi		
1555   4963 ED A0       > ldi		
1555   4965 ED A0       > ldi		
1555   4967 ED A0       > ldi		
1555   4969 ED A0       > ldi		
1555   496B ED A0       > ldi		
1555   496D ED A0       > ldi		
1555   496F ED A0       > ldi		
1555   4971 ED A0       > ldi		
1555   4973 ED A0       > ldi		
1555   4975 ED A0       > ldi		
1555   4977 ED A0       > ldi		
1555   4979 ED A0       > ldi		
1555   497B ED A0       > ldi		
1555   497D ED A0       > ldi		
1555   497F ED A0       > ldi		
1555   4981 ED A0       > ldi		
1555   4983 ED A0       > ldi		
1555   4985 ED A0       > ldi		
1555   4987 ED A0       > ldi		
1555   4989 ED A0       > ldi		
1555   498B ED A0       > ldi		
1555   498D ED A0       > ldi		
1555   498F ED A0       > ldi		
1555   4991 ED A0       > ldi		
1555   4993 ED A0       > ldi		
1555   4995 ED A0       > ldi		
1555   4997 ED A0       > ldi		
1555   4999 ED A0       > ldi		
1555   499B ED A0       > ldi		
1555   499D ED A0       > ldi		
1555   499F ED A0       > ldi		
1555   49A1 ED A0       > ldi		
1555   49A3 ED A0       > ldi		
1555   49A5 ED A0       > ldi		
1555   49A7 ED A0       > ldi		
1555   49A9 ED A0       > ldi		
1555   49AB ED A0       > ldi		
1555   49AD ED A0       > ldi		
1555   49AF ED A0       > ldi		
1555   49B1 ED A0       > ldi		
1555   49B3 ED A0       > ldi		
1555   49B5 ED A0       > ldi		
1555   49B7 ED A0       > ldi		
1555   49B9 ED A0       > ldi		
1555   49BB ED A0       > ldi		
1555   49BD ED A0       > ldi		
1555   49BF ED A0       > ldi		
1555   49C1 ED A0       > ldi		
1555   49C3 ED A0       > ldi		
1555   49C5 ED A0       > ldi		
1555   49C7 ED A0       > ldi		
1555   49C9 ED A0       > ldi		
1555   49CB ED A0       > ldi		
1555   49CD ED A0       > ldi		
1555   49CF ED A0       > ldi		
1555   49D1 ED A0       > ldi		
1555   49D3 ED A0       > ldi		
1555   49D5 ED A0       > ldi		
1555   49D7 ED A0       > ldi		
1555   49D9 ED A0       > ldi		
1555   49DB ED A0       > ldi		
1555   49DD ED A0       > ldi		
1555   49DF ED A0       > ldi		
1555   49E1 ED A0       > ldi		
1555   49E3 ED A0       > ldi		
1555   49E5 ED A0       > ldi		
1555   49E7 ED A0       > ldi		
1555   49E9 ED A0       > ldi		
1555   49EB ED A0       > ldi		
1555   49ED ED A0       > ldi		
1555   49EF ED A0       > ldi		
1555   49F1 ED A0       > ldi		
1555   49F3 ED A0       > ldi		
1555   49F5 ED A0       > ldi		
1555   49F7 ED A0       > ldi		
1555   49F9 ED A0       > ldi		
1555   49FB ED A0       > ldi		
1555   49FD ED A0       > ldi		
1555   49FF ED A0       > ldi		
1555   4A01 ED A0       > ldi		
1555   4A03 ED A0       > ldi		
1555   4A05 ED A0       > ldi		
1555   4A07 ED A0       > ldi		
1555   4A09 ED A0       > ldi		
1555   4A0B ED A0       > ldi		
1555   4A0D ED A0       > ldi		
1555   4A0F ED A0       > ldi		
1555   4A11 ED A0       > ldi		
1555   4A13 ED A0       > ldi		
1555   4A15 ED A0       > ldi		
1555   4A17 ED A0       > ldi		
1555   4A19 ED A0       > ldi		
1555   4A1B ED A0       > ldi		
1555   4A1D ED A0       > ldi		
1555   4A1F ED A0       > ldi		
1555   4A21 ED A0       > ldi		
1555   4A23 ED A0       > ldi		
1555   4A25 ED A0       > ldi		
1555   4A27 ED A0       > ldi		
1555   4A29 ED A0       > ldi		
1555   4A2B ED A0       > ldi		
1555   4A2D ED A0       > ldi		
1555   4A2F ED A0       > ldi		
1555   4A31 ED A0       > ldi		
1555   4A33 ED A0       > ldi		
1555   4A35 ED A0       > ldi		
1555   4A37 ED A0       > ldi		
1555   4A39 ED A0       > ldi		
1555   4A3B ED A0       > ldi		
1555   4A3D ED A0       > ldi		
1555   4A3F ED A0       > ldi		
1555   4A41 ED A0       > ldi		
1555   4A43 ED A0       > ldi		
1555   4A45 ED A0       > ldi		
1555   4A47 ED A0       > ldi		
1555   4A49 ED A0       > ldi		
1555   4A4B ED A0       > ldi		
1555   4A4D ED A0       > ldi		
1555   4A4F ED A0       > ldi		
1555   4A51 ED A0       > ldi		
1555   4A53 ED A0       > ldi		
1555   4A55 ED A0       > ldi		
1555   4A57 ED A0       > ldi		
1555   4A59 ED A0       > ldi		
1555   4A5B ED A0       > ldi		
1555   4A5D ED A0       > ldi		
1555   4A5F ED A0       > ldi		
1555   4A61 ED A0       > ldi		
1555   4A63 ED A0       > ldi		
1555   4A65 ED A0       > ldi		
1555   4A67 ED A0       > ldi		
1555   4A69 ED A0       > ldi		
1555   4A6B ED A0       > ldi		
1555   4A6D ED A0       > ldi		
1555   4A6F ED A0       > ldi		
1555   4A71 ED A0       > ldi		
1555   4A73 ED A0       > ldi		
1555   4A75 ED A0       > ldi		
1555   4A77 ED A0       > ldi		
1555   4A79 ED A0       > ldi		
1555   4A7B ED A0       > ldi		
1555   4A7D ED A0       > ldi		
1555   4A7F ED A0       > ldi		
1555   4A81 ED A0       > ldi		
1555   4A83 ED A0       > ldi		
1555   4A85 ED A0       > ldi		
1555   4A87 ED A0       > ldi		
1555   4A89 ED A0       > ldi		
1555   4A8B ED A0       > ldi		
1555   4A8D ED A0       > ldi		
1555   4A8F ED A0       > ldi		
1555   4A91 ED A0       > ldi		
1555   4A93 ED A0       > ldi		
1555   4A95 ED A0       > ldi		
1555   4A97 ED A0       > ldi		
1555   4A99 ED A0       > ldi		
1555   4A9B ED A0       > ldi		
1555   4A9D ED A0       > ldi		
1555   4A9F ED A0       > ldi		
1555   4AA1 ED A0       > ldi		
1555   4AA3 ED A0       > ldi		
1555   4AA5 ED A0       > ldi		
1555   4AA7 ED A0       > ldi		
1555   4AA9 ED A0       > ldi		
1555   4AAB ED A0       > ldi		
1555   4AAD ED A0       > ldi		
1556   4AAF             .part2m: 
1557   4AAF 3E FF       	ld	a, $FF		; envia dummy CRC
1558   4AB1 32 00 7B    	ld	(PORTSPI),a
1559   4AB4 32 00 7B    	ld	(PORTSPI),a
1560   4AB7 CD 42 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1561   4ABA E6 1F       	and	$1F		; testa bits erro
1562   4ABC FE 05       	cp	5
1563   4ABE 37          	scf
1564   4ABF C2 2F 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1565   4AC2 CD 51 46    	call	WAIT_RESP_NO_00	; esperar cartao
1566   4AC5 DA 2F 4F    	jp	c,terminaLeituraEscritaBloco
1567   4AC8 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para gravar
1568   4ACB 3D          	dec	a
1569   4ACC FD 77 32    	ld	(iy+NUMBLOCOS), a
1570   4ACF C2 9E 46    	jp	nz,.loop
1571   4AD2 3A 00 7B    	ld	a, (PORTSPI)	; acabou os blocos, fazer 2 dummy reads
1572   4AD5 3A 00 7B    	ld	a, (PORTSPI)
1573   4AD8 3E FD       	ld	a, $FD		; enviar $FD para informar ao cartao que acabou os dados
1574   4ADA 32 00 7B    	ld	(PORTSPI),a
1575   4ADD 3A 00 7B    	ld	a, (PORTSPI)	; dummy reads
1576   4AE0 3A 00 7B    	ld	a, (PORTSPI)
1577   4AE3 CD 51 46    	call	WAIT_RESP_NO_00	; esperar cartao
1578   4AE6 C3 2E 4F    	jp	.fim		; CMD25 concluido, sair informando nenhum erro
1579   4AE9             
1580   4AE9 01 00 02    .r800m: 	ld	bc,512
1581   4AEC ED B0       	ldir
1582   4AEE 18 BF       	jr	.part2m
1583   4AF0             
1584   4AF0 01 00 02    .r800s: 	ld	bc,512
1585   4AF3 ED B0       	ldir
1586   4AF5 C3 10 4F    	jp	.part2s
1587   4AF8             
1588   4AF8             .umBloco: 
1589   4AF8 3E 58       	ld	a, CMD24	; gravar somente um bloco com comando CMD24 = Write Single Block
1590   4AFA CD DA 45    	call	SD_SEND_CMD_GET_ERROR
1591   4AFD DA 2F 4F    	jp	c,terminaLeituraEscritaBloco	; erro
1592   4B00             
1593   4B00 3E FE       	ld	a, $FE		; mandar $FE para indicar que vamos mandar dados para gravacao
1594   4B02 32 00 7B    	ld	(PORTSPI),a
1595   4B05             
1596   4B05             	; Check for a Z80 or R800
1597   4B05 EB          	ex	de,hl
1598   4B06             ;	or 	a		; Clear Cy
1599   4B06 3E 14       	ld	a,20
1600   4B08 ED F9       	db	#ED,#F9		; mulub a,a
1601   4B0A EB          	ex	de,hl
1602   4B0B 11 00 7B    	ld	de, PORTSPI
1603   4B0E 38 E0       	jr	c,.r800s	; Use LDIR for R800
1604   4B10 ED A0       > ldi
1604   4B12 ED A0       > ldi
1604   4B14 ED A0       > ldi
1604   4B16 ED A0       > ldi
1604   4B18 ED A0       > ldi
1604   4B1A ED A0       > ldi
1604   4B1C ED A0       > ldi
1604   4B1E ED A0       > ldi
1604   4B20 ED A0       > ldi
1604   4B22 ED A0       > ldi
1604   4B24 ED A0       > ldi
1604   4B26 ED A0       > ldi
1604   4B28 ED A0       > ldi
1604   4B2A ED A0       > ldi
1604   4B2C ED A0       > ldi
1604   4B2E ED A0       > ldi
1604   4B30 ED A0       > ldi
1604   4B32 ED A0       > ldi
1604   4B34 ED A0       > ldi
1604   4B36 ED A0       > ldi
1604   4B38 ED A0       > ldi
1604   4B3A ED A0       > ldi
1604   4B3C ED A0       > ldi
1604   4B3E ED A0       > ldi
1604   4B40 ED A0       > ldi
1604   4B42 ED A0       > ldi
1604   4B44 ED A0       > ldi
1604   4B46 ED A0       > ldi
1604   4B48 ED A0       > ldi
1604   4B4A ED A0       > ldi
1604   4B4C ED A0       > ldi
1604   4B4E ED A0       > ldi
1604   4B50 ED A0       > ldi
1604   4B52 ED A0       > ldi
1604   4B54 ED A0       > ldi
1604   4B56 ED A0       > ldi
1604   4B58 ED A0       > ldi
1604   4B5A ED A0       > ldi
1604   4B5C ED A0       > ldi
1604   4B5E ED A0       > ldi
1604   4B60 ED A0       > ldi
1604   4B62 ED A0       > ldi
1604   4B64 ED A0       > ldi
1604   4B66 ED A0       > ldi
1604   4B68 ED A0       > ldi
1604   4B6A ED A0       > ldi
1604   4B6C ED A0       > ldi
1604   4B6E ED A0       > ldi
1604   4B70 ED A0       > ldi
1604   4B72 ED A0       > ldi
1604   4B74 ED A0       > ldi
1604   4B76 ED A0       > ldi
1604   4B78 ED A0       > ldi
1604   4B7A ED A0       > ldi
1604   4B7C ED A0       > ldi
1604   4B7E ED A0       > ldi
1604   4B80 ED A0       > ldi
1604   4B82 ED A0       > ldi
1604   4B84 ED A0       > ldi
1604   4B86 ED A0       > ldi
1604   4B88 ED A0       > ldi
1604   4B8A ED A0       > ldi
1604   4B8C ED A0       > ldi
1604   4B8E ED A0       > ldi
1604   4B90 ED A0       > ldi
1604   4B92 ED A0       > ldi
1604   4B94 ED A0       > ldi
1604   4B96 ED A0       > ldi
1604   4B98 ED A0       > ldi
1604   4B9A ED A0       > ldi
1604   4B9C ED A0       > ldi
1604   4B9E ED A0       > ldi
1604   4BA0 ED A0       > ldi
1604   4BA2 ED A0       > ldi
1604   4BA4 ED A0       > ldi
1604   4BA6 ED A0       > ldi
1604   4BA8 ED A0       > ldi
1604   4BAA ED A0       > ldi
1604   4BAC ED A0       > ldi
1604   4BAE ED A0       > ldi
1604   4BB0 ED A0       > ldi
1604   4BB2 ED A0       > ldi
1604   4BB4 ED A0       > ldi
1604   4BB6 ED A0       > ldi
1604   4BB8 ED A0       > ldi
1604   4BBA ED A0       > ldi
1604   4BBC ED A0       > ldi
1604   4BBE ED A0       > ldi
1604   4BC0 ED A0       > ldi
1604   4BC2 ED A0       > ldi
1604   4BC4 ED A0       > ldi
1604   4BC6 ED A0       > ldi
1604   4BC8 ED A0       > ldi
1604   4BCA ED A0       > ldi
1604   4BCC ED A0       > ldi
1604   4BCE ED A0       > ldi
1604   4BD0 ED A0       > ldi
1604   4BD2 ED A0       > ldi
1604   4BD4 ED A0       > ldi
1604   4BD6 ED A0       > ldi
1604   4BD8 ED A0       > ldi
1604   4BDA ED A0       > ldi
1604   4BDC ED A0       > ldi
1604   4BDE ED A0       > ldi
1604   4BE0 ED A0       > ldi
1604   4BE2 ED A0       > ldi
1604   4BE4 ED A0       > ldi
1604   4BE6 ED A0       > ldi
1604   4BE8 ED A0       > ldi
1604   4BEA ED A0       > ldi
1604   4BEC ED A0       > ldi
1604   4BEE ED A0       > ldi
1604   4BF0 ED A0       > ldi
1604   4BF2 ED A0       > ldi
1604   4BF4 ED A0       > ldi
1604   4BF6 ED A0       > ldi
1604   4BF8 ED A0       > ldi
1604   4BFA ED A0       > ldi
1604   4BFC ED A0       > ldi
1604   4BFE ED A0       > ldi
1604   4C00 ED A0       > ldi
1604   4C02 ED A0       > ldi
1604   4C04 ED A0       > ldi
1604   4C06 ED A0       > ldi
1604   4C08 ED A0       > ldi
1604   4C0A ED A0       > ldi
1604   4C0C ED A0       > ldi
1604   4C0E ED A0       > ldi
1604   4C10 ED A0       > ldi
1604   4C12 ED A0       > ldi
1604   4C14 ED A0       > ldi
1604   4C16 ED A0       > ldi
1604   4C18 ED A0       > ldi
1604   4C1A ED A0       > ldi
1604   4C1C ED A0       > ldi
1604   4C1E ED A0       > ldi
1604   4C20 ED A0       > ldi
1604   4C22 ED A0       > ldi
1604   4C24 ED A0       > ldi
1604   4C26 ED A0       > ldi
1604   4C28 ED A0       > ldi
1604   4C2A ED A0       > ldi
1604   4C2C ED A0       > ldi
1604   4C2E ED A0       > ldi
1604   4C30 ED A0       > ldi
1604   4C32 ED A0       > ldi
1604   4C34 ED A0       > ldi
1604   4C36 ED A0       > ldi
1604   4C38 ED A0       > ldi
1604   4C3A ED A0       > ldi
1604   4C3C ED A0       > ldi
1604   4C3E ED A0       > ldi
1604   4C40 ED A0       > ldi
1604   4C42 ED A0       > ldi
1604   4C44 ED A0       > ldi
1604   4C46 ED A0       > ldi
1604   4C48 ED A0       > ldi
1604   4C4A ED A0       > ldi
1604   4C4C ED A0       > ldi
1604   4C4E ED A0       > ldi
1604   4C50 ED A0       > ldi
1604   4C52 ED A0       > ldi
1604   4C54 ED A0       > ldi
1604   4C56 ED A0       > ldi
1604   4C58 ED A0       > ldi
1604   4C5A ED A0       > ldi
1604   4C5C ED A0       > ldi
1604   4C5E ED A0       > ldi
1604   4C60 ED A0       > ldi
1604   4C62 ED A0       > ldi
1604   4C64 ED A0       > ldi
1604   4C66 ED A0       > ldi
1604   4C68 ED A0       > ldi
1604   4C6A ED A0       > ldi
1604   4C6C ED A0       > ldi
1604   4C6E ED A0       > ldi
1604   4C70 ED A0       > ldi
1604   4C72 ED A0       > ldi
1604   4C74 ED A0       > ldi
1604   4C76 ED A0       > ldi
1604   4C78 ED A0       > ldi
1604   4C7A ED A0       > ldi
1604   4C7C ED A0       > ldi
1604   4C7E ED A0       > ldi
1604   4C80 ED A0       > ldi
1604   4C82 ED A0       > ldi
1604   4C84 ED A0       > ldi
1604   4C86 ED A0       > ldi
1604   4C88 ED A0       > ldi
1604   4C8A ED A0       > ldi
1604   4C8C ED A0       > ldi
1604   4C8E ED A0       > ldi
1604   4C90 ED A0       > ldi
1604   4C92 ED A0       > ldi
1604   4C94 ED A0       > ldi
1604   4C96 ED A0       > ldi
1604   4C98 ED A0       > ldi
1604   4C9A ED A0       > ldi
1604   4C9C ED A0       > ldi
1604   4C9E ED A0       > ldi
1604   4CA0 ED A0       > ldi
1604   4CA2 ED A0       > ldi
1604   4CA4 ED A0       > ldi
1604   4CA6 ED A0       > ldi
1604   4CA8 ED A0       > ldi
1604   4CAA ED A0       > ldi
1604   4CAC ED A0       > ldi
1604   4CAE ED A0       > ldi
1604   4CB0 ED A0       > ldi
1604   4CB2 ED A0       > ldi
1604   4CB4 ED A0       > ldi
1604   4CB6 ED A0       > ldi
1604   4CB8 ED A0       > ldi
1604   4CBA ED A0       > ldi
1604   4CBC ED A0       > ldi
1604   4CBE ED A0       > ldi
1604   4CC0 ED A0       > ldi
1604   4CC2 ED A0       > ldi
1604   4CC4 ED A0       > ldi
1604   4CC6 ED A0       > ldi
1604   4CC8 ED A0       > ldi
1604   4CCA ED A0       > ldi
1604   4CCC ED A0       > ldi
1604   4CCE ED A0       > ldi
1604   4CD0 ED A0       > ldi
1604   4CD2 ED A0       > ldi
1604   4CD4 ED A0       > ldi
1604   4CD6 ED A0       > ldi
1604   4CD8 ED A0       > ldi
1604   4CDA ED A0       > ldi
1604   4CDC ED A0       > ldi
1604   4CDE ED A0       > ldi
1604   4CE0 ED A0       > ldi
1604   4CE2 ED A0       > ldi
1604   4CE4 ED A0       > ldi
1604   4CE6 ED A0       > ldi
1604   4CE8 ED A0       > ldi
1604   4CEA ED A0       > ldi
1604   4CEC ED A0       > ldi
1604   4CEE ED A0       > ldi
1604   4CF0 ED A0       > ldi
1604   4CF2 ED A0       > ldi
1604   4CF4 ED A0       > ldi
1604   4CF6 ED A0       > ldi
1604   4CF8 ED A0       > ldi
1604   4CFA ED A0       > ldi
1604   4CFC ED A0       > ldi
1604   4CFE ED A0       > ldi
1604   4D00 ED A0       > ldi
1604   4D02 ED A0       > ldi
1604   4D04 ED A0       > ldi
1604   4D06 ED A0       > ldi
1604   4D08 ED A0       > ldi
1604   4D0A ED A0       > ldi
1604   4D0C ED A0       > ldi
1604   4D0E ED A0       > ldi
1604   4D10 ED A0       > ldi
1604   4D12 ED A0       > ldi
1604   4D14 ED A0       > ldi
1604   4D16 ED A0       > ldi
1604   4D18 ED A0       > ldi
1604   4D1A ED A0       > ldi
1604   4D1C ED A0       > ldi
1604   4D1E ED A0       > ldi
1604   4D20 ED A0       > ldi
1604   4D22 ED A0       > ldi
1604   4D24 ED A0       > ldi
1604   4D26 ED A0       > ldi
1604   4D28 ED A0       > ldi
1604   4D2A ED A0       > ldi
1604   4D2C ED A0       > ldi
1604   4D2E ED A0       > ldi
1604   4D30 ED A0       > ldi
1604   4D32 ED A0       > ldi
1604   4D34 ED A0       > ldi
1604   4D36 ED A0       > ldi
1604   4D38 ED A0       > ldi
1604   4D3A ED A0       > ldi
1604   4D3C ED A0       > ldi
1604   4D3E ED A0       > ldi
1604   4D40 ED A0       > ldi
1604   4D42 ED A0       > ldi
1604   4D44 ED A0       > ldi
1604   4D46 ED A0       > ldi
1604   4D48 ED A0       > ldi
1604   4D4A ED A0       > ldi
1604   4D4C ED A0       > ldi
1604   4D4E ED A0       > ldi
1604   4D50 ED A0       > ldi
1604   4D52 ED A0       > ldi
1604   4D54 ED A0       > ldi
1604   4D56 ED A0       > ldi
1604   4D58 ED A0       > ldi
1604   4D5A ED A0       > ldi
1604   4D5C ED A0       > ldi
1604   4D5E ED A0       > ldi
1604   4D60 ED A0       > ldi
1604   4D62 ED A0       > ldi
1604   4D64 ED A0       > ldi
1604   4D66 ED A0       > ldi
1604   4D68 ED A0       > ldi
1604   4D6A ED A0       > ldi
1604   4D6C ED A0       > ldi
1604   4D6E ED A0       > ldi
1604   4D70 ED A0       > ldi
1604   4D72 ED A0       > ldi
1604   4D74 ED A0       > ldi
1604   4D76 ED A0       > ldi
1604   4D78 ED A0       > ldi
1604   4D7A ED A0       > ldi
1604   4D7C ED A0       > ldi
1604   4D7E ED A0       > ldi
1604   4D80 ED A0       > ldi
1604   4D82 ED A0       > ldi
1604   4D84 ED A0       > ldi
1604   4D86 ED A0       > ldi
1604   4D88 ED A0       > ldi
1604   4D8A ED A0       > ldi
1604   4D8C ED A0       > ldi
1604   4D8E ED A0       > ldi
1604   4D90 ED A0       > ldi
1604   4D92 ED A0       > ldi
1604   4D94 ED A0       > ldi
1604   4D96 ED A0       > ldi
1604   4D98 ED A0       > ldi
1604   4D9A ED A0       > ldi
1604   4D9C ED A0       > ldi
1604   4D9E ED A0       > ldi
1604   4DA0 ED A0       > ldi
1604   4DA2 ED A0       > ldi
1604   4DA4 ED A0       > ldi
1604   4DA6 ED A0       > ldi
1604   4DA8 ED A0       > ldi
1604   4DAA ED A0       > ldi
1604   4DAC ED A0       > ldi
1604   4DAE ED A0       > ldi
1604   4DB0 ED A0       > ldi
1604   4DB2 ED A0       > ldi
1604   4DB4 ED A0       > ldi
1604   4DB6 ED A0       > ldi
1604   4DB8 ED A0       > ldi
1604   4DBA ED A0       > ldi
1604   4DBC ED A0       > ldi
1604   4DBE ED A0       > ldi
1604   4DC0 ED A0       > ldi
1604   4DC2 ED A0       > ldi
1604   4DC4 ED A0       > ldi
1604   4DC6 ED A0       > ldi
1604   4DC8 ED A0       > ldi
1604   4DCA ED A0       > ldi
1604   4DCC ED A0       > ldi
1604   4DCE ED A0       > ldi
1604   4DD0 ED A0       > ldi
1604   4DD2 ED A0       > ldi
1604   4DD4 ED A0       > ldi
1604   4DD6 ED A0       > ldi
1604   4DD8 ED A0       > ldi
1604   4DDA ED A0       > ldi
1604   4DDC ED A0       > ldi
1604   4DDE ED A0       > ldi
1604   4DE0 ED A0       > ldi
1604   4DE2 ED A0       > ldi
1604   4DE4 ED A0       > ldi
1604   4DE6 ED A0       > ldi
1604   4DE8 ED A0       > ldi
1604   4DEA ED A0       > ldi
1604   4DEC ED A0       > ldi
1604   4DEE ED A0       > ldi
1604   4DF0 ED A0       > ldi
1604   4DF2 ED A0       > ldi
1604   4DF4 ED A0       > ldi
1604   4DF6 ED A0       > ldi
1604   4DF8 ED A0       > ldi
1604   4DFA ED A0       > ldi
1604   4DFC ED A0       > ldi
1604   4DFE ED A0       > ldi
1604   4E00 ED A0       > ldi
1604   4E02 ED A0       > ldi
1604   4E04 ED A0       > ldi
1604   4E06 ED A0       > ldi
1604   4E08 ED A0       > ldi
1604   4E0A ED A0       > ldi
1604   4E0C ED A0       > ldi
1604   4E0E ED A0       > ldi
1604   4E10 ED A0       > ldi
1604   4E12 ED A0       > ldi
1604   4E14 ED A0       > ldi
1604   4E16 ED A0       > ldi
1604   4E18 ED A0       > ldi
1604   4E1A ED A0       > ldi
1604   4E1C ED A0       > ldi
1604   4E1E ED A0       > ldi
1604   4E20 ED A0       > ldi
1604   4E22 ED A0       > ldi
1604   4E24 ED A0       > ldi
1604   4E26 ED A0       > ldi
1604   4E28 ED A0       > ldi
1604   4E2A ED A0       > ldi
1604   4E2C ED A0       > ldi
1604   4E2E ED A0       > ldi
1604   4E30 ED A0       > ldi
1604   4E32 ED A0       > ldi
1604   4E34 ED A0       > ldi
1604   4E36 ED A0       > ldi
1604   4E38 ED A0       > ldi
1604   4E3A ED A0       > ldi
1604   4E3C ED A0       > ldi
1604   4E3E ED A0       > ldi
1604   4E40 ED A0       > ldi
1604   4E42 ED A0       > ldi
1604   4E44 ED A0       > ldi
1604   4E46 ED A0       > ldi
1604   4E48 ED A0       > ldi
1604   4E4A ED A0       > ldi
1604   4E4C ED A0       > ldi
1604   4E4E ED A0       > ldi
1604   4E50 ED A0       > ldi
1604   4E52 ED A0       > ldi
1604   4E54 ED A0       > ldi
1604   4E56 ED A0       > ldi
1604   4E58 ED A0       > ldi
1604   4E5A ED A0       > ldi
1604   4E5C ED A0       > ldi
1604   4E5E ED A0       > ldi
1604   4E60 ED A0       > ldi
1604   4E62 ED A0       > ldi
1604   4E64 ED A0       > ldi
1604   4E66 ED A0       > ldi
1604   4E68 ED A0       > ldi
1604   4E6A ED A0       > ldi
1604   4E6C ED A0       > ldi
1604   4E6E ED A0       > ldi
1604   4E70 ED A0       > ldi
1604   4E72 ED A0       > ldi
1604   4E74 ED A0       > ldi
1604   4E76 ED A0       > ldi
1604   4E78 ED A0       > ldi
1604   4E7A ED A0       > ldi
1604   4E7C ED A0       > ldi
1604   4E7E ED A0       > ldi
1604   4E80 ED A0       > ldi
1604   4E82 ED A0       > ldi
1604   4E84 ED A0       > ldi
1604   4E86 ED A0       > ldi
1604   4E88 ED A0       > ldi
1604   4E8A ED A0       > ldi
1604   4E8C ED A0       > ldi
1604   4E8E ED A0       > ldi
1604   4E90 ED A0       > ldi
1604   4E92 ED A0       > ldi
1604   4E94 ED A0       > ldi
1604   4E96 ED A0       > ldi
1604   4E98 ED A0       > ldi
1604   4E9A ED A0       > ldi
1604   4E9C ED A0       > ldi
1604   4E9E ED A0       > ldi
1604   4EA0 ED A0       > ldi
1604   4EA2 ED A0       > ldi
1604   4EA4 ED A0       > ldi
1604   4EA6 ED A0       > ldi
1604   4EA8 ED A0       > ldi
1604   4EAA ED A0       > ldi
1604   4EAC ED A0       > ldi
1604   4EAE ED A0       > ldi
1604   4EB0 ED A0       > ldi
1604   4EB2 ED A0       > ldi
1604   4EB4 ED A0       > ldi
1604   4EB6 ED A0       > ldi
1604   4EB8 ED A0       > ldi
1604   4EBA ED A0       > ldi
1604   4EBC ED A0       > ldi
1604   4EBE ED A0       > ldi
1604   4EC0 ED A0       > ldi
1604   4EC2 ED A0       > ldi
1604   4EC4 ED A0       > ldi
1604   4EC6 ED A0       > ldi
1604   4EC8 ED A0       > ldi
1604   4ECA ED A0       > ldi
1604   4ECC ED A0       > ldi
1604   4ECE ED A0       > ldi
1604   4ED0 ED A0       > ldi
1604   4ED2 ED A0       > ldi
1604   4ED4 ED A0       > ldi
1604   4ED6 ED A0       > ldi
1604   4ED8 ED A0       > ldi
1604   4EDA ED A0       > ldi
1604   4EDC ED A0       > ldi
1604   4EDE ED A0       > ldi
1604   4EE0 ED A0       > ldi
1604   4EE2 ED A0       > ldi
1604   4EE4 ED A0       > ldi
1604   4EE6 ED A0       > ldi
1604   4EE8 ED A0       > ldi
1604   4EEA ED A0       > ldi
1604   4EEC ED A0       > ldi
1604   4EEE ED A0       > ldi
1604   4EF0 ED A0       > ldi
1604   4EF2 ED A0       > ldi
1604   4EF4 ED A0       > ldi
1604   4EF6 ED A0       > ldi
1604   4EF8 ED A0       > ldi
1604   4EFA ED A0       > ldi
1604   4EFC ED A0       > ldi
1604   4EFE ED A0       > ldi
1604   4F00 ED A0       > ldi
1604   4F02 ED A0       > ldi
1604   4F04 ED A0       > ldi
1604   4F06 ED A0       > ldi
1604   4F08 ED A0       > ldi
1604   4F0A ED A0       > ldi
1604   4F0C ED A0       > ldi
1604   4F0E ED A0       > ldi
1605   4F10             .part2s: 
1606   4F10 01 00 02    	ld	bc,512
1607   4F13 ED B0       	ldir
1608   4F15 3E FF       	ld	a, $FF		; envia dummy CRC
1609   4F17 32 00 7B    	ld	(PORTSPI),a
1610   4F1A 32 00 7B    	ld	(PORTSPI),a
1611   4F1D CD 42 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1612   4F20 E6 1F       	and	$1F		; testa bits erro
1613   4F22 FE 05       	cp	5
1614   4F24 37          	scf
1615   4F25 C2 2F 4F    	jp	nz,terminaLeituraEscritaBloco	; resposta errada, informar erro
1616   4F28             .esp: 
1617   4F28 CD 42 46    	call	WAIT_RESP_NO_FF	; esperar cartao
1618   4F2B B7          	or	a
1619   4F2C 28 FA       	jr	z,.esp
1620   4F2E             .fim: 
1621   4F2E AF          	xor	a		; zera carry e informa nenhum erro
1622   4F2F             terminaLeituraEscritaBloco: 
1623   4F2F F5          	push	af
1624   4F30 CD BD 45    	call	desabilitaSDs	; desabilitar todos os cartoes
1625   4F33 F1          	pop	af
1626   4F34 C9          	ret
1627   4F35             
1628   4F35             
1629   4F35             ; ------------------------------------------------
1630   4F35             ; Ler um bloco de 512 bytes do cartao
1631   4F35             ; HL aponta para o inicio dos dados
1632   4F35             ; BC e DE contem o numero do bloco (BCDE = 32 bits)
1633   4F35             ; Destroi AF, BC, DE, HL
1634   4F35             ; ------------------------------------------------
1635   4F35             LerBloco: 
1636   4F35 DD 7E 0F    	ld	a, (ix+15)	; verificar se eh SDV1 ou SDV2
1637   4F38 B7          	or	a
1638   4F39 CC A7 57    	call	z,blocoParaByte	; se for SDV1 coverter blocos para bytes
1639   4F3C CD 60 46    	call	setaSDAtual
1640   4F3F             
1641   4F3F             
1642   4F3F             
1643   4F3F FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se Nextor quer ler um ou mais blocos
1644   4F42 3D          	dec	a
1645   4F43 CA 87 53    	jp	z,.umBloco	; somente um bloco, pular
1646   4F46             
1647   4F46             ; multiplos blocos
1648   4F46 3E 52       	ld	a, CMD18	; ler multiplos blocos com CMD18 = Read Multiple Blocks
1649   4F48 CD DA 45    	call	SD_SEND_CMD_GET_ERROR
1650   4F4B DA 2F 4F    	jp	c,terminaLeituraEscritaBloco
1651   4F4E             .loop: 
1652   4F4E CD 34 46    	call	WAIT_RESP_FE
1653   4F51 DA 2F 4F    	jp	c,terminaLeituraEscritaBloco
1654   4F54 EB          	ex	de,hl
1655   4F55             	; Check for a Z80 or R800
1656   4F55             ;	or 	a		; Clear Cy
1657   4F55 3E 14       	ld	a,20
1658   4F57 ED F9       	db	#ED,#F9		; mulub a,a
1659   4F59 21 00 7B    	ld	hl, PORTSPI
1660   4F5C DA 78 53    	jp	c,.r800m	; Use LDIR for R800
1661   4F5F ED A0       > ldi
1661   4F61 ED A0       > ldi
1661   4F63 ED A0       > ldi
1661   4F65 ED A0       > ldi
1661   4F67 ED A0       > ldi
1661   4F69 ED A0       > ldi
1661   4F6B ED A0       > ldi
1661   4F6D ED A0       > ldi
1661   4F6F ED A0       > ldi
1661   4F71 ED A0       > ldi
1661   4F73 ED A0       > ldi
1661   4F75 ED A0       > ldi
1661   4F77 ED A0       > ldi
1661   4F79 ED A0       > ldi
1661   4F7B ED A0       > ldi
1661   4F7D ED A0       > ldi
1661   4F7F ED A0       > ldi
1661   4F81 ED A0       > ldi
1661   4F83 ED A0       > ldi
1661   4F85 ED A0       > ldi
1661   4F87 ED A0       > ldi
1661   4F89 ED A0       > ldi
1661   4F8B ED A0       > ldi
1661   4F8D ED A0       > ldi
1661   4F8F ED A0       > ldi
1661   4F91 ED A0       > ldi
1661   4F93 ED A0       > ldi
1661   4F95 ED A0       > ldi
1661   4F97 ED A0       > ldi
1661   4F99 ED A0       > ldi
1661   4F9B ED A0       > ldi
1661   4F9D ED A0       > ldi
1661   4F9F ED A0       > ldi
1661   4FA1 ED A0       > ldi
1661   4FA3 ED A0       > ldi
1661   4FA5 ED A0       > ldi
1661   4FA7 ED A0       > ldi
1661   4FA9 ED A0       > ldi
1661   4FAB ED A0       > ldi
1661   4FAD ED A0       > ldi
1661   4FAF ED A0       > ldi
1661   4FB1 ED A0       > ldi
1661   4FB3 ED A0       > ldi
1661   4FB5 ED A0       > ldi
1661   4FB7 ED A0       > ldi
1661   4FB9 ED A0       > ldi
1661   4FBB ED A0       > ldi
1661   4FBD ED A0       > ldi
1661   4FBF ED A0       > ldi
1661   4FC1 ED A0       > ldi
1661   4FC3 ED A0       > ldi
1661   4FC5 ED A0       > ldi
1661   4FC7 ED A0       > ldi
1661   4FC9 ED A0       > ldi
1661   4FCB ED A0       > ldi
1661   4FCD ED A0       > ldi
1661   4FCF ED A0       > ldi
1661   4FD1 ED A0       > ldi
1661   4FD3 ED A0       > ldi
1661   4FD5 ED A0       > ldi
1661   4FD7 ED A0       > ldi
1661   4FD9 ED A0       > ldi
1661   4FDB ED A0       > ldi
1661   4FDD ED A0       > ldi
1661   4FDF ED A0       > ldi
1661   4FE1 ED A0       > ldi
1661   4FE3 ED A0       > ldi
1661   4FE5 ED A0       > ldi
1661   4FE7 ED A0       > ldi
1661   4FE9 ED A0       > ldi
1661   4FEB ED A0       > ldi
1661   4FED ED A0       > ldi
1661   4FEF ED A0       > ldi
1661   4FF1 ED A0       > ldi
1661   4FF3 ED A0       > ldi
1661   4FF5 ED A0       > ldi
1661   4FF7 ED A0       > ldi
1661   4FF9 ED A0       > ldi
1661   4FFB ED A0       > ldi
1661   4FFD ED A0       > ldi
1661   4FFF ED A0       > ldi
1661   5001 ED A0       > ldi
1661   5003 ED A0       > ldi
1661   5005 ED A0       > ldi
1661   5007 ED A0       > ldi
1661   5009 ED A0       > ldi
1661   500B ED A0       > ldi
1661   500D ED A0       > ldi
1661   500F ED A0       > ldi
1661   5011 ED A0       > ldi
1661   5013 ED A0       > ldi
1661   5015 ED A0       > ldi
1661   5017 ED A0       > ldi
1661   5019 ED A0       > ldi
1661   501B ED A0       > ldi
1661   501D ED A0       > ldi
1661   501F ED A0       > ldi
1661   5021 ED A0       > ldi
1661   5023 ED A0       > ldi
1661   5025 ED A0       > ldi
1661   5027 ED A0       > ldi
1661   5029 ED A0       > ldi
1661   502B ED A0       > ldi
1661   502D ED A0       > ldi
1661   502F ED A0       > ldi
1661   5031 ED A0       > ldi
1661   5033 ED A0       > ldi
1661   5035 ED A0       > ldi
1661   5037 ED A0       > ldi
1661   5039 ED A0       > ldi
1661   503B ED A0       > ldi
1661   503D ED A0       > ldi
1661   503F ED A0       > ldi
1661   5041 ED A0       > ldi
1661   5043 ED A0       > ldi
1661   5045 ED A0       > ldi
1661   5047 ED A0       > ldi
1661   5049 ED A0       > ldi
1661   504B ED A0       > ldi
1661   504D ED A0       > ldi
1661   504F ED A0       > ldi
1661   5051 ED A0       > ldi
1661   5053 ED A0       > ldi
1661   5055 ED A0       > ldi
1661   5057 ED A0       > ldi
1661   5059 ED A0       > ldi
1661   505B ED A0       > ldi
1661   505D ED A0       > ldi
1661   505F ED A0       > ldi
1661   5061 ED A0       > ldi
1661   5063 ED A0       > ldi
1661   5065 ED A0       > ldi
1661   5067 ED A0       > ldi
1661   5069 ED A0       > ldi
1661   506B ED A0       > ldi
1661   506D ED A0       > ldi
1661   506F ED A0       > ldi
1661   5071 ED A0       > ldi
1661   5073 ED A0       > ldi
1661   5075 ED A0       > ldi
1661   5077 ED A0       > ldi
1661   5079 ED A0       > ldi
1661   507B ED A0       > ldi
1661   507D ED A0       > ldi
1661   507F ED A0       > ldi
1661   5081 ED A0       > ldi
1661   5083 ED A0       > ldi
1661   5085 ED A0       > ldi
1661   5087 ED A0       > ldi
1661   5089 ED A0       > ldi
1661   508B ED A0       > ldi
1661   508D ED A0       > ldi
1661   508F ED A0       > ldi
1661   5091 ED A0       > ldi
1661   5093 ED A0       > ldi
1661   5095 ED A0       > ldi
1661   5097 ED A0       > ldi
1661   5099 ED A0       > ldi
1661   509B ED A0       > ldi
1661   509D ED A0       > ldi
1661   509F ED A0       > ldi
1661   50A1 ED A0       > ldi
1661   50A3 ED A0       > ldi
1661   50A5 ED A0       > ldi
1661   50A7 ED A0       > ldi
1661   50A9 ED A0       > ldi
1661   50AB ED A0       > ldi
1661   50AD ED A0       > ldi
1661   50AF ED A0       > ldi
1661   50B1 ED A0       > ldi
1661   50B3 ED A0       > ldi
1661   50B5 ED A0       > ldi
1661   50B7 ED A0       > ldi
1661   50B9 ED A0       > ldi
1661   50BB ED A0       > ldi
1661   50BD ED A0       > ldi
1661   50BF ED A0       > ldi
1661   50C1 ED A0       > ldi
1661   50C3 ED A0       > ldi
1661   50C5 ED A0       > ldi
1661   50C7 ED A0       > ldi
1661   50C9 ED A0       > ldi
1661   50CB ED A0       > ldi
1661   50CD ED A0       > ldi
1661   50CF ED A0       > ldi
1661   50D1 ED A0       > ldi
1661   50D3 ED A0       > ldi
1661   50D5 ED A0       > ldi
1661   50D7 ED A0       > ldi
1661   50D9 ED A0       > ldi
1661   50DB ED A0       > ldi
1661   50DD ED A0       > ldi
1661   50DF ED A0       > ldi
1661   50E1 ED A0       > ldi
1661   50E3 ED A0       > ldi
1661   50E5 ED A0       > ldi
1661   50E7 ED A0       > ldi
1661   50E9 ED A0       > ldi
1661   50EB ED A0       > ldi
1661   50ED ED A0       > ldi
1661   50EF ED A0       > ldi
1661   50F1 ED A0       > ldi
1661   50F3 ED A0       > ldi
1661   50F5 ED A0       > ldi
1661   50F7 ED A0       > ldi
1661   50F9 ED A0       > ldi
1661   50FB ED A0       > ldi
1661   50FD ED A0       > ldi
1661   50FF ED A0       > ldi
1661   5101 ED A0       > ldi
1661   5103 ED A0       > ldi
1661   5105 ED A0       > ldi
1661   5107 ED A0       > ldi
1661   5109 ED A0       > ldi
1661   510B ED A0       > ldi
1661   510D ED A0       > ldi
1661   510F ED A0       > ldi
1661   5111 ED A0       > ldi
1661   5113 ED A0       > ldi
1661   5115 ED A0       > ldi
1661   5117 ED A0       > ldi
1661   5119 ED A0       > ldi
1661   511B ED A0       > ldi
1661   511D ED A0       > ldi
1661   511F ED A0       > ldi
1661   5121 ED A0       > ldi
1661   5123 ED A0       > ldi
1661   5125 ED A0       > ldi
1661   5127 ED A0       > ldi
1661   5129 ED A0       > ldi
1661   512B ED A0       > ldi
1661   512D ED A0       > ldi
1661   512F ED A0       > ldi
1661   5131 ED A0       > ldi
1661   5133 ED A0       > ldi
1661   5135 ED A0       > ldi
1661   5137 ED A0       > ldi
1661   5139 ED A0       > ldi
1661   513B ED A0       > ldi
1661   513D ED A0       > ldi
1661   513F ED A0       > ldi
1661   5141 ED A0       > ldi
1661   5143 ED A0       > ldi
1661   5145 ED A0       > ldi
1661   5147 ED A0       > ldi
1661   5149 ED A0       > ldi
1661   514B ED A0       > ldi
1661   514D ED A0       > ldi
1661   514F ED A0       > ldi
1661   5151 ED A0       > ldi
1661   5153 ED A0       > ldi
1661   5155 ED A0       > ldi
1661   5157 ED A0       > ldi
1661   5159 ED A0       > ldi
1661   515B ED A0       > ldi
1661   515D ED A0       > ldi
1661   515F ED A0       > ldi
1661   5161 ED A0       > ldi
1661   5163 ED A0       > ldi
1661   5165 ED A0       > ldi
1661   5167 ED A0       > ldi
1661   5169 ED A0       > ldi
1661   516B ED A0       > ldi
1661   516D ED A0       > ldi
1661   516F ED A0       > ldi
1661   5171 ED A0       > ldi
1661   5173 ED A0       > ldi
1661   5175 ED A0       > ldi
1661   5177 ED A0       > ldi
1661   5179 ED A0       > ldi
1661   517B ED A0       > ldi
1661   517D ED A0       > ldi
1661   517F ED A0       > ldi
1661   5181 ED A0       > ldi
1661   5183 ED A0       > ldi
1661   5185 ED A0       > ldi
1661   5187 ED A0       > ldi
1661   5189 ED A0       > ldi
1661   518B ED A0       > ldi
1661   518D ED A0       > ldi
1661   518F ED A0       > ldi
1661   5191 ED A0       > ldi
1661   5193 ED A0       > ldi
1661   5195 ED A0       > ldi
1661   5197 ED A0       > ldi
1661   5199 ED A0       > ldi
1661   519B ED A0       > ldi
1661   519D ED A0       > ldi
1661   519F ED A0       > ldi
1661   51A1 ED A0       > ldi
1661   51A3 ED A0       > ldi
1661   51A5 ED A0       > ldi
1661   51A7 ED A0       > ldi
1661   51A9 ED A0       > ldi
1661   51AB ED A0       > ldi
1661   51AD ED A0       > ldi
1661   51AF ED A0       > ldi
1661   51B1 ED A0       > ldi
1661   51B3 ED A0       > ldi
1661   51B5 ED A0       > ldi
1661   51B7 ED A0       > ldi
1661   51B9 ED A0       > ldi
1661   51BB ED A0       > ldi
1661   51BD ED A0       > ldi
1661   51BF ED A0       > ldi
1661   51C1 ED A0       > ldi
1661   51C3 ED A0       > ldi
1661   51C5 ED A0       > ldi
1661   51C7 ED A0       > ldi
1661   51C9 ED A0       > ldi
1661   51CB ED A0       > ldi
1661   51CD ED A0       > ldi
1661   51CF ED A0       > ldi
1661   51D1 ED A0       > ldi
1661   51D3 ED A0       > ldi
1661   51D5 ED A0       > ldi
1661   51D7 ED A0       > ldi
1661   51D9 ED A0       > ldi
1661   51DB ED A0       > ldi
1661   51DD ED A0       > ldi
1661   51DF ED A0       > ldi
1661   51E1 ED A0       > ldi
1661   51E3 ED A0       > ldi
1661   51E5 ED A0       > ldi
1661   51E7 ED A0       > ldi
1661   51E9 ED A0       > ldi
1661   51EB ED A0       > ldi
1661   51ED ED A0       > ldi
1661   51EF ED A0       > ldi
1661   51F1 ED A0       > ldi
1661   51F3 ED A0       > ldi
1661   51F5 ED A0       > ldi
1661   51F7 ED A0       > ldi
1661   51F9 ED A0       > ldi
1661   51FB ED A0       > ldi
1661   51FD ED A0       > ldi
1661   51FF ED A0       > ldi
1661   5201 ED A0       > ldi
1661   5203 ED A0       > ldi
1661   5205 ED A0       > ldi
1661   5207 ED A0       > ldi
1661   5209 ED A0       > ldi
1661   520B ED A0       > ldi
1661   520D ED A0       > ldi
1661   520F ED A0       > ldi
1661   5211 ED A0       > ldi
1661   5213 ED A0       > ldi
1661   5215 ED A0       > ldi
1661   5217 ED A0       > ldi
1661   5219 ED A0       > ldi
1661   521B ED A0       > ldi
1661   521D ED A0       > ldi
1661   521F ED A0       > ldi
1661   5221 ED A0       > ldi
1661   5223 ED A0       > ldi
1661   5225 ED A0       > ldi
1661   5227 ED A0       > ldi
1661   5229 ED A0       > ldi
1661   522B ED A0       > ldi
1661   522D ED A0       > ldi
1661   522F ED A0       > ldi
1661   5231 ED A0       > ldi
1661   5233 ED A0       > ldi
1661   5235 ED A0       > ldi
1661   5237 ED A0       > ldi
1661   5239 ED A0       > ldi
1661   523B ED A0       > ldi
1661   523D ED A0       > ldi
1661   523F ED A0       > ldi
1661   5241 ED A0       > ldi
1661   5243 ED A0       > ldi
1661   5245 ED A0       > ldi
1661   5247 ED A0       > ldi
1661   5249 ED A0       > ldi
1661   524B ED A0       > ldi
1661   524D ED A0       > ldi
1661   524F ED A0       > ldi
1661   5251 ED A0       > ldi
1661   5253 ED A0       > ldi
1661   5255 ED A0       > ldi
1661   5257 ED A0       > ldi
1661   5259 ED A0       > ldi
1661   525B ED A0       > ldi
1661   525D ED A0       > ldi
1661   525F ED A0       > ldi
1661   5261 ED A0       > ldi
1661   5263 ED A0       > ldi
1661   5265 ED A0       > ldi
1661   5267 ED A0       > ldi
1661   5269 ED A0       > ldi
1661   526B ED A0       > ldi
1661   526D ED A0       > ldi
1661   526F ED A0       > ldi
1661   5271 ED A0       > ldi
1661   5273 ED A0       > ldi
1661   5275 ED A0       > ldi
1661   5277 ED A0       > ldi
1661   5279 ED A0       > ldi
1661   527B ED A0       > ldi
1661   527D ED A0       > ldi
1661   527F ED A0       > ldi
1661   5281 ED A0       > ldi
1661   5283 ED A0       > ldi
1661   5285 ED A0       > ldi
1661   5287 ED A0       > ldi
1661   5289 ED A0       > ldi
1661   528B ED A0       > ldi
1661   528D ED A0       > ldi
1661   528F ED A0       > ldi
1661   5291 ED A0       > ldi
1661   5293 ED A0       > ldi
1661   5295 ED A0       > ldi
1661   5297 ED A0       > ldi
1661   5299 ED A0       > ldi
1661   529B ED A0       > ldi
1661   529D ED A0       > ldi
1661   529F ED A0       > ldi
1661   52A1 ED A0       > ldi
1661   52A3 ED A0       > ldi
1661   52A5 ED A0       > ldi
1661   52A7 ED A0       > ldi
1661   52A9 ED A0       > ldi
1661   52AB ED A0       > ldi
1661   52AD ED A0       > ldi
1661   52AF ED A0       > ldi
1661   52B1 ED A0       > ldi
1661   52B3 ED A0       > ldi
1661   52B5 ED A0       > ldi
1661   52B7 ED A0       > ldi
1661   52B9 ED A0       > ldi
1661   52BB ED A0       > ldi
1661   52BD ED A0       > ldi
1661   52BF ED A0       > ldi
1661   52C1 ED A0       > ldi
1661   52C3 ED A0       > ldi
1661   52C5 ED A0       > ldi
1661   52C7 ED A0       > ldi
1661   52C9 ED A0       > ldi
1661   52CB ED A0       > ldi
1661   52CD ED A0       > ldi
1661   52CF ED A0       > ldi
1661   52D1 ED A0       > ldi
1661   52D3 ED A0       > ldi
1661   52D5 ED A0       > ldi
1661   52D7 ED A0       > ldi
1661   52D9 ED A0       > ldi
1661   52DB ED A0       > ldi
1661   52DD ED A0       > ldi
1661   52DF ED A0       > ldi
1661   52E1 ED A0       > ldi
1661   52E3 ED A0       > ldi
1661   52E5 ED A0       > ldi
1661   52E7 ED A0       > ldi
1661   52E9 ED A0       > ldi
1661   52EB ED A0       > ldi
1661   52ED ED A0       > ldi
1661   52EF ED A0       > ldi
1661   52F1 ED A0       > ldi
1661   52F3 ED A0       > ldi
1661   52F5 ED A0       > ldi
1661   52F7 ED A0       > ldi
1661   52F9 ED A0       > ldi
1661   52FB ED A0       > ldi
1661   52FD ED A0       > ldi
1661   52FF ED A0       > ldi
1661   5301 ED A0       > ldi
1661   5303 ED A0       > ldi
1661   5305 ED A0       > ldi
1661   5307 ED A0       > ldi
1661   5309 ED A0       > ldi
1661   530B ED A0       > ldi
1661   530D ED A0       > ldi
1661   530F ED A0       > ldi
1661   5311 ED A0       > ldi
1661   5313 ED A0       > ldi
1661   5315 ED A0       > ldi
1661   5317 ED A0       > ldi
1661   5319 ED A0       > ldi
1661   531B ED A0       > ldi
1661   531D ED A0       > ldi
1661   531F ED A0       > ldi
1661   5321 ED A0       > ldi
1661   5323 ED A0       > ldi
1661   5325 ED A0       > ldi
1661   5327 ED A0       > ldi
1661   5329 ED A0       > ldi
1661   532B ED A0       > ldi
1661   532D ED A0       > ldi
1661   532F ED A0       > ldi
1661   5331 ED A0       > ldi
1661   5333 ED A0       > ldi
1661   5335 ED A0       > ldi
1661   5337 ED A0       > ldi
1661   5339 ED A0       > ldi
1661   533B ED A0       > ldi
1661   533D ED A0       > ldi
1661   533F ED A0       > ldi
1661   5341 ED A0       > ldi
1661   5343 ED A0       > ldi
1661   5345 ED A0       > ldi
1661   5347 ED A0       > ldi
1661   5349 ED A0       > ldi
1661   534B ED A0       > ldi
1661   534D ED A0       > ldi
1661   534F ED A0       > ldi
1661   5351 ED A0       > ldi
1661   5353 ED A0       > ldi
1661   5355 ED A0       > ldi
1661   5357 ED A0       > ldi
1661   5359 ED A0       > ldi
1661   535B ED A0       > ldi
1661   535D ED A0       > ldi
1662   535F             .part2m: 
1663   535F EB          	ex	de,hl
1664   5360 3A 00 7B    	ld	a, (PORTSPI)	; descarta CRC
1665   5363 3A 00 7B    	ld	a, (PORTSPI)
1666   5366 FD 7E 32    	ld	a, (iy+NUMBLOCOS)	; testar se tem mais blocos para ler
1667   5369 3D          	dec	a
1668   536A FD 77 32    	ld	(iy+NUMBLOCOS), a
1669   536D C2 4E 4F    	jp	nz,.loop
1670   5370 3E 4C       	ld	a, CMD12	; acabou os blocos, mandar CMD12 para cancelar leitura
1671   5372 CD D5 45    	call	SD_SEND_CMD_NO_ARGS
1672   5375 C3 A3 57    	jp	.fim
1673   5378             
1674   5378 01 00 02    .r800m:  ld	bc,512
1675   537B ED B0       	ldir
1676   537D 18 E0       	jr	.part2m
1677   537F             
1678   537F 01 00 02    .r800s: 	ld	bc,512
1679   5382 ED B0       	ldir
1680   5384 C3 9F 57    	jp	.part2s
1681   5387             
1682   5387             .umBloco: 
1683   5387 3E 51       	ld	a, CMD17	; ler somente um bloco com CMD17 = Read Single Block
1684   5389 CD DA 45    	call	SD_SEND_CMD_GET_ERROR
1685   538C DA 2F 4F    	jp	c,terminaLeituraEscritaBloco
1686   538F             
1687   538F CD 34 46    	call	WAIT_RESP_FE
1688   5392 DA 2F 4F    	jp	c,terminaLeituraEscritaBloco
1689   5395 EB          	ex	de,hl
1690   5396             
1691   5396             	; Check for a Z80 or R800
1692   5396             ;	or 	a		; Clear Cy
1693   5396 3E 14       	ld	a,20
1694   5398 ED F9       	db	#ED,#F9		; mulub a,a
1695   539A 21 00 7B    	ld	hl, PORTSPI
1696   539D 38 E0       	jr	c,.r800s	; Use LDIR for R800
1697   539F ED A0       > ldi
1697   53A1 ED A0       > ldi
1697   53A3 ED A0       > ldi
1697   53A5 ED A0       > ldi
1697   53A7 ED A0       > ldi
1697   53A9 ED A0       > ldi
1697   53AB ED A0       > ldi
1697   53AD ED A0       > ldi
1697   53AF ED A0       > ldi
1697   53B1 ED A0       > ldi
1697   53B3 ED A0       > ldi
1697   53B5 ED A0       > ldi
1697   53B7 ED A0       > ldi
1697   53B9 ED A0       > ldi
1697   53BB ED A0       > ldi
1697   53BD ED A0       > ldi
1697   53BF ED A0       > ldi
1697   53C1 ED A0       > ldi
1697   53C3 ED A0       > ldi
1697   53C5 ED A0       > ldi
1697   53C7 ED A0       > ldi
1697   53C9 ED A0       > ldi
1697   53CB ED A0       > ldi
1697   53CD ED A0       > ldi
1697   53CF ED A0       > ldi
1697   53D1 ED A0       > ldi
1697   53D3 ED A0       > ldi
1697   53D5 ED A0       > ldi
1697   53D7 ED A0       > ldi
1697   53D9 ED A0       > ldi
1697   53DB ED A0       > ldi
1697   53DD ED A0       > ldi
1697   53DF ED A0       > ldi
1697   53E1 ED A0       > ldi
1697   53E3 ED A0       > ldi
1697   53E5 ED A0       > ldi
1697   53E7 ED A0       > ldi
1697   53E9 ED A0       > ldi
1697   53EB ED A0       > ldi
1697   53ED ED A0       > ldi
1697   53EF ED A0       > ldi
1697   53F1 ED A0       > ldi
1697   53F3 ED A0       > ldi
1697   53F5 ED A0       > ldi
1697   53F7 ED A0       > ldi
1697   53F9 ED A0       > ldi
1697   53FB ED A0       > ldi
1697   53FD ED A0       > ldi
1697   53FF ED A0       > ldi
1697   5401 ED A0       > ldi
1697   5403 ED A0       > ldi
1697   5405 ED A0       > ldi
1697   5407 ED A0       > ldi
1697   5409 ED A0       > ldi
1697   540B ED A0       > ldi
1697   540D ED A0       > ldi
1697   540F ED A0       > ldi
1697   5411 ED A0       > ldi
1697   5413 ED A0       > ldi
1697   5415 ED A0       > ldi
1697   5417 ED A0       > ldi
1697   5419 ED A0       > ldi
1697   541B ED A0       > ldi
1697   541D ED A0       > ldi
1697   541F ED A0       > ldi
1697   5421 ED A0       > ldi
1697   5423 ED A0       > ldi
1697   5425 ED A0       > ldi
1697   5427 ED A0       > ldi
1697   5429 ED A0       > ldi
1697   542B ED A0       > ldi
1697   542D ED A0       > ldi
1697   542F ED A0       > ldi
1697   5431 ED A0       > ldi
1697   5433 ED A0       > ldi
1697   5435 ED A0       > ldi
1697   5437 ED A0       > ldi
1697   5439 ED A0       > ldi
1697   543B ED A0       > ldi
1697   543D ED A0       > ldi
1697   543F ED A0       > ldi
1697   5441 ED A0       > ldi
1697   5443 ED A0       > ldi
1697   5445 ED A0       > ldi
1697   5447 ED A0       > ldi
1697   5449 ED A0       > ldi
1697   544B ED A0       > ldi
1697   544D ED A0       > ldi
1697   544F ED A0       > ldi
1697   5451 ED A0       > ldi
1697   5453 ED A0       > ldi
1697   5455 ED A0       > ldi
1697   5457 ED A0       > ldi
1697   5459 ED A0       > ldi
1697   545B ED A0       > ldi
1697   545D ED A0       > ldi
1697   545F ED A0       > ldi
1697   5461 ED A0       > ldi
1697   5463 ED A0       > ldi
1697   5465 ED A0       > ldi
1697   5467 ED A0       > ldi
1697   5469 ED A0       > ldi
1697   546B ED A0       > ldi
1697   546D ED A0       > ldi
1697   546F ED A0       > ldi
1697   5471 ED A0       > ldi
1697   5473 ED A0       > ldi
1697   5475 ED A0       > ldi
1697   5477 ED A0       > ldi
1697   5479 ED A0       > ldi
1697   547B ED A0       > ldi
1697   547D ED A0       > ldi
1697   547F ED A0       > ldi
1697   5481 ED A0       > ldi
1697   5483 ED A0       > ldi
1697   5485 ED A0       > ldi
1697   5487 ED A0       > ldi
1697   5489 ED A0       > ldi
1697   548B ED A0       > ldi
1697   548D ED A0       > ldi
1697   548F ED A0       > ldi
1697   5491 ED A0       > ldi
1697   5493 ED A0       > ldi
1697   5495 ED A0       > ldi
1697   5497 ED A0       > ldi
1697   5499 ED A0       > ldi
1697   549B ED A0       > ldi
1697   549D ED A0       > ldi
1697   549F ED A0       > ldi
1697   54A1 ED A0       > ldi
1697   54A3 ED A0       > ldi
1697   54A5 ED A0       > ldi
1697   54A7 ED A0       > ldi
1697   54A9 ED A0       > ldi
1697   54AB ED A0       > ldi
1697   54AD ED A0       > ldi
1697   54AF ED A0       > ldi
1697   54B1 ED A0       > ldi
1697   54B3 ED A0       > ldi
1697   54B5 ED A0       > ldi
1697   54B7 ED A0       > ldi
1697   54B9 ED A0       > ldi
1697   54BB ED A0       > ldi
1697   54BD ED A0       > ldi
1697   54BF ED A0       > ldi
1697   54C1 ED A0       > ldi
1697   54C3 ED A0       > ldi
1697   54C5 ED A0       > ldi
1697   54C7 ED A0       > ldi
1697   54C9 ED A0       > ldi
1697   54CB ED A0       > ldi
1697   54CD ED A0       > ldi
1697   54CF ED A0       > ldi
1697   54D1 ED A0       > ldi
1697   54D3 ED A0       > ldi
1697   54D5 ED A0       > ldi
1697   54D7 ED A0       > ldi
1697   54D9 ED A0       > ldi
1697   54DB ED A0       > ldi
1697   54DD ED A0       > ldi
1697   54DF ED A0       > ldi
1697   54E1 ED A0       > ldi
1697   54E3 ED A0       > ldi
1697   54E5 ED A0       > ldi
1697   54E7 ED A0       > ldi
1697   54E9 ED A0       > ldi
1697   54EB ED A0       > ldi
1697   54ED ED A0       > ldi
1697   54EF ED A0       > ldi
1697   54F1 ED A0       > ldi
1697   54F3 ED A0       > ldi
1697   54F5 ED A0       > ldi
1697   54F7 ED A0       > ldi
1697   54F9 ED A0       > ldi
1697   54FB ED A0       > ldi
1697   54FD ED A0       > ldi
1697   54FF ED A0       > ldi
1697   5501 ED A0       > ldi
1697   5503 ED A0       > ldi
1697   5505 ED A0       > ldi
1697   5507 ED A0       > ldi
1697   5509 ED A0       > ldi
1697   550B ED A0       > ldi
1697   550D ED A0       > ldi
1697   550F ED A0       > ldi
1697   5511 ED A0       > ldi
1697   5513 ED A0       > ldi
1697   5515 ED A0       > ldi
1697   5517 ED A0       > ldi
1697   5519 ED A0       > ldi
1697   551B ED A0       > ldi
1697   551D ED A0       > ldi
1697   551F ED A0       > ldi
1697   5521 ED A0       > ldi
1697   5523 ED A0       > ldi
1697   5525 ED A0       > ldi
1697   5527 ED A0       > ldi
1697   5529 ED A0       > ldi
1697   552B ED A0       > ldi
1697   552D ED A0       > ldi
1697   552F ED A0       > ldi
1697   5531 ED A0       > ldi
1697   5533 ED A0       > ldi
1697   5535 ED A0       > ldi
1697   5537 ED A0       > ldi
1697   5539 ED A0       > ldi
1697   553B ED A0       > ldi
1697   553D ED A0       > ldi
1697   553F ED A0       > ldi
1697   5541 ED A0       > ldi
1697   5543 ED A0       > ldi
1697   5545 ED A0       > ldi
1697   5547 ED A0       > ldi
1697   5549 ED A0       > ldi
1697   554B ED A0       > ldi
1697   554D ED A0       > ldi
1697   554F ED A0       > ldi
1697   5551 ED A0       > ldi
1697   5553 ED A0       > ldi
1697   5555 ED A0       > ldi
1697   5557 ED A0       > ldi
1697   5559 ED A0       > ldi
1697   555B ED A0       > ldi
1697   555D ED A0       > ldi
1697   555F ED A0       > ldi
1697   5561 ED A0       > ldi
1697   5563 ED A0       > ldi
1697   5565 ED A0       > ldi
1697   5567 ED A0       > ldi
1697   5569 ED A0       > ldi
1697   556B ED A0       > ldi
1697   556D ED A0       > ldi
1697   556F ED A0       > ldi
1697   5571 ED A0       > ldi
1697   5573 ED A0       > ldi
1697   5575 ED A0       > ldi
1697   5577 ED A0       > ldi
1697   5579 ED A0       > ldi
1697   557B ED A0       > ldi
1697   557D ED A0       > ldi
1697   557F ED A0       > ldi
1697   5581 ED A0       > ldi
1697   5583 ED A0       > ldi
1697   5585 ED A0       > ldi
1697   5587 ED A0       > ldi
1697   5589 ED A0       > ldi
1697   558B ED A0       > ldi
1697   558D ED A0       > ldi
1697   558F ED A0       > ldi
1697   5591 ED A0       > ldi
1697   5593 ED A0       > ldi
1697   5595 ED A0       > ldi
1697   5597 ED A0       > ldi
1697   5599 ED A0       > ldi
1697   559B ED A0       > ldi
1697   559D ED A0       > ldi
1697   559F ED A0       > ldi
1697   55A1 ED A0       > ldi
1697   55A3 ED A0       > ldi
1697   55A5 ED A0       > ldi
1697   55A7 ED A0       > ldi
1697   55A9 ED A0       > ldi
1697   55AB ED A0       > ldi
1697   55AD ED A0       > ldi
1697   55AF ED A0       > ldi
1697   55B1 ED A0       > ldi
1697   55B3 ED A0       > ldi
1697   55B5 ED A0       > ldi
1697   55B7 ED A0       > ldi
1697   55B9 ED A0       > ldi
1697   55BB ED A0       > ldi
1697   55BD ED A0       > ldi
1697   55BF ED A0       > ldi
1697   55C1 ED A0       > ldi
1697   55C3 ED A0       > ldi
1697   55C5 ED A0       > ldi
1697   55C7 ED A0       > ldi
1697   55C9 ED A0       > ldi
1697   55CB ED A0       > ldi
1697   55CD ED A0       > ldi
1697   55CF ED A0       > ldi
1697   55D1 ED A0       > ldi
1697   55D3 ED A0       > ldi
1697   55D5 ED A0       > ldi
1697   55D7 ED A0       > ldi
1697   55D9 ED A0       > ldi
1697   55DB ED A0       > ldi
1697   55DD ED A0       > ldi
1697   55DF ED A0       > ldi
1697   55E1 ED A0       > ldi
1697   55E3 ED A0       > ldi
1697   55E5 ED A0       > ldi
1697   55E7 ED A0       > ldi
1697   55E9 ED A0       > ldi
1697   55EB ED A0       > ldi
1697   55ED ED A0       > ldi
1697   55EF ED A0       > ldi
1697   55F1 ED A0       > ldi
1697   55F3 ED A0       > ldi
1697   55F5 ED A0       > ldi
1697   55F7 ED A0       > ldi
1697   55F9 ED A0       > ldi
1697   55FB ED A0       > ldi
1697   55FD ED A0       > ldi
1697   55FF ED A0       > ldi
1697   5601 ED A0       > ldi
1697   5603 ED A0       > ldi
1697   5605 ED A0       > ldi
1697   5607 ED A0       > ldi
1697   5609 ED A0       > ldi
1697   560B ED A0       > ldi
1697   560D ED A0       > ldi
1697   560F ED A0       > ldi
1697   5611 ED A0       > ldi
1697   5613 ED A0       > ldi
1697   5615 ED A0       > ldi
1697   5617 ED A0       > ldi
1697   5619 ED A0       > ldi
1697   561B ED A0       > ldi
1697   561D ED A0       > ldi
1697   561F ED A0       > ldi
1697   5621 ED A0       > ldi
1697   5623 ED A0       > ldi
1697   5625 ED A0       > ldi
1697   5627 ED A0       > ldi
1697   5629 ED A0       > ldi
1697   562B ED A0       > ldi
1697   562D ED A0       > ldi
1697   562F ED A0       > ldi
1697   5631 ED A0       > ldi
1697   5633 ED A0       > ldi
1697   5635 ED A0       > ldi
1697   5637 ED A0       > ldi
1697   5639 ED A0       > ldi
1697   563B ED A0       > ldi
1697   563D ED A0       > ldi
1697   563F ED A0       > ldi
1697   5641 ED A0       > ldi
1697   5643 ED A0       > ldi
1697   5645 ED A0       > ldi
1697   5647 ED A0       > ldi
1697   5649 ED A0       > ldi
1697   564B ED A0       > ldi
1697   564D ED A0       > ldi
1697   564F ED A0       > ldi
1697   5651 ED A0       > ldi
1697   5653 ED A0       > ldi
1697   5655 ED A0       > ldi
1697   5657 ED A0       > ldi
1697   5659 ED A0       > ldi
1697   565B ED A0       > ldi
1697   565D ED A0       > ldi
1697   565F ED A0       > ldi
1697   5661 ED A0       > ldi
1697   5663 ED A0       > ldi
1697   5665 ED A0       > ldi
1697   5667 ED A0       > ldi
1697   5669 ED A0       > ldi
1697   566B ED A0       > ldi
1697   566D ED A0       > ldi
1697   566F ED A0       > ldi
1697   5671 ED A0       > ldi
1697   5673 ED A0       > ldi
1697   5675 ED A0       > ldi
1697   5677 ED A0       > ldi
1697   5679 ED A0       > ldi
1697   567B ED A0       > ldi
1697   567D ED A0       > ldi
1697   567F ED A0       > ldi
1697   5681 ED A0       > ldi
1697   5683 ED A0       > ldi
1697   5685 ED A0       > ldi
1697   5687 ED A0       > ldi
1697   5689 ED A0       > ldi
1697   568B ED A0       > ldi
1697   568D ED A0       > ldi
1697   568F ED A0       > ldi
1697   5691 ED A0       > ldi
1697   5693 ED A0       > ldi
1697   5695 ED A0       > ldi
1697   5697 ED A0       > ldi
1697   5699 ED A0       > ldi
1697   569B ED A0       > ldi
1697   569D ED A0       > ldi
1697   569F ED A0       > ldi
1697   56A1 ED A0       > ldi
1697   56A3 ED A0       > ldi
1697   56A5 ED A0       > ldi
1697   56A7 ED A0       > ldi
1697   56A9 ED A0       > ldi
1697   56AB ED A0       > ldi
1697   56AD ED A0       > ldi
1697   56AF ED A0       > ldi
1697   56B1 ED A0       > ldi
1697   56B3 ED A0       > ldi
1697   56B5 ED A0       > ldi
1697   56B7 ED A0       > ldi
1697   56B9 ED A0       > ldi
1697   56BB ED A0       > ldi
1697   56BD ED A0       > ldi
1697   56BF ED A0       > ldi
1697   56C1 ED A0       > ldi
1697   56C3 ED A0       > ldi
1697   56C5 ED A0       > ldi
1697   56C7 ED A0       > ldi
1697   56C9 ED A0       > ldi
1697   56CB ED A0       > ldi
1697   56CD ED A0       > ldi
1697   56CF ED A0       > ldi
1697   56D1 ED A0       > ldi
1697   56D3 ED A0       > ldi
1697   56D5 ED A0       > ldi
1697   56D7 ED A0       > ldi
1697   56D9 ED A0       > ldi
1697   56DB ED A0       > ldi
1697   56DD ED A0       > ldi
1697   56DF ED A0       > ldi
1697   56E1 ED A0       > ldi
1697   56E3 ED A0       > ldi
1697   56E5 ED A0       > ldi
1697   56E7 ED A0       > ldi
1697   56E9 ED A0       > ldi
1697   56EB ED A0       > ldi
1697   56ED ED A0       > ldi
1697   56EF ED A0       > ldi
1697   56F1 ED A0       > ldi
1697   56F3 ED A0       > ldi
1697   56F5 ED A0       > ldi
1697   56F7 ED A0       > ldi
1697   56F9 ED A0       > ldi
1697   56FB ED A0       > ldi
1697   56FD ED A0       > ldi
1697   56FF ED A0       > ldi
1697   5701 ED A0       > ldi
1697   5703 ED A0       > ldi
1697   5705 ED A0       > ldi
1697   5707 ED A0       > ldi
1697   5709 ED A0       > ldi
1697   570B ED A0       > ldi
1697   570D ED A0       > ldi
1697   570F ED A0       > ldi
1697   5711 ED A0       > ldi
1697   5713 ED A0       > ldi
1697   5715 ED A0       > ldi
1697   5717 ED A0       > ldi
1697   5719 ED A0       > ldi
1697   571B ED A0       > ldi
1697   571D ED A0       > ldi
1697   571F ED A0       > ldi
1697   5721 ED A0       > ldi
1697   5723 ED A0       > ldi
1697   5725 ED A0       > ldi
1697   5727 ED A0       > ldi
1697   5729 ED A0       > ldi
1697   572B ED A0       > ldi
1697   572D ED A0       > ldi
1697   572F ED A0       > ldi
1697   5731 ED A0       > ldi
1697   5733 ED A0       > ldi
1697   5735 ED A0       > ldi
1697   5737 ED A0       > ldi
1697   5739 ED A0       > ldi
1697   573B ED A0       > ldi
1697   573D ED A0       > ldi
1697   573F ED A0       > ldi
1697   5741 ED A0       > ldi
1697   5743 ED A0       > ldi
1697   5745 ED A0       > ldi
1697   5747 ED A0       > ldi
1697   5749 ED A0       > ldi
1697   574B ED A0       > ldi
1697   574D ED A0       > ldi
1697   574F ED A0       > ldi
1697   5751 ED A0       > ldi
1697   5753 ED A0       > ldi
1697   5755 ED A0       > ldi
1697   5757 ED A0       > ldi
1697   5759 ED A0       > ldi
1697   575B ED A0       > ldi
1697   575D ED A0       > ldi
1697   575F ED A0       > ldi
1697   5761 ED A0       > ldi
1697   5763 ED A0       > ldi
1697   5765 ED A0       > ldi
1697   5767 ED A0       > ldi
1697   5769 ED A0       > ldi
1697   576B ED A0       > ldi
1697   576D ED A0       > ldi
1697   576F ED A0       > ldi
1697   5771 ED A0       > ldi
1697   5773 ED A0       > ldi
1697   5775 ED A0       > ldi
1697   5777 ED A0       > ldi
1697   5779 ED A0       > ldi
1697   577B ED A0       > ldi
1697   577D ED A0       > ldi
1697   577F ED A0       > ldi
1697   5781 ED A0       > ldi
1697   5783 ED A0       > ldi
1697   5785 ED A0       > ldi
1697   5787 ED A0       > ldi
1697   5789 ED A0       > ldi
1697   578B ED A0       > ldi
1697   578D ED A0       > ldi
1697   578F ED A0       > ldi
1697   5791 ED A0       > ldi
1697   5793 ED A0       > ldi
1697   5795 ED A0       > ldi
1697   5797 ED A0       > ldi
1697   5799 ED A0       > ldi
1697   579B ED A0       > ldi
1697   579D ED A0       > ldi
1698   579F             .part2s: 
1699   579F EB          	ex	de,hl
1700   57A0 3A 00 7B    	ld	a, (PORTSPI)	; descarta CRC
1701   57A3             .fim: 
1702   57A3 AF          	xor	a		; zera carry para informar leitura sem erros
1703   57A4 C3 2F 4F    	jp	terminaLeituraEscritaBloco
1704   57A7             
1705   57A7             
1706   57A7             ; ------------------------------------------------
1707   57A7             ; Converte blocos para bytes. Na pratica faz
1708   57A7             ; BC DE = (BC DE) * 512
1709   57A7             ; ------------------------------------------------
1710   57A7             blocoParaByte: 
1711   57A7 41          	ld	b, c
1712   57A8 4A          	ld	c, d
1713   57A9 53          	ld	d, e
1714   57AA 1E 00       	ld	e, 0
1715   57AC CB 22       	sla	d
1716   57AE CB 11       	rl	c
1717   57B0 CB 10       	rl	b
1718   57B2 C9          	ret
1719   57B3             
1720   57B3             ; ------------------------------------------------
1721   57B3             ; Funcoes utilitarias
1722   57B3             ; ------------------------------------------------
1723   57B3             
1724   57B3             ; ------------------------------------------------
1725   57B3             ; Imprime string na tela apontada por DE
1726   57B3             ; Destroi todos os registradores
1727   57B3             ; ------------------------------------------------
1728   57B3             printString: 
1729   57B3 1A          	ld	a, (de)
1730   57B4 B7          	or	a
1731   57B5 C8          	ret	z
1732   57B6 CD A2 00    	call	CHPUT
1733   57B9 13          	inc	de
1734   57BA 18 F7       	jr	printString
1735   57BC             
1736   57BC             
1737   57BC             ; ------------------------------------------------
1738   57BC             ; Converte o byte em A para string em decimal no
1739   57BC             ; buffer apontado por DE
1740   57BC             ; Destroi AF, BC, HL, DE
1741   57BC             ; ------------------------------------------------
1742   57BC             DecToAscii: 
1743   57BC 26 00       	ld	h, 0
1744   57BE 6F          	ld	l, a		; copiar A para HL
1745   57BF FD 36 34 01 	ld	(iy+TEMP), 1	; flag para indicar que devemos cortar os zeros a esquerda
1746   57C3 01 9C FF    	ld	bc, -100	; centenas
1747   57C6 CD D4 57    	call	.num1
1748   57C9 0E F6       	ld	c, -10		; dezenas
1749   57CB CD D4 57    	call	.num1
1750   57CE FD 36 34 02 	ld	(iy+TEMP), 2	; unidade deve exibir 0 se for zero e nao corta-lo
1751   57D2 0E FF       	ld	c, -1		; unidades
1752   57D4             .num1: 
1753   57D4 3E 2F       	ld	a, '0'-1
1754   57D6             .num2: 
1755   57D6 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1756   57D7 09          	add	hl, bc		; somar com negativo
1757   57D8 38 FC       	jr	c,.num2		; ainda nao zeramos
1758   57DA ED 42       	sbc	hl, bc		; retoma valor original
1759   57DC FD 35 34    	dec	(iy+TEMP)	; se flag do corte do zero indicar para nao cortar, pula
1760   57DF 20 08       	jr	nz,.naozero
1761   57E1 FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1762   57E3 20 04       	jr	nz,.naozero
1763   57E5 FD 34 34    	inc	(iy+TEMP)	; se for zero, nao salvamos e voltamos a flag
1764   57E8 C9          	ret
1765   57E9             .naozero: 
1766   57E9 12          	ld	(de), a		; eh zero ou eh outro numero, salvar
1767   57EA 13          	inc	de		; incrementa ponteiro de destino
1768   57EB C9          	ret
1769   57EC             
1770   57EC             ; ------------------------------------------------
1771   57EC             ; Converte o byte em A para string em hexa no
1772   57EC             ; buffer apontado por DE
1773   57EC             ; Destroi AF, C, DE
1774   57EC             ; ------------------------------------------------
1775   57EC             HexToAscii: 
1776   57EC 4F          	ld	c, a
1777   57ED 1F          	rra
1778   57EE 1F          	rra
1779   57EF 1F          	rra
1780   57F0 1F          	rra
1781   57F1 CD F5 57    	call	.conv
1782   57F4 79          	ld  	a, c
1783   57F5             .conv: 
1784   57F5 E6 0F       	and	$0F
1785   57F7 C6 90       	add	a, $90
1786   57F9 27          	daa
1787   57FA CE 40       	adc	a, $40
1788   57FC 27          	daa
1789   57FD 12          	ld	(de), a
1790   57FE 13          	inc	de
1791   57FF C9          	ret
1792   5800             
1793   5800             ; ------------------------------------------------
1794   5800             ; Converte o byte em A para string em decimal e
1795   5800             ; imprime na tela
1796   5800             ; Destroi AF, BC, HL, DE
1797   5800             ; ------------------------------------------------
1798   5800             printDecToAscii: 
1799   5800 26 00       	ld	h, 0
1800   5802 6F          	ld	l, a		; copiar A para HL
1801   5803 06 01       	ld	b, 1		; flag para indicar que devemos cortar os zeros a esquerda
1802   5805 11 9C FF    	ld	de, -100	; centenas
1803   5808 CD 14 58    	call	.num1
1804   580B 1E F6       	ld	e, -10		; dezenas
1805   580D CD 14 58    	call	.num1
1806   5810 06 02       	ld	b, 2		; unidade deve exibir 0 se for zero e nao corta-lo
1807   5812 1E FF       	ld	e, -1		; unidades
1808   5814             .num1: 
1809   5814 3E 2F       	ld	a, '0'-1
1810   5816             .num2: 
1811   5816 3C          	inc	a		; contar o valor em ascii de '0' a '9'
1812   5817 19          	add	hl, de		; somar com negativo
1813   5818 38 FC       	jr	c,.num2		; ainda nao zeramos
1814   581A ED 52       	sbc	hl, de		; retoma valor original
1815   581C 10 06       	djnz	.naozero	; se flag do corte do zero indicar para nao cortar, pula
1816   581E FE 30       	cp	'0'		; devemos cortar os zeros a esquerda. Eh zero?
1817   5820 20 02       	jr	nz,.naozero
1818   5822 04          	inc	b		; se for zero, nao imprimimos e voltamos a flag
1819   5823 C9          	ret
1820   5824             .naozero: 
1821   5824 E5          	push	hl		; nao eh zero ou eh outro numero, imprimir
1822   5825 C5          	push	bc
1823   5826 CD A2 00    	call	CHPUT
1824   5829 C1          	pop	bc
1825   582A E1          	pop	hl
1826   582B C9          	ret
1827   582C             
1828   582C             ; ------------------------------------------------
1829   582C             ; Procura pelo nome do fabricante em uma tabela.
1830   582C             ; A contem o byte do fabricante
1831   582C             ; Devolve HL apontando para o buffer do fabricante
1832   582C             ; e BC com o comprimento do texto
1833   582C             ; Destroi AF, BC, HL
1834   582C             ; ------------------------------------------------
1835   582C             pegaFabricante: 
1836   582C 4F          	ld	c, a
1837   582D 21 4E 58    	ld	hl, tblFabricantes
1838   5830             
1839   5830             .loop: 
1840   5830 7E          	ld	a, (hl)
1841   5831 23          	inc	hl
1842   5832 B9          	cp	c
1843   5833 28 0C       	jr	z,.achado
1844   5835 B7          	or	a
1845   5836 28 09       	jr	z,.achado
1846   5838 C5          	push	bc
1847   5839 CD 41 58    	call	.achado
1848   583C 09          	add	hl, bc
1849   583D 23          	inc	hl
1850   583E C1          	pop	bc
1851   583F 18 EF       	jr	.loop
1852   5841             
1853   5841             .achado: 
1854   5841 0E 00       	ld	c, 0
1855   5843 E5          	push	hl
1856   5844 AF          	xor	a
1857   5845             .loop2: 
1858   5845 0C          	inc	c
1859   5846 23          	inc	hl
1860   5847 BE          	cp	(hl)
1861   5848 20 FB       	jr	nz,.loop2
1862   584A E1          	pop	hl
1863   584B 06 00       	ld	b, 0
1864   584D C9          	ret
1865   584E             
1866   584E             tblFabricantes: 
1867   584E 01          	db	1
1868   584F             	db	"Panasonic",0
1868   584F 50616E61736F6E696300
1869   5859 02          	db	2
1870   585A             	db	"Toshiba",0
1870   585A 546F736869626100
1871   5862 03          	db	3
1872   5863             	db	"SanDisk",0
1872   5863 53616E4469736B00
1873   586B 04          	db	4
1874   586C             	db	"SMI-S",0
1874   586C 534D492D5300
1875   5872 06          	db	6
1876   5873             	db	"Renesas",0
1876   5873 52656E6573617300
1877   587B 11          	db	17
1878   587C             	db	"Dane-Elec",0
1878   587C 44616E652D456C656300
1879   5886 13          	db	19
1880   5887             	db	"KingMax",0
1880   5887 4B696E674D617800
1881   588F 15          	db	21
1882   5890             	db	"Samsung",0
1882   5890 53616D73756E6700
1883   5898 18          	db	24
1884   5899             	db	"Infineon",0
1884   5899 496E66696E656F6E00
1885   58A2 1A          	db	26
1886   58A3 50 51 49 00 	db	"PQI",0
1887   58A7 1B          	db	27
1888   58A8 536F6E7900  	db	"Sony",0
1889   58AD 1C          	db	28
1890   58AE             	db	"Transcend",0
1890   58AE 5472616E7363656E6400
1891   58B8 1D          	db	29
1892   58B9             	db	"A-DATA",0
1892   58B9 412D4441544100
1893   58C0 1F          	db	31
1894   58C1             	db	"SiliconPower",0
1894   58C1 53696C69636F6E506F77657200
1895   58CE 27          	db	39
1896   58CF             	db	"Verbatim",0
1896   58CF 566572626174696D00
1897   58D8 41          	db	65
1898   58D9 4F 4B 49 00 	db	"OKI",0
1899   58DD 73          	db	115
1900   58DE             	db	"SilverHT",0
1900   58DE 53696C766572485400
1901   58E7 89          	db	137
1902   58E8             	db	"L.Data",0
1902   58E8 4C2E4461746100
1903   58EF 00          	db	0
1904   58F0             	db	"Generico",0
1904   58F0 47656E657269636F00
1905   58F9             
1906   58F9             
1907   58F9             ; ------------------------------------------------
1908   58F9             ; Restore screen parameters on MSX>=2 if they're
1909   58F9             ; not set yet
1910   58F9             ; ------------------------------------------------
1911   58F9             MYSETSCR: 
1912   58F9 3A 2D 00    	ld	a,(MSXVER)
1913   58FC B7          	or	a			; MSX1?
1914   58FD CA 6C 00    	jp	z,INITXT		; Yes, change do screen-0
1915   5900             
1916   5900 0E 23       	ld	c,$23			; Block-2, R#3
1917   5902 DD 21 F5 01 	ld 	ix,REDCLK
1918   5906 CD 5F 01    	call	EXTROM
1919   5909 E6 01       	and	1
1920   590B 47          	ld	b,a
1921   590C 3A AF FC    	ld	a,(SCRMOD)
1922   590F B8          	cp	b
1923   5910 20 1C       	jr	nz,.restore
1924   5912 0C          	inc	c
1925   5913 DD 21 F5 01 	ld 	ix,REDCLK
1926   5917 CD 5F 01    	call	EXTROM
1927   591A 47          	ld	b,a
1928   591B 0C          	inc	c
1929   591C DD 21 F5 01 	ld 	ix,REDCLK
1930   5920 CD 5F 01    	call	EXTROM
1931   5923 87          	add	a,a
1932   5924 87          	add	a,a
1933   5925 87          	add	a,a
1934   5926 87          	add	a,a
1935   5927 B0          	or	b
1936   5928 47          	ld	b,a
1937   5929 3A B0 F3    	ld	a,(LINLEN)
1938   592C B8          	cp	b
1939   592D C8          	ret	z
1940   592E             .restore: 
1941   592E AF          	xor	a		; Don't displat the function keys
1942   592F DD 21 85 01 	ld	ix,SDFSCR
1943   5933 C3 5F 01    	jp	EXTROM
1944   5936             
1945   5936             
1946   5936             
1947   5936             ; ==========================================================================
1948   5936             strTitle: 
1949   5936             	db	"FBLabs SDHC driver "
1949   5936 46424C61627320534448432064726976657220
1950   5949             	db	"v",VER_MAIN+$30,'.',VER_SEC+$30,'.',VER_REV+$30
1950   5949 76312E302E36
1951   594F 0D 0A 00    	db	13,10,0
1952   5952             
1953   5952             strBootpaused: 
1954   5952             	db	"Paused. Press <i> to show the copyright info.",13,10,0
1954   5952 5061757365642E205072657373203C693E20746F2073686F772074686520636F
1954   5972 7079726967687420696E666F2E0D0A00
1955   5982             
1956   5982             strCopyright: 
1957   5982             	db	"Copyright (c) 2014 Fabio Belavenuto",13,10
1957   5982 436F7079726967687420286329203230313420466162696F2042656C6176656E
1957   59A2 75746F0D0A
1958   59A7             	db	"Licenced under CERN OHL v1.1",13,10
1958   59A7 4C6963656E63656420756E646572204345524E204F484C2076312E310D0A
1959   59C5             	db	"http://ohwr.org/cernohl",13,10
1959   59C5 687474703A2F2F6F6877722E6F72672F6365726E6F686C0D0A
1960   59DE             	db	"PCB designed by Luciano Sturaro",13,10
1960   59DE 5043422064657369676E6564206279204C756369616E6F205374757261726F0D
1960   59FE 0A
1961   59FF             	; fall throw
1962   59FF             strCrLf: 
1963   59FF 0D 0A 00    	db	13,10,0
1964   5A02             strCartao: 
1965   5A02             	db	"Slot ",0
1965   5A02 536C6F742000
1966   5A08             strVazio: 
1967   5A08             	db	"Empty",13,10,0
1967   5A08 456D7074790D0A00
1968   5A10             strNaoIdentificado: 
1969   5A10             	db	"Unknown!",13,10,0
1969   5A10 556E6B6E6F776E210D0A00
1970   5A1B             			;----------------------------------------
1971   5A1B             strMr_mp_desativada: 
1972   5A1B             	db	"Slot expander/Mapper/MegaRAM disabled",13,10,0
1972   5A1B 536C6F7420657870616E6465722F4D61707065722F4D65676152414D20646973
1972   5A3B 61626C65640D0A00
1973   5A43             strMapper: 
1974   5A43             	db	"Slot expanded and Memory Mapper enabled",13,10,0
1974   5A43 536C6F7420657870616E64656420616E64204D656D6F7279204D617070657220
1974   5A63 656E61626C65640D0A00
1975   5A6D             strMegaram: 
1976   5A6D             	db	"Slot expander and MegaRAM enabled",13,10,0
1976   5A6D 536C6F7420657870616E64657220616E64204D65676152414D20656E61626C65
1976   5A8D 640D0A00
1977   5A91             strSDV1: 
1978   5A91             	db	"SDV1 - ",0
1978   5A91 53445631202D2000
1979   5A99             strSDV2: 
1980   5A99             	db	"SDV2 - ",0
1980   5A99 53445632202D2000
1981   5AA1             
1982   5AA1             ;-----------------------------------------------------------------------------
1983   5AA1             ;
1984   5AA1             ; End of the driver code
1985   5AA1             
1986   5AA1             DRV_END: 
1987   5AA1             
1988   5AA1 FF          	ds	3ED0h-(DRV_END-DRV_START), $FF
1989   7FD0             
1990   7FD0             
